
<!DOCTYPE html>
<html lang="en">
<head>
    <script>
    // --- SECURITY CHECK ---
    // If the token is missing, they accessed this file directly (cheating)
    if (!sessionStorage.getItem('portalToken')) {
        // Replace 'index.html' with the actual name of your main login page
        window.location.href = 'index.html'; 
    }

    // Disable Right Click on Exam Page too
    document.addEventListener('contextmenu', event => event.preventDefault());
    
    // Disable Selection
    document.addEventListener('selectstart', event => event.preventDefault());
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MCQ Exam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root, [data-theme="light"] {
            --bg-primary: #f9fafb; /* gray-50 */
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6; /* gray-100 */
            --bg-accent: #e5e7eb; /* gray-200 */
            --bg-accent-hover: #d1d5db; /* gray-300 */
            --bg-info: #eff6ff; /* blue-50 */
            --bg-info-border: #bfdbfe; /* blue-200 */
            --bg-success: #f0fdf4; /* green-50 */
            --bg-success-border: #bbf7d0; /* green-200 */
            --bg-danger: #fef2f2; /* red-50 */
            --bg-danger-border: #fecaca; /* red-200 */
            --bg-warning: #fffbeb; /* yellow-50 */
            --bg-warning-border: #fde68a; /* yellow-200 */
            --bg-code: #e5e7eb;
            --text-primary: #1f2937; /* gray-800 */
            --text-secondary: #4b5563; /* gray-600 */
            --text-tertiary: #6b7280; /* gray-500 */
            --text-accent: #3b82f6; /* blue-600 */
            --text-accent-hover: #2563eb; /* blue-700 */
            --text-inverted: #ffffff;
            --text-info: #1e40af; /* blue-800 */
            --text-success: #15803d; /* green-700 */
            --text-danger: #b91c1c; /* red-700 */
            --text-warning: #92400e; /* yellow-800 */
            --border-primary: #e5e7eb; /* gray-200 */
            --border-secondary: #d1d5db; /* gray-300 */
            --border-accent: #3b82f6;
            --shadow-color: rgba(0,0,0,0.1);
            --swipe-duration: 0.3s; /* Default Smooth */
            --font-explanation: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }

        [data-theme="dark"] {
            --bg-primary: #111827; /* gray-900 */
            --bg-secondary: #1f2937; /* gray-800 */
            --bg-tertiary: #374151; /* gray-700 */
            --bg-accent: #4b5563; /* gray-600 */
            --bg-accent-hover: #525c6a;
            --bg-info: #1e293b; 
            --bg-info-border: #334155;
            --bg-success: #064e3b; /* green-900 */
            --bg-success-border: #065f46;
            --bg-danger: #7f1d1d; /* red-900 */
            --bg-danger-border: #991b1b;
            --bg-warning: #451a03;
            --bg-warning-border: #78350f;
            --bg-code: #374151;
            --text-primary: #f3f4f6; /* near-white, AAA */
            --text-secondary: #d1d5db; /* gray-300, AAA */
            --text-tertiary: #9ca3af; /* gray-400 */
            --text-accent: #60a5fa; /* blue-400 */
            --text-accent-hover: #93c5fd; /* blue-300 */
            --text-inverted: #1f2937;
            --text-info: #bfdbfe;
            --text-success: #86efac; /* green-300 */
            --text-danger: #fca5a5; /* red-300 */
            --text-warning: #fcd34d;
            --border-primary: #374151; /* gray-700 */
            --border-secondary: #4b5563; /* gray-600 */
            --border-accent: #60a5fa;
            --shadow-color: rgba(0,0,0,0.4);
            --font-explanation: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }

        [data-theme="ambient"] {
            --bg-primary: #fdf6e3; /* cream */
            --bg-secondary: #f6efd8;
            --bg-tertiary: #eee8d5;
            --bg-accent: #dcd4c1;
            --bg-accent-hover: #c9c1ae;
            --bg-info: #e0f2f1; 
            --bg-info-border: #b2dfdb;
            --bg-success: #e8f5e9;
            --bg-success-border: #c8e6c9;
            --bg-danger: #ffebee;
            --bg-danger-border: #ffcdd2;
            --bg-warning: #fff3e0;
            --bg-warning-border: #ffe0b2;
            --bg-code: #eee8d5;
            --text-primary: #433e3f; /* dark brown */
            --text-secondary: #586e75;
            --text-tertiary: #657b83;
            --text-accent: #cb4b16; /* warm orange */
            --text-accent-hover: #d35400;
            --text-inverted: #fdf6e3;
            --text-info: #00695c;
            --text-success: #2e7d32;
            --text-danger: #c62828;
            --text-warning: #e65100;
            --border-primary: #dcd4c1;
            --border-secondary: #c9c1ae;
            --border-accent: #cb4b16;
            --shadow-color: rgba(67, 62, 63, 0.1);
            --font-explanation: 'Georgia', 'Cambria', 'Times New Roman', serif;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            /* Disable Selection and Touch Callouts */
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10 and IE 11 */
            user-select: none; /* Standard syntax */
            -webkit-touch-callout: none; /* iOS Safari */
        }
        
        /* Re-enable selection for inputs */
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        /* View Transitions for Theme Switch */
        ::view-transition-old(root),
        ::view-transition-new(root) {
            animation: none;
            mix-blend-mode: normal;
        }
        ::view-transition-old(root) { z-index: 1; }
        ::view-transition-new(root) { z-index: 9999; }

        .screen { display: none; }
        .screen.active { display: flex; }
        .option-label { transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out; }
        .prose strong { font-weight: 700; color: var(--text-primary); }
        .prose em { color: var(--text-primary); font-style: italic; }
        .prose br { content: ""; display: block; margin-bottom: 0.5rem; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .prose p { margin-bottom: 1rem; }
        .calculator-btn { padding: 1rem 0; font-size: 1.25rem; border-radius: 0.5rem; transition: background-color 0.2s, transform 0.1s, filter 0.1s; text-align: center; }
        .key-press-feedback { transform: scale(0.95); filter: brightness(0.85); }
        .calculator-modal.dragging { opacity: 0.7; border: 2px dashed var(--border-accent); }
        
        /* Custom Radio Button for Exam Mode */
        .radio-circle::after {
            content: '';
            display: block;
            width: 1rem; /* 16px */
            height: 1rem; /* 16px */
            border-radius: 50%;
            background-color: var(--border-accent);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.2s ease-in-out;
        }
        .option-label.selected .radio-circle::after {
            transform: translate(-50%, -50%) scale(1);
        }
        
        /* Themed Components */
        .themed-bg-primary { background-color: var(--bg-primary); }
        .themed-bg-secondary { background-color: var(--bg-secondary); }
        .themed-bg-tertiary { background-color: var(--bg-tertiary); }
        .themed-bg-accent { background-color: var(--bg-accent); }
        .themed-bg-accent-hover:hover { background-color: var(--bg-accent-hover); }

        .themed-text-primary { color: var(--text-primary); }
        .themed-text-secondary { color: var(--text-secondary); }
        .themed-text-tertiary { color: var(--text-tertiary); }
        .themed-text-accent { color: var(--text-accent); }
        .themed-text-inverted { color: var(--text-inverted); }
        .themed-text-success { color: var(--text-success); }
        .themed-text-danger { color: var(--text-danger); }
        .themed-text-warning { color: var(--text-warning); }

        .themed-border-primary { border-color: var(--border-primary); }
        .themed-border-secondary { border-color: var(--border-secondary); }
        .themed-border-accent { border-color: var(--border-accent); }
        
        .themed-shadow { box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -2px var(--shadow-color); }
        
        /* Component specific overrides */
        #setup-screen .bg-white, #results-screen .bg-white, #review-screen .bg-white, #practice-screen .bg-white, #practice-results-screen .bg-white, #past-results-screen .bg-white, #progress-screen .bg-white, .modal-card, #calculator-modal {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        header { background-color: var(--bg-secondary); }
        main, footer { background-color: var(--bg-tertiary); }
        footer { box-shadow: 0 -2px 5px var(--shadow-color); }
        input, textarea { background-color: var(--bg-secondary); border-color: var(--border-secondary); color: var(--text-primary); }
        input:focus, textarea:focus { --tw-ring-color: var(--text-accent); border-color: var(--text-accent); }
        #timer, #practice-timer { background-color: var(--bg-accent); }
        .option-label { background-color: var(--bg-tertiary); position: relative; overflow: hidden; }
        .option-label.selected { background-color: var(--bg-info); border-color: var(--border-accent); }
        .option-label:hover { background-color: var(--bg-accent); }
        #question-palette { background-color: var(--bg-secondary); }
        #hide-palette-btn, #show-palette-btn { background-color: var(--bg-secondary); color: var(--text-secondary); border-color: var(--border-primary); }
        
        /* Improved Explanation Typography and Styles */
        .explanation-card {
            background-color: var(--bg-secondary);
            border-top: 4px solid var(--text-accent);
            border-radius: 0.75rem;
            margin-top: 2rem;
            animation: fade-in-up 0.4s ease-out;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            position: relative; /* For toolbar anchor */
        }
        .explanation-header {
            padding: 1rem 1.5rem;
            font-weight: 700;
            color: var(--text-accent);
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-primary);
            font-size: 1.1rem;
        }
        .explanation-content {
            padding: 1.5rem 2rem;
            color: var(--text-primary);
            font-size: 1.05rem;
            line-height: 1.8;
            font-family: var(--font-explanation);
            user-select: text; /* Allow selection in explanation */
        }

        /* Feedback Header Badge */
        .feedback-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 0.875rem;
            margin-left: 1rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease-out;
        }
        .feedback-badge.visible { opacity: 1; transform: translateY(0); }
        .feedback-badge.correct { background-color: var(--bg-success); color: var(--text-success); border: 1px solid var(--bg-success-border); }
        .feedback-badge.incorrect { background-color: var(--bg-danger); color: var(--text-danger); border: 1px solid var(--bg-danger-border); }

        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Streak Badge */
        .streak-badge {
            display: flex;
            align-items: center;
            background: rgba(245, 158, 11, 0.1); /* amber-500 with opacity */
            color: #d97706; /* amber-600 */
            padding: 0.25rem 0.75rem;
            border-radius: 99px;
            font-weight: 700;
            font-size: 0.85rem;
            border: 1px solid rgba(245, 158, 11, 0.3);
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .streak-badge.active {
            transform: scale(1.1);
            background: rgba(245, 158, 11, 0.25);
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.2);
        }
        
        /* Swipe Animations */
        @keyframes slide-out-left { to { transform: translateX(-100%); opacity: 0; } }
        @keyframes slide-in-from-right { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slide-out-right { to { transform: translateX(100%); opacity: 0; } }
        @keyframes slide-in-from-left { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .slide-out-left { animation: slide-out-left var(--swipe-duration) ease-out forwards; }
        .slide-in-from-right { animation: slide-in-from-right var(--swipe-duration) ease-out forwards; }
        .slide-out-right { animation: slide-out-right var(--swipe-duration) ease-out forwards; }
        .slide-in-from-left { animation: slide-in-from-left var(--swipe-duration) ease-out forwards; }
        
        /* Toast Notification */
        @keyframes fade-in-out {
            0% { transform: translateY(100%); opacity: 0; }
            10% { transform: translateY(0); opacity: 1; }
            90% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(100%); opacity: 0; }
        }
        #toast-notification {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            background-color: #333;
            color: white;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            z-index: 100;
            visibility: hidden;
            opacity: 0;
        }
        #toast-notification.show {
            visibility: visible;
            bottom: 2rem;
            animation: fade-in-out 3s ease-in-out forwards;
        }

        /* Save Button Animation */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.25); }
            100% { transform: scale(1); }
        }
        .pop-animation {
            animation: pop 0.3s ease-out;
        }
        
        /* CHART CSS */
        .chart-wrapper {
            display: flex;
            align-items: flex-end;
            justify-content: flex-start;
            gap: 16px;
            height: 300px;
            width: 100%;
            overflow-x: auto;
            padding: 20px 10px 40px 10px;
            border-bottom: 2px solid var(--border-primary);
            border-left: 2px solid var(--border-primary);
            background: linear-gradient(to bottom, var(--bg-primary), var(--bg-secondary));
            border-radius: 12px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.02);
        }
        .chart-bar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            justify-content: flex-end;
            flex-shrink: 0;
            width: 50px;
            position: relative;
            transition: transform 0.2s;
        }
        .chart-bar-container:hover {
            transform: translateY(-5px);
            z-index: 10;
        }
        
        @keyframes grow-up {
            from { height: 0; opacity: 0; }
            to { opacity: 1; }
        }
        
        .chart-bar {
            width: 100%;
            border-radius: 6px 6px 0 0;
            position: relative;
            min-height: 24px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 5px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: grow-up 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            opacity: 0; /* Start invisible for animation */
        }
        
        /* Interference/Gradient Effects */
        .bar-success {
            background: linear-gradient(180deg, #4ade80 0%, #16a34a 100%);
            border: 1px solid #15803d;
        }
        .bar-danger {
            background: linear-gradient(180deg, #f87171 0%, #dc2626 100%);
            border: 1px solid #b91c1c;
        }
        
        /* Text inside bar */
        .chart-bar-text {
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            white-space: nowrap;
            margin-bottom: 5px;
        }
        
        .chart-bar-label {
            font-size: 11px;
            margin-top: 10px;
            color: var(--text-secondary);
            transform: rotate(-45deg);
            white-space: nowrap;
            text-align: right;
            width: 100%;
            transform-origin: top center;
            text-overflow: ellipsis;
            overflow: hidden;
        }
        .chart-bar-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: rgba(17, 24, 39, 0.95);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 20;
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }
        .chart-bar-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: rgba(17, 24, 39, 0.95) transparent transparent transparent;
        }
        .chart-bar-container:hover .chart-bar-tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(-12px);
        }
        
        /* STAT CARDS */
        .stat-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-value { font-size: 1.5rem; font-weight: 800; color: var(--text-primary); }
        .stat-label { font-size: 0.75rem; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; }

        /* DYNAMIC ISLAND */
        #dynamic-island {
            position: fixed;
            z-index: 9999;
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(16px);
            border-radius: 20px;
            padding: 6px;
            gap: 8px;
            display: flex;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            transition: width 0.5s, height 0.5s, top 0.5s, left 0.5s, right 0.5s, bottom 0.5s, border-radius 0.5s, opacity 0.4s ease;
            cursor: grab;
            border: 1px solid rgba(255,255,255,0.15);
        }
        #dynamic-island:active { cursor: grabbing; }
        
        #dynamic-island.dragging { transition: none !important; }
        
        @keyframes hint-move {
            0% { transform: translateY(0); }
            25% { transform: translateY(5px); }
            50% { transform: translateY(-5px); }
            75% { transform: translateY(5px); }
            100% { transform: translateY(0); }
        }
        .hint-anim { animation: hint-move 0.6s ease-in-out; box-shadow: 0 0 25px rgba(255,255,255,0.5) !important; }
        
        #dynamic-island.idle { opacity: 0.3; }
        #dynamic-island.idle:hover { opacity: 1; }
        
        #dynamic-island.horizontal { flex-direction: row; height: auto; align-items: center; }
        #dynamic-island.vertical { flex-direction: column; width: auto; align-items: center; }

        .island-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: background 0.2s, transform 0.2s;
            cursor: pointer;
        }
        .island-btn:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
        .island-btn:active { transform: scale(0.95); }
        .island-btn svg { width: 18px; height: 18px; }
        
        .island-mini-btn {
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            padding: 0;
            padding-bottom: 2px;
        }
        .island-mini-btn:hover { background: rgba(255, 255, 255, 0.2); color: white; }

        .island-separator { background: rgba(255,255,255,0.2); border-radius: 99px; }
        #dynamic-island.horizontal .island-separator { width: 1px; height: 20px; }
        #dynamic-island.vertical .island-separator { width: 20px; height: 1px; }

        #dynamic-island.minimized {
            padding: 0;
            gap: 0;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            cursor: pointer;
            justify-content: center;
            opacity: 1 !important; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        [data-theme="light"] #dynamic-island.minimized,
        [data-theme="ambient"] #dynamic-island.minimized {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        #dynamic-island.minimized > * { display: none !important; }

        #dynamic-island.minimized.horizontal { width: 40px; height: 6px; border-radius: 10px; }
        #dynamic-island.minimized.vertical { width: 6px; height: 40px; border-radius: 10px; }

    </style>
    <script>
        // Immediately apply theme from localStorage to prevent FOUC
        (function() {
            try {
                const examId = 'exam_1765464039475_g95jee1';
                const THEME_KEY = 'examTheme_' + examId;
                const savedTheme = localStorage.getItem(THEME_KEY);
                if (savedTheme) {
                    document.documentElement.dataset.theme = savedTheme;
                }
            } catch (e) {
                console.error('Could not apply saved theme.', e);
            }
        })();
    </script>
</head>
<body class="">
    
    <!-- DYNAMIC ISLAND: Left Side Center Default -->
    <div id="dynamic-island" class="vertical" style="top: 50%; left: 20px; transform: translateY(-50%);">
        <button id="island-minimize-btn" class="island-mini-btn" aria-label="Minimize Island" title="Minimize">&minus;</button>
        
        <div class="island-separator"></div>
        <button id="island-home-btn" class="island-btn" aria-label="Go Home">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
        </button>

        <div class="island-separator"></div>
        <button id="island-progress-btn" class="island-btn" aria-label="View Progress">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
        </button>
        <div class="island-separator"></div>
        <button id="island-theme-btn" class="island-btn" aria-label="Toggle Theme">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
            </svg>
        </button>
        <div class="island-separator"></div>
        <button id="island-settings-btn" class="island-btn" aria-label="Swipe Settings">
             <svg id="swipe-icon-smooth" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
            <svg id="swipe-icon-hard" class="hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
        </button>
    </div>

    <div id="toast-notification"></div>
    <main id="app-container" class="h-screen w-screen relative">
        <!-- SCREEN 1: SECTION SETUP -->
        <div id="setup-screen" class="screen active flex-col justify-center items-center p-4">
            <div id="resume-banner" class="hidden w-full max-w-5xl bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg shadow-lg mb-6" role="alert">
                <div class="flex">
                    <div class="py-1"><svg class="fill-current h-6 w-6 text-yellow-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-5.414V8a1 1 0 112 0v4.586a1 1 0 11-2 0zM10 6a1 1 0 100-2 1 1 0 000 2z"/></svg></div>
                    <div>
                        <p class="font-bold">Saved Exam Session Found!</p>
                        <p class="text-sm">You have a saved exam in progress. What would you like to do?</p>
                        <div class="mt-3">
                            <button id="resume-session-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded" aria-label="Resume previous session">Resume Session</button>
                            <button id="discard-draft-btn" class="ml-4 text-sm text-yellow-800 hover:underline" aria-label="Discard draft and start new">Discard and Start New</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="w-full max-w-5xl bg-white p-8 rounded-lg shadow-lg themed-bg-secondary themed-shadow">
                <p class="text-xs text-center mb-4 themed-text-tertiary">Read instructions before start</p>
                <h1 class="text-3xl font-bold mb-2 text-center themed-text-accent">Internal Medicine Review: Neurology, Pulmonology, and Cardiology</h1>
                <h2 class="text-xl font-semibold mb-6 text-center themed-text-secondary">Exam Setup</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- Left Panel: Exam Configuration -->
                    <div class="md:col-span-2 space-y-6">
                        <div>
                            <p class="mb-4 themed-text-secondary">Total Questions Found: 55. Configure your exam sections below.</p>
                            
                            <div class="space-y-4 mb-6">
                                <div>
                                    <label for="subject-name" class="block text-sm font-medium themed-text-secondary">Subject Name</label>
                                    <input type="text" id="subject-name" value="Internal Medicine Review: Neurology, Pulmonology, and Cardiology" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="candidate-name" class="block text-sm font-medium themed-text-secondary">Candidate Name</label>
                                    <input type="text" id="candidate-name" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="short-note" class="block text-sm font-medium themed-text-secondary">Short Note (Optional)</label>
                                    <textarea id="short-note" rows="2" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Any notes for this test..."></textarea>
                                </div>
                            </div>

                            <div class="flex items-center mb-6">
                                <input type="checkbox" id="shuffle-mcqs-checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="shuffle-mcqs-checkbox" class="ml-2 block text-sm font-medium themed-text-secondary">Shuffle Questions</label>
                            </div>

                            <hr class="my-6 themed-border-primary">
                            
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold themed-text-primary">Exam Sections</h2>
                                <button id="auto-set-sections-btn" class="px-3 py-1 rounded-full text-xs font-semibold border border-blue-500 text-blue-500 hover:bg-blue-50 transition-colors" title="Split into 50-question sections (1 min/q)">Auto Set</button>
                            </div>
                            <div id="sections-container" class="space-y-4 max-h-48 overflow-y-auto pr-2">
                                <!-- Sections will be injected here by JS -->
                            </div>

                            <div class="mt-4 flex justify-between items-center">
                                <button id="add-section-btn" class="py-2 px-4 rounded themed-bg-accent themed-bg-accent-hover" aria-label="Add a new section">Add Section</button>
                            </div>
                        </div>

                        <div class="mt-6 text-center">
                            <button id="start-exam-btn" class="py-3 px-8 rounded-lg font-bold text-lg w-full md:w-auto" style="background-color: var(--text-accent); color: var(--text-inverted);" aria-label="Start the exam">Start Exam</button>
                            <p id="setup-error" class="mt-4 themed-text-danger text-center h-5"></p>
                        </div>
                    </div>

                    <!-- Right Panel: Alternative Modes -->
                    <div class="md:col-span-1 p-6 rounded-lg border themed-bg-primary themed-border-primary">
                        <h2 class="text-xl font-semibold mb-6 text-center themed-text-primary">Alternative Modes</h2>
                        <div class="space-y-4">
                            <div class="p-4 rounded-lg border" style="background-color: var(--bg-warning); border-color: var(--bg-warning-border);">
                                <h3 class="font-semibold text-lg text-center mb-3 themed-text-warning">Practice Mode</h3>
                                <div class="space-y-4 text-sm">
                                     <div>
                                        <label for="practice-q-count-slider" class="block font-medium themed-text-secondary">Number of Questions: <span id="practice-q-count-label">55</span></label>
                                        <input type="range" id="practice-q-count-slider" min="1" max="55" value="55" class="mt-1 block w-full cursor-pointer">
                                    </div>
                                    <div>
                                        <label for="practice-time-overall" class="block font-medium themed-text-secondary">Overall Time Limit (minutes)</label>
                                        <input type="number" id="practice-time-overall" class="mt-1 block w-full p-2 border rounded-md shadow-sm" placeholder="Optional: e.g., 60">
                                    </div>
                                    <div>
                                        <label for="practice-time-per-mcq" class="block font-medium themed-text-secondary">Time per MCQ (seconds)</label>
                                        <input type="number" id="practice-time-per-mcq" class="mt-1 block w-full p-2 border rounded-md shadow-sm" placeholder="Optional: e.g., 30">
                                    </div>
                                </div>
                                <button id="start-practice-btn" class="mt-4 py-3 px-6 rounded-lg font-bold w-full" style="background-color: var(--text-warning); color: var(--bg-primary);" aria-label="Start Practice Mode">Start Practice</button>
                                <p class="text-xs mt-2 text-center themed-text-tertiary">Get instant feedback with streaks & gamification.</p>
                            </div>
                            <div class="text-center">
                                <button id="revise-btn" class="py-3 px-6 rounded-lg font-bold w-full" style="background-color: #8b5cf6; color: white;" aria-label="Start Revise Mode">Revise Test</button>
                                <p class="text-xs mt-2 themed-text-tertiary">Freely browse all questions, answers, and explanations.</p>
                            </div>
                             <div id="saved-questions-container" class="text-center hidden">
                                 <button id="view-saved-btn" class="py-3 px-6 rounded-lg font-bold w-full relative" style="background-color: #4f46e5; color: white;" aria-label="View Saved Questions">
                                     Saved Questions
                                     <span id="saved-questions-count" class="absolute top-0 right-0 -mt-2 -mr-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                                 </button>
                                 <p class="text-xs mt-2 themed-text-tertiary">Review questions you've bookmarked.</p>
                            </div>
                            <div id="past-results-container" class="text-center hidden">
                                <button id="view-past-results-btn" class="py-3 px-6 rounded-lg font-bold w-full relative" style="background-color: #0d9488; color: white;" aria-label="View Past Results">
                                    View Past Results
                                    <span id="past-results-count" class="absolute top-0 right-0 -mt-2 -mr-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                                 </button>
                                 <p class="text-xs mt-2 themed-text-tertiary">Review your past exam performances.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCREEN 2: EXAM -->
        <div id="exam-screen" class="screen h-full relative">
            <!-- Main Content -->
            <div class="flex-1 flex flex-col">
                <header class="p-3 shadow-md flex justify-between items-center themed-bg-secondary themed-shadow">
                    <div class="flex items-center space-x-4">
                        <div>
                            <h1 id="section-name" class="text-xl font-bold themed-text-accent"></h1>
                            <p id="question-counter" class="text-sm themed-text-tertiary"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-xs font-bold themed-text-tertiary">created by mano</span>
                        <button id="calculator-toggle-btn" class="p-2 rounded-full themed-bg-accent-hover" aria-label="Toggle Calculator">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 themed-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                           </svg>
                        </button>
                        <div id="timer" class="text-xl font-mono px-4 py-1 rounded themed-bg-accent themed-text-primary" aria-label="Timer"></div>
                    </div>
                </header>

                <main class="flex-1 p-6 overflow-y-auto themed-bg-tertiary">
                    <div class="p-6 rounded-lg themed-bg-secondary">
                        <p id="question-text" class="text-lg font-semibold mb-6 whitespace-pre-wrap"></p>
                        <div id="question-image-container" class="my-4 flex justify-center"></div>
                        <div id="options-container" class="space-y-4"></div>
                    </div>
                </main>
                
                <footer class="p-4 themed-bg-secondary" style="box-shadow: 0 -2px 5px var(--shadow-color);">
                    <div class="flex justify-between items-center">
                        <div>
                            <button id="mark-review-btn" class="py-2 px-4 rounded text-white bg-purple-600 hover:bg-purple-700" aria-label="Mark for Review and Next">Mark for Review & Next</button>
                            <button id="clear-response-btn" class="py-2 px-4 rounded ml-4 themed-bg-accent themed-bg-accent-hover" aria-label="Clear Selected Response">Clear Response</button>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button id="prev-btn" class="py-2 px-6 rounded disabled:opacity-50 themed-bg-accent themed-bg-accent-hover" aria-label="Previous Question">Previous</button>
                            <button id="save-next-btn" class="py-2 px-6 rounded font-bold" style="background-color: #16a34a; color: white;" aria-label="Save Answer and Next Question">Save & Next</button>
                        </div>
                    </div>
                </footer>
            </div>

            <!-- Side Palette -->
            <aside id="question-palette" class="w-64 flex-shrink-0 relative transition-all duration-300 ease-in-out themed-bg-secondary">
                <div id="palette-content-wrapper" class="p-4 flex flex-col h-full w-full overflow-hidden transition-opacity duration-300">
                    <h2 class="text-lg font-bold mb-4 text-center">Question Palette</h2>
                    <div id="palette-container" class="grid grid-cols-5 gap-2 flex-1 overflow-y-auto"></div>
                     <div class="mt-4 text-xs space-y-2 themed-text-secondary">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center"><div class="w-4 h-4 rounded bg-green-600 mr-2"></div> Answered</div>
                            <span id="answered-count" class="font-bold px-1.5 py-0.5 rounded-full text-[10px] themed-bg-accent themed-text-primary">0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center"><div class="w-4 h-4 rounded bg-red-600 mr-2"></div> Not Answered</div>
                            <span id="not-answered-count" class="font-bold px-1.5 py-0.5 rounded-full text-[10px] themed-bg-accent themed-text-primary">0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center"><div class="w-4 h-4 rounded bg-gray-500 mr-2"></div> Not Visited</div>
                            <span id="not-visited-count" class="font-bold px-1.5 py-0.5 rounded-full text-[10px] themed-bg-accent themed-text-primary">0</span>
                        </div>
                         <div class="flex items-center justify-between">
                            <div class="flex items-center"><div class="w-4 h-4 rounded bg-purple-600 mr-2 relative"><svg xmlns="http://www.w3.org/2000/svg" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 h-2.5 w-2.5 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z" /></svg></div> Marked for Review</div>
                            <span id="marked-for-review-count" class="font-bold px-1.5 py-0.5 rounded-full text-[10px] themed-bg-accent themed-text-primary">0</span>
                        </div>
                    </div>
                </div>
                <button id="hide-palette-btn" class="absolute top-1/2 -left-3 z-10 p-1 rounded-full shadow-md border -translate-y-1/2" aria-label="Hide Question Palette">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                </button>
            </aside>

            <!-- Show Palette Button -->
            <button id="show-palette-btn" class="hidden absolute top-1/2 right-4 z-10 p-2 rounded-full shadow-lg border -translate-y-1/2" aria-label="Show Question Palette">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
            </button>
        </div>

        <!-- SCREEN 3: RESULTS -->
        <div id="results-screen" class="screen flex-col items-center justify-center p-8">
            <div class="w-full max-w-4xl p-8 rounded-lg shadow-lg themed-bg-secondary themed-shadow">
                <h1 class="text-4xl font-bold mb-4 text-center themed-text-accent">Exam Results</h1>
                <div id="exam-details" class="text-sm themed-text-secondary mb-6 border-b pb-4 space-y-1 themed-border-primary"></div>
                <div id="overall-performance" class="p-6 rounded-lg mb-8 text-center themed-bg-primary"></div>
                <h2 class="text-2xl font-semibold mb-4 text-center">Section-wise Analysis</h2>
                <div id="section-analysis" class="space-y-4"></div>
                <div class="mt-8 flex justify-center gap-4">
                    <button id="review-answers-btn" class="py-3 px-8 text-white rounded font-bold" style="background-color: var(--text-accent);" aria-label="Review Answers">Review Answers</button>
                    <button id="download-report-btn" class="py-3 px-8 text-white rounded font-bold" style="background-color: var(--text-success); color: var(--text-inverted);" aria-label="Download Report">Download Report</button>
                    <button id="restart-btn" class="py-3 px-8 rounded font-bold themed-bg-accent themed-text-primary" aria-label="Start New Exam">New Exam</button>
                </div>
            </div>
        </div>
        
        <!-- SCREEN 4: REVIEW -->
        <div id="review-screen" class="screen h-full flex-col">
          <header class="p-3 shadow-md flex justify-between items-center w-full themed-bg-secondary">
              <h1 id="review-title" class="text-xl font-bold themed-text-accent">Review Mode</h1>
               <div class="flex items-center space-x-4">
                    <button id="save-mcq-btn" class="p-2 rounded-full themed-bg-accent-hover" aria-label="Save Question">
                        <!-- SVG will be injected here -->
                    </button>
                    <button id="exit-revise-btn" class="py-2 px-4 rounded themed-bg-accent themed-bg-accent-hover hidden" aria-label="Exit Revise Mode">Exit Revise</button>
                    <button id="back-to-results-btn" class="py-2 px-4 rounded themed-bg-accent themed-bg-accent-hover" aria-label="Back to Results">Back to Results</button>
                </div>
          </header>
          <div id="review-palette-container" class="w-full max-w-4xl mx-auto p-4 border-b overflow-x-auto themed-bg-primary themed-border-primary">
             <div id="review-palette-grid" class="flex flex-nowrap gap-3 justify-start">
                 <!-- Review palette buttons will be injected here -->
             </div>
          </div>
          <main class="flex-1 p-6 overflow-y-auto w-full max-w-4xl mx-auto">
              <div class="p-6 rounded-lg themed-bg-secondary">
                  <div class="flex justify-between items-center">
                    <p id="review-question-text" class="text-lg font-semibold mb-6 whitespace-pre-wrap flex-1"></p>
                    <div id="review-time-taken" class="text-sm flex items-center ml-4 flex-shrink-0 themed-text-secondary"></div>
                  </div>
                  <div id="review-question-image-container" class="my-4 flex justify-center"></div>
                  <div id="review-options-container" class="space-y-4"></div>
                  
                  <!-- EXPLANATION SECTION -->
                  <div class="explanation-card" id="review-explanation-card">
                       <div class="explanation-header">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Explanation
                       </div>

                      <div id="explanation-image-container" class="my-4 flex justify-center"></div>
                      <div id="explanation-container" class="explanation-content prose max-w-none">
                          <!-- Explanation text will go here -->
                      </div>
                  </div>
              </div>
          </main>
          <footer class="p-4 shadow-inner flex justify-between items-center w-full themed-bg-secondary" style="box-shadow: 0 -2px 5px var(--shadow-color);">
              <button id="review-prev-btn" class="py-2 px-6 rounded disabled:opacity-50 themed-bg-accent themed-bg-accent-hover" aria-label="Previous Question">Previous</button>
              <span id="review-question-counter" class="font-bold"></span>
              <button id="review-next-btn" class="py-2 px-6 rounded disabled:opacity-50 themed-bg-accent themed-bg-accent-hover" aria-label="Next Question">Next</button>
          </footer>
        </div>
        
        <!-- SCREEN 5: PRACTICE MODE -->
        <div id="practice-screen" class="screen h-full flex-col relative">
            <header class="p-3 shadow-md flex justify-between items-center w-full themed-bg-secondary">
                <div class="flex items-center space-x-4">
                    <div>
                        <h1 class="text-xl font-bold themed-text-warning">Practice Mode</h1>
                        <p id="practice-subject-name" class="text-sm themed-text-tertiary"></p>
                    </div>
                </div>
                
                <!-- STREAK COUNTER & FEEDBACK -->
                <div id="practice-streak-container" class="flex-1 flex justify-center items-center">
                    <div id="streak-badge" class="streak-badge hidden">
                        <span class="mr-1">ðŸ”¥</span> Streak: <span id="streak-count" class="ml-1">0</span>
                    </div>
                    <!-- Header Feedback Badge -->
                    <div id="header-feedback-badge" class="feedback-badge">
                         <span id="header-feedback-text"></span>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <button id="save-mcq-practice-btn" class="p-2 rounded-full themed-bg-accent-hover" aria-label="Save Question">
                        <!-- SVG will be injected here -->
                    </button>
                    <button id="toggle-sparkles-btn" class="p-2 rounded-full themed-bg-accent-hover" aria-label="Toggle Sparkles">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                       </svg>
                    </button>
                    <button id="practice-calculator-toggle-btn" class="p-2 rounded-full themed-bg-accent-hover" aria-label="Toggle Calculator">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 themed-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                       </svg>
                    </button>
                    <div id="practice-timer" class="text-xl font-mono px-4 py-1 rounded hidden themed-bg-accent themed-text-primary" aria-label="Practice Timer"></div>
                    <button id="exit-practice-btn" class="py-2 px-4 rounded themed-bg-accent themed-bg-accent-hover" aria-label="Exit Practice Mode">Exit Practice</button>
                </div>
            </header>
            
            <div id="practice-palette-container" class="w-full max-w-4xl mx-auto p-4 border-b overflow-x-auto themed-bg-primary themed-border-primary">
                 <div id="practice-palette-grid" class="flex flex-nowrap gap-3 justify-start">
                     <!-- Practice palette buttons injected by JS -->
                 </div>
            </div>

            <div id="per-question-timer-container" class="w-full h-2 themed-bg-accent hidden">
                <div id="per-question-timer-bar" class="h-full bg-green-500" style="transition: width 150ms linear;"></div>
            </div>
            <main class="flex-1 p-6 overflow-y-auto w-full max-w-4xl mx-auto">
                <div class="p-6 rounded-lg themed-bg-secondary">
                    <p id="practice-question-text" class="text-lg font-semibold mb-6 whitespace-pre-wrap"></p>
                    <div id="practice-question-image-container" class="my-4 flex justify-center"></div>
                    <div id="practice-options-container" class="space-y-4"></div>
                    
                    <!-- EXPLANATION SECTION -->
                    <div id="practice-explanation-section" class="hidden explanation-card">
                        <div class="explanation-header">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Explanation
                        </div>
                        
                        <div id="practice-explanation-image-container" class="my-4 flex justify-center"></div>
                        <div id="practice-explanation-container" class="explanation-content prose max-w-none">
                            <!-- Explanation text will go here -->
                        </div>
                    </div>
                </div>
            </main>
            <footer class="p-4 shadow-inner flex justify-between items-center w-full themed-bg-secondary" style="box-shadow: 0 -2px 5px var(--shadow-color);">
                <button id="practice-prev-btn" class="py-2 px-6 rounded disabled:opacity-50 themed-bg-accent themed-bg-accent-hover" aria-label="Previous Question">Previous</button>
                <span id="practice-question-counter" class="font-bold"></span>
                <button id="practice-next-btn" class="py-2 px-6 rounded disabled:opacity-50 themed-bg-accent themed-bg-accent-hover" aria-label="Next Question">Next</button>
            </footer>
        </div>

        <!-- SCREEN 6: PRACTICE RESULTS -->
        <div id="practice-results-screen" class="screen flex-col items-center justify-center p-8">
            <div class="w-full max-w-2xl p-8 rounded-lg shadow-lg text-center themed-bg-secondary themed-shadow">
                <h1 class="text-4xl font-bold mb-4 themed-text-warning">Practice Results</h1>
                <div id="practice-exam-details" class="text-sm themed-text-secondary mb-6 border-b pb-4 space-y-1 themed-border-primary"></div>
                
                <div class="p-6 rounded-lg mb-8 themed-bg-primary">
                    <h2 class="text-2xl font-semibold">Your Performance</h2>
                    <p id="practice-score" class="text-5xl font-bold my-4"></p>
                    <div class="flex justify-center space-x-8 text-lg">
                        <span id="practice-correct"></span>
                        <span id="practice-incorrect"></span>
                        <span id="practice-attempted"></span>
                    </div>
                     <div id="practice-avg-time" class="mt-4 themed-text-secondary"></div>
                </div>
                
                <div class="mt-8 flex justify-center gap-4">
                    <button id="review-practice-answers-btn" class="py-3 px-8 rounded font-bold" style="background-color: var(--text-accent); color: var(--text-inverted);" aria-label="Review Practice Answers">Review Answers</button>
                    <button id="restart-practice-btn" class="py-3 px-8 rounded font-bold" style="background-color: var(--text-warning); color: var(--bg-primary);" aria-label="Restart Practice">Restart Practice</button>
                    <button id="back-to-setup-btn" class="py-3 px-8 rounded font-bold themed-bg-accent themed-text-primary" aria-label="Back to Setup">Back to Setup</button>
                </div>
            </div>
        </div>

        <!-- SCREEN 7: PAST RESULTS HISTORY -->
        <div id="past-results-screen" class="screen flex-col items-center justify-center p-8">
            <div class="w-full max-w-3xl p-8 rounded-lg shadow-lg themed-bg-secondary themed-shadow">
                <h1 class="text-3xl font-bold mb-6 text-center themed-text-accent">Past Exam Results</h1>
                <div id="past-results-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                    <!-- Past results will be injected here -->
                </div>
                <div class="mt-8 flex justify-center">
                    <button id="back-to-setup-from-history-btn" class="py-3 px-8 rounded font-bold themed-bg-accent themed-text-primary" aria-label="Back to Setup">Back to Setup</button>
                </div>
            </div>
        </div>

        <!-- SCREEN 8: PROGRESS ANALYTICS (CHARTS) -->
        <div id="progress-screen" class="screen flex-col items-center justify-center p-8">
            <div class="w-full max-w-5xl p-8 rounded-lg shadow-lg themed-bg-secondary themed-shadow overflow-y-auto max-h-full">
                <h1 class="text-3xl font-bold mb-6 text-center themed-text-accent">Performance Analytics</h1>
                
                <!-- KPI Dashboard (Inserted) -->
                <div id="kpi-dashboard" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <!-- Cards injected by JS -->
                </div>

                <!-- Exam Progress -->
                <div class="mb-8">
                    <h2 class="text-xl font-bold mb-4 themed-text-primary flex items-center">
                        <svg class="w-5 h-5 mr-2 themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        Exam History
                    </h2>
                    <div id="exam-chart-container" class="chart-wrapper">
                        <!-- Exam bars injected here -->
                    </div>
                    <p id="exam-chart-empty" class="text-sm themed-text-tertiary mt-2 text-center hidden">No exam attempts recorded yet.</p>
                </div>

                <!-- Practice Progress -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold themed-text-warning flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            Practice History
                        </h2>
                        <button id="reset-practice-history-btn" class="text-xs py-1 px-3 rounded border border-red-300 text-red-500 hover:bg-red-50">Reset Practice History</button>
                    </div>
                    <div id="practice-chart-container" class="chart-wrapper">
                        <!-- Practice bars injected here -->
                    </div>
                    <p id="practice-chart-empty" class="text-sm themed-text-tertiary mt-2 text-center hidden">No practice sessions recorded yet.</p>
                </div>

                <div class="flex justify-center">
                    <button id="back-to-setup-from-progress-btn" class="py-3 px-8 rounded font-bold themed-bg-accent themed-text-primary" aria-label="Back to Setup">Back to Setup</button>
                </div>
            </div>
        </div>


        <!-- MODAL: CONFIRMATION -->
        <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
            <div class="p-8 rounded-lg shadow-xl max-w-sm w-full text-center modal-card">
                <h2 class="text-xl font-bold mb-4">Confirm Action</h2>
                <p id="confirmation-message" class="mb-6 themed-text-secondary"></p>
                <div class="flex justify-center gap-4">
                    <button id="cancel-confirmation-btn" class="py-2 px-6 rounded font-semibold themed-bg-accent themed-bg-accent-hover" aria-label="Cancel Action">Cancel</button>
                    <button id="confirm-action-btn" class="py-2 px-6 rounded font-semibold text-white" style="background-color: var(--text-danger); color: var(--text-inverted);" aria-label="Confirm Action">Proceed</button>
                </div>
            </div>
        </div>

        <!-- MODAL: REPORT OPTIONS -->
        <div id="report-options-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
            <div class="p-8 rounded-lg shadow-xl max-w-sm w-full text-center modal-card">
                <h2 class="text-xl font-bold mb-4">Download Report</h2>
                <p class="mb-6 themed-text-secondary">Would you like to include the explanations in your PDF report?</p>
                <div class="flex flex-col gap-4">
                    <button id="download-with-explanations-btn" class="py-2 px-6 rounded font-semibold" style="background-color: var(--text-success); color: var(--text-inverted);" aria-label="Download with explanations">With Explanations</button>
                    <button id="download-without-explanations-btn" class="py-2 px-6 rounded font-semibold" style="background-color: var(--text-accent); color: var(--text-inverted);" aria-label="Download without explanations">Without Explanations</button>
                    <button id="cancel-report-download-btn" class="py-2 px-6 rounded font-semibold mt-2 themed-bg-accent themed-bg-accent-hover" aria-label="Cancel Download">Cancel</button>
                </div>
            </div>
        </div>

        <!-- MODAL: PRACTICE RESUME -->
        <div id="practice-resume-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
            <div class="p-8 rounded-lg shadow-xl max-w-sm w-full text-center modal-card">
                <h2 class="text-xl font-bold mb-4">Resume Practice</h2>
                <p class="mb-6 themed-text-secondary">You have a saved practice session. Would you like to continue where you left off?</p>
                <div class="flex justify-center gap-4">
                    <button id="practice-start-new-btn" class="py-2 px-6 rounded font-semibold themed-bg-accent themed-bg-accent-hover" aria-label="Start new practice">Start New</button>
                    <button id="practice-resume-btn" class="py-2 px-6 rounded font-semibold text-white bg-yellow-500 hover:bg-yellow-600" aria-label="Resume practice">Resume</button>
                </div>
            </div>
        </div>
        
        <!-- CALCULATOR MODAL -->
        <div id="calculator-modal" class="calculator-modal absolute w-64 rounded-lg shadow-2xl z-50 hidden">
            <div id="calculator-header" class="p-2 flex justify-between items-center rounded-t-lg cursor-move themed-bg-accent">
                <span class="font-bold themed-text-secondary">Calculator</span>
                <button id="calculator-close-btn" class="text-xl themed-text-secondary hover:themed-text-primary" aria-label="Close Calculator">&times;</button>
            </div>
            <div class="p-4">
                <div id="calculator-display" class="text-right text-3xl font-mono p-2 rounded mb-4 overflow-x-auto themed-bg-tertiary" aria-label="Calculator Display">0</div>
                <div id="calculator-buttons" class="grid grid-cols-4 gap-2">
                    <button class="calculator-btn col-span-2" style="background-color: var(--text-danger); color: var(--text-inverted);" aria-label="Clear Calculation">C</button>
                    <button class="calculator-btn operator themed-bg-accent themed-bg-accent-hover">/</button>
                    <button class="calculator-btn operator themed-bg-accent themed-bg-accent-hover">*</button>

                    <button class="calculator-btn digit themed-bg-tertiary">7</button>
                    <button class="calculator-btn digit themed-bg-tertiary">8</button>
                    <button class="calculator-btn digit themed-bg-tertiary">9</button>
                    <button class="calculator-btn operator themed-bg-accent themed-bg-accent-hover">-</button>

                    <button class="calculator-btn digit themed-bg-tertiary">4</button>
                    <button class="calculator-btn digit themed-bg-tertiary">5</button>
                    <button class="calculator-btn digit themed-bg-tertiary">6</button>
                    <button class="calculator-btn operator themed-bg-accent themed-bg-accent-hover">+</button>

                    <button class="calculator-btn digit themed-bg-tertiary">1</button>
                    <button class="calculator-btn digit themed-bg-tertiary">2</button>
                    <button class="calculator-btn digit themed-bg-tertiary">3</button>
                    <button class="calculator-btn equals row-span-2" style="background-color: var(--text-accent); color: var(--text-inverted);" aria-label="Calculate Result">=</button>
                    
                    <button class="calculator-btn col-span-2 digit themed-bg-tertiary">0</button>
                    <button class="calculator-btn decimal themed-bg-tertiary">.</button>
                </div>
            </div>
        </div>
    </main>

<script>
    // --- APP INITIALIZATION ---
    // Prevent right-click to protect content
    document.addEventListener('contextmenu', (e) => e.preventDefault());

    // Prevent inspection via keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
        if (e.key === 'F12' || 
            (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) || 
            (e.ctrlKey && e.key === 'U')) {
            e.preventDefault();
        }
    });

    window.addEventListener('DOMContentLoaded', () => {
      try {
        // --- DATA & STATE ---
        // FIX: Using renamed variable from outer scope.
        const examId = 'exam_1765464039475_g95jee1';
        const mcqs = [{"id":1,"question":"A 26-year-old woman presents with ptosis worsening in the evening. Ice-pack test improves ptosis. She has positive anti-AChR antibodies. Which structure is most commonly abnormal in this condition?","options":{"a":"Thymus","b":"Thyroid","c":"Substantia nigra","d":"Basal ganglia"},"correctAnswer":"a","explanation":"**1. High-Yield Topic Explanation**\n\nIn myasthenia gravis (MG) with evening ptosis (fatigable weakness), ice-pack test improvement (transient AChE inhibition), and positive anti-AChR antibodies, the most commonly abnormal structure is the thymus. Thymoma is present in 10-15% of MG; thymic hyperplasia in 60-70%. The thymus is believed to harbor autoreactive B cells generating anti-AChR antibodies. Thymectomy improves symptoms in 30-50% of patients, especially if performed early in seronegative disease.\n\n**2. Rationale for Incorrect Options**\n\n- **b) Thyroid:** Hashimoto thyroiditis can coexist with MG; not the primary abnormality in MG pathogenesis.\n- **c) Substantia nigra:** Involved in Parkinson disease; not related to MG.\n- **d) Basal ganglia:** Movement disorder pathology; not involved in MG.\n\n**3. Exam Essentials**\n\n- **Thymic involvement in MG:** Hyperplasia (most common), thymoma (10-15%), or normal (myasthenic crisis variant).\n- **Thymectomy indications:** Early-onset MG, thymoma present, seronegative disease; improves outcomes.\n- **Antibodies:** Anti-AChR (80%), anti-MuSK (5%), seronegative (15%).\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"MG Pathophysiology\":**\n- **M** â€“ Myasthenia (muscle weakness, fatigable)\n- **G** â€“ Gravis (serious)\n- **T** â€“ Thymic (thymoma/hyperplasia in 70%)\n- **A** â€“ Antibodies (anti-AChR)"},{"id":2,"question":"A 62-year-old smoker presents with proximal muscle weakness that improves with repeated muscle use. NCS shows incremental response. Which antibody is most likely?","options":{"a":"Anti-AChR","b":"Anti-VGCC","c":"Anti-MuSK","d":"Anti-GQ1b"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn Lambert-Eaton myasthenic syndrome (LEMS) presenting with proximal muscle weakness improving with repeated use (opposite of MG) and incremental response on NCS (amplitude increases with repetitive stimulation), the antibody most likely is anti-VGCC (voltage-gated calcium channel). LEMS is a paraneoplastic syndrome (50-60% have malignancy, especially SCLC) caused by IgG antibodies blocking presynaptic calcium channels, reducing acetylcholine release.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Anti-AChR:** Myasthenia gravis; weakness worsens with repeated use (opposite pattern).\n- **c) Anti-MuSK:** Seronegative MG variant; not LEMS.\n- **d) Anti-GQ1b:** Miller Fisher syndrome (variant GBS); ophthalmoplegia, ataxia, areflexia.\n\n**3. Exam Essentials**\n\n- **LEMS features:** Proximal weakness improves with use, autonomic dysfunction (dry mouth, constipation), hypo/areflexia.\n- **Diagnosis:** Anti-VGCC antibodies (positive in 85%), incremental EMG response (key finding).\n- **Treatment:** 3,4-diaminopyridine (increases acetylcholine release), immunosuppression, treat underlying malignancy.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"NMJ Antibodies\":**\n- **Anti-AChR:** Myasthenia gravis (weakness worsens with use)\n- **Anti-VGCC:** LEMS (weakness improves with use, paraneoplastic)\n- **Anti-MuSK:** Seronegative MG (ocular-bulbar predominant)"},{"id":3,"question":"A patient presents with rapidly progressive ascending paralysis, hypo-reflexia, and CSF showing albumino-cytological dissociation. The next step in monitoring severity is:","options":{"a":"Serum CK","b":"FVC monitoring","c":"Brain MRI","d":"Tensilon test"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn Guillain-BarrÃ© syndrome (GBS) presenting with rapidly progressive ascending paralysis, hyporeflexia, and albumino-cytological dissociation (high CSF protein with low cells), the next step in monitoring severity is FVC (forced vital capacity). FVC measures respiratory muscle strength; FVC \u003c20 mL/kg or \u003c1.5 L indicates need for mechanical ventilation. Respiratory failure is the major cause of mortality in severe GBS, making FVC monitoring critical for ventilator preparation.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Serum CK:** Not markedly elevated in GBS; useful in myopathy.\n- **c) Brain MRI:** CNS imaging not indicated in GBS (peripheral neuropathy, not CNS).\n- **d) Tensilon test:** Tests neuromuscular junction; not relevant to GBS.\n\n**3. Exam Essentials**\n\n- **GBS respiratory monitoring:** FVC >20 mL/kg = mild, 15-20 = moderate, \u003c15 = severe requiring ICU.\n- **Respiratory complications:** 25% require mechanical ventilation; autonomic dysfunction (arrhythmias, BP lability) common.\n- **Treatment:** IVIG or plasmapheresis; supportive care (ventilation, monitoring); mortality \u003c5% with treatment.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":4,"question":"A 55-year-old man presents with both UMN signs (hyperreflexia) and LMN signs (fasciculations). He also has progressive dysphagia. Which complication is the most common cause of death?","options":{"a":"Renal failure","b":"Aspiration pneumonia","c":"Sudden cardiac arrest","d":"Sepsis"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn amyotrophic lateral sclerosis (ALS) with UMN signs (hyperreflexia) + LMN signs (fasciculations) + progressive dysphagia, the most common cause of death is aspiration pneumonia from bulbar dysfunction (dysphagia, dysarthria). As disease progresses, impaired swallowing allows food/secretion aspiration, leading to recurrent pneumonia and respiratory compromise. Other causes include respiratory failure (diaphragm paralysis) and autonomic dysfunction.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Renal failure:** Not typical in ALS; renal function usually preserved.\n- **c) Sudden cardiac arrest:** Can occur but less common than aspiration pneumonia.\n- **d) Sepsis:** Often secondary to aspiration pneumonia; not primary cause.\n\n**3. Exam Essentials**\n\n- **ALS features:** Progressive UMN/LMN dysfunction, bulbar involvement (dysarthria, dysphagia), respiratory weakness.\n- **Diagnosis:** EMG showing denervation (fibrillations, positive sharp waves), NCS relatively normal, no sensory involvement.\n- **Prognosis:** Median survival 3-5 years; bulbar-onset worse prognosis than limb-onset.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":5,"question":"A patient with suspected MS undergoes MRI showing oval hyperintensities with Dawsonâ€™s fingers. CSF shows oligoclonal bands. Diagnosis requires:","options":{"a":"â‰¥2 demyelinating events separated by â‰¥1 month","b":"One event + abnormal EEG","c":"Positive anti-MBP alone","d":"Only MRI abnormalities"},"correctAnswer":"a","explanation":"**1. High-Yield Topic Explanation**\n\nMultiple sclerosis diagnosis requires dissemination in space (DIS) and dissemination in time (DIT) under McDonald criteria. â‰¥2 demyelinating events separated by â‰¥1 month (or â‰¥2 lesions on MRI separated spatially and temporally) are required for diagnosis. MRI showing \"Dawson's fingers\" (perivenous lesions) and oligoclonal bands in CSF support the diagnosis but â‰¥2 temporal/spatial events define MS, distinguishing from isolated demyelinating episode (CIS).\n\n**2. Rationale for Incorrect Options**\n\n- **b) One event + abnormal EEG:** Insufficient for MS; requires two events or dissemination pattern.\n- **c) Anti-MBP alone:** Not diagnostic; can be positive in other demyelinating diseases.\n- **d) Only MRI abnormalities:** Insufficient without clinical correlation and temporal separation.\n\n**3. Exam Essentials**\n\n- **McDonald criteria:** DIS (â‰¥1 lesion in â‰¥2 CNS regions) and DIT (â‰¥2 events â‰¥1 month apart or simultaneous DIS + DIT).\n- **Demyelinating lesions:** Periventricular (85%), infratentorial (50%), spinal cord (50% have cord involvement).\n- **CSF findings:** Oligoclonal bands (90%), IgG index elevated, pleocytosis.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"MS Diagnosis (McDonald)\":**\n- **D** â€“ Dissemination in Space (â‰¥2 lesions in â‰¥2 regions)\n- **D** â€“ Dissemination in Time (â‰¥2 events â‰¥1 month apart)\n- **Both required** for MS diagnosis (or variants with specific criteria)"},{"id":6,"question":"A 23-year-old female has sudden unilateral vision loss with pain on eye movement. MRI shows \u003c3segment spinal cord involvement. Antibody likely?","options":{"a":"Anti-AQP4","b":"Anti-MBP","c":"Anti-MOG","d":"Anti-GD1a"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nIn neuromyelitis optica spectrum disorder (NMOSD) with sudden unilateral vision loss (optic neuritis), pain on eye movement, and \u003c3 segment spinal cord involvement on MRI, the antibody most likely is anti-MOG (myelin oligodendrocyte glycoprotein). Anti-MOG is more prevalent in seronegative patients with limited cord involvement (\u003c3 segments); anti-AQP4 typically presents with longitudinally extensive transverse myelitis (LETM) â‰¥3 segments. Limited NMO with anti-MOG has better prognosis than AQP4-positive disease.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Anti-AQP4:** Associated with extensive spinal involvement (â‰¥3 segments), recurrent relapses; more severe.\n- **b) Anti-MBP:** Less specific; can be seen in various demyelinating diseases.\n- **d) Anti-GD1a:** Miller Fisher syndrome variant of GBS; not NMOSD.\n\n**3. Exam Essentials**\n\n- **NMOSD classification:** Anti-AQP4+ disease (severe, extensive), anti-MOG+ disease (often monophasic), seronegative.\n- **Anti-MOG characteristics:** Younger age, better prognosis, fewer relapses, shorter cord lesions.\n- **Treatment:** Corticosteroids acutely; preventive immunosuppression (azathioprine, mycophenolate); avoid beta-interferons (worsen).\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":7,"question":"A 70-year-old man presents with bradykinesia, rigidity, resting tremor, and micrographia. MRI shows loss of swallow-tail sign. What is the most effective treatment?","options":{"a":"Bromocriptine","b":"Levodopa + Carbidopa","c":"Amantadine","d":"Rasagiline alone"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn Parkinson disease with bradykinesia, rigidity, resting tremor, micrographia, and loss of \"swallow-tail sign\" on MRI (indicating substantia nigra degeneration), the most effective treatment is levodopa + carbidopa. Levodopa crosses the blood-brain barrier; carbidopa inhibits peripheral decarboxylase, maximizing CNS levodopa availability and dopamine production. Levodopa remains gold-standard for symptom control, especially for rigidity and bradykinesia.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Bromocriptine:** Dopamine agonist; less effective than levodopa; used as adjunct.\n- **c) Amantadine:** Weak anti-parkinsonian agent; mainly for tremor and dyskinesia.\n- **d) Rasagiline alone:** MAOB inhibitor; mild effect; adjunct to levodopa, not monotherapy.\n\n**3. Exam Essentials**\n\n- **Levodopa dosing:** Start low (25 mg three times daily), titrate gradually; long-term motor complications develop (on-off, dyskinesias).\n- **Carbidopa role:** Peripheral decarboxylase inhibitor; prevents dopamine loss in periphery; standard 1:10 ratio.\n- **Long-term concerns:** Motor fluctuations, dyskinesias after 5-10 years; manage with dose adjustments, COMT inhibitors.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Parkinson Medication Hierarchy\":**\n- **Levodopa + carbidopa** (gold-standard, most effective)\n- **Dopamine agonists** (bromocriptine, pramipexole, ropinirole)\n- **MAO-B inhibitors** (rasagiline, selegiline)\n- **Anticholinergics** (benztropine, trihexyphenidyl)\n- **Amantadine** (tremor, dyskinesia)"},{"id":8,"question":"A patient presents with vertical gaze palsy and frequent falls. MRI shows â€œhummingbird sign.â€ Diagnosis?","options":{"a":"Parkinson disease","b":"PSP","c":"MSA","d":"Drug-induced parkinsonism"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn progressive supranuclear palsy (PSP) presenting with vertical gaze palsy and frequent falls, the characteristic \"hummingbird sign\" on MRI (midbrain atrophy with preservation of pons) is diagnostic. Vertical supranuclear gaze palsy is hallmark; postural instability with early falls (unlike Parkinson disease where falls are late); preserved horizontal saccades initially. PSP is a tauopathy; prognosis worse than Parkinson disease.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Parkinson disease:** Horizontal gaze usually preserved; tremor common (PSP rarely); late falls.\n- **c) MSA:** Autonomic dysfunction prominent (orthostatic hypotension); different imaging (\"hot-cross bun\").\n- **d) Drug-induced parkinsonism:** From dopamine antagonists; reverses with drug withdrawal.\n\n**3. Exam Essentials**\n\n- **PSP features:** Vertical gaze palsy (down first, then up), early postural instability/falls, pseudobulbar palsy, frontal lobe signs.\n- **\"Hummingbird sign\":** Midbrain atrophy; pathognomonic finding on MRI.\n- **Treatment:** Symptomatic (dopamine agonists may worsen); no disease-modifying therapy; prognosis poor (survival 6-8 years).\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":9,"question":"A 34-year-old woman presents with unilateral, pulsatile headache lasting 6 hours with photophobia and aura of flashing zig-zag lights. Acute therapy?","options":{"a":"Indomethacin","b":"Verapamil","c":"Triptans","d":"Propranolol"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nIn migraine with aura (unilateral pulsatile headache, 6-hour duration, photophobia, aura of flashing zig-zag lights), the acute therapy of choice is triptans (5-HT1B/1D agonists). Triptans cause cranial vasoconstriction and inhibit neuropeptide release, effective for acute migraine relief, especially if given early. Naratriptan, sumatriptan, and zolmitriptan are commonly used; intranasal or subcutaneous forms for rapid onset.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Indomethacin:** For chronic paroxysmal hemicrania and hemicranias continua; not first-line acute migraine.\n- **b) Verapamil:** Prophylactic agent for migraine prevention; not acute therapy.\n- **d) Propranolol:** Prophylactic beta-blocker for migraine prevention; not acute treatment.\n\n**3. Exam Essentials**\n\n- **Migraine classification:** With aura (visual/sensory/motor aura 20-60 min before headache) vs without.\n- **Acute treatment:** Triptans (first-line if tolerated), NSAIDs (aspirin, ibuprofen), combination therapy (sumatriptan-naproxen).\n- **Prophylaxis:** Beta-blockers (propranolol), verapamil, topiramate, amitriptyline for frequent migraines.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Migraine Aura Features\":**\n- **Visual:** Flashing lights (photopsia), zig-zag lines, scotomas\n- **Sensory:** Paresthesias, tingling\n- **Motor:** Weakness (rare)\n- **Duration:** 20-60 minutes before headache onset"},{"id":10,"question":"A middle-aged male has sudden severe headache, vomiting, and neck stiffness. CT shows basal cistern bleed. Cause?","options":{"a":"Hypertension","b":"Ruptured Berry aneurysm","c":"AV malformation","d":"ICA thrombosis"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn subarachnoid hemorrhage (SAH) with sudden severe headache, vomiting, neck stiffness, and basal cistern bleeding on CT, the cause is most likely ruptured berry aneurysm. Berry aneurysms account for 85% of non-traumatic SAH; Circle of Willis is most common site (85%), including anterior communicating artery (30%), posterior communicating artery (30%), and middle cerebral artery bifurcation (20%). Basal cisternal blood is classic for aneurysmal SAH.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Hypertension:** Can cause parenchymal (intracerebral) hemorrhage; subarachnoid from hypertension is less common.\n- **c) AV malformation:** Can cause SAH but less common (5% of SAH); different demographics (younger).\n- **d) ICA thrombosis:** Ischemic event; does not cause hemorrhage.\n\n**3. Exam Essentials**\n\n- **SAH presentation:** \"Worst headache of life,\" neck stiffness, photophobia, altered consciousness, cranial nerve palsies.\n- **Complications:** Rebleeding (within days), vasospasm (3-14 days), hydrocephalus, seizures.\n- **Immediate treatment:** Nimodipine (vasospasm prevention), anticoagulation reversal if needed, neurosurgery/endovascular treatment.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":11,"question":"A 68-year-old man has progressive memory loss, personality changes, and MRI showing hippocampal atrophy. Best drug to improve symptoms?","options":{"a":"Memantine","b":"Donepezil","c":"Lecanemab","d":"Haloperidol"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn Alzheimer disease with progressive memory loss, personality changes, hippocampal atrophy, the best drug to improve symptoms is donepezil (acetylcholinesterase inhibitor). Donepezil increases acetylcholine levels in cortical areas; improves cognitive function in mild-moderate disease but does not halt progression. Lecanemab (recent amyloid-targeting monoclonal antibody) slows decline in early symptomatic AD but donepezil remains first-line for symptom management.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Memantine:** NMDA receptor antagonist; used in moderate-severe AD; less effective in early disease.\n- **c) Lecanemab:** Newest anti-amyloid monoclonal; slows cognitive decline but not symptom relief; IV infusion required.\n- **d) Haloperidol:** Antipsychotic; used for behavioral symptoms only; worsens cognition, increases mortality.\n\n**3. Exam Essentials**\n\n- **Alzheimer pathology:** Amyloid-beta plaques, neurofibrillary tau tangles; hippocampal atrophy early sign.\n- **Cholinesterase inhibitors:** Donepezil, rivastigmine, galantamine; modest cognitive benefit; GI side effects common.\n- **Disease-modifying:** Lecanemab, aducanumab (amyloid-targeting); slow decline but don't reverse damage.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":12,"question":"A stroke patient arrives 3 hours after onset. BP = 180/100 mmHg. NCCT shows no bleed. Next step?","options":{"a":"Avoid thrombolysis due to BP","b":"Give aspirin immediately","c":"Perform thrombolysis","d":"Mechanical thrombectomy only"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nIn acute ischemic stroke (3 hours from onset, BP 180/100, NCCT no bleed), thrombolysis should be performed despite elevated BP. BP 180/100 is not an absolute contraindication; only BP >185/110 despite aggressive treatment precludes thrombolysis. IV thrombolysis is indicated within 4.5 hours of ischemic stroke onset; early treatment improves outcomes significantly. BP should be monitored closely post-thrombolysis but does NOT prevent acute treatment.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Avoid thrombolysis:** Incorrect reasoning; BP 180/100 permissible; outcome worse without thrombolysis.\n- **b) Aspirin immediately:** Can be given after IV thrombolysis but doesn't replace it; tPA preferred.\n- **d) Mechanical thrombectomy only:** Reserved for LVO (large vessel occlusion) in anterior circulation; IV tPA should still be given.\n\n**3. Exam Essentials**\n\n- **IV tPA window:** 3-4.5 hours from symptom onset; later window (up to 24 hours) for selected patients with thrombectomy capability.\n- **Key contraindications:** Intracerebral hemorrhage, severe HTN (>185/110), recent surgery, anticoagulation, thrombocytopenia.\n- **Mechanical thrombectomy:** 24-hour window possible with appropriate imaging; better outcomes for LVO.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Stroke Window Times\":**\n- **0-3 hours:** Preferred window for IV tPA\n- **3-4.5 hours:** Extended window for IV tPA (selected patients)\n- **0-24 hours:** Thrombectomy window (with favorable imaging)"},{"id":13,"question":"A 19-year-old boy presents with wrist drop, glove-and-stocking sensory loss. Most likely localization?","options":{"a":"NMJ disorder","b":"Upper motor neuron lesion","c":"Polyneuropathy","d":"Myopathy"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nWrist drop indicates radial nerve palsy (motor deficit); combined with glove-and-stocking sensory loss (distal, symmetric), this pattern is pathognomonic for polyneuropathy. Glove-and-stocking distribution reflects length-dependent axonal degeneration affecting longest fibers first. Wrist drop is classic motor sign of distal motor neuropathy (wrist extensors innervated by radial nerve, among distal muscles affected).\n\n**2. Rationale for Incorrect Options**\n\n- **a) NMJ disorder:** Fatigable weakness; not selective motor nerve distribution; normal sensory.\n- **b) UMN lesion:** Hyperreflexia; intact sensation or cortical distribution; no glove-stocking pattern.\n- **d) Myopathy:** Proximal weakness; distal sensation intact; symmetric pattern.\n\n**3. Exam Essentials**\n\n- **Polyneuropathy pattern:** Distal, symmetric, length-dependent; motor/sensory/autonomic combination.\n- **Common causes:** Diabetes (most common), alcohol, vitamin deficiency (B12), chemotherapy, infections (HIV, HCV).\n- **Diagnosis:** NCS/EMG shows distal axonal degeneration (low amplitude, normal velocity); nerve biopsy if atypical.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Peripheral Nerve Distribution\":**\n- **Glove-and-stocking:** Polyneuropathy (distal, symmetric)\n- **Anatomical distribution:** Nerve entrapment (radial, median, ulnar)\n- **Proximal asymmetric:** Plexopathy or radiculopathy"},{"id":14,"question":"A patient has ipsilateral loss of dorsal column function and motor weakness + contralateral loss of pain and temperature. Syndrome?","options":{"a":"Brown-Sequard","b":"Central cord syndrome","c":"Anterior cord syndrome","d":"Cauda equina"},"correctAnswer":"a","explanation":"**1. High-Yield Topic Explanation**\n\nBrown-SÃ©quard syndrome (hemisection of spinal cord) presents with ipsilateral loss of dorsal column (proprioception, vibration) + motor weakness (corticospinal tract) and contralateral loss of pain and temperature (spinothalamic tract crossing levels below lesion). This distinctive dissociated sensory loss (intact pain sense ipsilateral, intact proprioception contralateral) distinguishes Brown-SÃ©quard from other cord syndromes. Wasting/weakness is ipsilateral due to anterior horn cell involvement at lesion level.\n\n**2. Rationale for Incorrect Options**\n\n- **b) Central cord:** Bilateral upper extremity weakness; bilateral pain/temperature loss; different from Brown-SÃ©quard.\n- **c) Anterior cord:** Bilateral motor and pain/temperature loss; proprioception preserved (posterior column spared).\n- **d) Cauda equina:** Lower motor neuron signs only; saddle anesthesia; bowel/bladder involvement.\n\n**3. Exam Essentials**\n\n- **Brown-SÃ©quard features:** Ipsilateral weakness, ipsilateral proprioception loss, contralateral pain/temperature loss.\n- **Level-dependent findings:** Lower cervical Brown-SÃ©quard may show ipsilateral hand weakness + contralateral leg pain loss.\n- **Prognosis:** 75% achieve functional recovery if incomplete; complete hemisection rare.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Brown-SÃ©quard Features\":**\n- **Ipsilateral:** Motor (weakness), proprioception (vibration/position sense)\n- **Contralateral:** Pain and temperature (spinothalamic)\n- **Remember:** Asymmetric sensory loss across midline"},{"id":15,"question":"A smoker develops cerebellar signs, ataxia, and autonomic dysfunction. MRI shows â€œhot-cross bunâ€ sign. Diagnosis?","options":{"a":"Parkinson disease","b":"MSA","c":"PSP","d":"Wilson disease"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn multiple system atrophy (MSA) with cerebellar signs (ataxia), autonomic dysfunction, and characteristic \"hot-cross bun\" sign on MRI (pontine atrophy with selective degeneration of basis pontis and transverse fibers), this is diagnostic. MSA is a synucleinopathy (alpha-synuclein accumulation) affecting cerebellum, basal ganglia, and brainstem. Cerebellar subtype (MSA-C) manifests ataxia; parkinsonian subtype (MSA-P) shows parkinsonism; both have autonomic failure and \"hot-cross bun.\"\n\n**2. Rationale for Incorrect Options**\n\n- **a) Parkinson disease:** No pontine atrophy or \"hot-cross bun\"; substantia nigra preserved initially.\n- **c) PSP:** \"Hummingbird sign\" (midbrain atrophy); vertical gaze palsy; different imaging.\n- **d) Wilson disease:** Kayser-Fleischer rings, low ceruloplasmin; different pathology (copper); ataxia can occur but imaging different.\n\n**3. Exam Essentials**\n\n- **MSA features:** Autonomic dysfunction (orthostatic hypotension, erectile dysfunction, urinary incontinence), cerebellar signs, parkinsonism.\n- **\"Hot-cross bun\":** Pontine atrophy with T2 hyperintensity of corticospinal tracts, transverse fibers; pathognomonic.\n- **Prognosis:** Rapidly progressive; median survival 7-10 years; no disease-modifying treatment.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"MSA Triad\":**\n- Parkinsonian features (rigidity, bradykinesia)\n- Autonomic dysfunction (hypotension, incontinence)\n- Cerebellar signs (ataxia, dysarthria)"},{"id":16,"question":"A 22-year-old woman has episodic nocturnal wheeze. Baseline spirometry is normal. Methacholine challenge causes a 22% fall in FEV1. What is the correct interpretation?","options":{"a":"Test is negative","b":"Test is positive â€“ airway hyperresponsiveness","c":"Inconclusive because baseline spirometry normal","d":"Repeat after bronchodilator withdrawal"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nMethacholine challenge test showing 22% fall in FEVâ‚ (PC20 = concentration causing 20% FEVâ‚ drop) is positive for airway hyperresponsiveness (AHR). Normal: PC20 >16 mg/mL; AHR: PC20 â‰¤16 mg/mL. This patient's episodic nocturnal wheeze with positive methacholine challenge confirms asthma diagnosis despite normal baseline spirometry. AHR is hallmark of asthma; baseline FEVâ‚ may be normal between exacerbations.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Test negative:** Fall of 22% meets positivity threshold (â‰¥20% is positive).\n- **c) Inconclusive because baseline normal:** Normal baseline does not invalidate positive challenge; AHR present even with normal FEVâ‚.\n- **d) Repeat after bronchodilator withdrawal:** Not necessary if 22% fall already documented; positive test confirmed.\n\n**3. Exam Essentials**\n\n- **Methacholine PC20 interpretation:** â‰¤8 mg/mL = hyperresponsive, 8-16 = borderline, >16 = normal.\n- **Clinical relevance:** Positive challenge confirms asthma even with normal spirometry; useful for diagnosis of suspected asthma.\n- **Specificity:** AHR seen in asthma, COPD, CF, bronchiectasis; not asthma-specific but clinically useful.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Methacholine PC20 Thresholds\":**\n- **â‰¤8 mg/mL:** Markedly hyperresponsive (asthma likely)\n- **8-16 mg/mL:** Borderline hyperresponsiveness\n- **>16 mg/mL:** Normal (AHR excluded)"},{"id":17,"question":"A 58-year-old smokerâ€™s PFT shows FEV1/FVC 52%, RV high, normal DLCO, minimal bronchodilator response. Most likely phenotype?","options":{"a":"Emphysema","b":"Chronic bronchitis COPD","c":"Asthma","d":"ACO"},"correctAnswer":"a","explanation":"**1. High-Yield Topic Explanation**\n\nIn a COPD patient with FEVâ‚/FVC 52% (obstruction), elevated RV (air trapping), and normal DLCO, this indicates emphysema phenotype. Normal DLCO distinguishes emphysema from asthma (where DLCO normal) but indicates parenchymal destruction without significant alveolar loss of surface area relative to expected for emphysema severity, OR early emphysema with preserved diffusion. The high RV is classic for emphysema from air trapping.\n\n**2. Rationale for Incorrect Options**\n\n- **b) Chronic bronchitis COPD:** Airways involvement; DLCO may be reduced if concurrent emphysema.\n- **c) Asthma:** Bronchodilator response usually >12%; persistent obstruction (FEVâ‚/FVC \u003c0.7) suggests fixed obstruction/remodeling.\n- **d) ACO:** Asthma-COPD overlap; would expect higher response to bronchodilator.\n\n**3. Exam Essentials**\n\n- **Emphysema pathology:** Alveolar destruction, loss of elastic recoil, air trapping, RV elevation.\n- **DLCO significance:** Reduced in emphysema from loss of alveolar surface area; normal DLCO argues against pure emphysema.\n- **Smoking history:** Strong risk factor; most common cause of emphysema.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"COPD Phenotypes\":**\n- **Emphysema:** â†‘RV, â†“DLCO, hyperinflation\n- **Chronic bronchitis:** Productive cough, bronchial wall thickening, normal RV\n- **Mixed:** Combination features"},{"id":18,"question":"Which abnormality appears earliest in idiopathic pulmonary fibrosis?","options":{"a":"â†“TLC","b":"â†“DLCO","c":"â†“FEV1","d":"â†“FEV1/FVC"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn idiopathic pulmonary fibrosis (IPF), the earliest PFT abnormality is reduced DLCO before TLC, FEVâ‚, or FEVâ‚/FVC changes appear. DLCO reduction reflects early alveolar inflammation and capillary involvement before significant parenchymal fibrosis causes restrictive pattern. This makes DLCO the most sensitive early marker for IPF; TLC becomes abnormal later as fibrosis progresses.\n\n**2. Rationale for Incorrect Options**\n\n- **a) â†“TLC:** Occurs later as fibrosis progresses; not earliest finding.\n- **c) â†“FEVâ‚:** Occurs with TLC reduction in restrictive disease; late finding.\n- **d) â†“FEVâ‚/FVC:** Maintained or increased (both reduced proportionally) in restrictive disease; not early marker.\n\n**3. Exam Essentials**\n\n- **IPF-PFT pattern:** Restrictive (TLC \u003c80%, FVC \u003c80%), FEVâ‚/FVC normal or increased, â†“DLCO (often marked).\n- **DLCO significance:** Progressive DLCO decline predicts worse prognosis; mortality correlates with DLCO reduction.\n- **Serial monitoring:** DLCO serial changes guide prognosis and treatment decisions.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":19,"question":"A 44-year-old woman with CTD-associated ILD shows basal fibrosis with subpleural sparing, uniform involvement, traction bronchiectasis, and no honeycombing. Most likely diagnosis?","options":{"a":"UIP","b":"Probable UIP","c":"NSIP","d":"IPF without honeycombing"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nIn connective tissue disease-associated ILD with basal fibrosis with subpleural sparing (reversed gradient), uniform involvement, traction bronchiectasis, and NO honeycombing, this pattern is nonspecific interstitial pneumonia (NSIP), not UIP. NSIP features: uniform inflammation, minimal honeycombing, better prognosis than UIP. UIP shows patchy distribution with subpleural/basilar predominance, honeycombing, and temporal heterogeneity. Subpleural sparing favors NSIP over UIP.\n\n**2. Rationale for Incorrect Options**\n\n- **a) UIP:** Patchy distribution, honeycombing present, temporal heterogeneity; not uniform involvement.\n- **b) Probable UIP:** Lacking typical UIP features mentioned; uniform pattern argues against.\n- **d) IPF without honeycombing:** IPF is UIP pattern; this patient has NSIP pattern (uniform, subpleural-sparing).\n\n**3. Exam Essentials**\n\n- **NSIP vs UIP:** NSIP uniform involvement, temporal homogeneity; UIP patchy, honeycombing, heterogeneous.\n- **CTD-ILD:** Usually NSIP pattern (80%); better prognosis, slower progression than UIP.\n- **Treatment response:** NSIP more steroid-responsive; immunosuppression beneficial.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"UIP vs NSIP Imaging\":**\n- **UIP:** Patchy, subpleural/basilar, honeycombing, traction bronchiectasis, temporal heterogeneity\n- **NSIP:** Uniform, subpleural sparing, minimal/no honeycombing, temporal homogeneity"},{"id":20,"question":"A COPD patient has persistent PaCOâ‚‚ 56 mmHg after recovery from an exacerbation. This indicates:","options":{"a":"No clinical significance","b":"Higher ICS response likelihood","c":"High mortality risk; evaluate for long-term NIV","d":"Need for LTOT only at night"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nIn a COPD patient with persistent PaCOâ‚‚ 56 mmHg after recovery from exacerbation, this indicates severe chronic hypercapnia and indicates HIGH MORTALITY RISK. Persistent hypercapnia post-exacerbation suggests severe parenchymal disease, respiratory muscle fatigue, or inadequate ventilation. This patient requires evaluation for long-term non-invasive ventilation (NIV) to improve outcomes and quality of life; mortality significantly higher with baseline hypercapnia.\n\n**2. Rationale for Incorrect Options**\n\n- **a) No clinical significance:** False; hypercapnia is marker of severe disease and poor prognosis.\n- **b) Higher ICS response:** Corticosteroid response unrelated to baseline COâ‚‚ levels.\n- **d) LTOT only at night:** Inadequate; patient needs evaluation for long-term NIV (CPAP or BiPAP), not just supplemental oxygen.\n\n**3. Exam Essentials**\n\n- **Hypercapnia significance:** PaCOâ‚‚ >50 mmHg baseline indicates severe obstructive disease; mortality 50% at 5 years.\n- **NIV indication:** Baseline pH \u003c7.35 or PaCOâ‚‚ >50-55 after acute event; improves survival and reduces hospitalizations.\n- **LTOT vs NIV:** LTOT alone insufficient if hypercapnic; NIV essential for COâ‚‚ clearance.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":21,"question":"Flow-volume loop shows flattened inspiratory and expiratory limbs. Most likely diagnosis?","options":{"a":"Vocal cord dysfunction","b":"Tracheomalacia","c":"Subglottic stenosis","d":"Asthma with poor effort"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nFlow-volume loop showing flattened inspiratory AND expiratory limbs indicates fixed airway obstruction (partial or complete obstruction of airway not varying with pressure). Subglottic stenosis causes fixed obstruction with characteristic symmetric flattening. Vocal cord dysfunction shows flattened inspiratory only; asthma/COPD shows flattened expiratory only; poor effort shows reduced volume without loop shape distortion.\n\n**2. Rationale for Incorrect Options**\n\n- **a) VCD:** Flattened inspiratory limb only (inspiration-limited); normal expiratory.\n- **b) Tracheomalacia:** Flattened expiratory limb; not inspiratory; variable obstruction.\n- **d) Poor effort:** Reduced volume but normal loop shape; not selective flattening pattern.\n\n**3. Exam Essentials**\n\n- **Flow-volume loop patterns:** Fixed obstruction (both limbs flat), variable upper (inspiratory flat), variable lower (expiratory flat).\n- **Fixed obstruction causes:** Stenosis (subglottic, tracheal), tumors, masses.\n- **Clinical correlation:** Stridor (fixed), wheezing (variable); dyspnea on exertion or at rest.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Flow-Volume Loop Patterns\":**\n- **Both flat:** Fixed obstruction (stenosis)\n- **Inspiratory flat:** Variable upper airway (VCD, laryngeal)\n- **Expiratory flat:** Asthma, COPD (lower airway)"},{"id":22,"question":"A farmer presents with dyspnea. HRCT shows upper-lobe fibrosis, mosaic attenuation, air trapping, reduced DLCO. Diagnosis?","options":{"a":"UIP","b":"NSIP","c":"Hypersensitivity pneumonitis (fibrotic)","d":"Sarcoidosis"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nA farmer with dyspnea, upper-lobe fibrosis, mosaic attenuation (air trapping), reduced DLCO on HRCT indicates hypersensitivity pneumonitis (HP), fibrotic form. HP is an immunologic lung disease from inhaled antigens (organic/inorganic dust exposure; farmers exposed to moldy hay, grain). Fibrotic HP shows upper-lobe predominance (unusual for IPF which is basilar); mosaic attenuation and air trapping are characteristic. Farmer history is key clue.\n\n**2. Rationale for Incorrect Options**\n\n- **a) UIP:** Usually basilar predominance; not upper-lobe; different distribution.\n- **b) NSIP:** Uniform distribution; not typical upper-lobe fibrosis pattern.\n- **d) Sarcoidosis:** Upper-lobe nodules; not usually diffuse fibrosis; different clinical context.\n\n**3. Exam Essentials**\n\n- **HP features:** Acute (diffuse infiltrates, fever after exposure), subacute, chronic (fibrosis, ULD).\n- **Occupational history:** Crucial; farmers, bird breeders, hot-tub exposure, metal workers.\n- **Diagnosis:** Clinical + exposure history + biopsy if needed; bronchoalveolar lavage (lymphocytosis).\n- **Treatment:** Antigen avoidance (curative if early); corticosteroids for progressive disease.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"HP Occupational Exposures\":**\n- **Farmer:** Moldy hay (Farmer's lung)\n- **Bird breeder:** Bird proteins (Pigeon breeder's lung)\n- **Hot-tub:** Mycobacteria\n- **Metal worker:** Metal dust (Hard metal disease)"},{"id":23,"question":"A patient with asthma has FeNO 12 ppb, normal eosinophils, poor bronchodilator response. Best next step?","options":{"a":"Add LABA","b":"Add LAMA","c":"Increase ICS dose","d":"Methacholine challenge"},"correctAnswer":"c","explanation":""},{"id":24,"question":"A 32-year-old man has restrictive PFT (FVC 60%, TLC 65%) but normal DLCO. Most likely diagnosis?","options":{"a":"IPF","b":"NSIP","c":"Chest wall disease","d":"Emphysema"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nA 32-year-old with restrictive PFT (FVC 60%, TLC 65%) but NORMAL DLCO indicates chest wall disease (neuromuscular, skeletal deformity, obesity). Normal DLCO excludes parenchymal ILD (IPF, NSIP both show â†“DLCO). Restrictive diseases with normal DLCO: chest wall disease, neuromuscular disorders. Parenchymal ILD always shows reduced DLCO due to alveolar inflammation/destruction.\n\n**2. Rationale for Incorrect Options**\n\n- **a) IPF:** â†“DLCO (marked); normal DLCO excludes parenchymal disease.\n- **b) NSIP:** â†“DLCO typical; normal DLCO argues against.\n- **d) Emphysema:** Obstructive (FEVâ‚/FVC \u003c0.7), not restrictive; â†“DLCO.\n\n**3. Exam Essentials**\n\n- **Restrictive with normal DLCO:** Chest wall (kyphoscoliosis, ankylosing spondylitis), neuromuscular (ALS, myasthenia).\n- **Restrictive with â†“DLCO:** Parenchymal ILD (IPF, NSIP, sarcoidosis, HP).\n- **Clinical correlation:** History (neuromuscular disease, deformity), physical exam, imaging guide diagnosis.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Restrictive Disease DLCO Pattern\":**\n- **Restrictive + â†“DLCO:** Parenchymal ILD\n- **Restrictive + Normal DLCO:** Chest wall/neuromuscular disease"},{"id":25,"question":"A smoker has normal FEV1/FVC but reduced FEF25â€“75% with CT showing small airway thickening. Interpretation?","options":{"a":"Normal","b":"Early small airway disease","c":"Asthma","d":"Poor effort"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn a smoker with normal FEVâ‚/FVC but reduced FEF25-75% (forced expiratory flow at 25-75% vital capacity) and small airway thickening on CT, this indicates early small airway disease. FEF25-75% reflects small airway flow rates and is more sensitive than FEVâ‚ for early obstruction before FEVâ‚/FVC becomes abnormal. Small airway remodeling precedes significant FEVâ‚ decline in emphysema/COPD development.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Normal:** Reduced FEF25-75% indicates small airway abnormality despite normal FEVâ‚/FVC.\n- **c) Asthma:** Could be present but CT showing small airway thickening (remodeling) suggests chronic pathology/smoking.\n- **d) Poor effort:** Poor effort reduces FVC more than FEF25-75%; FEVâ‚/FVC maintained; different pattern.\n\n**3. Exam Essentials**\n\n- **FEF25-75% significance:** Sensitive marker of small airway disease; reduced before FEVâ‚ changes.\n- **Small airway thickening:** Pathologic finding in early emphysema; smoking-related damage.\n- **Prognosis:** Early detection allows smoking cessation intervention to slow COPD progression.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":26,"question":"In IPF exacerbation, ABG shows PaOâ‚‚ 48 mmHg, PaCOâ‚‚ 28 mmHg. Most likely type of respiratory failure?","options":{"a":"Type 1","b":"Type 2","c":"Mixed","d":"Hyperventilation syndrome"},"correctAnswer":"a","explanation":"**1. High-Yield Topic Explanation**\n\nIn IPF exacerbation with PaOâ‚‚ 48 mmHg (hypoxemia) and PaCOâ‚‚ 28 mmHg (hypocapnia), this is Type I respiratory failure (primary hypoxemia with normal/low COâ‚‚). Normal/low PaCOâ‚‚ indicates adequate ventilation (patient hyperventilating to compensate for hypoxemia); problem is oxygenation failure (diffusion/shunt), not ventilation. Type II respiratory failure would show hypercapnia (PaCOâ‚‚ >50) indicating ventilation failure.\n\n**2. Rationale for Incorrect Options**\n\n- **b) Type II:** Hypercapnia (>50 mmHg); patient has normal/low COâ‚‚.\n- **c) Mixed:** Would show both hypoxemia AND hypercapnia; this patient hypocapnic.\n- **d) Hyperventilation syndrome:** Clinical syndrome; not applicable to critical IPF exacerbation.\n\n**3. Exam Essentials**\n\n- **Type I RF:** PaOâ‚‚ \u003c60 with PaCOâ‚‚ normal/low; causes: shunt, V/Q mismatch, diffusion defect.\n- **Type II RF:** PaCOâ‚‚ >50; causes: hypoventilation, respiratory muscle fatigue, airway obstruction.\n- **IPF exacerbation:** Acute respiratory failure; poor prognosis; mortality >50% despite ICU care.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Respiratory Failure Types\":**\n- **Type I:** Low Oâ‚‚, low/normal COâ‚‚ (oxygenation problem)\n- **Type II:** Low Oâ‚‚, high COâ‚‚ (ventilation problem)\n- **Type III:** Perioperative RF; intraoperative COâ‚‚ insufflation\n- **Type IV:** Shock-associated RF; hypoperfusion"},{"id":27,"question":"A 40-year-old lifelong asthmatic shows FEV1/FVC 55% and \u003c8% reversibility. DLCO elevated. What explains this?","options":{"a":"Asthma-COPD overlap","b":"Airway remodeling with fixed obstruction","c":"Emphysema","d":"Poor effort"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nA lifelong asthmatic with FEVâ‚/FVC 55% (persistent obstruction), \u003c8% reversibility (fixed obstruction), and ELEVATED DLCO indicates airway remodeling with fixed obstruction. Chronic inflammation in poorly controlled asthma causes permanent airway remodeling (smooth muscle hyperplasia, subepithelial fibrosis, mucus plugging); loses reversibility. Elevated DLCO excludes emphysema (which shows â†“DLCO). This represents \"burnt-out asthma\" with fixed obstruction.\n\n**2. Rationale for Incorrect Options**\n\n- **a) ACO:** Asthma-COPD overlap; would expect smoking history; elevated DLCO unusual if emphysema component present.\n- **c) Emphysema:** â†“DLCO (not elevated); patient's elevated DLCO argues against.\n- **d) Poor effort:** Would affect reproducibility; FEVâ‚/FVC and reversibility discordant; not overall pattern here.\n\n**3. Exam Essentials**\n\n- **Airway remodeling:** Smooth muscle thickening, subepithelial fibrosis, mucus metaplasia from chronic inflammation.\n- **Fixed obstruction development:** Years of uncontrolled inflammation; loss of reversibility hallmark.\n- **Prevention:** Tight asthma control, early ICS therapy, long-term anti-inflammatory therapy.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":28,"question":"Advanced COPD patient has PaOâ‚‚ 50 mmHg but PaCOâ‚‚ = 38 mmHg. Interpretation?","options":{"a":"Unusual COPD variant","b":"Respiratory muscle fatigue","c":"Dynamic hyperventilation","d":"Impending COâ‚‚ retention"},"correctAnswer":"d","explanation":"**1. High-Yield Topic Explanation**\n\nIn advanced COPD with PaOâ‚‚ 50 mmHg (hypoxemia) but PaCOâ‚‚ = 38 mmHg (normal), the interpretation is impending COâ‚‚ retention. Normal COâ‚‚ in setting of severe hypoxemia means patient is hyperventilating maximally to maintain COâ‚‚; this is respiratory muscle fatigue compensation on the verge of failure. Soon-to-come COâ‚‚ rise signals impending respiratory failure. This is different from stable COPD where baseline PaCOâ‚‚ may be elevated chronically.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Unusual variant:** Not unusual; represents transition to failure.\n- **b) Respiratory muscle fatigue:** Occurring now (explained by hyperventilation) but not the pointâ€”fatigue is starting.\n- **c) Dynamic hyperventilation:** Applies but implies acute state; patient is near respiratory collapse.\n\n**3. Exam Essentials**\n\n- **COPD COâ‚‚ retention:** Baseline hypercapnia in severe COPD; PaCOâ‚‚ >50 accepted in stable state.\n- **Acute decompensation:** Rising PaCOâ‚‚ with normal baseline signals respiratory failure; ICU admission critical.\n- **Management:** NIV (BiPAP), supplemental Oâ‚‚ cautiously, antibiotics, bronchodilators, steroids.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":29,"question":"Which finding favors NSIP over UIP?","options":{"a":"Markedly reduced DLCO with mild restriction","b":"Honeycombing","c":"Basal subpleural cysts","d":"Upper lobe nodules"},"correctAnswer":"a","explanation":"**1. High-Yield Topic Explanation**\n\nMarkedly reduced DLCO with mild restriction favors NSIP over UIP. NSIP typically shows mild-moderate restrictive pattern (TLC 60-80%) with variable DLCO reduction (often less severe than UIP). UIP shows more pronounced TLC reduction and typically more severe DLCO reduction with extent correlated to fibrosis. The mild restriction + marked DLCO reduction pattern is characteristic of NSIP reflecting \"early\" or less extensive fibrosis.\n\n**2. Rationale for Incorrect Options**\n\n- **b) Honeycombing:** UIP feature; absent in NSIP; favors UIP.\n- **c) Basal subpleural cysts:** Characteristic of UIP; not NSIP.\n- **d) Upper lobe nodules:** Sarcoidosis pattern; not NSIP vs UIP distinction.\n\n**3. Exam Essentials**\n\n- **NSIP PFT:** Mild-moderate restriction, variable DLCO, better prognosis than UIP.\n- **UIP PFT:** Often marked restriction, marked DLCO reduction, poor prognosis.\n- **Prognosis correlation:** NSIP 5-year survival ~80%; UIP ~50%.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":30,"question":"A severe ARDS patient has PaOâ‚‚/FiOâ‚‚ = 80 despite 100% oxygen; PaCOâ‚‚ normal. Primary mechanism?","options":{"a":"Hypoventilation","b":"V/Q mismatch","c":"Shunt","d":"Diffusion defect"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nIn severe ARDS with PaOâ‚‚/FiOâ‚‚ = 80 despite 100% oxygen (refractory hypoxemia), PaCOâ‚‚ normal, the primary mechanism is intrapulmonary shunt (blood bypassing ventilated alveoli). Shunt physiology is refractory to supplemental oxygen because blood never reaches ventilated alveoli. V/Q mismatch (other main ARDS mechanism) responds partially to Oâ‚‚. Normal PaCOâ‚‚ with severe hypoxemia (not hypercapnia) indicates shunt (ventilation adequate, oxygenation failed).\n\n**2. Rationale for Incorrect Options**\n\n- **a) Hypoventilation:** Would show hypercapnia; patient has normal COâ‚‚.\n- **b) V/Q mismatch:** Would improve with supplemental Oâ‚‚; this patient refractory despite 100%.\n- **d) Diffusion defect:** Rare cause of ARDS; shunt more common.\n\n**3. Exam Essentials**\n\n- **ARDS mechanisms:** Increased capillary permeability (edema), atelectasis (shunt), V/Q mismatch.\n- **Shunt physiology:** Blood flows past non-ventilated alveoli; Oâ‚‚ supplementation ineffective; 50:50 mix desaturated.\n- **Prone positioning:** Helps redistribute perfusion away from shunt areas; improves oxygenation.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Hypoxemia Mechanism by ABG Pattern\":**\n- **Low Oâ‚‚ + High COâ‚‚:** Hypoventilation, respiratory failure\n- **Low Oâ‚‚ + Normal/Low COâ‚‚:** Diffusion, V/Q, shunt (patient hyperventilating)\n- **Oâ‚‚ unresponsive:** Shunt (refractory) vs V/Q (partial response)"},{"id":31,"question":"A 57-year-old man develops chest pain while walking uphill. Pain is relieved by rest. ECG is normal. Most likely diagnosis?","options":{"a":"Unstable angina","b":"Stable angina","c":"Prinzmetal angina","d":"NSTEMI"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nStable angina presents with predictable chest pain on exertion (walking uphill), reliably relieved by rest, normal ECG. Reproducible pattern with consistent triggers and relief within 5 minutes of rest are classic. NSTEMI would show troponin elevation; unstable angina would occur at rest or with minimal exertion; Prinzmetal is at rest. The normal ECG and exertional nature without troponin elevation confirm stable anginaâ€”requires medical therapy but no acute intervention.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Unstable angina:** Occurs at rest, new onset, or with minimal exertion; crescendo pattern.\n- **c) Prinzmetal:** Vasospastic angina at rest, typically early morning; ECG may show ST elevation during episodes.\n- **d) NSTEMI:** Troponin elevated; sustained symptoms; acute coronary syndrome.\n\n**3. Exam Essentials**\n\n- **Stable angina:** Exertional, relieved by rest/nitrates, reproducible, anginal equivalent (dyspnea, fatigue, diaphoresis).\n- **CCS classification:** I (symptoms with strenuous exertion), II-IV (increasingly with minimal exertion/at rest).\n- **Diagnosis:** Clinical history + ECG/stress test/imaging; troponin normal.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Anginal Chest Pain Types\":**\n- **Stable:** Exertional, reproducible, relieved by rest\n- **Unstable:** At rest, new, crescendo pattern\n- **Prinzmetal:** Vasospastic, at rest, usually early AM\n- **Atypical:** No clear pattern; unclear relationship to exertion/rest"},{"id":32,"question":"A patient with acute chest pain has ST elevation in V2â€“V4. The artery most likely involved is:","options":{"a":"Left circumflex","b":"Right coronary artery","c":"Left anterior descending","d":"Posterior descending artery"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nST elevation in V2-V4 on ECG indicates left anterior descending (LAD) coronary artery territory infarction. V2-V3 = septal (LAD branch); V4 = anterior (LAD) wall. LAD supplies anterior wall, anterior septum, and apex in most patients. Acute STEMI in LAD territory results in anterior MI with highest mortality risk due to large myocardium supplied; mechanical complications (VSR, papillary muscle rupture) possible.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Left circumflex:** Supplies lateral wall (V5-V6 ST elevation), inferior wall (variant anatomy).\n- **b) Right coronary:** Supplies inferior wall (II, III, aVF ST elevation), RV (if proximal RCA).\n- **d) Posterior descending:** Branch of RCA; supplies inferior/posterior walls.\n\n**3. Exam Essentials**\n\n- **LAD MI:** Anterior ST elevation (V1-V4), may extend to V5-V6 (anterolateral); high mortality.\n- **Complications:** LV dysfunction, cardiogenic shock, VSD, papillary muscle rupture, arrhythmias.\n- **Treatment:** Urgent reperfusion (PCI or thrombolysis), antiplatelet therapy, beta-blockers, ACE-I.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Coronary Territory ECG Localization\":**\n- **LAD:** V1-V4 (anterior/septal); I, aVL (lateral)\n- **RCA:** II, III, aVF (inferior); V1-V4R (RV if proximal)\n- **LCx:** V5-V6, I, aVL (lateral); II, III, aVF (if dominant/inferior)"},{"id":33,"question":"A 60-year-old smoker has chest pain at rest. ECG shows ST depression. Troponin is negative. Diagnosis?","options":{"a":"NSTEMI","b":"Unstable angina","c":"Prinzmetal angina","d":"Stable angina"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nUnstable angina presents with chest pain at rest (not exertional), ST depression on ECG, and negative troponin. The key feature is ischemic chest pain without myocardial necrosis (troponin negative). ST depression indicates ischemia; negative troponin excludes myocardial necrosis, distinguishing from NSTEMI. Unstable angina is acute coronary syndrome (ACS) but without infarction; requires hospitalization, antiplatelet therapy, anticoagulation.\n\n**2. Rationale for Incorrect Options**\n\n- **a) NSTEMI:** Troponin would be elevated; this patient's is negative.\n- **c) Prinzmetal:** Vasospastic; ST elevation (not depression) during pain; less common.\n- **d) Stable angina:** Reproducibly exertional; patient has rest pain (unstable presentation).\n\n**3. Exam Essentials**\n\n- **Unstable angina:** ACS presentation; troponin-negative; ST changes/T inversion; high mortality if untreated.\n- **Risk stratification:** HEART score, TIMI score; assess short-term MI risk.\n- **Treatment:** Dual antiplatelet (aspirin + P2Y12), anticoagulation (heparin, fondaparinux), beta-blockers, cardiac imaging.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"ACS Troponin/ECG Pattern\":**\n- **NSTEMI:** â†‘ Troponin + ST depression/T inversion\n- **Unstable angina:** Normal troponin + ST depression/T inversion\n- **STEMI:** â†‘ Troponin + ST elevation\n- **Chest pain, no ACS:** Normal troponin + normal ECG"},{"id":34,"question":"A patient with suspected ischemia undergoes treadmill test. Test is positive if:","options":{"a":"ST elevation â‰¥0.5 mm","b":"ST depression â‰¥1 mm horizontal/downsloping","c":"Increase in heart rate by 20%","d":"BP rises slightly"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nST depression â‰¥1 mm horizontal or downsloping on treadmill stress test indicates positive test for ischemia. This ST response suggests coronary artery disease with inducible ischemia. ST elevation â‰¥0.5 mm (question option) is not standard criterion (more typical for current injury); increase in heart rate by 20% is chronotropic incompetence indicator but not ischemia; slight BP rise is expected normal response. Only ST depression â‰¥1 mm (horizontal/downsloping) is diagnostic positive finding.\n\n**2. Rationale for Incorrect Options**\n\n- **a) ST elevation â‰¥0.5 mm:** Not standard criterion; >1 mm required for positivity.\n- **c) HR increase by 20%:** Chronotropic incompetence marker; not ischemic response.\n- **d) BP rise slightly:** Normal response; expected with exercise; not pathologic.\n\n**3. Exam Essentials**\n\n- **Stress test interpretation:** ST depression â‰¥1 mm (horizontal/downsloping preferred over upsloping); time to appearance, duration, recovery.\n- **Other markers:** Symptoms (chest pain, dyspnea), arrhythmias, BP response, exercise capacity.\n- **Limitations:** 30-40% false negative rate; 10% false positive rate; lower sensitivity in women.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":35,"question":"A patient with chronic stable angina uses sublingual nitroglycerin. Main mechanism of symptom relief is:","options":{"a":"Coronary vasodilation","b":"Increased preload","c":"Decreased preload","d":"Increased contractility"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nNitroglycerin's mechanism of symptom relief in angina is primarily decreased preload (venous vasodilation > arterial), reducing left ventricular end-diastolic pressure (LVEDP) and ventricular wall tension. Reduced wall tension lowers myocardial oxygen demand, providing rapid relief of anginal symptoms. Coronary vasodilation occurs but is secondary effect (especially epicardial vessels); direct coronary vasodilation explains some benefit but preload reduction is main mechanism.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Coronary vasodilation:** Important but secondary mechanism; preload reduction primary.\n- **b) Increased preload:** Opposite; nitrates decrease preload.\n- **d) Increased contractility:** Reflex increased by sympathetic activation; primary effect is decreased contractility from lower preload.\n\n**3. Exam Essentials**\n\n- **Nitrate hemodynamics:** â†“ Preload (venous pooling), â†“ LVEDP, â†“ wall tension, â†“ MVOâ‚‚.\n- **Nitrate types:** Sublingual (onset 1-5 min), long-acting (isosorbide dinitrate), transdermal.\n- **Nitrate tolerance:** Develops with continuous exposure; overcome by nitrate-free interval (10-12 hours/day).\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Nitrate Effects\":**\n- Venous vasodilation (preload â†“)\n- Energetics improved (MVOâ‚‚ â†“)\n- No direct cardiac inotropic effect (reflex increase only)\n- Oxygen demand reduced\n- Usefulness in angina relief"},{"id":36,"question":"A 65-year-old man develops hypotension and clear lungs after an inferior wall MI. JVP is elevated. Most likely diagnosis?","options":{"a":"LV failure","b":"RV infarction","c":"Papillary muscle rupture","d":"Pulmonary embolism"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nHypotension with clear lungs (no pulmonary edema) and elevated JVP after inferior MI indicates RV infarction. RV infarction typically accompanies inferior MI (30-50% of inferior MIs); loss of RV contractility â†’ impaired RV output â†’ low left ventricular preload â†’ hypotension. Clear lungs distinguish from LV failure (which would show pulmonary edema). Elevated JVP reflects RV diastolic dysfunction (impaired filling, elevated RV pressure).\n\n**2. Rationale for Incorrect Options**\n\n- **a) LV failure:** Would show pulmonary edema/rales; lungs clear here.\n- **c) Papillary muscle rupture:** Acute severe MR; pulmonary edema from backward flow.\n- **d) Pulmonary embolism:** Would show hypoxia, elevated JVP but different clinical context.\n\n**3. Exam Essentials**\n\n- **RV MI findings:** Inferior STEMI with right-sided lead (V4R) ST elevation, elevated JVP, clear lungs, hypotension.\n- **Management:** Careful fluid administration (unlike LV infarction); avoid nitrates/diuretics (preload-dependent); inotropic support if severe.\n- **Complications:** Cardiogenic shock (15-20%), bradyarrhythmias (AV block), mechanical complications.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":37,"question":"A 55-year-old diabetic male presents with chest pain. Troponin is detectable but mildly elevated and rising. ECG shows ST depression in V5â€“V6. Diagnosis?","options":{"a":"NSTEMI","b":"Unstable angina","c":"STEMI","d":"Prinzmetal angina"},"correctAnswer":"a","explanation":"**1. High-Yield Topic Explanation**\n\nNSTEMI (non-ST elevation MI) presents with detectable, rising troponin (myocardial necrosis), ST depression on ECG (ischemia), and chest pain at rest. The combination of positive troponin + ST changes confirms acute coronary syndrome with myocardial infarction (NSTEMI) despite absence of ST elevation. Rising troponin (serial measurement) is more diagnostic than single value.\n\n**2. Rationale for Incorrect Options**\n\n- **b) Unstable angina:** Troponin negative; this patient has detectable troponin.\n- **c) STEMI:** ST elevation not mentioned; ST depression present.\n- **d) Prinzmetal:** Vasospastic; usually at rest but ECG shows ST elevation during chest pain (not depression).\n\n**3. Exam Essentials**\n\n- **NSTEMI diagnosis:** Troponin elevation + ischemic ECG changes (ST depression, T inversion) + clinical ACS symptoms.\n- **Risk stratification:** TIMI score, HEART score; guide intensity of treatment.\n- **Management:** Dual antiplatelet therapy, anticoagulation, beta-blockers, statins, ACE-I; coronary angiography; revascularization.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"MI Types by ECG/Troponin\":**\n- **STEMI:** ST elevation + â†‘ troponin (complete occlusion)\n- **NSTEMI:** ST depression/T inversion + â†‘ troponin (subtotal occlusion)\n- **Unstable angina:** ST changes + normal troponin (ischemia without infarction)"},{"id":38,"question":"A patient with IHD is started on atorvastatin 40 mg. The main goal is:","options":{"a":"Reduce triglycerides","b":"Reduce LDL cholesterol","c":"Increase HDL cholesterol","d":"Improve cardiac contractility"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nAtorvastatin (statin) main goal in IHD is LDL cholesterol reduction. Statins inhibit HMG-CoA reductase, blocking cholesterol synthesis; primary benefit is LDL reduction by 30-50%. Secondary benefits include triglyceride reduction (modest), HDL increase (modest). LDL target in established IHD is \u003c70 mg/dL (high-risk patients); aggressive LDL lowering reduces cardiovascular events and mortality.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Triglyceride reduction:** Secondary benefit; less significant than LDL lowering.\n- **c) HDL increase:** Modest benefit; not primary mechanism.\n- **d) Cardiac contractility:** Neutral to slightly negative effect; statin benefit is LDL reduction.\n\n**3. Exam Essentials**\n\n- **Statin intensity:** High (atorvastatin â‰¥40, rosuvastatin â‰¥20), moderate, low based on risk.\n- **Target LDL:** Primary prevention \u003c100, secondary prevention \u003c70, STEMI \u003c55 per recent guidelines.\n- **Side effects:** Muscle symptoms (myopathy rare), elevated transaminases, new-onset diabetes (mild risk increase).\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":39,"question":"A 70-year-old man develops chest pain radiating to the left arm. ECG is normal. First troponin negative. Next best step?","options":{"a":"Discharge","b":"Repeat troponin at 3 hours","c":"Give thrombolysis","d":"Immediate angiography"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn chest pain with normal first troponin (negative) and normal ECG, the next best step is repeat troponin at 3 hours. Serial troponin measurements (0 and 3 hours, or 0-3-6 hours depending on assay) are required to exclude MI before discharge, as troponin rises during myocardial necrosis timeline. High-sensitivity troponin assays allow earlier rule-out (0-3 hours). Single negative troponin insufficient to exclude ACS.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Discharge:** Inappropriate without serial troponin; would miss MI in first 3 hours.\n- **c) Thrombolysis:** No indication without confirmed STEMI; premature and risky.\n- **d) Immediate angiography:** Not indicated with negative ECG/normal troponin; reserved for confirmed ACS.\n\n**3. Exam Essentials**\n\n- **Troponin kinetics:** Rises 2-4 hours post-MI, peaks 24-48 hours, normalizes 7-14 days.\n- **High-sensitivity troponin:** Allows earlier detection; may enable 0-3 hour rule-out protocols.\n- **ACS rule-out:** Serial troponin + serial ECG + clinical assessment; combination approach.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Chest Pain Evaluation\":**\n- **Troponin negative + ECG normal + serial troponin rule-out:** Low risk, likely non-ACS\n- **Troponin positive or ECG changes:** High risk, ACS likely\n- **Equivocal:** Observe, serial testing, stress testing"},{"id":40,"question":"A 62-year-old woman with angina has 80% stenosis of proximal LAD. Preferred management?","options":{"a":"Medical therapy only","b":"PCI with stent","c":"CABG is mandatory","d":"Thrombolysis"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn stable angina with proximal LAD 80% stenosis, preferred management is PCI with stent. Proximal LAD disease supplies large myocardial territory; revascularization indicated for 70%+ stenosis causing symptoms or ischemia. PCI preferred over medical therapy for significant stenosis; CABG reserved for left main stenosis, multivessel disease, or PCI failure. 80% LAD stenosis meets indication for intervention in presence of symptoms (angina).\n\n**2. Rationale for Incorrect Options**\n\n- **a) Medical therapy only:** Insufficient for significant proximal LAD stenosis; revascularization indicated.\n- **c) CABG mandatory:** Not mandatory for single LAD lesion; PCI is preferred less-invasive option.\n- **d) Thrombolysis:** For acute STEMI; not for chronic stable angina.\n\n**3. Exam Essentials**\n\n- **Revascularization indication:** LM stenosis >50%, 3-vessel disease, proximal LAD with ischemia, EF \u003c35%.\n- **PCI vs CABG:** PCI for single vessel, CABG for complex anatomy/LM/multivessel with certain conditions.\n- **Stent type:** DES (drug-eluting) preferred; reduces restenosis compared to bare-metal stents.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Revascularization Strategy\":**\n- **PCI:** Single/2-vessel disease, proximal LAD, accessible lesions\n- **CABG:** LM stenosis, 3-vessel disease, prior PCI failure, poor PCI anatomy"},{"id":41,"question":"A 35-year-old man presents with sharp chest pain that improves on leaning forward. ECG shows diffuse ST elevation with PR depression. Most likely diagnosis?","options":{"a":"STEMI","b":"Early repolarization","c":"Acute pericarditis","d":"Takotsubo cardiomyopathy"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nAcute pericarditis presents with sharp chest pain improving with leaning forward (pericardial friction decreases with forward lean), diffuse ST elevation with PR depression on ECG, and recent viral illness context. The combination of positional chest pain, diffuse ST elevation (unlike STEMI which is regional), and PR depression is pathognomonic for acute pericarditis. Pericardial friction rub on auscultation confirms inflammation.\n\n**2. Rationale for Incorrect Options**\n\n- **a) STEMI:** Localized ST elevation (not diffuse); pain not positional; troponin elevated (pericarditis usually normal).\n- **b) Early repolarization:** Benign; PR segment normal; no friction rub or clinical symptoms.\n- **d) Takotsubo:** Apical ballooning on echo; regional wall motion abnormality; different presentation.\n\n**3. Exam Essentials**\n\n- **Pericarditis features:** Pleuritic chest pain (worse supine, better upright/leaning forward), pericardial friction rub, diffuse ST elevation + PR depression.\n- **Etiology:** Viral (most common), post-MI (Dressler), uremia, malignancy, autoimmune.\n- **Complications:** Pericardial effusion, tamponade, constrictive pericarditis (chronic).\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Acute Pericarditis Triad\":**\n- Pain (pleuritic, positional)\n- ECG (diffuse ST elevation + PR depression)\n- Rub (pericardial friction rub)"},{"id":42,"question":"A patient with acute pericarditis is being treated with NSAIDs. Which additional drug reduces recurrence risk?","options":{"a":"IV steroids","b":"Colchicine","c":"Beta-blockers","d":"Nitrates"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn acute pericarditis treatment with NSAIDs, colchicine added to NSAIDs reduces recurrence risk from 30% to \u003c10%. Colchicine inhibits inflammasome activation, reducing pericardial inflammation. Low-dose colchicine (0.5 mg daily or BID for 3 months) combined with NSAID and aspirin is standard approach. IV steroids used if contraindications to NSAIDs but less ideal; prolonged corticosteroids increase recurrence risk.\n\n**2. Rationale for Incorrect Options**\n\n- **a) IV steroids:** Indicated if NSAID contraindicated; but do NOT reduce recurrence better than NSAIDs + colchicine.\n- **c) Beta-blockers:** No role in pericarditis prevention; cardiac control not related to inflammation.\n- **d) Nitrates:** No role in pericarditis management; used for angina.\n\n**3. Exam Essentials**\n\n- **Acute pericarditis treatment:** NSAIDs (indomethacin, ibuprofen) for 2-4 weeks; colchicine for 3 months.\n- **Colchicine mechanism:** Inhibits inflammasome, reduces interleukin-1 production and pericardial inflammation.\n- **Recurrent pericarditis:** Colchicine monotherapy for recurrences; low-dose azathioprine or mycophenolate for refractory cases.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":43,"question":"A 60-year-old man presents with hypotension, muffled heart sounds, and elevated JVP. Pulsus paradoxus is present. Best initial investigation?","options":{"a":"Troponin","b":"Echocardiography","c":"Chest X-ray","d":"Coronary angiography"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn tamponade (hypotension, muffled heart sounds, elevated JVP, pulsus paradoxus), echocardiography is the best initial investigation to confirm pericardial effusion and assess hemodynamic significance (RV/RA collapse during diastole indicates tamponade physiology). Echocardiography is non-invasive, rapid, can guide pericardiocentesis. Troponin not diagnostic; CXR limited sensitivity; angiography risks acute decompensation.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Troponin:** Elevated if myocarditis present; not diagnostic for tamponade.\n- **c) CXR:** Shows large effusion as \"water-bottle heart\" but limited hemodynamic assessment.\n- **d) Angiography:** Risky in tamponade; can precipitate cardiovascular collapse; only if tamponade from ACS.\n\n**3. Exam Essentials**\n\n- **Beck's triad:** Hypotension, elevated JVP, muffled heart sounds; pulsus paradoxus often present.\n- **Echo findings:** Pericardial effusion, RV/RA diastolic collapse (confirms tamponade physiology), dilated IVC.\n- **Treatment:** Pericardiocentesis emergent; fluid drainage provides immediate relief.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Tamponade (Beck's Triad)\":**\n- Hypotension\n- Elevated JVP\n- Muffled heart sounds\n- **Plus:** Pulsus paradoxus (ominous sign)"},{"id":44,"question":"A patient with suspected tamponade shows equalization of diastolic pressures in RA, RV, and LV on catheterization. Diagnosis?","options":{"a":"Constrictive pericarditis","b":"Restrictive cardiomyopathy","c":"Pericardial effusion","d":"Cardiac tamponade"},"correctAnswer":"d","explanation":"**1. High-Yield Topic Explanation**\n\nCardiac tamponade shows equalization of diastolic pressures in right atrium, right ventricle, and left ventricle on right heart catheterization. This \"square root sign\" (diastolic pressure plateau) results from elevated intrapericardial pressure compressing all cardiac chambers equally, limiting diastolic filling. Equalization of pressures is hemodynamic hallmark distinguishing tamponade from constrictive pericarditis (which also shows diastolic plateau but different pressure waveforms).\n\n**2. Rationale for Incorrect Options**\n\n- **a) Constrictive pericarditis:** Also shows diastolic plateau but PAP typically higher; different clinical features.\n- **b) Restrictive cardiomyopathy:** Elevated ventricular diastolic pressures but no pericardial constraint.\n- **c) Pericardial effusion alone:** Without hemodynamic compromise; pressures not equalized.\n\n**3. Exam Essentials**\n\n- **Tamponade hemodynamics:** â†‘ RA pressure, â†‘ pericardial pressure, equalization of diastolic pressures.\n- **Pulsus paradoxus:** >10 mmHg drop in SBP with inspiration (exaggerated normal response).\n- **Diagnosis confirmation:** Echocardiography (effusion + RA/RV collapse) is gold-standard; catheterization for equivocal cases.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Tamponade Catheterization Findings\":**\n- **Equalization** of diastolic pressures (RA = RV = LV diastolic)\n- **\"Square root sign\"** (diastolic plateau)\n- **â†‘ RA pressure** (elevated)\n- **â†‘ Pericardial pressure** (elevated)"},{"id":45,"question":"A patient with chronic dyspnea has JVP with prominent y descent, pericardial knock, and square root sign on catheterization. Diagnosis?","options":{"a":"Restrictive cardiomyopathy","b":"Constrictive pericarditis","c":"RV infarction","d":"Tamponade"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nConstrictive pericarditis presents with chronic dyspnea, prominent y descent on JVP (rapid atrial emptying), pericardial knock (early diastolic sound from ventricular contact with pericardium), and \"square root sign\" on catheterization (diastolic pressure plateau from rigid pericardium limiting ventricular filling). This \"square root sign\" reflects sudden cessation of ventricular filling when pericardial constraint reached. Differs from restrictive cardiomyopathy by pericardial involvement (constriction) vs myocardial stiffness.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Restrictive cardiomyopathy:** Square root sign present but from myocardial stiffness; no pericardial involvement; different imaging.\n- **c) RV infarction:** Acute presentation; elevated RV pressure; different history/enzymes.\n- **d) Tamponade:** Acute presentation; equalization of pressures; pericardial effusion present.\n\n**3. Exam Essentials**\n\n- **Constrictive features:** Elevated and equalized diastolic pressures, prominent y descent, diastolic plateau, pericardial thickening on imaging.\n- **Causes:** Post-cardiac surgery, viral pericarditis, TB (developing countries), radiation, malignancy.\n- **Treatment:** Pericardiectomy (definitive); diuretics/digoxin for symptom relief while awaiting surgery.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Constrictive Pericarditis Signs\":**\n- **Elevated JVP** with prominent y descent\n- **Pericardial knock** (early diastolic sound)\n- **\"Square root sign\"** on catheterization\n- **Pericardial thickening** on imaging (CT/MRI)"},{"id":46,"question":"A patient with pericardial effusion has pulsus paradoxus. Mechanism?","options":{"a":"LV systolic failure","b":"Decreased RV filling during inspiration","c":"Increased afterload","d":"Pulmonary hypertension"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn pulsus paradoxus, the mechanism is decreased RV filling during inspiration from increased venous return to RV + reduced right atrial pressure from ventricular septal bowing leftward (when intrapericardial pressure is elevated). Increased RV volume during inspiration shifts interventricular septum leftward, compressing LV and reducing LV filling + stroke volume, resulting in SBP drop >10 mmHg with inspiration (exaggerated normal physiology).\n\n**2. Rationale for Incorrect Options**\n\n- **a) LV systolic failure:** Would show low cardiac output but not specific inspiration relationship; not mechanism.\n- **c) Increased afterload:** Afterload not primarily affected by inspiration in pulsus paradoxus.\n- **d) Pulmonary hypertension:** Can accompany but not mechanism of pulsus paradoxus generation.\n\n**3. Exam Essentials**\n\n- **Pulsus paradoxus:** >10 mmHg drop in SBP from inspiration (normal \u003c10); palpable pulse decrease with breath.\n- **Causes:** Tamponade, constrictive pericarditis, restrictive cardiomyopathy, severe asthma/COPD exacerbation, hypovolemia.\n- **Detection:** Manual blood pressure cuff; inflate above SBP, slowly deflate, note when Korotkoff sounds first heard (inspiration) vs all phases (expiration).\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Pulsus Paradoxus Mechanism\":**\n- **Inspiration:** â†‘ venous return to RV\n- **Increased RV volume:** Leftward septum shift\n- **Compressed LV:** â†“ LV filling/output\n- **Result:** â†“ SBP with inspiration (>10 mmHg drop = paradoxus)"},{"id":47,"question":"Chest X-ray shows â€œwater bottleâ€“shaped heart.â€ Which condition most likely?","options":{"a":"Acute MI","b":"Large pericardial effusion","c":"Constrictive pericarditis","d":"Restrictive cardiomyopathy"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nChest X-ray showing \"water bottle\" (globular) heart shape indicates large pericardial effusion. The enlarged cardiac silhouette appears smooth, globular, apex blunted on frontal radiograph. This classic appearance results from large fluid surrounding heart, obscuring normal cardiac contours. Echocardiography confirms effusion and assesses hemodynamic significance (tamponade physiology).\n\n**2. Rationale for Incorrect Options**\n\n- **a) Acute MI:** Cardiac silhouette usually normal or slightly enlarged; not water-bottle appearance.\n- **c) Constrictive pericarditis:** Thickened pericardium without large effusion; normal or small heart size.\n- **d) Restrictive cardiomyopathy:** Enlarged heart from myocardial disease; not water-bottle appearance.\n\n**3. Exam Essentials**\n\n- **Large effusion findings:** Globular heart, blunted apex, muffled heart sounds, may have pulsus paradoxus.\n- **Hemodynamic significance:** Assessed by echocardiography (RA/RV collapse indicates tamponade).\n- **Causes:** Malignancy, infection, renal failure, autoimmune, idiopathic.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":48,"question":"A patient with acute pericarditis after a recent MI presents with fever and pericardial friction rub. Diagnosis?","options":{"a":"Acute MI extension","b":"Dressler syndrome","c":"RV infarction","d":"Pulmonary embolism"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nDressler syndrome (post-MI pericarditis) occurs weeks after MI (typically 2-12 weeks) with fever, pericardial friction rub, and pericardial/pleural inflammation. This is an autoimmune reaction to myocardial antigens released during infarction, causing pericarditis independent of infarction extent. Different from acute pericarditis with fever that precedes/accompanies MI itself. NSAIDs/colchicine treatment effective; recurrence possible.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Acute MI extension:** Acute phase; presents with chest pain, enzyme elevation; not delayed pericarditis.\n- **c) RV infarction:** Acute; would present in hospital phase; not delayed autoimmune reaction.\n- **d) PE:** Different presentation; pleurisy less prominent; troponin pattern different.\n\n**3. Exam Essentials**\n\n- **Dressler features:** Delayed pericarditis (weeks post-MI), fever, elevated inflammatory markers (ESR, CRP), pericardial friction rub.\n- **Diagnosis:** Clinical; exclude other causes (post-infarction angina, recurrent MI, pericardial effusion/tamponade).\n- **Treatment:** NSAIDs, colchicine, corticosteroids if severe; prognosis generally good with treatment.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":49,"question":"Which ECG finding is typical of early acute pericarditis?","options":{"a":"Localized ST elevation","b":"ST elevation with reciprocal ST depression","c":"PR depression","d":"Deep Q waves"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nTypical ECG in early acute pericarditis shows PR depression (atrial epicardial injury current), reflecting pericardial inflammation involving atria. This is the earliest ECG change; followed by diffuse ST elevation (ventricular epicardial involvement). PR depression is relatively specific for pericarditis (unlike ST elevation which occurs in STEMI with regional distribution). Reciprocal ST depression in aVR/V1 may occur but less prominent than ST elevation.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Localized ST elevation:** Regional distribution seen in STEMI; pericarditis shows diffuse ST elevation.\n- **b) ST elevation with reciprocal:** Both present in STEMI; pericarditis shows diffuse ST elevation without reciprocal changes.\n- **d) Deep Q waves:** Occur in chronic infarction; not early pericarditis.\n\n**3. Exam Essentials**\n\n- **Pericarditis ECG evolution:** PR depression (stage 1) â†’ diffuse ST elevation (stage 2) â†’ T inversion (stage 3) â†’ normalization (stage 4).\n- **PR depression:** Atrial epicardial involvement; relatively specific for pericarditis.\n- **Diffuse ST elevation:** Global epicardial injury (unlike STEMI which is territorial).\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Pericarditis ECG Stages\":**\n- **Stage 1:** PR depression (earliest, specific for pericarditis)\n- **Stage 2:** Diffuse ST elevation (global, not territorial)\n- **Stage 3:** T wave inversion (diffuse)\n- **Stage 4:** Normalization (may take weeks)"},{"id":50,"question":"A 62-year-old woman has dyspnea, right heart failure, and a holosystolic murmur louder with inspiration. Diagnosis?","options":{"a":"MR","b":"TR","c":"AR","d":"AS"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn a dyspneic patient with right heart failure signs and holosystolic murmur louder with inspiration (Carvallo sign), the diagnosis is tricuspid regurgitation (TR). The inspiratory augmentation of the holosystolic (pansystolic) murmur is key finding, reflecting increased venous return to right heart during inspiration â†’ increased TR flow. TR usually secondary to RV dilatation (pulmonary hypertension, RV infarction) or primary valve disease (less common).\n\n**2. Rationale for Incorrect Options**\n\n- **a) Mitral regurgitation:** Apical holosystolic murmur; does NOT increase with inspiration; left-sided lesion.\n- **c) Aortic regurgitation:** Early diastolic murmur; not systolic; different location/character.\n- **d) Aortic stenosis:** Systolic ejection murmur (not holosystolic); louder with expiration; no inspiratory augmentation.\n\n**3. Exam Essentials**\n\n- **TR findings:** Holosystolic murmur at left lower sternal border, louder with inspiration, elevated JVP, hepatomegaly, pulsatile hepatic vein.\n- **Secondary TR:** From RV dilatation (PHT, RV infarction, COPD); usually improves with underlying disease treatment.\n- **Primary TR:** Endocarditis, rheumatic, carcinoid, trauma; may require valve replacement.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Right vs Left-Sided Valve Lesions\":**\n- **Right-sided:** Louder with inspiration (â†‘ venous return to RV)\n- **Left-sided:** Louder with expiration or unchanged with respiration\n- **TR holosystolic:** Increases with inspiration (Carvallo sign)\n- **MR holosystolic:** Does NOT change with respiration"},{"id":51,"question":"A patient with aortic regurgitation has a wide pulse pressure, bounding pulses, and early diastolic decrescendo murmur at left sternal border. Which maneuver increases murmur intensity?","options":{"a":"Valsalva","b":"Handgrip","c":"Standing","d":"Inspiration"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn aortic regurgitation (AR) with wide pulse pressure, bounding pulses, and early diastolic murmur, the murmur increases with handgrip (increases systemic vascular resistance/afterload, increases diastolic blood pressure, increases AR jet velocity and audibility). Valsalva (decreases preload) decreases AR murmur; standing (decreases preload) decreases murmur; inspiration generally does not affect AR significantly (left-sided lesion). Handgrip strengthens AR murmur by increasing regurgitant flow.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Valsalva:** Decreases venous return/preload; decreases AR murmur.\n- **c) Standing:** Decreases venous return/preload; decreases AR murmur.\n- **d) Inspiration:** Right-sided effect; AR is left-sided; minimal change.\n\n**3. Exam Essentials**\n\n- **AR presentation:** Wide pulse pressure (high SBP, low DBP), bounding pulses (water-hammer), early diastolic decrescendo murmur.\n- **AR physical signs:** Corrigan pulse (rapid upstroke, collapse), Hill sign (BP lower arm >upper by 20 mmHg), Traube sign (double pulse in arteries).\n- **Acute vs chronic:** Acute AR may present with normal BP from acute LV failure; chronic AR shows classic wide pulse pressure.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Murmur Changes with Maneuvers\":**\n- **Handgrip:** â†‘ Afterload â†’ â†‘ AR murmur, â†‘ MR murmur\n- **Valsalva/Stand:** â†“ Preload â†’ â†“ systolic murmurs (AS, MR), â†‘ MVP click\n- **Squatting:** â†‘ Preload â†’ opposite effects of Valsalva"},{"id":52,"question":"A 32-year-old woman presents with progressive dyspnea and palpitations. She has diastolic murmur with opening snap at the apex. The interval between S2 and opening snap is short. Severity of disease?","options":{"a":"Mild mitral stenosis","b":"Moderate mitral stenosis","c":"Severe mitral stenosis","d":"MR with flow murmur"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nIn mitral stenosis (MS) with diastolic murmur, loud S1, tapping apex beat, and SHORT interval between S2 and opening snap, this indicates severe MS. The opening snap occurs earlier in severe MS (shorter S2-OS interval) because elevated left atrial pressure causes earlier opening of stenotic valve. Shorter interval = higher LA pressure = more severe stenosis. The loud S1 reflects forceful valve closure before stenosis prevents opening; the \"tapping apex\" is the palpable S1.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Mild MS:** Long S2-OS interval (low LA pressure); more gradual opening.\n- **b) Moderate MS:** Intermediate interval timing.\n- **d) MR with flow murmur:** Murmur would be holosystolic (not classic diastolic rumble); different clinical context.\n\n**3. Exam Essentials**\n\n- **MS severity:** A2-OS interval inversely correlates with severity (shorter = more severe).\n- **MS features:** Low-pitched diastolic rumble (best heard with bell), loud S1, OS, opening snap, AFib common.\n- **Symptoms:** Dyspnea, orthopnea, AFib complications (stroke, rate control), pulmonary hypertension.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"Mitral Stenosis Severity by S2-OS Interval\":**\n- **Long interval (>120 ms):** Mild/moderate MS (low LA pressure)\n- **Short interval (\u003c80 ms):** Severe MS (high LA pressure, earlier snap)"},{"id":53,"question":"A 28-year-old woman has systolic click with late systolic murmur at the apex that becomes louder and earlier with standing. Diagnosis?","options":{"a":"Mitral stenosis","b":"Mitral regurgitation","c":"Mitral valve prolapse","d":"Aortic stenosis"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nMitral valve prolapse (MVP) presents with systolic click (abrupt leaflet billowing) followed by late systolic murmur at apex, and murmur becomes louder and earlier with standing (decreased preload causes click/murmur to occur earlier in systole). The \"click + late systolic murmur\" and positional changes are diagnostic. MVP is most common valve lesion (2-3% of population); usually benign but requires endocarditis prophylaxis if murmur present.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Mitral stenosis:** Diastolic rumble; loud S1; opening snap; different murmur timing.\n- **b) Mitral regurgitation:** Holosystolic murmur (not late systolic with click); continuous/holosystolic.\n- **d) Aortic stenosis:** Systolic ejection murmur (not click-murmur pattern); different location/character.\n\n**3. Exam Essentials**\n\n- **MVP diagnosis:** Systolic click Â± late systolic murmur; click/murmur earlier with Valsalva/standing; softer with squatting.\n- **Complications:** Infective endocarditis (if murmur present), arrhythmias, sudden death (rare), severe MR (rare).\n- **Management:** Reassurance (benign); endocarditis prophylaxis if murmur present; beta-blockers if palpitations.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"MVP Features\":**\n- **Midsystolic** Click\n- **Late systolic** Murmur\n- **Maneuvers:** Earlier with standing/Valsalva (â†“ preload), softer with squatting (â†‘ preload)"},{"id":54,"question":"A patient with infective endocarditis of the aortic valve develops acute dyspnea, hypotension, and flash pulmonary edema. Most likely finding?","options":{"a":"Severe acute AR","b":"Severe AS","c":"Acute MR","d":"Severe TR"},"correctAnswer":"a","explanation":"**1. High-Yield Topic Explanation**\n\nIn infective endocarditis (IE) of the aortic valve causing acute severe AR with flash pulmonary edema, hypotension, and acute dyspnea, the most likely finding is severe acute aortic regurgitation. Acute AR causes sudden volume overload of unprepared LV â†’ acute LV failure with pulmonary edema and cardiogenic shock. The acute presentation (hours to days) distinguishes from chronic AR which is better tolerated.\n\n**2. Rationale for Incorrect Options**\n\n- **b) Severe AS:** Would present with angina, syncope; pulmonary edema develops gradually.\n- **c) Acute MR:** Possible with IE but usually less dramatic hypotension/pulmonary edema than acute AR.\n- **d) Severe TR:** Right-sided; would cause hepatic congestion, not pulmonary edema/shock.\n\n**3. Exam Essentials**\n\n- **Acute AR hemodynamics:** Sudden volume load; unprepared LV cannot accommodate; acute LV dilation/failure.\n- **IE aortic involvement:** Higher mortality than MR; often requires emergency surgery (aortic root abscess).\n- **Clinical urgency:** Emergency evaluation; echocardiography; blood cultures; probable surgery indicated.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"IE Valve Involvement Severity\":**\n- **Aortic IE:** Most severe (risk of root abscess, acute AR)\n- **Mitral IE:** Common (MR, perforations)\n- **Tricuspid IE:** Less severe (RV can tolerate); IV drug users\n- **Pulmonary valve:** Rare; IV drug users"},{"id":55,"question":"A 45-year-old man has history of rheumatic fever. He presents with diastolic rumble, loud S1, and tapping apex beat. A-fib is present. Best management?","options":{"a":"Immediate balloon valvotomy","b":"Rate control + anticoagulation","c":"Thrombolysis","d":"Coronary angiography"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn rheumatic MS with atrial fibrillation, best management is rate control + anticoagulation. Immediate balloon valvotomy is avoided in AFib (high embolic risk during procedure); anticoagulation essential (AFib increases stroke risk 5-fold in MS). Rate control (beta-blockers, digoxin, calcium channel blockers) improves symptoms. Definitive valve intervention (valvotomy or replacement) planned electively after AFib rate controlled and anticoagulation established.\n\n**2. Rationale for Incorrect Options**\n\n- **a) Immediate balloon valvotomy:** High risk acutely with AFib; emboli from atrial thrombus.\n- **c) Thrombolysis:** No indication; acute/subacute MI not present; risks hemorrhage.\n- **d) Coronary angiography:** Not indicated in isolated MS; reserved if concurrent CAD suspected.\n\n**3. Exam Essentials**\n\n- **AFib in MS:** Extremely common (35-50% of MS patients); embolic stroke major risk.\n- **Anticoagulation:** Essential in AFib + MS (INR 2-3 for mechanical, higher for MS even with bioprosthetic).\n- **Rate control targets:** HR \u003c110 bpm (lenient control) acceptable; strict control (HR \u003c80) not superior in stable patients.\n\n**4. Logical Learning Aid**\n\n**Mnemonic â€“ \"AFib + MS Management\":**\n- Anticoagulation (essential)\n- Rate control (beta-blockers, digoxin, CCB)\n- Valve intervention (planned electively)\n- Avoid procedures acutely (high embolic risk)"}];
        const images = [];
        const initialMcqsState = JSON.parse(JSON.stringify(mcqs)); // For exam reset
        let currentMcqs = []; // Can be a subset for practice mode
        let sections = [];
        let answerStates = [];
        let practiceStates = [];
        let currentSectionIndex = 0;
        let currentQuestionIndexInSection = 0;
        let currentPracticeIndex = 0;
        let timerInterval;
        let practiceTimerInterval;
        let perQuestionTimerInterval;
        let timePerMcq = 0;
        let timeOverall = 0;
        let questionStartTime = 0;
        let subjectName, candidateName, shortNote;
        let onConfirmCallback = null;
        let reviewReturnScreen = 'results'; // 'results' or 'practiceResults'
        let isShuffled = false;
        let isReviewingSaved = false;
        // FIX: Changed to string concatenation to avoid nested template literal parsing issues.
        const EXAM_DRAFT_KEY = 'examDraft_' + examId;
        const PRACTICE_DRAFT_KEY = 'practiceDraft_' + examId;
        const SAVED_MCQS_KEY = 'savedMcqs_' + examId;
        const EXAM_RESULTS_HISTORY_KEY = 'examResultsHistory_' + examId;
        const PRACTICE_RESULTS_HISTORY_KEY = 'practiceResultsHistory_' + examId;
        const THEME_KEY = 'examTheme_' + examId;
        let savedMcqIds = [];
        let isSmoothSwipe = true;
        let isSparklesEnabled = true;
        
        // --- GAMIFICATION STATE ---
        let currentStreak = 0;

        const QuestionStatus = {
            NotVisited: 'NOT_VISITED',
            NotAnswered: 'NOT_ANSWERED',
            Answered: 'ANSWERED',
            MarkedForReview: 'MARKED_FOR_REVIEW',
        };
        
        const statusColors = {
            [QuestionStatus.Answered]: 'bg-green-600 hover:bg-green-500',
            [QuestionStatus.NotAnswered]: 'bg-red-600 hover:bg-red-500',
            [QuestionStatus.NotVisited]: 'bg-gray-500 hover:bg-gray-600',
            [QuestionStatus.MarkedForReview]: 'bg-purple-600 hover:bg-purple-500',
        };

        const svgBookmarkOutline = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" style="color: var(--text-secondary);" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>';
        const svgBookmarkSolid = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" style="color: var(--text-accent);" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path></svg>';

        // --- DOM ELEMENTS ---
        const screens = {
            setup: document.getElementById('setup-screen'),
            exam: document.getElementById('exam-screen'),
            results: document.getElementById('results-screen'),
            review: document.getElementById('review-screen'),
            practice: document.getElementById('practice-screen'),
            practiceResults: document.getElementById('practice-results-screen'),
            pastResults: document.getElementById('past-results-screen'),
            progress: document.getElementById('progress-screen'),
        };
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessageEl = document.getElementById('confirmation-message');
        const confirmActionBtn = document.getElementById('confirm-action-btn');
        const cancelConfirmationBtn = document.getElementById('cancel-confirmation-btn');
        const reportOptionsModal = document.getElementById('report-options-modal');
        const calculatorModal = document.getElementById('calculator-modal');
        const questionPalette = document.getElementById('question-palette');
        const paletteContentWrapper = document.getElementById('palette-content-wrapper');
        const hidePaletteBtn = document.getElementById('hide-palette-btn');
        const showPaletteBtn = document.getElementById('show-palette-btn');
        const practiceResumeModal = document.getElementById('practice-resume-modal');
        const savedQuestionsContainer = document.getElementById('saved-questions-container');
        const viewSavedBtn = document.getElementById('view-saved-btn');
        const savedQuestionsCountEl = document.getElementById('saved-questions-count');
        const saveMcqBtn = document.getElementById('save-mcq-btn');
        const saveMcqPracticeBtn = document.getElementById('save-mcq-practice-btn');
        const toggleSparklesBtn = document.getElementById('toggle-sparkles-btn');
        const reviewTitleEl = document.getElementById('review-title');
        const toastEl = document.getElementById('toast-notification');
        
        // --- CONFETTI LOGIC (Gravity Burst) ---
        function triggerConfetti(rect) {
            if (!isSparklesEnabled) return;
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const colors = ['#EF476F', '#FFD166', '#06D6A0', '#118AB2', '#073B4C', '#9D4EDD'];
            
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.style.position = 'fixed';
                particle.style.left = centerX + 'px';
                particle.style.top = centerY + 'px';
                particle.style.width = (Math.random() * 10 + 5) + 'px';
                particle.style.height = particle.style.width;
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                particle.style.zIndex = '9999';
                particle.style.pointerEvents = 'none';
                
                // Random Shapes: Square, Circle, Triangle, Star
                const shapeType = Math.floor(Math.random() * 4);
                if (shapeType === 1) { // Circle
                    particle.style.borderRadius = '50%';
                } else if (shapeType === 2) { // Triangle
                     particle.style.width = '0'; 
                     particle.style.height = '0'; 
                     particle.style.backgroundColor = 'transparent';
                     particle.style.borderLeft = '6px solid transparent';
                     particle.style.borderRight = '6px solid transparent';
                     particle.style.borderBottom = '12px solid ' + colors[Math.floor(Math.random() * colors.length)];
                } else if (shapeType === 3) { // Star (using clip-path)
                     particle.style.clipPath = 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)';
                }
                // shapeType 0 is Square (default)

                document.body.appendChild(particle);

                // Physics variables
                // Burst effect: high velocity, random angle
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 15 + 5; 
                let vx = Math.cos(angle) * velocity;
                let vy = Math.sin(angle) * velocity;
                const gravity = 0.8;
                const drag = 0.96;
                let posX = centerX;
                let posY = centerY;
                let rotation = Math.random() * 360;
                let rotationSpeed = (Math.random() - 0.5) * 20;
                let opacity = 1;

                function animate() {
                    posX += vx;
                    posY += vy;
                    vy += gravity; // Apply gravity
                    vx *= drag;    // Air resistance
                    vy *= drag;
                    rotation += rotationSpeed;
                    opacity -= 0.01;

                    particle.style.left = posX + 'px';
                    particle.style.top = posY + 'px';
                    if (shapeType !== 2) { 
                        particle.style.transform = 'rotate(' + rotation + 'deg)';
                    } else {
                        particle.style.transform = 'rotate(' + rotation + 'deg)';
                    }
                    particle.style.opacity = opacity;

                    if (opacity > 0 && posY < window.innerHeight) {
                        requestAnimationFrame(animate);
                    } else {
                        particle.remove();
                    }
                }
                
                requestAnimationFrame(animate);
            }
        }

        // --- DYNAMIC ISLAND LOGIC ---
        const island = document.getElementById('dynamic-island');
        const islandMinimizeBtn = document.getElementById('island-minimize-btn');
        const islandThemeBtn = document.getElementById('island-theme-btn');
        const islandSettingsBtn = document.getElementById('island-settings-btn');
        const islandProgressBtn = document.getElementById('island-progress-btn');
        const islandHomeBtn = document.getElementById('island-home-btn');
        const swipeIconSmooth = document.getElementById('swipe-icon-smooth');
        const swipeIconHard = document.getElementById('swipe-icon-hard');
        
        let islandIdleTimeout;
        let isMinimized = false;
        
        function resetIslandIdle() {
            if (isMinimized) return; // Don't fade out if minimized (handled by style)
            island.classList.remove('idle');
            if (islandIdleTimeout) clearTimeout(islandIdleTimeout);
            islandIdleTimeout = setTimeout(() => {
                island.classList.add('idle');
            }, 3000);
        }

        // Initialize drag for Dynamic Island
        function initDynamicIsland() {
            // Trigger startup vibration
            island.classList.add('hint-anim');
            setTimeout(() => { island.classList.remove('hint-anim'); }, 1000);

            let isDragging = false;
            let dragOffsetX, dragOffsetY;
            const threshold = 5; // Movement threshold

            const onStart = (clientX, clientY) => {
                if (isMinimized) return;
                
                // Calculate offset from the top-left of the island to the cursor
                const rect = island.getBoundingClientRect();
                dragOffsetX = clientX - rect.left;
                dragOffsetY = clientY - rect.top;
                
                isDragging = false;
                resetIslandIdle();
                
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchmove', onTouchMove, { passive: false });
                document.addEventListener('touchend', onEnd);
            };
            
            const onMove = (e) => handleMove(e.clientX, e.clientY);
            const onTouchMove = (e) => {
                if (isMinimized) return;
                e.preventDefault();
                handleMove(e.touches[0].clientX, e.touches[0].clientY);
            };

            const handleMove = (clientX, clientY) => {
                if (!isDragging) {
                    // Check if moved enough to count as drag
                    isDragging = true;
                    island.classList.add('dragging'); // Disables transition for 1:1 tracking
                    
                    // Clear transform logic used for centering, switch to absolute pos
                    island.style.transform = 'none';
                    island.style.right = 'auto'; 
                    island.style.bottom = 'auto';
                }

                // Move exactly with cursor
                island.style.left = (clientX - dragOffsetX) + 'px';
                island.style.top = (clientY - dragOffsetY) + 'px';
                resetIslandIdle();
            };

            const onEnd = () => {
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchmove', onTouchMove);
                document.removeEventListener('touchend', onEnd);
                
                if (isDragging) {
                    island.classList.remove('dragging'); // Re-enable transition for snap
                    snapIsland();
                }
            };
            
            island.addEventListener('mousedown', (e) => {
                if (isMinimized) return;
                if (e.target.closest('button')) return;
                onStart(e.clientX, e.clientY);
            });
            
            island.addEventListener('touchstart', (e) => {
                if (isMinimized) return;
                if (e.target.closest('button')) return;
                onStart(e.touches[0].clientX, e.touches[0].clientY);
            }, { passive: false });
            
            island.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', resetIslandIdle);
            });
            
            island.addEventListener('click', (e) => {
                if (isMinimized && !e.target.closest('button')) {
                    toggleMinimize();
                }
            });
            
            resetIslandIdle();
        }
        
        function snapIsland() {
            const rect = island.getBoundingClientRect();
            const winW = window.innerWidth;
            const winH = window.innerHeight;
            
            const distTop = rect.top;
            const distBottom = winH - rect.bottom;
            const distLeft = rect.left;
            const distRight = winW - rect.right;
            
            const minDist = Math.min(distTop, distBottom, distLeft, distRight);
            const padding = 20;

            island.classList.remove('horizontal', 'vertical');

            // Snap logic
            if (minDist === distTop) {
                island.style.top = padding + 'px';
                island.style.bottom = 'auto';
                island.classList.add('horizontal');
            } else if (minDist === distBottom) {
                island.style.top = 'auto';
                island.style.bottom = padding + 'px';
                island.classList.add('horizontal');
            } else if (minDist === distLeft) {
                island.style.left = padding + 'px';
                island.style.right = 'auto';
                island.classList.add('vertical');
            } else { // Right
                island.style.left = 'auto';
                island.style.right = padding + 'px';
                island.classList.add('vertical');
            }
            
            // Constrain within window
            const newRect = island.getBoundingClientRect();
            if (island.classList.contains('horizontal')) {
               if(newRect.left < 0) island.style.left = padding + 'px';
               if(newRect.right > winW) island.style.left = (winW - newRect.width - padding) + 'px';
            } else {
               if(newRect.top < 0) island.style.top = padding + 'px';
               if(newRect.bottom > winH) island.style.top = (winH - newRect.height - padding) + 'px';
            }
        }
        
        function toggleMinimize() {
            isMinimized = !isMinimized;
            
            if (isMinimized) {
                island.classList.add('minimized');
                // Force snap to closest wall with 0 padding for the "dash" look
                const rect = island.getBoundingClientRect();
                const winW = window.innerWidth;
                const winH = window.innerHeight;
                
                // Determine orientation based on current class
                if (island.classList.contains('horizontal')) {
                    if (rect.top < winH / 2) { // Top wall
                        island.style.top = '0px';
                        island.style.bottom = 'auto';
                    } else { // Bottom wall
                        island.style.top = 'auto';
                        island.style.bottom = '0px';
                    }
                } else { // Vertical
                     if (rect.left < winW / 2) { // Left wall
                        island.style.left = '0px';
                        island.style.right = 'auto';
                    } else { // Right wall
                        island.style.left = 'auto';
                        island.style.right = '0px';
                    }
                }
            } else {
                island.classList.remove('minimized');
                snapIsland(); // Restore to padded position
                resetIslandIdle();
            }
        }
        
        initDynamicIsland();

        islandMinimizeBtn.addEventListener('click', toggleMinimize);
        
        const themes = ['light', 'dark', 'ambient'];
        islandThemeBtn.addEventListener('click', (e) => {
            const currentTheme = document.documentElement.dataset.theme || 'light';
            const currentIndex = themes.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % themes.length;
            const newTheme = themes[nextIndex];
            
            // Fix: Ensure coordinates are valid for touch/click
            const x = (e.clientX !== undefined && e.clientX !== 0) ? e.clientX : window.innerWidth / 2;
            const y = (e.clientY !== undefined && e.clientY !== 0) ? e.clientY : window.innerHeight / 2;
            
            const endRadius = Math.hypot(
                Math.max(x, innerWidth - x),
                Math.max(y, innerHeight - y)
            );

            // View Transition API for "Sunrise" effect
            if (document.startViewTransition) {
                 const transition = document.startViewTransition(() => {
                    applyTheme(newTheme);
                });

                transition.ready.then(() => {
                    // Animate the clip-path of the new view
                    document.documentElement.animate(
                        {
                            clipPath: [
                                `circle(0px at ${x}px ${y}px)`,
                                `circle(${endRadius}px at ${x}px ${y}px)`
                            ],
                        },
                        {
                            duration: 500,
                            easing: 'ease-in',
                            pseudoElement: '::view-transition-new(root)',
                        }
                    );
                });
            } else {
                // Fallback Animation for devices without View Transition API
                 const themeColors = {
                    'light': '#f3f4f6',
                    'dark': '#374151',
                    'ambient': '#eee8d5'
                };
                
                const overlay = document.createElement('div');
                overlay.style.position = 'fixed';
                overlay.style.top = y + 'px';
                overlay.style.left = x + 'px';
                overlay.style.width = '0px';
                overlay.style.height = '0px';
                overlay.style.borderRadius = '50%';
                overlay.style.backgroundColor = themeColors[newTheme];
                overlay.style.zIndex = '10000';
                overlay.style.transform = 'translate(-50%, -50%)';
                overlay.style.pointerEvents = 'none';
                document.body.appendChild(overlay);
                
                const anim = overlay.animate(
                    [{ width: '0px', height: '0px' }, { width: (endRadius * 2) + 'px', height: (endRadius * 2) + 'px' }],
                    { duration: 500, easing: 'ease-in', fill: 'forwards' }
                );
                
                anim.onfinish = () => {
                    applyTheme(newTheme);
                    overlay.remove();
                };
            }
        });
        
        islandSettingsBtn.addEventListener('click', () => {
            isSmoothSwipe = !isSmoothSwipe;
            if (isSmoothSwipe) {
                document.documentElement.style.setProperty('--swipe-duration', '0.3s');
                swipeIconSmooth.classList.remove('hidden');
                swipeIconHard.classList.add('hidden');
                showToast("Swipe Animation: Smooth");
            } else {
                document.documentElement.style.setProperty('--swipe-duration', '0s');
                swipeIconSmooth.classList.add('hidden');
                swipeIconHard.classList.remove('hidden');
                showToast("Swipe Animation: Instant");
            }
        });
        
        islandProgressBtn.addEventListener('click', () => {
            switchScreen('progress');
            renderProgressCharts();
        });

        islandHomeBtn.addEventListener('click', () => {
            const currentScreenId = document.querySelector('.screen.active')?.id;
            const goHome = () => {
                 if (document.startViewTransition) {
                     document.startViewTransition(() => switchScreen('setup'));
                 } else {
                     switchScreen('setup');
                 }
            };
            
            if (currentScreenId === 'exam-screen') {
                showConfirmation("Exit exam and go home? Progress is saved locally.", () => {
                    saveExamDraft();
                    goHome();
                });
            } else if (currentScreenId === 'practice-screen') {
                 showConfirmation("Exit practice session?", () => {
                    savePracticeDraft();
                    goHome();
                 });
            } else {
                goHome();
            }
        });

        // --- THEME LOGIC ---
        function applyTheme(theme) {
            document.documentElement.dataset.theme = theme;
            try {
                localStorage.setItem(THEME_KEY, theme);
            } catch (e) { console.error('Failed to save theme'); }
        }

        // --- UTILS ---
        let toastTimeout;
        function showToast(message) {
            if (toastTimeout) clearTimeout(toastTimeout);
            toastEl.textContent = message;
            toastEl.classList.add('show');
            toastTimeout = setTimeout(() => {
                toastEl.classList.remove('show');
            }, 3000);
        }
        
        function animateButton(buttonEl) {
            buttonEl.classList.remove('pop-animation');
            // This is a trick to restart the animation
            void buttonEl.offsetWidth; 
            buttonEl.classList.add('pop-animation');
        }

        function showConfirmation(message, onConfirm) {
            onConfirmCallback = onConfirm;
            confirmationMessageEl.textContent = message;
            confirmationModal.classList.remove('hidden');
            confirmationModal.classList.add('flex');
        }

        function hideConfirmation() {
            onConfirmCallback = null;
            confirmationModal.classList.add('hidden');
            confirmationModal.classList.remove('flex');
        }

        confirmActionBtn.addEventListener('click', () => {
            if (onConfirmCallback) {
                onConfirmCallback();
            }
            hideConfirmation();
        });

        cancelConfirmationBtn.addEventListener('click', hideConfirmation);

        // --- HISTORY API INTEGRATION ---
        
        // Initialize history state on load
        window.history.replaceState({ screen: 'setup' }, '', '#setup');

        function switchScreen(screenName, pushToHistory = true) {
            Object.values(screens).forEach(screen => {
                if(screen) screen.classList.remove('active');
            });
            if(screens[screenName]) {
                screens[screenName].classList.add('active');
                if (pushToHistory) {
                    window.history.pushState({ screen: screenName }, '', '#' + screenName);
                }
            }
        }

        window.addEventListener('popstate', (event) => {
            const activeScreen = document.querySelector('.screen.active');
            const activeId = activeScreen ? activeScreen.id : 'setup-screen';

            // GUARD: Prevent exiting Exam Mode accidentally
            if (activeId === 'exam-screen') {
                // Push state back immediately to maintain URL/State stability while showing modal
                window.history.pushState({ screen: 'exam' }, '', '#exam');
                showConfirmation("Are you sure you want to exit the exam? Your progress will be saved.", () => {
                    // If confirmed, proceed to finish exam (which goes to results)
                    handleNextSection(); 
                });
                return;
            }

            // GUARD: Prevent exiting Practice Mode accidentally
            if (activeId === 'practice-screen') {
                 window.history.pushState({ screen: 'practice' }, '', '#practice');
                 showConfirmation("Are you sure you want to exit practice mode?", () => {
                    if (practiceTimerInterval) clearInterval(practiceTimerInterval);
                    if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
                    recordTime(currentMcqs[currentPracticeIndex].id, practiceStates);
                    showPracticeResults();
                 });
                 return;
            }

            // Normal Navigation handling
            if (event.state && event.state.screen) {
                switchScreen(event.state.screen, false); // false = don't push again
            } else {
                switchScreen('setup', false);
            }
        });

        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function formatTime(seconds) {
            const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
            const secs = String(seconds % 60).padStart(2, '0');
            return mins + ':' + secs;
        }
        
        function formatTimeDetailed(seconds) {
            if (seconds < 60) return Math.round(seconds) + 's';
            const mins = Math.floor(seconds / 60);
            const secs = Math.round(seconds % 60);
            return mins + 'm ' + secs + 's';
        }

        function processQuestionContent(text, imageContainerId) {
            const imageContainer = document.getElementById(imageContainerId);
            imageContainer.innerHTML = ''; // Clear previous image

            const imageRegex = /{image\s+(\d+)}/g;
            let processedText = text;
            
            let match;
            const displayedImageIndices = new Set();
            while ((match = imageRegex.exec(text)) !== null) {
                const imageIndex = parseInt(match[1], 10) - 1;
                if (images[imageIndex] && !displayedImageIndices.has(imageIndex)) {
                    const img = document.createElement('img');
                    img.src = images[imageIndex];
                    img.alt = 'Illustration for question';
                    img.className = 'max-w-full max-h-96 object-contain rounded-md shadow-sm border mx-auto themed-border-primary';
                    imageContainer.appendChild(img);
                    displayedImageIndices.add(imageIndex);
                }
                processedText = processedText.replace(match[0], '');
            }
            
            return processedText.trim();
        }

        // --- TIME TRACKING LOGIC ---
        function recordTime(mcqId, stateCollection) {
            if (!mcqId || !questionStartTime) return;
            const state = stateCollection.find(s => s.mcqId === mcqId);
            if (state) {
                const elapsed = (Date.now() - questionStartTime) / 1000; // in seconds
                state.timeTaken = (state.timeTaken || 0) + elapsed;
            }
        }

        // --- DRAFT LOGIC ---
        function saveExamDraft() {
            try {
                recordTime(currentMCQ.id, answerStates);
                const draft = {
                    mcqs: currentMcqs, // Save potentially shuffled list
                    sections,
                    answerStates,
                    currentSectionIndex,
                    currentQuestionIndexInSection,
                    subjectName,
                    candidateName,
                    shortNote,
                    isShuffled,
                };
                localStorage.setItem(EXAM_DRAFT_KEY, JSON.stringify(draft));
                questionStartTime = Date.now(); // Reset timer after saving
            } catch (e) {
                console.error("Failed to save exam draft:", e);
            }
        }
        
        function savePracticeDraft() {
            try {
                recordTime(currentMcqs[currentPracticeIndex].id, practiceStates);
                const draft = {
                    mcqs: currentMcqs, // Save the subset of MCQs
                    practiceStates,
                    currentPracticeIndex,
                    subjectName,
                    candidateName,
                    isShuffled,
                    timePerMcq,
                    timeOverall,
                    currentStreak, // Save streak
                };
                localStorage.setItem(PRACTICE_DRAFT_KEY, JSON.stringify(draft));
                questionStartTime = Date.now(); // Reset timer after saving
            } catch (e) {
                console.error("Failed to save practice draft:", e);
            }
        }

        function clearExamDraft() { localStorage.removeItem(EXAM_DRAFT_KEY); }
        function clearPracticeDraft() { localStorage.removeItem(PRACTICE_DRAFT_KEY); }
        
        // --- SAVED QUESTIONS LOGIC ---
        function updateSavedQuestionsUI() {
            if (savedMcqIds.length > 0) {
                savedQuestionsCountEl.textContent = savedMcqIds.length;
                savedQuestionsContainer.classList.remove('hidden');
            } else {
                savedQuestionsContainer.classList.add('hidden');
            }
        }

        function toggleSaveMcq() {
            const mcq = currentMcqs[reviewQuestionIndex];
            if (!mcq) return;

            const mcqId = mcq.id;
            const index = savedMcqIds.indexOf(mcqId);
            let message = '';

            if (index > -1) {
                savedMcqIds.splice(index, 1);
                message = 'Question Unsaved!';
            } else {
                savedMcqIds.push(mcqId);
                message = 'Question Saved!';
                animateButton(saveMcqBtn);
            }

            showToast(message);
            localStorage.setItem(SAVED_MCQS_KEY, JSON.stringify(savedMcqIds));
            updateSaveButtonState();
            updateSavedQuestionsUI();

            if (isReviewingSaved && savedMcqIds.length === 0) {
                alert("You have no saved questions.");
                switchScreen('setup');
            } else if (isReviewingSaved) {
                // Refresh the view if an item is removed
                currentMcqs = initialMcqsState.filter(mcq => savedMcqIds.includes(mcq.id));
                if (reviewQuestionIndex >= currentMcqs.length) {
                    reviewQuestionIndex = Math.max(0, currentMcqs.length - 1);
                }
                renderReviewPalette();
                renderReviewQuestion();
            }
        }
        
        function toggleSavePracticeMcq() {
            const mcq = currentMcqs[currentPracticeIndex];
            if (!mcq) return;

            const mcqId = mcq.id;
            const index = savedMcqIds.indexOf(mcqId);
            let message = '';

            if (index > -1) {
                savedMcqIds.splice(index, 1);
                message = 'Question Unsaved!';
            } else {
                savedMcqIds.push(mcqId);
                message = 'Question Saved!';
                animateButton(saveMcqPracticeBtn);
            }
            
            showToast(message);
            localStorage.setItem(SAVED_MCQS_KEY, JSON.stringify(savedMcqIds));
            updatePracticeSaveButtonState();
            updateSavedQuestionsUI();
        }

        function updateSaveButtonState() {
            const mcq = currentMcqs[reviewQuestionIndex];
            if (!mcq) return;

            if (savedMcqIds.includes(mcq.id)) {
                saveMcqBtn.innerHTML = svgBookmarkSolid;
                saveMcqBtn.setAttribute('aria-label', 'Unsave Question');
            } else {
                saveMcqBtn.innerHTML = svgBookmarkOutline;
                saveMcqBtn.setAttribute('aria-label', 'Save Question');
            }
        }
        
        function updatePracticeSaveButtonState() {
            const mcq = currentMcqs[currentPracticeIndex];
            if (!mcq) return;

            if (savedMcqIds.includes(mcq.id)) {
                saveMcqPracticeBtn.innerHTML = svgBookmarkSolid;
                saveMcqPracticeBtn.setAttribute('aria-label', 'Unsave Question');
            } else {
                saveMcqPracticeBtn.innerHTML = svgBookmarkOutline;
                saveMcqPracticeBtn.setAttribute('aria-label', 'Save Question');
            }
        }

        // --- PALETTE VISIBILITY LOGIC ---
        if(hidePaletteBtn && showPaletteBtn && questionPalette && paletteContentWrapper) {
            hidePaletteBtn.addEventListener('click', () => {
                questionPalette.classList.remove('w-64');
                questionPalette.classList.add('w-0');
                paletteContentWrapper.classList.add('opacity-0');
                hidePaletteBtn.classList.add('hidden');
                showPaletteBtn.classList.remove('hidden');
            });

            showPaletteBtn.addEventListener('click', () => {
                questionPalette.classList.remove('w-0');
                questionPalette.classList.add('w-64');
                paletteContentWrapper.classList.remove('opacity-0');
                showPaletteBtn.classList.add('hidden');
                hidePaletteBtn.classList.remove('hidden');
            });
        }

        // --- CALCULATOR LOGIC ---
        const calculatorHeader = document.getElementById('calculator-header');
        const calculatorCloseBtn = document.getElementById('calculator-close-btn');
        const calculatorDisplay = document.getElementById('calculator-display');
        const calculatorButtons = document.getElementById('calculator-buttons');
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };

        function toggleCalculator(buttonEl) {
            const wasHidden = calculatorModal.classList.contains('hidden');
            
            if (wasHidden) {
                const rect = buttonEl.getBoundingClientRect();
                const calculatorWidth = 256; // Corresponds to Tailwind's w-64 class
                
                // Position it below the button, accounting for page scroll
                calculatorModal.style.top = (rect.bottom + window.scrollY + 10) + 'px';
                
                // Center it horizontally under the button
                let leftPos = rect.left + window.scrollX + (rect.width / 2) - (calculatorWidth / 2);
                
                // Constrain to viewport horizontal edges
                const minLeft = window.scrollX + 8;
                const maxLeft = window.scrollX + window.innerWidth - calculatorWidth - 8;
                leftPos = Math.max(minLeft, Math.min(leftPos, maxLeft));

                calculatorModal.style.left = leftPos + 'px';
            }
             
            calculatorModal.classList.toggle('hidden');
        }
        document.getElementById('calculator-toggle-btn').addEventListener('click', (e) => toggleCalculator(e.currentTarget));
        document.getElementById('practice-calculator-toggle-btn').addEventListener('click', (e) => toggleCalculator(e.currentTarget));
        
        calculatorCloseBtn.addEventListener('click', () => {
            calculatorModal.classList.add('hidden');
        });

        function dragStart(clientX, clientY) {
            isDragging = true;
            dragOffset.x = clientX - calculatorModal.offsetLeft;
            dragOffset.y = clientY - calculatorModal.offsetTop;
            calculatorModal.classList.add('dragging');
            document.body.style.userSelect = 'none'; // Prevent text selection
        }

        function dragMove(clientX, clientY) {
            if (!isDragging) return;
            const newX = clientX - dragOffset.x;
            const newY = clientY - dragOffset.y;
            const maxX = window.innerWidth - calculatorModal.offsetWidth;
            const maxY = window.innerHeight - calculatorModal.offsetHeight;
            calculatorModal.style.left = Math.max(0, Math.min(newX, maxX)) + 'px';
            calculatorModal.style.top = Math.max(0, Math.min(newY, maxY)) + 'px';
        }

        function dragEnd() {
            if (!isDragging) return;
            isDragging = false;
            calculatorModal.classList.remove('dragging');
            document.body.style.userSelect = '';
        }

        // Mouse Events
        calculatorHeader.addEventListener('mousedown', (e) => {
            e.preventDefault();
            dragStart(e.clientX, e.clientY);
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                dragMove(e.clientX, e.clientY);
            }
        });
        
        document.addEventListener('mouseup', dragEnd);

        // Touch Events
        calculatorHeader.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                dragStart(e.touches[0].clientX, e.touches[0].clientY);
            }
        }, { passive: true });

        document.addEventListener('touchmove', (e) => {
            if (isDragging && e.touches.length === 1) {
                e.preventDefault(); // Prevent scrolling while dragging
                dragMove(e.touches[0].clientX, e.touches[0].clientY);
            }
        }, { passive: false });

        document.addEventListener('touchend', dragEnd);
        document.addEventListener('touchcancel', dragEnd);


        const calculatorState = {
            displayValue: '0',
            fullExpression: '', // Holds the full visual string e.g. "6+5"
            firstOperand: null,
            waitingForSecondOperand: false,
            operator: null,
            isResultDisplayed: false
        };

        function updateCalculatorDisplay() {
            calculatorDisplay.textContent = calculatorState.fullExpression || '0';
            calculatorDisplay.scrollLeft = calculatorDisplay.scrollWidth;
        }

        function inputDigit(digit) {
            if (calculatorState.isResultDisplayed) {
                calculatorState.fullExpression = digit;
                calculatorState.displayValue = digit;
                calculatorState.firstOperand = null;
                calculatorState.waitingForSecondOperand = false;
                calculatorState.operator = null;
                calculatorState.isResultDisplayed = false;
                return;
            }

            // Append to full expression, replacing single '0' unless digit is '.'
            if (calculatorState.fullExpression === '0') {
                calculatorState.fullExpression = digit;
            } else {
                calculatorState.fullExpression += digit;
            }

            const { displayValue, waitingForSecondOperand } = calculatorState;
            if (waitingForSecondOperand) {
                calculatorState.displayValue = digit;
                calculatorState.waitingForSecondOperand = false;
            } else {
                calculatorState.displayValue = displayValue === '0' ? digit : displayValue + digit;
            }
        }

        function inputDecimal(dot) {
            if (calculatorState.isResultDisplayed) {
                calculatorState.displayValue = '0.';
                calculatorState.fullExpression = '0.';
                calculatorState.firstOperand = null;
                calculatorState.waitingForSecondOperand = false;
                calculatorState.operator = null;
                calculatorState.isResultDisplayed = false;
                return;
            }

            if (calculatorState.waitingForSecondOperand) {
                calculatorState.displayValue = '0.';
                calculatorState.waitingForSecondOperand = false;
                calculatorState.fullExpression += '0.';
                return;
            }
            if (!calculatorState.displayValue.includes(dot)) {
                calculatorState.displayValue += dot;
                calculatorState.fullExpression += dot;
            }
        }
        
        const performCalculation = {
            '/': (first, second) => second === 0 ? 'Error' : first / second,
            '*': (first, second) => first * second,
            '+': (first, second) => first + second,
            '-': (first, second) => first - second,
        };

        function handleOperator(nextOperator) {
            if (calculatorState.isResultDisplayed) {
                // If starting new operation on result, keep result in display
                calculatorState.fullExpression = calculatorState.displayValue + nextOperator;
                calculatorState.isResultDisplayed = false;
            } else {
                calculatorState.fullExpression += nextOperator;
            }

            const { firstOperand, displayValue, operator } = calculatorState;
            const inputValue = parseFloat(displayValue);

            if (operator && calculatorState.waitingForSecondOperand) {
                calculatorState.operator = nextOperator;
                return;
            }

            if (firstOperand === null) {
                calculatorState.firstOperand = inputValue;
            } else if (operator) {
                const result = performCalculation[operator](firstOperand, inputValue);
                if (result === 'Error') {
                    calculatorState.displayValue = 'Error';
                    calculatorState.fullExpression = 'Error';
                } else {
                    // Truncate long decimals to avoid display issues
                    const resStr = String(parseFloat(result.toFixed(7)));
                    calculatorState.displayValue = resStr;
                }
                calculatorState.firstOperand = result === 'Error' ? null : result;
            }
            
            calculatorState.waitingForSecondOperand = true;
            calculatorState.operator = nextOperator;
        }

        function resetCalculator() {
            calculatorState.displayValue = '0';
            calculatorState.fullExpression = '';
            calculatorState.firstOperand = null;
            calculatorState.waitingForSecondOperand = false;
            calculatorState.operator = null;
            calculatorState.isResultDisplayed = false;
        }

        calculatorButtons.addEventListener('click', (event) => {
            const { target } = event;
            if (!target.matches('button')) return;

            if (calculatorState.displayValue === 'Error' && target.textContent !== 'C') return;

            if (target.classList.contains('digit')) { inputDigit(target.textContent); }
            else if (target.classList.contains('decimal')) { inputDecimal(target.textContent); }
            else if (target.classList.contains('operator')) { handleOperator(target.textContent); }
            else if (target.textContent === 'C') { resetCalculator(); }
            else if (target.classList.contains('equals')) {
                 if (calculatorState.operator && calculatorState.firstOperand !== null) {
                    const inputValue = parseFloat(calculatorState.displayValue);
                    const result = performCalculation[calculatorState.operator](calculatorState.firstOperand, inputValue);
                    
                    let resultStr = 'Error';
                    if (result !== 'Error') {
                         resultStr = String(parseFloat(result.toFixed(7)));
                    }
                    
                    calculatorState.displayValue = resultStr;
                    calculatorState.fullExpression += '=' + resultStr; // Append =Result
                    
                    calculatorState.firstOperand = null;
                    calculatorState.operator = null;
                    calculatorState.waitingForSecondOperand = false;
                    calculatorState.isResultDisplayed = true;
                }
            }
            updateCalculatorDisplay();
        });

        function handleCalculatorKeyPress(event) {
            if (calculatorModal.classList.contains('hidden')) return;

            const { key } = event;
            let buttonToAnimate;
            
            const buttons = Array.from(calculatorButtons.querySelectorAll('button'));

            if (key >= '0' && key <= '9') {
                inputDigit(key);
                buttonToAnimate = buttons.find(b => b.textContent === key && b.classList.contains('digit'));
            } else if (key === '.') {
                inputDecimal(key);
                buttonToAnimate = buttons.find(b => b.textContent === key && b.classList.contains('decimal'));
            } else if (['+', '-', '*', '/'].includes(key)) {
                handleOperator(key);
                buttonToAnimate = buttons.find(b => b.textContent === key && b.classList.contains('operator'));
            } else if (key === 'Enter' || key === '=') {
                event.preventDefault();
                if (calculatorState.operator && calculatorState.firstOperand !== null) {
                     const inputValue = parseFloat(calculatorState.displayValue);
                     const result = performCalculation[calculatorState.operator](calculatorState.firstOperand, inputValue);
                     let resultStr = 'Error';
                     if (result !== 'Error') { resultStr = String(parseFloat(result.toFixed(7))); }
                     calculatorState.displayValue = resultStr;
                     calculatorState.fullExpression += '=' + resultStr;
                     
                     calculatorState.firstOperand = null;
                     calculatorState.operator = null;
                     calculatorState.waitingForSecondOperand = false;
                     calculatorState.isResultDisplayed = true;
                }
                buttonToAnimate = buttons.find(b => b.classList.contains('equals'));
            } else if (key === 'Escape') {
                calculatorModal.classList.add('hidden');
                buttonToAnimate = calculatorCloseBtn;
            } else if (key === 'Backspace' || key.toLowerCase() === 'c') {
                resetCalculator();
                buttonToAnimate = buttons.find(b => b.textContent === 'C');
            }

            if (buttonToAnimate) {
                buttonToAnimate.classList.add('key-press-feedback');
                setTimeout(() => {
                    buttonToAnimate.classList.remove('key-press-feedback');
                }, 100);
            }
            
            if (['0','1','2','3','4','5','6','7','8','9','.','+','-','*','/','Enter','=','Backspace','c','C'].includes(key)) {
                updateCalculatorDisplay();
            }
        }
        document.addEventListener('keydown', handleCalculatorKeyPress);


        // --- SETUP SCREEN LOGIC ---
        const sectionsContainer = document.getElementById('sections-container');
        const setupErrorEl = document.getElementById('setup-error');
        
        function renderSections() {
            sectionsContainer.innerHTML = '';
            sections.forEach((section, index) => {
                const sectionEl = document.createElement('div');
                sectionEl.className = 'p-4 rounded-md flex items-center space-x-3 themed-bg-tertiary';
                const removeButtonHtml = sections.length > 1
                    ? '<button data-index="' + index + '" class="remove-section-btn themed-text-danger text-2xl">\u00d7</button>'
                    : '';
                
                sectionEl.innerHTML =
                    '<input type="text" value="' + section.name + '" data-index="' + index + '" data-field="name" class="section-input p-2 rounded w-1/4 border" placeholder="Section Name"/>' +
                    '<input type="number" value="' + section.startQuestion + '" data-index="' + index + '" data-field="startQuestion" class="section-input p-2 rounded w-1/5 border" placeholder="Start"/>' +
                    '<span class="themed-text-tertiary">to</span>' +
                    '<input type="number" value="' + section.endQuestion + '" data-index="' + index + '" data-field="endQuestion" class="section-input p-2 rounded w-1/5 border" placeholder="End"/>' +
                    '<input type="number" value="' + section.duration + '" data-index="' + index + '" data-field="duration" class="section-input p-2 rounded w-1/5 border" placeholder="Duration (min)"/>' +
                    removeButtonHtml;
                sectionsContainer.appendChild(sectionEl);
            });
        }

        document.getElementById('add-section-btn').addEventListener('click', () => {
            const lastSection = sections[sections.length - 1];
            const nextStart = lastSection.endQuestion + 1;
            if (nextStart > mcqs.length) return;
            sections.push({ name: 'Section ' + (sections.length + 1), startQuestion: nextStart, endQuestion: mcqs.length, duration: mcqs.length - nextStart + 1 });
            renderSections();
        });

        document.getElementById('auto-set-sections-btn').addEventListener('click', () => {
            if (!mcqs || mcqs.length === 0) return;
            
            sections = [];
            const chunkSize = 50;
            let currentStart = 1;
            let idx = 1;
            
            while (currentStart <= mcqs.length) {
                let currentEnd = Math.min(currentStart + chunkSize - 1, mcqs.length);
                sections.push({
                    name: 'Section ' + idx,
                    startQuestion: currentStart,
                    endQuestion: currentEnd,
                    duration: (currentEnd - currentStart + 1) // 1 minute per question
                });
                currentStart = currentEnd + 1;
                idx++;
            }
            renderSections();
            showToast("Sections auto-configured");
        });

        sectionsContainer.addEventListener('change', (e) => {
            const target = e.target;
            if (target.classList.contains('section-input')) {
                const { index, field } = target.dataset;
                const value = field === 'name' ? target.value : parseInt(target.value, 10);
                sections[index][field] = value;
            }
        });
        
        sectionsContainer.addEventListener('click', (e) => {
            const target = e.target;
            if(target.classList.contains('remove-section-btn')) {
                const { index } = target.dataset;
                sections.splice(parseInt(index, 10), 1);
                renderSections();
            }
        });

        document.getElementById('revise-btn').addEventListener('click', () => {
            setupErrorEl.textContent = '';
            subjectName = document.getElementById('subject-name').value;
            candidateName = document.getElementById('candidate-name').value;
            
            // Use full, unshuffled set for revision
            currentMcqs = [...initialMcqsState]; 
            answerStates = currentMcqs.map(mcq => ({ mcqId: mcq.id, status: QuestionStatus.NotVisited, selectedOption: undefined, timeTaken: 0 }));
            reviewQuestionIndex = 0;
            switchScreen('review');
            setupReviewScreen(true, false); // isReviseMode = true
        });

        document.getElementById('start-exam-btn').addEventListener('click', () => {
            setupErrorEl.textContent = '';
            subjectName = document.getElementById('subject-name').value;
            candidateName = document.getElementById('candidate-name').value;
            shortNote = document.getElementById('short-note').value;
            
            let questionSet = new Set();
            for(const section of sections) {
                if(section.startQuestion > section.endQuestion || section.startQuestion < 1 || section.endQuestion > mcqs.length) {
                    setupErrorEl.textContent = 'Invalid range in ' + section.name + '.'; return;
                }
                if(section.duration <= 0) {
                    setupErrorEl.textContent = 'Duration must be positive in ' + section.name + '.'; return;
                }
                for(let i = section.startQuestion; i <= section.endQuestion; i++) {
                    if(questionSet.has(i)) {
                        setupErrorEl.textContent = 'Question ' + i + ' is in multiple sections.'; return;
                    }
                    questionSet.add(i);
                }
            }
            if (questionSet.size !== mcqs.length && mcqs.length > 0) {
                 const allCoveredQuestions = Array.from(questionSet).sort((a,b) => a-b);
                 if (allCoveredQuestions.length !== mcqs.length || allCoveredQuestions[allCoveredQuestions.length - 1] !== mcqs.length) {
                    setupErrorEl.textContent = 'All questions must be covered exactly once across all sections.'; return;
                 }
            }
            
            startExam();
        });
        
        function initializeSetup() {
            sections = [{ name: 'Section 1', startQuestion: 1, endQuestion: mcqs.length, duration: mcqs.length }];
            renderSections();
            const qCountSlider = document.getElementById('practice-q-count-slider');
            const qCountLabel = document.getElementById('practice-q-count-label');
            if(qCountSlider) {
                qCountSlider.addEventListener('input', () => {
                    qCountLabel.textContent = qCountSlider.value;
                });
            }
        }

        function confirmAndProceedToNextSection() {
            const isLastSection = currentSectionIndex === sections.length - 1;
            const message = isLastSection
                ? "Are you sure you want to submit the exam? This will end the test."
                : "Are you sure you want to submit this section? You will not be able to return to it.";
            showConfirmation(message, handleNextSection);
        }


        // --- EXAM LOGIC ---
        let currentSectionMCQs = [];
        let currentMCQ;

        function startExam() {
            isShuffled = document.getElementById('shuffle-mcqs-checkbox').checked;
            let baseMcqs = JSON.parse(JSON.stringify(initialMcqsState));

            if (isShuffled) {
                // Shuffle questions *within* each section's defined range
                sections.forEach(section => {
                    const startIndex = section.startQuestion - 1;
                    const endIndex = section.endQuestion;
                    const sectionSlice = baseMcqs.slice(startIndex, endIndex);
                    shuffleArray(sectionSlice);
                    // Replace the original slice with the shuffled one
                    baseMcqs.splice(startIndex, sectionSlice.length, ...sectionSlice);
                });
            }
            
            currentMcqs.length = 0;
            Array.prototype.push.apply(currentMcqs, baseMcqs);


            answerStates = currentMcqs.map(mcq => ({ mcqId: mcq.id, status: QuestionStatus.NotVisited, selectedOption: undefined, timeTaken: 0 }));
            currentSectionIndex = 0;
            currentQuestionIndexInSection = 0;
            loadSection();
            switchScreen('exam');
        }

        function loadSection() {
            if (timerInterval) clearInterval(timerInterval);

            const section = sections[currentSectionIndex];
            document.getElementById('section-name').textContent = section.name;
            
            // Get questions for the current section from the (potentially shuffled) main list
            currentSectionMCQs = currentMcqs.slice(section.startQuestion - 1, section.endQuestion);
            
            loadQuestion();
            renderPalette();

            let timeLeft = section.duration * 60;
            const timerEl = document.getElementById('timer');
            timerEl.textContent = formatTime(timeLeft);
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = formatTime(timeLeft);
                if (timeLeft <= 0) {
                    handleNextSection();
                }
            }, 1000);
        }
        
        function loadQuestion() {
            currentMCQ = currentSectionMCQs[currentQuestionIndexInSection];
            const answerState = answerStates.find(a => a.mcqId === currentMCQ.id);

            if (answerState.status === QuestionStatus.NotVisited) {
                answerState.status = QuestionStatus.NotAnswered;
            }
            
            document.getElementById('question-counter').textContent = 'Question ' + (currentQuestionIndexInSection + 1) + ' of ' + currentSectionMCQs.length;
            document.getElementById('question-text').innerHTML = processQuestionContent(currentMCQ.question, 'question-image-container');
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            Object.keys(currentMCQ.options).forEach(key => {
                const isSelected = answerState.selectedOption === key;
                const optionEl = document.createElement('label');
                const selectedClass = isSelected ? 'selected' : '';
                optionEl.className = 'option-label flex items-center p-4 rounded-lg cursor-pointer border-2 ' + selectedClass;
                optionEl.innerHTML =
                    '<input type="radio" name="option" value="' + key + '" ' + (isSelected ? 'checked' : '') + ' class="hidden"/>' +
                    '<span class="radio-circle w-6 h-6 rounded-full border-2 themed-border-secondary mr-4 flex-shrink-0 relative"></span>' +
                    '<span class="flex-1">' + key.toUpperCase() + '. ' + currentMCQ.options[key] + '</span>';
                optionsContainer.appendChild(optionEl);
            });

            const saveNextBtn = document.getElementById('save-next-btn');
            if (currentQuestionIndexInSection === currentSectionMCQs.length - 1) {
                saveNextBtn.textContent = 'Submit Section';
            } else {
                saveNextBtn.textContent = 'Save & Next';
            }
            
            document.getElementById('prev-btn').disabled = currentQuestionIndexInSection === 0;
            updatePaletteItem(currentMCQ.id);
            updatePaletteLegendCounts();
            saveExamDraft(); // Auto-save on every question load
            questionStartTime = Date.now();
        }

        document.getElementById('options-container').addEventListener('change', e => {
            const target = e.target;
            if (target.name === 'option') {
                const answerState = answerStates.find(a => a.mcqId === currentMCQ.id);
                const newStatus = answerState.status === QuestionStatus.MarkedForReview ? QuestionStatus.MarkedForReview : QuestionStatus.Answered;
                answerState.selectedOption = target.value;
                answerState.status = newStatus;
                loadQuestion(); // Re-render to show selection and auto-save
            }
        });

        function navigateQuestion(offset) {
            recordTime(currentMCQ.id, answerStates);
            const newIndex = currentQuestionIndexInSection + offset;
            if (newIndex >= 0 && newIndex < currentSectionMCQs.length) {
                currentQuestionIndexInSection = newIndex;
                loadQuestion();
            } else if (newIndex >= currentSectionMCQs.length) {
                confirmAndProceedToNextSection();
            }
        }

        document.getElementById('save-next-btn').addEventListener('click', () => navigateQuestion(1));
        document.getElementById('prev-btn').addEventListener('click', () => navigateQuestion(-1));

        document.getElementById('mark-review-btn').addEventListener('click', () => {
            const answerState = answerStates.find(a => a.mcqId === currentMCQ.id);
            answerState.status = answerState.status === QuestionStatus.MarkedForReview 
                ? (answerState.selectedOption ? QuestionStatus.Answered : QuestionStatus.NotAnswered)
                : QuestionStatus.MarkedForReview;
            updatePaletteItem(currentMCQ.id);
            updatePaletteLegendCounts();
            navigateQuestion(1);
        });

        document.getElementById('clear-response-btn').addEventListener('click', () => {
            const answerState = answerStates.find(a => a.mcqId === currentMCQ.id);
            answerState.selectedOption = undefined;
            answerState.status = QuestionStatus.NotAnswered;
            loadQuestion();
        });

        function handleNextSection() {
            recordTime(currentMCQ.id, answerStates);
            if (currentSectionIndex < sections.length - 1) {
                currentSectionIndex++;
                currentQuestionIndexInSection = 0;
                loadSection();
            } else {
                clearInterval(timerInterval);
                showResults();
            }
        }

        // --- PALETTE LOGIC ---
        function updatePaletteLegendCounts() {
            const sectionMCQIds = new Set(currentSectionMCQs.map(mcq => mcq.id));

            const counts = {
                [QuestionStatus.Answered]: 0,
                [QuestionStatus.NotAnswered]: 0,
                [QuestionStatus.NotVisited]: 0,
                [QuestionStatus.MarkedForReview]: 0,
            };

            answerStates.forEach(state => {
                if (sectionMCQIds.has(state.mcqId)) {
                    counts[state.status]++;
                }
            });

            document.getElementById('answered-count').textContent = String(counts[QuestionStatus.Answered]);
            document.getElementById('not-answered-count').textContent = String(counts[QuestionStatus.NotAnswered]);
            document.getElementById('not-visited-count').textContent = String(counts[QuestionStatus.NotVisited]);
            document.getElementById('marked-for-review-count').textContent = String(counts[QuestionStatus.MarkedForReview]);
        }

        function renderPalette() {
            const paletteContainer = document.getElementById('palette-container');
            paletteContainer.innerHTML = '';
            currentSectionMCQs.forEach((mcq, index) => {
                const answerState = answerStates.find(a => a.mcqId === mcq.id);
                const btn = document.createElement('button');
                btn.id = 'palette-item-' + mcq.id;
                btn.dataset.index = String(index);
                btn.className = 'h-10 w-10 flex items-center justify-center rounded text-white font-bold relative ' + statusColors[answerState.status];
                btn.innerHTML = (index + 1);
                // Accessibility: Add dynamic aria-label
                btn.setAttribute('aria-label', 'Go to question ' + (index + 1));
                if (answerState.status === QuestionStatus.MarkedForReview) {
                    btn.innerHTML += '<svg xmlns="http://www.w3.org/2000/svg" class="absolute bottom-1 right-1 h-3 w-3 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z" /></svg>';
                }
                btn.addEventListener('click', () => {
                    recordTime(currentMCQ.id, answerStates);
                    currentQuestionIndexInSection = parseInt(btn.dataset.index, 10);
                    loadQuestion();
                });
                paletteContainer.appendChild(btn);
            });
        }

        function updatePaletteItem(mcqId) {
            const btn = document.getElementById('palette-item-' + mcqId);
            if (!btn) return;
            const answerState = answerStates.find(a => a.mcqId === mcqId);
            btn.className = 'h-10 w-10 flex items-center justify-center rounded text-white font-bold relative ' + statusColors[answerState.status];
            btn.innerHTML = String(parseInt(btn.dataset.index, 10) + 1);
            if (answerState.status === QuestionStatus.MarkedForReview) {
                btn.innerHTML += '<svg xmlns="http://www.w3.org/2000/svg" class="absolute bottom-1 right-1 h-3 w-3 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z" /></svg>';
            }
        }

        // --- RESULTS LOGIC ---
        function showResults() {
            clearExamDraft();
            const shortNoteHtml = shortNote ? '<p><span class="font-bold">Notes:</span> ' + shortNote + '</p>' : '';
            const detailsHtml =
                '<p><span class="font-bold">Subject:</span> ' + (subjectName || 'N/A') + '</p>' +
                '<p><span class="font-bold">Candidate:</span> ' + (candidateName || 'N/A') + '</p>' +
                shortNoteHtml;
            document.getElementById('exam-details').innerHTML = detailsHtml;

            const results = sections.map(section => {
                let correct = 0, incorrect = 0, unanswered = 0;
                // Use the section's original question indices to find the right questions in the shuffled list
                const sectionQs = currentMcqs.slice(section.startQuestion - 1, section.endQuestion);
                sectionQs.forEach(mcq => {
                    const answerState = answerStates.find(a => a.mcqId === mcq.id);
                    if(answerState) {
                        if(!answerState.selectedOption) unanswered++;
                        else if(answerState.selectedOption === mcq.correctAnswer) correct++;
                        else incorrect++;
                    }
                });

                const total = correct + incorrect + unanswered;
                return { name: section.name, correct, incorrect, unanswered, total, score: total > 0 ? (correct / total * 100) : 0 };
            });
            
            const totalCorrect = results.reduce((sum, r) => sum + r.correct, 0);
            const totalIncorrect = results.reduce((sum, r) => sum + r.incorrect, 0);
            const totalUnanswered = results.reduce((sum, r) => sum + r.unanswered, 0);
            const overallTotal = totalCorrect + totalIncorrect + totalUnanswered;
            const overallScore = overallTotal > 0 ? (totalCorrect / overallTotal * 100) : 0;
            const scoreColorClass = overallScore >= 50 ? 'themed-text-success' : 'themed-text-danger';
            
            const attemptedStates = answerStates.filter(s => s.timeTaken > 0);
            const totalTimeSpent = attemptedStates.reduce((acc, s) => acc + s.timeTaken, 0);
            const avgTime = attemptedStates.length > 0 ? totalTimeSpent / attemptedStates.length : 0;
            const avgTimeHtml = '<div class="mt-4 themed-text-secondary">Average time per question: <span class="font-semibold">' + formatTimeDetailed(avgTime) + '</span></div>';

            const performanceHtml =
                '<h2 class="text-2xl font-semibold">Overall Performance</h2>' +
                '<p class="text-5xl font-bold my-4 ' + scoreColorClass + '">' + overallScore.toFixed(2) + '%</p>' +
                '<div class="flex justify-center space-x-8 text-lg">' +
                    '<span><span class="font-bold themed-text-success">' + totalCorrect + '</span> Correct</span>' +
                    '<span><span class="font-bold themed-text-danger">' + totalIncorrect + '</span> Incorrect</span>' +
                    '<span><span class="font-bold themed-text-secondary">' + totalUnanswered + '</span> Unanswered</span>' +
                '</div>' + avgTimeHtml;
            document.getElementById('overall-performance').innerHTML = performanceHtml;
            
            const sectionAnalysisContainer = document.getElementById('section-analysis');
            sectionAnalysisContainer.innerHTML = '';
            results.forEach(r => {
                sectionAnalysisContainer.innerHTML +=
                    '<div class="p-4 rounded-lg themed-bg-primary">' +
                        '<div class="flex justify-between items-center mb-2">' +
                            '<h3 class="text-xl font-bold">' + r.name + '</h3>' +
                            '<p class="text-xl font-semibold themed-text-accent">' + r.score.toFixed(2) + '%</p>' +
                        '</div>' +
                        '<div class="flex justify-around text-sm">' +
                            '<span>Correct: <span class="font-bold themed-text-success">' + r.correct + '</span></span>' +
                            '<span>Incorrect: <span class="font-bold themed-text-danger">' + r.incorrect + '</span></span>' +
                            '<span>Unanswered: <span class="font-bold themed-text-secondary">' + r.unanswered + '</span></span>' +
                        '</div>' +
                    '</div>';
            });
            const analysisHtml = sectionAnalysisContainer.innerHTML;

            // Save result to localStorage history
            const historyJSON = localStorage.getItem(EXAM_RESULTS_HISTORY_KEY);
            let history = historyJSON ? JSON.parse(historyJSON) : [];
            const resultData = {
                timestamp: new Date().toISOString(),
                overallScore: overallScore.toFixed(2),
                detailsHtml,
                performanceHtml,
                analysisHtml,
                answerStates,
                currentMcqs,
                subjectName,
                candidateName,
                shortNote,
                isShuffled
            };
            history.unshift(resultData); // Add to the beginning
            localStorage.setItem(EXAM_RESULTS_HISTORY_KEY, JSON.stringify(history));
            
            const pastResultsContainer = document.getElementById('past-results-container');
            const pastResultsCount = document.getElementById('past-results-count');
            pastResultsContainer.classList.remove('hidden');
            pastResultsCount.textContent = history.length;


            switchScreen('results');
        }

        document.getElementById('restart-btn').addEventListener('click', () => {
            clearExamDraft();
            clearPracticeDraft();
            document.getElementById('subject-name').value = '';
            document.getElementById('candidate-name').value = '';
            document.getElementById('short-note').value = '';
            document.getElementById('shuffle-mcqs-checkbox').checked = false;
            
            currentMcqs.length = 0;
            Array.prototype.push.apply(currentMcqs, JSON.parse(JSON.stringify(initialMcqsState)));
            
            initializeSetup();
            switchScreen('setup');
        });
        
        document.getElementById('download-report-btn').addEventListener('click', () => {
            reportOptionsModal.classList.remove('hidden');
            reportOptionsModal.classList.add('flex');
        });
        
        document.getElementById('cancel-report-download-btn').addEventListener('click', () => {
            reportOptionsModal.classList.add('hidden');
            reportOptionsModal.classList.remove('flex');
        });

        document.getElementById('download-with-explanations-btn').addEventListener('click', () => {
            reportOptionsModal.classList.add('hidden');
            reportOptionsModal.classList.remove('flex');
            downloadReport(true);
        });

        document.getElementById('download-without-explanations-btn').addEventListener('click', () => {
            reportOptionsModal.classList.add('hidden');
            reportOptionsModal.classList.remove('flex');
            downloadReport(false);
        });

        function renderMarkdownToPdf(doc, markdown, options) {
            let { x, y, maxWidth, pageHeight, margin, lineHeight, bulletIndent } = options;
            if (!markdown) return y;

            const checkPageBreak = (neededHeight) => {
                if (y + neededHeight > pageHeight - margin) {
                    doc.addPage();
                    y = margin;
                }
                return y;
            };

            const renderTextBlock = (textBlock) => {
                if (!textBlock.trim()) return;
                
                const blocks = textBlock.split(/\n\s*\n/);
                blocks.forEach(block => {
                    const trimmedBlock = block.trim();
                    if (!trimmedBlock) return;
                    
                    const lines = trimmedBlock.split('\n');
                
                    let isUnordered = lines.every(l => l.trim().startsWith('- ') || l.trim().startsWith('* '));
                    let isOrdered = lines.every(l => l.trim().match(/^\d+\.\s/));
                    
                    if(isUnordered) {
                        lines.forEach(line => {
                            const itemText = line.trim().substring(2);
                            const splitText = doc.splitTextToSize(itemText, maxWidth - bulletIndent);
                            y = checkPageBreak(splitText.length * lineHeight);
                            doc.text('â€¢', x, y, { baseline: 'top' });
                            doc.text(splitText, x + bulletIndent, y, { baseline: 'top' });
                            y += splitText.length * lineHeight;
                        });
                        y += lineHeight / 2;
                    } else if (isOrdered) {
                        lines.forEach(line => {
                            const number = line.trim().match(/^\d+\./)[0];
                            const itemText = line.trim().substring(number.length).trim();
                            const splitText = doc.splitTextToSize(itemText, maxWidth - doc.getTextWidth(number) - bulletIndent);
                            y = checkPageBreak(splitText.length * lineHeight);
                            doc.text(number, x, y, { baseline: 'top' });
                            doc.text(splitText, x + doc.getTextWidth(number) + bulletIndent - 2, y, { baseline: 'top' });
                            y += splitText.length * lineHeight;
                        });
                        y += lineHeight / 2;
                    } else { // Paragraph
                        lines.forEach(line => {
                            let isBold = line.startsWith('**') && line.endsWith('**') && line.length > 4;
                            let isItalic = line.startsWith('*') && line.endsWith('*') && line.length > 2;
                            
                            let processedLine = line;
                            if (isBold) {
                                processedLine = line.substring(2, line.length - 2);
                                doc.setFont('helvetica', 'bold');
                            } else if (isItalic) {
                                processedLine = line.substring(1, line.length - 1);
                                doc.setFont('helvetica', 'italic');
                            }

                            const splitText = doc.splitTextToSize(processedLine, maxWidth);
                            y = checkPageBreak(splitText.length * lineHeight);
                            doc.text(splitText, x, y, { baseline: 'top' });
                            y += splitText.length * lineHeight;

                            doc.setFont('helvetica', 'normal'); // Reset font
                        });
                        y += lineHeight / 2;
                    }
                });
            };

            const imageRegex = /({image\s+\d+})/g;
            const parts = markdown.split(imageRegex).filter(part => part);

            parts.forEach(part => {
                if (part.match(imageRegex)) {
                    const imageIndex = parseInt(part.match(/\d+/)[0], 10) - 1;
                    if (images[imageIndex]) {
                        try {
                            const imgData = images[imageIndex];
                            const fileType = imgData.substring(imgData.indexOf('/') + 1, imgData.indexOf(';'));
                            const imgProps = doc.getImageProperties(imgData);
                            const imgWidth = Math.min(maxWidth, imgProps.width);
                            const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

                            y = checkPageBreak(imgHeight + 5); 
                            doc.addImage(imgData, fileType.toUpperCase(), x, y, imgWidth, imgHeight);
                            y += imgHeight + 5;
                        } catch (e) {
                            console.error("Error adding image to PDF:", e);
                            const errorText = '[Error loading image]';
                            y = checkPageBreak(lineHeight);
                            doc.text(errorText, x, y, { baseline: 'top' });
                            y += lineHeight;
                        }
                    }
                } else {
                    renderTextBlock(part);
                }
            });

            return y;
        }

        async function downloadReport(includeExplanations) {
            const btn = document.getElementById('download-report-btn');
            btn.disabled = true;
            btn.textContent = 'Generating...';

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const analyticsContainer = document.querySelector('#results-screen > div');

                // --- Page 1: Analytics ---
                doc.setFontSize(22);
                doc.text('Exam Report', 105, 20, { align: 'center' });
                
                doc.setFontSize(11);
                doc.text('Subject: ' + (subjectName || 'N/A'), 15, 35);
                doc.text('Candidate: ' + (candidateName || 'N/A'), 15, 42);
                if (shortNote) {
                    const noteLines = doc.splitTextToSize('Notes: ' + shortNote, 180);
                    doc.text(noteLines, 15, 49);
                }
                doc.setFontSize(9);
                doc.setTextColor(150);
                doc.text('Generated on: ' + new Date().toLocaleString(), 105, 58, { align: 'center' });

                const canvas = await window.html2canvas(analyticsContainer, { scale: 2, windowWidth: analyticsContainer.scrollWidth, windowHeight: analyticsContainer.scrollHeight });
                const imgData = canvas.toDataURL('image/png');
                const imgProps = doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                doc.addImage(imgData, 'PNG', 10, 65, pdfWidth - 20, pdfHeight);

                // --- Subsequent Pages: Detailed Review ---
                doc.addPage();
                doc.setFontSize(18);
                doc.text('Detailed Answer Review', 105, 15, { align: 'center' });

                let y = 30;
                const margin = 15;
                const pageHeight = doc.internal.pageSize.getHeight();
                const maxWidth = pdfWidth - margin * 2;

                currentMcqs.forEach((mcq, index) => {
                    const answerState = answerStates.find(a => a.mcqId === mcq.id);
                    if (y > pageHeight - 40) { 
                        doc.addPage();
                        y = 20;
                    }

                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(12);
                    
                    const questionContent = (index + 1) + '. ' + mcq.question;
                    const imageRegex = /({image\s+\d+})/g;
                    const questionParts = questionContent.split(imageRegex).filter(part => part);

                    const checkPageBreakForQuestion = (neededHeight) => {
                        if (y + neededHeight > pageHeight - margin) {
                            doc.addPage();
                            y = 20;
                        }
                    };

                    questionParts.forEach(part => {
                        if (part.match(imageRegex)) {
                            const imageIndex = parseInt(part.match(/\d+/)[0], 10) - 1;
                            if (images[imageIndex]) {
                                try {
                                    const imgData = images[imageIndex];
                                    const fileType = imgData.substring(imgData.indexOf('/') + 1, imgData.indexOf(';'));
                                    const imgProps = doc.getImageProperties(imgData);
                                    const imgWidth = Math.min(maxWidth, imgProps.width);
                                    const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

                                    checkPageBreakForQuestion(imgHeight + 5);
                                    doc.addImage(imgData, fileType.toUpperCase(), margin, y, imgWidth, imgHeight);
                                    y += imgHeight + 5;
                                } catch (e) {
                                    console.error("Error adding image to PDF:", e);
                                    const errorText = '[Error loading image]';
                                    checkPageBreakForQuestion(7);
                                    doc.text(errorText, margin, y, { baseline: 'top' });
                                    y += 7;
                                }
                            }
                        } else {
                            const questionText = doc.splitTextToSize(part, maxWidth);
                            checkPageBreakForQuestion(questionText.length * 7);
                            doc.text(questionText, margin, y, { baseline: 'top' });
                            y += questionText.length * 7;
                        }
                    });
                    y += 3;


                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    Object.keys(mcq.options).forEach(key => {
                        const isCorrect = mcq.correctAnswer === key;
                        const isSelected = answerState.selectedOption === key;

                        if (isCorrect) doc.setTextColor(34, 139, 34);
                        else if (isSelected && !isCorrect) doc.setTextColor(220, 20, 60);
                        else doc.setTextColor(0, 0, 0);
                        
                        const optionString = '(' + key.toUpperCase() + ') ' + mcq.options[key];
                        const optionText = doc.splitTextToSize(optionString, maxWidth - 5);
                        doc.text(optionText, margin + 5, y, { baseline: 'top' });
                        y += optionText.length * 5;
                    });
                    y += 3;
                    
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(9);
                    const summaryText = 'Your Answer: ' + (answerState.selectedOption ? answerState.selectedOption.toUpperCase() : 'Not Answered') + ' | Correct Answer: ' + mcq.correctAnswer.toUpperCase();
                    doc.text(summaryText, margin, y, { baseline: 'top' });
                    y += 7;

                    if (includeExplanations && mcq.explanation) {
                        doc.setTextColor(55, 65, 81);
                        doc.setFont('helvetica', 'bold');
                        doc.setFontSize(10);
                        doc.text('Explanation:', margin, y, { baseline: 'top' });
                        y += 6;

                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(9);

                        const renderOptions = { x: margin, y: y, maxWidth: maxWidth, pageHeight: pageHeight, margin: margin, lineHeight: 4.5, bulletIndent: 4 };
                        y = renderMarkdownToPdf(doc, mcq.explanation, renderOptions);
                    }
                    
                    y += 4;

                    if (index < currentMcqs.length - 1) {
                        doc.setDrawColor(200, 200, 200);
                        doc.line(margin, y, pdfWidth - margin, y);
                        y += 7;
                    }
                });

                doc.save('exam_report.pdf');
            } catch (error) {
                console.error("Failed to generate report:", error);
                alert("Sorry, there was an error generating the report.");
            } finally {
                btn.disabled = false;
                btn.textContent = 'Download Report';
            }
        }
        
        function markdownToHtml(markdown) {
            if (!markdown) return '';

            let text = markdown
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');

            const blocks = text.split(/\n\s*\n/);
            
            return blocks.map(block => {
                const trimmedBlock = block.trim();
                if (!trimmedBlock) return '';

                const lines = trimmedBlock.split('\n');

                if (lines.every(line => line.trim().startsWith('- ') || line.trim().startsWith('* '))) {
                    const listItems = lines.map(line => '<li>' + line.trim().substring(2) + '</li>').join('');
                    return '<ul>' + listItems + '</ul>';
                }

                if (lines.every(line => line.trim().match(/^\d+\.\s/))) {
                    const listItems = lines.map(line => '<li>' + line.trim().replace(/^\d+\.\s/, '') + '</li>').join('');
                    return '<ol>' + listItems + '</ol>';
                }

                return '<p>' + lines.join('<br />') + '</p>';
            }).join('');
        }
        
        // --- PRACTICE MODE LOGIC ---
        document.getElementById('start-practice-btn').addEventListener('click', () => {
            setupErrorEl.textContent = '';
            subjectName = document.getElementById('subject-name').value;
            candidateName = document.getElementById('candidate-name').value;

            const savedPracticeDraft = localStorage.getItem(PRACTICE_DRAFT_KEY);

            if (savedPracticeDraft) {
                practiceResumeModal.classList.remove('hidden');
                practiceResumeModal.classList.add('flex');
            } else {
                startPractice(false); // false means don't load from draft
            }
        });

        document.getElementById('practice-resume-btn').addEventListener('click', () => {
            practiceResumeModal.classList.add('hidden');
            practiceResumeModal.classList.remove('flex');
            startPractice(true); // true means load from draft
        });

        document.getElementById('practice-start-new-btn').addEventListener('click', () => {
            practiceResumeModal.classList.add('hidden');
            practiceResumeModal.classList.remove('flex');
            clearPracticeDraft();
            startPractice(false);
        });

        function handleQuestionTimeout() {
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
            const mcq = currentMcqs[currentPracticeIndex];
            const practiceState = practiceStates.find(p => p.mcqId === mcq.id);

            if (practiceState.attempted) return;

            practiceState.attempted = true;
            practiceState.selectedOption = null; // Timed out, considered incorrect
            practiceState.timeTaken = timePerMcq;
            
            revealPracticeAnswer(null);
            savePracticeDraft();
        }

        // Streak UI Helper
        function updateStreakUI() {
            const streakBadge = document.getElementById('streak-badge');
            const streakCountEl = document.getElementById('streak-count');
            
            if (currentStreak > 0) {
                streakBadge.classList.remove('hidden');
                streakCountEl.textContent = currentStreak;
                
                // Animate
                streakBadge.classList.remove('active');
                void streakBadge.offsetWidth; // Trigger reflow
                streakBadge.classList.add('active');
                setTimeout(() => streakBadge.classList.remove('active'), 200);
            } else {
                streakBadge.classList.add('hidden');
            }
        }

        function startPractice(loadFromDraft = false) {
            if (practiceTimerInterval) clearInterval(practiceTimerInterval);
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
            
            if (loadFromDraft) {
                try {
                    const draft = JSON.parse(localStorage.getItem(PRACTICE_DRAFT_KEY));
                    currentMcqs.length = 0;
                    Array.prototype.push.apply(currentMcqs, draft.mcqs);
                    practiceStates = draft.practiceStates;
                    currentPracticeIndex = draft.currentPracticeIndex;
                    subjectName = draft.subjectName;
                    candidateName = draft.candidateName;
                    isShuffled = draft.isShuffled;
                    timePerMcq = draft.timePerMcq || 0;
                    timeOverall = draft.timeOverall || 0;
                    currentStreak = draft.currentStreak || 0;
                    
                    document.getElementById('subject-name').value = subjectName || '';
                    document.getElementById('candidate-name').value = candidateName || '';
                    document.getElementById('shuffle-mcqs-checkbox').checked = isShuffled;

                } catch (e) {
                    console.error("Failed to load practice draft:", e);
                    alert("The saved practice draft is corrupted. Starting a new session.");
                    clearPracticeDraft();
                    loadFromDraft = false; // Fallback to new session
                }
            }
            
            if (!loadFromDraft) {
                currentStreak = 0; // Reset streak
                isShuffled = document.getElementById('shuffle-mcqs-checkbox').checked;
                let baseMcqs = [...initialMcqsState];
                if (isShuffled) {
                    shuffleArray(baseMcqs);
                }

                const qCountSlider = document.getElementById('practice-q-count-slider');
                let qCount = parseInt(qCountSlider.value, 10);
                if (isNaN(qCount) || qCount <= 0 || qCount > baseMcqs.length) {
                    qCount = baseMcqs.length;
                }
                currentMcqs = baseMcqs.slice(0, qCount);
                
                practiceStates = currentMcqs.map(mcq => ({ mcqId: mcq.id, selectedOption: null, attempted: false, timeTaken: 0 }));
                currentPracticeIndex = 0;
                timePerMcq = parseInt(document.getElementById('practice-time-per-mcq').value, 10) || 0;
                timeOverall = parseInt(document.getElementById('practice-time-overall').value, 10) || 0;
            }

            document.getElementById('practice-subject-name').textContent = subjectName || 'Practice Mode';
            updateStreakUI();
            switchScreen('practice');
            renderPracticePalette(); // Added call to render palette
            renderPracticeQuestion();
            
            const practiceTimerEl = document.getElementById('practice-timer');
            if (timeOverall > 0) {
                practiceTimerEl.classList.remove('hidden');
                let timeLeft = timeOverall * 60;
                practiceTimerEl.textContent = formatTime(timeLeft);
                practiceTimerInterval = setInterval(() => {
                    timeLeft--;
                    practiceTimerEl.textContent = formatTime(timeLeft);
                    if (timeLeft <= 0) {
                        if(practiceTimerInterval) clearInterval(practiceTimerInterval);
                        if(perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
                        alert("Practice time is up!");
                        showPracticeResults();
                    }
                }, 1000);
            } else {
                practiceTimerEl.classList.add('hidden');
            }
        }

        function renderPracticeQuestion() {
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);

            const mcq = currentMcqs[currentPracticeIndex];
            const practiceState = practiceStates.find(p => p.mcqId === mcq.id);
            
            document.getElementById('practice-question-counter').textContent = 'Question ' + (currentPracticeIndex + 1) + ' of ' + currentMcqs.length;
            document.getElementById('practice-question-text').innerHTML = (currentPracticeIndex + 1) + '. ' + processQuestionContent(mcq.question, 'practice-question-image-container');

            // Update Palette Active State
            const allPaletteBtns = document.querySelectorAll('#practice-palette-grid button');
            allPaletteBtns.forEach(btn => btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500'));
            const currentBtn = document.getElementById('practice-palette-item-' + currentPracticeIndex);
            if (currentBtn) {
                currentBtn.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
                // Ensure the active button is visible in the scrollable container
                currentBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }

            const optionsContainer = document.getElementById('practice-options-container');
            optionsContainer.innerHTML = '';
            
            Object.keys(mcq.options).forEach(key => {
                const optionEl = document.createElement('div');
                optionEl.dataset.optionKey = key;
                optionEl.className = 'flex items-center p-4 rounded-lg border-2 transition-all themed-bg-tertiary themed-border-primary';
                optionEl.innerHTML = '<span class="flex-1">' + key.toUpperCase() + '. ' + mcq.options[key] + '</span>';
                optionsContainer.appendChild(optionEl);
            });
            
            // Hide previous results elements
            document.getElementById('practice-explanation-section').classList.add('hidden');
            document.getElementById('header-feedback-badge').classList.remove('visible');
            document.getElementById('header-feedback-badge').className = 'feedback-badge'; // Reset class

            if (practiceState.attempted) {
                revealPracticeAnswer(practiceState.selectedOption);
            } else {
                optionsContainer.classList.add('cursor-pointer');
                optionsContainer.querySelectorAll('[data-option-key]').forEach(el => el.classList.add('themed-bg-accent-hover'));
            }

            // Per-question timer logic
            const timerContainer = document.getElementById('per-question-timer-container');
            const timerBar = document.getElementById('per-question-timer-bar');
            if (timePerMcq > 0 && !practiceState.attempted) {
                timerContainer.classList.remove('hidden');
                timerBar.style.width = '100%';
                timerBar.classList.remove('bg-green-500');
                timerBar.classList.add('bg-green-500');

                const timerStart = Date.now();
                perQuestionTimerInterval = setInterval(() => {
                    const elapsed = (Date.now() - timerStart) / 1000;
                    if (elapsed >= timePerMcq) {
                        handleQuestionTimeout();
                        return;
                    }
                    const remainingPercent = ((timePerMcq - elapsed) / timePerMcq) * 100;
                    timerBar.style.width = remainingPercent + '%';

                    if (remainingPercent < 40) {
                        timerBar.classList.remove('bg-green-500');
                        timerBar.classList.add('bg-red-500');
                    }
                }, 100);
            } else {
                timerContainer.classList.add('hidden');
            }

            document.getElementById('practice-prev-btn').disabled = currentPracticeIndex === 0;
            document.getElementById('practice-next-btn').disabled = currentPracticeIndex === currentMcqs.length - 1;
            
            updatePracticeSaveButtonState();
            questionStartTime = Date.now();
        }

        function revealPracticeAnswer(selectedKey) {
            const mcq = currentMcqs[currentPracticeIndex];
            const optionsContainer = document.getElementById('practice-options-container');
            optionsContainer.classList.remove('cursor-pointer');
            
            // Check correctness
            const isCorrect = mcq.correctAnswer === selectedKey;
            
            // Update Palette Button Color for the answered question
            const paletteBtn = document.getElementById('practice-palette-item-' + currentPracticeIndex);
            if (paletteBtn) {
                // If selectedKey is null (timeout), it's incorrect (red)
                const paletteIsCorrect = selectedKey && (mcq.correctAnswer === selectedKey);
                paletteBtn.className = 'w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full text-white font-bold transition-all transform hover:scale-110 focus:outline-none ' + (paletteIsCorrect ? 'bg-green-600' : 'bg-red-600');
            }

            optionsContainer.querySelectorAll('[data-option-key]').forEach(el => {
                el.classList.remove('themed-bg-accent-hover');
                const key = el.dataset.optionKey;
                const isOptionCorrect = mcq.correctAnswer === key;
                const isSelected = selectedKey === key;

                el.classList.remove('themed-bg-tertiary', 'themed-border-primary');
                
                // SVG Icons
                const checkIcon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2 text-green-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>';
                const crossIcon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2 text-red-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>';

                if (isOptionCorrect) {
                    el.style.backgroundColor = 'var(--bg-success)';
                    el.style.borderColor = 'var(--bg-success-border)';
                    if (!el.innerHTML.includes('<svg')) el.innerHTML += checkIcon;
                    
                    if (isCorrect && isSelected) {
                        triggerConfetti(el.getBoundingClientRect());
                    }
                } else if (isSelected && !isOptionCorrect) {
                    el.style.backgroundColor = 'var(--bg-danger)';
                    el.style.borderColor = 'var(--bg-danger-border)';
                     if (!el.innerHTML.includes('<svg')) el.innerHTML += crossIcon;
                } else {
                    el.classList.add('opacity-60');
                }
            });
            
            // --- HEADER FEEDBACK ---
            const badge = document.getElementById('header-feedback-badge');
            const badgeText = document.getElementById('header-feedback-text');
            
            if (isCorrect) {
                badge.className = 'feedback-badge visible correct';
                badgeText.innerHTML = 'Excellent! ðŸŽ‰';
            } else {
                badge.className = 'feedback-badge visible incorrect';
                badgeText.innerHTML = 'Incorrect âŒ';
            }

            // --- EXPLANATION SECTION ---
            const explanationSection = document.getElementById('practice-explanation-section');
            const explanationContainer = document.getElementById('practice-explanation-container');
            
            if (mcq.explanation) {
                const cleanedExplanationText = processQuestionContent(mcq.explanation, 'practice-explanation-image-container');
                explanationContainer.innerHTML = markdownToHtml(cleanedExplanationText);
            } else {
                document.getElementById('practice-explanation-image-container').innerHTML = '';
                explanationContainer.innerHTML = '<p class="themed-text-tertiary">No explanation was provided for this question.</p>';
            }
            explanationSection.classList.remove('hidden');
        }

        document.getElementById('practice-options-container').addEventListener('click', (e) => {
            const optionEl = e.target.closest('[data-option-key]');
            if (!optionEl) return;

            const mcq = currentMcqs[currentPracticeIndex];
            const practiceState = practiceStates.find(p => p.mcqId === mcq.id);
            
            if (practiceState.attempted) return;
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);

            recordTime(mcq.id, practiceStates);
            
            const selectedKey = optionEl.dataset.optionKey;
            practiceState.attempted = true;
            practiceState.selectedOption = selectedKey;

            // STREAK LOGIC UPDATE
            if (selectedKey === mcq.correctAnswer) {
                currentStreak++;
            } else {
                currentStreak = 0;
            }
            updateStreakUI();

            revealPracticeAnswer(selectedKey);
            savePracticeDraft();
        });
        
        // ADDED: Function to render the practice palette
        function renderPracticePalette() {
            const paletteGrid = document.getElementById('practice-palette-grid');
            if (!paletteGrid) return;
            paletteGrid.innerHTML = '';

            currentMcqs.forEach((mcq, index) => {
                const btn = document.createElement('button');
                btn.id = 'practice-palette-item-' + index;
                btn.dataset.index = String(index);
                
                // Determine color based on state
                const pState = practiceStates.find(p => p.mcqId === mcq.id);
                let bgClass = 'bg-gray-400'; // Default gray
                if (pState && pState.attempted) {
                     const isCorrect = pState.selectedOption === mcq.correctAnswer;
                     bgClass = isCorrect ? 'bg-green-600' : 'bg-red-600';
                }

                btn.className = 'w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full text-white font-bold transition-all transform hover:scale-110 focus:outline-none ' + bgClass; 
                btn.textContent = String(index + 1);
                btn.setAttribute('aria-label', 'Go to question ' + (index + 1));
                
                btn.addEventListener('click', () => {
                    if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
                    // Record time for current before switching if not answered
                    const currentMcq = currentMcqs[currentPracticeIndex];
                    if(currentMcq) {
                         const currentState = practiceStates.find(p => p.mcqId === currentMcq.id);
                         if (!currentState.attempted) recordTime(currentMcq.id, practiceStates);
                    }
                    
                    currentPracticeIndex = parseInt(btn.dataset.index, 10);
                    renderPracticeQuestion();
                    savePracticeDraft();
                });
                paletteGrid.appendChild(btn);
            });
        }
        
        function navigatePractice(offset) {
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
            const mcq = currentMcqs[currentPracticeIndex];
            const practiceState = practiceStates.find(p => p.mcqId === mcq.id);
            if (!practiceState.attempted) {
                recordTime(mcq.id, practiceStates); // Record time even if unanswered
            }

            const newIndex = currentPracticeIndex + offset;
            if (newIndex >= 0 && newIndex < currentMcqs.length) {
                currentPracticeIndex = newIndex;
                renderPracticeQuestion();
                savePracticeDraft();
            }
        }

        document.getElementById('practice-prev-btn').addEventListener('click', () => navigatePractice(-1));
        document.getElementById('practice-next-btn').addEventListener('click', () => navigatePractice(1));

        document.getElementById('exit-practice-btn').addEventListener('click', () => {
            if (practiceTimerInterval) clearInterval(practiceTimerInterval);
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
            recordTime(currentMcqs[currentPracticeIndex].id, practiceStates);
            showPracticeResults();
        });

        // --- REVIEW LOGIC ---
        let reviewQuestionIndex = 0;
        
        function setupReviewScreen(isReviseMode = false, isSavedMode = false) {
            const backBtn = document.getElementById('back-to-results-btn');
            const exitBtn = document.getElementById('exit-revise-btn');
            isReviewingSaved = isSavedMode;

            if (isSavedMode) {
                reviewTitleEl.textContent = 'Saved Questions';
                backBtn.style.display = 'none';
                exitBtn.style.display = 'inline-block';
                document.getElementById('review-time-taken').style.display = 'none';
            } else if (isReviseMode) {
                reviewTitleEl.textContent = 'Revise Mode';
                backBtn.style.display = 'none';
                exitBtn.style.display = 'inline-block';
                document.getElementById('review-time-taken').style.display = 'none';
            } else {
                reviewTitleEl.textContent = 'Review Answers';
                backBtn.style.display = 'inline-block';
                exitBtn.style.display = 'none';
                document.getElementById('review-time-taken').style.display = 'flex';
                if (reviewReturnScreen === 'practiceResults') {
                    backBtn.textContent = 'Back to Practice Results';
                } else {
                    backBtn.textContent = 'Back to Exam Results';
                }
            }
            renderReviewPalette();
            renderReviewQuestion();
        }
        
        document.getElementById('review-answers-btn').addEventListener('click', () => {
            reviewQuestionIndex = 0;
            reviewReturnScreen = 'results';
            switchScreen('review');
            setupReviewScreen(false, false);
        });
        
        document.getElementById('exit-revise-btn').addEventListener('click', () => {
            switchScreen('setup');
        });

        document.getElementById('review-practice-answers-btn').addEventListener('click', () => {
            answerStates = currentMcqs.map(mcq => {
                const pState = practiceStates.find(p => p.mcqId === mcq.id);
                return { mcqId: mcq.id, selectedOption: pState ? pState.selectedOption : null, timeTaken: pState ? pState.timeTaken : 0 };
            });
            reviewQuestionIndex = 0;
            reviewReturnScreen = 'practiceResults';
            switchScreen('review');
            setupReviewScreen(false, false);
        });

        document.getElementById('back-to-results-btn').addEventListener('click', () => switchScreen(reviewReturnScreen));
        
        function renderReviewPalette() {
            const paletteGrid = document.getElementById('review-palette-grid');
            if (!paletteGrid) return;
            paletteGrid.innerHTML = '';

            currentMcqs.forEach((mcq, index) => {
                const answerState = answerStates.find(a => a.mcqId === mcq.id);
                const isCorrect = answerState && answerState.selectedOption === mcq.correctAnswer;
                const hasAnswered = answerState && answerState.selectedOption !== undefined && answerState.selectedOption !== null;
                
                let bgClass = 'bg-gray-400';
                if (hasAnswered) {
                    bgClass = isCorrect ? 'bg-green-600' : 'bg-red-600';
                }

                const btn = document.createElement('button');
                btn.id = 'review-palette-item-' + index;
                btn.dataset.index = String(index);
                btn.className = 'w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full text-white font-bold transition-all transform hover:scale-110 focus:outline-none ' + bgClass;
                btn.textContent = String(index + 1);
                // Accessibility: Dynamic aria label
                btn.setAttribute('aria-label', 'Review question ' + (index + 1));
                btn.addEventListener('click', () => {
                    reviewQuestionIndex = parseInt(btn.dataset.index, 10);
                    renderReviewQuestion();
                });
                paletteGrid.appendChild(btn);
            });
        }

        function renderReviewQuestion() {
            updateSaveButtonState();
            const allPaletteBtns = document.querySelectorAll('#review-palette-grid button');
            allPaletteBtns.forEach(btn => btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500'));
            const currentBtn = document.getElementById('review-palette-item-' + reviewQuestionIndex);
            if (currentBtn) {
                currentBtn.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
                currentBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }

            const mcq = currentMcqs[reviewQuestionIndex];
            const answerState = answerStates.find(a => a.mcqId === mcq.id);
            
            document.getElementById('review-question-text').innerHTML = (reviewQuestionIndex + 1) + '. ' + processQuestionContent(mcq.question, 'review-question-image-container');
            document.getElementById('review-question-counter').textContent = 'Question ' + (reviewQuestionIndex + 1) + ' of ' + currentMcqs.length;
            
            const timeTakenEl = document.getElementById('review-time-taken');
            if (answerState && answerState.timeTaken) {
                timeTakenEl.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg> Time Taken: <span class="font-semibold ml-1">' + formatTimeDetailed(answerState.timeTaken) + '</span>';
            } else {
                timeTakenEl.innerHTML = '';
            }

            const explanationContainer = document.getElementById('explanation-container');
            if (mcq.explanation) {
                const cleanedExplanationText = processQuestionContent(mcq.explanation, 'explanation-image-container');
                explanationContainer.innerHTML = markdownToHtml(cleanedExplanationText);
            } else {
                document.getElementById('explanation-image-container').innerHTML = '';
                explanationContainer.innerHTML = '<p class="themed-text-tertiary">No explanation was provided for this question.</p>';
            }
            
            const reviewOptionsContainer = document.getElementById('review-options-container');
            reviewOptionsContainer.innerHTML = '';
            Object.keys(mcq.options).forEach(key => {
                const isSelected = answerState && answerState.selectedOption === key;
                const isCorrect = mcq.correctAnswer === key;
                let style = 'background-color: var(--bg-tertiary); border-color: transparent;';
                let indicatorText = '';

                if (isCorrect) {
                    style = 'background-color: var(--bg-success); border-color: var(--bg-success-border);';
                    indicatorText = '<span class="ml-auto text-sm font-semibold themed-text-success">Correct Answer</span>';
                }
                
                if (isSelected && !isCorrect) {
                    style = 'background-color: var(--bg-danger); border-color: var(--bg-danger-border);';
                    indicatorText = '<span class="ml-auto text-sm font-semibold themed-text-danger">Your Answer</span>';
                } else if (isSelected && isCorrect) {
                     indicatorText = '<span class="ml-auto text-sm font-semibold themed-text-success">Your Answer (Correct)</span>';
                }
                
                reviewOptionsContainer.innerHTML +=
                    '<div class="flex items-center p-4 rounded-lg border-2" style="' + style + '">' +
                        '<span class="flex-1">' + key.toUpperCase() + '. ' + mcq.options[key] + '</span>' +
                        indicatorText +
                    '</div>';
            });
            
            document.getElementById('review-prev-btn').disabled = reviewQuestionIndex === 0;
            document.getElementById('review-next-btn').disabled = reviewQuestionIndex === currentMcqs.length - 1;
        }

        document.getElementById('review-prev-btn').addEventListener('click', () => {
            if(reviewQuestionIndex > 0) {
                reviewQuestionIndex--;
                renderReviewQuestion();
            }
        });

        document.getElementById('review-next-btn').addEventListener('click', () => {
            if(reviewQuestionIndex < currentMcqs.length - 1) {
                reviewQuestionIndex++;
                renderReviewQuestion();
            }
        });
        
        // --- SWIPE NAVIGATION LOGIC ---
        function setupSwipeNavigation(container) {
            let touchStartX = 0;
            let touchStartY = 0;
            const mainContent = container.querySelector('main');
            let isAnimating = false;

            container.addEventListener('touchstart', e => {
                if (isAnimating) return;
                
                // FIX: Prevent page swipe if user is trying to scroll the palette
                if (e.target.closest('.overflow-x-auto')) return;

                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            container.addEventListener('touchend', e => {
                if (isAnimating) return;
                const touchEndX = e.changedTouches[0].screenX;
                const touchEndY = e.changedTouches[0].screenY;
                const diffX = touchEndX - touchStartX;
                const diffY = touchEndY - touchStartY;

                if (Math.abs(diffX) > 50 && Math.abs(diffX) > Math.abs(diffY)) {
                    
                    const isNext = diffX < 0; // Swipe Left
                    
                    // FIX: Re-enabled swipe backward (swipe right)
                    // The line that prevented it was removed here.

                    isAnimating = true;
                    const outClass = isNext ? 'slide-out-left' : 'slide-out-right';
                    const inClass = isNext ? 'slide-in-from-right' : 'slide-in-from-left';
                    
                    const onAnimationOutEnd = () => {
                        mainContent.removeEventListener('animationend', onAnimationOutEnd);
                        mainContent.classList.remove(outClass);

                        // Perform navigation action
                        if (container.id === 'practice-screen') {
                            if (isNext) navigatePractice(1);
                            else navigatePractice(-1);
                        } else if (container.id === 'review-screen') {
                            if (isNext) document.getElementById('review-next-btn').click();
                            else document.getElementById('review-prev-btn').click();
                        }

                        mainContent.classList.add(inClass);
                        
                        const onAnimationInEnd = () => {
                            mainContent.removeEventListener('animationend', onAnimationInEnd);
                            mainContent.classList.remove(inClass);
                            isAnimating = false;
                        };
                        mainContent.addEventListener('animationend', onAnimationInEnd);
                    };

                    mainContent.addEventListener('animationend', onAnimationOutEnd);
                    mainContent.classList.add(outClass);
                }
            }, { passive: true });
        }

        setupSwipeNavigation(screens.practice);
        setupSwipeNavigation(screens.review);

        // --- PAST RESULTS LOGIC ---
        function showPastResultsList() {
            const historyJSON = localStorage.getItem(EXAM_RESULTS_HISTORY_KEY);
            const history = historyJSON ? JSON.parse(historyJSON) : [];
            const listEl = document.getElementById('past-results-list');
            listEl.innerHTML = '';

            if (history.length === 0) {
                listEl.innerHTML = '<p class="text-center themed-text-tertiary">No past results found.</p>';
            } else {
                history.forEach((result, index) => {
                    const date = new Date(result.timestamp).toLocaleString();
                    const scoreColor = result.overallScore >= 50 ? 'themed-text-success' : 'themed-text-danger';
                    const item = document.createElement('button');
                    item.className = 'w-full text-left p-4 rounded-lg border flex justify-between items-center transition-colors themed-bg-primary themed-border-primary hover:bg-[var(--bg-tertiary)]';
                    item.dataset.resultIndex = index;
                    item.innerHTML = 
                        '<div>' +
                            '<p class="font-bold themed-text-primary">' + (result.subjectName || 'Untitled Exam') + '</p>' +
                            '<p class="text-sm themed-text-secondary">' + date + '</p>' +
                        '</div>' +
                        '<div class="text-right">' +
                            '<p class="text-xl font-bold ' + scoreColor + '">' + result.overallScore + '%</p>' +
                            '<p class="text-xs themed-text-tertiary">Click to view details</p>' +
                        '</div>';
                    listEl.appendChild(item);
                });
            }
            switchScreen('pastResults');
        }
        
        document.getElementById('past-results-list').addEventListener('click', (e) => {
            const target = e.target.closest('[data-result-index]');
            if (target) {
                const index = parseInt(target.dataset.resultIndex, 10);
                const historyJSON = localStorage.getItem(EXAM_RESULTS_HISTORY_KEY);
                const history = historyJSON ? JSON.parse(historyJSON) : [];
                const resultData = history[index];
                if (resultData) {
                    loadResultIntoView(resultData);
                }
            }
        });

        function loadResultIntoView(resultData) {
            document.getElementById('exam-details').innerHTML = resultData.detailsHtml;
            document.getElementById('overall-performance').innerHTML = resultData.performanceHtml;
            document.getElementById('section-analysis').innerHTML = resultData.analysisHtml;
            
            // Set state for the "Review Answers" button for this specific result
            answerStates = resultData.answerStates;
            currentMcqs = resultData.currentMcqs;
            subjectName = resultData.subjectName;
            candidateName = resultData.candidateName;
            shortNote = resultData.shortNote;
            isShuffled = resultData.isShuffled;
            
            switchScreen('results');
        }
        
        document.getElementById('back-to-setup-from-history-btn').addEventListener('click', () => switchScreen('setup'));

        // --- PROGRESS CHARTS RENDERING ---
        function renderProgressCharts() {
            const examHistoryJSON = localStorage.getItem(EXAM_RESULTS_HISTORY_KEY);
            const examHistory = examHistoryJSON ? JSON.parse(examHistoryJSON) : [];
            
            const practiceHistoryJSON = localStorage.getItem(PRACTICE_RESULTS_HISTORY_KEY);
            const practiceHistory = practiceHistoryJSON ? JSON.parse(practiceHistoryJSON) : [];

            // --- KPI DASHBOARD STATS ---
            // Combine scores for calculation? No, separate is better. Let's show Exam stats primarily.
            const examScores = examHistory.map(h => parseFloat(h.overallScore || 0));
            const totalExams = examHistory.length;
            const avgScore = totalExams > 0 ? (examScores.reduce((a,b)=>a+b, 0) / totalExams).toFixed(1) : '0';
            const maxScore = totalExams > 0 ? Math.max(...examScores).toFixed(1) : '0';
            
            // Total Practice Questions Solved
            const totalPracticeQs = practiceHistory.reduce((acc, curr) => acc + (curr.attempted || 0), 0);

            const kpiDashboard = document.getElementById('kpi-dashboard');
            kpiDashboard.innerHTML = ''; // Clear previous

            const kpis = [
                { label: 'Avg Exam Score', value: avgScore + '%', color: 'text-blue-500' },
                { label: 'Highest Score', value: maxScore + '%', color: 'text-green-500' },
                { label: 'Total Attempts', value: totalExams, color: 'text-purple-500' },
                { label: 'Practice Qs', value: totalPracticeQs, color: 'text-orange-500' }
            ];

            kpis.forEach(kpi => {
                const card = document.createElement('div');
                card.className = 'stat-card themed-bg-primary themed-border-primary';
                card.innerHTML = `
                    <span class="stat-value ${kpi.color}">${kpi.value}</span>
                    <span class="stat-label">${kpi.label}</span>
                `;
                kpiDashboard.appendChild(card);
            });


            // Helper to create bars
            const createBar = (score, labelText, tooltipTitle, subtitle, index, prevScore) => {
                const scoreNum = parseFloat(score);
                const isSuccess = scoreNum >= 50;
                const barClass = isSuccess ? 'bar-success' : 'bar-danger';
                
                const barContainer = document.createElement('div');
                barContainer.className = 'chart-bar-container';
                
                const bar = document.createElement('div');
                bar.className = 'chart-bar ' + barClass;
                bar.style.height = Math.max(scoreNum, 5) + '%'; 
                // Staggered Animation Delay
                bar.style.animationDelay = (index * 0.1) + 's';
                
                // Text inside bar
                const barText = document.createElement('span');
                barText.className = 'chart-bar-text';
                barText.textContent = scoreNum.toFixed(1) + '%';
                if (scoreNum < 15) barText.style.display = 'none';
                bar.appendChild(barText);
                
                const label = document.createElement('div');
                label.className = 'chart-bar-label';
                label.textContent = labelText;
                
                // Trend Indicator
                let trendHtml = '';
                if (prevScore !== null) {
                    const diff = scoreNum - prevScore;
                    if (diff > 0) trendHtml = '<span class="text-green-400 ml-2 text-xs">â–² +' + diff.toFixed(1) + '%</span>';
                    else if (diff < 0) trendHtml = '<span class="text-red-400 ml-2 text-xs">â–¼ ' + diff.toFixed(1) + '%</span>';
                    else trendHtml = '<span class="text-gray-400 ml-2 text-xs">- 0%</span>';
                }

                const tooltip = document.createElement('div');
                tooltip.className = 'chart-bar-tooltip';
                tooltip.innerHTML = '<strong>' + tooltipTitle + '</strong>' + trendHtml + '<br/>' + subtitle;
                
                barContainer.appendChild(tooltip);
                barContainer.appendChild(bar);
                barContainer.appendChild(label);
                
                return barContainer;
            };

            // 1. Render Exam Chart
            const examContainer = document.getElementById('exam-chart-container');
            const examEmpty = document.getElementById('exam-chart-empty');
            
            examContainer.innerHTML = '';
            if (examHistory.length === 0) {
                examEmpty.classList.remove('hidden');
            } else {
                examEmpty.classList.add('hidden');
                // Process in chronological order for trends, but show recent last? 
                // Actually history is stored newest first. Let's reverse to show chronological left-to-right.
                const reversedHistory = [...examHistory].reverse();
                
                reversedHistory.forEach((result, i) => {
                    let correct = 0, total = 0;
                    if (result.answerStates && result.currentMcqs) {
                        result.answerStates.forEach(state => {
                            const mcq = result.currentMcqs.find(m => m.id === state.mcqId);
                            if(mcq) {
                                total++;
                                if (state.selectedOption === mcq.correctAnswer) correct++;
                            }
                        });
                    }
                    
                    const date = new Date(result.timestamp).toLocaleDateString(undefined, {month: 'short', day: 'numeric'});
                    const subject = (result.subjectName || 'Exam').substring(0, 15);
                    
                    // Previous score for trend
                    const prevScore = i > 0 ? parseFloat(reversedHistory[i-1].overallScore) : null;

                    const bar = createBar(
                        result.overallScore, 
                        date, 
                        subject, 
                        'Score: ' + result.overallScore + '%<br>Marks: ' + correct + ' / ' + total,
                        i,
                        prevScore
                    );
                    examContainer.appendChild(bar);
                });
            }

            // 2. Render Practice Chart
            const practiceContainer = document.getElementById('practice-chart-container');
            const practiceEmpty = document.getElementById('practice-chart-empty');
            
            practiceContainer.innerHTML = '';
            if (practiceHistory.length === 0) {
                practiceEmpty.classList.remove('hidden');
            } else {
                practiceEmpty.classList.add('hidden');
                const reversedHistory = [...practiceHistory].reverse();
                
                reversedHistory.forEach((result, i) => {
                    const date = new Date(result.timestamp).toLocaleDateString(undefined, {month: 'short', day: 'numeric'});
                    const subject = (result.subjectName || 'Practice').substring(0, 15);
                    const prevScore = i > 0 ? parseFloat(reversedHistory[i-1].score) : null;

                    const bar = createBar(
                        result.score, 
                        date, 
                        subject, 
                        'Score: ' + result.score + '%<br>Marks: ' + result.correct + ' / ' + result.attempted,
                        i,
                        prevScore
                    );
                    practiceContainer.appendChild(bar);
                });
            }
        }

        document.getElementById('reset-practice-history-btn').addEventListener('click', () => {
            showConfirmation("Are you sure you want to clear all practice history? This cannot be undone.", () => {
                localStorage.removeItem(PRACTICE_RESULTS_HISTORY_KEY);
                renderProgressCharts();
            });
        });
        
        function showPracticeResults() {
            if (practiceTimerInterval) clearInterval(practiceTimerInterval);
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
            clearPracticeDraft();
            
            const detailsHtml =
                '<p><span class="font-bold">Subject:</span> ' + (subjectName || 'N/A') + '</p>' +
                '<p><span class="font-bold">Candidate:</span> ' + (candidateName || 'N/A') + '</p>';
            document.getElementById('practice-exam-details').innerHTML = detailsHtml;

            let correct = 0, incorrect = 0, attempted = 0;
            practiceStates.forEach(state => {
                if (state.attempted) {
                    attempted++;
                    const mcq = currentMcqs.find(m => m.id === state.mcqId);
                    if (mcq && state.selectedOption === mcq.correctAnswer) {
                        correct++;
                    } else {
                        incorrect++;
                    }
                }
            });
            
            const score = attempted > 0 ? (correct / attempted * 100) : 0;
            const scoreColorClass = score >= 50 ? 'themed-text-success' : 'themed-text-danger';
            
            document.getElementById('practice-score').className = 'text-5xl font-bold my-4 ' + scoreColorClass;
            document.getElementById('practice-score').textContent = score.toFixed(2) + '%';
            
            document.getElementById('practice-correct').innerHTML = '<span class="font-bold themed-text-success">' + correct + '</span> Correct';
            document.getElementById('practice-incorrect').innerHTML = '<span class="font-bold themed-text-danger">' + incorrect + '</span> Incorrect';
            document.getElementById('practice-attempted').innerHTML = '<span class="font-bold themed-text-secondary">' + attempted + '</span> Attempted';
            
            const attemptedStates = practiceStates.filter(s => s.timeTaken > 0);
            const totalTimeSpent = attemptedStates.reduce((acc, s) => acc + s.timeTaken, 0);
            const avgTime = attemptedStates.length > 0 ? totalTimeSpent / attemptedStates.length : 0;
            document.getElementById('practice-avg-time').innerHTML = 'Average time per question: <span class="font-semibold">' + formatTimeDetailed(avgTime) + '</span>';

            // SAVE PRACTICE RESULT
            const historyJSON = localStorage.getItem(PRACTICE_RESULTS_HISTORY_KEY);
            let history = historyJSON ? JSON.parse(historyJSON) : [];
            const resultData = {
                timestamp: new Date().toISOString(),
                score: score.toFixed(2),
                correct,
                incorrect,
                attempted,
                subjectName
            };
            history.unshift(resultData);
            localStorage.setItem(PRACTICE_RESULTS_HISTORY_KEY, JSON.stringify(history));

            switchScreen('practiceResults');
        }

        document.getElementById('restart-practice-btn').addEventListener('click', () => {
            clearPracticeDraft();
            startPractice(false);
        });
        
        document.getElementById('back-to-setup-btn').addEventListener('click', () => switchScreen('setup'));
        document.getElementById('back-to-setup-from-progress-btn').addEventListener('click', () => switchScreen('setup'));

        // --- INITIALIZE APP ---
        const savedExamDraft = localStorage.getItem(EXAM_DRAFT_KEY);
        if (savedExamDraft) {
            const resumeBanner = document.getElementById('resume-banner');
            resumeBanner.classList.remove('hidden');

            document.getElementById('resume-session-btn').addEventListener('click', () => {
                try {
                    const draft = JSON.parse(savedExamDraft);
                    
                    currentMcqs.length = 0;
                    Array.prototype.push.apply(currentMcqs, draft.mcqs);
                    sections = draft.sections;
                    answerStates = draft.answerStates;
                    currentSectionIndex = draft.currentSectionIndex;
                    currentQuestionIndexInSection = draft.currentQuestionIndexInSection;
                    subjectName = draft.subjectName;
                    candidateName = draft.candidateName;
                    shortNote = draft.shortNote;
                    isShuffled = draft.isShuffled;

                    document.getElementById('subject-name').value = subjectName || '';
                    document.getElementById('candidate-name').value = candidateName || '';
                    document.getElementById('short-note').value = shortNote || '';
                    document.getElementById('shuffle-mcqs-checkbox').checked = isShuffled;
                    
                    renderSections();
                    loadSection();
                    switchScreen('exam');

                } catch (e) {
                    console.error("Failed to load exam draft:", e);
                    alert("The saved exam draft appears to be corrupted and could not be loaded.");
                    clearExamDraft();
                    resumeBanner.classList.add('hidden');
                }
            });

            document.getElementById('discard-draft-btn').addEventListener('click', () => {
                clearExamDraft();
                resumeBanner.classList.add('hidden');
            });
        }
        
        const savedMcqsData = localStorage.getItem(SAVED_MCQS_KEY);
        if (savedMcqsData) {
            try {
                savedMcqIds = JSON.parse(savedMcqsData);
            } catch (e) {
                console.error("Could not parse saved MCQs", e);
                savedMcqIds = [];
            }
        }
        updateSavedQuestionsUI();
        
        const savedResultsData = localStorage.getItem(EXAM_RESULTS_HISTORY_KEY);
        if (savedResultsData) {
            const history = JSON.parse(savedResultsData);
            if(history.length > 0) {
                const pastResultsContainer = document.getElementById('past-results-container');
                const pastResultsCount = document.getElementById('past-results-count');
                pastResultsContainer.classList.remove('hidden');
                pastResultsCount.textContent = history.length;
            }
        }

        document.getElementById('view-past-results-btn').addEventListener('click', showPastResultsList);

        saveMcqBtn.addEventListener('click', toggleSaveMcq);
        saveMcqPracticeBtn.addEventListener('click', toggleSavePracticeMcq);
        
        if (toggleSparklesBtn) {
            toggleSparklesBtn.addEventListener('click', () => {
                isSparklesEnabled = !isSparklesEnabled;
                const svg = toggleSparklesBtn.querySelector('svg');
                if (isSparklesEnabled) {
                    svg.classList.remove('themed-text-secondary');
                    svg.classList.add('text-yellow-500');
                    svg.setAttribute('fill', 'currentColor');
                    showToast("Sparkles On âœ¨");
                } else {
                    svg.classList.add('themed-text-secondary');
                    svg.classList.remove('text-yellow-500');
                    svg.setAttribute('fill', 'none');
                    showToast("Sparkles Off");
                }
            });
        }

        viewSavedBtn.addEventListener('click', () => {
            if (savedMcqIds.length === 0) {
                alert("You have no saved questions.");
                return;
            }
            currentMcqs = initialMcqsState.filter(mcq => savedMcqIds.includes(mcq.id));
            answerStates = currentMcqs.map(mcq => ({
                mcqId: mcq.id,
                status: QuestionStatus.NotVisited,
                selectedOption: undefined,
                timeTaken: 0
            }));
            reviewQuestionIndex = 0;
            switchScreen('review');
            setupReviewScreen(true, true);
        });

        if (mcqs.length > 0) {
            currentMcqs = [...mcqs];
            initializeSetup();
        } else {
            switchScreen('setup');
            document.getElementById('setup-error').textContent = "No questions were loaded. Please generate a new file.";
            document.getElementById('start-exam-btn').disabled = true;
            document.getElementById('add-section-btn').disabled = true;
        }
      } catch (error) {
          console.error("Fatal error during exam initialization:", error);
          document.body.innerHTML =
              '<div style="padding: 2rem; text-align: center; font-family: sans-serif; color: #333;">' +
                  '<h1 style="color: #d9534f; font-size: 2rem;">An Unexpected Error Occurred</h1>' +
                  '<p style="margin-top: 1rem;">The exam file could not be loaded. This is likely due to an internal script error.</p>' +
                  '<p style="margin-top: 0.5rem;">Please try generating the exam file again from the main application.</p>' +
                  '<div style="margin-top: 2rem; padding: 1rem; background-color: #f7f7f7; border: 1px solid #ddd; text-align: left; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; font-size: 0.8rem; max-width: 800px; margin-left: auto; margin-right: auto;">' +
                      '<h3 style="margin-bottom: 0.5rem; font-weight: bold;">Error Details:</h3>' +
                      error.message +
                  '</div>' +
              '</div>';
      }
    });

</script>
<script>
    // --- DISABLE BROWSER BACK/FORWARD ---
    // This script prevents the user from using the browser back button or swipe gestures
    // to leave the page or navigate history, keeping them in the exam app.
    history.pushState(null, document.title, location.href);
    window.addEventListener('popstate', function (event) {
        history.pushState(null, document.title, location.href);
    });
</script>
</body>
</html>
    
