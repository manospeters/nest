
<!DOCTYPE html>
<html lang="en">
<head>
    <script>
    // --- SECURITY CHECK ---
    // If the token is missing, they accessed this file directly (cheating)
    if (!sessionStorage.getItem('portalToken')) {
        // Replace 'index.html' with the actual name of your main login page
        window.location.href = 'index.html'; 
    }

    // Disable Right Click on Exam Page too
    document.addEventListener('contextmenu', event => event.preventDefault());
    
    // Disable Selection
    document.addEventListener('selectstart', event => event.preventDefault());
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MCQ Exam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root, [data-theme="light"] {
            --bg-primary: #f9fafb; /* gray-50 */
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6; /* gray-100 */
            --bg-accent: #e5e7eb; /* gray-200 */
            --bg-accent-hover: #d1d5db; /* gray-300 */
            --bg-info: #eff6ff; /* blue-50 */
            --bg-info-border: #bfdbfe; /* blue-200 */
            --bg-success: #f0fdf4; /* green-50 */
            --bg-success-border: #bbf7d0; /* green-200 */
            --bg-danger: #fef2f2; /* red-50 */
            --bg-danger-border: #fecaca; /* red-200 */
            --bg-warning: #fffbeb; /* yellow-50 */
            --bg-warning-border: #fde68a; /* yellow-200 */
            --bg-code: #e5e7eb;
            --text-primary: #1f2937; /* gray-800 */
            --text-secondary: #4b5563; /* gray-600 */
            --text-tertiary: #6b7280; /* gray-500 */
            --text-accent: #3b82f6; /* blue-600 */
            --text-accent-hover: #2563eb; /* blue-700 */
            --text-inverted: #ffffff;
            --text-info: #1e40af; /* blue-800 */
            --text-success: #15803d; /* green-700 */
            --text-danger: #b91c1c; /* red-700 */
            --text-warning: #92400e; /* yellow-800 */
            --border-primary: #e5e7eb; /* gray-200 */
            --border-secondary: #d1d5db; /* gray-300 */
            --border-accent: #3b82f6;
            --shadow-color: rgba(0,0,0,0.1);
            --swipe-duration: 0.3s; /* Default Smooth */
            --font-explanation: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }

        [data-theme="dark"] {
            --bg-primary: #111827; /* gray-900 */
            --bg-secondary: #1f2937; /* gray-800 */
            --bg-tertiary: #374151; /* gray-700 */
            --bg-accent: #4b5563; /* gray-600 */
            --bg-accent-hover: #525c6a;
            --bg-info: #1e293b; 
            --bg-info-border: #334155;
            --bg-success: #064e3b; /* green-900 */
            --bg-success-border: #065f46;
            --bg-danger: #7f1d1d; /* red-900 */
            --bg-danger-border: #991b1b;
            --bg-warning: #451a03;
            --bg-warning-border: #78350f;
            --bg-code: #374151;
            --text-primary: #f3f4f6; /* near-white, AAA */
            --text-secondary: #d1d5db; /* gray-300, AAA */
            --text-tertiary: #9ca3af; /* gray-400 */
            --text-accent: #60a5fa; /* blue-400 */
            --text-accent-hover: #93c5fd; /* blue-300 */
            --text-inverted: #1f2937;
            --text-info: #bfdbfe;
            --text-success: #86efac; /* green-300 */
            --text-danger: #fca5a5; /* red-300 */
            --text-warning: #fcd34d;
            --border-primary: #374151; /* gray-700 */
            --border-secondary: #4b5563; /* gray-600 */
            --border-accent: #60a5fa;
            --shadow-color: rgba(0,0,0,0.4);
            --font-explanation: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }

        [data-theme="ambient"] {
            --bg-primary: #fdf6e3; /* cream */
            --bg-secondary: #f6efd8;
            --bg-tertiary: #eee8d5;
            --bg-accent: #dcd4c1;
            --bg-accent-hover: #c9c1ae;
            --bg-info: #e0f2f1; 
            --bg-info-border: #b2dfdb;
            --bg-success: #e8f5e9;
            --bg-success-border: #c8e6c9;
            --bg-danger: #ffebee;
            --bg-danger-border: #ffcdd2;
            --bg-warning: #fff3e0;
            --bg-warning-border: #ffe0b2;
            --bg-code: #eee8d5;
            --text-primary: #433e3f; /* dark brown */
            --text-secondary: #586e75;
            --text-tertiary: #657b83;
            --text-accent: #cb4b16; /* warm orange */
            --text-accent-hover: #d35400;
            --text-inverted: #fdf6e3;
            --text-info: #00695c;
            --text-success: #2e7d32;
            --text-danger: #c62828;
            --text-warning: #e65100;
            --border-primary: #dcd4c1;
            --border-secondary: #c9c1ae;
            --border-accent: #cb4b16;
            --shadow-color: rgba(67, 62, 63, 0.1);
            --font-explanation: 'Georgia', 'Cambria', 'Times New Roman', serif;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            /* Disable Selection and Touch Callouts */
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10 and IE 11 */
            user-select: none; /* Standard syntax */
            -webkit-touch-callout: none; /* iOS Safari */
        }
        
        /* Re-enable selection for inputs */
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        /* View Transitions for Theme Switch */
        ::view-transition-old(root),
        ::view-transition-new(root) {
            animation: none;
            mix-blend-mode: normal;
        }
        ::view-transition-old(root) { z-index: 1; }
        ::view-transition-new(root) { z-index: 9999; }

        .screen { display: none; }
        .screen.active { display: flex; }
        .option-label { transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out; }
        .prose strong { font-weight: 700; color: var(--text-primary); }
        .prose em { color: var(--text-primary); font-style: italic; }
        .prose br { content: ""; display: block; margin-bottom: 0.5rem; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .prose p { margin-bottom: 1rem; }
        .calculator-btn { padding: 1rem 0; font-size: 1.25rem; border-radius: 0.5rem; transition: background-color 0.2s, transform 0.1s, filter 0.1s; text-align: center; }
        .key-press-feedback { transform: scale(0.95); filter: brightness(0.85); }
        .calculator-modal.dragging { opacity: 0.7; border: 2px dashed var(--border-accent); }
        
        /* Custom Radio Button for Exam Mode */
        .radio-circle::after {
            content: '';
            display: block;
            width: 1rem; /* 16px */
            height: 1rem; /* 16px */
            border-radius: 50%;
            background-color: var(--border-accent);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.2s ease-in-out;
        }
        .option-label.selected .radio-circle::after {
            transform: translate(-50%, -50%) scale(1);
        }
        
        /* Themed Components */
        .themed-bg-primary { background-color: var(--bg-primary); }
        .themed-bg-secondary { background-color: var(--bg-secondary); }
        .themed-bg-tertiary { background-color: var(--bg-tertiary); }
        .themed-bg-accent { background-color: var(--bg-accent); }
        .themed-bg-accent-hover:hover { background-color: var(--bg-accent-hover); }

        .themed-text-primary { color: var(--text-primary); }
        .themed-text-secondary { color: var(--text-secondary); }
        .themed-text-tertiary { color: var(--text-tertiary); }
        .themed-text-accent { color: var(--text-accent); }
        .themed-text-inverted { color: var(--text-inverted); }
        .themed-text-success { color: var(--text-success); }
        .themed-text-danger { color: var(--text-danger); }
        .themed-text-warning { color: var(--text-warning); }

        .themed-border-primary { border-color: var(--border-primary); }
        .themed-border-secondary { border-color: var(--border-secondary); }
        .themed-border-accent { border-color: var(--border-accent); }
        
        .themed-shadow { box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -2px var(--shadow-color); }
        
        /* Component specific overrides */
        #setup-screen .bg-white, #results-screen .bg-white, #review-screen .bg-white, #practice-screen .bg-white, #practice-results-screen .bg-white, #past-results-screen .bg-white, #progress-screen .bg-white, .modal-card, #calculator-modal {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        header { background-color: var(--bg-secondary); }
        main, footer { background-color: var(--bg-tertiary); }
        footer { box-shadow: 0 -2px 5px var(--shadow-color); }
        input, textarea { background-color: var(--bg-secondary); border-color: var(--border-secondary); color: var(--text-primary); }
        input:focus, textarea:focus { --tw-ring-color: var(--text-accent); border-color: var(--text-accent); }
        #timer, #practice-timer { background-color: var(--bg-accent); }
        .option-label { background-color: var(--bg-tertiary); position: relative; overflow: hidden; }
        .option-label.selected { background-color: var(--bg-info); border-color: var(--border-accent); }
        .option-label:hover { background-color: var(--bg-accent); }
        #question-palette { background-color: var(--bg-secondary); }
        #hide-palette-btn, #show-palette-btn { background-color: var(--bg-secondary); color: var(--text-secondary); border-color: var(--border-primary); }
        
        /* Improved Explanation Typography and Styles */
        .explanation-card {
            background-color: var(--bg-secondary);
            border-top: 4px solid var(--text-accent);
            border-radius: 0.75rem;
            margin-top: 2rem;
            animation: fade-in-up 0.4s ease-out;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            position: relative; /* For toolbar anchor */
        }
        .explanation-header {
            padding: 1rem 1.5rem;
            font-weight: 700;
            color: var(--text-accent);
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-primary);
            font-size: 1.1rem;
        }
        .explanation-content {
            padding: 1.5rem 2rem;
            color: var(--text-primary);
            font-size: 1.05rem;
            line-height: 1.8;
            font-family: var(--font-explanation);
            user-select: text; /* Allow selection in explanation */
        }

        /* Feedback Header Badge */
        .feedback-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 0.875rem;
            margin-left: 1rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease-out;
        }
        .feedback-badge.visible { opacity: 1; transform: translateY(0); }
        .feedback-badge.correct { background-color: var(--bg-success); color: var(--text-success); border: 1px solid var(--bg-success-border); }
        .feedback-badge.incorrect { background-color: var(--bg-danger); color: var(--text-danger); border: 1px solid var(--bg-danger-border); }

        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Streak Badge */
        .streak-badge {
            display: flex;
            align-items: center;
            background: rgba(245, 158, 11, 0.1); /* amber-500 with opacity */
            color: #d97706; /* amber-600 */
            padding: 0.25rem 0.75rem;
            border-radius: 99px;
            font-weight: 700;
            font-size: 0.85rem;
            border: 1px solid rgba(245, 158, 11, 0.3);
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .streak-badge.active {
            transform: scale(1.1);
            background: rgba(245, 158, 11, 0.25);
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.2);
        }
        
        /* Swipe Animations */
        @keyframes slide-out-left { to { transform: translateX(-100%); opacity: 0; } }
        @keyframes slide-in-from-right { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slide-out-right { to { transform: translateX(100%); opacity: 0; } }
        @keyframes slide-in-from-left { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .slide-out-left { animation: slide-out-left var(--swipe-duration) ease-out forwards; }
        .slide-in-from-right { animation: slide-in-from-right var(--swipe-duration) ease-out forwards; }
        .slide-out-right { animation: slide-out-right var(--swipe-duration) ease-out forwards; }
        .slide-in-from-left { animation: slide-in-from-left var(--swipe-duration) ease-out forwards; }
        
        /* Toast Notification */
        @keyframes fade-in-out {
            0% { transform: translateY(100%); opacity: 0; }
            10% { transform: translateY(0); opacity: 1; }
            90% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(100%); opacity: 0; }
        }
        #toast-notification {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            background-color: #333;
            color: white;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            z-index: 100;
            visibility: hidden;
            opacity: 0;
        }
        #toast-notification.show {
            visibility: visible;
            bottom: 2rem;
            animation: fade-in-out 3s ease-in-out forwards;
        }

        /* Save Button Animation */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.25); }
            100% { transform: scale(1); }
        }
        .pop-animation {
            animation: pop 0.3s ease-out;
        }
        
        /* CHART CSS */
        .chart-wrapper {
            display: flex;
            align-items: flex-end;
            justify-content: flex-start;
            gap: 16px;
            height: 300px;
            width: 100%;
            overflow-x: auto;
            padding: 20px 10px 40px 10px;
            border-bottom: 2px solid var(--border-primary);
            border-left: 2px solid var(--border-primary);
            background: linear-gradient(to bottom, var(--bg-primary), var(--bg-secondary));
            border-radius: 12px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.02);
        }
        .chart-bar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            justify-content: flex-end;
            flex-shrink: 0;
            width: 50px;
            position: relative;
            transition: transform 0.2s;
        }
        .chart-bar-container:hover {
            transform: translateY(-5px);
            z-index: 10;
        }
        
        @keyframes grow-up {
            from { height: 0; opacity: 0; }
            to { opacity: 1; }
        }
        
        .chart-bar {
            width: 100%;
            border-radius: 6px 6px 0 0;
            position: relative;
            min-height: 24px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 5px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: grow-up 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            opacity: 0; /* Start invisible for animation */
        }
        
        /* Interference/Gradient Effects */
        .bar-success {
            background: linear-gradient(180deg, #4ade80 0%, #16a34a 100%);
            border: 1px solid #15803d;
        }
        .bar-danger {
            background: linear-gradient(180deg, #f87171 0%, #dc2626 100%);
            border: 1px solid #b91c1c;
        }
        
        /* Text inside bar */
        .chart-bar-text {
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            white-space: nowrap;
            margin-bottom: 5px;
        }
        
        .chart-bar-label {
            font-size: 11px;
            margin-top: 10px;
            color: var(--text-secondary);
            transform: rotate(-45deg);
            white-space: nowrap;
            text-align: right;
            width: 100%;
            transform-origin: top center;
            text-overflow: ellipsis;
            overflow: hidden;
        }
        .chart-bar-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: rgba(17, 24, 39, 0.95);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 20;
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }
        .chart-bar-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: rgba(17, 24, 39, 0.95) transparent transparent transparent;
        }
        .chart-bar-container:hover .chart-bar-tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(-12px);
        }
        
        /* STAT CARDS */
        .stat-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-value { font-size: 1.5rem; font-weight: 800; color: var(--text-primary); }
        .stat-label { font-size: 0.75rem; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; }

        /* DYNAMIC ISLAND */
        #dynamic-island {
            position: fixed;
            z-index: 9999;
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(16px);
            border-radius: 20px;
            padding: 6px;
            gap: 8px;
            display: flex;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            transition: width 0.5s, height 0.5s, top 0.5s, left 0.5s, right 0.5s, bottom 0.5s, border-radius 0.5s, opacity 0.4s ease;
            cursor: grab;
            border: 1px solid rgba(255,255,255,0.15);
        }
        #dynamic-island:active { cursor: grabbing; }
        
        #dynamic-island.dragging { transition: none !important; }
        
        @keyframes hint-move {
            0% { transform: translateY(0); }
            25% { transform: translateY(5px); }
            50% { transform: translateY(-5px); }
            75% { transform: translateY(5px); }
            100% { transform: translateY(0); }
        }
        .hint-anim { animation: hint-move 0.6s ease-in-out; box-shadow: 0 0 25px rgba(255,255,255,0.5) !important; }
        
        #dynamic-island.idle { opacity: 0.3; }
        #dynamic-island.idle:hover { opacity: 1; }
        
        #dynamic-island.horizontal { flex-direction: row; height: auto; align-items: center; }
        #dynamic-island.vertical { flex-direction: column; width: auto; align-items: center; }

        .island-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: background 0.2s, transform 0.2s;
            cursor: pointer;
        }
        .island-btn:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
        .island-btn:active { transform: scale(0.95); }
        .island-btn svg { width: 18px; height: 18px; }
        
        .island-mini-btn {
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            padding: 0;
            padding-bottom: 2px;
        }
        .island-mini-btn:hover { background: rgba(255, 255, 255, 0.2); color: white; }

        .island-separator { background: rgba(255,255,255,0.2); border-radius: 99px; }
        #dynamic-island.horizontal .island-separator { width: 1px; height: 20px; }
        #dynamic-island.vertical .island-separator { width: 20px; height: 1px; }

        #dynamic-island.minimized {
            padding: 0;
            gap: 0;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            cursor: pointer;
            justify-content: center;
            opacity: 1 !important; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        [data-theme="light"] #dynamic-island.minimized,
        [data-theme="ambient"] #dynamic-island.minimized {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        #dynamic-island.minimized > * { display: none !important; }

        #dynamic-island.minimized.horizontal { width: 40px; height: 6px; border-radius: 10px; }
        #dynamic-island.minimized.vertical { width: 6px; height: 40px; border-radius: 10px; }

    </style>
    <script>
        // Immediately apply theme from localStorage to prevent FOUC
        (function() {
            try {
                const examId = 'exam_1764510536988_wv9g0b8';
                const THEME_KEY = 'examTheme_' + examId;
                const savedTheme = localStorage.getItem(THEME_KEY);
                if (savedTheme) {
                    document.documentElement.dataset.theme = savedTheme;
                }
            } catch (e) {
                console.error('Could not apply saved theme.', e);
            }
        })();
    </script>
</head>
<body class="">
    
    <!-- DYNAMIC ISLAND: Left Side Center Default -->
    <div id="dynamic-island" class="vertical" style="top: 50%; left: 20px; transform: translateY(-50%);">
        <button id="island-minimize-btn" class="island-mini-btn" aria-label="Minimize Island" title="Minimize">&minus;</button>
        
        <div class="island-separator"></div>
        <button id="island-home-btn" class="island-btn" aria-label="Go Home">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
        </button>

        <div class="island-separator"></div>
        <button id="island-progress-btn" class="island-btn" aria-label="View Progress">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
        </button>
        <div class="island-separator"></div>
        <button id="island-theme-btn" class="island-btn" aria-label="Toggle Theme">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
            </svg>
        </button>
        <div class="island-separator"></div>
        <button id="island-settings-btn" class="island-btn" aria-label="Swipe Settings">
             <svg id="swipe-icon-smooth" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
            <svg id="swipe-icon-hard" class="hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
        </button>
    </div>

    <div id="toast-notification"></div>
    <main id="app-container" class="h-screen w-screen relative">
        <!-- SCREEN 1: SECTION SETUP -->
        <div id="setup-screen" class="screen active flex-col justify-center items-center p-4">
            <div id="resume-banner" class="hidden w-full max-w-5xl bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg shadow-lg mb-6" role="alert">
                <div class="flex">
                    <div class="py-1"><svg class="fill-current h-6 w-6 text-yellow-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-5.414V8a1 1 0 112 0v4.586a1 1 0 11-2 0zM10 6a1 1 0 100-2 1 1 0 000 2z"/></svg></div>
                    <div>
                        <p class="font-bold">Saved Exam Session Found!</p>
                        <p class="text-sm">You have a saved exam in progress. What would you like to do?</p>
                        <div class="mt-3">
                            <button id="resume-session-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded" aria-label="Resume previous session">Resume Session</button>
                            <button id="discard-draft-btn" class="ml-4 text-sm text-yellow-800 hover:underline" aria-label="Discard draft and start new">Discard and Start New</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="w-full max-w-5xl bg-white p-8 rounded-lg shadow-lg themed-bg-secondary themed-shadow">
                <p class="text-xs text-center mb-4 themed-text-tertiary">Read instructions before start</p>
                <h1 class="text-3xl font-bold mb-2 text-center themed-text-accent">Pediatrics</h1>
                <h2 class="text-xl font-semibold mb-6 text-center themed-text-secondary">Exam Setup</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- Left Panel: Exam Configuration -->
                    <div class="md:col-span-2 space-y-6">
                        <div>
                            <p class="mb-4 themed-text-secondary">Total Questions Found: 50. Configure your exam sections below.</p>
                            
                            <div class="space-y-4 mb-6">
                                <div>
                                    <label for="subject-name" class="block text-sm font-medium themed-text-secondary">Subject Name</label>
                                    <input type="text" id="subject-name" value="Pediatrics" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="candidate-name" class="block text-sm font-medium themed-text-secondary">Candidate Name</label>
                                    <input type="text" id="candidate-name" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="short-note" class="block text-sm font-medium themed-text-secondary">Short Note (Optional)</label>
                                    <textarea id="short-note" rows="2" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Any notes for this test..."></textarea>
                                </div>
                            </div>

                            <div class="flex items-center mb-6">
                                <input type="checkbox" id="shuffle-mcqs-checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="shuffle-mcqs-checkbox" class="ml-2 block text-sm font-medium themed-text-secondary">Shuffle Questions</label>
                            </div>

                            <hr class="my-6 themed-border-primary">
                            
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold themed-text-primary">Exam Sections</h2>
                                <button id="auto-set-sections-btn" class="px-3 py-1 rounded-full text-xs font-semibold border border-blue-500 text-blue-500 hover:bg-blue-50 transition-colors" title="Split into 50-question sections (1 min/q)">Auto Set</button>
                            </div>
                            <div id="sections-container" class="space-y-4 max-h-48 overflow-y-auto pr-2">
                                <!-- Sections will be injected here by JS -->
                            </div>

                            <div class="mt-4 flex justify-between items-center">
                                <button id="add-section-btn" class="py-2 px-4 rounded themed-bg-accent themed-bg-accent-hover" aria-label="Add a new section">Add Section</button>
                            </div>
                        </div>

                        <div class="mt-6 text-center">
                            <button id="start-exam-btn" class="py-3 px-8 rounded-lg font-bold text-lg w-full md:w-auto" style="background-color: var(--text-accent); color: var(--text-inverted);" aria-label="Start the exam">Start Exam</button>
                            <p id="setup-error" class="mt-4 themed-text-danger text-center h-5"></p>
                        </div>
                    </div>

                    <!-- Right Panel: Alternative Modes -->
                    <div class="md:col-span-1 p-6 rounded-lg border themed-bg-primary themed-border-primary">
                        <h2 class="text-xl font-semibold mb-6 text-center themed-text-primary">Alternative Modes</h2>
                        <div class="space-y-4">
                            <div class="p-4 rounded-lg border" style="background-color: var(--bg-warning); border-color: var(--bg-warning-border);">
                                <h3 class="font-semibold text-lg text-center mb-3 themed-text-warning">Practice Mode</h3>
                                <div class="space-y-4 text-sm">
                                     <div>
                                        <label for="practice-q-count-slider" class="block font-medium themed-text-secondary">Number of Questions: <span id="practice-q-count-label">50</span></label>
                                        <input type="range" id="practice-q-count-slider" min="1" max="50" value="50" class="mt-1 block w-full cursor-pointer">
                                    </div>
                                    <div>
                                        <label for="practice-time-overall" class="block font-medium themed-text-secondary">Overall Time Limit (minutes)</label>
                                        <input type="number" id="practice-time-overall" class="mt-1 block w-full p-2 border rounded-md shadow-sm" placeholder="Optional: e.g., 60">
                                    </div>
                                    <div>
                                        <label for="practice-time-per-mcq" class="block font-medium themed-text-secondary">Time per MCQ (seconds)</label>
                                        <input type="number" id="practice-time-per-mcq" class="mt-1 block w-full p-2 border rounded-md shadow-sm" placeholder="Optional: e.g., 30">
                                    </div>
                                </div>
                                <button id="start-practice-btn" class="mt-4 py-3 px-6 rounded-lg font-bold w-full" style="background-color: var(--text-warning); color: var(--bg-primary);" aria-label="Start Practice Mode">Start Practice</button>
                                <p class="text-xs mt-2 text-center themed-text-tertiary">Get instant feedback with streaks & gamification.</p>
                            </div>
                            <div class="text-center">
                                <button id="revise-btn" class="py-3 px-6 rounded-lg font-bold w-full" style="background-color: #8b5cf6; color: white;" aria-label="Start Revise Mode">Revise Test</button>
                                <p class="text-xs mt-2 themed-text-tertiary">Freely browse all questions, answers, and explanations.</p>
                            </div>
                             <div id="saved-questions-container" class="text-center hidden">
                                 <button id="view-saved-btn" class="py-3 px-6 rounded-lg font-bold w-full relative" style="background-color: #4f46e5; color: white;" aria-label="View Saved Questions">
                                     Saved Questions
                                     <span id="saved-questions-count" class="absolute top-0 right-0 -mt-2 -mr-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                                 </button>
                                 <p class="text-xs mt-2 themed-text-tertiary">Review questions you've bookmarked.</p>
                            </div>
                            <div id="past-results-container" class="text-center hidden">
                                <button id="view-past-results-btn" class="py-3 px-6 rounded-lg font-bold w-full relative" style="background-color: #0d9488; color: white;" aria-label="View Past Results">
                                    View Past Results
                                    <span id="past-results-count" class="absolute top-0 right-0 -mt-2 -mr-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                                 </button>
                                 <p class="text-xs mt-2 themed-text-tertiary">Review your past exam performances.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCREEN 2: EXAM -->
        <div id="exam-screen" class="screen h-full relative">
            <!-- Main Content -->
            <div class="flex-1 flex flex-col">
                <header class="p-3 shadow-md flex justify-between items-center themed-bg-secondary themed-shadow">
                    <div class="flex items-center space-x-4">
                        <div>
                            <h1 id="section-name" class="text-xl font-bold themed-text-accent"></h1>
                            <p id="question-counter" class="text-sm themed-text-tertiary"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-xs font-bold themed-text-tertiary">created by mano</span>
                        <button id="calculator-toggle-btn" class="p-2 rounded-full themed-bg-accent-hover" aria-label="Toggle Calculator">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 themed-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                           </svg>
                        </button>
                        <div id="timer" class="text-xl font-mono px-4 py-1 rounded themed-bg-accent themed-text-primary" aria-label="Timer"></div>
                    </div>
                </header>

                <main class="flex-1 p-6 overflow-y-auto themed-bg-tertiary">
                    <div class="p-6 rounded-lg themed-bg-secondary">
                        <p id="question-text" class="text-lg font-semibold mb-6 whitespace-pre-wrap"></p>
                        <div id="question-image-container" class="my-4 flex justify-center"></div>
                        <div id="options-container" class="space-y-4"></div>
                    </div>
                </main>
                
                <footer class="p-4 themed-bg-secondary" style="box-shadow: 0 -2px 5px var(--shadow-color);">
                    <div class="flex justify-between items-center">
                        <div>
                            <button id="mark-review-btn" class="py-2 px-4 rounded text-white bg-purple-600 hover:bg-purple-700" aria-label="Mark for Review and Next">Mark for Review & Next</button>
                            <button id="clear-response-btn" class="py-2 px-4 rounded ml-4 themed-bg-accent themed-bg-accent-hover" aria-label="Clear Selected Response">Clear Response</button>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button id="prev-btn" class="py-2 px-6 rounded disabled:opacity-50 themed-bg-accent themed-bg-accent-hover" aria-label="Previous Question">Previous</button>
                            <button id="save-next-btn" class="py-2 px-6 rounded font-bold" style="background-color: #16a34a; color: white;" aria-label="Save Answer and Next Question">Save & Next</button>
                        </div>
                    </div>
                </footer>
            </div>

            <!-- Side Palette -->
            <aside id="question-palette" class="w-64 flex-shrink-0 relative transition-all duration-300 ease-in-out themed-bg-secondary">
                <div id="palette-content-wrapper" class="p-4 flex flex-col h-full w-full overflow-hidden transition-opacity duration-300">
                    <h2 class="text-lg font-bold mb-4 text-center">Question Palette</h2>
                    <div id="palette-container" class="grid grid-cols-5 gap-2 flex-1 overflow-y-auto"></div>
                     <div class="mt-4 text-xs space-y-2 themed-text-secondary">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center"><div class="w-4 h-4 rounded bg-green-600 mr-2"></div> Answered</div>
                            <span id="answered-count" class="font-bold px-1.5 py-0.5 rounded-full text-[10px] themed-bg-accent themed-text-primary">0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center"><div class="w-4 h-4 rounded bg-red-600 mr-2"></div> Not Answered</div>
                            <span id="not-answered-count" class="font-bold px-1.5 py-0.5 rounded-full text-[10px] themed-bg-accent themed-text-primary">0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center"><div class="w-4 h-4 rounded bg-gray-500 mr-2"></div> Not Visited</div>
                            <span id="not-visited-count" class="font-bold px-1.5 py-0.5 rounded-full text-[10px] themed-bg-accent themed-text-primary">0</span>
                        </div>
                         <div class="flex items-center justify-between">
                            <div class="flex items-center"><div class="w-4 h-4 rounded bg-purple-600 mr-2 relative"><svg xmlns="http://www.w3.org/2000/svg" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 h-2.5 w-2.5 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z" /></svg></div> Marked for Review</div>
                            <span id="marked-for-review-count" class="font-bold px-1.5 py-0.5 rounded-full text-[10px] themed-bg-accent themed-text-primary">0</span>
                        </div>
                    </div>
                </div>
                <button id="hide-palette-btn" class="absolute top-1/2 -left-3 z-10 p-1 rounded-full shadow-md border -translate-y-1/2" aria-label="Hide Question Palette">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                </button>
            </aside>

            <!-- Show Palette Button -->
            <button id="show-palette-btn" class="hidden absolute top-1/2 right-4 z-10 p-2 rounded-full shadow-lg border -translate-y-1/2" aria-label="Show Question Palette">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
            </button>
        </div>

        <!-- SCREEN 3: RESULTS -->
        <div id="results-screen" class="screen flex-col items-center justify-center p-8">
            <div class="w-full max-w-4xl p-8 rounded-lg shadow-lg themed-bg-secondary themed-shadow">
                <h1 class="text-4xl font-bold mb-4 text-center themed-text-accent">Exam Results</h1>
                <div id="exam-details" class="text-sm themed-text-secondary mb-6 border-b pb-4 space-y-1 themed-border-primary"></div>
                <div id="overall-performance" class="p-6 rounded-lg mb-8 text-center themed-bg-primary"></div>
                <h2 class="text-2xl font-semibold mb-4 text-center">Section-wise Analysis</h2>
                <div id="section-analysis" class="space-y-4"></div>
                <div class="mt-8 flex justify-center gap-4">
                    <button id="review-answers-btn" class="py-3 px-8 text-white rounded font-bold" style="background-color: var(--text-accent);" aria-label="Review Answers">Review Answers</button>
                    <button id="download-report-btn" class="py-3 px-8 text-white rounded font-bold" style="background-color: var(--text-success); color: var(--text-inverted);" aria-label="Download Report">Download Report</button>
                    <button id="restart-btn" class="py-3 px-8 rounded font-bold themed-bg-accent themed-text-primary" aria-label="Start New Exam">New Exam</button>
                </div>
            </div>
        </div>
        
        <!-- SCREEN 4: REVIEW -->
        <div id="review-screen" class="screen h-full flex-col">
          <header class="p-3 shadow-md flex justify-between items-center w-full themed-bg-secondary">
              <h1 id="review-title" class="text-xl font-bold themed-text-accent">Review Mode</h1>
               <div class="flex items-center space-x-4">
                    <button id="save-mcq-btn" class="p-2 rounded-full themed-bg-accent-hover" aria-label="Save Question">
                        <!-- SVG will be injected here -->
                    </button>
                    <button id="exit-revise-btn" class="py-2 px-4 rounded themed-bg-accent themed-bg-accent-hover hidden" aria-label="Exit Revise Mode">Exit Revise</button>
                    <button id="back-to-results-btn" class="py-2 px-4 rounded themed-bg-accent themed-bg-accent-hover" aria-label="Back to Results">Back to Results</button>
                </div>
          </header>
          <div id="review-palette-container" class="w-full max-w-4xl mx-auto p-4 border-b overflow-x-auto themed-bg-primary themed-border-primary">
             <div id="review-palette-grid" class="flex flex-nowrap gap-3 justify-start">
                 <!-- Review palette buttons will be injected here -->
             </div>
          </div>
          <main class="flex-1 p-6 overflow-y-auto w-full max-w-4xl mx-auto">
              <div class="p-6 rounded-lg themed-bg-secondary">
                  <div class="flex justify-between items-center">
                    <p id="review-question-text" class="text-lg font-semibold mb-6 whitespace-pre-wrap flex-1"></p>
                    <div id="review-time-taken" class="text-sm flex items-center ml-4 flex-shrink-0 themed-text-secondary"></div>
                  </div>
                  <div id="review-question-image-container" class="my-4 flex justify-center"></div>
                  <div id="review-options-container" class="space-y-4"></div>
                  
                  <!-- EXPLANATION SECTION -->
                  <div class="explanation-card" id="review-explanation-card">
                       <div class="explanation-header">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Explanation
                       </div>

                      <div id="explanation-image-container" class="my-4 flex justify-center"></div>
                      <div id="explanation-container" class="explanation-content prose max-w-none">
                          <!-- Explanation text will go here -->
                      </div>
                  </div>
              </div>
          </main>
          <footer class="p-4 shadow-inner flex justify-between items-center w-full themed-bg-secondary" style="box-shadow: 0 -2px 5px var(--shadow-color);">
              <button id="review-prev-btn" class="py-2 px-6 rounded disabled:opacity-50 themed-bg-accent themed-bg-accent-hover" aria-label="Previous Question">Previous</button>
              <span id="review-question-counter" class="font-bold"></span>
              <button id="review-next-btn" class="py-2 px-6 rounded disabled:opacity-50 themed-bg-accent themed-bg-accent-hover" aria-label="Next Question">Next</button>
          </footer>
        </div>
        
        <!-- SCREEN 5: PRACTICE MODE -->
        <div id="practice-screen" class="screen h-full flex-col relative">
            <header class="p-3 shadow-md flex justify-between items-center w-full themed-bg-secondary">
                <div class="flex items-center space-x-4">
                    <div>
                        <h1 class="text-xl font-bold themed-text-warning">Practice Mode</h1>
                        <p id="practice-subject-name" class="text-sm themed-text-tertiary"></p>
                    </div>
                </div>
                
                <!-- STREAK COUNTER & FEEDBACK -->
                <div id="practice-streak-container" class="flex-1 flex justify-center items-center">
                    <div id="streak-badge" class="streak-badge hidden">
                        <span class="mr-1">ðŸ”¥</span> Streak: <span id="streak-count" class="ml-1">0</span>
                    </div>
                    <!-- Header Feedback Badge -->
                    <div id="header-feedback-badge" class="feedback-badge">
                         <span id="header-feedback-text"></span>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <button id="save-mcq-practice-btn" class="p-2 rounded-full themed-bg-accent-hover" aria-label="Save Question">
                        <!-- SVG will be injected here -->
                    </button>
                    <button id="toggle-sparkles-btn" class="p-2 rounded-full themed-bg-accent-hover" aria-label="Toggle Sparkles">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                       </svg>
                    </button>
                    <button id="practice-calculator-toggle-btn" class="p-2 rounded-full themed-bg-accent-hover" aria-label="Toggle Calculator">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 themed-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                       </svg>
                    </button>
                    <div id="practice-timer" class="text-xl font-mono px-4 py-1 rounded hidden themed-bg-accent themed-text-primary" aria-label="Practice Timer"></div>
                    <button id="exit-practice-btn" class="py-2 px-4 rounded themed-bg-accent themed-bg-accent-hover" aria-label="Exit Practice Mode">Exit Practice</button>
                </div>
            </header>
            
            <div id="practice-palette-container" class="w-full max-w-4xl mx-auto p-4 border-b overflow-x-auto themed-bg-primary themed-border-primary">
                 <div id="practice-palette-grid" class="flex flex-nowrap gap-3 justify-start">
                     <!-- Practice palette buttons injected by JS -->
                 </div>
            </div>

            <div id="per-question-timer-container" class="w-full h-2 themed-bg-accent hidden">
                <div id="per-question-timer-bar" class="h-full bg-green-500" style="transition: width 150ms linear;"></div>
            </div>
            <main class="flex-1 p-6 overflow-y-auto w-full max-w-4xl mx-auto">
                <div class="p-6 rounded-lg themed-bg-secondary">
                    <p id="practice-question-text" class="text-lg font-semibold mb-6 whitespace-pre-wrap"></p>
                    <div id="practice-question-image-container" class="my-4 flex justify-center"></div>
                    <div id="practice-options-container" class="space-y-4"></div>
                    
                    <!-- EXPLANATION SECTION -->
                    <div id="practice-explanation-section" class="hidden explanation-card">
                        <div class="explanation-header">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Explanation
                        </div>
                        
                        <div id="practice-explanation-image-container" class="my-4 flex justify-center"></div>
                        <div id="practice-explanation-container" class="explanation-content prose max-w-none">
                            <!-- Explanation text will go here -->
                        </div>
                    </div>
                </div>
            </main>
            <footer class="p-4 shadow-inner flex justify-between items-center w-full themed-bg-secondary" style="box-shadow: 0 -2px 5px var(--shadow-color);">
                <button id="practice-prev-btn" class="py-2 px-6 rounded disabled:opacity-50 themed-bg-accent themed-bg-accent-hover" aria-label="Previous Question">Previous</button>
                <span id="practice-question-counter" class="font-bold"></span>
                <button id="practice-next-btn" class="py-2 px-6 rounded disabled:opacity-50 themed-bg-accent themed-bg-accent-hover" aria-label="Next Question">Next</button>
            </footer>
        </div>

        <!-- SCREEN 6: PRACTICE RESULTS -->
        <div id="practice-results-screen" class="screen flex-col items-center justify-center p-8">
            <div class="w-full max-w-2xl p-8 rounded-lg shadow-lg text-center themed-bg-secondary themed-shadow">
                <h1 class="text-4xl font-bold mb-4 themed-text-warning">Practice Results</h1>
                <div id="practice-exam-details" class="text-sm themed-text-secondary mb-6 border-b pb-4 space-y-1 themed-border-primary"></div>
                
                <div class="p-6 rounded-lg mb-8 themed-bg-primary">
                    <h2 class="text-2xl font-semibold">Your Performance</h2>
                    <p id="practice-score" class="text-5xl font-bold my-4"></p>
                    <div class="flex justify-center space-x-8 text-lg">
                        <span id="practice-correct"></span>
                        <span id="practice-incorrect"></span>
                        <span id="practice-attempted"></span>
                    </div>
                     <div id="practice-avg-time" class="mt-4 themed-text-secondary"></div>
                </div>
                
                <div class="mt-8 flex justify-center gap-4">
                    <button id="review-practice-answers-btn" class="py-3 px-8 rounded font-bold" style="background-color: var(--text-accent); color: var(--text-inverted);" aria-label="Review Practice Answers">Review Answers</button>
                    <button id="restart-practice-btn" class="py-3 px-8 rounded font-bold" style="background-color: var(--text-warning); color: var(--bg-primary);" aria-label="Restart Practice">Restart Practice</button>
                    <button id="back-to-setup-btn" class="py-3 px-8 rounded font-bold themed-bg-accent themed-text-primary" aria-label="Back to Setup">Back to Setup</button>
                </div>
            </div>
        </div>

        <!-- SCREEN 7: PAST RESULTS HISTORY -->
        <div id="past-results-screen" class="screen flex-col items-center justify-center p-8">
            <div class="w-full max-w-3xl p-8 rounded-lg shadow-lg themed-bg-secondary themed-shadow">
                <h1 class="text-3xl font-bold mb-6 text-center themed-text-accent">Past Exam Results</h1>
                <div id="past-results-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                    <!-- Past results will be injected here -->
                </div>
                <div class="mt-8 flex justify-center">
                    <button id="back-to-setup-from-history-btn" class="py-3 px-8 rounded font-bold themed-bg-accent themed-text-primary" aria-label="Back to Setup">Back to Setup</button>
                </div>
            </div>
        </div>

        <!-- SCREEN 8: PROGRESS ANALYTICS (CHARTS) -->
        <div id="progress-screen" class="screen flex-col items-center justify-center p-8">
            <div class="w-full max-w-5xl p-8 rounded-lg shadow-lg themed-bg-secondary themed-shadow overflow-y-auto max-h-full">
                <h1 class="text-3xl font-bold mb-6 text-center themed-text-accent">Performance Analytics</h1>
                
                <!-- KPI Dashboard (Inserted) -->
                <div id="kpi-dashboard" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <!-- Cards injected by JS -->
                </div>

                <!-- Exam Progress -->
                <div class="mb-8">
                    <h2 class="text-xl font-bold mb-4 themed-text-primary flex items-center">
                        <svg class="w-5 h-5 mr-2 themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        Exam History
                    </h2>
                    <div id="exam-chart-container" class="chart-wrapper">
                        <!-- Exam bars injected here -->
                    </div>
                    <p id="exam-chart-empty" class="text-sm themed-text-tertiary mt-2 text-center hidden">No exam attempts recorded yet.</p>
                </div>

                <!-- Practice Progress -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold themed-text-warning flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            Practice History
                        </h2>
                        <button id="reset-practice-history-btn" class="text-xs py-1 px-3 rounded border border-red-300 text-red-500 hover:bg-red-50">Reset Practice History</button>
                    </div>
                    <div id="practice-chart-container" class="chart-wrapper">
                        <!-- Practice bars injected here -->
                    </div>
                    <p id="practice-chart-empty" class="text-sm themed-text-tertiary mt-2 text-center hidden">No practice sessions recorded yet.</p>
                </div>

                <div class="flex justify-center">
                    <button id="back-to-setup-from-progress-btn" class="py-3 px-8 rounded font-bold themed-bg-accent themed-text-primary" aria-label="Back to Setup">Back to Setup</button>
                </div>
            </div>
        </div>


        <!-- MODAL: CONFIRMATION -->
        <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
            <div class="p-8 rounded-lg shadow-xl max-w-sm w-full text-center modal-card">
                <h2 class="text-xl font-bold mb-4">Confirm Action</h2>
                <p id="confirmation-message" class="mb-6 themed-text-secondary"></p>
                <div class="flex justify-center gap-4">
                    <button id="cancel-confirmation-btn" class="py-2 px-6 rounded font-semibold themed-bg-accent themed-bg-accent-hover" aria-label="Cancel Action">Cancel</button>
                    <button id="confirm-action-btn" class="py-2 px-6 rounded font-semibold text-white" style="background-color: var(--text-danger); color: var(--text-inverted);" aria-label="Confirm Action">Proceed</button>
                </div>
            </div>
        </div>

        <!-- MODAL: REPORT OPTIONS -->
        <div id="report-options-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
            <div class="p-8 rounded-lg shadow-xl max-w-sm w-full text-center modal-card">
                <h2 class="text-xl font-bold mb-4">Download Report</h2>
                <p class="mb-6 themed-text-secondary">Would you like to include the explanations in your PDF report?</p>
                <div class="flex flex-col gap-4">
                    <button id="download-with-explanations-btn" class="py-2 px-6 rounded font-semibold" style="background-color: var(--text-success); color: var(--text-inverted);" aria-label="Download with explanations">With Explanations</button>
                    <button id="download-without-explanations-btn" class="py-2 px-6 rounded font-semibold" style="background-color: var(--text-accent); color: var(--text-inverted);" aria-label="Download without explanations">Without Explanations</button>
                    <button id="cancel-report-download-btn" class="py-2 px-6 rounded font-semibold mt-2 themed-bg-accent themed-bg-accent-hover" aria-label="Cancel Download">Cancel</button>
                </div>
            </div>
        </div>

        <!-- MODAL: PRACTICE RESUME -->
        <div id="practice-resume-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
            <div class="p-8 rounded-lg shadow-xl max-w-sm w-full text-center modal-card">
                <h2 class="text-xl font-bold mb-4">Resume Practice</h2>
                <p class="mb-6 themed-text-secondary">You have a saved practice session. Would you like to continue where you left off?</p>
                <div class="flex justify-center gap-4">
                    <button id="practice-start-new-btn" class="py-2 px-6 rounded font-semibold themed-bg-accent themed-bg-accent-hover" aria-label="Start new practice">Start New</button>
                    <button id="practice-resume-btn" class="py-2 px-6 rounded font-semibold text-white bg-yellow-500 hover:bg-yellow-600" aria-label="Resume practice">Resume</button>
                </div>
            </div>
        </div>
        
        <!-- CALCULATOR MODAL -->
        <div id="calculator-modal" class="calculator-modal absolute w-64 rounded-lg shadow-2xl z-50 hidden">
            <div id="calculator-header" class="p-2 flex justify-between items-center rounded-t-lg cursor-move themed-bg-accent">
                <span class="font-bold themed-text-secondary">Calculator</span>
                <button id="calculator-close-btn" class="text-xl themed-text-secondary hover:themed-text-primary" aria-label="Close Calculator">&times;</button>
            </div>
            <div class="p-4">
                <div id="calculator-display" class="text-right text-3xl font-mono p-2 rounded mb-4 overflow-x-auto themed-bg-tertiary" aria-label="Calculator Display">0</div>
                <div id="calculator-buttons" class="grid grid-cols-4 gap-2">
                    <button class="calculator-btn col-span-2" style="background-color: var(--text-danger); color: var(--text-inverted);" aria-label="Clear Calculation">C</button>
                    <button class="calculator-btn operator themed-bg-accent themed-bg-accent-hover">/</button>
                    <button class="calculator-btn operator themed-bg-accent themed-bg-accent-hover">*</button>

                    <button class="calculator-btn digit themed-bg-tertiary">7</button>
                    <button class="calculator-btn digit themed-bg-tertiary">8</button>
                    <button class="calculator-btn digit themed-bg-tertiary">9</button>
                    <button class="calculator-btn operator themed-bg-accent themed-bg-accent-hover">-</button>

                    <button class="calculator-btn digit themed-bg-tertiary">4</button>
                    <button class="calculator-btn digit themed-bg-tertiary">5</button>
                    <button class="calculator-btn digit themed-bg-tertiary">6</button>
                    <button class="calculator-btn operator themed-bg-accent themed-bg-accent-hover">+</button>

                    <button class="calculator-btn digit themed-bg-tertiary">1</button>
                    <button class="calculator-btn digit themed-bg-tertiary">2</button>
                    <button class="calculator-btn digit themed-bg-tertiary">3</button>
                    <button class="calculator-btn equals row-span-2" style="background-color: var(--text-accent); color: var(--text-inverted);" aria-label="Calculate Result">=</button>
                    
                    <button class="calculator-btn col-span-2 digit themed-bg-tertiary">0</button>
                    <button class="calculator-btn decimal themed-bg-tertiary">.</button>
                </div>
            </div>
        </div>
    </main>

<script>
    // --- APP INITIALIZATION ---
    // Prevent right-click to protect content
    document.addEventListener('contextmenu', (e) => e.preventDefault());

    // Prevent inspection via keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
        if (e.key === 'F12' || 
            (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) || 
            (e.ctrlKey && e.key === 'U')) {
            e.preventDefault();
        }
    });

    window.addEventListener('DOMContentLoaded', () => {
      try {
        // --- DATA & STATE ---
        // FIX: Using renamed variable from outer scope.
        const examId = 'exam_1764510536988_wv9g0b8';
        const mcqs = [{"id":1,"question":"A 3-year-old boy is being investigated for suspected familial short stature. His motherâ€™s height is 146 cm and fatherâ€™s height is 150 cm. What is the final height this child is likely to achieve?","options":{"a":"154.5 cm","b":"159.5 cm","c":"148 cm","d":"165 cm"},"correctAnswer":"a","explanation":"**High-Yield Topic Explanation (The Core Concept):** Familial short stature is a benign variation of normal growth where the child's height potential is determined by genetic factors. The projected adult height is calculated using the Mid-Parental Height (MPH) formula: (Motherâ€™s Height + Fatherâ€™s Height + 13) / 2 for boys. In this case, (146 + 150 + 13) / 2 = 154.5 cm.\n\n**2. Rationale for Incorrect Options:**\n\n**159.5 cm:** Incorrect calculation; this would likely result from misapplying the formula or adding 13 to the wrong sum.\n\n**148 cm:** This is close to the mid-point of the parents without the male adjustment (+13 cm).\n\n**165 cm:** Overestimation; likely results from adding 13 cm to the mother's height or incorrect arithmetic.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- MPH Formula (Boys): (Mother + Father + 13) / 2 Â± 8.5 cm.\n- MPH Formula (Girls): (Mother + Father - 13) / 2 Â± 8.5 cm.\n- Bone Age: In familial short stature, bone age equals chronological age (unlike constitutional delay).\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\n\"Boys are Taller, Add Thirteen\": Remember to add 13 cm for boys and subtract 13 cm for girls."},{"id":2,"question":"A child has recently learnt to stand with support and hold objects using a pincer grasp. He however, cannot walk. Which of the other milestone is likely to be present in the child?","options":{"a":"Sit without support","b":"Copy a line","c":"Complete bowel control","d":"Identify colors"},"correctAnswer":"a","explanation":"**High-Yield Topic Explanation (The Core Concept):** Standing with support and pincer grasp (using thumb and index finger) typically develop around 10 months of age. At this age, a child can also sit without support (achieved at 6-8 months). This developmental stage precedes independent walking (12-15 months).\n\n**2. Rationale for Incorrect Options:**\n\n**Copy a line:** A milestone for 2 years (vertical) or 2.5 years (horizontal).\n\n**Complete bowel control:** Usually achieved by 4 years; bladder control comes later (around 5 years).\n\n**Identify colors:** A cognitive milestone typically seen around 3-4 years.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Pincer Grasp: Immature at 9 months; mature (neat) at 12 months.\n- Sitting: Sit with support (5-6 mo) â†’ Sit without support (6-8 mo).\n- Standing: Stand with support (9-10 mo) â†’ Stand without support (12 mo).\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":3,"question":"A recently delivered newborn baby was born to a diabetic mother. His mother had poorly controlled type 2 diabetes. Which of these is the least likely finding expected in the child?","options":{"a":"Caudal regression syndrome","b":"Myelomeningocele","c":"SGA","d":"VSD"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation (The Core Concept):** Infants of Diabetic Mothers (IDM) are typically Large for Gestational Age (LGA) or macrosomic due to fetal hyperinsulinemia acting as a growth factor. Small for Gestational Age (SGA) is the least likely finding unless the mother has severe vascular complications (nephropathy/retinopathy) causing placental insufficiency, which is less common than the typical macrosomia.\n\n**2. Rationale for Incorrect Options:**\n\n**Caudal regression syndrome:** A rare but highly specific congenital anomaly associated with maternal diabetes (sacral agenesis).\n\n**Myelomeningocele:** Neural tube defects are significantly more common in IDM babies.\n\n**VSD:** Congenital heart defects (VSD, TGA) are common associations; Hypertrophic Cardiomyopathy is the most specific cardiac issue.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Classic Triad of IDM: Macrosomia, Hypoglycemia, Polycythemia.\n- Most Common Anomaly: VSD (Ventricular Septal Defect).\n- Most Specific Anomaly: Caudal Regression Syndrome (Sacral Agenesis).\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":4,"question":"A newborn is brought to a pediatrician for consultation. The pediatrician advises the mother â€œkangaroo mother careâ€ procedure. The newborn is most likely:","options":{"a":"AGA baby","b":"LGA baby","c":"Posterm baby","d":"LBW baby"},"correctAnswer":"d","explanation":"**High-Yield Topic Explanation (The Core Concept):** Kangaroo Mother Care (KMC) is a specialized method of care for Low Birth Weight (LBW) infants (\u003c2500g), regardless of gestational age. It involves continuous skin-to-skin contact and exclusive breastfeeding. It promotes thermal control, bonding, and weight gain.\n\n**2. Rationale for Incorrect Options:**\n\n**AGA baby:** Appropriate for Gestational Age babies do not specifically require KMC unless they are LBW.\n\n**LGA baby:** Large babies do not require thermal protection via KMC as critically as LBW infants.\n\n**Postterm baby:** Often have issues like meconium aspiration but do not inherently require KMC for thermoregulation.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- KMC Criteria: Hemodynamically stable LBW infants (\u003c2500g).\n- Components: Skin-to-skin contact, exclusive breastfeeding, early discharge.\n- Benefits: Reduces hypothermia, nosocomial infection, and mortality.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":5,"question":"Most children are able to stand without support for the first time by the age of:","options":{"a":"6 months","b":"1 year","c":"2 years","d":"2.5 years"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation (The Core Concept):** Gross motor development follows a predictable sequence. Standing without support (independent standing) is typically achieved by 12 months (1 year). This is the precursor to independent walking, which follows shortly after.\n\n**2. Rationale for Incorrect Options:**\n\n**6 months:** Child sits with support; rolling over (prone to supine).\n\n**2 years:** Child can run, climb stairs (2 feet per step), and jump.\n\n**2.5 years:** Child can jump over obstacles and stand on one foot briefly.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- 9-10 Months: Stands with support (cruising).\n- 12 Months: Stands without support; may take first steps.\n- 15 Months: Walks independently; crawls upstairs.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":6,"question":"An infant is brought to pediatric OPD with diarrhea, perioral dermatitis and hair loss. These features can be seen in children with deficiency of:","options":{"a":"Copper","b":"Zinc","c":"Iron","d":"Selenium"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation (The Core Concept):** The triad of diarrhea, perioral dermatitis, and alopecia (hair loss) is classic for Acrodermatitis Enteropathica, which is caused by Zinc deficiency. It can be congenital (defect in absorption) or acquired (nutritional).\n\n**2. Rationale for Incorrect Options:**\n\n**Copper:** Deficiency causes Menkes kinky hair disease (sparse, brittle hair), anemia, and neutropenia.\n\n**Iron:** Causes microcytic anemia, pallor, and pica; dermatitis is not a classic feature.\n\n**Selenium:** Deficiency (Keshan disease) causes cardiomyopathy and muscle weakness.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Zinc Deficiency Triad: Dermatitis (acral/perioral), Diarrhea, Alopecia.\n- Treatment: Oral Zinc supplementation (lifelong for congenital forms).\n- Differential: Biotin deficiency can look similar (seborrheic dermatitis + alopecia).\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\n\"Zinc for Zits and Z-hair\": Zinc deficiency affects skin (zits/dermatitis) and hair."},{"id":7,"question":"LISA is a new technique that can be used in newborns for administration of:","options":{"a":"Enteral feeds","b":"10% Dextrose","c":"Iron","d":"Surfactant"},"correctAnswer":"d","explanation":"**High-Yield Topic Explanation (The Core Concept):** LISA (Less Invasive Surfactant Administration) is a technique used to deliver surfactant to premature infants with Respiratory Distress Syndrome (RDS) while they are on CPAP, avoiding the need for intubation and mechanical ventilation.\n\n**2. Rationale for Incorrect Options:**\n\n**Enteral feeds:** Administered via Orogastric or Nasogastric tubes.\n\n**10% Dextrose:** Administered IV for hypoglycemia.\n\n**Iron:** Administered orally or IV for anemia, not intratracheally.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Indication: Preterm infants with RDS failing CPAP.\n- Mechanism: A thin catheter is inserted into the trachea to instill surfactant while the baby breathes spontaneously.\n- Benefit: Reduces barotrauma and need for mechanical ventilation.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":8,"question":"A D4 newborn is being evaluated in the OPD and has erythematous rashes on his trunk as shown in the image. The neonate is otherwise healthy and taking feeds well. These rashes are most likely composed of: {image 1}","options":{"a":"Basophils","b":"Lymphocytes","c":"Eosinophils","d":"Mast cells"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation (The Core Concept):** The description and typical \"flea-bitten\" rash appearance in a healthy newborn on Day 2-4 corresponds to Erythema Toxicum Neonatorum (ETN). These lesions are sterile and filled with Eosinophils. It is a benign, self-limiting condition.\n\n**2. Rationale for Incorrect Options:**\n\n**Basophils:** Rarely dominant in skin rashes; seen in CML or allergic reactions (blood).\n\n**Lymphocytes:** Predominant in viral exanthems or chronic inflammation.\n\n**Mast cells:** Seen in Urticaria Pigmentosa (Darier's sign positive).\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Onset: Day 2-3 of life; resolves by day 7.\n- Site: Face, trunk, proximal limbs (spares palms/soles).\n- Smear: Shows numerous Eosinophils.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\n\"E\" for Erythema, \"E\" for Eosinophils: Erythema Toxicum = Eosinophils."},{"id":9,"question":"A child was diagnosed as a case of severe acute malnutrition after evaluation and anthropometry. Which of the following criteria would have been unlikely used for diagnosis?","options":{"a":"Weight for age","b":"Weight for height","c":"Midarm circumference","d":"Pedal edema"},"correctAnswer":"a","explanation":"**High-Yield Topic Explanation (The Core Concept):** Severe Acute Malnutrition (SAM) is diagnosed by Weight for Height (\u003c-3 SD), Mid-Upper Arm Circumference (MUAC) (\u003c11.5 cm), or the presence of nutritional edema. Weight for Age is used to diagnose \"Underweight,\" not specifically SAM (wasting).\n\n**2. Rationale for Incorrect Options:**\n\n**Weight for height:** The gold standard index for wasting (acute malnutrition).\n\n**Midarm circumference:** Independent criteria for SAM in children 6-59 months (\u003c11.5 cm).\n\n**Pedal edema:** Bilateral pitting edema is an independent diagnostic criterion for SAM (Kwashiorkor).\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- WHO Criteria for SAM: W/H \u003c-3 SD OR MUAC \u003c115mm OR Bilateral Edema.\n- Age Group: MUAC is valid only for 6 months to 5 years.\n- Weight for Age: Detects underweight (composite of stunting + wasting).\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":10,"question":"A severe malnourished child in shock should be preferably administered the following fluid:","options":{"a":"ORS","b":"ReSoMal","c":"IV RL","d":"IV RL in 5% Dx"},"correctAnswer":"d","explanation":"**High-Yield Topic Explanation (The Core Concept):** In SAM with shock (severe dehydration/sepsis), the fluid of choice is IV Ringer's Lactate with 5% Dextrose (or half-strength Darrowâ€™s with 5% Dextrose). The dextrose is crucial because these children are highly prone to hypoglycemia, and pure crystalloids can worsen it.\n\n**2. Rationale for Incorrect Options:**\n\n**ORS:** Used for stable dehydration, not shock.\n\n**ReSoMal:** Rehydration Solution for Malnutrition â€“ strictly oral/NG, never IV (high potassium can cause cardiac arrest if given IV).\n\n**IV RL:** Lacks glucose; risk of hypoglycemia.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Shock Dose in SAM: 15 ml/kg over 1 hour (slower than normal children).\n- ReSoMal: Low Na+, High K+; use for oral rehydration in SAM without shock.\n- Avoid: Saline overload (heart failure risk is high due to weak heart).\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":11,"question":"Significant lanugo on the body, absent sole creases, and poor elastic recoil of the ear are features suggestive of:","options":{"a":"IUGR baby","b":"Posterm baby","c":"Preterm baby","d":"LBW baby"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation (The Core Concept):** These physical features are classic signs of a Preterm baby (\u003c37 weeks). Abundant lanugo (fine hair), absent sole creases (smooth soles), and poor ear recoil (cartilage not fully formed) are components of the New Ballard Score used to estimate gestational age.\n\n**2. Rationale for Incorrect Options:**\n\n**IUGR baby:** Defined by weight (\u003c10th centile); may look \"starved\" (loose skin) but skin maturity markers (creases/ear) match gestational age.\n\n**Postterm baby:** Peeling skin, long nails, absent lanugo, deep sole creases.\n\n**LBW baby:** Defined strictly by weight (\u003c2.5kg), not physical maturity (can be term LBW).\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Ear Recoil: Instant (Term) vs. Slow/Absent (Preterm).\n- Sole Creases: Entire sole (Term) vs. Anterior 1/3 or absent (Preterm).\n- Lanugo: Disappears near term; abundant in mid-trimester/early preterm.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":12,"question":"A newborn after birth does not cry, was resuscitated, and started on PPV with an ambu bag and mask. Which of the options is a valid indication for starting PPV?","options":{"a":"HR \u003c 100/minute","b":"RR\u003c 60/minute","c":"HR \u003c 60/minute","d":"RR \u003c 40/minute"},"correctAnswer":"a","explanation":"**High-Yield Topic Explanation (The Core Concept):** According to the Neonatal Resuscitation Program (NRP), if a baby is apneic, gasping, or has a Heart Rate \u003c 100/min despite initial steps (stimulation, suction), Positive Pressure Ventilation (PPV) must be started immediately. HR is the most critical determinant.\n\n**2. Rationale for Incorrect Options:**\n\n**RR \u003c 60/min:** Normal newborn RR is 30-60; slow breathing is apnea, but HR \u003c100 is the specific trigger for PPV.\n\n**HR \u003c 60/min:** Indication for Chest Compressions (if HR \u003c60 despite 30s of effective PPV).\n\n**RR \u003c 40/min:** Lower limit of normal is roughly 30-40; not a standalone criteria for PPV unless apneic.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Golden Minute: Ventilation should start within 60 seconds if needed.\n- HR \u003c 100: Start PPV.\n- HR \u003c 60: Start Chest Compressions (3:1 ratio).\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":13,"question":"Which of the options is deemed the best criteria for deciding response to a particular treatment in neonatal resuscitation and decision on moving to the next step?","options":{"a":"Color","b":"Heart rate","c":"Tone","d":"Respiration"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation (The Core Concept):** Heart Rate is the most sensitive and important indicator of a newborn's response to resuscitation. An increasing heart rate indicates effective ventilation. Decisions to start PPV, start compressions, or administer epinephrine are all based on HR thresholds (\u003c100, \u003c60).\n\n**2. Rationale for Incorrect Options:**\n\n**Color:** Poor indicator; acrocyanosis is normal. \"Pink vs Blue\" is no longer used to guide resuscitation decisions.\n\n**Tone:** Helpful for initial assessment (Stay with mom vs. Warmer) but not for checking response to PPV.\n\n**Respiration:** Gasping implies need for help, but HR improvement confirms the success of that help.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Primary Measure: Heart Rate (auscultate precordium or palpate umbilicus).\n- Target Saturation: Takes 10 minutes to reach >90%; don't rely on color.\n- Effective PPV: Confirmed by rising HR and chest rise.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":14,"question":"Which of these is the best criteria for diagnosing severe wasting?","options":{"a":"Weight for age","b":"Weight for height","c":"Height for age","d":"Midarm circumference"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation (The Core Concept):** Weight for Height is the specific anthropometric index for Wasting (acute malnutrition). It reflects recent weight loss. Wasting is defined as Weight for Height \u003c-2 SD (Moderate) or \u003c-3 SD (Severe).\n\n**2. Rationale for Incorrect Options:**\n\n**Weight for age:** Detects Underweight (general malnutrition).\n\n**Height for age:** Detects Stunting (chronic malnutrition).\n\n**Midarm circumference:** Detects severe wasting specifically in 6mo-5yr, but W/H is the broader standard index for wasting across ages.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Stunting: Low Height for Age (Chronic).\n- Wasting: Low Weight for Height (Acute).\n- Underweight: Low Weight for Age (Mixed).\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\n\"Short is Stunted, Thin is Wasted\": Height = Stunting, Weight (relative to height) = Wasting."},{"id":15,"question":"A newborn was brought with severe cyanosis, tachypnea and breathlessness. A chest X ray performed is shown. Which of these is a correct statement for this heart disease? {image 2}","options":{"a":"Cyanosis is usually rare at birth","b":"Two broad subtypes of this heart disease","c":"Pulmonary blood flow is significantly reduced","d":"Benign, easily controllable disorder"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation (The Core Concept):** The image (typically \"Egg-on-Side\" or \"Egg-on-String\") coupled with severe cyanosis at birth is classic for Transposition of the Great Arteries (TGA). TGA has two main subtypes: D-TGA (cyanotic) and L-TGA (congenitally corrected). The prompt suggests D-TGA.\n\n**2. Rationale for Incorrect Options:**\n\n**Cyanosis is rare at birth:** Incorrect; TGA presents with severe cyanosis immediately at birth (unlike TOF).\n\n**Pulmonary blood flow reduced:** Incorrect; TGA has increased pulmonary blood flow (plethora on X-ray).\n\n**Benign disorder:** Incorrect; it is a critical ductal-dependent lesion requiring urgent intervention (Prostaglandin/Surgery).\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- CXR Sign: Egg-on-side appearance (narrow mediastinum).\n- Clinical: Day 1 cyanosis, single S2.\n- Treatment: PGE1 to keep duct open â†’ Balloon Septostomy â†’ Arterial Switch Operation (ASO).\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":16,"question":"A newborn with an Apgar score of 4 at 1 minute after birth will be categorized as:","options":{"a":"Severely depressed","b":"Moderately depressed","c":"Mildly depressed","d":"Normal"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation (The Core Concept):** An Apgar score of 4-6 is classified as Moderately Depressed. The score ranges are: 7-10 (Normal/Vigorous), 4-6 (Moderate depression), and 0-3 (Severe depression). This indicates the need for continued resuscitative efforts/observation.\n\n**2. Rationale for Incorrect Options:**\n\n**Severely depressed:** Apgar score 0-3.\n\n**Mildly depressed:** Not a standard category; usually grouped with normal or high moderate.\n\n**Normal:** Apgar score 7-10.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Components: Appearance, Pulse, Grimace, Activity, Respiration.\n- Timing: Recorded at 1 min and 5 min (and every 5 min if score \u003c7).\n- Prognosis: Low 5-min score correlates better with neurological outcome than 1-min score.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\n\"APGAR\": Appearance (color), Pulse (HR), Grimace (reflex), Activity (tone), Respiration."},{"id":17,"question":"A 6-month old infant is brought to the OPD with cyanotic (â€œtetâ€) spells. All of the following can be part of its management except:","options":{"a":"Phenylephrine","b":"Isoprenaline","c":"Metoprolol","d":"Oxygen"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation (The Core Concept):** Metoprolol (Beta-blocker) is used for long-term prophylaxis of Tet spells (infundibular spasm), not for acute management. Acute management aims to increase SVR or calm the child. Isoprenaline is a beta-agonist and would worsen the spell by increasing contractility/spasm (it is contraindicated). Wait, key says 'b' (Isoprenaline) is the exception/wrong drug. Correct, Isoprenaline worsens the obstruction. Phenylephrine increases SVR (good). Oxygen is standard.\n\n**2. Rationale for Incorrect Options:**\n\n**Phenylephrine:** Vasoconstrictor; increases Systemic Vascular Resistance (SVR), forcing blood to lungs (Beneficial).\n\n**Oxygen:** Pulmonary vasodilator; decreases PVR (Beneficial).\n\n**Metoprolol:** Beta-blockers relax the infundibulum; Propranolol is standard, but Metoprolol is same class (Beneficial mechanism). Isoprenaline (Beta agonist) is the dangerous one.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Tet Spell Mechanism: Infundibular spasm + Decreased SVR = R-to-L shunt worsening.\n- Acute Rx: Knee-chest position, Morphine, Oxygen, IV Fluids, Phenylephrine/Ketamine.\n- Contraindicated: Inotropes (Digoxin) or Beta-agonists (Isoprenaline) â€“ they worsen spasm.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\n\"MOKE\": Morphine, Oxygen, Knee-chest, Epinephrine (Phenylephrine - careful with the 'E')."},{"id":18,"question":"A child complains of pain in the legs while walking. His pulses of the lower limb are feeble while radial/brachial pulses are normal. He is diagnosed with a congenital heart disease. Blood flow to the lower limbs in this congenital heart disease will be maintained with:","options":{"a":"Carotid artery","b":"Coronary artery","c":"Intercostal artery","d":"Radial artery"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation (The Core Concept):** This clinical picture (Upper limb hypertension/normal pulses + Lower limb hypotension/feeble pulses + Claudication) describes Coarctation of the Aorta (CoA). In post-ductal CoA, blood flow to the lower limbs is maintained via collaterals, primarily the Intercostal arteries (causing rib notching on X-ray).\n\n**2. Rationale for Incorrect Options:**\n\n**Carotid artery:** Supplies the head/neck; originates proximal to the coarctation.\n\n**Coronary artery:** Supplies the heart.\n\n**Radial artery:** Supplies the arm (pre-coarctation flow is normal/high).\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Sign: Radio-femoral delay.\n- X-ray: \"Figure of 3\" sign (aorta shape) and Inferior Rib Notching (collaterals).\n- Association: Turner Syndrome, Bicuspid Aortic Valve.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":19,"question":"An infant with cataract, sensineural hearing loss, and microcephaly is diagnosed with congenital rubella syndrome. Which of these congenital heart diseases is most likely to be seen?","options":{"a":"VSD","b":"TGA","c":"Subvalvular pulmonary stenosis","d":"PDA"},"correctAnswer":"d","explanation":"**High-Yield Topic Explanation (The Core Concept):** Congenital Rubella Syndrome (CRS) is classically associated with the triad of Cataracts, Sensorineural Deafness, and Cardiac defects. The most common heart defect associated with CRS is Patent Ductus Arteriosus (PDA), followed by Pulmonary Artery Stenosis.\n\n**2. Rationale for Incorrect Options:**\n\n**VSD:** Most common CHD overall, but not the specific signature of Rubella.\n\n**TGA:** Associated with maternal diabetes, not Rubella.\n\n**Subvalvular pulmonary stenosis:** Peripheral Pulmonary Stenosis is the Rubella association, but PDA is the classic answer choice.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Gregg's Triad: Cataract, Deafness, PDA/Pulmonary Stenosis.\n- Rash: \"Blueberry Muffin\" rash (extramedullary hematopoiesis).\n- Prevention: MMR Vaccine.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\n\"Rubella has a Pulse\": Pulse = PDA."},{"id":20,"question":"A D3 newborn, term baby and weight 2.2 kg, is to be started on IV fluids. Calculate the amount of IV fluids he will require on day 3:","options":{"a":"198 ml","b":"242 ml","c":"176 ml","d":"262 ml"},"correctAnswer":"a","explanation":"**High-Yield Topic Explanation (The Core Concept):** Fluid requirements for a term neonate typically start at 60 ml/kg on Day 1 and increase by 10-20 ml/kg/day.\nDay 1: 60 ml/kg\nDay 2: 75-80 ml/kg\nDay 3: ~90-100 ml/kg.\nCalculation: 2.2 kg Ã— 90 ml/kg = 198 ml. (Standard progression: 60 â†’ 75 â†’ 90 ml/kg).\n\n**2. Rationale for Incorrect Options:**\n\n**242 ml:** Implies >100 ml/kg (Day 4-5 rates).\n\n**176 ml:** 80 ml/kg (Day 2 rate).\n\n**262 ml:** Excessive for Day 3.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Term Fluids: Start 60 ml/kg/day.\n- Preterm Fluids: Start 70-80 ml/kg/day (higher insensible loss).\n- Fluid Type: 10% Dextrose for first 2 days; add electrolytes (Na/K) from Day 3.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":21,"question":"The most common site of intracranial bleed expected in a preterm baby (delivered at 30 weeks) is:","options":{"a":"Intraventricular","b":"Germinal matrix","c":"Basal ganglia","d":"Brainstem"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation (The Core Concept):** In preterm infants (\u003c32 weeks), the Germinal Matrix is a highly vascular, fragile area in the brain prone to rupture due to hemodynamic fluctuations. Rupture here leads to Germinal Matrix Hemorrhage (GMH), which can extend to become Intraventricular Hemorrhage (IVH).\n\n**2. Rationale for Incorrect Options:**\n\n**Intraventricular:** This is the extension of the bleed, but the site of origin is the germinal matrix.\n\n**Basal ganglia:** Site of bleed in older children/adults (hypertensive).\n\n**Brainstem:** Rare site for spontaneous neonatal bleed.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Risk Group: VLBW and Preterm (\u003c32 wks).\n- Screening: Cranial Ultrasound (Day 3-7).\n- Grading: Papile grading (Grade I-IV). Grade III/IV have poor prognosis.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":22,"question":"A child with marasmus is expected to have all of the following features except:","options":{"a":"Severe muscle wasting","b":"Alert look","c":"â€œBaggy pant appearanceâ€","d":"Poor appetite"},"correctAnswer":"d","explanation":"**High-Yield Topic Explanation (The Core Concept):** Marasmus is severe calorie deficiency (balanced starvation). The child is alert, has a good appetite (ravenous eater), and shows severe muscle/fat wasting (\"Baggy pants\"). Poor appetite is a characteristic feature of Kwashiorkor, not Marasmus.\n\n**2. Rationale for Incorrect Options:**\n\n**Severe muscle wasting:** Hallmark of Marasmus (skin and bones).\n\n**Alert look:** Marasmic children are alert and irritable (Kwashiorkor children are lethargic/apathetic).\n\n**\"Baggy pant appearance\":** Due to loss of gluteal fat and muscle.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Marasmus: Calorie deficiency, Wasting, Alert, Good Appetite.\n- Kwashiorkor: Protein deficiency, Edema, Apathetic, Poor Appetite, Hepatomegaly.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\n\"M\" for Marasmus, \"M\" for Muscle Wasting.\n\n\"K\" for Kwashiorkor, \"K\" for Krap appetite (Poor)."},{"id":23,"question":"Supracardiac, infracardiac, and cardiac are subtypes of which of these congenital heart diseases?","options":{"a":"VSD","b":"TAPVR","c":"TGA","d":"Hypoplastic left heart syndrome"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation (The Core Concept):** Total Anomalous Pulmonary Venous Return (TAPVR) is classified into four types based on the site of drainage:\n\nSupracardiac (drain to SVC - most common)\n\nCardiac (drain to Coronary Sinus)\n\nInfracardiac (drain to IVC/Portal Vein - obstructive)\n\nMixed.\n\n**2. Rationale for Incorrect Options:**\n\n**VSD:** Classification is membranous, muscular, etc.\n\n**TGA:** Classification is D-TGA vs L-TGA.\n\n**Hypoplastic left heart syndrome:** Anatomical description of LV aplasia.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- X-ray: \"Snowman\" or \"Figure of 8\" appearance (Supracardiac).\n- Obstructed TAPVR: Usually Infracardiac type; presents with severe cyanosis and pulmonary edema (emergency).\n- Physiology: Mixing lesion (requires ASD for survival).\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":24,"question":"Which of the following statements is wrong about fetal circulation?","options":{"a":"Pressure on left side of heart more than right side","b":"SVC less oxygenated than IVC","c":"Umbilical artery less oxygenated than umbilical vein","d":"Two umbilical artery but one umbilical vein"},"correctAnswer":"a","explanation":"**High-Yield Topic Explanation (The Core Concept):** In fetal circulation, the pressure on the right side is higher than the left (due to high pulmonary resistance). This pushes blood through the ductus arteriosus. Post-birth, this reverses. Therefore, \"Pressure on left side > right side\" is a wrong statement for fetal life (it becomes true after birth).\n\n**2. Rationale for Incorrect Options:**\n\n**SVC less oxygenated than IVC:** True; IVC carries oxygenated blood from the placenta (via Ductus Venosus).\n\n**Umbilical artery less oxygenated than umbilical vein:** True; Vein brings fresh blood, Arteries return waste blood.\n\n**Two umbilical artery but one umbilical vein:** True anatomical fact (Left umbilical vein persists).\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Shunts: Ductus Venosus (Liver bypass), Foramen Ovale (Atrial bypass), Ductus Arteriosus (Lung bypass).\n- Highest O2 Saturation: Umbilical Vein.\n- Closure: DA closes functionally in 10-15 hours; FO closes as LA pressure rises.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":25,"question":"Which of these congenital heart diseases may carry the least risk of heart failure complication?","options":{"a":"PDA","b":"VSD","c":"TOF","d":"TGA"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation (The Core Concept):** Tetralogy of Fallot (TOF) typically involves pulmonary stenosis which protects the pulmonary vascular bed from over-circulation. Therefore, congestive heart failure is rare in classic TOF. The other lesions (PDA, VSD, TGA) cause left-to-right shunting or high flow, leading to volume overload and failure.\n\n**2. Rationale for Incorrect Options:**\n\n**PDA:** Left-to-Right shunt â†’ Pulmonary over-circulation â†’ Heart Failure.\n\n**VSD:** Large VSD is a classic cause of failure in infancy.\n\n**TGA:** Without stenosis, TGA rarely causes failure early, but if VSD is present or as PVR drops, failure can occur; however, TOF is the classic \"protective\" lesion against failure.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- TOF Features: VSD, Overriding Aorta, PS, RVH.\n- Pink Tet: TOF with mild PS (L-to-R shunt possible â†’ Failure possible, but rare).\n- Presentation: Cyanosis (spells), not Failure.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\n\"TOF is Tough\": The heart muscle is strong (RVH) but doesn't fail (no overload)."},{"id":26,"question":"Which of these skull fontanelles is usually the first to close?","options":{"a":"Anterior","b":"Posterior","c":"Sphenoid","d":"Mastoid"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation (The Core Concept):** The Posterior Fontanelle (lambda) is triangular and typically closes by 6-8 weeks (1.5-2 months) of age. It is the first to close among the major fontanelles checked clinically.\n\n**2. Rationale for Incorrect Options:**\n\n**Anterior:** Diamond shaped; closes late (18-24 months).\n\n**Sphenoid (Anterolateral):** Closes around 6 months.\n\n**Mastoid (Posterolateral):** Closes around 6-18 months.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Posterior: 6-8 weeks.\n- Anterior: 1.5 - 2 years.\n- Large Anterior Fontanelle: Hypothyroidism, Rickets, Hydrocephalus, Down Syndrome.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":27,"question":"A 3-month-old infant with a large skull was diagnosed with a hydrocephalus. His brain imaging confirmed an obstructive hydrocephalus with intraventricular obstruction. Which of these is the most common site of obstruction?","options":{"a":"Interventricular foramen","b":"Third ventricle","c":"Lateral ventricle","d":"Aqueduct of sylvius"},"correctAnswer":"d","explanation":"**High-Yield Topic Explanation (The Core Concept):** The Aqueduct of Sylvius (connecting the 3rd and 4th ventricles) is the narrowest part of the ventricular system. Aqueductal Stenosis is the most common cause of congenital obstructive hydrocephalus.\n\n**2. Rationale for Incorrect Options:**\n\n**Interventricular foramen (Monro):** Connects lateral to 3rd; obstruction here causes unilateral/bilateral lateral ventricle dilation only.\n\n**Third ventricle:** Obstruction is less common (e.g., colloid cyst).\n\n**Lateral ventricle:** Site of fluid production, not common obstruction site itself.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Non-communicating (Obstructive): Blockage within the system (Aqueductal stenosis).\n- Communicating: Impaired absorption (post-meningitis, hemorrhage).\n- Sign: Sunset sign of eyes, Macewen sign (cracked pot sound).\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":28,"question":"Prenatal diagnosis of anencephaly and spina bifida through amniotic fluid analysis is possible. Which of the following markers in amniotic fluid is considered the most sensitive for their diagnosis?","options":{"a":"Total hCG","b":"Estradiol","c":"Gelacetylcholinesterase","d":"Alpha-fetoprotein"},"correctAnswer":"d","explanation":"**High-Yield Topic Explanation (The Core Concept):** Alpha-fetoprotein (AFP) is a protein produced by the fetal liver. In Open Neural Tube Defects (Anencephaly, Spina Bifida), AFP leaks into the amniotic fluid (and maternal serum). Elevated Amniotic Fluid AFP + Acetylcholinesterase is highly diagnostic. AFP is the standard screening marker.\n\n**2. Rationale for Incorrect Options:**\n\n**Total hCG:** Marker for aneuploidy (Down syndrome).\n\n**Estradiol:** Used in Triple/Quadruple screen for Down syndrome (low uE3).\n\n**Gelacetylcholinesterase:** Confirmatory test if AFP is high, but AFP is the primary sensitive marker mentioned. Note: The key selects AFP. Acetylcholinesterase is more specific but AFP is the classic sensitive screening marker.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- High AFP: NTDs, Gastroschisis, Multiple gestation.\n- Low AFP: Down Syndrome (Trisomy 21).\n- Prevention: Folic Acid 400mcg pre-conception.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":29,"question":"Head circumference of a 3-month-old infant, growing well, is expected to be what percentage of head circumference of a 1-year-old child?","options":{"a":"25%","b":"35%","c":"50%","d":"85%"},"correctAnswer":"d","explanation":"**High-Yield Topic Explanation (The Core Concept):** Head circumference (HC) growth is rapid in the first year.\nBirth: 35 cm.\n3 months: ~40-41 cm.\n1 year: ~46-47 cm.\n40 cm (3mo) is roughly 85% of 47 cm (1yr)? No, math: 40/47 = 85%. So HC at 3 months is approx 85% of the 1-year size. Correction: The brain growth is 80-85% complete by significantly later, but the HC numeric value matches this ratio.\n\n**2. Rationale for Incorrect Options:**\n\n**25%, 35%, 50%:** These underestimate the rapid early head growth. By 6 months, HC is already 43-44 cm.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Growth Rate: +2 cm/mo (0-3 mo), +1 cm/mo (3-6 mo), +0.5 cm/mo (6-12 mo).\n- Brain Size: Brain weight doubles by 6 months, triples by 1 year.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\n\"35-47-50\": 35cm (Birth) â†’ 47cm (1yr) â†’ 50cm (Adult/Late childhood... actually adult is 55, but 50 is approx 5yr)."},{"id":30,"question":"A 5-year-old child with persistent headaches, worsening usually in the morning, with nausea, and vomiting, was brought to a pediatric OPD for evaluation. Brain imaging showed a large midline intracerebral mass. Which of these brain tumors may be the most likely cause?","options":{"a":"Choroid plexus tumor","b":"Diffuse astrocytoma","c":"Medulloblastoma","d":"Craniopharyngioma"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation (The Core Concept):** Medulloblastoma is the most common malignant brain tumor in children. It arises in the midline (vermis of cerebellum) and obstructs the 4th ventricle, causing increased ICT (morning headache, vomiting).\n\n**2. Rationale for Incorrect Options:**\n\n**Choroid plexus tumor:** Rare, causes hydrocephalus by overproduction.\n\n**Diffuse astrocytoma:** Usually cerebral hemispheres (supratentorial).\n\n**Craniopharyngioma:** Suprasellar (visual defects, hormonal issues), usually calcified. Note: Key says 'c' (Medulloblastoma).\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Most Common Brain Tumor: Astrocytoma (Pilocytic - benign).\n- Most Common Malignant: Medulloblastoma.\n- Location: Infratentorial tumors are more common in children (unlike adults).\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\n\"M\" for Midline, \"M\" for Medulloblastoma."},{"id":31,"question":"All of the following may be commonly known etiological causes of neonatal meningitis except:","options":{"a":"S. aureus","b":"Meningococcus","c":"GBS","d":"E. coli"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation (The Core Concept):** The most common causes of neonatal meningitis are Group B Streptococcus (GBS), E. coli, and Listeria monocytogenes. Meningococcus (N. meningitidis) is a common cause in infants and older children/adults but is rare in the neonatal period (\u003c1 month).\n\n**2. Rationale for Incorrect Options:**\n\n**S. aureus:** Cause of late-onset sepsis/meningitis, especially with invasive devices.\n\n**GBS:** #1 cause of early-onset sepsis/meningitis.\n\n**E. coli:** #2 cause (common in preterms).\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Neonatal Bacteria: GBS, E. coli, Listeria.\n- Infant/Child Bacteria: Pneumococcus, Meningococcus, HiB (unvaccinated).\n- Empiric Rx (Neonate): Ampicillin + Gentamicin (+ Cefotaxime for meningitis).\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\n\"BEL\": B group strep, E. coli, Listeria."},{"id":32,"question":"Abnormal persistence of Moros reflex beyond what age may be considered pathological?","options":{"a":"2 months","b":"3 months","c":"4 months","d":"6 months"},"correctAnswer":"d","explanation":"**High-Yield Topic Explanation (The Core Concept):** The Moro reflex (startle reflex) typically appears at birth and disappears by 3-4 months (max 6 months). Persistence beyond 6 months is definitely pathological and suggests Cerebral Palsy or neurological delay.\n\n**2. Rationale for Incorrect Options:**\n\n**2, 3, 4 months:** The reflex naturally fades during this window. Disappearance at 4 months is normal.\n\n**Persistence >6m:** Indicates failure of cortical suppression of primitive reflexes.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Asymmetric Moro: Erb's palsy, Clavicle fracture.\n- Absent Moro: Severe CNS depression, Kernicterus.\n- Persistent Moro: Cerebral Palsy.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":33,"question":"A 3-week infant with prolonged jaundice since birth is being evaluated. He is passing high-colour urine and clay-colour stools. His total serum bilirubin and conjugated bilirubin fraction are raised. Liver function test also revealed elevated GGT. Which of these may be the most likely cause?","options":{"a":"Cystic fibrosis","b":"Hirchsprung disease","c":"Neonatal hepatitis","d":"Choledochal cyst"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation (The Core Concept):** Prolonged jaundice (>2 weeks) with cholestasis (high conjugated bilirubin, clay stools, high urine color) suggests an obstructive pathology. Elevated GGT points towards biliary obstruction. Neonatal Hepatitis (giant cell) and Biliary Atresia are top differentials. While Biliary Atresia is critical to rule out, \"Neonatal Hepatitis\" is a broad category often used for intrahepatic causes. However, looking at the key (c) and the options: Cystic Fibrosis and Choledochal cyst are specific. Neonatal Hepatitis is the most common intrahepatic cause. Correction based on key: The key says 'c' (Neonatal hepatitis). Usually, Biliary Atresia has high GGT and Hepatitis has normal/low GGT unless it's specific types. However, high GGT is broadly biliary. If Biliary Atresia isn't an option, Hepatitis is the diagnosis of exclusion or specific viral types. Re-eval: Key says C.\n\n**2. Rationale for Incorrect Options:**\n\n**Cystic fibrosis:** Causes cholestasis but usually presents with meconium ileus or respiratory issues first.\n\n**Hirchsprung:** Causes obstruction/constipation, not cholestatic jaundice.\n\n**Choledochal cyst:** Anatomical cyst; causes cholestasis but is rarer than hepatitis/atresia.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Cholestasis: Direct Bilirubin >1 mg/dL (or >20% total).\n- Stool Color: Pale/Clay = Obstruction (Atresia).\n- Critical Window: Kasai surgery for Biliary Atresia best before 60 days.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":34,"question":"An 8-month infant, weight 8 kg, with diarrhea and vomiting since the last 3 days is drowsy on evaluation with poor skin turgor. His eyes are sunken. According to the mother, child is not accepting feeds. Treatment of choice in first 1 hour:","options":{"a":"ORS 240 ml","b":"IV RL 240 ml","c":"ORS 560 ml","d":"IV NS 560 ml"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation (The Core Concept):** The child has Severe Dehydration (Drowsy, Poor turgor, Sunken eyes). In severe dehydration, rapid IV rehydration is required. The standard regimen (IMNCI/WHO) for infants (\u003c12m) is 30 ml/kg in 1st hour followed by 70 ml/kg over 5 hours.\nWeight 8 kg Ã— 30 ml = 240 ml. Fluid of choice is IV Ringer Lactate.\n\n**2. Rationale for Incorrect Options:**\n\n**ORS:** Contraindicated if child is drowsy/shocked (risk of aspiration, slow).\n\n**IV NS 560 ml:** This is 70ml/kg (the subsequent phase volume).\n\n**ORS 560 ml:** Incorrect volume and route.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Severe Dehydration Signs: Lethargy/Unconscious, Sunken eyes, Skin pinch goes back very slowly (>2s).\n- Plan C (Severe): Start IV fluids immediately (RL).\n- Volume: 100ml/kg total. Split 30ml/kg + 70ml/kg.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":35,"question":"Tissue transglutaminase and endomysial antibodies are markers for diagnosis of which of these diseases in children?","options":{"a":"Cystic fibrosis","b":"Hirchsprung disease","c":"Neonatal cholestasis","d":"Celiac disease"},"correctAnswer":"d","explanation":"**High-Yield Topic Explanation (The Core Concept):** Anti-Tissue Transglutaminase (anti-tTG) IgA and Anti-Endomysial (EMA) antibodies are highly sensitive and specific serological markers for Celiac Disease (Gluten sensitive enteropathy).\n\n**2. Rationale for Incorrect Options:**\n\n**Cystic fibrosis:** Diagnosed by Sweat Chloride test / Genetics (CFTR).\n\n**Hirchsprung:** Diagnosed by Rectal Biopsy (absent ganglion cells).\n\n**Neonatal cholestasis:** Diagnosed by LFTs, HIDA scan, Biopsy.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Screening Test: IgA anti-tTG.\n- Confirmatory Test: Duodenal Biopsy (Villous atrophy, Crypt hyperplasia).\n- Prerequisite: Patient must be on a gluten-containing diet during testing.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":36,"question":"Which of these respiratory disorders in children is unlikely to present with wheezing?","options":{"a":"Bronchitis","b":"Bronchiolitis","c":"Asthma","d":"Croup"},"correctAnswer":"d","explanation":"**High-Yield Topic Explanation (The Core Concept):** Croup (Laryngotracheobronchitis) is an upper airway obstruction causing Stridor (inspiratory sound) and a barking cough. Wheezing is a lower airway sound (expiratory) typical of Bronchitis, Bronchiolitis, and Asthma.\n\n**2. Rationale for Incorrect Options:**\n\n**Bronchitis:** Inflammation of bronchi; can cause wheeze.\n\n**Bronchiolitis:** Viral (RSV) small airway inflammation; classic for wheeze in infants.\n\n**Asthma:** Reversible airway obstruction; classic wheeze.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Stridor: Upper airway (Croup, Epiglottitis, Foreign Body).\n- Wheeze: Lower airway (Asthma, Bronchiolitis).\n- Croup Sign: Steeple sign on X-ray.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\n\"S\" for Stridor, \"S\" for Superior (Upper) Airway."},{"id":37,"question":"A child with chronic diarrhea, bloating, fatigue, and progressive weight loss is suspected of celiac disease. Testing for which of the following genes may be supportive of this diagnosis?","options":{"a":"HLADQ4","b":"HLDQ5","c":"HLADQ1","d":"HLADQ2"},"correctAnswer":"d","explanation":"**High-Yield Topic Explanation (The Core Concept):** Celiac disease has a strong genetic association. Almost all patients carry HLA-DQ2 (95%) or HLA-DQ8 (5%). Absence of these alleles effectively rules out Celiac disease (high negative predictive value).\n\n**2. Rationale for Incorrect Options:**\n\n**HLADQ4, HLDQ5, HLADQ1:** Not associated with Celiac disease.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Genetics: HLA-DQ2 and DQ8.\n- Trigger: Gliadin fraction of Gluten (Wheat, Rye, Barley).\n- Biopsy: Marsh grading (Villous atrophy).\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\n\"I ate (8) too (2) much Gluten\": HLA-DQ 2 and DQ 8."},{"id":38,"question":"Cystic fibrosis is an autosomal recessive disorder associated with a wide range of symptoms including chronic lung infections, pancreatic insufficiency, and cholestasis in children. The mutated CFTR gene is located on the long arm of which chromosome?","options":{"a":"Chromosome 3","b":"Chromosome 7","c":"Chromosome 13","d":"Chromosome 15"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation (The Core Concept):** The CFTR (Cystic Fibrosis Transmembrane Conductance Regulator) gene is located on the long arm of Chromosome 7. The most common mutation is Delta F508 (deletion of Phenylalanine at position 508).\n\n**2. Rationale for Incorrect Options:**\n\n**Chromosome 3:** VHL gene (Von Hippel-Lindau).\n\n**Chromosome 13:** RB1 gene (Retinoblastoma), Wilson disease.\n\n**Chromosome 15:** Prader-Willi / Angelman syndrome, Marfan (FBN1).\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Inheritance: Autosomal Recessive.\n- Pathophysiology: Defective Chloride channel â†’ Thick sticky mucus.\n- Diagnosis: Sweat Chloride >60 mmol/L.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\n\"C-F-Seven-R\": CFTR is on Chromosome 7."},{"id":39,"question":"Most children develop a complete bladder control usually by what age?","options":{"a":"1 year","b":"2 years","c":"4 years","d":"5 years"},"correctAnswer":"d","explanation":"**High-Yield Topic Explanation (The Core Concept):** Bladder control follows a sequence: Nocturnal bowel â†’ Diurnal bowel â†’ Diurnal bladder â†’ Nocturnal bladder. Complete bladder control (including night) is typically achieved by 5 years. Bedwetting (Enuresis) is considered normal up to 5 years.\n\n**2. Rationale for Incorrect Options:**\n\n**1 year:** No sphincter control.\n\n**2 years:** Bowel control usually achieved.\n\n**4 years:** Daytime bladder control usually achieved, but night control takes longer.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Sequence: Bowel before Bladder. Day before Night.\n- Enuresis: Diagnosis made only after 5 years (chronological) or mental age of 5.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":40,"question":"Which of these drug classes is the first-line maintenance (controller) treatment for childhood asthma?","options":{"a":"Inhaled corticosteroids","b":"SABA","c":"LABA","d":"Leukotriene receptor antagonists"},"correctAnswer":"a","explanation":"**High-Yield Topic Explanation (The Core Concept):** Inhaled Corticosteroids (ICS) (e.g., Budesonide, Fluticasone) are the most effective anti-inflammatory drugs and are the first-line maintenance (controller) therapy for persistent childhood asthma.\n\n**2. Rationale for Incorrect Options:**\n\n**SABA (e.g., Salbutamol):** Reliever/Rescue medication for acute symptoms, not maintenance.\n\n**LABA:** Never used as monotherapy in asthma (safety warning); used as add-on to ICS.\n\n**Leukotriene receptor antagonists:** Alternative controller (weaker than ICS), often for allergic rhinitis or viral-induced wheeze.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Controller: ICS (Gold standard).\n- Reliever: SABA.\n- Delivery: Spacer device is mandatory for children to ensure lung deposition.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":41,"question":"A 2.5-year-old child with recurrent episodes of UTI is suspected of having a vesicoureteric reflux. Which of the following test is usually considered â€œgold standardâ€ for detecting VUR?","options":{"a":"MCU","b":"Ultrasound","c":"DTPA","d":"DMSA"},"correctAnswer":"a","explanation":"**High-Yield Topic Explanation (The Core Concept):** Micturating Cystourethrogram (MCU) is the gold standard investigation for diagnosing and grading Vesicoureteric Reflux (VUR). It visualizes the reflux of contrast from the bladder up to the ureters/kidneys during voiding.\n\n**2. Rationale for Incorrect Options:**\n\n**Ultrasound:** Good for screening (hydronephrosis) but misses low-grade VUR.\n\n**DTPA:** Dynamic scan for obstruction/function (diuretic renography).\n\n**DMSA:** Static scan; Gold standard for cortical scarring (pyelonephritis sequel), not for detecting reflux itself.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- VUR Diagnosis: MCU.\n- Scarring Diagnosis: DMSA.\n- Obstruction (PUJ): DTPA/Mag3.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":42,"question":"A 7-month old baby with poor growth and 2 episodes of hematuria was advised abdominal ultrasound. Ultrasound showed both kidneys enlarged with loss of corticomedullary differentiation and small cysts in the medulla and cortex. Congenital hepatic fibrosis was also present. This renal disorder is most likely to present in what inheritance pattern?","options":{"a":"X-linked recessive","b":"X-linked dominant","c":"Autosomal dominant","d":"Autosomal receive"},"correctAnswer":"d","explanation":"**High-Yield Topic Explanation (The Core Concept):** The presence of enlarged kidneys with microcysts, loss of corticomedullary differentiation, and Congenital Hepatic Fibrosis is the classic presentation of Autosomal Recessive Polycystic Kidney Disease (ARPKD).\n\n**2. Rationale for Incorrect Options:**\n\n**Autosomal Dominant (ADPKD):** Presents in adults; macroscopic cysts; liver cysts (not fibrosis).\n\n**X-linked:** Alport syndrome (nephritis + deafness).\n\n**Multicystic Dysplastic Kidney:** Non-functioning, non-communicating cysts; usually unilateral.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- ARPKD: Infants/Children + Hepatic Fibrosis + Lung Hypoplasia (Potter sequence).\n- ADPKD: Adults + Berry Aneurysms + Liver Cysts.\n- Gene: PKHD1 (Fibrocystin).\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\n\"Recessive is Rapid\": ARPKD presents rapidly in infancy/childhood."},{"id":43,"question":"Routine abdomen evaluation in a 5-day old newborn revealed a large right-side abdominal lump. Which of these may be the most likely cause?","options":{"a":"Polycystic kidney","b":"Wilms tumor","c":"Neuroblastoma","d":"Multicystic dysplastic kidney"},"correctAnswer":"d","explanation":"**High-Yield Topic Explanation (The Core Concept):** In a newborn, the most common cause of an abdominal mass is renal in origin. Specifically, Multicystic Dysplastic Kidney (MCDK) is a common cause of a palpable flank mass. Hydronephrosis and MCDK are top differentials. Neuroblastoma and Wilms are tumors, but benign renal anomalies are statistically more common causes of lumps in healthy newborns. Note: Key says 'd' (MCDK).\n\n**2. Rationale for Incorrect Options:**\n\n**Polycystic kidney:** Usually bilateral enlargement.\n\n**Wilms tumor:** Malignancy usually presenting in toddlers (3-4 years), rare in neonates.\n\n**Neuroblastoma:** Common malignancy of infancy, but MCDK is the most common abdominal mass overall in the neonatal period.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Neonatal Abdominal Mass: >50% are Renal (Hydronephrosis/MCDK).\n- MCDK: Non-functional kidney; eventually involutes.\n- Wilms: Does not cross midline; well child.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":44,"question":"Which of these neonatal seizures is the most common type?","options":{"a":"Focal seizures","b":"Tonic seizures","c":"Infantile spasms","d":"Subtle seizures"},"correctAnswer":"d","explanation":"**High-Yield Topic Explanation (The Core Concept):** Subtle seizures are the most common type of seizure in the neonatal period. They present with overlooked signs like lip smacking, cycling movements of legs, staring, or apnea, due to the immature cortical organization in newborns.\n\n**2. Rationale for Incorrect Options:**\n\n**Focal seizures:** Clonic/Tonic focal are common but Subtle is #1.\n\n**Tonic seizures:** Generalized tonic are seen, typically in preterms with IVH.\n\n**Infantile spasms:** Onset typically 4-6 months (West Syndrome).\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Neonatal Seizure: Phenobarbitone is 1st line drug.\n- Cause: HIE (Hypoxic Ischemic Encephalopathy) is #1 cause.\n- Nature: Generalized tonic-clonic (GTCS) is rare/impossible in neonates (lack myelination).\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":45,"question":"A child with suspected seizure activity for the last 3 months is advised EEG. The EEG of this child shows symmetrical 3-Hz spike-and-wave discharges that begin and end abruptly. This EEG pattern is most consistent with a diagnosis of:","options":{"a":"Juvenile myoclonic epilepsy","b":"Absence seizures","c":"Generalized tonic-clonic seizures","d":"Infantile spasms"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation (The Core Concept):** The EEG pattern of symmetrical 3-Hz spike-and-wave discharges is pathognomonic for Absence Seizures (Petit Mal). Clinically, these present as brief staring spells with abrupt onset and offset, often triggered by hyperventilation.\n\n**2. Rationale for Incorrect Options:**\n\n**Juvenile myoclonic epilepsy:** 4-6 Hz polyspike and wave.\n\n**Generalized tonic-clonic:** Generalized high-amplitude spikes/polyspikes.\n\n**Infantile spasms:** Hypsarrhythmia (chaotic high voltage).\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Drug of Choice: Ethosuximide or Valproate.\n- Trigger: Hyperventilation.\n- Prognosis: Good; often resolves in adolescence.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\n\"ABC\": Absence, Blanking out, Count to 3 (3Hz)."},{"id":46,"question":"A child had a history of abdomen pain, joint pain and rashes, typically blanching papules and palpable purpura involving the legs. About 2 weeks later, the child developed gross hematuria. Renal biopsy of this glomerulonephritis is likely to mimic that of which other renal disorder?","options":{"a":"Minimal change disease","b":"Post-streptococcal glomerulonephritis","c":"IgA nephropathy","d":"MPGN"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation (The Core Concept):** The clinical scenario describes Henoch-SchÃ¶nlein Purpura (HSP) (Abdominal pain, Arthritis, Palpable Purpura). HSP is an IgA-mediated vasculitis. Renal biopsy in HSP nephritis shows mesangial IgA deposition, which is histologically identical to IgA Nephropathy (Berger's disease).\n\n**2. Rationale for Incorrect Options:**\n\n**Minimal change disease:** Nephrotic syndrome; electron microscopy shows foot process effacement (light microscopy normal).\n\n**Post-streptococcal glomerulonephritis:** Subepithelial \"humps\" (IgG/C3).\n\n**MPGN:** Tram-track appearance.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- HSP Tetrad: Purpura (Palpable), Arthritis, Abdominal Pain, Renal involvement.\n- Pathology: IgA deposition in mesangium.\n- Prognosis: Excellent; self-limiting.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":47,"question":"A respiratory rate of 46/minute will be considered fast breathing in children:","options":{"a":"Above 1 year","b":"Above 8 months","c":"Above 6 months","d":"Above 2 months"},"correctAnswer":"a","explanation":"**High-Yield Topic Explanation (The Core Concept):** Respiratory rate cut-offs for fast breathing (tachypnea) in IMNCI:\n\u003c 2 months: â‰¥ 60/min\n2 months - 12 months: â‰¥ 50/min\n12 months - 5 years: â‰¥ 40/min\nA rate of 46/min is >40, so it is fast breathing for a child above 1 year (12 months). For a younger child (e.g., 6 months), 46 is normal (\u003c50).\n\n**2. Rationale for Incorrect Options:**\n\n**Above 8 months / 6 months / 2 months:** The threshold is 50/min. So 46 is normal for these ages. It is only abnormal for a child >1 year where the limit is 40.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- 0-2 mo: 60.\n- 2-12 mo: 50.\n- 1-5 yr: 40.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\n\"6-5-4 Rule\": 60 (neonate), 50 (infant), 40 (child)."},{"id":48,"question":"A child is able to climb stairs, though one step at a time, turn each page of a book individually, and copy a line although not a circle. His development age is most likely:","options":{"a":"6 months","b":"2 years","c":"3 years","d":"4 years"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation (The Core Concept):** Climbing stairs (one foot per step/2 feet per step means \"marking time\" - typically 2 years), turning pages individually (2 years), and copying a vertical line (2 years) are milestones of a 2-year-old. Copying a circle is a 3-year milestone.\n\n**2. Rationale for Incorrect Options:**\n\n**6 months:** Sits, transfers objects.\n\n**3 years:** Rides tricycle, copies circle, climbs stairs alternating feet.\n\n**4 years:** Hops, copies cross/square.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- 18 Months: Tower of 3 cubes, scribbles.\n- 2 Years: Tower of 6 cubes, horizontal/vertical line.\n- 3 Years: Tower of 9 cubes, circle.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":49,"question":"Which of these language milestones is the last to appear in a child?","options":{"a":"Vocalization","b":"Babbling","c":"Jargons","d":"Bisyllables"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation (The Core Concept):** Language development sequence:\n\nVocalization (Cooing) - 3 months\n\nMonosyllables - 6 months\n\nBisyllables (Mama/Dada non-specific) - 9 months\n\nJargon (complex babbling with intonation) - 12-15 months.\n\nTherefore, Jargon is the last to appear.\n\n**2. Rationale for Incorrect Options:**\n\n**Vocalization:** Early (2-3 mo).\n\n**Babbling:** 4-6 mo.\n\n**Bisyllables:** 9 mo.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Red Flag: No speech/babbling by 12 months; No single words by 16 months.\n- Hearing: Always check hearing in speech delay.\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":50,"question":"A baby is born at 35 weeks gestation. He was premature, although he cried at birth and had an Apgar of 7 and 8 at 1 and 5 minutes after birth. He may be offered the following feeds under supervision:","options":{"a":"Tube feeds","b":"Breast feeds","c":"Spoon feeds","d":"Enteral feeds"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation (The Core Concept):** A baby born at 35 weeks (late preterm) with good Apgar scores and crying is physiologically mature enough to coordinate sucking, swallowing, and breathing (which matures by 34 weeks). Therefore, Breastfeeding is the standard of care.\n\n**2. Rationale for Incorrect Options:**\n\n**Tube feeds:** Reserved for \u003c32-34 weeks or those unable to suck/swallow.\n\n**Spoon feeds (Paladai):** Option if sucking is weak, but direct breast is preferred if capable.\n\n**Enteral feeds:** General term, but \"Breast feeds\" is the specific correct mode.\n\n**3. Exam Essentials (High-Yield Facts):**\n\n- Suck-Swallow-Breathe Coordination: Develops by 34 weeks gestation.\n- Absolute Contraindication to Breastfeeding: Galactosemia, Maternal HIV (in developed countries/depending on guidelines), Active TB (until treated).\n\n**4. Logical Learning Aids (Mnemonics & Tricks):**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."}];
        const images = ["data:image/jpeg;base64,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","data:image/jpeg;base64,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"];
        const initialMcqsState = JSON.parse(JSON.stringify(mcqs)); // For exam reset
        let currentMcqs = []; // Can be a subset for practice mode
        let sections = [];
        let answerStates = [];
        let practiceStates = [];
        let currentSectionIndex = 0;
        let currentQuestionIndexInSection = 0;
        let currentPracticeIndex = 0;
        let timerInterval;
        let practiceTimerInterval;
        let perQuestionTimerInterval;
        let timePerMcq = 0;
        let timeOverall = 0;
        let questionStartTime = 0;
        let subjectName, candidateName, shortNote;
        let onConfirmCallback = null;
        let reviewReturnScreen = 'results'; // 'results' or 'practiceResults'
        let isShuffled = false;
        let isReviewingSaved = false;
        // FIX: Changed to string concatenation to avoid nested template literal parsing issues.
        const EXAM_DRAFT_KEY = 'examDraft_' + examId;
        const PRACTICE_DRAFT_KEY = 'practiceDraft_' + examId;
        const SAVED_MCQS_KEY = 'savedMcqs_' + examId;
        const EXAM_RESULTS_HISTORY_KEY = 'examResultsHistory_' + examId;
        const PRACTICE_RESULTS_HISTORY_KEY = 'practiceResultsHistory_' + examId;
        const THEME_KEY = 'examTheme_' + examId;
        let savedMcqIds = [];
        let isSmoothSwipe = true;
        let isSparklesEnabled = true;
        
        // --- GAMIFICATION STATE ---
        let currentStreak = 0;

        const QuestionStatus = {
            NotVisited: 'NOT_VISITED',
            NotAnswered: 'NOT_ANSWERED',
            Answered: 'ANSWERED',
            MarkedForReview: 'MARKED_FOR_REVIEW',
        };
        
        const statusColors = {
            [QuestionStatus.Answered]: 'bg-green-600 hover:bg-green-500',
            [QuestionStatus.NotAnswered]: 'bg-red-600 hover:bg-red-500',
            [QuestionStatus.NotVisited]: 'bg-gray-500 hover:bg-gray-600',
            [QuestionStatus.MarkedForReview]: 'bg-purple-600 hover:bg-purple-500',
        };

        const svgBookmarkOutline = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" style="color: var(--text-secondary);" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>';
        const svgBookmarkSolid = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" style="color: var(--text-accent);" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path></svg>';

        // --- DOM ELEMENTS ---
        const screens = {
            setup: document.getElementById('setup-screen'),
            exam: document.getElementById('exam-screen'),
            results: document.getElementById('results-screen'),
            review: document.getElementById('review-screen'),
            practice: document.getElementById('practice-screen'),
            practiceResults: document.getElementById('practice-results-screen'),
            pastResults: document.getElementById('past-results-screen'),
            progress: document.getElementById('progress-screen'),
        };
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessageEl = document.getElementById('confirmation-message');
        const confirmActionBtn = document.getElementById('confirm-action-btn');
        const cancelConfirmationBtn = document.getElementById('cancel-confirmation-btn');
        const reportOptionsModal = document.getElementById('report-options-modal');
        const calculatorModal = document.getElementById('calculator-modal');
        const questionPalette = document.getElementById('question-palette');
        const paletteContentWrapper = document.getElementById('palette-content-wrapper');
        const hidePaletteBtn = document.getElementById('hide-palette-btn');
        const showPaletteBtn = document.getElementById('show-palette-btn');
        const practiceResumeModal = document.getElementById('practice-resume-modal');
        const savedQuestionsContainer = document.getElementById('saved-questions-container');
        const viewSavedBtn = document.getElementById('view-saved-btn');
        const savedQuestionsCountEl = document.getElementById('saved-questions-count');
        const saveMcqBtn = document.getElementById('save-mcq-btn');
        const saveMcqPracticeBtn = document.getElementById('save-mcq-practice-btn');
        const toggleSparklesBtn = document.getElementById('toggle-sparkles-btn');
        const reviewTitleEl = document.getElementById('review-title');
        const toastEl = document.getElementById('toast-notification');
        
        // --- CONFETTI LOGIC (Gravity Burst) ---
        function triggerConfetti(rect) {
            if (!isSparklesEnabled) return;
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const colors = ['#EF476F', '#FFD166', '#06D6A0', '#118AB2', '#073B4C', '#9D4EDD'];
            
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.style.position = 'fixed';
                particle.style.left = centerX + 'px';
                particle.style.top = centerY + 'px';
                particle.style.width = (Math.random() * 10 + 5) + 'px';
                particle.style.height = particle.style.width;
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                particle.style.zIndex = '9999';
                particle.style.pointerEvents = 'none';
                
                // Random Shapes: Square, Circle, Triangle, Star
                const shapeType = Math.floor(Math.random() * 4);
                if (shapeType === 1) { // Circle
                    particle.style.borderRadius = '50%';
                } else if (shapeType === 2) { // Triangle
                     particle.style.width = '0'; 
                     particle.style.height = '0'; 
                     particle.style.backgroundColor = 'transparent';
                     particle.style.borderLeft = '6px solid transparent';
                     particle.style.borderRight = '6px solid transparent';
                     particle.style.borderBottom = '12px solid ' + colors[Math.floor(Math.random() * colors.length)];
                } else if (shapeType === 3) { // Star (using clip-path)
                     particle.style.clipPath = 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)';
                }
                // shapeType 0 is Square (default)

                document.body.appendChild(particle);

                // Physics variables
                // Burst effect: high velocity, random angle
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 15 + 5; 
                let vx = Math.cos(angle) * velocity;
                let vy = Math.sin(angle) * velocity;
                const gravity = 0.8;
                const drag = 0.96;
                let posX = centerX;
                let posY = centerY;
                let rotation = Math.random() * 360;
                let rotationSpeed = (Math.random() - 0.5) * 20;
                let opacity = 1;

                function animate() {
                    posX += vx;
                    posY += vy;
                    vy += gravity; // Apply gravity
                    vx *= drag;    // Air resistance
                    vy *= drag;
                    rotation += rotationSpeed;
                    opacity -= 0.01;

                    particle.style.left = posX + 'px';
                    particle.style.top = posY + 'px';
                    if (shapeType !== 2) { 
                        particle.style.transform = 'rotate(' + rotation + 'deg)';
                    } else {
                        particle.style.transform = 'rotate(' + rotation + 'deg)';
                    }
                    particle.style.opacity = opacity;

                    if (opacity > 0 && posY < window.innerHeight) {
                        requestAnimationFrame(animate);
                    } else {
                        particle.remove();
                    }
                }
                
                requestAnimationFrame(animate);
            }
        }

        // --- DYNAMIC ISLAND LOGIC ---
        const island = document.getElementById('dynamic-island');
        const islandMinimizeBtn = document.getElementById('island-minimize-btn');
        const islandThemeBtn = document.getElementById('island-theme-btn');
        const islandSettingsBtn = document.getElementById('island-settings-btn');
        const islandProgressBtn = document.getElementById('island-progress-btn');
        const islandHomeBtn = document.getElementById('island-home-btn');
        const swipeIconSmooth = document.getElementById('swipe-icon-smooth');
        const swipeIconHard = document.getElementById('swipe-icon-hard');
        
        let islandIdleTimeout;
        let isMinimized = false;
        
        function resetIslandIdle() {
            if (isMinimized) return; // Don't fade out if minimized (handled by style)
            island.classList.remove('idle');
            if (islandIdleTimeout) clearTimeout(islandIdleTimeout);
            islandIdleTimeout = setTimeout(() => {
                island.classList.add('idle');
            }, 3000);
        }

        // Initialize drag for Dynamic Island
        function initDynamicIsland() {
            // Trigger startup vibration
            island.classList.add('hint-anim');
            setTimeout(() => { island.classList.remove('hint-anim'); }, 1000);

            let isDragging = false;
            let dragOffsetX, dragOffsetY;
            const threshold = 5; // Movement threshold

            const onStart = (clientX, clientY) => {
                if (isMinimized) return;
                
                // Calculate offset from the top-left of the island to the cursor
                const rect = island.getBoundingClientRect();
                dragOffsetX = clientX - rect.left;
                dragOffsetY = clientY - rect.top;
                
                isDragging = false;
                resetIslandIdle();
                
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchmove', onTouchMove, { passive: false });
                document.addEventListener('touchend', onEnd);
            };
            
            const onMove = (e) => handleMove(e.clientX, e.clientY);
            const onTouchMove = (e) => {
                if (isMinimized) return;
                e.preventDefault();
                handleMove(e.touches[0].clientX, e.touches[0].clientY);
            };

            const handleMove = (clientX, clientY) => {
                if (!isDragging) {
                    // Check if moved enough to count as drag
                    isDragging = true;
                    island.classList.add('dragging'); // Disables transition for 1:1 tracking
                    
                    // Clear transform logic used for centering, switch to absolute pos
                    island.style.transform = 'none';
                    island.style.right = 'auto'; 
                    island.style.bottom = 'auto';
                }

                // Move exactly with cursor
                island.style.left = (clientX - dragOffsetX) + 'px';
                island.style.top = (clientY - dragOffsetY) + 'px';
                resetIslandIdle();
            };

            const onEnd = () => {
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchmove', onTouchMove);
                document.removeEventListener('touchend', onEnd);
                
                if (isDragging) {
                    island.classList.remove('dragging'); // Re-enable transition for snap
                    snapIsland();
                }
            };
            
            island.addEventListener('mousedown', (e) => {
                if (isMinimized) return;
                if (e.target.closest('button')) return;
                onStart(e.clientX, e.clientY);
            });
            
            island.addEventListener('touchstart', (e) => {
                if (isMinimized) return;
                if (e.target.closest('button')) return;
                onStart(e.touches[0].clientX, e.touches[0].clientY);
            }, { passive: false });
            
            island.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', resetIslandIdle);
            });
            
            island.addEventListener('click', (e) => {
                if (isMinimized && !e.target.closest('button')) {
                    toggleMinimize();
                }
            });
            
            resetIslandIdle();
        }
        
        function snapIsland() {
            const rect = island.getBoundingClientRect();
            const winW = window.innerWidth;
            const winH = window.innerHeight;
            
            const distTop = rect.top;
            const distBottom = winH - rect.bottom;
            const distLeft = rect.left;
            const distRight = winW - rect.right;
            
            const minDist = Math.min(distTop, distBottom, distLeft, distRight);
            const padding = 20;

            island.classList.remove('horizontal', 'vertical');

            // Snap logic
            if (minDist === distTop) {
                island.style.top = padding + 'px';
                island.style.bottom = 'auto';
                island.classList.add('horizontal');
            } else if (minDist === distBottom) {
                island.style.top = 'auto';
                island.style.bottom = padding + 'px';
                island.classList.add('horizontal');
            } else if (minDist === distLeft) {
                island.style.left = padding + 'px';
                island.style.right = 'auto';
                island.classList.add('vertical');
            } else { // Right
                island.style.left = 'auto';
                island.style.right = padding + 'px';
                island.classList.add('vertical');
            }
            
            // Constrain within window
            const newRect = island.getBoundingClientRect();
            if (island.classList.contains('horizontal')) {
               if(newRect.left < 0) island.style.left = padding + 'px';
               if(newRect.right > winW) island.style.left = (winW - newRect.width - padding) + 'px';
            } else {
               if(newRect.top < 0) island.style.top = padding + 'px';
               if(newRect.bottom > winH) island.style.top = (winH - newRect.height - padding) + 'px';
            }
        }
        
        function toggleMinimize() {
            isMinimized = !isMinimized;
            
            if (isMinimized) {
                island.classList.add('minimized');
                // Force snap to closest wall with 0 padding for the "dash" look
                const rect = island.getBoundingClientRect();
                const winW = window.innerWidth;
                const winH = window.innerHeight;
                
                // Determine orientation based on current class
                if (island.classList.contains('horizontal')) {
                    if (rect.top < winH / 2) { // Top wall
                        island.style.top = '0px';
                        island.style.bottom = 'auto';
                    } else { // Bottom wall
                        island.style.top = 'auto';
                        island.style.bottom = '0px';
                    }
                } else { // Vertical
                     if (rect.left < winW / 2) { // Left wall
                        island.style.left = '0px';
                        island.style.right = 'auto';
                    } else { // Right wall
                        island.style.left = 'auto';
                        island.style.right = '0px';
                    }
                }
            } else {
                island.classList.remove('minimized');
                snapIsland(); // Restore to padded position
                resetIslandIdle();
            }
        }
        
        initDynamicIsland();

        islandMinimizeBtn.addEventListener('click', toggleMinimize);
        
        const themes = ['light', 'dark', 'ambient'];
        islandThemeBtn.addEventListener('click', (e) => {
            const currentTheme = document.documentElement.dataset.theme || 'light';
            const currentIndex = themes.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % themes.length;
            const newTheme = themes[nextIndex];
            
            // Fix: Ensure coordinates are valid for touch/click
            const x = (e.clientX !== undefined && e.clientX !== 0) ? e.clientX : window.innerWidth / 2;
            const y = (e.clientY !== undefined && e.clientY !== 0) ? e.clientY : window.innerHeight / 2;
            
            const endRadius = Math.hypot(
                Math.max(x, innerWidth - x),
                Math.max(y, innerHeight - y)
            );

            // View Transition API for "Sunrise" effect
            if (document.startViewTransition) {
                 const transition = document.startViewTransition(() => {
                    applyTheme(newTheme);
                });

                transition.ready.then(() => {
                    // Animate the clip-path of the new view
                    document.documentElement.animate(
                        {
                            clipPath: [
                                `circle(0px at ${x}px ${y}px)`,
                                `circle(${endRadius}px at ${x}px ${y}px)`
                            ],
                        },
                        {
                            duration: 500,
                            easing: 'ease-in',
                            pseudoElement: '::view-transition-new(root)',
                        }
                    );
                });
            } else {
                // Fallback Animation for devices without View Transition API
                 const themeColors = {
                    'light': '#f3f4f6',
                    'dark': '#374151',
                    'ambient': '#eee8d5'
                };
                
                const overlay = document.createElement('div');
                overlay.style.position = 'fixed';
                overlay.style.top = y + 'px';
                overlay.style.left = x + 'px';
                overlay.style.width = '0px';
                overlay.style.height = '0px';
                overlay.style.borderRadius = '50%';
                overlay.style.backgroundColor = themeColors[newTheme];
                overlay.style.zIndex = '10000';
                overlay.style.transform = 'translate(-50%, -50%)';
                overlay.style.pointerEvents = 'none';
                document.body.appendChild(overlay);
                
                const anim = overlay.animate(
                    [{ width: '0px', height: '0px' }, { width: (endRadius * 2) + 'px', height: (endRadius * 2) + 'px' }],
                    { duration: 500, easing: 'ease-in', fill: 'forwards' }
                );
                
                anim.onfinish = () => {
                    applyTheme(newTheme);
                    overlay.remove();
                };
            }
        });
        
        islandSettingsBtn.addEventListener('click', () => {
            isSmoothSwipe = !isSmoothSwipe;
            if (isSmoothSwipe) {
                document.documentElement.style.setProperty('--swipe-duration', '0.3s');
                swipeIconSmooth.classList.remove('hidden');
                swipeIconHard.classList.add('hidden');
                showToast("Swipe Animation: Smooth");
            } else {
                document.documentElement.style.setProperty('--swipe-duration', '0s');
                swipeIconSmooth.classList.add('hidden');
                swipeIconHard.classList.remove('hidden');
                showToast("Swipe Animation: Instant");
            }
        });
        
        islandProgressBtn.addEventListener('click', () => {
            switchScreen('progress');
            renderProgressCharts();
        });

        islandHomeBtn.addEventListener('click', () => {
            const currentScreenId = document.querySelector('.screen.active')?.id;
            const goHome = () => {
                 if (document.startViewTransition) {
                     document.startViewTransition(() => switchScreen('setup'));
                 } else {
                     switchScreen('setup');
                 }
            };
            
            if (currentScreenId === 'exam-screen') {
                showConfirmation("Exit exam and go home? Progress is saved locally.", () => {
                    saveExamDraft();
                    goHome();
                });
            } else if (currentScreenId === 'practice-screen') {
                 showConfirmation("Exit practice session?", () => {
                    savePracticeDraft();
                    goHome();
                 });
            } else {
                goHome();
            }
        });

        // --- THEME LOGIC ---
        function applyTheme(theme) {
            document.documentElement.dataset.theme = theme;
            try {
                localStorage.setItem(THEME_KEY, theme);
            } catch (e) { console.error('Failed to save theme'); }
        }

        // --- UTILS ---
        let toastTimeout;
        function showToast(message) {
            if (toastTimeout) clearTimeout(toastTimeout);
            toastEl.textContent = message;
            toastEl.classList.add('show');
            toastTimeout = setTimeout(() => {
                toastEl.classList.remove('show');
            }, 3000);
        }
        
        function animateButton(buttonEl) {
            buttonEl.classList.remove('pop-animation');
            // This is a trick to restart the animation
            void buttonEl.offsetWidth; 
            buttonEl.classList.add('pop-animation');
        }

        function showConfirmation(message, onConfirm) {
            onConfirmCallback = onConfirm;
            confirmationMessageEl.textContent = message;
            confirmationModal.classList.remove('hidden');
            confirmationModal.classList.add('flex');
        }

        function hideConfirmation() {
            onConfirmCallback = null;
            confirmationModal.classList.add('hidden');
            confirmationModal.classList.remove('flex');
        }

        confirmActionBtn.addEventListener('click', () => {
            if (onConfirmCallback) {
                onConfirmCallback();
            }
            hideConfirmation();
        });

        cancelConfirmationBtn.addEventListener('click', hideConfirmation);

        // --- HISTORY API INTEGRATION ---
        
        // Initialize history state on load
        window.history.replaceState({ screen: 'setup' }, '', '#setup');

        function switchScreen(screenName, pushToHistory = true) {
            Object.values(screens).forEach(screen => {
                if(screen) screen.classList.remove('active');
            });
            if(screens[screenName]) {
                screens[screenName].classList.add('active');
                if (pushToHistory) {
                    window.history.pushState({ screen: screenName }, '', '#' + screenName);
                }
            }
        }

        window.addEventListener('popstate', (event) => {
            const activeScreen = document.querySelector('.screen.active');
            const activeId = activeScreen ? activeScreen.id : 'setup-screen';

            // GUARD: Prevent exiting Exam Mode accidentally
            if (activeId === 'exam-screen') {
                // Push state back immediately to maintain URL/State stability while showing modal
                window.history.pushState({ screen: 'exam' }, '', '#exam');
                showConfirmation("Are you sure you want to exit the exam? Your progress will be saved.", () => {
                    // If confirmed, proceed to finish exam (which goes to results)
                    handleNextSection(); 
                });
                return;
            }

            // GUARD: Prevent exiting Practice Mode accidentally
            if (activeId === 'practice-screen') {
                 window.history.pushState({ screen: 'practice' }, '', '#practice');
                 showConfirmation("Are you sure you want to exit practice mode?", () => {
                    if (practiceTimerInterval) clearInterval(practiceTimerInterval);
                    if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
                    recordTime(currentMcqs[currentPracticeIndex].id, practiceStates);
                    showPracticeResults();
                 });
                 return;
            }

            // Normal Navigation handling
            if (event.state && event.state.screen) {
                switchScreen(event.state.screen, false); // false = don't push again
            } else {
                switchScreen('setup', false);
            }
        });

        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function formatTime(seconds) {
            const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
            const secs = String(seconds % 60).padStart(2, '0');
            return mins + ':' + secs;
        }
        
        function formatTimeDetailed(seconds) {
            if (seconds < 60) return Math.round(seconds) + 's';
            const mins = Math.floor(seconds / 60);
            const secs = Math.round(seconds % 60);
            return mins + 'm ' + secs + 's';
        }

        function processQuestionContent(text, imageContainerId) {
            const imageContainer = document.getElementById(imageContainerId);
            imageContainer.innerHTML = ''; // Clear previous image

            const imageRegex = /{image\s+(\d+)}/g;
            let processedText = text;
            
            let match;
            const displayedImageIndices = new Set();
            while ((match = imageRegex.exec(text)) !== null) {
                const imageIndex = parseInt(match[1], 10) - 1;
                if (images[imageIndex] && !displayedImageIndices.has(imageIndex)) {
                    const img = document.createElement('img');
                    img.src = images[imageIndex];
                    img.alt = 'Illustration for question';
                    img.className = 'max-w-full max-h-96 object-contain rounded-md shadow-sm border mx-auto themed-border-primary';
                    imageContainer.appendChild(img);
                    displayedImageIndices.add(imageIndex);
                }
                processedText = processedText.replace(match[0], '');
            }
            
            return processedText.trim();
        }

        // --- TIME TRACKING LOGIC ---
        function recordTime(mcqId, stateCollection) {
            if (!mcqId || !questionStartTime) return;
            const state = stateCollection.find(s => s.mcqId === mcqId);
            if (state) {
                const elapsed = (Date.now() - questionStartTime) / 1000; // in seconds
                state.timeTaken = (state.timeTaken || 0) + elapsed;
            }
        }

        // --- DRAFT LOGIC ---
        function saveExamDraft() {
            try {
                recordTime(currentMCQ.id, answerStates);
                const draft = {
                    mcqs: currentMcqs, // Save potentially shuffled list
                    sections,
                    answerStates,
                    currentSectionIndex,
                    currentQuestionIndexInSection,
                    subjectName,
                    candidateName,
                    shortNote,
                    isShuffled,
                };
                localStorage.setItem(EXAM_DRAFT_KEY, JSON.stringify(draft));
                questionStartTime = Date.now(); // Reset timer after saving
            } catch (e) {
                console.error("Failed to save exam draft:", e);
            }
        }
        
        function savePracticeDraft() {
            try {
                recordTime(currentMcqs[currentPracticeIndex].id, practiceStates);
                const draft = {
                    mcqs: currentMcqs, // Save the subset of MCQs
                    practiceStates,
                    currentPracticeIndex,
                    subjectName,
                    candidateName,
                    isShuffled,
                    timePerMcq,
                    timeOverall,
                    currentStreak, // Save streak
                };
                localStorage.setItem(PRACTICE_DRAFT_KEY, JSON.stringify(draft));
                questionStartTime = Date.now(); // Reset timer after saving
            } catch (e) {
                console.error("Failed to save practice draft:", e);
            }
        }

        function clearExamDraft() { localStorage.removeItem(EXAM_DRAFT_KEY); }
        function clearPracticeDraft() { localStorage.removeItem(PRACTICE_DRAFT_KEY); }
        
        // --- SAVED QUESTIONS LOGIC ---
        function updateSavedQuestionsUI() {
            if (savedMcqIds.length > 0) {
                savedQuestionsCountEl.textContent = savedMcqIds.length;
                savedQuestionsContainer.classList.remove('hidden');
            } else {
                savedQuestionsContainer.classList.add('hidden');
            }
        }

        function toggleSaveMcq() {
            const mcq = currentMcqs[reviewQuestionIndex];
            if (!mcq) return;

            const mcqId = mcq.id;
            const index = savedMcqIds.indexOf(mcqId);
            let message = '';

            if (index > -1) {
                savedMcqIds.splice(index, 1);
                message = 'Question Unsaved!';
            } else {
                savedMcqIds.push(mcqId);
                message = 'Question Saved!';
                animateButton(saveMcqBtn);
            }

            showToast(message);
            localStorage.setItem(SAVED_MCQS_KEY, JSON.stringify(savedMcqIds));
            updateSaveButtonState();
            updateSavedQuestionsUI();

            if (isReviewingSaved && savedMcqIds.length === 0) {
                alert("You have no saved questions.");
                switchScreen('setup');
            } else if (isReviewingSaved) {
                // Refresh the view if an item is removed
                currentMcqs = initialMcqsState.filter(mcq => savedMcqIds.includes(mcq.id));
                if (reviewQuestionIndex >= currentMcqs.length) {
                    reviewQuestionIndex = Math.max(0, currentMcqs.length - 1);
                }
                renderReviewPalette();
                renderReviewQuestion();
            }
        }
        
        function toggleSavePracticeMcq() {
            const mcq = currentMcqs[currentPracticeIndex];
            if (!mcq) return;

            const mcqId = mcq.id;
            const index = savedMcqIds.indexOf(mcqId);
            let message = '';

            if (index > -1) {
                savedMcqIds.splice(index, 1);
                message = 'Question Unsaved!';
            } else {
                savedMcqIds.push(mcqId);
                message = 'Question Saved!';
                animateButton(saveMcqPracticeBtn);
            }
            
            showToast(message);
            localStorage.setItem(SAVED_MCQS_KEY, JSON.stringify(savedMcqIds));
            updatePracticeSaveButtonState();
            updateSavedQuestionsUI();
        }

        function updateSaveButtonState() {
            const mcq = currentMcqs[reviewQuestionIndex];
            if (!mcq) return;

            if (savedMcqIds.includes(mcq.id)) {
                saveMcqBtn.innerHTML = svgBookmarkSolid;
                saveMcqBtn.setAttribute('aria-label', 'Unsave Question');
            } else {
                saveMcqBtn.innerHTML = svgBookmarkOutline;
                saveMcqBtn.setAttribute('aria-label', 'Save Question');
            }
        }
        
        function updatePracticeSaveButtonState() {
            const mcq = currentMcqs[currentPracticeIndex];
            if (!mcq) return;

            if (savedMcqIds.includes(mcq.id)) {
                saveMcqPracticeBtn.innerHTML = svgBookmarkSolid;
                saveMcqPracticeBtn.setAttribute('aria-label', 'Unsave Question');
            } else {
                saveMcqPracticeBtn.innerHTML = svgBookmarkOutline;
                saveMcqPracticeBtn.setAttribute('aria-label', 'Save Question');
            }
        }

        // --- PALETTE VISIBILITY LOGIC ---
        if(hidePaletteBtn && showPaletteBtn && questionPalette && paletteContentWrapper) {
            hidePaletteBtn.addEventListener('click', () => {
                questionPalette.classList.remove('w-64');
                questionPalette.classList.add('w-0');
                paletteContentWrapper.classList.add('opacity-0');
                hidePaletteBtn.classList.add('hidden');
                showPaletteBtn.classList.remove('hidden');
            });

            showPaletteBtn.addEventListener('click', () => {
                questionPalette.classList.remove('w-0');
                questionPalette.classList.add('w-64');
                paletteContentWrapper.classList.remove('opacity-0');
                showPaletteBtn.classList.add('hidden');
                hidePaletteBtn.classList.remove('hidden');
            });
        }

        // --- CALCULATOR LOGIC ---
        const calculatorHeader = document.getElementById('calculator-header');
        const calculatorCloseBtn = document.getElementById('calculator-close-btn');
        const calculatorDisplay = document.getElementById('calculator-display');
        const calculatorButtons = document.getElementById('calculator-buttons');
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };

        function toggleCalculator(buttonEl) {
            const wasHidden = calculatorModal.classList.contains('hidden');
            
            if (wasHidden) {
                const rect = buttonEl.getBoundingClientRect();
                const calculatorWidth = 256; // Corresponds to Tailwind's w-64 class
                
                // Position it below the button, accounting for page scroll
                calculatorModal.style.top = (rect.bottom + window.scrollY + 10) + 'px';
                
                // Center it horizontally under the button
                let leftPos = rect.left + window.scrollX + (rect.width / 2) - (calculatorWidth / 2);
                
                // Constrain to viewport horizontal edges
                const minLeft = window.scrollX + 8;
                const maxLeft = window.scrollX + window.innerWidth - calculatorWidth - 8;
                leftPos = Math.max(minLeft, Math.min(leftPos, maxLeft));

                calculatorModal.style.left = leftPos + 'px';
            }
             
            calculatorModal.classList.toggle('hidden');
        }
        document.getElementById('calculator-toggle-btn').addEventListener('click', (e) => toggleCalculator(e.currentTarget));
        document.getElementById('practice-calculator-toggle-btn').addEventListener('click', (e) => toggleCalculator(e.currentTarget));
        
        calculatorCloseBtn.addEventListener('click', () => {
            calculatorModal.classList.add('hidden');
        });

        function dragStart(clientX, clientY) {
            isDragging = true;
            dragOffset.x = clientX - calculatorModal.offsetLeft;
            dragOffset.y = clientY - calculatorModal.offsetTop;
            calculatorModal.classList.add('dragging');
            document.body.style.userSelect = 'none'; // Prevent text selection
        }

        function dragMove(clientX, clientY) {
            if (!isDragging) return;
            const newX = clientX - dragOffset.x;
            const newY = clientY - dragOffset.y;
            const maxX = window.innerWidth - calculatorModal.offsetWidth;
            const maxY = window.innerHeight - calculatorModal.offsetHeight;
            calculatorModal.style.left = Math.max(0, Math.min(newX, maxX)) + 'px';
            calculatorModal.style.top = Math.max(0, Math.min(newY, maxY)) + 'px';
        }

        function dragEnd() {
            if (!isDragging) return;
            isDragging = false;
            calculatorModal.classList.remove('dragging');
            document.body.style.userSelect = '';
        }

        // Mouse Events
        calculatorHeader.addEventListener('mousedown', (e) => {
            e.preventDefault();
            dragStart(e.clientX, e.clientY);
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                dragMove(e.clientX, e.clientY);
            }
        });
        
        document.addEventListener('mouseup', dragEnd);

        // Touch Events
        calculatorHeader.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                dragStart(e.touches[0].clientX, e.touches[0].clientY);
            }
        }, { passive: true });

        document.addEventListener('touchmove', (e) => {
            if (isDragging && e.touches.length === 1) {
                e.preventDefault(); // Prevent scrolling while dragging
                dragMove(e.touches[0].clientX, e.touches[0].clientY);
            }
        }, { passive: false });

        document.addEventListener('touchend', dragEnd);
        document.addEventListener('touchcancel', dragEnd);


        const calculatorState = {
            displayValue: '0',
            fullExpression: '', // Holds the full visual string e.g. "6+5"
            firstOperand: null,
            waitingForSecondOperand: false,
            operator: null,
            isResultDisplayed: false
        };

        function updateCalculatorDisplay() {
            calculatorDisplay.textContent = calculatorState.fullExpression || '0';
            calculatorDisplay.scrollLeft = calculatorDisplay.scrollWidth;
        }

        function inputDigit(digit) {
            if (calculatorState.isResultDisplayed) {
                calculatorState.fullExpression = digit;
                calculatorState.displayValue = digit;
                calculatorState.firstOperand = null;
                calculatorState.waitingForSecondOperand = false;
                calculatorState.operator = null;
                calculatorState.isResultDisplayed = false;
                return;
            }

            // Append to full expression, replacing single '0' unless digit is '.'
            if (calculatorState.fullExpression === '0') {
                calculatorState.fullExpression = digit;
            } else {
                calculatorState.fullExpression += digit;
            }

            const { displayValue, waitingForSecondOperand } = calculatorState;
            if (waitingForSecondOperand) {
                calculatorState.displayValue = digit;
                calculatorState.waitingForSecondOperand = false;
            } else {
                calculatorState.displayValue = displayValue === '0' ? digit : displayValue + digit;
            }
        }

        function inputDecimal(dot) {
            if (calculatorState.isResultDisplayed) {
                calculatorState.displayValue = '0.';
                calculatorState.fullExpression = '0.';
                calculatorState.firstOperand = null;
                calculatorState.waitingForSecondOperand = false;
                calculatorState.operator = null;
                calculatorState.isResultDisplayed = false;
                return;
            }

            if (calculatorState.waitingForSecondOperand) {
                calculatorState.displayValue = '0.';
                calculatorState.waitingForSecondOperand = false;
                calculatorState.fullExpression += '0.';
                return;
            }
            if (!calculatorState.displayValue.includes(dot)) {
                calculatorState.displayValue += dot;
                calculatorState.fullExpression += dot;
            }
        }
        
        const performCalculation = {
            '/': (first, second) => second === 0 ? 'Error' : first / second,
            '*': (first, second) => first * second,
            '+': (first, second) => first + second,
            '-': (first, second) => first - second,
        };

        function handleOperator(nextOperator) {
            if (calculatorState.isResultDisplayed) {
                // If starting new operation on result, keep result in display
                calculatorState.fullExpression = calculatorState.displayValue + nextOperator;
                calculatorState.isResultDisplayed = false;
            } else {
                calculatorState.fullExpression += nextOperator;
            }

            const { firstOperand, displayValue, operator } = calculatorState;
            const inputValue = parseFloat(displayValue);

            if (operator && calculatorState.waitingForSecondOperand) {
                calculatorState.operator = nextOperator;
                return;
            }

            if (firstOperand === null) {
                calculatorState.firstOperand = inputValue;
            } else if (operator) {
                const result = performCalculation[operator](firstOperand, inputValue);
                if (result === 'Error') {
                    calculatorState.displayValue = 'Error';
                    calculatorState.fullExpression = 'Error';
                } else {
                    // Truncate long decimals to avoid display issues
                    const resStr = String(parseFloat(result.toFixed(7)));
                    calculatorState.displayValue = resStr;
                }
                calculatorState.firstOperand = result === 'Error' ? null : result;
            }
            
            calculatorState.waitingForSecondOperand = true;
            calculatorState.operator = nextOperator;
        }

        function resetCalculator() {
            calculatorState.displayValue = '0';
            calculatorState.fullExpression = '';
            calculatorState.firstOperand = null;
            calculatorState.waitingForSecondOperand = false;
            calculatorState.operator = null;
            calculatorState.isResultDisplayed = false;
        }

        calculatorButtons.addEventListener('click', (event) => {
            const { target } = event;
            if (!target.matches('button')) return;

            if (calculatorState.displayValue === 'Error' && target.textContent !== 'C') return;

            if (target.classList.contains('digit')) { inputDigit(target.textContent); }
            else if (target.classList.contains('decimal')) { inputDecimal(target.textContent); }
            else if (target.classList.contains('operator')) { handleOperator(target.textContent); }
            else if (target.textContent === 'C') { resetCalculator(); }
            else if (target.classList.contains('equals')) {
                 if (calculatorState.operator && calculatorState.firstOperand !== null) {
                    const inputValue = parseFloat(calculatorState.displayValue);
                    const result = performCalculation[calculatorState.operator](calculatorState.firstOperand, inputValue);
                    
                    let resultStr = 'Error';
                    if (result !== 'Error') {
                         resultStr = String(parseFloat(result.toFixed(7)));
                    }
                    
                    calculatorState.displayValue = resultStr;
                    calculatorState.fullExpression += '=' + resultStr; // Append =Result
                    
                    calculatorState.firstOperand = null;
                    calculatorState.operator = null;
                    calculatorState.waitingForSecondOperand = false;
                    calculatorState.isResultDisplayed = true;
                }
            }
            updateCalculatorDisplay();
        });

        function handleCalculatorKeyPress(event) {
            if (calculatorModal.classList.contains('hidden')) return;

            const { key } = event;
            let buttonToAnimate;
            
            const buttons = Array.from(calculatorButtons.querySelectorAll('button'));

            if (key >= '0' && key <= '9') {
                inputDigit(key);
                buttonToAnimate = buttons.find(b => b.textContent === key && b.classList.contains('digit'));
            } else if (key === '.') {
                inputDecimal(key);
                buttonToAnimate = buttons.find(b => b.textContent === key && b.classList.contains('decimal'));
            } else if (['+', '-', '*', '/'].includes(key)) {
                handleOperator(key);
                buttonToAnimate = buttons.find(b => b.textContent === key && b.classList.contains('operator'));
            } else if (key === 'Enter' || key === '=') {
                event.preventDefault();
                if (calculatorState.operator && calculatorState.firstOperand !== null) {
                     const inputValue = parseFloat(calculatorState.displayValue);
                     const result = performCalculation[calculatorState.operator](calculatorState.firstOperand, inputValue);
                     let resultStr = 'Error';
                     if (result !== 'Error') { resultStr = String(parseFloat(result.toFixed(7))); }
                     calculatorState.displayValue = resultStr;
                     calculatorState.fullExpression += '=' + resultStr;
                     
                     calculatorState.firstOperand = null;
                     calculatorState.operator = null;
                     calculatorState.waitingForSecondOperand = false;
                     calculatorState.isResultDisplayed = true;
                }
                buttonToAnimate = buttons.find(b => b.classList.contains('equals'));
            } else if (key === 'Escape') {
                calculatorModal.classList.add('hidden');
                buttonToAnimate = calculatorCloseBtn;
            } else if (key === 'Backspace' || key.toLowerCase() === 'c') {
                resetCalculator();
                buttonToAnimate = buttons.find(b => b.textContent === 'C');
            }

            if (buttonToAnimate) {
                buttonToAnimate.classList.add('key-press-feedback');
                setTimeout(() => {
                    buttonToAnimate.classList.remove('key-press-feedback');
                }, 100);
            }
            
            if (['0','1','2','3','4','5','6','7','8','9','.','+','-','*','/','Enter','=','Backspace','c','C'].includes(key)) {
                updateCalculatorDisplay();
            }
        }
        document.addEventListener('keydown', handleCalculatorKeyPress);


        // --- SETUP SCREEN LOGIC ---
        const sectionsContainer = document.getElementById('sections-container');
        const setupErrorEl = document.getElementById('setup-error');
        
        function renderSections() {
            sectionsContainer.innerHTML = '';
            sections.forEach((section, index) => {
                const sectionEl = document.createElement('div');
                sectionEl.className = 'p-4 rounded-md flex items-center space-x-3 themed-bg-tertiary';
                const removeButtonHtml = sections.length > 1
                    ? '<button data-index="' + index + '" class="remove-section-btn themed-text-danger text-2xl">\u00d7</button>'
                    : '';
                
                sectionEl.innerHTML =
                    '<input type="text" value="' + section.name + '" data-index="' + index + '" data-field="name" class="section-input p-2 rounded w-1/4 border" placeholder="Section Name"/>' +
                    '<input type="number" value="' + section.startQuestion + '" data-index="' + index + '" data-field="startQuestion" class="section-input p-2 rounded w-1/5 border" placeholder="Start"/>' +
                    '<span class="themed-text-tertiary">to</span>' +
                    '<input type="number" value="' + section.endQuestion + '" data-index="' + index + '" data-field="endQuestion" class="section-input p-2 rounded w-1/5 border" placeholder="End"/>' +
                    '<input type="number" value="' + section.duration + '" data-index="' + index + '" data-field="duration" class="section-input p-2 rounded w-1/5 border" placeholder="Duration (min)"/>' +
                    removeButtonHtml;
                sectionsContainer.appendChild(sectionEl);
            });
        }

        document.getElementById('add-section-btn').addEventListener('click', () => {
            const lastSection = sections[sections.length - 1];
            const nextStart = lastSection.endQuestion + 1;
            if (nextStart > mcqs.length) return;
            sections.push({ name: 'Section ' + (sections.length + 1), startQuestion: nextStart, endQuestion: mcqs.length, duration: mcqs.length - nextStart + 1 });
            renderSections();
        });

        document.getElementById('auto-set-sections-btn').addEventListener('click', () => {
            if (!mcqs || mcqs.length === 0) return;
            
            sections = [];
            const chunkSize = 50;
            let currentStart = 1;
            let idx = 1;
            
            while (currentStart <= mcqs.length) {
                let currentEnd = Math.min(currentStart + chunkSize - 1, mcqs.length);
                sections.push({
                    name: 'Section ' + idx,
                    startQuestion: currentStart,
                    endQuestion: currentEnd,
                    duration: (currentEnd - currentStart + 1) // 1 minute per question
                });
                currentStart = currentEnd + 1;
                idx++;
            }
            renderSections();
            showToast("Sections auto-configured");
        });

        sectionsContainer.addEventListener('change', (e) => {
            const target = e.target;
            if (target.classList.contains('section-input')) {
                const { index, field } = target.dataset;
                const value = field === 'name' ? target.value : parseInt(target.value, 10);
                sections[index][field] = value;
            }
        });
        
        sectionsContainer.addEventListener('click', (e) => {
            const target = e.target;
            if(target.classList.contains('remove-section-btn')) {
                const { index } = target.dataset;
                sections.splice(parseInt(index, 10), 1);
                renderSections();
            }
        });

        document.getElementById('revise-btn').addEventListener('click', () => {
            setupErrorEl.textContent = '';
            subjectName = document.getElementById('subject-name').value;
            candidateName = document.getElementById('candidate-name').value;
            
            // Use full, unshuffled set for revision
            currentMcqs = [...initialMcqsState]; 
            answerStates = currentMcqs.map(mcq => ({ mcqId: mcq.id, status: QuestionStatus.NotVisited, selectedOption: undefined, timeTaken: 0 }));
            reviewQuestionIndex = 0;
            switchScreen('review');
            setupReviewScreen(true, false); // isReviseMode = true
        });

        document.getElementById('start-exam-btn').addEventListener('click', () => {
            setupErrorEl.textContent = '';
            subjectName = document.getElementById('subject-name').value;
            candidateName = document.getElementById('candidate-name').value;
            shortNote = document.getElementById('short-note').value;
            
            let questionSet = new Set();
            for(const section of sections) {
                if(section.startQuestion > section.endQuestion || section.startQuestion < 1 || section.endQuestion > mcqs.length) {
                    setupErrorEl.textContent = 'Invalid range in ' + section.name + '.'; return;
                }
                if(section.duration <= 0) {
                    setupErrorEl.textContent = 'Duration must be positive in ' + section.name + '.'; return;
                }
                for(let i = section.startQuestion; i <= section.endQuestion; i++) {
                    if(questionSet.has(i)) {
                        setupErrorEl.textContent = 'Question ' + i + ' is in multiple sections.'; return;
                    }
                    questionSet.add(i);
                }
            }
            if (questionSet.size !== mcqs.length && mcqs.length > 0) {
                 const allCoveredQuestions = Array.from(questionSet).sort((a,b) => a-b);
                 if (allCoveredQuestions.length !== mcqs.length || allCoveredQuestions[allCoveredQuestions.length - 1] !== mcqs.length) {
                    setupErrorEl.textContent = 'All questions must be covered exactly once across all sections.'; return;
                 }
            }
            
            startExam();
        });
        
        function initializeSetup() {
            sections = [{ name: 'Section 1', startQuestion: 1, endQuestion: mcqs.length, duration: mcqs.length }];
            renderSections();
            const qCountSlider = document.getElementById('practice-q-count-slider');
            const qCountLabel = document.getElementById('practice-q-count-label');
            if(qCountSlider) {
                qCountSlider.addEventListener('input', () => {
                    qCountLabel.textContent = qCountSlider.value;
                });
            }
        }

        function confirmAndProceedToNextSection() {
            const isLastSection = currentSectionIndex === sections.length - 1;
            const message = isLastSection
                ? "Are you sure you want to submit the exam? This will end the test."
                : "Are you sure you want to submit this section? You will not be able to return to it.";
            showConfirmation(message, handleNextSection);
        }


        // --- EXAM LOGIC ---
        let currentSectionMCQs = [];
        let currentMCQ;

        function startExam() {
            isShuffled = document.getElementById('shuffle-mcqs-checkbox').checked;
            let baseMcqs = JSON.parse(JSON.stringify(initialMcqsState));

            if (isShuffled) {
                // Shuffle questions *within* each section's defined range
                sections.forEach(section => {
                    const startIndex = section.startQuestion - 1;
                    const endIndex = section.endQuestion;
                    const sectionSlice = baseMcqs.slice(startIndex, endIndex);
                    shuffleArray(sectionSlice);
                    // Replace the original slice with the shuffled one
                    baseMcqs.splice(startIndex, sectionSlice.length, ...sectionSlice);
                });
            }
            
            currentMcqs.length = 0;
            Array.prototype.push.apply(currentMcqs, baseMcqs);


            answerStates = currentMcqs.map(mcq => ({ mcqId: mcq.id, status: QuestionStatus.NotVisited, selectedOption: undefined, timeTaken: 0 }));
            currentSectionIndex = 0;
            currentQuestionIndexInSection = 0;
            loadSection();
            switchScreen('exam');
        }

        function loadSection() {
            if (timerInterval) clearInterval(timerInterval);

            const section = sections[currentSectionIndex];
            document.getElementById('section-name').textContent = section.name;
            
            // Get questions for the current section from the (potentially shuffled) main list
            currentSectionMCQs = currentMcqs.slice(section.startQuestion - 1, section.endQuestion);
            
            loadQuestion();
            renderPalette();

            let timeLeft = section.duration * 60;
            const timerEl = document.getElementById('timer');
            timerEl.textContent = formatTime(timeLeft);
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = formatTime(timeLeft);
                if (timeLeft <= 0) {
                    handleNextSection();
                }
            }, 1000);
        }
        
        function loadQuestion() {
            currentMCQ = currentSectionMCQs[currentQuestionIndexInSection];
            const answerState = answerStates.find(a => a.mcqId === currentMCQ.id);

            if (answerState.status === QuestionStatus.NotVisited) {
                answerState.status = QuestionStatus.NotAnswered;
            }
            
            document.getElementById('question-counter').textContent = 'Question ' + (currentQuestionIndexInSection + 1) + ' of ' + currentSectionMCQs.length;
            document.getElementById('question-text').innerHTML = processQuestionContent(currentMCQ.question, 'question-image-container');
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            Object.keys(currentMCQ.options).forEach(key => {
                const isSelected = answerState.selectedOption === key;
                const optionEl = document.createElement('label');
                const selectedClass = isSelected ? 'selected' : '';
                optionEl.className = 'option-label flex items-center p-4 rounded-lg cursor-pointer border-2 ' + selectedClass;
                optionEl.innerHTML =
                    '<input type="radio" name="option" value="' + key + '" ' + (isSelected ? 'checked' : '') + ' class="hidden"/>' +
                    '<span class="radio-circle w-6 h-6 rounded-full border-2 themed-border-secondary mr-4 flex-shrink-0 relative"></span>' +
                    '<span class="flex-1">' + key.toUpperCase() + '. ' + currentMCQ.options[key] + '</span>';
                optionsContainer.appendChild(optionEl);
            });

            const saveNextBtn = document.getElementById('save-next-btn');
            if (currentQuestionIndexInSection === currentSectionMCQs.length - 1) {
                saveNextBtn.textContent = 'Submit Section';
            } else {
                saveNextBtn.textContent = 'Save & Next';
            }
            
            document.getElementById('prev-btn').disabled = currentQuestionIndexInSection === 0;
            updatePaletteItem(currentMCQ.id);
            updatePaletteLegendCounts();
            saveExamDraft(); // Auto-save on every question load
            questionStartTime = Date.now();
        }

        document.getElementById('options-container').addEventListener('change', e => {
            const target = e.target;
            if (target.name === 'option') {
                const answerState = answerStates.find(a => a.mcqId === currentMCQ.id);
                const newStatus = answerState.status === QuestionStatus.MarkedForReview ? QuestionStatus.MarkedForReview : QuestionStatus.Answered;
                answerState.selectedOption = target.value;
                answerState.status = newStatus;
                loadQuestion(); // Re-render to show selection and auto-save
            }
        });

        function navigateQuestion(offset) {
            recordTime(currentMCQ.id, answerStates);
            const newIndex = currentQuestionIndexInSection + offset;
            if (newIndex >= 0 && newIndex < currentSectionMCQs.length) {
                currentQuestionIndexInSection = newIndex;
                loadQuestion();
            } else if (newIndex >= currentSectionMCQs.length) {
                confirmAndProceedToNextSection();
            }
        }

        document.getElementById('save-next-btn').addEventListener('click', () => navigateQuestion(1));
        document.getElementById('prev-btn').addEventListener('click', () => navigateQuestion(-1));

        document.getElementById('mark-review-btn').addEventListener('click', () => {
            const answerState = answerStates.find(a => a.mcqId === currentMCQ.id);
            answerState.status = answerState.status === QuestionStatus.MarkedForReview 
                ? (answerState.selectedOption ? QuestionStatus.Answered : QuestionStatus.NotAnswered)
                : QuestionStatus.MarkedForReview;
            updatePaletteItem(currentMCQ.id);
            updatePaletteLegendCounts();
            navigateQuestion(1);
        });

        document.getElementById('clear-response-btn').addEventListener('click', () => {
            const answerState = answerStates.find(a => a.mcqId === currentMCQ.id);
            answerState.selectedOption = undefined;
            answerState.status = QuestionStatus.NotAnswered;
            loadQuestion();
        });

        function handleNextSection() {
            recordTime(currentMCQ.id, answerStates);
            if (currentSectionIndex < sections.length - 1) {
                currentSectionIndex++;
                currentQuestionIndexInSection = 0;
                loadSection();
            } else {
                clearInterval(timerInterval);
                showResults();
            }
        }

        // --- PALETTE LOGIC ---
        function updatePaletteLegendCounts() {
            const sectionMCQIds = new Set(currentSectionMCQs.map(mcq => mcq.id));

            const counts = {
                [QuestionStatus.Answered]: 0,
                [QuestionStatus.NotAnswered]: 0,
                [QuestionStatus.NotVisited]: 0,
                [QuestionStatus.MarkedForReview]: 0,
            };

            answerStates.forEach(state => {
                if (sectionMCQIds.has(state.mcqId)) {
                    counts[state.status]++;
                }
            });

            document.getElementById('answered-count').textContent = String(counts[QuestionStatus.Answered]);
            document.getElementById('not-answered-count').textContent = String(counts[QuestionStatus.NotAnswered]);
            document.getElementById('not-visited-count').textContent = String(counts[QuestionStatus.NotVisited]);
            document.getElementById('marked-for-review-count').textContent = String(counts[QuestionStatus.MarkedForReview]);
        }

        function renderPalette() {
            const paletteContainer = document.getElementById('palette-container');
            paletteContainer.innerHTML = '';
            currentSectionMCQs.forEach((mcq, index) => {
                const answerState = answerStates.find(a => a.mcqId === mcq.id);
                const btn = document.createElement('button');
                btn.id = 'palette-item-' + mcq.id;
                btn.dataset.index = String(index);
                btn.className = 'h-10 w-10 flex items-center justify-center rounded text-white font-bold relative ' + statusColors[answerState.status];
                btn.innerHTML = (index + 1);
                // Accessibility: Add dynamic aria-label
                btn.setAttribute('aria-label', 'Go to question ' + (index + 1));
                if (answerState.status === QuestionStatus.MarkedForReview) {
                    btn.innerHTML += '<svg xmlns="http://www.w3.org/2000/svg" class="absolute bottom-1 right-1 h-3 w-3 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z" /></svg>';
                }
                btn.addEventListener('click', () => {
                    recordTime(currentMCQ.id, answerStates);
                    currentQuestionIndexInSection = parseInt(btn.dataset.index, 10);
                    loadQuestion();
                });
                paletteContainer.appendChild(btn);
            });
        }

        function updatePaletteItem(mcqId) {
            const btn = document.getElementById('palette-item-' + mcqId);
            if (!btn) return;
            const answerState = answerStates.find(a => a.mcqId === mcqId);
            btn.className = 'h-10 w-10 flex items-center justify-center rounded text-white font-bold relative ' + statusColors[answerState.status];
            btn.innerHTML = String(parseInt(btn.dataset.index, 10) + 1);
            if (answerState.status === QuestionStatus.MarkedForReview) {
                btn.innerHTML += '<svg xmlns="http://www.w3.org/2000/svg" class="absolute bottom-1 right-1 h-3 w-3 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z" /></svg>';
            }
        }

        // --- RESULTS LOGIC ---
        function showResults() {
            clearExamDraft();
            const shortNoteHtml = shortNote ? '<p><span class="font-bold">Notes:</span> ' + shortNote + '</p>' : '';
            const detailsHtml =
                '<p><span class="font-bold">Subject:</span> ' + (subjectName || 'N/A') + '</p>' +
                '<p><span class="font-bold">Candidate:</span> ' + (candidateName || 'N/A') + '</p>' +
                shortNoteHtml;
            document.getElementById('exam-details').innerHTML = detailsHtml;

            const results = sections.map(section => {
                let correct = 0, incorrect = 0, unanswered = 0;
                // Use the section's original question indices to find the right questions in the shuffled list
                const sectionQs = currentMcqs.slice(section.startQuestion - 1, section.endQuestion);
                sectionQs.forEach(mcq => {
                    const answerState = answerStates.find(a => a.mcqId === mcq.id);
                    if(answerState) {
                        if(!answerState.selectedOption) unanswered++;
                        else if(answerState.selectedOption === mcq.correctAnswer) correct++;
                        else incorrect++;
                    }
                });

                const total = correct + incorrect + unanswered;
                return { name: section.name, correct, incorrect, unanswered, total, score: total > 0 ? (correct / total * 100) : 0 };
            });
            
            const totalCorrect = results.reduce((sum, r) => sum + r.correct, 0);
            const totalIncorrect = results.reduce((sum, r) => sum + r.incorrect, 0);
            const totalUnanswered = results.reduce((sum, r) => sum + r.unanswered, 0);
            const overallTotal = totalCorrect + totalIncorrect + totalUnanswered;
            const overallScore = overallTotal > 0 ? (totalCorrect / overallTotal * 100) : 0;
            const scoreColorClass = overallScore >= 50 ? 'themed-text-success' : 'themed-text-danger';
            
            const attemptedStates = answerStates.filter(s => s.timeTaken > 0);
            const totalTimeSpent = attemptedStates.reduce((acc, s) => acc + s.timeTaken, 0);
            const avgTime = attemptedStates.length > 0 ? totalTimeSpent / attemptedStates.length : 0;
            const avgTimeHtml = '<div class="mt-4 themed-text-secondary">Average time per question: <span class="font-semibold">' + formatTimeDetailed(avgTime) + '</span></div>';

            const performanceHtml =
                '<h2 class="text-2xl font-semibold">Overall Performance</h2>' +
                '<p class="text-5xl font-bold my-4 ' + scoreColorClass + '">' + overallScore.toFixed(2) + '%</p>' +
                '<div class="flex justify-center space-x-8 text-lg">' +
                    '<span><span class="font-bold themed-text-success">' + totalCorrect + '</span> Correct</span>' +
                    '<span><span class="font-bold themed-text-danger">' + totalIncorrect + '</span> Incorrect</span>' +
                    '<span><span class="font-bold themed-text-secondary">' + totalUnanswered + '</span> Unanswered</span>' +
                '</div>' + avgTimeHtml;
            document.getElementById('overall-performance').innerHTML = performanceHtml;
            
            const sectionAnalysisContainer = document.getElementById('section-analysis');
            sectionAnalysisContainer.innerHTML = '';
            results.forEach(r => {
                sectionAnalysisContainer.innerHTML +=
                    '<div class="p-4 rounded-lg themed-bg-primary">' +
                        '<div class="flex justify-between items-center mb-2">' +
                            '<h3 class="text-xl font-bold">' + r.name + '</h3>' +
                            '<p class="text-xl font-semibold themed-text-accent">' + r.score.toFixed(2) + '%</p>' +
                        '</div>' +
                        '<div class="flex justify-around text-sm">' +
                            '<span>Correct: <span class="font-bold themed-text-success">' + r.correct + '</span></span>' +
                            '<span>Incorrect: <span class="font-bold themed-text-danger">' + r.incorrect + '</span></span>' +
                            '<span>Unanswered: <span class="font-bold themed-text-secondary">' + r.unanswered + '</span></span>' +
                        '</div>' +
                    '</div>';
            });
            const analysisHtml = sectionAnalysisContainer.innerHTML;

            // Save result to localStorage history
            const historyJSON = localStorage.getItem(EXAM_RESULTS_HISTORY_KEY);
            let history = historyJSON ? JSON.parse(historyJSON) : [];
            const resultData = {
                timestamp: new Date().toISOString(),
                overallScore: overallScore.toFixed(2),
                detailsHtml,
                performanceHtml,
                analysisHtml,
                answerStates,
                currentMcqs,
                subjectName,
                candidateName,
                shortNote,
                isShuffled
            };
            history.unshift(resultData); // Add to the beginning
            localStorage.setItem(EXAM_RESULTS_HISTORY_KEY, JSON.stringify(history));
            
            const pastResultsContainer = document.getElementById('past-results-container');
            const pastResultsCount = document.getElementById('past-results-count');
            pastResultsContainer.classList.remove('hidden');
            pastResultsCount.textContent = history.length;


            switchScreen('results');
        }

        document.getElementById('restart-btn').addEventListener('click', () => {
            clearExamDraft();
            clearPracticeDraft();
            document.getElementById('subject-name').value = '';
            document.getElementById('candidate-name').value = '';
            document.getElementById('short-note').value = '';
            document.getElementById('shuffle-mcqs-checkbox').checked = false;
            
            currentMcqs.length = 0;
            Array.prototype.push.apply(currentMcqs, JSON.parse(JSON.stringify(initialMcqsState)));
            
            initializeSetup();
            switchScreen('setup');
        });
        
        document.getElementById('download-report-btn').addEventListener('click', () => {
            reportOptionsModal.classList.remove('hidden');
            reportOptionsModal.classList.add('flex');
        });
        
        document.getElementById('cancel-report-download-btn').addEventListener('click', () => {
            reportOptionsModal.classList.add('hidden');
            reportOptionsModal.classList.remove('flex');
        });

        document.getElementById('download-with-explanations-btn').addEventListener('click', () => {
            reportOptionsModal.classList.add('hidden');
            reportOptionsModal.classList.remove('flex');
            downloadReport(true);
        });

        document.getElementById('download-without-explanations-btn').addEventListener('click', () => {
            reportOptionsModal.classList.add('hidden');
            reportOptionsModal.classList.remove('flex');
            downloadReport(false);
        });

        function renderMarkdownToPdf(doc, markdown, options) {
            let { x, y, maxWidth, pageHeight, margin, lineHeight, bulletIndent } = options;
            if (!markdown) return y;

            const checkPageBreak = (neededHeight) => {
                if (y + neededHeight > pageHeight - margin) {
                    doc.addPage();
                    y = margin;
                }
                return y;
            };

            const renderTextBlock = (textBlock) => {
                if (!textBlock.trim()) return;
                
                const blocks = textBlock.split(/\n\s*\n/);
                blocks.forEach(block => {
                    const trimmedBlock = block.trim();
                    if (!trimmedBlock) return;
                    
                    const lines = trimmedBlock.split('\n');
                
                    let isUnordered = lines.every(l => l.trim().startsWith('- ') || l.trim().startsWith('* '));
                    let isOrdered = lines.every(l => l.trim().match(/^\d+\.\s/));
                    
                    if(isUnordered) {
                        lines.forEach(line => {
                            const itemText = line.trim().substring(2);
                            const splitText = doc.splitTextToSize(itemText, maxWidth - bulletIndent);
                            y = checkPageBreak(splitText.length * lineHeight);
                            doc.text('â€¢', x, y, { baseline: 'top' });
                            doc.text(splitText, x + bulletIndent, y, { baseline: 'top' });
                            y += splitText.length * lineHeight;
                        });
                        y += lineHeight / 2;
                    } else if (isOrdered) {
                        lines.forEach(line => {
                            const number = line.trim().match(/^\d+\./)[0];
                            const itemText = line.trim().substring(number.length).trim();
                            const splitText = doc.splitTextToSize(itemText, maxWidth - doc.getTextWidth(number) - bulletIndent);
                            y = checkPageBreak(splitText.length * lineHeight);
                            doc.text(number, x, y, { baseline: 'top' });
                            doc.text(splitText, x + doc.getTextWidth(number) + bulletIndent - 2, y, { baseline: 'top' });
                            y += splitText.length * lineHeight;
                        });
                        y += lineHeight / 2;
                    } else { // Paragraph
                        lines.forEach(line => {
                            let isBold = line.startsWith('**') && line.endsWith('**') && line.length > 4;
                            let isItalic = line.startsWith('*') && line.endsWith('*') && line.length > 2;
                            
                            let processedLine = line;
                            if (isBold) {
                                processedLine = line.substring(2, line.length - 2);
                                doc.setFont('helvetica', 'bold');
                            } else if (isItalic) {
                                processedLine = line.substring(1, line.length - 1);
                                doc.setFont('helvetica', 'italic');
                            }

                            const splitText = doc.splitTextToSize(processedLine, maxWidth);
                            y = checkPageBreak(splitText.length * lineHeight);
                            doc.text(splitText, x, y, { baseline: 'top' });
                            y += splitText.length * lineHeight;

                            doc.setFont('helvetica', 'normal'); // Reset font
                        });
                        y += lineHeight / 2;
                    }
                });
            };

            const imageRegex = /({image\s+\d+})/g;
            const parts = markdown.split(imageRegex).filter(part => part);

            parts.forEach(part => {
                if (part.match(imageRegex)) {
                    const imageIndex = parseInt(part.match(/\d+/)[0], 10) - 1;
                    if (images[imageIndex]) {
                        try {
                            const imgData = images[imageIndex];
                            const fileType = imgData.substring(imgData.indexOf('/') + 1, imgData.indexOf(';'));
                            const imgProps = doc.getImageProperties(imgData);
                            const imgWidth = Math.min(maxWidth, imgProps.width);
                            const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

                            y = checkPageBreak(imgHeight + 5); 
                            doc.addImage(imgData, fileType.toUpperCase(), x, y, imgWidth, imgHeight);
                            y += imgHeight + 5;
                        } catch (e) {
                            console.error("Error adding image to PDF:", e);
                            const errorText = '[Error loading image]';
                            y = checkPageBreak(lineHeight);
                            doc.text(errorText, x, y, { baseline: 'top' });
                            y += lineHeight;
                        }
                    }
                } else {
                    renderTextBlock(part);
                }
            });

            return y;
        }

        async function downloadReport(includeExplanations) {
            const btn = document.getElementById('download-report-btn');
            btn.disabled = true;
            btn.textContent = 'Generating...';

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const analyticsContainer = document.querySelector('#results-screen > div');

                // --- Page 1: Analytics ---
                doc.setFontSize(22);
                doc.text('Exam Report', 105, 20, { align: 'center' });
                
                doc.setFontSize(11);
                doc.text('Subject: ' + (subjectName || 'N/A'), 15, 35);
                doc.text('Candidate: ' + (candidateName || 'N/A'), 15, 42);
                if (shortNote) {
                    const noteLines = doc.splitTextToSize('Notes: ' + shortNote, 180);
                    doc.text(noteLines, 15, 49);
                }
                doc.setFontSize(9);
                doc.setTextColor(150);
                doc.text('Generated on: ' + new Date().toLocaleString(), 105, 58, { align: 'center' });

                const canvas = await window.html2canvas(analyticsContainer, { scale: 2, windowWidth: analyticsContainer.scrollWidth, windowHeight: analyticsContainer.scrollHeight });
                const imgData = canvas.toDataURL('image/png');
                const imgProps = doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                doc.addImage(imgData, 'PNG', 10, 65, pdfWidth - 20, pdfHeight);

                // --- Subsequent Pages: Detailed Review ---
                doc.addPage();
                doc.setFontSize(18);
                doc.text('Detailed Answer Review', 105, 15, { align: 'center' });

                let y = 30;
                const margin = 15;
                const pageHeight = doc.internal.pageSize.getHeight();
                const maxWidth = pdfWidth - margin * 2;

                currentMcqs.forEach((mcq, index) => {
                    const answerState = answerStates.find(a => a.mcqId === mcq.id);
                    if (y > pageHeight - 40) { 
                        doc.addPage();
                        y = 20;
                    }

                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(12);
                    
                    const questionContent = (index + 1) + '. ' + mcq.question;
                    const imageRegex = /({image\s+\d+})/g;
                    const questionParts = questionContent.split(imageRegex).filter(part => part);

                    const checkPageBreakForQuestion = (neededHeight) => {
                        if (y + neededHeight > pageHeight - margin) {
                            doc.addPage();
                            y = 20;
                        }
                    };

                    questionParts.forEach(part => {
                        if (part.match(imageRegex)) {
                            const imageIndex = parseInt(part.match(/\d+/)[0], 10) - 1;
                            if (images[imageIndex]) {
                                try {
                                    const imgData = images[imageIndex];
                                    const fileType = imgData.substring(imgData.indexOf('/') + 1, imgData.indexOf(';'));
                                    const imgProps = doc.getImageProperties(imgData);
                                    const imgWidth = Math.min(maxWidth, imgProps.width);
                                    const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

                                    checkPageBreakForQuestion(imgHeight + 5);
                                    doc.addImage(imgData, fileType.toUpperCase(), margin, y, imgWidth, imgHeight);
                                    y += imgHeight + 5;
                                } catch (e) {
                                    console.error("Error adding image to PDF:", e);
                                    const errorText = '[Error loading image]';
                                    checkPageBreakForQuestion(7);
                                    doc.text(errorText, margin, y, { baseline: 'top' });
                                    y += 7;
                                }
                            }
                        } else {
                            const questionText = doc.splitTextToSize(part, maxWidth);
                            checkPageBreakForQuestion(questionText.length * 7);
                            doc.text(questionText, margin, y, { baseline: 'top' });
                            y += questionText.length * 7;
                        }
                    });
                    y += 3;


                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    Object.keys(mcq.options).forEach(key => {
                        const isCorrect = mcq.correctAnswer === key;
                        const isSelected = answerState.selectedOption === key;

                        if (isCorrect) doc.setTextColor(34, 139, 34);
                        else if (isSelected && !isCorrect) doc.setTextColor(220, 20, 60);
                        else doc.setTextColor(0, 0, 0);
                        
                        const optionString = '(' + key.toUpperCase() + ') ' + mcq.options[key];
                        const optionText = doc.splitTextToSize(optionString, maxWidth - 5);
                        doc.text(optionText, margin + 5, y, { baseline: 'top' });
                        y += optionText.length * 5;
                    });
                    y += 3;
                    
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(9);
                    const summaryText = 'Your Answer: ' + (answerState.selectedOption ? answerState.selectedOption.toUpperCase() : 'Not Answered') + ' | Correct Answer: ' + mcq.correctAnswer.toUpperCase();
                    doc.text(summaryText, margin, y, { baseline: 'top' });
                    y += 7;

                    if (includeExplanations && mcq.explanation) {
                        doc.setTextColor(55, 65, 81);
                        doc.setFont('helvetica', 'bold');
                        doc.setFontSize(10);
                        doc.text('Explanation:', margin, y, { baseline: 'top' });
                        y += 6;

                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(9);

                        const renderOptions = { x: margin, y: y, maxWidth: maxWidth, pageHeight: pageHeight, margin: margin, lineHeight: 4.5, bulletIndent: 4 };
                        y = renderMarkdownToPdf(doc, mcq.explanation, renderOptions);
                    }
                    
                    y += 4;

                    if (index < currentMcqs.length - 1) {
                        doc.setDrawColor(200, 200, 200);
                        doc.line(margin, y, pdfWidth - margin, y);
                        y += 7;
                    }
                });

                doc.save('exam_report.pdf');
            } catch (error) {
                console.error("Failed to generate report:", error);
                alert("Sorry, there was an error generating the report.");
            } finally {
                btn.disabled = false;
                btn.textContent = 'Download Report';
            }
        }
        
        function markdownToHtml(markdown) {
            if (!markdown) return '';

            let text = markdown
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');

            const blocks = text.split(/\n\s*\n/);
            
            return blocks.map(block => {
                const trimmedBlock = block.trim();
                if (!trimmedBlock) return '';

                const lines = trimmedBlock.split('\n');

                if (lines.every(line => line.trim().startsWith('- ') || line.trim().startsWith('* '))) {
                    const listItems = lines.map(line => '<li>' + line.trim().substring(2) + '</li>').join('');
                    return '<ul>' + listItems + '</ul>';
                }

                if (lines.every(line => line.trim().match(/^\d+\.\s/))) {
                    const listItems = lines.map(line => '<li>' + line.trim().replace(/^\d+\.\s/, '') + '</li>').join('');
                    return '<ol>' + listItems + '</ol>';
                }

                return '<p>' + lines.join('<br />') + '</p>';
            }).join('');
        }
        
        // --- PRACTICE MODE LOGIC ---
        document.getElementById('start-practice-btn').addEventListener('click', () => {
            setupErrorEl.textContent = '';
            subjectName = document.getElementById('subject-name').value;
            candidateName = document.getElementById('candidate-name').value;

            const savedPracticeDraft = localStorage.getItem(PRACTICE_DRAFT_KEY);

            if (savedPracticeDraft) {
                practiceResumeModal.classList.remove('hidden');
                practiceResumeModal.classList.add('flex');
            } else {
                startPractice(false); // false means don't load from draft
            }
        });

        document.getElementById('practice-resume-btn').addEventListener('click', () => {
            practiceResumeModal.classList.add('hidden');
            practiceResumeModal.classList.remove('flex');
            startPractice(true); // true means load from draft
        });

        document.getElementById('practice-start-new-btn').addEventListener('click', () => {
            practiceResumeModal.classList.add('hidden');
            practiceResumeModal.classList.remove('flex');
            clearPracticeDraft();
            startPractice(false);
        });

        function handleQuestionTimeout() {
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
            const mcq = currentMcqs[currentPracticeIndex];
            const practiceState = practiceStates.find(p => p.mcqId === mcq.id);

            if (practiceState.attempted) return;

            practiceState.attempted = true;
            practiceState.selectedOption = null; // Timed out, considered incorrect
            practiceState.timeTaken = timePerMcq;
            
            revealPracticeAnswer(null);
            savePracticeDraft();
        }

        // Streak UI Helper
        function updateStreakUI() {
            const streakBadge = document.getElementById('streak-badge');
            const streakCountEl = document.getElementById('streak-count');
            
            if (currentStreak > 0) {
                streakBadge.classList.remove('hidden');
                streakCountEl.textContent = currentStreak;
                
                // Animate
                streakBadge.classList.remove('active');
                void streakBadge.offsetWidth; // Trigger reflow
                streakBadge.classList.add('active');
                setTimeout(() => streakBadge.classList.remove('active'), 200);
            } else {
                streakBadge.classList.add('hidden');
            }
        }

        function startPractice(loadFromDraft = false) {
            if (practiceTimerInterval) clearInterval(practiceTimerInterval);
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
            
            if (loadFromDraft) {
                try {
                    const draft = JSON.parse(localStorage.getItem(PRACTICE_DRAFT_KEY));
                    currentMcqs.length = 0;
                    Array.prototype.push.apply(currentMcqs, draft.mcqs);
                    practiceStates = draft.practiceStates;
                    currentPracticeIndex = draft.currentPracticeIndex;
                    subjectName = draft.subjectName;
                    candidateName = draft.candidateName;
                    isShuffled = draft.isShuffled;
                    timePerMcq = draft.timePerMcq || 0;
                    timeOverall = draft.timeOverall || 0;
                    currentStreak = draft.currentStreak || 0;
                    
                    document.getElementById('subject-name').value = subjectName || '';
                    document.getElementById('candidate-name').value = candidateName || '';
                    document.getElementById('shuffle-mcqs-checkbox').checked = isShuffled;

                } catch (e) {
                    console.error("Failed to load practice draft:", e);
                    alert("The saved practice draft is corrupted. Starting a new session.");
                    clearPracticeDraft();
                    loadFromDraft = false; // Fallback to new session
                }
            }
            
            if (!loadFromDraft) {
                currentStreak = 0; // Reset streak
                isShuffled = document.getElementById('shuffle-mcqs-checkbox').checked;
                let baseMcqs = [...initialMcqsState];
                if (isShuffled) {
                    shuffleArray(baseMcqs);
                }

                const qCountSlider = document.getElementById('practice-q-count-slider');
                let qCount = parseInt(qCountSlider.value, 10);
                if (isNaN(qCount) || qCount <= 0 || qCount > baseMcqs.length) {
                    qCount = baseMcqs.length;
                }
                currentMcqs = baseMcqs.slice(0, qCount);
                
                practiceStates = currentMcqs.map(mcq => ({ mcqId: mcq.id, selectedOption: null, attempted: false, timeTaken: 0 }));
                currentPracticeIndex = 0;
                timePerMcq = parseInt(document.getElementById('practice-time-per-mcq').value, 10) || 0;
                timeOverall = parseInt(document.getElementById('practice-time-overall').value, 10) || 0;
            }

            document.getElementById('practice-subject-name').textContent = subjectName || 'Practice Mode';
            updateStreakUI();
            switchScreen('practice');
            renderPracticePalette(); // Added call to render palette
            renderPracticeQuestion();
            
            const practiceTimerEl = document.getElementById('practice-timer');
            if (timeOverall > 0) {
                practiceTimerEl.classList.remove('hidden');
                let timeLeft = timeOverall * 60;
                practiceTimerEl.textContent = formatTime(timeLeft);
                practiceTimerInterval = setInterval(() => {
                    timeLeft--;
                    practiceTimerEl.textContent = formatTime(timeLeft);
                    if (timeLeft <= 0) {
                        if(practiceTimerInterval) clearInterval(practiceTimerInterval);
                        if(perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
                        alert("Practice time is up!");
                        showPracticeResults();
                    }
                }, 1000);
            } else {
                practiceTimerEl.classList.add('hidden');
            }
        }

        function renderPracticeQuestion() {
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);

            const mcq = currentMcqs[currentPracticeIndex];
            const practiceState = practiceStates.find(p => p.mcqId === mcq.id);
            
            document.getElementById('practice-question-counter').textContent = 'Question ' + (currentPracticeIndex + 1) + ' of ' + currentMcqs.length;
            document.getElementById('practice-question-text').innerHTML = (currentPracticeIndex + 1) + '. ' + processQuestionContent(mcq.question, 'practice-question-image-container');

            // Update Palette Active State
            const allPaletteBtns = document.querySelectorAll('#practice-palette-grid button');
            allPaletteBtns.forEach(btn => btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500'));
            const currentBtn = document.getElementById('practice-palette-item-' + currentPracticeIndex);
            if (currentBtn) {
                currentBtn.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
                // Ensure the active button is visible in the scrollable container
                currentBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }

            const optionsContainer = document.getElementById('practice-options-container');
            optionsContainer.innerHTML = '';
            
            Object.keys(mcq.options).forEach(key => {
                const optionEl = document.createElement('div');
                optionEl.dataset.optionKey = key;
                optionEl.className = 'flex items-center p-4 rounded-lg border-2 transition-all themed-bg-tertiary themed-border-primary';
                optionEl.innerHTML = '<span class="flex-1">' + key.toUpperCase() + '. ' + mcq.options[key] + '</span>';
                optionsContainer.appendChild(optionEl);
            });
            
            // Hide previous results elements
            document.getElementById('practice-explanation-section').classList.add('hidden');
            document.getElementById('header-feedback-badge').classList.remove('visible');
            document.getElementById('header-feedback-badge').className = 'feedback-badge'; // Reset class

            if (practiceState.attempted) {
                revealPracticeAnswer(practiceState.selectedOption);
            } else {
                optionsContainer.classList.add('cursor-pointer');
                optionsContainer.querySelectorAll('[data-option-key]').forEach(el => el.classList.add('themed-bg-accent-hover'));
            }

            // Per-question timer logic
            const timerContainer = document.getElementById('per-question-timer-container');
            const timerBar = document.getElementById('per-question-timer-bar');
            if (timePerMcq > 0 && !practiceState.attempted) {
                timerContainer.classList.remove('hidden');
                timerBar.style.width = '100%';
                timerBar.classList.remove('bg-green-500');
                timerBar.classList.add('bg-green-500');

                const timerStart = Date.now();
                perQuestionTimerInterval = setInterval(() => {
                    const elapsed = (Date.now() - timerStart) / 1000;
                    if (elapsed >= timePerMcq) {
                        handleQuestionTimeout();
                        return;
                    }
                    const remainingPercent = ((timePerMcq - elapsed) / timePerMcq) * 100;
                    timerBar.style.width = remainingPercent + '%';

                    if (remainingPercent < 40) {
                        timerBar.classList.remove('bg-green-500');
                        timerBar.classList.add('bg-red-500');
                    }
                }, 100);
            } else {
                timerContainer.classList.add('hidden');
            }

            document.getElementById('practice-prev-btn').disabled = currentPracticeIndex === 0;
            document.getElementById('practice-next-btn').disabled = currentPracticeIndex === currentMcqs.length - 1;
            
            updatePracticeSaveButtonState();
            questionStartTime = Date.now();
        }

        function revealPracticeAnswer(selectedKey) {
            const mcq = currentMcqs[currentPracticeIndex];
            const optionsContainer = document.getElementById('practice-options-container');
            optionsContainer.classList.remove('cursor-pointer');
            
            // Check correctness
            const isCorrect = mcq.correctAnswer === selectedKey;
            
            // Update Palette Button Color for the answered question
            const paletteBtn = document.getElementById('practice-palette-item-' + currentPracticeIndex);
            if (paletteBtn) {
                // If selectedKey is null (timeout), it's incorrect (red)
                const paletteIsCorrect = selectedKey && (mcq.correctAnswer === selectedKey);
                paletteBtn.className = 'w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full text-white font-bold transition-all transform hover:scale-110 focus:outline-none ' + (paletteIsCorrect ? 'bg-green-600' : 'bg-red-600');
            }

            optionsContainer.querySelectorAll('[data-option-key]').forEach(el => {
                el.classList.remove('themed-bg-accent-hover');
                const key = el.dataset.optionKey;
                const isOptionCorrect = mcq.correctAnswer === key;
                const isSelected = selectedKey === key;

                el.classList.remove('themed-bg-tertiary', 'themed-border-primary');
                
                // SVG Icons
                const checkIcon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2 text-green-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>';
                const crossIcon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2 text-red-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>';

                if (isOptionCorrect) {
                    el.style.backgroundColor = 'var(--bg-success)';
                    el.style.borderColor = 'var(--bg-success-border)';
                    if (!el.innerHTML.includes('<svg')) el.innerHTML += checkIcon;
                    
                    if (isCorrect && isSelected) {
                        triggerConfetti(el.getBoundingClientRect());
                    }
                } else if (isSelected && !isOptionCorrect) {
                    el.style.backgroundColor = 'var(--bg-danger)';
                    el.style.borderColor = 'var(--bg-danger-border)';
                     if (!el.innerHTML.includes('<svg')) el.innerHTML += crossIcon;
                } else {
                    el.classList.add('opacity-60');
                }
            });
            
            // --- HEADER FEEDBACK ---
            const badge = document.getElementById('header-feedback-badge');
            const badgeText = document.getElementById('header-feedback-text');
            
            if (isCorrect) {
                badge.className = 'feedback-badge visible correct';
                badgeText.innerHTML = 'Excellent! ðŸŽ‰';
            } else {
                badge.className = 'feedback-badge visible incorrect';
                badgeText.innerHTML = 'Incorrect âŒ';
            }

            // --- EXPLANATION SECTION ---
            const explanationSection = document.getElementById('practice-explanation-section');
            const explanationContainer = document.getElementById('practice-explanation-container');
            
            if (mcq.explanation) {
                const cleanedExplanationText = processQuestionContent(mcq.explanation, 'practice-explanation-image-container');
                explanationContainer.innerHTML = markdownToHtml(cleanedExplanationText);
            } else {
                document.getElementById('practice-explanation-image-container').innerHTML = '';
                explanationContainer.innerHTML = '<p class="themed-text-tertiary">No explanation was provided for this question.</p>';
            }
            explanationSection.classList.remove('hidden');
        }

        document.getElementById('practice-options-container').addEventListener('click', (e) => {
            const optionEl = e.target.closest('[data-option-key]');
            if (!optionEl) return;

            const mcq = currentMcqs[currentPracticeIndex];
            const practiceState = practiceStates.find(p => p.mcqId === mcq.id);
            
            if (practiceState.attempted) return;
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);

            recordTime(mcq.id, practiceStates);
            
            const selectedKey = optionEl.dataset.optionKey;
            practiceState.attempted = true;
            practiceState.selectedOption = selectedKey;

            // STREAK LOGIC UPDATE
            if (selectedKey === mcq.correctAnswer) {
                currentStreak++;
            } else {
                currentStreak = 0;
            }
            updateStreakUI();

            revealPracticeAnswer(selectedKey);
            savePracticeDraft();
        });
        
        // ADDED: Function to render the practice palette
        function renderPracticePalette() {
            const paletteGrid = document.getElementById('practice-palette-grid');
            if (!paletteGrid) return;
            paletteGrid.innerHTML = '';

            currentMcqs.forEach((mcq, index) => {
                const btn = document.createElement('button');
                btn.id = 'practice-palette-item-' + index;
                btn.dataset.index = String(index);
                
                // Determine color based on state
                const pState = practiceStates.find(p => p.mcqId === mcq.id);
                let bgClass = 'bg-gray-400'; // Default gray
                if (pState && pState.attempted) {
                     const isCorrect = pState.selectedOption === mcq.correctAnswer;
                     bgClass = isCorrect ? 'bg-green-600' : 'bg-red-600';
                }

                btn.className = 'w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full text-white font-bold transition-all transform hover:scale-110 focus:outline-none ' + bgClass; 
                btn.textContent = String(index + 1);
                btn.setAttribute('aria-label', 'Go to question ' + (index + 1));
                
                btn.addEventListener('click', () => {
                    if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
                    // Record time for current before switching if not answered
                    const currentMcq = currentMcqs[currentPracticeIndex];
                    if(currentMcq) {
                         const currentState = practiceStates.find(p => p.mcqId === currentMcq.id);
                         if (!currentState.attempted) recordTime(currentMcq.id, practiceStates);
                    }
                    
                    currentPracticeIndex = parseInt(btn.dataset.index, 10);
                    renderPracticeQuestion();
                    savePracticeDraft();
                });
                paletteGrid.appendChild(btn);
            });
        }
        
        function navigatePractice(offset) {
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
            const mcq = currentMcqs[currentPracticeIndex];
            const practiceState = practiceStates.find(p => p.mcqId === mcq.id);
            if (!practiceState.attempted) {
                recordTime(mcq.id, practiceStates); // Record time even if unanswered
            }

            const newIndex = currentPracticeIndex + offset;
            if (newIndex >= 0 && newIndex < currentMcqs.length) {
                currentPracticeIndex = newIndex;
                renderPracticeQuestion();
                savePracticeDraft();
            }
        }

        document.getElementById('practice-prev-btn').addEventListener('click', () => navigatePractice(-1));
        document.getElementById('practice-next-btn').addEventListener('click', () => navigatePractice(1));

        document.getElementById('exit-practice-btn').addEventListener('click', () => {
            if (practiceTimerInterval) clearInterval(practiceTimerInterval);
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
            recordTime(currentMcqs[currentPracticeIndex].id, practiceStates);
            showPracticeResults();
        });

        // --- REVIEW LOGIC ---
        let reviewQuestionIndex = 0;
        
        function setupReviewScreen(isReviseMode = false, isSavedMode = false) {
            const backBtn = document.getElementById('back-to-results-btn');
            const exitBtn = document.getElementById('exit-revise-btn');
            isReviewingSaved = isSavedMode;

            if (isSavedMode) {
                reviewTitleEl.textContent = 'Saved Questions';
                backBtn.style.display = 'none';
                exitBtn.style.display = 'inline-block';
                document.getElementById('review-time-taken').style.display = 'none';
            } else if (isReviseMode) {
                reviewTitleEl.textContent = 'Revise Mode';
                backBtn.style.display = 'none';
                exitBtn.style.display = 'inline-block';
                document.getElementById('review-time-taken').style.display = 'none';
            } else {
                reviewTitleEl.textContent = 'Review Answers';
                backBtn.style.display = 'inline-block';
                exitBtn.style.display = 'none';
                document.getElementById('review-time-taken').style.display = 'flex';
                if (reviewReturnScreen === 'practiceResults') {
                    backBtn.textContent = 'Back to Practice Results';
                } else {
                    backBtn.textContent = 'Back to Exam Results';
                }
            }
            renderReviewPalette();
            renderReviewQuestion();
        }
        
        document.getElementById('review-answers-btn').addEventListener('click', () => {
            reviewQuestionIndex = 0;
            reviewReturnScreen = 'results';
            switchScreen('review');
            setupReviewScreen(false, false);
        });
        
        document.getElementById('exit-revise-btn').addEventListener('click', () => {
            switchScreen('setup');
        });

        document.getElementById('review-practice-answers-btn').addEventListener('click', () => {
            answerStates = currentMcqs.map(mcq => {
                const pState = practiceStates.find(p => p.mcqId === mcq.id);
                return { mcqId: mcq.id, selectedOption: pState ? pState.selectedOption : null, timeTaken: pState ? pState.timeTaken : 0 };
            });
            reviewQuestionIndex = 0;
            reviewReturnScreen = 'practiceResults';
            switchScreen('review');
            setupReviewScreen(false, false);
        });

        document.getElementById('back-to-results-btn').addEventListener('click', () => switchScreen(reviewReturnScreen));
        
        function renderReviewPalette() {
            const paletteGrid = document.getElementById('review-palette-grid');
            if (!paletteGrid) return;
            paletteGrid.innerHTML = '';

            currentMcqs.forEach((mcq, index) => {
                const answerState = answerStates.find(a => a.mcqId === mcq.id);
                const isCorrect = answerState && answerState.selectedOption === mcq.correctAnswer;
                const hasAnswered = answerState && answerState.selectedOption !== undefined && answerState.selectedOption !== null;
                
                let bgClass = 'bg-gray-400';
                if (hasAnswered) {
                    bgClass = isCorrect ? 'bg-green-600' : 'bg-red-600';
                }

                const btn = document.createElement('button');
                btn.id = 'review-palette-item-' + index;
                btn.dataset.index = String(index);
                btn.className = 'w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full text-white font-bold transition-all transform hover:scale-110 focus:outline-none ' + bgClass;
                btn.textContent = String(index + 1);
                // Accessibility: Dynamic aria label
                btn.setAttribute('aria-label', 'Review question ' + (index + 1));
                btn.addEventListener('click', () => {
                    reviewQuestionIndex = parseInt(btn.dataset.index, 10);
                    renderReviewQuestion();
                });
                paletteGrid.appendChild(btn);
            });
        }

        function renderReviewQuestion() {
            updateSaveButtonState();
            const allPaletteBtns = document.querySelectorAll('#review-palette-grid button');
            allPaletteBtns.forEach(btn => btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500'));
            const currentBtn = document.getElementById('review-palette-item-' + reviewQuestionIndex);
            if (currentBtn) {
                currentBtn.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
                currentBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }

            const mcq = currentMcqs[reviewQuestionIndex];
            const answerState = answerStates.find(a => a.mcqId === mcq.id);
            
            document.getElementById('review-question-text').innerHTML = (reviewQuestionIndex + 1) + '. ' + processQuestionContent(mcq.question, 'review-question-image-container');
            document.getElementById('review-question-counter').textContent = 'Question ' + (reviewQuestionIndex + 1) + ' of ' + currentMcqs.length;
            
            const timeTakenEl = document.getElementById('review-time-taken');
            if (answerState && answerState.timeTaken) {
                timeTakenEl.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg> Time Taken: <span class="font-semibold ml-1">' + formatTimeDetailed(answerState.timeTaken) + '</span>';
            } else {
                timeTakenEl.innerHTML = '';
            }

            const explanationContainer = document.getElementById('explanation-container');
            if (mcq.explanation) {
                const cleanedExplanationText = processQuestionContent(mcq.explanation, 'explanation-image-container');
                explanationContainer.innerHTML = markdownToHtml(cleanedExplanationText);
            } else {
                document.getElementById('explanation-image-container').innerHTML = '';
                explanationContainer.innerHTML = '<p class="themed-text-tertiary">No explanation was provided for this question.</p>';
            }
            
            const reviewOptionsContainer = document.getElementById('review-options-container');
            reviewOptionsContainer.innerHTML = '';
            Object.keys(mcq.options).forEach(key => {
                const isSelected = answerState && answerState.selectedOption === key;
                const isCorrect = mcq.correctAnswer === key;
                let style = 'background-color: var(--bg-tertiary); border-color: transparent;';
                let indicatorText = '';

                if (isCorrect) {
                    style = 'background-color: var(--bg-success); border-color: var(--bg-success-border);';
                    indicatorText = '<span class="ml-auto text-sm font-semibold themed-text-success">Correct Answer</span>';
                }
                
                if (isSelected && !isCorrect) {
                    style = 'background-color: var(--bg-danger); border-color: var(--bg-danger-border);';
                    indicatorText = '<span class="ml-auto text-sm font-semibold themed-text-danger">Your Answer</span>';
                } else if (isSelected && isCorrect) {
                     indicatorText = '<span class="ml-auto text-sm font-semibold themed-text-success">Your Answer (Correct)</span>';
                }
                
                reviewOptionsContainer.innerHTML +=
                    '<div class="flex items-center p-4 rounded-lg border-2" style="' + style + '">' +
                        '<span class="flex-1">' + key.toUpperCase() + '. ' + mcq.options[key] + '</span>' +
                        indicatorText +
                    '</div>';
            });
            
            document.getElementById('review-prev-btn').disabled = reviewQuestionIndex === 0;
            document.getElementById('review-next-btn').disabled = reviewQuestionIndex === currentMcqs.length - 1;
        }

        document.getElementById('review-prev-btn').addEventListener('click', () => {
            if(reviewQuestionIndex > 0) {
                reviewQuestionIndex--;
                renderReviewQuestion();
            }
        });

        document.getElementById('review-next-btn').addEventListener('click', () => {
            if(reviewQuestionIndex < currentMcqs.length - 1) {
                reviewQuestionIndex++;
                renderReviewQuestion();
            }
        });
        
        // --- SWIPE NAVIGATION LOGIC ---
        function setupSwipeNavigation(container) {
            let touchStartX = 0;
            let touchStartY = 0;
            const mainContent = container.querySelector('main');
            let isAnimating = false;

            container.addEventListener('touchstart', e => {
                if (isAnimating) return;
                
                // FIX: Prevent page swipe if user is trying to scroll the palette
                if (e.target.closest('.overflow-x-auto')) return;

                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            container.addEventListener('touchend', e => {
                if (isAnimating) return;
                const touchEndX = e.changedTouches[0].screenX;
                const touchEndY = e.changedTouches[0].screenY;
                const diffX = touchEndX - touchStartX;
                const diffY = touchEndY - touchStartY;

                if (Math.abs(diffX) > 50 && Math.abs(diffX) > Math.abs(diffY)) {
                    
                    const isNext = diffX < 0; // Swipe Left
                    
                    // FIX: Re-enabled swipe backward (swipe right)
                    // The line that prevented it was removed here.

                    isAnimating = true;
                    const outClass = isNext ? 'slide-out-left' : 'slide-out-right';
                    const inClass = isNext ? 'slide-in-from-right' : 'slide-in-from-left';
                    
                    const onAnimationOutEnd = () => {
                        mainContent.removeEventListener('animationend', onAnimationOutEnd);
                        mainContent.classList.remove(outClass);

                        // Perform navigation action
                        if (container.id === 'practice-screen') {
                            if (isNext) navigatePractice(1);
                            else navigatePractice(-1);
                        } else if (container.id === 'review-screen') {
                            if (isNext) document.getElementById('review-next-btn').click();
                            else document.getElementById('review-prev-btn').click();
                        }

                        mainContent.classList.add(inClass);
                        
                        const onAnimationInEnd = () => {
                            mainContent.removeEventListener('animationend', onAnimationInEnd);
                            mainContent.classList.remove(inClass);
                            isAnimating = false;
                        };
                        mainContent.addEventListener('animationend', onAnimationInEnd);
                    };

                    mainContent.addEventListener('animationend', onAnimationOutEnd);
                    mainContent.classList.add(outClass);
                }
            }, { passive: true });
        }

        setupSwipeNavigation(screens.practice);
        setupSwipeNavigation(screens.review);

        // --- PAST RESULTS LOGIC ---
        function showPastResultsList() {
            const historyJSON = localStorage.getItem(EXAM_RESULTS_HISTORY_KEY);
            const history = historyJSON ? JSON.parse(historyJSON) : [];
            const listEl = document.getElementById('past-results-list');
            listEl.innerHTML = '';

            if (history.length === 0) {
                listEl.innerHTML = '<p class="text-center themed-text-tertiary">No past results found.</p>';
            } else {
                history.forEach((result, index) => {
                    const date = new Date(result.timestamp).toLocaleString();
                    const scoreColor = result.overallScore >= 50 ? 'themed-text-success' : 'themed-text-danger';
                    const item = document.createElement('button');
                    item.className = 'w-full text-left p-4 rounded-lg border flex justify-between items-center transition-colors themed-bg-primary themed-border-primary hover:bg-[var(--bg-tertiary)]';
                    item.dataset.resultIndex = index;
                    item.innerHTML = 
                        '<div>' +
                            '<p class="font-bold themed-text-primary">' + (result.subjectName || 'Untitled Exam') + '</p>' +
                            '<p class="text-sm themed-text-secondary">' + date + '</p>' +
                        '</div>' +
                        '<div class="text-right">' +
                            '<p class="text-xl font-bold ' + scoreColor + '">' + result.overallScore + '%</p>' +
                            '<p class="text-xs themed-text-tertiary">Click to view details</p>' +
                        '</div>';
                    listEl.appendChild(item);
                });
            }
            switchScreen('pastResults');
        }
        
        document.getElementById('past-results-list').addEventListener('click', (e) => {
            const target = e.target.closest('[data-result-index]');
            if (target) {
                const index = parseInt(target.dataset.resultIndex, 10);
                const historyJSON = localStorage.getItem(EXAM_RESULTS_HISTORY_KEY);
                const history = historyJSON ? JSON.parse(historyJSON) : [];
                const resultData = history[index];
                if (resultData) {
                    loadResultIntoView(resultData);
                }
            }
        });

        function loadResultIntoView(resultData) {
            document.getElementById('exam-details').innerHTML = resultData.detailsHtml;
            document.getElementById('overall-performance').innerHTML = resultData.performanceHtml;
            document.getElementById('section-analysis').innerHTML = resultData.analysisHtml;
            
            // Set state for the "Review Answers" button for this specific result
            answerStates = resultData.answerStates;
            currentMcqs = resultData.currentMcqs;
            subjectName = resultData.subjectName;
            candidateName = resultData.candidateName;
            shortNote = resultData.shortNote;
            isShuffled = resultData.isShuffled;
            
            switchScreen('results');
        }
        
        document.getElementById('back-to-setup-from-history-btn').addEventListener('click', () => switchScreen('setup'));

        // --- PROGRESS CHARTS RENDERING ---
        function renderProgressCharts() {
            const examHistoryJSON = localStorage.getItem(EXAM_RESULTS_HISTORY_KEY);
            const examHistory = examHistoryJSON ? JSON.parse(examHistoryJSON) : [];
            
            const practiceHistoryJSON = localStorage.getItem(PRACTICE_RESULTS_HISTORY_KEY);
            const practiceHistory = practiceHistoryJSON ? JSON.parse(practiceHistoryJSON) : [];

            // --- KPI DASHBOARD STATS ---
            // Combine scores for calculation? No, separate is better. Let's show Exam stats primarily.
            const examScores = examHistory.map(h => parseFloat(h.overallScore || 0));
            const totalExams = examHistory.length;
            const avgScore = totalExams > 0 ? (examScores.reduce((a,b)=>a+b, 0) / totalExams).toFixed(1) : '0';
            const maxScore = totalExams > 0 ? Math.max(...examScores).toFixed(1) : '0';
            
            // Total Practice Questions Solved
            const totalPracticeQs = practiceHistory.reduce((acc, curr) => acc + (curr.attempted || 0), 0);

            const kpiDashboard = document.getElementById('kpi-dashboard');
            kpiDashboard.innerHTML = ''; // Clear previous

            const kpis = [
                { label: 'Avg Exam Score', value: avgScore + '%', color: 'text-blue-500' },
                { label: 'Highest Score', value: maxScore + '%', color: 'text-green-500' },
                { label: 'Total Attempts', value: totalExams, color: 'text-purple-500' },
                { label: 'Practice Qs', value: totalPracticeQs, color: 'text-orange-500' }
            ];

            kpis.forEach(kpi => {
                const card = document.createElement('div');
                card.className = 'stat-card themed-bg-primary themed-border-primary';
                card.innerHTML = `
                    <span class="stat-value ${kpi.color}">${kpi.value}</span>
                    <span class="stat-label">${kpi.label}</span>
                `;
                kpiDashboard.appendChild(card);
            });


            // Helper to create bars
            const createBar = (score, labelText, tooltipTitle, subtitle, index, prevScore) => {
                const scoreNum = parseFloat(score);
                const isSuccess = scoreNum >= 50;
                const barClass = isSuccess ? 'bar-success' : 'bar-danger';
                
                const barContainer = document.createElement('div');
                barContainer.className = 'chart-bar-container';
                
                const bar = document.createElement('div');
                bar.className = 'chart-bar ' + barClass;
                bar.style.height = Math.max(scoreNum, 5) + '%'; 
                // Staggered Animation Delay
                bar.style.animationDelay = (index * 0.1) + 's';
                
                // Text inside bar
                const barText = document.createElement('span');
                barText.className = 'chart-bar-text';
                barText.textContent = scoreNum.toFixed(1) + '%';
                if (scoreNum < 15) barText.style.display = 'none';
                bar.appendChild(barText);
                
                const label = document.createElement('div');
                label.className = 'chart-bar-label';
                label.textContent = labelText;
                
                // Trend Indicator
                let trendHtml = '';
                if (prevScore !== null) {
                    const diff = scoreNum - prevScore;
                    if (diff > 0) trendHtml = '<span class="text-green-400 ml-2 text-xs">â–² +' + diff.toFixed(1) + '%</span>';
                    else if (diff < 0) trendHtml = '<span class="text-red-400 ml-2 text-xs">â–¼ ' + diff.toFixed(1) + '%</span>';
                    else trendHtml = '<span class="text-gray-400 ml-2 text-xs">- 0%</span>';
                }

                const tooltip = document.createElement('div');
                tooltip.className = 'chart-bar-tooltip';
                tooltip.innerHTML = '<strong>' + tooltipTitle + '</strong>' + trendHtml + '<br/>' + subtitle;
                
                barContainer.appendChild(tooltip);
                barContainer.appendChild(bar);
                barContainer.appendChild(label);
                
                return barContainer;
            };

            // 1. Render Exam Chart
            const examContainer = document.getElementById('exam-chart-container');
            const examEmpty = document.getElementById('exam-chart-empty');
            
            examContainer.innerHTML = '';
            if (examHistory.length === 0) {
                examEmpty.classList.remove('hidden');
            } else {
                examEmpty.classList.add('hidden');
                // Process in chronological order for trends, but show recent last? 
                // Actually history is stored newest first. Let's reverse to show chronological left-to-right.
                const reversedHistory = [...examHistory].reverse();
                
                reversedHistory.forEach((result, i) => {
                    let correct = 0, total = 0;
                    if (result.answerStates && result.currentMcqs) {
                        result.answerStates.forEach(state => {
                            const mcq = result.currentMcqs.find(m => m.id === state.mcqId);
                            if(mcq) {
                                total++;
                                if (state.selectedOption === mcq.correctAnswer) correct++;
                            }
                        });
                    }
                    
                    const date = new Date(result.timestamp).toLocaleDateString(undefined, {month: 'short', day: 'numeric'});
                    const subject = (result.subjectName || 'Exam').substring(0, 15);
                    
                    // Previous score for trend
                    const prevScore = i > 0 ? parseFloat(reversedHistory[i-1].overallScore) : null;

                    const bar = createBar(
                        result.overallScore, 
                        date, 
                        subject, 
                        'Score: ' + result.overallScore + '%<br>Marks: ' + correct + ' / ' + total,
                        i,
                        prevScore
                    );
                    examContainer.appendChild(bar);
                });
            }

            // 2. Render Practice Chart
            const practiceContainer = document.getElementById('practice-chart-container');
            const practiceEmpty = document.getElementById('practice-chart-empty');
            
            practiceContainer.innerHTML = '';
            if (practiceHistory.length === 0) {
                practiceEmpty.classList.remove('hidden');
            } else {
                practiceEmpty.classList.add('hidden');
                const reversedHistory = [...practiceHistory].reverse();
                
                reversedHistory.forEach((result, i) => {
                    const date = new Date(result.timestamp).toLocaleDateString(undefined, {month: 'short', day: 'numeric'});
                    const subject = (result.subjectName || 'Practice').substring(0, 15);
                    const prevScore = i > 0 ? parseFloat(reversedHistory[i-1].score) : null;

                    const bar = createBar(
                        result.score, 
                        date, 
                        subject, 
                        'Score: ' + result.score + '%<br>Marks: ' + result.correct + ' / ' + result.attempted,
                        i,
                        prevScore
                    );
                    practiceContainer.appendChild(bar);
                });
            }
        }

        document.getElementById('reset-practice-history-btn').addEventListener('click', () => {
            showConfirmation("Are you sure you want to clear all practice history? This cannot be undone.", () => {
                localStorage.removeItem(PRACTICE_RESULTS_HISTORY_KEY);
                renderProgressCharts();
            });
        });
        
        function showPracticeResults() {
            if (practiceTimerInterval) clearInterval(practiceTimerInterval);
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
            clearPracticeDraft();
            
            const detailsHtml =
                '<p><span class="font-bold">Subject:</span> ' + (subjectName || 'N/A') + '</p>' +
                '<p><span class="font-bold">Candidate:</span> ' + (candidateName || 'N/A') + '</p>';
            document.getElementById('practice-exam-details').innerHTML = detailsHtml;

            let correct = 0, incorrect = 0, attempted = 0;
            practiceStates.forEach(state => {
                if (state.attempted) {
                    attempted++;
                    const mcq = currentMcqs.find(m => m.id === state.mcqId);
                    if (mcq && state.selectedOption === mcq.correctAnswer) {
                        correct++;
                    } else {
                        incorrect++;
                    }
                }
            });
            
            const score = attempted > 0 ? (correct / attempted * 100) : 0;
            const scoreColorClass = score >= 50 ? 'themed-text-success' : 'themed-text-danger';
            
            document.getElementById('practice-score').className = 'text-5xl font-bold my-4 ' + scoreColorClass;
            document.getElementById('practice-score').textContent = score.toFixed(2) + '%';
            
            document.getElementById('practice-correct').innerHTML = '<span class="font-bold themed-text-success">' + correct + '</span> Correct';
            document.getElementById('practice-incorrect').innerHTML = '<span class="font-bold themed-text-danger">' + incorrect + '</span> Incorrect';
            document.getElementById('practice-attempted').innerHTML = '<span class="font-bold themed-text-secondary">' + attempted + '</span> Attempted';
            
            const attemptedStates = practiceStates.filter(s => s.timeTaken > 0);
            const totalTimeSpent = attemptedStates.reduce((acc, s) => acc + s.timeTaken, 0);
            const avgTime = attemptedStates.length > 0 ? totalTimeSpent / attemptedStates.length : 0;
            document.getElementById('practice-avg-time').innerHTML = 'Average time per question: <span class="font-semibold">' + formatTimeDetailed(avgTime) + '</span>';

            // SAVE PRACTICE RESULT
            const historyJSON = localStorage.getItem(PRACTICE_RESULTS_HISTORY_KEY);
            let history = historyJSON ? JSON.parse(historyJSON) : [];
            const resultData = {
                timestamp: new Date().toISOString(),
                score: score.toFixed(2),
                correct,
                incorrect,
                attempted,
                subjectName
            };
            history.unshift(resultData);
            localStorage.setItem(PRACTICE_RESULTS_HISTORY_KEY, JSON.stringify(history));

            switchScreen('practiceResults');
        }

        document.getElementById('restart-practice-btn').addEventListener('click', () => {
            clearPracticeDraft();
            startPractice(false);
        });
        
        document.getElementById('back-to-setup-btn').addEventListener('click', () => switchScreen('setup'));
        document.getElementById('back-to-setup-from-progress-btn').addEventListener('click', () => switchScreen('setup'));

        // --- INITIALIZE APP ---
        const savedExamDraft = localStorage.getItem(EXAM_DRAFT_KEY);
        if (savedExamDraft) {
            const resumeBanner = document.getElementById('resume-banner');
            resumeBanner.classList.remove('hidden');

            document.getElementById('resume-session-btn').addEventListener('click', () => {
                try {
                    const draft = JSON.parse(savedExamDraft);
                    
                    currentMcqs.length = 0;
                    Array.prototype.push.apply(currentMcqs, draft.mcqs);
                    sections = draft.sections;
                    answerStates = draft.answerStates;
                    currentSectionIndex = draft.currentSectionIndex;
                    currentQuestionIndexInSection = draft.currentQuestionIndexInSection;
                    subjectName = draft.subjectName;
                    candidateName = draft.candidateName;
                    shortNote = draft.shortNote;
                    isShuffled = draft.isShuffled;

                    document.getElementById('subject-name').value = subjectName || '';
                    document.getElementById('candidate-name').value = candidateName || '';
                    document.getElementById('short-note').value = shortNote || '';
                    document.getElementById('shuffle-mcqs-checkbox').checked = isShuffled;
                    
                    renderSections();
                    loadSection();
                    switchScreen('exam');

                } catch (e) {
                    console.error("Failed to load exam draft:", e);
                    alert("The saved exam draft appears to be corrupted and could not be loaded.");
                    clearExamDraft();
                    resumeBanner.classList.add('hidden');
                }
            });

            document.getElementById('discard-draft-btn').addEventListener('click', () => {
                clearExamDraft();
                resumeBanner.classList.add('hidden');
            });
        }
        
        const savedMcqsData = localStorage.getItem(SAVED_MCQS_KEY);
        if (savedMcqsData) {
            try {
                savedMcqIds = JSON.parse(savedMcqsData);
            } catch (e) {
                console.error("Could not parse saved MCQs", e);
                savedMcqIds = [];
            }
        }
        updateSavedQuestionsUI();
        
        const savedResultsData = localStorage.getItem(EXAM_RESULTS_HISTORY_KEY);
        if (savedResultsData) {
            const history = JSON.parse(savedResultsData);
            if(history.length > 0) {
                const pastResultsContainer = document.getElementById('past-results-container');
                const pastResultsCount = document.getElementById('past-results-count');
                pastResultsContainer.classList.remove('hidden');
                pastResultsCount.textContent = history.length;
            }
        }

        document.getElementById('view-past-results-btn').addEventListener('click', showPastResultsList);

        saveMcqBtn.addEventListener('click', toggleSaveMcq);
        saveMcqPracticeBtn.addEventListener('click', toggleSavePracticeMcq);
        
        if (toggleSparklesBtn) {
            toggleSparklesBtn.addEventListener('click', () => {
                isSparklesEnabled = !isSparklesEnabled;
                const svg = toggleSparklesBtn.querySelector('svg');
                if (isSparklesEnabled) {
                    svg.classList.remove('themed-text-secondary');
                    svg.classList.add('text-yellow-500');
                    svg.setAttribute('fill', 'currentColor');
                    showToast("Sparkles On âœ¨");
                } else {
                    svg.classList.add('themed-text-secondary');
                    svg.classList.remove('text-yellow-500');
                    svg.setAttribute('fill', 'none');
                    showToast("Sparkles Off");
                }
            });
        }

        viewSavedBtn.addEventListener('click', () => {
            if (savedMcqIds.length === 0) {
                alert("You have no saved questions.");
                return;
            }
            currentMcqs = initialMcqsState.filter(mcq => savedMcqIds.includes(mcq.id));
            answerStates = currentMcqs.map(mcq => ({
                mcqId: mcq.id,
                status: QuestionStatus.NotVisited,
                selectedOption: undefined,
                timeTaken: 0
            }));
            reviewQuestionIndex = 0;
            switchScreen('review');
            setupReviewScreen(true, true);
        });

        if (mcqs.length > 0) {
            currentMcqs = [...mcqs];
            initializeSetup();
        } else {
            switchScreen('setup');
            document.getElementById('setup-error').textContent = "No questions were loaded. Please generate a new file.";
            document.getElementById('start-exam-btn').disabled = true;
            document.getElementById('add-section-btn').disabled = true;
        }
      } catch (error) {
          console.error("Fatal error during exam initialization:", error);
          document.body.innerHTML =
              '<div style="padding: 2rem; text-align: center; font-family: sans-serif; color: #333;">' +
                  '<h1 style="color: #d9534f; font-size: 2rem;">An Unexpected Error Occurred</h1>' +
                  '<p style="margin-top: 1rem;">The exam file could not be loaded. This is likely due to an internal script error.</p>' +
                  '<p style="margin-top: 0.5rem;">Please try generating the exam file again from the main application.</p>' +
                  '<div style="margin-top: 2rem; padding: 1rem; background-color: #f7f7f7; border: 1px solid #ddd; text-align: left; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; font-size: 0.8rem; max-width: 800px; margin-left: auto; margin-right: auto;">' +
                      '<h3 style="margin-bottom: 0.5rem; font-weight: bold;">Error Details:</h3>' +
                      error.message +
                  '</div>' +
              '</div>';
      }
    });

</script>
<script>
    // --- DISABLE BROWSER BACK/FORWARD ---
    // This script prevents the user from using the browser back button or swipe gestures
    // to leave the page or navigate history, keeping them in the exam app.
    history.pushState(null, document.title, location.href);
    window.addEventListener('popstate', function (event) {
        history.pushState(null, document.title, location.href);
    });
</script>
</body>
</html>
    
