
<!DOCTYPE html>
<html lang="en">
<head>
    <script>
    // --- SECURITY CHECK ---
    // If the token is missing, they accessed this file directly (cheating)
    if (!sessionStorage.getItem('portalToken')) {
        // Replace 'index.html' with the actual name of your main login page
        window.location.href = 'index.html'; 
    }

    // Disable Right Click on Exam Page too
    document.addEventListener('contextmenu', event => event.preventDefault());
    
    // Disable Selection
    document.addEventListener('selectstart', event => event.preventDefault());
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MCQ Exam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root, [data-theme="light"] {
            --bg-primary: #f9fafb; /* gray-50 */
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6; /* gray-100 */
            --bg-accent: #e5e7eb; /* gray-200 */
            --bg-accent-hover: #d1d5db; /* gray-300 */
            --bg-info: #eff6ff; /* blue-50 */
            --bg-info-border: #bfdbfe; /* blue-200 */
            --bg-success: #f0fdf4; /* green-50 */
            --bg-success-border: #bbf7d0; /* green-200 */
            --bg-danger: #fef2f2; /* red-50 */
            --bg-danger-border: #fecaca; /* red-200 */
            --bg-warning: #fffbeb; /* yellow-50 */
            --bg-warning-border: #fde68a; /* yellow-200 */
            --bg-code: #e5e7eb;
            --text-primary: #1f2937; /* gray-800 */
            --text-secondary: #4b5563; /* gray-600 */
            --text-tertiary: #6b7280; /* gray-500 */
            --text-accent: #3b82f6; /* blue-600 */
            --text-accent-hover: #2563eb; /* blue-700 */
            --text-inverted: #ffffff;
            --text-info: #1e40af; /* blue-800 */
            --text-success: #15803d; /* green-700 */
            --text-danger: #b91c1c; /* red-700 */
            --text-warning: #92400e; /* yellow-800 */
            --border-primary: #e5e7eb; /* gray-200 */
            --border-secondary: #d1d5db; /* gray-300 */
            --border-accent: #3b82f6;
            --shadow-color: rgba(0,0,0,0.1);
            --swipe-duration: 0.3s; /* Default Smooth */
            --font-explanation: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }

        [data-theme="dark"] {
            --bg-primary: #111827; /* gray-900 */
            --bg-secondary: #1f2937; /* gray-800 */
            --bg-tertiary: #374151; /* gray-700 */
            --bg-accent: #4b5563; /* gray-600 */
            --bg-accent-hover: #525c6a;
            --bg-info: #1e293b; 
            --bg-info-border: #334155;
            --bg-success: #064e3b; /* green-900 */
            --bg-success-border: #065f46;
            --bg-danger: #7f1d1d; /* red-900 */
            --bg-danger-border: #991b1b;
            --bg-warning: #451a03;
            --bg-warning-border: #78350f;
            --bg-code: #374151;
            --text-primary: #f3f4f6; /* near-white, AAA */
            --text-secondary: #d1d5db; /* gray-300, AAA */
            --text-tertiary: #9ca3af; /* gray-400 */
            --text-accent: #60a5fa; /* blue-400 */
            --text-accent-hover: #93c5fd; /* blue-300 */
            --text-inverted: #1f2937;
            --text-info: #bfdbfe;
            --text-success: #86efac; /* green-300 */
            --text-danger: #fca5a5; /* red-300 */
            --text-warning: #fcd34d;
            --border-primary: #374151; /* gray-700 */
            --border-secondary: #4b5563; /* gray-600 */
            --border-accent: #60a5fa;
            --shadow-color: rgba(0,0,0,0.4);
            --font-explanation: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }

        [data-theme="ambient"] {
            --bg-primary: #fdf6e3; /* cream */
            --bg-secondary: #f6efd8;
            --bg-tertiary: #eee8d5;
            --bg-accent: #dcd4c1;
            --bg-accent-hover: #c9c1ae;
            --bg-info: #e0f2f1; 
            --bg-info-border: #b2dfdb;
            --bg-success: #e8f5e9;
            --bg-success-border: #c8e6c9;
            --bg-danger: #ffebee;
            --bg-danger-border: #ffcdd2;
            --bg-warning: #fff3e0;
            --bg-warning-border: #ffe0b2;
            --bg-code: #eee8d5;
            --text-primary: #433e3f; /* dark brown */
            --text-secondary: #586e75;
            --text-tertiary: #657b83;
            --text-accent: #cb4b16; /* warm orange */
            --text-accent-hover: #d35400;
            --text-inverted: #fdf6e3;
            --text-info: #00695c;
            --text-success: #2e7d32;
            --text-danger: #c62828;
            --text-warning: #e65100;
            --border-primary: #dcd4c1;
            --border-secondary: #c9c1ae;
            --border-accent: #cb4b16;
            --shadow-color: rgba(67, 62, 63, 0.1);
            --font-explanation: 'Georgia', 'Cambria', 'Times New Roman', serif;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            /* Disable Selection and Touch Callouts */
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10 and IE 11 */
            user-select: none; /* Standard syntax */
            -webkit-touch-callout: none; /* iOS Safari */
        }
        
        /* Re-enable selection for inputs */
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        /* View Transitions for Theme Switch */
        ::view-transition-old(root),
        ::view-transition-new(root) {
            animation: none;
            mix-blend-mode: normal;
        }
        ::view-transition-old(root) { z-index: 1; }
        ::view-transition-new(root) { z-index: 9999; }

        .screen { display: none; }
        .screen.active { display: flex; }
        .option-label { transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out; }
        .prose strong { font-weight: 700; color: var(--text-primary); }
        .prose em { color: var(--text-primary); font-style: italic; }
        .prose br { content: ""; display: block; margin-bottom: 0.5rem; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .prose p { margin-bottom: 1rem; }
        .calculator-btn { padding: 1rem 0; font-size: 1.25rem; border-radius: 0.5rem; transition: background-color 0.2s, transform 0.1s, filter 0.1s; text-align: center; }
        .key-press-feedback { transform: scale(0.95); filter: brightness(0.85); }
        .calculator-modal.dragging { opacity: 0.7; border: 2px dashed var(--border-accent); }
        
        /* Custom Radio Button for Exam Mode */
        .radio-circle::after {
            content: '';
            display: block;
            width: 1rem; /* 16px */
            height: 1rem; /* 16px */
            border-radius: 50%;
            background-color: var(--border-accent);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.2s ease-in-out;
        }
        .option-label.selected .radio-circle::after {
            transform: translate(-50%, -50%) scale(1);
        }
        
        /* Themed Components */
        .themed-bg-primary { background-color: var(--bg-primary); }
        .themed-bg-secondary { background-color: var(--bg-secondary); }
        .themed-bg-tertiary { background-color: var(--bg-tertiary); }
        .themed-bg-accent { background-color: var(--bg-accent); }
        .themed-bg-accent-hover:hover { background-color: var(--bg-accent-hover); }

        .themed-text-primary { color: var(--text-primary); }
        .themed-text-secondary { color: var(--text-secondary); }
        .themed-text-tertiary { color: var(--text-tertiary); }
        .themed-text-accent { color: var(--text-accent); }
        .themed-text-inverted { color: var(--text-inverted); }
        .themed-text-success { color: var(--text-success); }
        .themed-text-danger { color: var(--text-danger); }
        .themed-text-warning { color: var(--text-warning); }

        .themed-border-primary { border-color: var(--border-primary); }
        .themed-border-secondary { border-color: var(--border-secondary); }
        .themed-border-accent { border-color: var(--border-accent); }
        
        .themed-shadow { box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -2px var(--shadow-color); }
        
        /* Component specific overrides */
        #setup-screen .bg-white, #results-screen .bg-white, #review-screen .bg-white, #practice-screen .bg-white, #practice-results-screen .bg-white, #past-results-screen .bg-white, #progress-screen .bg-white, .modal-card, #calculator-modal {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        header { background-color: var(--bg-secondary); }
        main, footer { background-color: var(--bg-tertiary); }
        footer { box-shadow: 0 -2px 5px var(--shadow-color); }
        input, textarea { background-color: var(--bg-secondary); border-color: var(--border-secondary); color: var(--text-primary); }
        input:focus, textarea:focus { --tw-ring-color: var(--text-accent); border-color: var(--text-accent); }
        #timer, #practice-timer { background-color: var(--bg-accent); }
        .option-label { background-color: var(--bg-tertiary); position: relative; overflow: hidden; }
        .option-label.selected { background-color: var(--bg-info); border-color: var(--border-accent); }
        .option-label:hover { background-color: var(--bg-accent); }
        #question-palette { background-color: var(--bg-secondary); }
        #hide-palette-btn, #show-palette-btn { background-color: var(--bg-secondary); color: var(--text-secondary); border-color: var(--border-primary); }
        
        /* Improved Explanation Typography and Styles */
        .explanation-card {
            background-color: var(--bg-secondary);
            border-top: 4px solid var(--text-accent);
            border-radius: 0.75rem;
            margin-top: 2rem;
            animation: fade-in-up 0.4s ease-out;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            position: relative; /* For toolbar anchor */
        }
        .explanation-header {
            padding: 1rem 1.5rem;
            font-weight: 700;
            color: var(--text-accent);
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-primary);
            font-size: 1.1rem;
        }
        .explanation-content {
            padding: 1.5rem 2rem;
            color: var(--text-primary);
            font-size: 1.05rem;
            line-height: 1.8;
            font-family: var(--font-explanation);
            user-select: text; /* Allow selection in explanation */
        }

        /* Feedback Header Badge */
        .feedback-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 0.875rem;
            margin-left: 1rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease-out;
        }
        .feedback-badge.visible { opacity: 1; transform: translateY(0); }
        .feedback-badge.correct { background-color: var(--bg-success); color: var(--text-success); border: 1px solid var(--bg-success-border); }
        .feedback-badge.incorrect { background-color: var(--bg-danger); color: var(--text-danger); border: 1px solid var(--bg-danger-border); }

        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Streak Badge */
        .streak-badge {
            display: flex;
            align-items: center;
            background: rgba(245, 158, 11, 0.1); /* amber-500 with opacity */
            color: #d97706; /* amber-600 */
            padding: 0.25rem 0.75rem;
            border-radius: 99px;
            font-weight: 700;
            font-size: 0.85rem;
            border: 1px solid rgba(245, 158, 11, 0.3);
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .streak-badge.active {
            transform: scale(1.1);
            background: rgba(245, 158, 11, 0.25);
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.2);
        }
        
        /* Swipe Animations */
        @keyframes slide-out-left { to { transform: translateX(-100%); opacity: 0; } }
        @keyframes slide-in-from-right { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slide-out-right { to { transform: translateX(100%); opacity: 0; } }
        @keyframes slide-in-from-left { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .slide-out-left { animation: slide-out-left var(--swipe-duration) ease-out forwards; }
        .slide-in-from-right { animation: slide-in-from-right var(--swipe-duration) ease-out forwards; }
        .slide-out-right { animation: slide-out-right var(--swipe-duration) ease-out forwards; }
        .slide-in-from-left { animation: slide-in-from-left var(--swipe-duration) ease-out forwards; }
        
        /* Toast Notification */
        @keyframes fade-in-out {
            0% { transform: translateY(100%); opacity: 0; }
            10% { transform: translateY(0); opacity: 1; }
            90% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(100%); opacity: 0; }
        }
        #toast-notification {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            background-color: #333;
            color: white;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            z-index: 100;
            visibility: hidden;
            opacity: 0;
        }
        #toast-notification.show {
            visibility: visible;
            bottom: 2rem;
            animation: fade-in-out 3s ease-in-out forwards;
        }

        /* Save Button Animation */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.25); }
            100% { transform: scale(1); }
        }
        .pop-animation {
            animation: pop 0.3s ease-out;
        }
        
        /* CHART CSS */
        .chart-wrapper {
            display: flex;
            align-items: flex-end;
            justify-content: flex-start;
            gap: 16px;
            height: 300px;
            width: 100%;
            overflow-x: auto;
            padding: 20px 10px 40px 10px;
            border-bottom: 2px solid var(--border-primary);
            border-left: 2px solid var(--border-primary);
            background: linear-gradient(to bottom, var(--bg-primary), var(--bg-secondary));
            border-radius: 12px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.02);
        }
        .chart-bar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            justify-content: flex-end;
            flex-shrink: 0;
            width: 50px;
            position: relative;
            transition: transform 0.2s;
        }
        .chart-bar-container:hover {
            transform: translateY(-5px);
            z-index: 10;
        }
        
        @keyframes grow-up {
            from { height: 0; opacity: 0; }
            to { opacity: 1; }
        }
        
        .chart-bar {
            width: 100%;
            border-radius: 6px 6px 0 0;
            position: relative;
            min-height: 24px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 5px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: grow-up 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            opacity: 0; /* Start invisible for animation */
        }
        
        /* Interference/Gradient Effects */
        .bar-success {
            background: linear-gradient(180deg, #4ade80 0%, #16a34a 100%);
            border: 1px solid #15803d;
        }
        .bar-danger {
            background: linear-gradient(180deg, #f87171 0%, #dc2626 100%);
            border: 1px solid #b91c1c;
        }
        
        /* Text inside bar */
        .chart-bar-text {
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            white-space: nowrap;
            margin-bottom: 5px;
        }
        
        .chart-bar-label {
            font-size: 11px;
            margin-top: 10px;
            color: var(--text-secondary);
            transform: rotate(-45deg);
            white-space: nowrap;
            text-align: right;
            width: 100%;
            transform-origin: top center;
            text-overflow: ellipsis;
            overflow: hidden;
        }
        .chart-bar-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: rgba(17, 24, 39, 0.95);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 20;
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }
        .chart-bar-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: rgba(17, 24, 39, 0.95) transparent transparent transparent;
        }
        .chart-bar-container:hover .chart-bar-tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(-12px);
        }
        
        /* STAT CARDS */
        .stat-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-value { font-size: 1.5rem; font-weight: 800; color: var(--text-primary); }
        .stat-label { font-size: 0.75rem; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; }

        /* DYNAMIC ISLAND */
        #dynamic-island {
            position: fixed;
            z-index: 9999;
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(16px);
            border-radius: 20px;
            padding: 6px;
            gap: 8px;
            display: flex;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            transition: width 0.5s, height 0.5s, top 0.5s, left 0.5s, right 0.5s, bottom 0.5s, border-radius 0.5s, opacity 0.4s ease;
            cursor: grab;
            border: 1px solid rgba(255,255,255,0.15);
        }
        #dynamic-island:active { cursor: grabbing; }
        
        #dynamic-island.dragging { transition: none !important; }
        
        @keyframes hint-move {
            0% { transform: translateY(0); }
            25% { transform: translateY(5px); }
            50% { transform: translateY(-5px); }
            75% { transform: translateY(5px); }
            100% { transform: translateY(0); }
        }
        .hint-anim { animation: hint-move 0.6s ease-in-out; box-shadow: 0 0 25px rgba(255,255,255,0.5) !important; }
        
        #dynamic-island.idle { opacity: 0.3; }
        #dynamic-island.idle:hover { opacity: 1; }
        
        #dynamic-island.horizontal { flex-direction: row; height: auto; align-items: center; }
        #dynamic-island.vertical { flex-direction: column; width: auto; align-items: center; }

        .island-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: background 0.2s, transform 0.2s;
            cursor: pointer;
        }
        .island-btn:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
        .island-btn:active { transform: scale(0.95); }
        .island-btn svg { width: 18px; height: 18px; }
        
        .island-mini-btn {
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            padding: 0;
            padding-bottom: 2px;
        }
        .island-mini-btn:hover { background: rgba(255, 255, 255, 0.2); color: white; }

        .island-separator { background: rgba(255,255,255,0.2); border-radius: 99px; }
        #dynamic-island.horizontal .island-separator { width: 1px; height: 20px; }
        #dynamic-island.vertical .island-separator { width: 20px; height: 1px; }

        #dynamic-island.minimized {
            padding: 0;
            gap: 0;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            cursor: pointer;
            justify-content: center;
            opacity: 1 !important; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        [data-theme="light"] #dynamic-island.minimized,
        [data-theme="ambient"] #dynamic-island.minimized {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        #dynamic-island.minimized > * { display: none !important; }

        #dynamic-island.minimized.horizontal { width: 40px; height: 6px; border-radius: 10px; }
        #dynamic-island.minimized.vertical { width: 6px; height: 40px; border-radius: 10px; }

    </style>
    <script>
        // Immediately apply theme from localStorage to prevent FOUC
        (function() {
            try {
                const examId = 'exam_1764430810115_td9ax66';
                const THEME_KEY = 'examTheme_' + examId;
                const savedTheme = localStorage.getItem(THEME_KEY);
                if (savedTheme) {
                    document.documentElement.dataset.theme = savedTheme;
                }
            } catch (e) {
                console.error('Could not apply saved theme.', e);
            }
        })();
    </script>
</head>
<body class="">
    
    <!-- DYNAMIC ISLAND: Left Side Center Default -->
    <div id="dynamic-island" class="vertical" style="top: 50%; left: 20px; transform: translateY(-50%);">
        <button id="island-minimize-btn" class="island-mini-btn" aria-label="Minimize Island" title="Minimize">&minus;</button>
        
        <div class="island-separator"></div>
        <button id="island-home-btn" class="island-btn" aria-label="Go Home">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
        </button>

        <div class="island-separator"></div>
        <button id="island-progress-btn" class="island-btn" aria-label="View Progress">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
        </button>
        <div class="island-separator"></div>
        <button id="island-theme-btn" class="island-btn" aria-label="Toggle Theme">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
            </svg>
        </button>
        <div class="island-separator"></div>
        <button id="island-settings-btn" class="island-btn" aria-label="Swipe Settings">
             <svg id="swipe-icon-smooth" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
            <svg id="swipe-icon-hard" class="hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
        </button>
    </div>

    <div id="toast-notification"></div>
    <main id="app-container" class="h-screen w-screen relative">
        <!-- SCREEN 1: SECTION SETUP -->
        <div id="setup-screen" class="screen active flex-col justify-center items-center p-4">
            <div id="resume-banner" class="hidden w-full max-w-5xl bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg shadow-lg mb-6" role="alert">
                <div class="flex">
                    <div class="py-1"><svg class="fill-current h-6 w-6 text-yellow-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-5.414V8a1 1 0 112 0v4.586a1 1 0 11-2 0zM10 6a1 1 0 100-2 1 1 0 000 2z"/></svg></div>
                    <div>
                        <p class="font-bold">Saved Exam Session Found!</p>
                        <p class="text-sm">You have a saved exam in progress. What would you like to do?</p>
                        <div class="mt-3">
                            <button id="resume-session-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded" aria-label="Resume previous session">Resume Session</button>
                            <button id="discard-draft-btn" class="ml-4 text-sm text-yellow-800 hover:underline" aria-label="Discard draft and start new">Discard and Start New</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="w-full max-w-5xl bg-white p-8 rounded-lg shadow-lg themed-bg-secondary themed-shadow">
                <p class="text-xs text-center mb-4 themed-text-tertiary">Read instructions before start</p>
                <h1 class="text-3xl font-bold mb-2 text-center themed-text-accent">Anesthesia</h1>
                <h2 class="text-xl font-semibold mb-6 text-center themed-text-secondary">Exam Setup</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- Left Panel: Exam Configuration -->
                    <div class="md:col-span-2 space-y-6">
                        <div>
                            <p class="mb-4 themed-text-secondary">Total Questions Found: 55. Configure your exam sections below.</p>
                            
                            <div class="space-y-4 mb-6">
                                <div>
                                    <label for="subject-name" class="block text-sm font-medium themed-text-secondary">Subject Name</label>
                                    <input type="text" id="subject-name" value="Anesthesia" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="candidate-name" class="block text-sm font-medium themed-text-secondary">Candidate Name</label>
                                    <input type="text" id="candidate-name" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="short-note" class="block text-sm font-medium themed-text-secondary">Short Note (Optional)</label>
                                    <textarea id="short-note" rows="2" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Any notes for this test..."></textarea>
                                </div>
                            </div>

                            <div class="flex items-center mb-6">
                                <input type="checkbox" id="shuffle-mcqs-checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="shuffle-mcqs-checkbox" class="ml-2 block text-sm font-medium themed-text-secondary">Shuffle Questions</label>
                            </div>

                            <hr class="my-6 themed-border-primary">
                            
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold themed-text-primary">Exam Sections</h2>
                                <button id="auto-set-sections-btn" class="px-3 py-1 rounded-full text-xs font-semibold border border-blue-500 text-blue-500 hover:bg-blue-50 transition-colors" title="Split into 50-question sections (1 min/q)">Auto Set</button>
                            </div>
                            <div id="sections-container" class="space-y-4 max-h-48 overflow-y-auto pr-2">
                                <!-- Sections will be injected here by JS -->
                            </div>

                            <div class="mt-4 flex justify-between items-center">
                                <button id="add-section-btn" class="py-2 px-4 rounded themed-bg-accent themed-bg-accent-hover" aria-label="Add a new section">Add Section</button>
                            </div>
                        </div>

                        <div class="mt-6 text-center">
                            <button id="start-exam-btn" class="py-3 px-8 rounded-lg font-bold text-lg w-full md:w-auto" style="background-color: var(--text-accent); color: var(--text-inverted);" aria-label="Start the exam">Start Exam</button>
                            <p id="setup-error" class="mt-4 themed-text-danger text-center h-5"></p>
                        </div>
                    </div>

                    <!-- Right Panel: Alternative Modes -->
                    <div class="md:col-span-1 p-6 rounded-lg border themed-bg-primary themed-border-primary">
                        <h2 class="text-xl font-semibold mb-6 text-center themed-text-primary">Alternative Modes</h2>
                        <div class="space-y-4">
                            <div class="p-4 rounded-lg border" style="background-color: var(--bg-warning); border-color: var(--bg-warning-border);">
                                <h3 class="font-semibold text-lg text-center mb-3 themed-text-warning">Practice Mode</h3>
                                <div class="space-y-4 text-sm">
                                     <div>
                                        <label for="practice-q-count-slider" class="block font-medium themed-text-secondary">Number of Questions: <span id="practice-q-count-label">55</span></label>
                                        <input type="range" id="practice-q-count-slider" min="1" max="55" value="55" class="mt-1 block w-full cursor-pointer">
                                    </div>
                                    <div>
                                        <label for="practice-time-overall" class="block font-medium themed-text-secondary">Overall Time Limit (minutes)</label>
                                        <input type="number" id="practice-time-overall" class="mt-1 block w-full p-2 border rounded-md shadow-sm" placeholder="Optional: e.g., 60">
                                    </div>
                                    <div>
                                        <label for="practice-time-per-mcq" class="block font-medium themed-text-secondary">Time per MCQ (seconds)</label>
                                        <input type="number" id="practice-time-per-mcq" class="mt-1 block w-full p-2 border rounded-md shadow-sm" placeholder="Optional: e.g., 30">
                                    </div>
                                </div>
                                <button id="start-practice-btn" class="mt-4 py-3 px-6 rounded-lg font-bold w-full" style="background-color: var(--text-warning); color: var(--bg-primary);" aria-label="Start Practice Mode">Start Practice</button>
                                <p class="text-xs mt-2 text-center themed-text-tertiary">Get instant feedback with streaks & gamification.</p>
                            </div>
                            <div class="text-center">
                                <button id="revise-btn" class="py-3 px-6 rounded-lg font-bold w-full" style="background-color: #8b5cf6; color: white;" aria-label="Start Revise Mode">Revise Test</button>
                                <p class="text-xs mt-2 themed-text-tertiary">Freely browse all questions, answers, and explanations.</p>
                            </div>
                             <div id="saved-questions-container" class="text-center hidden">
                                 <button id="view-saved-btn" class="py-3 px-6 rounded-lg font-bold w-full relative" style="background-color: #4f46e5; color: white;" aria-label="View Saved Questions">
                                     Saved Questions
                                     <span id="saved-questions-count" class="absolute top-0 right-0 -mt-2 -mr-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                                 </button>
                                 <p class="text-xs mt-2 themed-text-tertiary">Review questions you've bookmarked.</p>
                            </div>
                            <div id="past-results-container" class="text-center hidden">
                                <button id="view-past-results-btn" class="py-3 px-6 rounded-lg font-bold w-full relative" style="background-color: #0d9488; color: white;" aria-label="View Past Results">
                                    View Past Results
                                    <span id="past-results-count" class="absolute top-0 right-0 -mt-2 -mr-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                                 </button>
                                 <p class="text-xs mt-2 themed-text-tertiary">Review your past exam performances.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCREEN 2: EXAM -->
        <div id="exam-screen" class="screen h-full relative">
            <!-- Main Content -->
            <div class="flex-1 flex flex-col">
                <header class="p-3 shadow-md flex justify-between items-center themed-bg-secondary themed-shadow">
                    <div class="flex items-center space-x-4">
                        <div>
                            <h1 id="section-name" class="text-xl font-bold themed-text-accent"></h1>
                            <p id="question-counter" class="text-sm themed-text-tertiary"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-xs font-bold themed-text-tertiary">created by mano</span>
                        <button id="calculator-toggle-btn" class="p-2 rounded-full themed-bg-accent-hover" aria-label="Toggle Calculator">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 themed-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                           </svg>
                        </button>
                        <div id="timer" class="text-xl font-mono px-4 py-1 rounded themed-bg-accent themed-text-primary" aria-label="Timer"></div>
                    </div>
                </header>

                <main class="flex-1 p-6 overflow-y-auto themed-bg-tertiary">
                    <div class="p-6 rounded-lg themed-bg-secondary">
                        <p id="question-text" class="text-lg font-semibold mb-6 whitespace-pre-wrap"></p>
                        <div id="question-image-container" class="my-4 flex justify-center"></div>
                        <div id="options-container" class="space-y-4"></div>
                    </div>
                </main>
                
                <footer class="p-4 themed-bg-secondary" style="box-shadow: 0 -2px 5px var(--shadow-color);">
                    <div class="flex justify-between items-center">
                        <div>
                            <button id="mark-review-btn" class="py-2 px-4 rounded text-white bg-purple-600 hover:bg-purple-700" aria-label="Mark for Review and Next">Mark for Review & Next</button>
                            <button id="clear-response-btn" class="py-2 px-4 rounded ml-4 themed-bg-accent themed-bg-accent-hover" aria-label="Clear Selected Response">Clear Response</button>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button id="prev-btn" class="py-2 px-6 rounded disabled:opacity-50 themed-bg-accent themed-bg-accent-hover" aria-label="Previous Question">Previous</button>
                            <button id="save-next-btn" class="py-2 px-6 rounded font-bold" style="background-color: #16a34a; color: white;" aria-label="Save Answer and Next Question">Save & Next</button>
                        </div>
                    </div>
                </footer>
            </div>

            <!-- Side Palette -->
            <aside id="question-palette" class="w-64 flex-shrink-0 relative transition-all duration-300 ease-in-out themed-bg-secondary">
                <div id="palette-content-wrapper" class="p-4 flex flex-col h-full w-full overflow-hidden transition-opacity duration-300">
                    <h2 class="text-lg font-bold mb-4 text-center">Question Palette</h2>
                    <div id="palette-container" class="grid grid-cols-5 gap-2 flex-1 overflow-y-auto"></div>
                     <div class="mt-4 text-xs space-y-2 themed-text-secondary">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center"><div class="w-4 h-4 rounded bg-green-600 mr-2"></div> Answered</div>
                            <span id="answered-count" class="font-bold px-1.5 py-0.5 rounded-full text-[10px] themed-bg-accent themed-text-primary">0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center"><div class="w-4 h-4 rounded bg-red-600 mr-2"></div> Not Answered</div>
                            <span id="not-answered-count" class="font-bold px-1.5 py-0.5 rounded-full text-[10px] themed-bg-accent themed-text-primary">0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center"><div class="w-4 h-4 rounded bg-gray-500 mr-2"></div> Not Visited</div>
                            <span id="not-visited-count" class="font-bold px-1.5 py-0.5 rounded-full text-[10px] themed-bg-accent themed-text-primary">0</span>
                        </div>
                         <div class="flex items-center justify-between">
                            <div class="flex items-center"><div class="w-4 h-4 rounded bg-purple-600 mr-2 relative"><svg xmlns="http://www.w3.org/2000/svg" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 h-2.5 w-2.5 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z" /></svg></div> Marked for Review</div>
                            <span id="marked-for-review-count" class="font-bold px-1.5 py-0.5 rounded-full text-[10px] themed-bg-accent themed-text-primary">0</span>
                        </div>
                    </div>
                </div>
                <button id="hide-palette-btn" class="absolute top-1/2 -left-3 z-10 p-1 rounded-full shadow-md border -translate-y-1/2" aria-label="Hide Question Palette">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                </button>
            </aside>

            <!-- Show Palette Button -->
            <button id="show-palette-btn" class="hidden absolute top-1/2 right-4 z-10 p-2 rounded-full shadow-lg border -translate-y-1/2" aria-label="Show Question Palette">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
            </button>
        </div>

        <!-- SCREEN 3: RESULTS -->
        <div id="results-screen" class="screen flex-col items-center justify-center p-8">
            <div class="w-full max-w-4xl p-8 rounded-lg shadow-lg themed-bg-secondary themed-shadow">
                <h1 class="text-4xl font-bold mb-4 text-center themed-text-accent">Exam Results</h1>
                <div id="exam-details" class="text-sm themed-text-secondary mb-6 border-b pb-4 space-y-1 themed-border-primary"></div>
                <div id="overall-performance" class="p-6 rounded-lg mb-8 text-center themed-bg-primary"></div>
                <h2 class="text-2xl font-semibold mb-4 text-center">Section-wise Analysis</h2>
                <div id="section-analysis" class="space-y-4"></div>
                <div class="mt-8 flex justify-center gap-4">
                    <button id="review-answers-btn" class="py-3 px-8 text-white rounded font-bold" style="background-color: var(--text-accent);" aria-label="Review Answers">Review Answers</button>
                    <button id="download-report-btn" class="py-3 px-8 text-white rounded font-bold" style="background-color: var(--text-success); color: var(--text-inverted);" aria-label="Download Report">Download Report</button>
                    <button id="restart-btn" class="py-3 px-8 rounded font-bold themed-bg-accent themed-text-primary" aria-label="Start New Exam">New Exam</button>
                </div>
            </div>
        </div>
        
        <!-- SCREEN 4: REVIEW -->
        <div id="review-screen" class="screen h-full flex-col">
          <header class="p-3 shadow-md flex justify-between items-center w-full themed-bg-secondary">
              <h1 id="review-title" class="text-xl font-bold themed-text-accent">Review Mode</h1>
               <div class="flex items-center space-x-4">
                    <button id="save-mcq-btn" class="p-2 rounded-full themed-bg-accent-hover" aria-label="Save Question">
                        <!-- SVG will be injected here -->
                    </button>
                    <button id="exit-revise-btn" class="py-2 px-4 rounded themed-bg-accent themed-bg-accent-hover hidden" aria-label="Exit Revise Mode">Exit Revise</button>
                    <button id="back-to-results-btn" class="py-2 px-4 rounded themed-bg-accent themed-bg-accent-hover" aria-label="Back to Results">Back to Results</button>
                </div>
          </header>
          <div id="review-palette-container" class="w-full max-w-4xl mx-auto p-4 border-b overflow-x-auto themed-bg-primary themed-border-primary">
             <div id="review-palette-grid" class="flex flex-nowrap gap-3 justify-start">
                 <!-- Review palette buttons will be injected here -->
             </div>
          </div>
          <main class="flex-1 p-6 overflow-y-auto w-full max-w-4xl mx-auto">
              <div class="p-6 rounded-lg themed-bg-secondary">
                  <div class="flex justify-between items-center">
                    <p id="review-question-text" class="text-lg font-semibold mb-6 whitespace-pre-wrap flex-1"></p>
                    <div id="review-time-taken" class="text-sm flex items-center ml-4 flex-shrink-0 themed-text-secondary"></div>
                  </div>
                  <div id="review-question-image-container" class="my-4 flex justify-center"></div>
                  <div id="review-options-container" class="space-y-4"></div>
                  
                  <!-- EXPLANATION SECTION -->
                  <div class="explanation-card" id="review-explanation-card">
                       <div class="explanation-header">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Explanation
                       </div>

                      <div id="explanation-image-container" class="my-4 flex justify-center"></div>
                      <div id="explanation-container" class="explanation-content prose max-w-none">
                          <!-- Explanation text will go here -->
                      </div>
                  </div>
              </div>
          </main>
          <footer class="p-4 shadow-inner flex justify-between items-center w-full themed-bg-secondary" style="box-shadow: 0 -2px 5px var(--shadow-color);">
              <button id="review-prev-btn" class="py-2 px-6 rounded disabled:opacity-50 themed-bg-accent themed-bg-accent-hover" aria-label="Previous Question">Previous</button>
              <span id="review-question-counter" class="font-bold"></span>
              <button id="review-next-btn" class="py-2 px-6 rounded disabled:opacity-50 themed-bg-accent themed-bg-accent-hover" aria-label="Next Question">Next</button>
          </footer>
        </div>
        
        <!-- SCREEN 5: PRACTICE MODE -->
        <div id="practice-screen" class="screen h-full flex-col relative">
            <header class="p-3 shadow-md flex justify-between items-center w-full themed-bg-secondary">
                <div class="flex items-center space-x-4">
                    <div>
                        <h1 class="text-xl font-bold themed-text-warning">Practice Mode</h1>
                        <p id="practice-subject-name" class="text-sm themed-text-tertiary"></p>
                    </div>
                </div>
                
                <!-- STREAK COUNTER & FEEDBACK -->
                <div id="practice-streak-container" class="flex-1 flex justify-center items-center">
                    <div id="streak-badge" class="streak-badge hidden">
                        <span class="mr-1">ðŸ”¥</span> Streak: <span id="streak-count" class="ml-1">0</span>
                    </div>
                    <!-- Header Feedback Badge -->
                    <div id="header-feedback-badge" class="feedback-badge">
                         <span id="header-feedback-text"></span>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <button id="save-mcq-practice-btn" class="p-2 rounded-full themed-bg-accent-hover" aria-label="Save Question">
                        <!-- SVG will be injected here -->
                    </button>
                    <button id="toggle-sparkles-btn" class="p-2 rounded-full themed-bg-accent-hover" aria-label="Toggle Sparkles">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                       </svg>
                    </button>
                    <button id="practice-calculator-toggle-btn" class="p-2 rounded-full themed-bg-accent-hover" aria-label="Toggle Calculator">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 themed-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                       </svg>
                    </button>
                    <div id="practice-timer" class="text-xl font-mono px-4 py-1 rounded hidden themed-bg-accent themed-text-primary" aria-label="Practice Timer"></div>
                    <button id="exit-practice-btn" class="py-2 px-4 rounded themed-bg-accent themed-bg-accent-hover" aria-label="Exit Practice Mode">Exit Practice</button>
                </div>
            </header>
            
            <div id="practice-palette-container" class="w-full max-w-4xl mx-auto p-4 border-b overflow-x-auto themed-bg-primary themed-border-primary">
                 <div id="practice-palette-grid" class="flex flex-nowrap gap-3 justify-start">
                     <!-- Practice palette buttons injected by JS -->
                 </div>
            </div>

            <div id="per-question-timer-container" class="w-full h-2 themed-bg-accent hidden">
                <div id="per-question-timer-bar" class="h-full bg-green-500" style="transition: width 150ms linear;"></div>
            </div>
            <main class="flex-1 p-6 overflow-y-auto w-full max-w-4xl mx-auto">
                <div class="p-6 rounded-lg themed-bg-secondary">
                    <p id="practice-question-text" class="text-lg font-semibold mb-6 whitespace-pre-wrap"></p>
                    <div id="practice-question-image-container" class="my-4 flex justify-center"></div>
                    <div id="practice-options-container" class="space-y-4"></div>
                    
                    <!-- EXPLANATION SECTION -->
                    <div id="practice-explanation-section" class="hidden explanation-card">
                        <div class="explanation-header">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Explanation
                        </div>
                        
                        <div id="practice-explanation-image-container" class="my-4 flex justify-center"></div>
                        <div id="practice-explanation-container" class="explanation-content prose max-w-none">
                            <!-- Explanation text will go here -->
                        </div>
                    </div>
                </div>
            </main>
            <footer class="p-4 shadow-inner flex justify-between items-center w-full themed-bg-secondary" style="box-shadow: 0 -2px 5px var(--shadow-color);">
                <button id="practice-prev-btn" class="py-2 px-6 rounded disabled:opacity-50 themed-bg-accent themed-bg-accent-hover" aria-label="Previous Question">Previous</button>
                <span id="practice-question-counter" class="font-bold"></span>
                <button id="practice-next-btn" class="py-2 px-6 rounded disabled:opacity-50 themed-bg-accent themed-bg-accent-hover" aria-label="Next Question">Next</button>
            </footer>
        </div>

        <!-- SCREEN 6: PRACTICE RESULTS -->
        <div id="practice-results-screen" class="screen flex-col items-center justify-center p-8">
            <div class="w-full max-w-2xl p-8 rounded-lg shadow-lg text-center themed-bg-secondary themed-shadow">
                <h1 class="text-4xl font-bold mb-4 themed-text-warning">Practice Results</h1>
                <div id="practice-exam-details" class="text-sm themed-text-secondary mb-6 border-b pb-4 space-y-1 themed-border-primary"></div>
                
                <div class="p-6 rounded-lg mb-8 themed-bg-primary">
                    <h2 class="text-2xl font-semibold">Your Performance</h2>
                    <p id="practice-score" class="text-5xl font-bold my-4"></p>
                    <div class="flex justify-center space-x-8 text-lg">
                        <span id="practice-correct"></span>
                        <span id="practice-incorrect"></span>
                        <span id="practice-attempted"></span>
                    </div>
                     <div id="practice-avg-time" class="mt-4 themed-text-secondary"></div>
                </div>
                
                <div class="mt-8 flex justify-center gap-4">
                    <button id="review-practice-answers-btn" class="py-3 px-8 rounded font-bold" style="background-color: var(--text-accent); color: var(--text-inverted);" aria-label="Review Practice Answers">Review Answers</button>
                    <button id="restart-practice-btn" class="py-3 px-8 rounded font-bold" style="background-color: var(--text-warning); color: var(--bg-primary);" aria-label="Restart Practice">Restart Practice</button>
                    <button id="back-to-setup-btn" class="py-3 px-8 rounded font-bold themed-bg-accent themed-text-primary" aria-label="Back to Setup">Back to Setup</button>
                </div>
            </div>
        </div>

        <!-- SCREEN 7: PAST RESULTS HISTORY -->
        <div id="past-results-screen" class="screen flex-col items-center justify-center p-8">
            <div class="w-full max-w-3xl p-8 rounded-lg shadow-lg themed-bg-secondary themed-shadow">
                <h1 class="text-3xl font-bold mb-6 text-center themed-text-accent">Past Exam Results</h1>
                <div id="past-results-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                    <!-- Past results will be injected here -->
                </div>
                <div class="mt-8 flex justify-center">
                    <button id="back-to-setup-from-history-btn" class="py-3 px-8 rounded font-bold themed-bg-accent themed-text-primary" aria-label="Back to Setup">Back to Setup</button>
                </div>
            </div>
        </div>

        <!-- SCREEN 8: PROGRESS ANALYTICS (CHARTS) -->
        <div id="progress-screen" class="screen flex-col items-center justify-center p-8">
            <div class="w-full max-w-5xl p-8 rounded-lg shadow-lg themed-bg-secondary themed-shadow overflow-y-auto max-h-full">
                <h1 class="text-3xl font-bold mb-6 text-center themed-text-accent">Performance Analytics</h1>
                
                <!-- KPI Dashboard (Inserted) -->
                <div id="kpi-dashboard" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <!-- Cards injected by JS -->
                </div>

                <!-- Exam Progress -->
                <div class="mb-8">
                    <h2 class="text-xl font-bold mb-4 themed-text-primary flex items-center">
                        <svg class="w-5 h-5 mr-2 themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        Exam History
                    </h2>
                    <div id="exam-chart-container" class="chart-wrapper">
                        <!-- Exam bars injected here -->
                    </div>
                    <p id="exam-chart-empty" class="text-sm themed-text-tertiary mt-2 text-center hidden">No exam attempts recorded yet.</p>
                </div>

                <!-- Practice Progress -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold themed-text-warning flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            Practice History
                        </h2>
                        <button id="reset-practice-history-btn" class="text-xs py-1 px-3 rounded border border-red-300 text-red-500 hover:bg-red-50">Reset Practice History</button>
                    </div>
                    <div id="practice-chart-container" class="chart-wrapper">
                        <!-- Practice bars injected here -->
                    </div>
                    <p id="practice-chart-empty" class="text-sm themed-text-tertiary mt-2 text-center hidden">No practice sessions recorded yet.</p>
                </div>

                <div class="flex justify-center">
                    <button id="back-to-setup-from-progress-btn" class="py-3 px-8 rounded font-bold themed-bg-accent themed-text-primary" aria-label="Back to Setup">Back to Setup</button>
                </div>
            </div>
        </div>


        <!-- MODAL: CONFIRMATION -->
        <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
            <div class="p-8 rounded-lg shadow-xl max-w-sm w-full text-center modal-card">
                <h2 class="text-xl font-bold mb-4">Confirm Action</h2>
                <p id="confirmation-message" class="mb-6 themed-text-secondary"></p>
                <div class="flex justify-center gap-4">
                    <button id="cancel-confirmation-btn" class="py-2 px-6 rounded font-semibold themed-bg-accent themed-bg-accent-hover" aria-label="Cancel Action">Cancel</button>
                    <button id="confirm-action-btn" class="py-2 px-6 rounded font-semibold text-white" style="background-color: var(--text-danger); color: var(--text-inverted);" aria-label="Confirm Action">Proceed</button>
                </div>
            </div>
        </div>

        <!-- MODAL: REPORT OPTIONS -->
        <div id="report-options-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
            <div class="p-8 rounded-lg shadow-xl max-w-sm w-full text-center modal-card">
                <h2 class="text-xl font-bold mb-4">Download Report</h2>
                <p class="mb-6 themed-text-secondary">Would you like to include the explanations in your PDF report?</p>
                <div class="flex flex-col gap-4">
                    <button id="download-with-explanations-btn" class="py-2 px-6 rounded font-semibold" style="background-color: var(--text-success); color: var(--text-inverted);" aria-label="Download with explanations">With Explanations</button>
                    <button id="download-without-explanations-btn" class="py-2 px-6 rounded font-semibold" style="background-color: var(--text-accent); color: var(--text-inverted);" aria-label="Download without explanations">Without Explanations</button>
                    <button id="cancel-report-download-btn" class="py-2 px-6 rounded font-semibold mt-2 themed-bg-accent themed-bg-accent-hover" aria-label="Cancel Download">Cancel</button>
                </div>
            </div>
        </div>

        <!-- MODAL: PRACTICE RESUME -->
        <div id="practice-resume-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
            <div class="p-8 rounded-lg shadow-xl max-w-sm w-full text-center modal-card">
                <h2 class="text-xl font-bold mb-4">Resume Practice</h2>
                <p class="mb-6 themed-text-secondary">You have a saved practice session. Would you like to continue where you left off?</p>
                <div class="flex justify-center gap-4">
                    <button id="practice-start-new-btn" class="py-2 px-6 rounded font-semibold themed-bg-accent themed-bg-accent-hover" aria-label="Start new practice">Start New</button>
                    <button id="practice-resume-btn" class="py-2 px-6 rounded font-semibold text-white bg-yellow-500 hover:bg-yellow-600" aria-label="Resume practice">Resume</button>
                </div>
            </div>
        </div>
        
        <!-- CALCULATOR MODAL -->
        <div id="calculator-modal" class="calculator-modal absolute w-64 rounded-lg shadow-2xl z-50 hidden">
            <div id="calculator-header" class="p-2 flex justify-between items-center rounded-t-lg cursor-move themed-bg-accent">
                <span class="font-bold themed-text-secondary">Calculator</span>
                <button id="calculator-close-btn" class="text-xl themed-text-secondary hover:themed-text-primary" aria-label="Close Calculator">&times;</button>
            </div>
            <div class="p-4">
                <div id="calculator-display" class="text-right text-3xl font-mono p-2 rounded mb-4 overflow-x-auto themed-bg-tertiary" aria-label="Calculator Display">0</div>
                <div id="calculator-buttons" class="grid grid-cols-4 gap-2">
                    <button class="calculator-btn col-span-2" style="background-color: var(--text-danger); color: var(--text-inverted);" aria-label="Clear Calculation">C</button>
                    <button class="calculator-btn operator themed-bg-accent themed-bg-accent-hover">/</button>
                    <button class="calculator-btn operator themed-bg-accent themed-bg-accent-hover">*</button>

                    <button class="calculator-btn digit themed-bg-tertiary">7</button>
                    <button class="calculator-btn digit themed-bg-tertiary">8</button>
                    <button class="calculator-btn digit themed-bg-tertiary">9</button>
                    <button class="calculator-btn operator themed-bg-accent themed-bg-accent-hover">-</button>

                    <button class="calculator-btn digit themed-bg-tertiary">4</button>
                    <button class="calculator-btn digit themed-bg-tertiary">5</button>
                    <button class="calculator-btn digit themed-bg-tertiary">6</button>
                    <button class="calculator-btn operator themed-bg-accent themed-bg-accent-hover">+</button>

                    <button class="calculator-btn digit themed-bg-tertiary">1</button>
                    <button class="calculator-btn digit themed-bg-tertiary">2</button>
                    <button class="calculator-btn digit themed-bg-tertiary">3</button>
                    <button class="calculator-btn equals row-span-2" style="background-color: var(--text-accent); color: var(--text-inverted);" aria-label="Calculate Result">=</button>
                    
                    <button class="calculator-btn col-span-2 digit themed-bg-tertiary">0</button>
                    <button class="calculator-btn decimal themed-bg-tertiary">.</button>
                </div>
            </div>
        </div>
    </main>

<script>
    // --- APP INITIALIZATION ---
    // Prevent right-click to protect content
    document.addEventListener('contextmenu', (e) => e.preventDefault());

    // Prevent inspection via keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
        if (e.key === 'F12' || 
            (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) || 
            (e.ctrlKey && e.key === 'U')) {
            e.preventDefault();
        }
    });

    window.addEventListener('DOMContentLoaded', () => {
      try {
        // --- DATA & STATE ---
        // FIX: Using renamed variable from outer scope.
        const examId = 'exam_1764430810115_td9ax66';
        const mcqs = [{"id":1,"question":"The primary purpose of the American Society of Anesthesiologists (ASA) Physical Status classification system is to:","options":{"a":"Predict the post-operative outcome for the patient.","b":"Estimate the difficulty of the surgical procedure.","c":"Assess the patient's overall health and classify operative risk.","d":"Determine the anesthetic technique to be used."},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nThe **ASA classification** is a standardized preoperative assessment tool that stratifies patients into six categories (I-VI) based on systemic disease and comorbidities. It does NOT predict specific outcomes, estimate surgical difficulty, or determine anesthetic techniqueâ€”it purely **classifies operative risk** by evaluating overall health status. This helps stratify perioperative risk and guides resource allocation.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Predict post-operative outcome): Classification is predictive of **risk**, not specific outcomes; outcome also depends on surgical factors, anesthesia management, and post-operative care.\n\n**Option B** (Estimate surgical difficulty): ASA assesses **patient** status, not procedural complexity; surgical difficulty is independent.\n\n**Option D** (Determine anesthetic technique): Technique selection depends on procedure type, patient preference, and contraindicationsâ€”not solely ASA class.\n\n**Exam Essentials:**\n\nASA I = Healthy; ASA II = Mild systemic disease; ASA III = Severe systemic disease; ASA IV = Life-threatening disease; ASA V = Moribund; ASA VI = Brain-dead\n\nHigher ASA class correlates with increased perioperative morbidity and mortality\n\nEmergency surgery adds \"E\" suffix (e.g., ASA III-E)\n\n**Logical Learning Aids:**\n\"SAIL UP\" â€“ ASA classification memory: **S**ystemic disease Assessment, **I**ncreased risk (I-VI), **L**ower class better, **U**pward = worse, **P**reoperative prediction of risk."},{"id":2,"question":"Which of the following is an example of an ASA Class IV patient?","options":{"a":"A 50-year-old with well-controlled hypertension.","b":"A 65-year-old with a recent myocardial infarction.","c":"A 70-year-old with diabetes and obesity.","d":"A 40-year-old with a localized infection."},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation:**\n**ASA IV patients** have a life-threatening systemic disease that is in constant threat to life and requires intensive treatment. A **recent myocardial infarction** (Option B) represents acute cardiac compromise with ongoing risk of arrhythmias, reinfarction, or cardiogenic shockâ€”a classic ASA IV scenario. Well-controlled conditions (hypertension, diabetes, obesity) without acute decompensation fall into ASA II or III.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Well-controlled hypertension): Managed chronic disease = ASA II, not IV.\n\n**Option C** (Diabetes and obesity): Chronic conditions without acute threat = ASA III at most.\n\n**Option D** (Localized infection): Minor acute illness = ASA II, unless septic/systemic.\n\n**Exam Essentials:**\n\nASA IV = Constant threat to life; acute coronary syndrome, sepsis, uncontrolled arrhythmia, severe valvular disease, organ failure\n\nRecent MI poses risk of reinfarction (10-15% within 3 months if unoptimized perioperatively)\n\nRequires aggressive preoperative optimization and perioperative monitoring\n\n**Logical Learning Aids:**\n\"Critical Condition Constant\" â€“ ASA IV = constant threat to life requiring intensive management; think acute/unstable **not** chronic/controlled."},{"id":3,"question":"The above classification is used to assess the: {image 1}","options":{"a":"Risk of aspiration.","b":"Difficulty of laryngoscopy and intubation.","c":"Patient's sedation level.","d":"Risk of post-operative nausea and vomiting."},"correctAnswer":"b","explanation":""},{"id":4,"question":"A patient taking clopidogrel for a recent coronary stent placement is scheduled for a major non-cardiac surgery. What is the recommended management plan?","options":{"a":"Continue clopidogrel throughout the perioperative period.","b":"Stop clopidogrel at least 5 days before surgery.","c":"Stop clopidogrel immediately and start heparin bridging.","d":"Stop clopidogrel at least 24 hours before surgery."},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation:**\n**Clopidogrel** is a P2Y12 inhibitor; stopping it **â‰¥5 days before surgery** allows platelet function recovery. For **recent coronary stents**, dual antiplatelet therapy (DAPT) is critical to prevent stent thrombosis (catastrophic, 15-30% mortality if occurs). However, for **major non-cardiac surgery**, the bleeding risk vs. thrombosis risk must be weighedâ€”consensus is **5-7 days off clopidogrel** before major surgery unless life-threatening risk of stent thrombosis exists. Continuing throughout causes excessive bleeding; stopping \u003c5 days inadequate platelet recovery.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Continue throughout): Unacceptable bleeding risk in major surgery.\n\n**Option C** (Stop immediately + heparin bridging): Clopidogrel has no direct bridging antidote; heparin does not \"bridge\" P2Y12 inhibition like it bridges warfarin.\n\n**Option D** (Stop 24 hours): Insufficient recovery time; platelet function requires 5-7 days to normalize.\n\n**Exam Essentials:**\n\nRecent coronary stent (\u003c12 months) = high thrombosis risk; defer elective surgery if possible\n\nStent type matters: **bare metal stents (BMS)** need â‰¥30 days DAPT; **drug-eluting stents (DES)** need â‰¥3-12 months\n\nFor life-threatening surgery, continue clopidogrel; manage bleeding risk with transfusion\n\nASA/ACC guidelines: â‰¥5 days discontinuation for major non-cardiac surgery\n\n**Logical Learning Aids:**\n\"DAPT = 5 to Operate\" â€“ For clopidogrel/DAPT, stop â‰¥5 days before major surgery unless stent thrombosis risk outweighs bleeding risk."},{"id":5,"question":"What is the primary reason for administering a stress dose of glucocorticoids to a steroid-dependent patient undergoing surgery?","options":{"a":"To prevent hyperglycemia.","b":"To improve wound healing.","c":"To replace the adrenal gland's inability to increase cortisol during the stress of surgery.","d":"To enhance the effects of anesthetic agents."},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nChronic glucocorticoid therapy suppresses hypothalamic-pituitary-adrenal (HPA) axis, causing adrenal atrophy. During surgical stress, the body normally increases cortisol 2-3 fold; suppressed adrenals **cannot mount this response**, causing **acute adrenal insufficiency** with cardiovascular collapse and hypoglycemia. **Stress-dose steroids** replace this deficit and restore hemodynamic stability. This is NOT about hyperglycemia prevention or wound healingâ€”it's about **preventing acute adrenal crisis**.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Prevent hyperglycemia): Steroids **cause** hyperglycemia, not prevent it; glucose management is separate.\n\n**Option B** (Improve wound healing): Steroids impair wound healing; this is never a reason to give stress-dose steroids.\n\n**Option D** (Enhance anesthetic effects): No interaction; anesthesia works independently of cortisol.\n\n**Exam Essentials:**\n\nHPA suppression occurs with >2 weeks of >20 mg/day hydrocortisone equivalent\n\nStress-dose protocol: 50-100 mg IV hydrocortisone at induction, then 25-50 mg every 6-8 hours for 24 hours (major surgery)\n\nRisk: Acute hypotension, hyponatremia, hypoglycemia, cardiovascular collapse\n\nMinor procedures (local anesthesia) may need only usual morning dose\n\n**Logical Learning Aids:**\n\"Stress = Steroids (SS)\" â€“ Chronic steroid users undergoing surgery need stress-dose glucocorticoids to prevent adrenal crisis; HPA axis cannot respond to surgical stress."},{"id":6,"question":"A patient on long-term steroid therapy is undergoing a minor outpatient procedure requiring only local anesthesia. What is the recommended perioperative steroid management?","options":{"a":"Administer a stress dose of IV hydrocortisone.","b":"Prescribe a tapering dose of oral steroids postoperatively.","c":"No additional steroid supplementation is required beyond the patient's usual morning dose.","d":"Discontinue steroids completely 24 hours before the procedure."},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nFor **minor procedures under local anesthesia**, surgical stress is minimalâ€”the adrenal gland does NOT require supplementation beyond the patient's usual maintenance dose. The **HPA axis can generate adequate cortisol** in response to minor stress. Unnecessary stress-dose steroids increase infection risk, hyperglycemia, and other side effects. **No additional supplementation** is needed for minor local procedures.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (IV hydrocortisone stress dose): Overkill for minor local procedure; increases risks without benefit.\n\n**Option B** (Tapering dose postoperatively): No indication for tapering; maintain usual dose.\n\n**Option D** (Discontinue 24 hours before): Dangerous; causes acute withdrawal and adrenal crisis; never discontinue abruptly.\n\n**Exam Essentials:**\n\nMinor stress (local/regional procedures) = continue usual morning dose only\n\nModerate stress (minor general surgery) = 25 mg hydrocortisone at induction, then usual dose\n\nMajor stress (major surgery, sepsis) = 50-100 mg at induction, then 25-50 mg every 6-8 hours for 24 hours\n\nNever abruptly discontinue chronic steroids; risk of acute adrenal insufficiency\n\n**Logical Learning Aids:**\n\"Minor Stress = Minor Steroids\" â€“ Minor procedures need only usual maintenance; stress-dose only for moderate-to-major surgery. Always continue (never stop abruptly) chronic steroids."},{"id":7,"question":"A sudden and complete loss of the capnograph waveform, after it was previously present, most likely indicates:","options":{"a":"A successful resuscitation","b":"A problem with the patient's metabolism","c":"A disconnected or displaced endotracheal tube","d":"A normal variation in breathing"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\n**Sudden, complete capnography waveform loss** after a previously present waveform indicates **disconnection or displacement of the endotracheal tube** (ETT). COâ‚‚ is no longer exhaled through the sensor, eliminating the waveform. This is a **critical alarm** requiring immediate action: check tube position, re-secure, or re-intubate. Causes include tube migration out of trachea, accidental extubation, or sensor disconnection.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Successful resuscitation): ROSC produces a capnography waveform; loss of waveform â‰  successful resuscitation.\n\n**Option B** (Problem with metabolism): Metabolic issues cause waveform **changes** (â†“ amplitude, â†“ slope), not **disappearance**.\n\n**Option D** (Normal variation): Sudden complete loss is abnormal and requires investigation.\n\n**Exam Essentials:**\n\nCapnography loss = tube problem until proven otherwise (disconnection, obstruction, esophageal intubation, cardiac arrest)\n\nEsophageal intubation produces brief COâ‚‚ (from stomach), then disappears; disconnection = immediate loss\n\nNormal capnography waveform is 30-40 mmHg at end-tidal; gradual â†“ suggests metabolism problem\n\nCapnography is gold standard for ETT confirmation\n\n**Logical Learning Aids:**\n\"Flat Cap = Tube Gap\" â€“ Sudden flat capnography = disconnected or displaced tube; check tube immediately."},{"id":8,"question":"What is the clinical significance of continuous capnography during cardiopulmonary resuscitation?","options":{"a":"To measure oxygen saturation","b":"To monitor the patient's temperature","c":"To assess the effectiveness of CPR and detect return of spontaneous circulation","d":"To track the patient's heart rate"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\n**Continuous capnography during CPR** serves as a **real-time monitor of CPR effectiveness** and **early predictor of return of spontaneous circulation (ROSC)**. Low or absent end-tidal COâ‚‚ (\u003c10 mmHg) suggests poor perfusion and cardiac output; a **sudden rise** in end-tidal COâ‚‚ indicates ROSC. This is more sensitive and earlier than pulse checks, guiding resuscitation decisions and determining prognosis (persistently low ETCOâ‚‚ suggests futility).\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Measure oxygen saturation): Pulse oximetry measures SpOâ‚‚, not capnography.\n\n**Option B** (Monitor temperature): Esophageal/core temperature monitors measure temperature, not capnography.\n\n**Option D** (Track heart rate): ECG/pulse monitors track heart rate, not capnography.\n\n**Exam Essentials:**\n\nETCOâ‚‚ >10-15 mmHg = likely ROSC; sustained \u003c10 mmHg = poor prognosis (consider stopping resuscitation)\n\nCapnography is sensitive early marker of perfusion; pulse checks lag behind\n\nACLS guidelines: Use capnography for real-time CPR quality feedback and ROSC detection\n\nCapnography availability predicts better outcomes in cardiac arrest\n\n**Logical Learning Aids:**\n\"COâ‚‚ = Circulation\" â€“ Capnography reflects cardiac output during CPR; rising ETCOâ‚‚ = ROSC; persistently low = poor prognosis. Use to guide CPR quality and termination decisions."},{"id":9,"question":"What is the cause of the \"curare cleft\" observed in a capnography waveform? {image 2}","options":{"a":"Airway obstruction","b":"Patient's spontaneous breathing efforts during mechanical ventilation","c":"Pulmonary embolism","d":"Esophageal intubation"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation:**\nThe **\"curare cleft\"** is a distinctive **dip or notch in the plateau phase** of the capnography waveform, caused by **spontaneous patient breathing during mechanical ventilation**. When the paralyzed patient (or inadequately paralyzed) takes a spontaneous breath during a mechanical breath, it creates a transient decrease in ETCOâ‚‚ (from mixing of fresh alveolar gas), producing the characteristic \"cleft\" appearance. Named after curare (paralytic drug), it indicates **inadequate neuromuscular blockade** or insufficient paralysis.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Airway obstruction): Causes changes in waveform shape but not the characteristic cleft; obstruction shows â†“ amplitude.\n\n**Option C** (Pulmonary embolism): Causes sudden â†“ ETCOâ‚‚ and waveform flattening, not a cleft.\n\n**Option D** (Esophageal intubation): Produces brief COâ‚‚ waveform, then disappears; no cleft pattern.\n\n**Exam Essentials:**\n\nCurare cleft = spontaneous breathing + mechanical ventilation â†’ indicates inadequate paralysis\n\nManagement: Increase neuromuscular blocker dose, adjust ventilator settings, or check for neuromuscular blocker failure\n\nCapnography abnormalities: â†“ amplitude = hypoventilation/obstruction; â†‘ slope = airway obstruction; cleft = spontaneous breathing\n\nTrain-of-four (TOF) monitoring confirms neuromuscular blockade adequacy\n\n**Logical Learning Aids:**\n\"Cleft = Breath Conflict\" â€“ Curare cleft = spontaneous patient breath conflicting with mechanical breath; indicates inadequate paralysis. Increase neuromuscular blocker."},{"id":10,"question":"A pulse oximeter primarily measures the percentage of which of the following?","options":{"a":"Carbon dioxide in the blood","b":"Oxygenated hemoglobin in the arterial blood","c":"Dissolved oxygen in the blood plasma","d":"Venous hemoglobin in the blood"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation:**\nPulse oximetry measures SpOâ‚‚, the percentage of **oxygenated hemoglobin (HbOâ‚‚) in arterial blood**. Using **infrared spectrophotometry** (Beer-Lambert Law), it detects light absorption by HbOâ‚‚ vs. deoxyhemoglobin. It does NOT measure COâ‚‚ (capnography), dissolved Oâ‚‚ (blood gas), or venous bloodâ€”only **arterial oxyhemoglobin percentage**. Normal SpOâ‚‚ >95%; \u003c90% indicates hypoxemia.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Carbon dioxide): Capnography measures COâ‚‚, not pulse oximetry.\n\n**Option C** (Dissolved oxygen): \u003c2% of blood oxygen is dissolved; pulse oximetry measures bound hemoglobin only.\n\n**Option D** (Venous hemoglobin): Pulse oximetry specifically measures **arterial** blood (pulsatile component).\n\n**Exam Essentials:**\n\nNormal SpOâ‚‚: >95% in room air; \u003c90% = hypoxemia requiring intervention\n\nLimitations: Affected by motion, poor perfusion, hemoglobinopathies (carboxyhemoglobin, methemoglobin), skin pigmentation\n\nAccuracy Â±2-3% at SpOâ‚‚ 95-100%; less accurate below 80%\n\nCapnography + Oximetry = comprehensive oxygenation + ventilation monitoring\n\n**Logical Learning Aids:**\n\"SpOâ‚‚ = Saturated Oâ‚‚ in Hemoglobin\" â€“ Pulse oximetry measures **oxygenated hemoglobin percentage** in arterial blood using infrared light absorption."},{"id":11,"question":"Which of the following conditions can cause a false SpO2 reading?","options":{"a":"Anemia","b":"Severe hypothermia","c":"In Neonates","d":"Jaundice"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation:**\n**Severe hypothermia** causes **profound vasoconstriction**, reducing peripheral perfusion to the point where pulse oximetry cannot detect pulsatile arterial blood flow. The sensor cannot differentiate arterial from venous blood, producing **unreliable or absent SpOâ‚‚ reading**. This is a classic cause of **false/unreliable SpOâ‚‚**. Other causes include carbon monoxide poisoning (carboxyhemoglobin mimics HbOâ‚‚ in infrared spectrum) and severe anemia (insufficient Hb to produce pulsatile signal).\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Anemia): Mild anemia doesn't cause false readings; severe anemia may reduce signal amplitude but not necessarily false readings.\n\n**Option C** (Neonates): SpOâ‚‚ can be accurately measured in neonates; pulse oximetry is standard neonatal monitoring.\n\n**Option D** (Jaundice): Bilirubin doesn't interfere with infrared spectrophotometry; no false readings.\n\n**Exam Essentials:**\n\nSevere hypothermia (\u003c28Â°C) = profound vasoconstriction â†’ no pulsatile flow â†’ unreliable SpOâ‚‚\n\nCarboxyhemoglobin/Methemoglobin = spurious SpOâ‚‚ (HbCO resembles HbOâ‚‚ to infrared light)\n\nPoor perfusion (shock, cardiac arrest) = weak or absent pulse signal â†’ unreliable SpOâ‚‚\n\n\"The patient is not dead until they are warm and dead\" â€“ Hypothermic patients can recover; rely on core temp + clinical signs, not SpOâ‚‚\n\n**Logical Learning Aids:**\n\"No Pulse = No SpOâ‚‚\" â€“ Severe hypothermia causes profound vasoconstriction and loss of peripheral pulsatile flow, making SpOâ‚‚ unreliable; use core temperature + clinical assessment."},{"id":12,"question":"Which law is the fundamental principle of pulse oximetry, relating the concentration of a substance to the absorption of light?","options":{"a":"Boyle's Law","b":"Charles's Law","c":"Beer-Lambert Law","d":"Fick's Law"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nThe **Beer-Lambert Law** states that the **absorption of light by a substance is proportional to its concentration**. Mathematically: **A = Îµbc** (Absorbance = extinction coefficient Ã— concentration Ã— path length). In **pulse oximetry**, this principle applies: infrared light passes through tissue; **HbOâ‚‚ and deoxyhemoglobin absorb light at different wavelengths** (660 nm red for deoxyhb; 940 nm infrared for HbOâ‚‚). The **ratio of light absorbed** calculates SpOâ‚‚ percentage.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Boyle's Law): Relates gas pressure and volume; irrelevant to light absorption.\n\n**Option B** (Charles's Law): Relates gas volume and temperature; irrelevant to spectrophotometry.\n\n**Option D** (Fick's Law): Relates gas diffusion across membranes; not about light absorption.\n\n**Exam Essentials:**\n\nBeer-Lambert Law = foundation of pulse oximetry spectrophotometry\n\nTwo wavelengths used: ~660 nm (red light) and ~940 nm (near-infrared) to differentiate HbOâ‚‚ vs. deoxyhemoglobin\n\nPulsatile component = isolated by detecting only the AC (alternating) component of light absorption (arterial vs. venous/tissue baseline)\n\nAccuracy limited below SpOâ‚‚ 80% (less color difference between HbOâ‚‚ and deoxyhemoglobin at low saturation)\n\n**Logical Learning Aids:**\n\"Beer-Lambert = Light Absorption Law\" â€“ Absorption of light âˆ concentration of substance; pulse oximetry uses this to measure HbOâ‚‚ concentration from light absorption patterns."},{"id":13,"question":"What is the primary safety feature to prevent connecting the wrong gas cylinder to a machine?","options":{"a":"Color coding","b":"Pressure gauge","c":"Pin index system","d":"Yoke block."},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nThe **pin index system** is a **mechanical safety system** that physically prevents connecting the wrong gas cylinder to an anesthesia machine. Each gas has a **unique configuration of two pins** on the yoke inlet; only cylinders with the **matching pin holes** can connect, making wrong connections mechanically impossible. This is the **most reliable safety feature** for cylinder connection, superior to color coding alone (which is human-error prone).\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Color coding): Helps **identify** gases visually but doesn't **prevent** wrong connections; human error can override.\n\n**Option B** (Pressure gauge): Measures cylinder pressure; irrelevant to preventing wrong connections.\n\n**Option D** (Yoke block): Holds the cylinder; doesn't prevent wrong connection.\n\n**Exam Essentials:**\n\nPin index configurations are cylinder-specific: Oâ‚‚ (pins 2,5), Nâ‚‚O (pins 3,5), air (pins 1,5), helium (pins 4,5), COâ‚‚ (pins 4,6)\n\nColor codes (Oâ‚‚=green, Nâ‚‚O=blue, air=yellow, COâ‚‚=gray) aid quick identification but are not foolproof\n\nFail-safe mechanisms prevent hypoxia if Oâ‚‚ supply fails by shutting off Nâ‚‚O\n\nRegulators have cylinder-specific connections; pin index is the mechanical backup\n\n**Logical Learning Aids:**\n\"Pins = Prevent Mistakes\" â€“ Pin index system mechanically prevents wrong cylinder connections; memorize common configurations (Oâ‚‚=2-5, Nâ‚‚O=3-5, air=1-5, COâ‚‚=4-6)."},{"id":14,"question":"What is the standard color code for a nitrous oxide cylinder?","options":{"a":"Blue body, white shoulder","b":"Blue body","c":"Green body","d":"Black body, white shoulder"},"correctAnswer":"b","explanation":""},{"id":15,"question":"What is the primary function of the emergency oxygen flush button on an anesthesia machine?","options":{"a":"To deliver a precise, low flow of oxygen","b":"To bypass the low pressure circuit and deliver a high flow of 100% oxygen","c":"To turn off all gas flow to the patient","d":"To provide suction to clear the patient's airway"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation:**\nThe **emergency oxygen flush button** on an anesthesia machine **bypasses the low-pressure circuit (vaporizers and flowmeters)** and delivers a **high flow of 100% oxygen (35-75 L/min)** directly to the patient's breathing circuit. It's used in **emergencies** (hypoxia, unable to ventilate) to rapidly deliver oxygen, or for **clearing volatile anesthetic from the circuit**. NOT a precise low-flow deliveryâ€”it's a **high-flow emergency tool**.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Precise, low flow): Opposite function; delivers **high** flow, not precise low flow; flowmeters provide precise low flow.\n\n**Option C** (Turn off all gas flow): The flush button **adds** oxygen; it doesn't stop flow.\n\n**Option D** (Provide suction): Unrelated; suction is separate.\n\n**Exam Essentials:**\n\nFlow rate: 35-75 L/min oxygen (depends on machine design)\n\nPrimary use: Emergency hypoxemia correction\n\nSecondary use: Rapidly wash volatile anesthetic from circuit (e.g., if malignant hyperthermia suspected)\n\nRisk: Can cause **barotrauma** if overused, especially in small children or during controlled ventilation\n\nDuration: Usually limited to 1-2 seconds; avoid prolonged use\n\n**Logical Learning Aids:**\n\"Flush = Fast, High-Flow Emergency Oâ‚‚\" â€“ Emergency oxygen flush = high-flow (35-75 L/min) 100% oxygen bypass for hypoxia emergencies; risk = barotrauma if overused."},{"id":16,"question":"What is a major safety risk associated with the inappropriate use of the oxygen flush valve?","options":{"a":"Hypoxia","b":"Anesthetic overdose","c":"Barotrauma (lung damage)","d":"Dilution of anesthetic agent"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\n**Barotrauma** (lung injury from excessive pressure) is a major safety risk with the **emergency oxygen flush**. If the flush button is held too long or if the breathing circuit is blocked (closed pop-off valve, inadequate ventilation), the **high pressure (35-75 L/min at 45-55 cm Hâ‚‚O)** can **rupture alveoli**, causing **pneumothorax, pneumomediastinum, or subcutaneous emphysema**. This is particularly dangerous in **infants and children** (less compliant lungs) and during **positive pressure ventilation**.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Hypoxia): The flush **prevents** hypoxia by delivering Oâ‚‚.\n\n**Option B** (Anesthetic overdose): Flush **removes** anesthetic from circuit; doesn't cause overdose.\n\n**Option D** (Dilution of anesthetic agent): Flush dilutes volatile anesthetic; this is **desirable** in emergencies (MH), not a risk.\n\n**Exam Essentials:**\n\nBarotrauma = pressure-related lung injury; classic complications include pneumothorax, tension pneumothorax, air trapping\n\nRisk factors: Small children (\u003c 5 kg), stiff lungs (ARDS, pulmonary fibrosis), apnea circuit with pop-off valve occluded\n\nPrevention: Brief flush duration (1-2 sec), keep circuit pop-off valve open, avoid flush if airway obstruction suspected\n\nManagement: If suspected barotrauma, stop flush, check circuit patency, decompress chest if tension pneumothorax\n\n**Logical Learning Aids:**\n\"High Pressure Hurtsâ€”Barotrauma\" â€“ Emergency flush delivers high pressure; overuse = barotrauma, especially in small children. Use briefly (1-2 sec), verify circuit patency."},{"id":17,"question":"What is the typical flow rate of oxygen delivered by the emergency oxygen flush?","options":{"a":"1â€“5 L/min","b":"10â€“20 L/min","c":"35â€“75 L/min","d":"100+ L/min"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nThe **emergency oxygen flush delivers 35-75 L/min** of 100% oxygen (exact flow rate varies by machine design and regulationsâ€”typically 35-60 L/min). This **high flow** is what makes it effective for rapid oxygen delivery in emergencies. The flow rate is **not** manually controlled; it's a fixed, design-determined flow. Understanding this high flow rate is essential for recognizing the potential for **barotrauma** and appropriate duration of use.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (1-5 L/min): This is the range for **standard** flowmeters used for controlled anesthesiaâ€”far too low for emergency.\n\n**Option B** (10-20 L/min): Still too low; used for moderate supplemental oxygen, not emergency bypass.\n\n**Option D** (100+ L/min): Exceeds typical machine capability; usually capped at 75 L/min.\n\n**Exam Essentials:**\n\nFlush flow = 35-75 L/min (most machines: 35-60 L/min)\n\nHigh flow = rapid oxygen delivery in hypoxic emergencies\n\nMechanism: Bypasses low-pressure circuit; regulated by machine design (not flowmeter-controlled)\n\nClinical significance: Can generate airway pressures of 45-55 cm Hâ‚‚O; risk of barotrauma if held too long\n\nPediatric consideration: Dangerous in small children; use sparingly and briefly\n\n**Logical Learning Aids:**\n\"Flush = 35-75 L/min Emergency Oâ‚‚\" â€“ Remember the high flow rate (35-75) to understand barotrauma risk; this is NOT the same as controlled flowmeter rates (1-5 L/min)."},{"id":18,"question":"For controlled mechanical ventilation, which Mapleson circuit is the most efficient, requiring the lowest fresh gas flow (FGF) to prevent rebreathing?","options":{"a":"Mapleson A","b":"Mapleson B","c":"Mapleson C","d":"Mapleson D"},"correctAnswer":"d","explanation":""},{"id":19,"question":"What is a key feature of the Mapleson E circuit?","options":{"a":"APL valve is near the patient","b":"Efficient for controlled ventilation","c":"It lacks a reservoir bag and APL valve","d":"The APL valve is distant from the patient"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nThe **Mapleson E circuit** (Ayre's T-piece) is distinguished by its **simplicity**: it lacks both a reservoir bag AND an APL (pop-off) valve. Instead, it's a simple **T-shaped tube** with the breathing limb and expiratory limb meeting at the patient connection. It's designed for **pediatric spontaneous breathing** (highly compliant system, minimal dead space). Gas exits through the open expiratory end by exhalation pressure. The lack of valve and bag makes it ideal for very light, minimal-resistance systems.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (APL valve near patient): Mapleson E has NO APL valve; this describes Mapleson A.\n\n**Option B** (Efficient for controlled ventilation): Mapleson E is **inefficient** for controlled ventilation; requires very high FGF (~3-4 Ã— MV) and bag modification.\n\n**Option D** (APL valve distant from patient): Mapleson E has no APL valve at all; this describes Mapleson D.\n\n**Exam Essentials:**\n\nMapleson E (Ayre's T-piece): No bag, no APL valve; simplicity = low dead space, low resistance\n\nUse: Pediatric spontaneous breathing (neonates to ~25 kg)\n\nModification: Jackson-Rees adds **reservoir bag to expiratory limb** (Mapleson E + bag), allowing controlled ventilation\n\nFGF: Requires high FGF for spontaneous ventilation (~2-3 Ã— MV); controlled ventilation needs bag modification\n\n**Logical Learning Aids:**\n\"E = Elegant & Empty\" â€“ Mapleson E is simple (no bag, no valve); ideal for pediatric spontaneous breathing. Jackson-Rees modification adds bag for control."},{"id":20,"question":"Which circuit modification is a Mapleson E with a reservoir bag added to the expiratory limb, allowing for controlled ventilation?","options":{"a":"Magill circuit","b":"Lack circuit","c":"Bain circuit","d":"Jackson-Rees modification"},"correctAnswer":"d","explanation":"**High-Yield Topic Explanation:**\nWhen a **reservoir bag is added to the expiratory limb of Mapleson E circuit**, it becomes the **Jackson-Rees modification**. This adaptation allows **controlled mechanical ventilation** by providing a bag to compress for positive pressure, while maintaining the low dead space and resistance of the original E circuit. The modification bridges spontaneous and controlled ventilation, making it suitable for **pediatric anesthesia** where flexibility between breathing modes is essential.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Magill circuit): Mapleson A, not a modification of E.\n\n**Option B** (Lack circuit): Mapleson C variant; not related to E modification.\n\n**Option C** (Bain circuit): Coaxial Mapleson D variant; not a modification of E.\n\n**Exam Essentials:**\n\nJackson-Rees = Mapleson E + reservoir bag on expiratory limb\n\nAdvantage: Allows transition from spontaneous to controlled ventilation\n\nPediatric standard: Widely used in pediatric anesthesia\n\nFGF requirement: Lower than pure E circuit (~1.5-2 Ã— MV for controlled ventilation with bag)\n\nDesign: Bag acts as both visual indicator of ventilation and tool for manual positive pressure\n\n**Logical Learning Aids:**\n\"Jackson-Rees = E + Bag\" â€“ Jackson-Rees modification = Mapleson E circuit with reservoir bag added to expiratory limb; allows both spontaneous and controlled ventilation in pediatric cases."},{"id":21,"question":"To correctly size an oropharyngeal airway in an adult, you should measure from:","options":{"a":"The corner of the mouth to the earlobe","b":"The corner of the mouth to the angle of the jaw","c":"The tip of the nose to the earlobe","d":"The chin to the corner of the mouth"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation:**\nTo **correctly size an oropharyngeal airway (OPA)** in an adult, measure from the **corner of the mouth to the angle of the jaw**. This distance typically corresponds to the proper OPA size (80 mm for adults; \"size 80 = 8 cm\"). Incorrect sizing causes problems: **too small** = ineffective airway obstruction relief; **too large** = gagging, laryngeal obstruction, esophageal intubation risk. Correct sizing ensures the airway tip lies at the pharyngeal inlet, above the epiglottis.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Corner of mouth to earlobe): Too long; would place airway beyond pharynx.\n\n**Option C** (Tip of nose to earlobe): Overly long measurement; not standard sizing method.\n\n**Option D** (Chin to corner of mouth): Doesn't capture pharyngeal length properly; inaccurate.\n\n**Exam Essentials:**\n\nAdult OPA sizing: Corner of mouth to angle of jaw â‰ˆ 80-90 mm (size 80-90 most common)\n\nPediatric OPA: Distance from incisor to angle of mandible; sizes 50-70 mm (age-dependent)\n\nInsertion: Open mouth with cross-finger technique, insert upside-down, then rotate 180Â° as tip advances\n\nComplications: Gagging, laryngospasm, esophageal intubation if too large; airway obstruction if too small\n\n**Logical Learning Aids:**\n\"Mouth to Jaw = Right Way\" â€“ OPA sizing: corner of mouth to angle of jaw; this simple landmark ensures optimal airway placement without obstruction or gagging."},{"id":22,"question":"A nasopharyngeal airway is contraindicated in a patient with a suspected:","options":{"a":"Asthma","b":"Severe hypoxia","c":"Basilar skull fracture","d":"Hypotension"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\n**Basilar skull fracture** is a **critical contraindication** for nasopharyngeal airway (NPA) insertion. With basilar skull fracture, the **cribriform plate (roof of ethmoid) may be disrupted**, allowing the NPA to pass through the fracture site into the **anterior cranial fossa/brain tissue**â€”causing catastrophic intracranial injury, CSF leak, or meningitis. **Clinical signs of basilar skull fracture:** Battle's sign (mastoid ecchymosis), raccoon eyes (periorbital ecchymosis), CSF rhinorrhea/otorrhea, hemotympanum.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Asthma): NPA is safe; may help avoid intubation-induced bronchoconstriction in asthma.\n\n**Option B** (Severe hypoxia): NPA is indicated to restore oxygenation if intubation fails.\n\n**Option D** (Hypotension): NPA is generally safe; avoid aggressive insertion pressure but not contraindicated.\n\n**Exam Essentials:**\n\nBasilar skull fracture = NPA contraindication (risk of intracranial placement)\n\nAlternative: Use oropharyngeal airway or proceed to intubation if secure airway needed\n\nClinical suspicion: Battle's sign, raccoon eyes, clear CSF from nose/ears, hemotympanum\n\nIf suspected, use oral airway or cautiously intubate; assume fracture until proven otherwise\n\nCT confirmation: Best diagnostic tool; radiographs less sensitive\n\n**Logical Learning Aids:**\n\"Basilar Breaks NPA\" â€“ Basilar skull fracture is a contraindication for nasopharyngeal airway; risk of intracranial placement through cribriform plate defect. Use oral airway instead."},{"id":23,"question":"A patient is found unresponsive with snoring respirations. The most appropriate initial action to open their airway, assuming no spinal trauma, is the:","options":{"a":"Jaw-thrust maneuver","b":"Head-tiltâ€“chin-lift maneuver","c":"Suctioning of the oropharynx","d":"Finger sweep"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation:**\nIn an **unresponsive patient with snoring respirations** (indicating **partial airway obstruction from tongue collapse**), the **head-tilt chin-lift maneuver** is the most appropriate **initial airway opening technique** (assuming **no spinal trauma**). This maneuver extends the head at the atlantoaxial joint and lifts the mandible forward, displacing the tongue from the posterior pharynx and opening the airway. Snoring indicates obstructionâ€”this maneuver relieves it.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Jaw-thrust maneuver): Appropriate if **spinal trauma suspected**; indicated for C-spine protection but more difficult, requires two hands; not first-line for simple obstruction.\n\n**Option C** (Suctioning): May worsen obstruction before airway opened; obstructed airway first, then suction if needed.\n\n**Option D** (Finger sweep): Risk of pushing foreign body deeper; outdated; removed from ACLS guidelines except for visible obstructions.\n\n**Exam Essentials:**\n\nHead-tilt chin-lift = first maneuver for simple airway obstruction in non-trauma patient\n\nTechnique: One hand on forehead (extend head), one hand under chin (lift jaw upward)\n\nJaw-thrust = first maneuver if **cervical spine trauma suspected**\n\nSnoring = partial obstruction from tongue; relieves with simple positioning\n\nBLS Sequence: Scene safety â†’ Check responsiveness â†’ Snoring â†’ Head-tilt chin-lift â†’ Continue BLS\n\n**Logical Learning Aids:**\n\"Snore = Simple Solution\" â€“ Snoring (partial obstruction) + no trauma = head-tilt chin-lift opens airway by lifting tongue. If trauma suspected, use jaw-thrust instead."},{"id":24,"question":"Which component of an endotracheal tube creates an airtight seal in the trachea to prevent aspiration?","options":{"a":"The Murphy eye","b":"The pilot balloon","c":"The cuff","d":"The bevel"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nThe **cuff** (inflatable balloon) at the **distal end of the endotracheal tube (ETT)** creates an **airtight seal in the trachea**. When inflated with air, the cuff expands and creates a seal against tracheal walls, **preventing aspiration of gastric contents, saliva, or blood** into the lungs. This **sealing function** distinguishes ETT as a **definitive airway**, making it the gold standard for airway protection in high-risk patients or during mechanical ventilation.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Murphy eye): Small hole near tip of ETT; allows ventilation if cuff occludes one tracheal segment; NOT for sealing.\n\n**Option B** (Pilot balloon): Small external balloon allowing cuff pressure monitoring/adjustment; indicates cuff inflation status but doesn't seal airway.\n\n**Option D** (Bevel): Angled tip of ETT; facilitates insertion; not for sealing.\n\n**Exam Essentials:**\n\nCuff function: Creates seal to prevent aspiration; allows positive pressure ventilation\n\nCuff pressure: Maintain 20-25 cm Hâ‚‚O (or measure in mmHg: ~15-20 mmHg); over-inflation â†’ tracheal stenosis; under-inflation â†’ air leak\n\nPilot balloon: Indicates cuff inflation; connects to cuff via tubing; monitor for pressure changes\n\nMurphy eye: Safety feature; allows gas delivery if main lumen obstructed; minor function\n\n**Logical Learning Aids:**\n\"Cuff = Seal, Murphy = Safety\" â€“ ETT cuff creates airtight seal preventing aspiration; Murphy eye is safety feature. Maintain cuff pressure 20-25 cm Hâ‚‚O to avoid stenosis."},{"id":25,"question":"Which of the following devices is considered a definitive airway because it protects against aspiration?","options":{"a":"Oropharyngeal airway","b":"Laryngeal mask airway (LMA)","c":"Endotracheal tube (ETT)","d":"Nasopharyngeal airway"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nAn **endotracheal tube (ETT)** is a **definitive airway** because it **completely seals the trachea** via the inflatable cuff, providing **complete protection against aspiration** of gastric contents, saliva, or blood. This makes it ideal for patients at high risk of aspiration (full stomach, emergency surgery, depressed consciousness) and for patients requiring **controlled mechanical ventilation**. Other airway devices (oropharyngeal, nasopharyngeal, LMA) do NOT provide definitive protection.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Oropharyngeal airway): Simple adjunct; does NOT seal airway; patient can still aspirate around it.\n\n**Option B** (Laryngeal mask airway): Supraglottic device; provides **partial** airway isolation; NOT definitive (aspiration can occur around the seal, especially with high pressures).\n\n**Option D** (Nasopharyngeal airway): Airway adjunct only; does NOT seal trachea; no aspiration protection.\n\n**Exam Essentials:**\n\nDefinitive airway = complete tracheal seal; only **ETT** qualifies in routine practice\n\nSecond-generation supraglottic airways (LMA ProSeal, i-gel) provide **improved** but NOT complete protection; gastric drain tubes reduce (not eliminate) aspiration risk\n\nIndication for ETT: Full stomach, emergency surgery, unresponsive/depressed level of consciousness, mechanical ventilation needed\n\nAdvantages: Allows controlled ventilation, complete aspiration protection, route for medications (in emergency)\n\n**Logical Learning Aids:**\n\"ETT = Definitive, Complete Seal\" â€“ Only endotracheal tube provides definitive airway with complete aspiration protection via cuff seal. LMA and simple airways do NOT seal trachea."},{"id":26,"question":"What is a key feature of the LMA Pro Seal compared to the Classic LMA?","options":{"a":"A non-inflatable cuff.","b":"A reinforced, flexible airway tube.","c":"A gastric drain tube.","d":"A shorter, more rigid tube"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nThe **LMA ProSeal** is a second-generation LMA with a **gastric drain tube**â€”a key advancement over the classic LMA. This tube allows gastric decompression and venting, reducing aspiration risk by preventing gastric inflation and reflux. The cuff design is also improved (larger, more compliant), providing a better seal for controlled ventilation at higher pressures (up to 30 cm Hâ‚‚O vs. 15-20 for Classic). These modifications make ProSeal suitable for longer procedures and higher-risk patients.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Non-inflatable cuff): ProSeal has an **inflatable** cuff; i-gel (second-generation) has non-inflatable gel cuff.\n\n**Option B** (Reinforced, flexible airway tube): Describes LMA Fastrach (reinforced); ProSeal has standard tube with improved cuff.\n\n**Option D** (Shorter, more rigid tube): Fastrach is more rigid; ProSeal is standard flexibility with reinforced characteristics.\n\n**Exam Essentials:**\n\nLMA ProSeal features: Gastric drain tube, improved cuff, perilaryngeal seal for better control\n\nPressure tolerance: Up to 30 cm Hâ‚‚O (vs. 15-20 for Classic); allows controlled ventilation in intermediate procedures\n\nIndication: Longer procedures, moderate aspiration risk, controlled ventilation needed\n\nComparison Classic vs. ProSeal: Classic = simple, quick placement; ProSeal = better seal, gastric drain, controlled ventilation option\n\nLimitation: Still not definitive airway; gastric drain does NOT guarantee aspiration prevention\n\n**Logical Learning Aids:**\n\"ProSeal = Seal + Suction\" â€“ LMA ProSeal adds gastric drainage tube and improved cuff seal compared to Classic LMA; better for controlled ventilation and longer cases."},{"id":27,"question":"What is a primary advantage of using an LMA compared to an endotracheal tube (ETT) for airway management?","options":{"a":"It provides a definitive, aspiration-proof airway.","b":"It is easier to insert and requires less technical skill.","c":"It allows for higher inflation pressures in the airway.","d":"It is suitable for long-term mechanical ventilation"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation:**\nA **primary advantage of LMA vs. endotracheal tube** is that it is **easier to insert and requires less technical skill**. LMA insertion does NOT require direct visualization (blind insertion), no laryngoscopy needed, faster learning curve for placement, and lower failure rate even with anatomically difficult airways. This makes LMA ideal for **emergency situations, untrained personnel, and difficult airways** where ETT placement might fail. However, LMA does NOT provide definitive airway or equivalent aspiration protection as ETT.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Provides definitive, aspiration-proof airway): FALSE; LMA is supraglottic, not definitive; aspiration can occur especially with high pressures or gastric distension.\n\n**Option C** (Allows higher inflation pressures): Opposite true; LMA has pressure limits (typically 15-25 cm Hâ‚‚O); ETT tolerates higher pressures.\n\n**Option D** (Suitable for long-term mechanical ventilation): FALSE; LMA not designed for long-term ventilation; risk of migration, aspiration, airway obstruction.\n\n**Exam Essentials:**\n\nLMA advantages: Faster insertion, minimal training needed, blind technique possible, avoids laryngoscopy (useful in difficult airway)\n\nLMA limitations: Not definitive, not suitable for long-term ventilation, cannot perform suctioning of trachea easily, risk of gastric distension\n\nETT advantages: Definitive airway, complete aspiration protection, allows long-term ventilation, permits tracheal suctioning\n\nClinical decision: LMA for routine elective cases; ETT for aspiration risk, emergency, long procedures, mechanical ventilation\n\n**Logical Learning Aids:**\n\"LMA = Lazy (Easy), ETT = Secure (Safe)\" â€“ LMA easier to insert (no laryngoscopy); ETT provides definitive protection. Choose based on procedure and risk."},{"id":28,"question":"Which of the following is a second-generation LMA that has a pre-shaped, non-inflatable cuff made from a gel-like substance?","options":{"a":"LMA Classicâ„¢","b":"LMA ProSealâ„¢","c":"i-gelâ„¢","d":"LMA Fastrachâ„¢"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nThe **i-gelâ„¢ is a second-generation LMA** characterized by a **non-inflatable, pre-shaped gel-like cuff** made from thermoplastic elastomer. Unlike inflatable-cuff LMAs, the i-gel cuff does NOT require inflationâ€”it maintains its shape through material properties. The gel provides a conformable seal against pharyngeal structures at body temperature, reducing insertion-related trauma and improving hemodynamic stability. The non-inflatable design simplifies insertion (no need to verify cuff inflation) and reduces cuff-related complications (over-inflation injury, cuff malfunction).\n\n**Rationale for Incorrect Options:**\n\n**Option A** (LMA Classicâ„¢): Has inflatable cuff; first-generation design.\n\n**Option B** (LMA ProSealâ„¢): Has inflatable cuff; second-generation, not non-inflatable.\n\n**Option D** (LMA Fastrachâ„¢): Has inflatable cuff; specialized for intubation over the device; not primarily known for gel cuff.\n\n**Exam Essentials:**\n\ni-gel features: Non-inflatable gel cuff, pre-shaped, thermoplastic elastomer material, single-use (disposable)\n\nAdvantages: No cuff pressure monitoring needed, faster insertion, reduced trauma, stable positioning, simplified troubleshooting\n\nLimitations: Cannot adjust seal (size mismatch means reinsertion); expensive (single-use); pressure limits similar to other LMAs\n\nIndications: When quick insertion prioritized, when cuff-related complications concern, when simplicity preferred\n\nComplications: Still risks of gastric insufflation, aspiration, laryngeal obstruction despite gel design\n\n**Logical Learning Aids:**\n\"i-gel = No Inflation\" â€“ i-gel is second-generation LMA with non-inflatable gel cuff; thermoplastic shape maintains seal without inflation. Fast insertion, no pressure monitoring."},{"id":29,"question":"What is a key defining feature that distinguishes a second-generation LMA from a firstgeneration LMA?","options":{"a":"It is always reusable.","b":"It lacks an inflatable cuff.","c":"It incorporates a channel for gastric drainage.","d":"It has a rigid wire-reinforced tube"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nThe **key defining feature** that distinguishes second-generation LMAs from first-generation is the **incorporation of a gastric drainage channel**. This feature allows venting of gastric gas and liquid, reducing gastric insufflation risks and decreasing aspiration potential. First-generation LMAs (Classic) lack this channel. This advancement improved safety profile for longer procedures and higher-pressure ventilation. Some second-generation LMAs (i-gel) also feature improved cuff designs (non-inflatable) or reinforced tubes, but the gastric channel is the primary universal distinguishing feature.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Always reusable): FALSE; some second-generation are single-use (i-gel); reusability varies by model.\n\n**Option B** (Lacks inflatable cuff): FALSE; most second-generation (ProSeal, Fastrach) have inflatable cuffs; only i-gel lacks inflation.\n\n**Exam Essentials:**\n\nFirst-generation LMAs: Classicâ„¢, Uniqueâ„¢ (disposable Classic)â€”simple design, inflatable cuff, no gastric drain\n\nSecond-generation LMAs: ProSealâ„¢ (gastric drain + improved seal), i-gelâ„¢ (gastric drain + non-inflatable cuff), Fastrachâ„¢ (gastric drain + wire-reinforced for intubation), LMA Supremeâ„¢\n\nCommon feature: All second-generation incorporate **gastric drain channel**\n\nFGF requirement: All (first and second-gen) require similar FGF (~3 Ã— MV) for spontaneous ventilation\n\nClinical significance: Second-generation allows safer controlled ventilation and longer procedure duration\n\n**Logical Learning Aids:**\n\"2nd Gen = Gastric Drain Channel\" â€“ Second-generation LMAs distinguish from first-generation by gastric drainage capability; reduces gastric insufflation and aspiration risk."},{"id":30,"question":"To confirm correct placement of the endotracheal tube after a cricothyroidotomy, which monitoring tool is most reliable?","options":{"a":"Listening for bilateral breath sounds","b":"Observing chest rise","c":"Monitoring oxygen saturation with a pulse oximeter","d":"End-tidal capnography"},"correctAnswer":"d","explanation":"**High-Yield Topic Explanation:**\n**End-tidal capnography (ETCOâ‚‚) is the most reliable method** to confirm correct endotracheal tube placement after cricothyroidotomy. A **waveform indicating 30-40 mmHg ETCOâ‚‚** confirms intra-tracheal placement. Capnography is superior to other methods (breath sounds are difficult to assess acutely in emergency; chest rise may be absent initially; pulse oximetry is slow to reflect oxygenation changes). In **emergency airway management**, capnography provides immediate, objective confirmation.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Bilateral breath sounds): Can be misleading; esophageal intubation may produce transmitted breath sounds; difficult to assess in noisy emergency environment.\n\n**Option B** (Chest rise): May be absent with small tidal volumes; relies on visual assessment during emergency chaos.\n\n**Option C** (SpOâ‚‚ monitoring): Slow to change (5-15 minutes); does NOT confirm placement immediately.\n\n**Exam Essentials:**\n\nCapnography = gold standard for tube confirmation (sensitivity >99%; specificity >99% after 6 breaths)\n\nIndications: After any intubation attempt (routine intubation, surgical airway, emergency)\n\nPositive finding: ETCOâ‚‚ 30-40 mmHg waveform = tracheal placement confirmed\n\nFalse negatives: Low cardiac output, cardiac arrest (no perfusion â†’ no COâ‚‚ production); verify with clinical exam + repeat capnography\n\nAlternative confirmation: Direct visualization of tube passing through vocal cords (gold standard if possible); ultrasound (tracheal ring visualization)\n\n**Logical Learning Aids:**\n\"Capnography Confirms Cricothyrotomy\" â€“ ETCOâ‚‚ waveform is most reliable confirmation of cricothyroidotomy tube placement; immediately confirms tracheal position."},{"id":31,"question":"In which of the following situations is a cricothyroidotomy most appropriately indicated?","options":{"a":"Routine airway management","b":"Elective tracheostomy","c":"Failed intubation and inability to ventilate","d":"Non-emergent airway management"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nCricothyroidotomy is indicated in emergency situations of \"Failed Intubation + Unable to Ventilate\" (FIUV)â€”the \"Can't intubate, Can't oxygenate\" emergency. This surgical airway allows **emergency oxygenation and ventilation** when laryngoscopy fails and bag-mask ventilation is inadequate. It is NOT used for routine airway management (elective tracheostomy is preferred for planned cases). Cricothyroidotomy is a **bridge** to get oxygen/ventilation while arranging definitive airway (re-intubation attempts, fiberoptic intubation, or formal tracheostomy).\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Routine airway management): ETT or LMA used routinely; cricothyroidotomy reserved for emergencies.\n\n**Option B** (Elective tracheostomy): Formal tracheostomy (not cricothyroidotomy) used for planned long-term airway; cricothyroidotomy is emergency temporizing procedure.\n\n**Option D** (Non-emergent airway management): Cricothyroidotomy is strictly emergency procedure; risks (tracheal stenosis, subglottic narrowing) limit non-emergent use.\n\n**Exam Essentials:**\n\nCricothyroidotomy indications: \"Can't intubate, Can't oxygenate\" after failed intubation and failed bag-mask ventilation\n\nAnatomy: Access between cricoid cartilage and thyroid cartilage; lies below the vocal cords (subglottic)\n\nAdvantages: Rapid placement (30-120 seconds), high success rate, minimal equipment needed\n\nComplications: Tracheal stenosis (long-term), subglottic narrowing, vocal cord injury, hemorrhage\n\nTimeline: Emergent procedure; must be performed within 3-5 minutes if hypoxemic arrest impending\n\n**Logical Learning Aids:**\n\"Can't Breathe? Cut the Neck\" â€“ Cricothyroidotomy is emergency surgical airway for failed intubation + failed ventilation; classic \"Can't intubate, Can't oxygenate\" scenario. Bridge to oxygenation."},{"id":32,"question":"The potency of an inhalational anesthetic is best measured by its:","options":{"a":"Blood-gas partition coefficient","b":"Minimum alveolar concentration","c":"Oil-gas partition coefficient","d":"Vapor pressure"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation:**\nThe **potency of an inhalational anesthetic is measured by its Minimum Alveolar Concentration (MAC)**. MAC is the **alveolar concentration of anesthetic gas at 1 atmosphere that prevents movement in response to surgical stimulation in 50% of patients**. Lower MAC = **higher potency** (less gas needed); higher MAC = lower potency (more gas needed). For example: **Halothane MAC = 0.75% (potent)**, Nitrous oxide MAC = 104% (low potency). MAC is inversely related to blood-gas partition coefficient.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Blood-gas partition coefficient): Related to **speed** of induction/recovery (solubility), not potency; high blood-gas = slow induction/recovery.\n\n**Option C** (Oil-gas partition coefficient): Correlates with potency but MAC is the **standard measure** of potency; oil-gas is historical.\n\n**Option D** (Vapor pressure): Determines how much gas can be vaporized at given temperature; not a potency measure.\n\n**Exam Essentials:**\n\nMAC values (need to memorize for exam):\n\nHalothane: 0.75% (highest potency among volatile agents used today)\n\nSevoflurane: 2.0%\n\nDesflurane: 6.0%\n\nNitrous oxide: 104% (lowest potency; cannot achieve MAC in 100% Nâ‚‚O at 1 atm)\n\nIsoflurane: 1.15% (historical agent; rarely used now)\n\nMAC Awareness: MAC-Awake = concentration for consciousness (typically 0.3-0.5 Ã— MAC)\n\nClinical significance: MAC guides dosing; depth of anesthesia related to multiple of MAC (1 MAC = adequate anesthesia for most surgeries)\n\n**Logical Learning Aids:**\n\"MAC = Minimal Anesthetic Concentration = Potency\" â€“ Lower MAC = higher potency (less gas needed). Memorize: Halothane 0.75%, Sevoflurane 2.0%, Desflurane 6.0%, Nâ‚‚O 104%."},{"id":33,"question":"Which of the following inhalational anesthetics has the highest blood-gas partition coefficient, leading to the slowest induction and recovery?","options":{"a":"Desflurane","b":"Sevoflurane","c":"Nitrous Oxide","d":"Halothane"},"correctAnswer":"c","explanation":""},{"id":34,"question":"Malignant hyperthermia can be triggered by all of the following except:","options":{"a":"Sevoflurane","b":"Desflurane","c":"Halothane","d":"Nitrous Oxide"},"correctAnswer":"d","explanation":"**High-Yield Topic Explanation:**\nNitrous oxide (Nâ‚‚O) is NOT a trigger for malignant hyperthermia (MH)â€”it is **safe in MH-susceptible patients**. The only triggers for MH are **depolarizing neuromuscular blockers** (succinylcholine) and **volatile anesthetics** (halothane, isoflurane, desflurane, sevoflurane, enflurane). Nitrous oxide, as an inert gas, does not trigger MH. Non-depolarizing neuromuscular blockers, propofol, opioids, and local anesthetics are also safe in MH-susceptible patients.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Sevoflurane): TRIGGERS MH; modern volatile agents are all MH triggers.\n\n**Option B** (Desflurane): TRIGGERS MH; modern volatile agent.\n\n**Option C** (Halothane): TRIGGERS MH; classic volatile agent; one of the most potent MH triggers.\n\n**Exam Essentials:**\n\nMH triggers: **Depolarizing blockers** (succinylcholine) + **Volatile anesthetics** (all modern volatile agents)\n\nSafe agents in MH-susceptible:\n\nNâ‚‚O (inert)\n\nPropofol (IV agent)\n\nOpioids (fentanyl, morphine, remifentanil)\n\nNon-depolarizing blockers (rocuronium, vecuronium, etc.)\n\nLocal anesthetics (lidocaine, bupivacaine)\n\nMH management: Stop triggering agents immediately, hyperventilate with 100% Oâ‚‚, administer dantrolene sodium (2.5 mg/kg IV repeated every 5 min up to 10 mg/kg)\n\nPrevention: Maintain \"MH-safe\" anesthesia: TIVA (propofol) + opioids + Nâ‚‚O + non-depolarizing blockers\n\n**Logical Learning Aids:**\n\"Nâ‚‚O = Nitrous = Safe; Succinyl + Sevoflurane = Scary\" â€“ Nâ‚‚O is NOT MH trigger. Only depolarizing blockers + volatile agents trigger MH. Safe agents: propofol, opioids, Nâ‚‚O, local anesthetics."},{"id":35,"question":"Which inhalational anesthetic is known for causing airway irritation and coughing, making it a poor choice for inhalational induction?","options":{"a":"Sevoflurane","b":"Desflurane","c":"Nitrous oxide","d":"Halothane"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation:**\nDesflurane is known for causing airway irritation, coughing, laryngospasm, and apnea during inhalational induction, making it a **poor choice for inhalational induction** (especially in pediatric patients). Desflurane's pungent airway irritation results from its chemical properties. In contrast, **sevoflurane is the preferred agent for inhalational induction** due to its minimal airway irritation despite slightly slower induction. Desflurane is suitable for **IV induction followed by maintenance** but NOT for inhalational induction.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Sevoflurane): Smooth induction, minimal airway irritation; **preferred** agent for inhalational induction in pediatrics.\n\n**Option C** (Nitrous oxide): Used as adjunct; minimal airway irritation; too low potency for sole induction agent.\n\n**Option D** (Halothane): Smooth induction; minimal airway irritation; historically preferred for inhalational induction (now less used due to hepatotoxicity risk, slow recovery).\n\n**Exam Essentials:**\n\nDesflurane: Rapid induction/recovery (fast emergence); but **airway irritation** limits use for inhalational induction\n\nInduction method for desflurane: IV induction (propofol/thiopental) followed by maintenance with desflurane inhalation\n\nPediatric inhalational induction: Sevoflurane preferred (smooth, fast)\n\nAirway complications with desflurane: Coughing, laryngospasm, increased secretions, apnea during induction\n\nClinical use: Desflurane excellent for maintenance (fast recovery); poor choice for inhalational induction\n\n**Logical Learning Aids:**\n\"Desflurane = Difficult Induction (pungent)\" â€“ Desflurane causes airway irritation; avoid for inhalational induction. Use sevoflurane or halothane for inhalational induction; use desflurane IV induction + maintenance."},{"id":36,"question":"The intravenous anesthetic agent known for producing a \"dissociative anesthesia\" state, characterized by a cataleptic state where the patient appears to be awake but is unresponsive to pain, is:","options":{"a":"Propofol","b":"Ketamine","c":"Midazolam","d":"Thiopental"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation:**\nKetamine is the classic **dissociative anesthetic** producing a unique state called **dissociative anesthesia** or **catalepsy**. Patients appear awake (eyes open, preserved reflexes) but are profoundly **unresponsive to pain** and **amnestic**. This state results from **selective CNS depression with preserved airway reflexes and ventilation**â€”the patient maintains spontaneous breathing and airway protection. Dissociation = **disconnection between cortical and limbic systems**. Ketamine is excellent for **emergency airway management, rapid sequence induction, and analgesia**.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Propofol): Produces unconsciousness (not dissociation); no preserved reflexes; slower recovery.\n\n**Option C** (Midazolam): Produces sedation/hypnosis; not dissociative.\n\n**Option D** (Thiopental): Produces hypnosis; not dissociative; depresses airway reflexes and ventilation.\n\n**Exam Essentials:**\n\nKetamine characteristics: Dissociation, analgesia, preserved airway reflexes, minimal respiratory depression, sympathomimetic (â†‘HR, â†‘BP)\n\nDissociative state: Catalepsy, analgesia, amnesia, nystagmus; patient appears awake but unresponsive to pain\n\nAirway safety: Preserved cough reflex, swallowing reflex; spontaneous ventilation maintained (FDA approved for emergency anesthesia)\n\nSide effects: Emergence reactions (dysphoria, hallucinations), nystagmus, increased secretions, hypertension, tachycardia\n\nClinical use: Emergency intubation, rapid sequence induction, analgesia in trauma, pediatric anesthesia, analgesia in conscious sedation\n\n**Logical Learning Aids:**\n\"Ketamine = Cataleptic (awake but unaware), Conscious but Completely out of touch\" â€“ Dissociative anesthesia; preserved reflexes, analgesia, and breathing. Ideal for emergency airway."},{"id":37,"question":"Which of the following is a potential side effect of etomidate that limits its use in prolonged infusions?","options":{"a":"Increased intracranial pressure","b":"Adrenocortical suppression","c":"Significant muscle rigidity","d":"Hypertension and tachycardia"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation:**\nEtomidate causes adrenocortical (adrenal) suppressionâ€”a significant side effect limiting its use in **prolonged infusions**. Even a single IV dose of etomidate **temporarily inhibits 11Î²-hydroxylase**, a crucial enzyme for cortisol synthesis. With single-dose use, this effect is transient and clinically insignificant. However, **prolonged etomidate infusion causes sustained adrenal suppression**, leading to **relative adrenal insufficiency with hypotension, hyponatremia, and poor outcome**â€”especially dangerous in critically ill patients. Modern practice limits etomidate to **single bolus in emergency intubation**, avoiding infusions.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Increased intracranial pressure): Etomidate **reduces** ICP; neurosurgical agent of choice; low ICP is advantage.\n\n**Option C** (Significant muscle rigidity): Etomidate causes minimal muscle rigidity (unlike opioids); smooth induction without rigidity.\n\n**Option D** (Hypertension and tachycardia): Etomidate maintains hemodynamic stability (minimal BP/HR changes); advantage in unstable patients.\n\n**Exam Essentials:**\n\nEtomidate advantages: Hemodynamic stability, reduced ICP, rapid onset, suitable for emergency intubation, minimal respiratory depression\n\nEtomidate disadvantages: **Adrenocortical suppression** (even single dose; prolonged infusion dangerous), pain on injection, no analgesia\n\nAdrenal suppression mechanism: Inhibits 11Î²-hydroxylase â†’ â†“ cortisol synthesis; recovers within 24-48 hours (single dose)\n\nProlonged infusion risk: Sustained adrenal suppression â†’ hypotension, hyponatremia, mortality increase in critical illness\n\nModern practice: Single bolus only in emergency; avoid infusions; alternative agents preferred for sedation (propofol, dexmedetomidine)\n\n**Logical Learning Aids:**\n\"Etomidate = Excellent but Adrenals Suppressed\" â€“ Etomidate great for emergency (hemodynamic stability, low ICP); but adrenocortical suppression limits prolonged infusions. Use single dose only."},{"id":38,"question":"Propofol, a widely used intravenous anesthetic, has which of the following additional properties?","options":{"a":"Good analgesic effects","b":"Good muscle relaxation","c":"Cardiovascular stability","d":"Antiemetic properties"},"correctAnswer":"d","explanation":"**High-Yield Topic Explanation:**\nPropofol has antiemetic propertiesâ€”it reduces post-operative nausea and vomiting (PONV) and is sometimes used for prophylaxis against PONV, especially in high-risk patients. Additionally, propofol has **mild analgesic properties** and produces **smooth induction** with minimal airway irritation. However, propofol does **NOT provide good muscle relaxation** (no neuromuscular blocking effectâ€”separate blockers still needed), causes **cardiovascular depression** (hypotension, bradycardia) more than etomidate, and lacks **analgesic potency** compared to opioids.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Good analgesic effects): Propofol has minimal analgesic properties; opioids required for analgesia in surgery.\n\n**Option B** (Good muscle relaxation): Propofol has no neuromuscular blocking effect; separate NMBs required.\n\n**Option C** (Cardiovascular stability): Propofol **reduces** CVS stability (causes hypotension, bradycardia); etomidate is more stable.\n\n**Exam Essentials:**\n\nPropofol properties: IV induction, smooth induction, PONV prophylaxis, â†“ ICP, mild muscle relaxation, dose-dependent respiratory depression\n\nAntiemetic mechanism: Likely involves 5-HTâ‚ƒ antagonism and/or limbic system effects\n\nAdvantages: Smooth induction, reduced PONV, reduced ICP, amnesia, rapid recovery\n\nDisadvantages: Hypotension, bradycardia, no analgesia, pain on injection (reduced with lidocaine), propofol infusion syndrome (prolonged infusion)\n\nClinical use: Induction agent, sedation in ICU (infusions), maintenance agent, PONV prophylaxis\n\n**Logical Learning Aids:**\n\"Propofol = Smooth + Sedates PONV\" â€“ Propofol antiemetic (reduces PONV); smooth induction; but hypotensive (needs caution in unstable patients). No muscle relaxation or analgesia."},{"id":39,"question":"Unlike other intravenous agents, ketamine anesthesia is associated with:","options":{"a":"Significant hypotension","b":"Decreased cerebral blood flow","c":"Cardiovascular stimulation","d":"Reduced intracranial pressure"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nKetamine anesthesia is associated with cardiovascular stimulationâ€”ketamine is **sympathomimetic** (increases norepinephrine release, inhibits reuptake), causing **â†‘ heart rate, â†‘ blood pressure, â†‘ cardiac output**. This is distinct from propofol/etomidate which are **cardiovascular depressants**. Ketamine's sympathomimetic effects make it **ideal for emergency intubation in hypotensive/shocked patients**â€”maintains or improves hemodynamics while providing anesthesia/analgesia. However, in **catecholamine-depleted patients** (prolonged critical illness), ketamine may cause paradoxical hypotension.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Significant hypotension): FALSE; ketamine **increases** BP; sympathomimetic.\n\n**Option B** (Decreased cerebral blood flow): Ketamine **preserves/increases** cerebral blood flow; neuroprotective.\n\n**Option D** (Reduced intracranial pressure): Ketamine **increases** ICP (â†‘ cerebral blood flow + â†‘ metabolism); not ideal for head trauma.\n\n**Exam Essentials:**\n\nKetamine sympathomimetic effects: â†‘ HR (10-25%), â†‘ SBP (10-30%), â†‘ CO, â†‘ cerebral blood flow\n\nMechanism: â†“ norepinephrine reuptake, â†‘ sympathetic outflow, mild direct myocardial stimulation\n\nException: Catecholamine-depleted patients (prolonged shock, critical illness) may have paradoxical hypotension\n\nClinical advantage: Excellent for **emergency intubation in hypotensive patients** (unlike propofol/etomidate which depress CVS)\n\nSide effects: Hypertension/tachycardia may be excessive in hypertensive patients; can worsen coronary ischemia in CAD patients\n\n**Logical Learning Aids:**\n\"Ketamine = Kicks up Heart & BP (Sympathomimetic)\" â€“ Ketamine increases heart rate, blood pressure, cerebral blood flow. Ideal for emergency intubation in hypotensive patients. Exception: catecholamine-depleted (paradoxical drop)."},{"id":40,"question":"Which neuromuscular blocker is eliminated primarily by organ-independent Hofmann elimination?","options":{"a":"Pancuronium","b":"Rocuronium","c":"Vecuronium","d":"Cisatracurium"},"correctAnswer":"d","explanation":"**High-Yield Topic Explanation:**\nCisatracurium is eliminated primarily by Hofmann eliminationâ€”a unique **organ-independent mechanism** (does NOT depend on liver or kidney function). Hofmann elimination is **spontaneous degradation at physiologic pH and temperature**, independent of organ function. This makes cisatracurium ideal in **hepatic/renal failure patients** where drug accumulation is a concern. In contrast, rocuronium, vecuronium, and pancuronium depend on organ clearance and accumulate with organ dysfunction.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Pancuronium): Renally eliminated; accumulates in renal failure.\n\n**Option B** (Rocuronium): Hepatically eliminated; accumulates in liver failure.\n\n**Option C** (Vecuronium): Hepatically eliminated (also ester hydrolysis); accumulates with liver dysfunction.\n\n**Exam Essentials:**\n\nCisatracurium characteristics: Hofmann elimination (organ-independent), ester hydrolysis (organ-independent), intermediate duration (40-60 min), no active metabolites, histamine release (minor, rarely clinically significant)\n\nHofmann elimination advantage: Safe in hepatic and renal failure; duration unchanged regardless of organ function\n\nOther organ-independent agents: Atracurium (similar to cisatracurium; also Hofmann + ester hydrolysis), mivacurium (pseudocholinesterase-dependent; organ-independent but abnormal enzyme carriers affected)\n\nClinical comparison:\n\nCisatracurium/Atracurium: Organ-independent, safe in failure\n\nRocuronium/Vecuronium/Pancuronium: Organ-dependent; avoid or use reduced doses in failure\n\nDuration: Not affected by organ dysfunction in cisatracurium (advantage) vs. prolonged duration in rocuronium in renal failure (disadvantage)\n\n**Logical Learning Aids:**\n\"Cisatracurium = Chemistry (Hofmann), not Organs\" â€“ Cisatracurium undergoes Hofmann elimination (organ-independent); safe in hepatic/renal failure. Rocuronium/Vecuronium organ-dependent; accumulate in failure."},{"id":41,"question":"In a patient with reduced plasma cholinesterase activity, which drug is most likely to have a prolonged effect?","options":{"a":"Rocuronium","b":"Atracurium","c":"Succinylcholine","d":"Pancuronium"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nSuccinylcholine (depolarizing NMB) is metabolized by plasma cholinesterase (pseudocholinesterase). In patients with **reduced plasma cholinesterase activity** (genetic variants, hepatic disease, pregnancy, certain medications), succinylcholine is metabolized very slowly, causing **prolonged neuromuscular blockade and apnea** (inability to breathe spontaneously after drug wears off, requiring mechanical ventilation until drug is metabolized). Other NMBs (rocuronium, atracurium, cisatracurium) are NOT dependent on plasma cholinesterase; their duration is unaffected by reduced enzyme activity.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Rocuronium): Hepatic elimination; NOT affected by plasma cholinesterase.\n\n**Option B** (Atracurium): Hofmann elimination + ester hydrolysis; NOT affected by plasma cholinesterase.\n\n**Option D** (Pancuronium): Renal elimination; NOT affected by plasma cholinesterase.\n\n**Exam Essentials:**\n\nSuccinylcholine metabolism: Plasma cholinesterase (pseudocholinesterase); normal duration 5-10 minutes\n\nReduced cholinesterase causes: Prolonged succinylcholine duration (up to hours); prolonged apnea; need for mechanical ventilation\n\nRisk factors for reduced cholinesterase:\n\nGenetic variants (homozygous atypical: 2-4 hours vs. normal; heterozygous: prolonged 20-30 min vs. 5-10)\n\nHepatic cirrhosis, hepatitis\n\nPregnancy, post-partum\n\nMedications: Anticholinesterases, certain antibiotics\n\nPseudocholinesterase test: Dibucaine number (normal >70; heterozygous 20-70; homozygous \u003c20); reveals genetic variants\n\nManagement: Continue mechanical ventilation, supportive care until drug metabolized; no reversal agents available\n\n**Logical Learning Aids:**\n\"Low Cholinesterase = Long Succinylcholine (apnea)\" â€“ Succinylcholine depends on plasma cholinesterase for metabolism; reduced enzyme (genetic, liver disease, pregnancy) prolongs duration â†’ prolonged apnea. Other NMBs unaffected."},{"id":42,"question":"What is the mechanism of action of sugammadex, a reversal agent for neuromuscular blockers?","options":{"a":"Inhibits acetylcholinesterase.","b":"Competes with the neuromuscular blocker for nicotinic receptors.","c":"Encapsulates and inactivates aminosteroid neuromuscular blockers.","d":"Promotes the release of acetylcholine"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nSugammadex is a selective relaxant binding agent that **encapsulates and inactivates aminosteroid neuromuscular blockers** (rocuronium, vecuronium). Sugammadex is a **modified gamma-cyclodextrin** that forms a 1:1 complex with aminosteroid NMBs in the plasma, physically removing them from the neuromuscular junction and preventing neuromuscular blockade. This is **NOT an acetylcholinesterase inhibitor** (like neostigmine/edrophonium); instead, it physically sequesters the NMB. Rapid onset allows **prompt reversal** of even deep neuromuscular blockade within 3-5 minutes.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Inhibits acetylcholinesterase): Neostigmine/edrophonium work this way; sugammadex does NOT inhibit enzyme.\n\n**Option B** (Competes with NMB for receptors): Describes competitive antagonism (not true reversal); sugammadex does not compete at receptor.\n\n**Option D** (Promotes acetylcholine release): Describes physostigmine mechanism; not how sugammadex works.\n\n**Exam Essentials:**\n\nSugammadex characteristics: Encapsulation mechanism, rapid onset (3-5 min), suitable for rocuronium/vecuronium (aminosteroids only), deep reversal possible, short duration after clearance\n\nDosing: 2 mg/kg for routine reversal; 4 mg/kg for deep blockade reversal\n\nAdvantages: Deep reversal possible, no contraindications (unlike neostigmine), suitable for rapid recovery anesthesia\n\nDisadvantages: Expensive, NOT effective for non-aminosteroid blockers (pancuronium, cisatracurium), risk of recurarization if eliminated faster than some NMBs\n\nNeostigmine (comparator): Acetylcholinesterase inhibitor; slower onset (10-15 min); limited to shallow-moderate blockade reversal; requires antimuscarinic\n\n**Logical Learning Aids:**\n\"Sugammadex = Sequester (encapsulate)\" â€“ Sugammadex encapsulates aminosteroid blockers, removing them from circulation. Rapid, deep reversal. For rocuronium/vecuronium only. NOT an enzyme inhibitor."},{"id":43,"question":"Which statement is TRUE regarding the difference between depolarizing and non-depolarizing neuromuscular blockers?","options":{"a":"Acetylcholinesterase inhibitors reverse the effect of depolarizing blockers.","b":"Only non-depolarizing blockers cause initial muscle fasciculations.","c":"Non-depolarizing blockers are safe in malignant hyperthermia","d":"Depolarizing blockers are primarily used for long surgical procedures"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nNon-depolarizing blockers are safe in malignant hyperthermia (correct statement). Non-depolarizing agents (rocuronium, vecuronium, atracurium, cisatracurium, pancuronium) do NOT trigger MH. Only **depolarizing blockers (succinylcholine)** and **volatile anesthetics** trigger MH. In MH-susceptible patients, non-depolarizing NMBs can be safely used; volatile agents and succinylcholine must be avoided.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Acetylcholinesterase inhibitors reverse depolarizing blockers): FALSE; depolarizing blockers (succinylcholine) produce prolonged paralysis after depolarization; reversal agents do NOT work because mechanism is persistent depolarization, not competitive blockade.\n\n**Option B** (Only non-depolarizing cause fasciculations): FALSE; depolarizing blockers (succinylcholine) cause visible muscle fasciculations (uncoordinated contractions); non-depolarizing do NOT fasciculate.\n\n**Option D** (Depolarizing blockers used for long procedures): FALSE; depolarizing blockers have very short duration (5-10 min); used only for intubation/short procedures. Long procedures use non-depolarizing.\n\n**Exam Essentials:**\n\nDepolarizing blockers: Succinylcholine; fasciculations, hyperkalemia risk, prolonged pseudocholinesterase-dependent duration, triggers MH, short duration (5-10 min)\n\nNon-depolarizing blockers: Rocuronium, vecuronium, pancuronium, cisatracurium, atracurium; no fasciculations, no hyperkalemia, longer duration, do NOT trigger MH\n\nReversal mechanisms:\n\nDepolarizing: NO reversal (only time); maintain ventilation until metabolized\n\nNon-depolarizing: Acetylcholinesterase inhibitors (neostigmine) OR encapsulation (sugammadex)\n\nMH safety: Non-depolarizing safe; depolarizing and volatiles trigger MH\n\n**Logical Learning Aids:**\n\"Non-depolarizing = Neostigmine reversal = NOT MH trigger\" â€“ Non-depolarizing blockers are safe in MH (can use rocuronium in MH-susceptible). Depolarizing (succinylcholine) TRIGGERS MH."},{"id":44,"question":"Which of the following is an acetylcholinesterase inhibitor used to reverse non-depolarizing muscle relaxants?","options":{"a":"Sugammadex","b":"Atropine","c":"Neostigmine","d":"N-acetylcysteine"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nNeostigmine is an acetylcholinesterase inhibitor used to reverse non-depolarizing neuromuscular blockers. Neostigmine inhibits plasma cholinesterase, causing **accumulation of acetylcholine at the neuromuscular junction**, which **competitively displaces the non-depolarizing blocker** from the receptor, restoring neuromuscular transmission. Neostigmine is effective only for **non-depolarizing blockers** (competitive mechanism); it does NOT work for depolarizing blockers. Neostigmine is typically given with an **antimuscarinic** (glycopyrrolate or atropine) to prevent cholinergic side effects (bradycardia, bronchospasm, salivation).\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Sugammadex): Encapsulation agent; reverses only aminosteroids (rocuronium, vecuronium); NOT an acetylcholinesterase inhibitor.\n\n**Option B** (Atropine): Antimuscarinic; used with neostigmine to block muscarinic side effects; not a reversal agent itself.\n\n**Option D** (N-acetylcysteine): Mucolytic agent; unrelated to NMB reversal.\n\n**Exam Essentials:**\n\nNeostigmine: Acetylcholinesterase inhibitor, reversible antagonist\n\nMechanism: â†‘ ACh â†’ competitively displaces non-depolarizing blocker at receptor\n\nDosing: 0.05-0.07 mg/kg IV (max 5 mg)\n\nOnset: 10-15 minutes (slower than sugammadex 3-5 min)\n\nLimitations: Only reverses shallow-moderate blockade; ineffective for deep blockade; limit to \u003c20 mg total neostigmine to avoid cholinergic crisis\n\nAntimuscarinic co-administration: Glycopyrrolate (0.01 mg/kg) or atropine (0.01-0.02 mg/kg) to prevent bradycardia, bronchospasm, salivation\n\nModern trend: Sugammadex preferred (faster, deeper reversal possible)\n\n**Logical Learning Aids:**\n\"Neostigmine = Neuro-muscle reversal (acetylcholinesterase inhibitor)\" â€“ Neostigmine reverses non-depolarizing blockers by increasing ACh; requires antimuscarinic co-administration. Give with glycopyrrolate."},{"id":45,"question":"The local anesthetic of choice for this procedure : {image 3}","options":{"a":"Bupivacaine","b":"Lidocaine without epinephrine","c":"Ropivacaine","d":"Procaine with epinephrine"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation:**\nWithout seeing the specific image, the question likely depicts a **regional anesthesia procedure requiring a quick-onset, potent local anesthetic without epinephrine**â€”classic scenario is **spinal anesthesia, epidural, or peripheral nerve block**. **Lidocaine without epinephrine** is often chosen for rapid-onset blocks where vasoconstriction is NOT desired (or contraindicated due to anatomical blood supply concerns). Bupivacaine causes slower onset but longer duration. Ropivacaine is intermediate. Procaine is rarely used (fast metabolism, short duration). The answer is likely **lidocaine without epinephrine** for quick onset without epinephrine-related complications.\n\n**Rationale for Incorrect Options (general guidance):**\n\nBupivacaine: Longer duration but slower onset; suitable for long procedures needing sustained block.\n\nRopivacaine: Intermediate onset/duration; lower cardiotoxicity than bupivacaine; suitable for long procedures with reduced toxicity risk.\n\nProcaine with epinephrine: Fast metabolism, very short duration (15-20 min); rarely used; epinephrine adds complexity.\n\n**Exam Essentials (without image):**\n\nLidocaine: Onset 10-20 min; duration 30-60 min (infiltration), 90-120 min (blocks); intermediate potency\n\nBupivacaine: Onset 10-30 min; duration 4-8 hours; high potency; cardiotoxic\n\nRopivacaine: Onset 10-20 min; duration 4-8 hours; intermediate potency; less cardiotoxic than bupivacaine\n\nProcaine: Onset rapid (5-10 min); duration 15-20 min; low potency; ester (fast metabolism)\n\nEpinephrine addition: Prolongs duration, increases vasoconstriction; avoid in end-organ areas (fingers, toes, ears, nose, penis)\n\n**Logical Learning Aids:**\n\"Lidocaine = Likable (fast, intermediate)\" â€“ Lidocaine often chosen for moderate-duration blocks with quick onset. Bupivacaine for long duration. Procaine/ropivacaine for specific scenarios."},{"id":46,"question":"Systemic toxicity from local anesthetics most commonly affects which two body systems?","options":{"a":"Renal and hepatic systems","b":"Central nervous system (CNS) and cardiovascular system (CVS).","c":"Respiratory and endocrine systems.","d":"Gastrointestinal and musculoskeletal systems."},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation:**\nSystemic local anesthetic toxicity primarily affects the Central Nervous System (CNS) and Cardiovascular System (CVS)â€”the two most sensitive organs. **CNS toxicity** manifests as **restlessness, tremors, confusion, seizures, loss of consciousness, apnea** (excitatory phase followed by depression). **CVS toxicity** manifests as **hypertension/tachycardia initially, then hypotension, bradycardia, arrhythmias, cardiac arrest**. Bupivacaine is particularly cardiotoxic (can cause \"local anesthetic-induced cardiac arrest\" refractory to standard ACLS medications; requires **lipid emulsion therapy**).\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Renal and hepatic): Not primary sites of toxicity; metabolism occurs hepatically, but toxicity symptoms are not renal/hepatic.\n\n**Option C** (Respiratory and endocrine): Secondary effects; respiratory depression is result of CNS toxicity; no primary endocrine toxicity.\n\n**Option D** (Gastrointestinal and musculoskeletal): Not typical sites of toxicity.\n\n**Exam Essentials:**\n\nCNS toxicity symptoms (in order of severity): Perioral numbness, tinnitus, metallic taste, visual disturbances â†’ agitation, tremors â†’ slurred speech, muscle twitching â†’ generalized seizures â†’ loss of consciousness, apnea\n\nCVS toxicity symptoms: â†‘ HR/BP â†’ arrhythmias (PVCs, VT, VF) â†’ bradycardia, hypotension â†’ cardiac arrest\n\nRisk factors: Rapid injection, inadvertent IV injection, overdose, lipophilic agents (bupivacaine > lidocaine), patient factors (age extremes, hepatic disease, cardiac disease)\n\nManagement: Stop injection, treat seizures (benzodiazepines, propofol), give lipid emulsion for bupivacaine toxicity (20% lipid emulsion 1.5 mL/kg bolus, then infusion), ACLS medications (may be less effective with lipophilic agents)\n\nLipid emulsion therapy: Specifically indicated for severe CVS toxicity from lipophilic agents (bupivacaine); mechanism unclear (possibly lipid sequestration or metabolic effects)\n\n**Logical Learning Aids:**\n\"Local Anesthetic = Brain & Heart Affected\" â€“ Toxicity hits CNS (seizures, apnea) and CVS (arrhythmias, arrest) first. Bupivacaine particularly cardiac-toxic; needs lipid emulsion."},{"id":47,"question":"What is a common sign of early central nervous system (CNS) toxicity from bupivacaine?","options":{"a":"Sudden severe hypertension.","b":"Profound sedation and coma.","c":"Perioral numbness and tinnitus.","d":"Generalized muscle paralysis."},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nEarly central nervous system toxicity from local anesthetics (especially bupivacaine) classically presents with **perioral numbness and tinnitus** (ringing in ears). These are early **warning signs** indicating rising blood levels of local anesthetic approaching toxic levels. Other early signs include metallic taste, visual disturbances, and tremors. **Recognizing these early symptoms allows intervention before seizures/cardiovascular collapse occurs**â€”the practitioner should immediately stop injection, treat patient, and prepare for possible seizure management or ACLS.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Sudden severe hypertension): Late CVS toxicity sign; not early CNS sign.\n\n**Option B** (Profound sedation and coma): Advanced CNS depression; occurs after seizure phase typically.\n\n**Option D** (Generalized muscle paralysis): Not typical of local anesthetic toxicity; suggests neuromuscular blocker toxicity instead.\n\n**Exam Essentials:**\n\nProgression of CNS toxicity:\n\nEarly (Warning signs): Perioral numbness, tinnitus, metallic taste, restlessness, visual disturbances\n\nMid (Excitatory): Muscle tremors, shivering, agitation, slurred speech\n\nLate (Depressant): Seizures, loss of consciousness, apnea, coma\n\nFactors accelerating toxicity: Acidosis, hypoxia, hypercarbia (all worsen CNS symptoms)\n\nClinical action: At early sign appearance, STOP injection, reassure patient, place IV line, prepare benzodiazepines, observe for seizure; avoid further injection\n\nSeizure management: Benzodiazepines (midazolam, lorazepam), propofol, or even succinylcholine if intubation needed\n\n**Logical Learning Aids:**\n\"Perioral Numbness & Tinnitus = Time to Stop!\" â€“ Early CNS toxicity signs: perioral numbness, tinnitus, metallic taste. STOP injection, reassure, observe. Late signs: seizures, apnea."},{"id":48,"question":"Which of the following describes the correct order of structures a needle passes through during a midline approach for a lumbar spinal anesthetic?","options":{"a":"Skin, supraspinous ligament, interspinous ligament, ligamentum flavum, dura mater, arachnoid mater","b":"Skin, interspinous ligament, supraspinous ligament, ligamentum flavum, dura mater, arachnoid mater","c":"Skin, ligamentum flavum, interspinous ligament, dura mater, arachnoid mater, pia mater","d":"Skin, supraspinous ligament, ligamentum flavum, interspinous ligament, dura mater, arachnoid mater"},"correctAnswer":"a","explanation":"**High-Yield Topic Explanation:**\nThe **correct order of structures** a needle passes through during **midline approach spinal anesthesia** (from superficial to deep) is: **Skin â†’ Supraspinous ligament â†’ Interspinous ligament â†’ Ligamentum flavum â†’ Dura mater â†’ Arachnoid mater**. The supraspinous ligament is encountered FIRST (connects spinous processes), followed by the interspinous ligament (connects adjacent spinous processes), then the ligamentum flavum (dense yellow elastic ligament; provides resistance), then membrane dura and arachnoid before reaching CSF.\n\n**Rationale for Incorrect Options:**\n\n**Option B**: Reverses supraspinous and interspinous order; supraspinous is most superficial.\n\n**Option C**: Skips supraspinous ligament; out of sequence.\n\n**Option D**: Reverses ligamentum flavum and interspinous order; incorrect sequence.\n\n**Exam Essentials:**\n\nSpinal needle anatomy:\n\nSkin: Initial penetration; superficial\n\nSupraspinous ligament: Most superficial ligament; connects tips of spinous processes\n\nInterspinous ligament: Deep to supraspinous; connects adjacent spinous processes\n\nLigamentum flavum: Dense elastic ligament; \"giving way\" sensation when pierced = classic midline identification\n\nDura-arachnoid complex: Two-layer membrane; dura outer (tough), arachnoid inner\n\nCSF: Once arachnoid penetrated, CSF appearance = correct placement\n\nAnatomical landmarks: L3-L4 or L4-L5 intervertebral space; locate by palpating iliac crests (at L4 level)\n\nLoss of resistance: Felt as needle passes ligamentum flavum (most distinct landmark)\n\n**Logical Learning Aids:**\n\"Skin, Supra-Inter-Flava, Dura-Arachnoid\" â€“ Midline spinal path: **Skin**, **S**upraspinous, **I**nterspinous, (**F**lava/Flavum), **D**ura, **A**rachnoid = \"S-S-I-F-D-A\" mnemonic. CSF = correct placement."},{"id":49,"question":"A post-dural puncture headache (PDPH) is caused by:","options":{"a":"A localized inflammatory reaction at the injection site","b":"The leakage of cerebrospinal fluid (CSF), causing traction on pain-sensitive meningeal structures","c":"A direct toxic effect of the local anesthetic on the central nervous system","d":"Increased intracranial pressure following the procedure"},"correctAnswer":"b","explanation":"**High-Yield Topic Explanation:**\nPost-dural puncture headache (PDPH) is caused by **leakage of cerebrospinal fluid (CSF)** through the dural puncture site, causing **intracranial hypotension and traction on pain-sensitive meningeal structures** (cranial nerves, venous sinuses). As CSF leaks, intracranial pressure drops, causing the brain to sag downward â†’ traction on meninges â†’ headache. The headache is typically **positional** (worse upright, better recumbent) due to gravity effects on CSF dynamics and brain position.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Localized inflammatory reaction): Minimal inflammation from spinal needle; not primary cause.\n\n**Option C** (Direct toxic effect on CNS): Local anesthetic toxicity causes other effects; not primary PDPH mechanism.\n\n**Option D** (Increased intracranial pressure): OPPOSITE true; PDPH results from **decreased** ICP due to CSF leak.\n\n**Exam Essentials:**\n\nPDPH characteristics: Positional headache (frontal/occipital), worse standing/sitting, better lying down, onset 12-48 hours post-procedure\n\nIncidence: ~5-30% after spinal puncture (varies by needle size, needle type, technique, patient factors)\n\nRisk factors: Large needle gauge, cutting-bevel needles (vs. pencil-point), young age, female, pregnancy, low BMI, multiple attempts\n\nAssociated symptoms: Neck stiffness, tinnitus, hearing changes, photophobia (from meningeal traction)\n\nPrevention: Small needles (25G or smaller), pencil-point bevel, minimize punctures, adequate hydration, bedrest, caffeine, prone positioning\n\nTreatment: Conservative (hydration, analgesics, caffeine, bedrest); epidural blood patch (EBP) if severe or persistent\n\n**Logical Learning Aids:**\n\"PDPH = Poor Dural Patch (CSF Leak)\" â€“ PDPH = CSF leaks from dural puncture â†’ intracranial hypotension â†’ meningeal traction = headache. Positional: upright=worse, recumbent=better."},{"id":50,"question":"The most common cause of death in pregnant women undergoing emergency Cesarean section under general anesthesia is gastric acid aspiration. How does central neuraxial blockade, like spinal anesthesia, help prevent this?","options":{"a":"It induces more profound muscle relaxation than general anesthesia.","b":"It provides more stable vital signs.","c":"It allows the patient to remain conscious, thus maintaining airway reflexes.","d":"It reduces surgical blood loss."},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nCentral neuraxial blockade (spinal/epidural anesthesia) allows the patient to remain conscious, thus **maintaining airway reflexes** (cough, gag, swallowing reflex). In contrast, **general anesthesia causes loss of consciousness and airway reflexes**, requiring intubation for airway protection. By avoiding general anesthesia and using neuraxial blockade, the patient maintains protective airway reflexes, **reducing the risk of gastric acid aspiration** into the lungs during emergency Cesarean sectionâ€”a catastrophic complication in obstetric emergencies. This is why neuraxial anesthesia is strongly preferred for obstetric cases when feasible.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Muscle relaxation): Neuraxial provides muscle relaxation via sympathetic blockade, but this doesn't prevent aspiration; muscle relaxation is related to surgical access, not airway protection.\n\n**Option B** (Stable vital signs): While neuraxial may provide stable hemodynamics vs. general anesthesia, this is indirect benefit; vital sign stability doesn't directly prevent aspiration.\n\n**Option D** (Reduced surgical blood loss): Neuraxial may reduce blood loss via sympathetic blockade, but irrelevant to aspiration prevention.\n\n**Exam Essentials:**\n\nAspiration risk in pregnancy: â†‘ intra-abdominal pressure (gravid uterus), delayed gastric emptying, increased gastric acid production\n\nGeneral anesthesia risk: Apnea during induction, emergency intubation delay, failed intubation â†’ aspiration of gastric contents = aspiration pneumonitis (Mendelson syndrome)\n\nNeuraxial anesthesia advantage: Patient conscious, airway reflexes intact â†’ gag reflex prevents aspiration despite gastric distension\n\nRapid sequence intubation (RSI): For emergent general anesthesia in obstetrics if neuraxial unavailable; cricoid pressure, pre-oxygenation, succinylcholine for rapid intubation\n\nFailed intubation in obstetrics: Increased airway edema, larger breasts, increased weight â†’ cricothyroidotomy may be needed\n\n**Logical Learning Aids:**\n\"Conscious Neuraxial = Protective Airway Reflexes\" â€“ Neuraxial anesthesia prevents aspiration by keeping patient conscious with intact cough/gag reflexes. General anesthesia risks aspiration during induction â†’ prefer neuraxial in obstetrics."},{"id":51,"question":"When performing a midline approach for spinal anesthesia, which ligament is the spinal needle passed through just before entering the epidural space?","options":{"a":"Supraspinous ligament","b":"Interspinous ligament","c":"Ligamentum flavum","d":"Posterior longitudinal ligament"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nWhen performing **midline spinal anesthesia, the **ligamentum flavum** is the **final ligament pierced before entering the epidural space**. Just before the needle enters the subarachnoid space to reach CSF, it passes through the ligamentum flavumâ€”the practitioner feels a \"giving way\" or \"loss of resistance\" sensation as the dense elastic ligament is penetrated, indicating correct midline location. The epidural space lies outside (superficial to) the dura; after ligamentum flavum, the next layers are dura and arachnoid before reaching CSF.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (Supraspinous ligament): Most superficial; encountered first, not before epidural space.\n\n**Option B** (Interspinous ligament): Encountered between supraspinous and ligamentum flavum; not directly before epidural space.\n\n**Option D** (Posterior longitudinal ligament): Lies deep to dura; not encountered in midline approach.\n\n**Exam Essentials:**\n\nEpidural space: Potential space between ligamentum flavum and dura mater; contains fat, blood vessels, nerves\n\nMidline spinal vs. epidural: Both pass through same ligaments (skin, supraspinous, interspinous, ligamentum flavum); epidural catheter stops in epidural space (doesn't penetrate dura); spinal needle penetrates dura-arachnoid to reach CSF\n\nTuohy needle (epidural): Blunt bevel; loss of resistance technique used; needle stops in epidural space after passing ligamentum flavum\n\nSpinal needle: Sharp bevel or pencil-point; passes through all layers including dura-arachnoid to reach CSF\n\nLandmark anatomy: Loss of resistance at ligamentum flavum is same for both epidural and spinal; difference is needle depth/insertion\n\n**Logical Learning Aids:**\n\"Ligamentum Flavum = Final barrier Before Epidural\" â€“ In spinal anesthesia midline approach, ligamentum flavum is the final ligament before entering epidural space. \"Loss of resistance\" = penetration of ligamentum flavum."},{"id":52,"question":"The most common side effect of an epidural block is:","options":{"a":"Postdural puncture headache (PDPH)","b":"Nausea and vomiting","c":"Hypotension","d":"Shivering"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nThe **most common side effect of epidural block is hypotension**â€”due to **sympathetic nervous system blockade** (vasodilation, â†“ SVR, â†“ venous return). Epidural anesthesia blocks sympathetic fibers at the level of anesthesia, causing **vasodilation and decreased peripheral vascular resistance**. If the blockade is high (thoracic/upper lumbar), sympathetic output is significantly reduced â†’ hypotension. This is managed by **IV fluid preloading, vasopressors (phenylephrine, ephedrine), and careful block level monitoring**.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (PDPH): Specific to dural puncture (spinal, inadvertent dural tap); NOT an expected side effect of epidural (as long as dura not punctured).\n\n**Option B** (Nausea and vomiting): Not a primary side effect of epidural block; more related to other factors.\n\n**Option D** (Shivering): Uncommon side effect; not characteristic of epidural.\n\n**Exam Essentials:**\n\nEpidural side effects:\n\nHypotension: Most common; sympathetic blockade (vasodilation, â†“ SVR)\n\nInadvertent dural puncture: Risk of PDPH, total spinal (high level) if anesthetic injected into subarachnoid space\n\nSubdural/epidural hematoma: Risk if anticoagulated or coagulopathic\n\nEpidural abscess: Rare infection complication\n\nUrinary retention: Opioid added to epidural anesthetic; can prolong retention\n\nPrevention of hypotension: Preload 500-1000 mL crystalloid, position changes, vasopressors ready\n\nComparison: Spinal anesthesia hypotension incidence higher (~20-30%) than epidural (~5-15%) due to more rapid sympathetic blockade\n\n**Logical Learning Aids:**\n\"Epidural = Blood pressure drop (Sympathetic blockade)\" â€“ Most common epidural side effect = hypotension from sympathetic blockade. Prevent with preloading, positioning, vasopressors."},{"id":53,"question":"The proper compression-to-ventilation ratio for a single rescuer performing CPR on an adult is:","options":{"a":"15 compressions to 2 breaths","b":"20 compressions to 2 breaths","c":"30 compressions to 2 breaths","d":"10 compressions to 1 breath"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nThe **recommended compression-to-ventilation ratio for adult CPR by a single rescuer is 30 compressions to 2 breaths** (30:2). This ratio maximizes **chest compression time** (most crucial component for perfusion) while still providing minimal ventilation. Recent guidelines emphasize **continuous chest compressions** as superior to interrupted compressions for ventilationâ€”hence the 30:2 ratio balances both. Single rescuer must switch between compressions and ventilation; in two-rescuer CPR, compressions are typically continuous with one rescuer providing ventilation.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (15 compressions to 2 breaths): Older guideline; now 30:2 preferred to maximize compressions.\n\n**Option B** (20 compressions to 2 breaths): Non-standard ratio.\n\n**Option D** (10 compressions to 1 breath): Too low compression-to-ventilation ratio; insufficient perfusion time.\n\n**Exam Essentials:**\n\nAdult CPR ratio: 30:2 (single rescuer) or 30:2 (two rescuers with one rescuer compressing)\n\nCompression rate: 100-120 compressions per minute (not \u003c100, not >120)\n\nCompression depth: At least 2 inches (5 cm) for adults; allow complete recoil\n\nModern emphasis: Compression-only CPR acceptable if untrained/unwilling to do rescue breathing; compressions most critical for perfusion\n\nPediatric CPR: 30:2 (same as adults); 100-120 compressions/min; compression depth 2 inches or 1/3 chest depth\n\nInfant CPR: 30:2 OR 15:2 (if trained); 100-120 compressions/min; compression depth ~1.5 inches or 1/3 chest depth (2 fingers or thumbs)\n\n**Logical Learning Aids:**\n\"30-2 = Adult CPR Gold\" â€“ Adult single-rescuer CPR = 30 compressions to 2 breaths. Compress hard and fast at 100-120/min; allow recoil. Compressions > ventilation in importance."},{"id":54,"question":"The recommended compression rate for 2 day old child is:","options":{"a":"60-80 compressions per minute","b":"80-100 compressions per minute","c":"100-120 compressions per minute","d":"120-140 compressions per minute"},"correctAnswer":"c","explanation":"**High-Yield Topic Explanation:**\nFor a **2-day-old neonate**, the **recommended compression rate is 100-120 compressions per minute**â€”same as adults. While compression **depth** varies with age (neonates ~1.5 inches or 1/3 chest depth vs. adults ~2 inches), the compression **rate** of 100-120/min applies across all ages (adults, children, infants, neonates). This high rate ensures adequate perfusion and oxygen delivery during cardiac arrest.\n\n**Rationale for Incorrect Options:**\n\n**Option A** (60-80 compressions/min): Too slow; inadequate perfusion, especially in arrested patient.\n\n**Option B** (80-100 compressions/min): Lower end; modern guidelines recommend 100-120 minimum.\n\n**Option D** (120-140 compressions/min): Exceeds recommended maximum; risks inadequate compression quality/recoil.\n\n**Exam Essentials:**\n\nCPR compression rate: **100-120 compressions/min** for all ages (neonates, infants, children, adults)\n\nAge-specific depth:\n\nInfants (0-1 yr): ~1.5 inches (approximately 1/3 chest depth) using 2 fingers or thumb technique\n\nChildren (1-8 yr): ~2 inches (approximately 1/3 chest depth) using 1-2 hands\n\nAdults: At least 2 inches (5 cm); approximately 1/3 chest depth\n\nNeonates (\u003c28 days): Similar depth as infants (~1.5 inches)\n\nCompression quality: Hard and fast; maintain rate 100-120, depth adequate, complete recoil, minimize interruptions\n\nVentilation: 30:2 (single rescuer) or continuous compressions with simultaneous ventilation (if trained/available)\n\n**Logical Learning Aids:**\n\"100-120 = All Ages (Compression rate)\" â€“ CPR rate is SAME for all ages: 100-120 compressions/minute (infants to adults). Depth varies by age; rate does NOT."},{"id":55,"question":"After confirming the scene is safe and finding an unresponsive adult with no normal breathing and no pulse, what is the immediate next step?","options":{"a":"Begin chest compression","b":"Give two rescue breaths","c":"Call emergency services","d":"Wait for first responders"},"correctAnswer":"a","explanation":""}];
        const images = ["data:image/jpeg;base64,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","data:image/jpeg;base64,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bbouuvyQ+ajSjJ0m3J6apK19+r6afNns1FeT/wDDTXhP/oB/EL/w3PiD/wCQaP8Ahprwn/0A/iF/4bnxB/8AINd5wnrFFeT/APDTXhP/AKAfxC/8Nz4g/wDkGj/hprwn/wBAP4hf+G58Qf8AyDQB6xRXk/8Aw014T/6AfxC/8Nz4g/8AkGj/AIaa8J/9AP4hf+G58Qf/ACDQB6xRXk//AA014T/6AfxC/wDDc+IP/kGj/hprwn/0A/iF/wCG58Qf/INAHrFFeT/8NNeE/wDoB/EL/wANz4g/+QaP+GmvCf8A0A/iF/4bnxB/8g0Adh8TNNutU8FagLCFrnULUx31rCn3pJoJFmRB7lowPxrQ8OeMNG8W2xm0nUILzbxJErYlhbusiH5kYd1YAivP/wDhprwn/wBAP4hf+G58Qf8AyDWHr3xh+GPiiZJtW8EeMtRuI/uT3Hww155E/wB1zY5H4GuOdOpGo6tKzukmn5Xtrrbd9H8jrp1Kcqfsqt1Ztprzt00vt3XzPdKK+ef+FjfDFV2xeH/ilar2W18H+K4QPoEtgBTf+Fj/AA67WPxjA9B4b8YY/wDRFDniukI/+BP/AORK5ML/ADy/8BX/AMkfRFFfPC/Eb4bKcnSfi43s3hfxeR+XkV0ml/tDeDNHsYrO20P4j+RFkL53w/8AEcr8knl3syx5Pc1pTlWb/exS9G3/AO2oyqRopfu5NvzSX/tzPY6KyfCvia08Y6Da6xYwahbWtxu2Rarptxp9yNrlTvguESVOVONyjIwRkEE61dBzhXl2s/H7TvD/AI21nw3f+HdZt30s6V5uoySWK2si6hdta27ITchz88crFSgbbGdqszIreo1wvif4M+GfF2talquoQ3BvdQ/srz3juGUH+zrqS6tcDoMSTPu/vAgHpQBRsf2jfhpqemzX9r4y0ya0hVXeRXPCld2QMZOEIkOOiEOcKQ1RfFj9obwb8ItJlvdT1rTJ5rZY7i502LUrdb1bRjl544GcNKFXL7Ey7qpCB22q2Pffsm/D/UtOt7K5tLyWK3QJAzXOWixFFFlePveXCq56jJIw2GHoHjT4faT498Jt4Z1QXA0Kby0ubO2naJbqFSCbeQr8xicAK6ZAdco2VZlIBraDr2neKNFsNY0i+g1LSr+BLm1vLWQSRTxOoZHRhwQQQQR61fqO3t4rO3iggiSCCJQkcUahVRQMBQBwAB2qSgAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/Z","data:image/jpeg;base64,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"];
        const initialMcqsState = JSON.parse(JSON.stringify(mcqs)); // For exam reset
        let currentMcqs = []; // Can be a subset for practice mode
        let sections = [];
        let answerStates = [];
        let practiceStates = [];
        let currentSectionIndex = 0;
        let currentQuestionIndexInSection = 0;
        let currentPracticeIndex = 0;
        let timerInterval;
        let practiceTimerInterval;
        let perQuestionTimerInterval;
        let timePerMcq = 0;
        let timeOverall = 0;
        let questionStartTime = 0;
        let subjectName, candidateName, shortNote;
        let onConfirmCallback = null;
        let reviewReturnScreen = 'results'; // 'results' or 'practiceResults'
        let isShuffled = false;
        let isReviewingSaved = false;
        // FIX: Changed to string concatenation to avoid nested template literal parsing issues.
        const EXAM_DRAFT_KEY = 'examDraft_' + examId;
        const PRACTICE_DRAFT_KEY = 'practiceDraft_' + examId;
        const SAVED_MCQS_KEY = 'savedMcqs_' + examId;
        const EXAM_RESULTS_HISTORY_KEY = 'examResultsHistory_' + examId;
        const PRACTICE_RESULTS_HISTORY_KEY = 'practiceResultsHistory_' + examId;
        const THEME_KEY = 'examTheme_' + examId;
        let savedMcqIds = [];
        let isSmoothSwipe = true;
        let isSparklesEnabled = true;
        
        // --- GAMIFICATION STATE ---
        let currentStreak = 0;

        const QuestionStatus = {
            NotVisited: 'NOT_VISITED',
            NotAnswered: 'NOT_ANSWERED',
            Answered: 'ANSWERED',
            MarkedForReview: 'MARKED_FOR_REVIEW',
        };
        
        const statusColors = {
            [QuestionStatus.Answered]: 'bg-green-600 hover:bg-green-500',
            [QuestionStatus.NotAnswered]: 'bg-red-600 hover:bg-red-500',
            [QuestionStatus.NotVisited]: 'bg-gray-500 hover:bg-gray-600',
            [QuestionStatus.MarkedForReview]: 'bg-purple-600 hover:bg-purple-500',
        };

        const svgBookmarkOutline = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" style="color: var(--text-secondary);" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>';
        const svgBookmarkSolid = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" style="color: var(--text-accent);" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path></svg>';

        // --- DOM ELEMENTS ---
        const screens = {
            setup: document.getElementById('setup-screen'),
            exam: document.getElementById('exam-screen'),
            results: document.getElementById('results-screen'),
            review: document.getElementById('review-screen'),
            practice: document.getElementById('practice-screen'),
            practiceResults: document.getElementById('practice-results-screen'),
            pastResults: document.getElementById('past-results-screen'),
            progress: document.getElementById('progress-screen'),
        };
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessageEl = document.getElementById('confirmation-message');
        const confirmActionBtn = document.getElementById('confirm-action-btn');
        const cancelConfirmationBtn = document.getElementById('cancel-confirmation-btn');
        const reportOptionsModal = document.getElementById('report-options-modal');
        const calculatorModal = document.getElementById('calculator-modal');
        const questionPalette = document.getElementById('question-palette');
        const paletteContentWrapper = document.getElementById('palette-content-wrapper');
        const hidePaletteBtn = document.getElementById('hide-palette-btn');
        const showPaletteBtn = document.getElementById('show-palette-btn');
        const practiceResumeModal = document.getElementById('practice-resume-modal');
        const savedQuestionsContainer = document.getElementById('saved-questions-container');
        const viewSavedBtn = document.getElementById('view-saved-btn');
        const savedQuestionsCountEl = document.getElementById('saved-questions-count');
        const saveMcqBtn = document.getElementById('save-mcq-btn');
        const saveMcqPracticeBtn = document.getElementById('save-mcq-practice-btn');
        const toggleSparklesBtn = document.getElementById('toggle-sparkles-btn');
        const reviewTitleEl = document.getElementById('review-title');
        const toastEl = document.getElementById('toast-notification');
        
        // --- CONFETTI LOGIC (Gravity Burst) ---
        function triggerConfetti(rect) {
            if (!isSparklesEnabled) return;
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const colors = ['#EF476F', '#FFD166', '#06D6A0', '#118AB2', '#073B4C', '#9D4EDD'];
            
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.style.position = 'fixed';
                particle.style.left = centerX + 'px';
                particle.style.top = centerY + 'px';
                particle.style.width = (Math.random() * 10 + 5) + 'px';
                particle.style.height = particle.style.width;
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                particle.style.zIndex = '9999';
                particle.style.pointerEvents = 'none';
                
                // Random Shapes: Square, Circle, Triangle, Star
                const shapeType = Math.floor(Math.random() * 4);
                if (shapeType === 1) { // Circle
                    particle.style.borderRadius = '50%';
                } else if (shapeType === 2) { // Triangle
                     particle.style.width = '0'; 
                     particle.style.height = '0'; 
                     particle.style.backgroundColor = 'transparent';
                     particle.style.borderLeft = '6px solid transparent';
                     particle.style.borderRight = '6px solid transparent';
                     particle.style.borderBottom = '12px solid ' + colors[Math.floor(Math.random() * colors.length)];
                } else if (shapeType === 3) { // Star (using clip-path)
                     particle.style.clipPath = 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)';
                }
                // shapeType 0 is Square (default)

                document.body.appendChild(particle);

                // Physics variables
                // Burst effect: high velocity, random angle
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 15 + 5; 
                let vx = Math.cos(angle) * velocity;
                let vy = Math.sin(angle) * velocity;
                const gravity = 0.8;
                const drag = 0.96;
                let posX = centerX;
                let posY = centerY;
                let rotation = Math.random() * 360;
                let rotationSpeed = (Math.random() - 0.5) * 20;
                let opacity = 1;

                function animate() {
                    posX += vx;
                    posY += vy;
                    vy += gravity; // Apply gravity
                    vx *= drag;    // Air resistance
                    vy *= drag;
                    rotation += rotationSpeed;
                    opacity -= 0.01;

                    particle.style.left = posX + 'px';
                    particle.style.top = posY + 'px';
                    if (shapeType !== 2) { 
                        particle.style.transform = 'rotate(' + rotation + 'deg)';
                    } else {
                        particle.style.transform = 'rotate(' + rotation + 'deg)';
                    }
                    particle.style.opacity = opacity;

                    if (opacity > 0 && posY < window.innerHeight) {
                        requestAnimationFrame(animate);
                    } else {
                        particle.remove();
                    }
                }
                
                requestAnimationFrame(animate);
            }
        }

        // --- DYNAMIC ISLAND LOGIC ---
        const island = document.getElementById('dynamic-island');
        const islandMinimizeBtn = document.getElementById('island-minimize-btn');
        const islandThemeBtn = document.getElementById('island-theme-btn');
        const islandSettingsBtn = document.getElementById('island-settings-btn');
        const islandProgressBtn = document.getElementById('island-progress-btn');
        const islandHomeBtn = document.getElementById('island-home-btn');
        const swipeIconSmooth = document.getElementById('swipe-icon-smooth');
        const swipeIconHard = document.getElementById('swipe-icon-hard');
        
        let islandIdleTimeout;
        let isMinimized = false;
        
        function resetIslandIdle() {
            if (isMinimized) return; // Don't fade out if minimized (handled by style)
            island.classList.remove('idle');
            if (islandIdleTimeout) clearTimeout(islandIdleTimeout);
            islandIdleTimeout = setTimeout(() => {
                island.classList.add('idle');
            }, 3000);
        }

        // Initialize drag for Dynamic Island
        function initDynamicIsland() {
            // Trigger startup vibration
            island.classList.add('hint-anim');
            setTimeout(() => { island.classList.remove('hint-anim'); }, 1000);

            let isDragging = false;
            let dragOffsetX, dragOffsetY;
            const threshold = 5; // Movement threshold

            const onStart = (clientX, clientY) => {
                if (isMinimized) return;
                
                // Calculate offset from the top-left of the island to the cursor
                const rect = island.getBoundingClientRect();
                dragOffsetX = clientX - rect.left;
                dragOffsetY = clientY - rect.top;
                
                isDragging = false;
                resetIslandIdle();
                
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchmove', onTouchMove, { passive: false });
                document.addEventListener('touchend', onEnd);
            };
            
            const onMove = (e) => handleMove(e.clientX, e.clientY);
            const onTouchMove = (e) => {
                if (isMinimized) return;
                e.preventDefault();
                handleMove(e.touches[0].clientX, e.touches[0].clientY);
            };

            const handleMove = (clientX, clientY) => {
                if (!isDragging) {
                    // Check if moved enough to count as drag
                    isDragging = true;
                    island.classList.add('dragging'); // Disables transition for 1:1 tracking
                    
                    // Clear transform logic used for centering, switch to absolute pos
                    island.style.transform = 'none';
                    island.style.right = 'auto'; 
                    island.style.bottom = 'auto';
                }

                // Move exactly with cursor
                island.style.left = (clientX - dragOffsetX) + 'px';
                island.style.top = (clientY - dragOffsetY) + 'px';
                resetIslandIdle();
            };

            const onEnd = () => {
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchmove', onTouchMove);
                document.removeEventListener('touchend', onEnd);
                
                if (isDragging) {
                    island.classList.remove('dragging'); // Re-enable transition for snap
                    snapIsland();
                }
            };
            
            island.addEventListener('mousedown', (e) => {
                if (isMinimized) return;
                if (e.target.closest('button')) return;
                onStart(e.clientX, e.clientY);
            });
            
            island.addEventListener('touchstart', (e) => {
                if (isMinimized) return;
                if (e.target.closest('button')) return;
                onStart(e.touches[0].clientX, e.touches[0].clientY);
            }, { passive: false });
            
            island.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', resetIslandIdle);
            });
            
            island.addEventListener('click', (e) => {
                if (isMinimized && !e.target.closest('button')) {
                    toggleMinimize();
                }
            });
            
            resetIslandIdle();
        }
        
        function snapIsland() {
            const rect = island.getBoundingClientRect();
            const winW = window.innerWidth;
            const winH = window.innerHeight;
            
            const distTop = rect.top;
            const distBottom = winH - rect.bottom;
            const distLeft = rect.left;
            const distRight = winW - rect.right;
            
            const minDist = Math.min(distTop, distBottom, distLeft, distRight);
            const padding = 20;

            island.classList.remove('horizontal', 'vertical');

            // Snap logic
            if (minDist === distTop) {
                island.style.top = padding + 'px';
                island.style.bottom = 'auto';
                island.classList.add('horizontal');
            } else if (minDist === distBottom) {
                island.style.top = 'auto';
                island.style.bottom = padding + 'px';
                island.classList.add('horizontal');
            } else if (minDist === distLeft) {
                island.style.left = padding + 'px';
                island.style.right = 'auto';
                island.classList.add('vertical');
            } else { // Right
                island.style.left = 'auto';
                island.style.right = padding + 'px';
                island.classList.add('vertical');
            }
            
            // Constrain within window
            const newRect = island.getBoundingClientRect();
            if (island.classList.contains('horizontal')) {
               if(newRect.left < 0) island.style.left = padding + 'px';
               if(newRect.right > winW) island.style.left = (winW - newRect.width - padding) + 'px';
            } else {
               if(newRect.top < 0) island.style.top = padding + 'px';
               if(newRect.bottom > winH) island.style.top = (winH - newRect.height - padding) + 'px';
            }
        }
        
        function toggleMinimize() {
            isMinimized = !isMinimized;
            
            if (isMinimized) {
                island.classList.add('minimized');
                // Force snap to closest wall with 0 padding for the "dash" look
                const rect = island.getBoundingClientRect();
                const winW = window.innerWidth;
                const winH = window.innerHeight;
                
                // Determine orientation based on current class
                if (island.classList.contains('horizontal')) {
                    if (rect.top < winH / 2) { // Top wall
                        island.style.top = '0px';
                        island.style.bottom = 'auto';
                    } else { // Bottom wall
                        island.style.top = 'auto';
                        island.style.bottom = '0px';
                    }
                } else { // Vertical
                     if (rect.left < winW / 2) { // Left wall
                        island.style.left = '0px';
                        island.style.right = 'auto';
                    } else { // Right wall
                        island.style.left = 'auto';
                        island.style.right = '0px';
                    }
                }
            } else {
                island.classList.remove('minimized');
                snapIsland(); // Restore to padded position
                resetIslandIdle();
            }
        }
        
        initDynamicIsland();

        islandMinimizeBtn.addEventListener('click', toggleMinimize);
        
        const themes = ['light', 'dark', 'ambient'];
        islandThemeBtn.addEventListener('click', (e) => {
            const currentTheme = document.documentElement.dataset.theme || 'light';
            const currentIndex = themes.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % themes.length;
            const newTheme = themes[nextIndex];
            
            // Fix: Ensure coordinates are valid for touch/click
            const x = (e.clientX !== undefined && e.clientX !== 0) ? e.clientX : window.innerWidth / 2;
            const y = (e.clientY !== undefined && e.clientY !== 0) ? e.clientY : window.innerHeight / 2;
            
            const endRadius = Math.hypot(
                Math.max(x, innerWidth - x),
                Math.max(y, innerHeight - y)
            );

            // View Transition API for "Sunrise" effect
            if (document.startViewTransition) {
                 const transition = document.startViewTransition(() => {
                    applyTheme(newTheme);
                });

                transition.ready.then(() => {
                    // Animate the clip-path of the new view
                    document.documentElement.animate(
                        {
                            clipPath: [
                                `circle(0px at ${x}px ${y}px)`,
                                `circle(${endRadius}px at ${x}px ${y}px)`
                            ],
                        },
                        {
                            duration: 500,
                            easing: 'ease-in',
                            pseudoElement: '::view-transition-new(root)',
                        }
                    );
                });
            } else {
                // Fallback Animation for devices without View Transition API
                 const themeColors = {
                    'light': '#f3f4f6',
                    'dark': '#374151',
                    'ambient': '#eee8d5'
                };
                
                const overlay = document.createElement('div');
                overlay.style.position = 'fixed';
                overlay.style.top = y + 'px';
                overlay.style.left = x + 'px';
                overlay.style.width = '0px';
                overlay.style.height = '0px';
                overlay.style.borderRadius = '50%';
                overlay.style.backgroundColor = themeColors[newTheme];
                overlay.style.zIndex = '10000';
                overlay.style.transform = 'translate(-50%, -50%)';
                overlay.style.pointerEvents = 'none';
                document.body.appendChild(overlay);
                
                const anim = overlay.animate(
                    [{ width: '0px', height: '0px' }, { width: (endRadius * 2) + 'px', height: (endRadius * 2) + 'px' }],
                    { duration: 500, easing: 'ease-in', fill: 'forwards' }
                );
                
                anim.onfinish = () => {
                    applyTheme(newTheme);
                    overlay.remove();
                };
            }
        });
        
        islandSettingsBtn.addEventListener('click', () => {
            isSmoothSwipe = !isSmoothSwipe;
            if (isSmoothSwipe) {
                document.documentElement.style.setProperty('--swipe-duration', '0.3s');
                swipeIconSmooth.classList.remove('hidden');
                swipeIconHard.classList.add('hidden');
                showToast("Swipe Animation: Smooth");
            } else {
                document.documentElement.style.setProperty('--swipe-duration', '0s');
                swipeIconSmooth.classList.add('hidden');
                swipeIconHard.classList.remove('hidden');
                showToast("Swipe Animation: Instant");
            }
        });
        
        islandProgressBtn.addEventListener('click', () => {
            switchScreen('progress');
            renderProgressCharts();
        });

        islandHomeBtn.addEventListener('click', () => {
            const currentScreenId = document.querySelector('.screen.active')?.id;
            const goHome = () => {
                 if (document.startViewTransition) {
                     document.startViewTransition(() => switchScreen('setup'));
                 } else {
                     switchScreen('setup');
                 }
            };
            
            if (currentScreenId === 'exam-screen') {
                showConfirmation("Exit exam and go home? Progress is saved locally.", () => {
                    saveExamDraft();
                    goHome();
                });
            } else if (currentScreenId === 'practice-screen') {
                 showConfirmation("Exit practice session?", () => {
                    savePracticeDraft();
                    goHome();
                 });
            } else {
                goHome();
            }
        });

        // --- THEME LOGIC ---
        function applyTheme(theme) {
            document.documentElement.dataset.theme = theme;
            try {
                localStorage.setItem(THEME_KEY, theme);
            } catch (e) { console.error('Failed to save theme'); }
        }

        // --- UTILS ---
        let toastTimeout;
        function showToast(message) {
            if (toastTimeout) clearTimeout(toastTimeout);
            toastEl.textContent = message;
            toastEl.classList.add('show');
            toastTimeout = setTimeout(() => {
                toastEl.classList.remove('show');
            }, 3000);
        }
        
        function animateButton(buttonEl) {
            buttonEl.classList.remove('pop-animation');
            // This is a trick to restart the animation
            void buttonEl.offsetWidth; 
            buttonEl.classList.add('pop-animation');
        }

        function showConfirmation(message, onConfirm) {
            onConfirmCallback = onConfirm;
            confirmationMessageEl.textContent = message;
            confirmationModal.classList.remove('hidden');
            confirmationModal.classList.add('flex');
        }

        function hideConfirmation() {
            onConfirmCallback = null;
            confirmationModal.classList.add('hidden');
            confirmationModal.classList.remove('flex');
        }

        confirmActionBtn.addEventListener('click', () => {
            if (onConfirmCallback) {
                onConfirmCallback();
            }
            hideConfirmation();
        });

        cancelConfirmationBtn.addEventListener('click', hideConfirmation);

        // --- HISTORY API INTEGRATION ---
        
        // Initialize history state on load
        window.history.replaceState({ screen: 'setup' }, '', '#setup');

        function switchScreen(screenName, pushToHistory = true) {
            Object.values(screens).forEach(screen => {
                if(screen) screen.classList.remove('active');
            });
            if(screens[screenName]) {
                screens[screenName].classList.add('active');
                if (pushToHistory) {
                    window.history.pushState({ screen: screenName }, '', '#' + screenName);
                }
            }
        }

        window.addEventListener('popstate', (event) => {
            const activeScreen = document.querySelector('.screen.active');
            const activeId = activeScreen ? activeScreen.id : 'setup-screen';

            // GUARD: Prevent exiting Exam Mode accidentally
            if (activeId === 'exam-screen') {
                // Push state back immediately to maintain URL/State stability while showing modal
                window.history.pushState({ screen: 'exam' }, '', '#exam');
                showConfirmation("Are you sure you want to exit the exam? Your progress will be saved.", () => {
                    // If confirmed, proceed to finish exam (which goes to results)
                    handleNextSection(); 
                });
                return;
            }

            // GUARD: Prevent exiting Practice Mode accidentally
            if (activeId === 'practice-screen') {
                 window.history.pushState({ screen: 'practice' }, '', '#practice');
                 showConfirmation("Are you sure you want to exit practice mode?", () => {
                    if (practiceTimerInterval) clearInterval(practiceTimerInterval);
                    if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
                    recordTime(currentMcqs[currentPracticeIndex].id, practiceStates);
                    showPracticeResults();
                 });
                 return;
            }

            // Normal Navigation handling
            if (event.state && event.state.screen) {
                switchScreen(event.state.screen, false); // false = don't push again
            } else {
                switchScreen('setup', false);
            }
        });

        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function formatTime(seconds) {
            const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
            const secs = String(seconds % 60).padStart(2, '0');
            return mins + ':' + secs;
        }
        
        function formatTimeDetailed(seconds) {
            if (seconds < 60) return Math.round(seconds) + 's';
            const mins = Math.floor(seconds / 60);
            const secs = Math.round(seconds % 60);
            return mins + 'm ' + secs + 's';
        }

        function processQuestionContent(text, imageContainerId) {
            const imageContainer = document.getElementById(imageContainerId);
            imageContainer.innerHTML = ''; // Clear previous image

            const imageRegex = /{image\s+(\d+)}/g;
            let processedText = text;
            
            let match;
            const displayedImageIndices = new Set();
            while ((match = imageRegex.exec(text)) !== null) {
                const imageIndex = parseInt(match[1], 10) - 1;
                if (images[imageIndex] && !displayedImageIndices.has(imageIndex)) {
                    const img = document.createElement('img');
                    img.src = images[imageIndex];
                    img.alt = 'Illustration for question';
                    img.className = 'max-w-full max-h-96 object-contain rounded-md shadow-sm border mx-auto themed-border-primary';
                    imageContainer.appendChild(img);
                    displayedImageIndices.add(imageIndex);
                }
                processedText = processedText.replace(match[0], '');
            }
            
            return processedText.trim();
        }

        // --- TIME TRACKING LOGIC ---
        function recordTime(mcqId, stateCollection) {
            if (!mcqId || !questionStartTime) return;
            const state = stateCollection.find(s => s.mcqId === mcqId);
            if (state) {
                const elapsed = (Date.now() - questionStartTime) / 1000; // in seconds
                state.timeTaken = (state.timeTaken || 0) + elapsed;
            }
        }

        // --- DRAFT LOGIC ---
        function saveExamDraft() {
            try {
                recordTime(currentMCQ.id, answerStates);
                const draft = {
                    mcqs: currentMcqs, // Save potentially shuffled list
                    sections,
                    answerStates,
                    currentSectionIndex,
                    currentQuestionIndexInSection,
                    subjectName,
                    candidateName,
                    shortNote,
                    isShuffled,
                };
                localStorage.setItem(EXAM_DRAFT_KEY, JSON.stringify(draft));
                questionStartTime = Date.now(); // Reset timer after saving
            } catch (e) {
                console.error("Failed to save exam draft:", e);
            }
        }
        
        function savePracticeDraft() {
            try {
                recordTime(currentMcqs[currentPracticeIndex].id, practiceStates);
                const draft = {
                    mcqs: currentMcqs, // Save the subset of MCQs
                    practiceStates,
                    currentPracticeIndex,
                    subjectName,
                    candidateName,
                    isShuffled,
                    timePerMcq,
                    timeOverall,
                    currentStreak, // Save streak
                };
                localStorage.setItem(PRACTICE_DRAFT_KEY, JSON.stringify(draft));
                questionStartTime = Date.now(); // Reset timer after saving
            } catch (e) {
                console.error("Failed to save practice draft:", e);
            }
        }

        function clearExamDraft() { localStorage.removeItem(EXAM_DRAFT_KEY); }
        function clearPracticeDraft() { localStorage.removeItem(PRACTICE_DRAFT_KEY); }
        
        // --- SAVED QUESTIONS LOGIC ---
        function updateSavedQuestionsUI() {
            if (savedMcqIds.length > 0) {
                savedQuestionsCountEl.textContent = savedMcqIds.length;
                savedQuestionsContainer.classList.remove('hidden');
            } else {
                savedQuestionsContainer.classList.add('hidden');
            }
        }

        function toggleSaveMcq() {
            const mcq = currentMcqs[reviewQuestionIndex];
            if (!mcq) return;

            const mcqId = mcq.id;
            const index = savedMcqIds.indexOf(mcqId);
            let message = '';

            if (index > -1) {
                savedMcqIds.splice(index, 1);
                message = 'Question Unsaved!';
            } else {
                savedMcqIds.push(mcqId);
                message = 'Question Saved!';
                animateButton(saveMcqBtn);
            }

            showToast(message);
            localStorage.setItem(SAVED_MCQS_KEY, JSON.stringify(savedMcqIds));
            updateSaveButtonState();
            updateSavedQuestionsUI();

            if (isReviewingSaved && savedMcqIds.length === 0) {
                alert("You have no saved questions.");
                switchScreen('setup');
            } else if (isReviewingSaved) {
                // Refresh the view if an item is removed
                currentMcqs = initialMcqsState.filter(mcq => savedMcqIds.includes(mcq.id));
                if (reviewQuestionIndex >= currentMcqs.length) {
                    reviewQuestionIndex = Math.max(0, currentMcqs.length - 1);
                }
                renderReviewPalette();
                renderReviewQuestion();
            }
        }
        
        function toggleSavePracticeMcq() {
            const mcq = currentMcqs[currentPracticeIndex];
            if (!mcq) return;

            const mcqId = mcq.id;
            const index = savedMcqIds.indexOf(mcqId);
            let message = '';

            if (index > -1) {
                savedMcqIds.splice(index, 1);
                message = 'Question Unsaved!';
            } else {
                savedMcqIds.push(mcqId);
                message = 'Question Saved!';
                animateButton(saveMcqPracticeBtn);
            }
            
            showToast(message);
            localStorage.setItem(SAVED_MCQS_KEY, JSON.stringify(savedMcqIds));
            updatePracticeSaveButtonState();
            updateSavedQuestionsUI();
        }

        function updateSaveButtonState() {
            const mcq = currentMcqs[reviewQuestionIndex];
            if (!mcq) return;

            if (savedMcqIds.includes(mcq.id)) {
                saveMcqBtn.innerHTML = svgBookmarkSolid;
                saveMcqBtn.setAttribute('aria-label', 'Unsave Question');
            } else {
                saveMcqBtn.innerHTML = svgBookmarkOutline;
                saveMcqBtn.setAttribute('aria-label', 'Save Question');
            }
        }
        
        function updatePracticeSaveButtonState() {
            const mcq = currentMcqs[currentPracticeIndex];
            if (!mcq) return;

            if (savedMcqIds.includes(mcq.id)) {
                saveMcqPracticeBtn.innerHTML = svgBookmarkSolid;
                saveMcqPracticeBtn.setAttribute('aria-label', 'Unsave Question');
            } else {
                saveMcqPracticeBtn.innerHTML = svgBookmarkOutline;
                saveMcqPracticeBtn.setAttribute('aria-label', 'Save Question');
            }
        }

        // --- PALETTE VISIBILITY LOGIC ---
        if(hidePaletteBtn && showPaletteBtn && questionPalette && paletteContentWrapper) {
            hidePaletteBtn.addEventListener('click', () => {
                questionPalette.classList.remove('w-64');
                questionPalette.classList.add('w-0');
                paletteContentWrapper.classList.add('opacity-0');
                hidePaletteBtn.classList.add('hidden');
                showPaletteBtn.classList.remove('hidden');
            });

            showPaletteBtn.addEventListener('click', () => {
                questionPalette.classList.remove('w-0');
                questionPalette.classList.add('w-64');
                paletteContentWrapper.classList.remove('opacity-0');
                showPaletteBtn.classList.add('hidden');
                hidePaletteBtn.classList.remove('hidden');
            });
        }

        // --- CALCULATOR LOGIC ---
        const calculatorHeader = document.getElementById('calculator-header');
        const calculatorCloseBtn = document.getElementById('calculator-close-btn');
        const calculatorDisplay = document.getElementById('calculator-display');
        const calculatorButtons = document.getElementById('calculator-buttons');
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };

        function toggleCalculator(buttonEl) {
            const wasHidden = calculatorModal.classList.contains('hidden');
            
            if (wasHidden) {
                const rect = buttonEl.getBoundingClientRect();
                const calculatorWidth = 256; // Corresponds to Tailwind's w-64 class
                
                // Position it below the button, accounting for page scroll
                calculatorModal.style.top = (rect.bottom + window.scrollY + 10) + 'px';
                
                // Center it horizontally under the button
                let leftPos = rect.left + window.scrollX + (rect.width / 2) - (calculatorWidth / 2);
                
                // Constrain to viewport horizontal edges
                const minLeft = window.scrollX + 8;
                const maxLeft = window.scrollX + window.innerWidth - calculatorWidth - 8;
                leftPos = Math.max(minLeft, Math.min(leftPos, maxLeft));

                calculatorModal.style.left = leftPos + 'px';
            }
             
            calculatorModal.classList.toggle('hidden');
        }
        document.getElementById('calculator-toggle-btn').addEventListener('click', (e) => toggleCalculator(e.currentTarget));
        document.getElementById('practice-calculator-toggle-btn').addEventListener('click', (e) => toggleCalculator(e.currentTarget));
        
        calculatorCloseBtn.addEventListener('click', () => {
            calculatorModal.classList.add('hidden');
        });

        function dragStart(clientX, clientY) {
            isDragging = true;
            dragOffset.x = clientX - calculatorModal.offsetLeft;
            dragOffset.y = clientY - calculatorModal.offsetTop;
            calculatorModal.classList.add('dragging');
            document.body.style.userSelect = 'none'; // Prevent text selection
        }

        function dragMove(clientX, clientY) {
            if (!isDragging) return;
            const newX = clientX - dragOffset.x;
            const newY = clientY - dragOffset.y;
            const maxX = window.innerWidth - calculatorModal.offsetWidth;
            const maxY = window.innerHeight - calculatorModal.offsetHeight;
            calculatorModal.style.left = Math.max(0, Math.min(newX, maxX)) + 'px';
            calculatorModal.style.top = Math.max(0, Math.min(newY, maxY)) + 'px';
        }

        function dragEnd() {
            if (!isDragging) return;
            isDragging = false;
            calculatorModal.classList.remove('dragging');
            document.body.style.userSelect = '';
        }

        // Mouse Events
        calculatorHeader.addEventListener('mousedown', (e) => {
            e.preventDefault();
            dragStart(e.clientX, e.clientY);
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                dragMove(e.clientX, e.clientY);
            }
        });
        
        document.addEventListener('mouseup', dragEnd);

        // Touch Events
        calculatorHeader.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                dragStart(e.touches[0].clientX, e.touches[0].clientY);
            }
        }, { passive: true });

        document.addEventListener('touchmove', (e) => {
            if (isDragging && e.touches.length === 1) {
                e.preventDefault(); // Prevent scrolling while dragging
                dragMove(e.touches[0].clientX, e.touches[0].clientY);
            }
        }, { passive: false });

        document.addEventListener('touchend', dragEnd);
        document.addEventListener('touchcancel', dragEnd);


        const calculatorState = {
            displayValue: '0',
            fullExpression: '', // Holds the full visual string e.g. "6+5"
            firstOperand: null,
            waitingForSecondOperand: false,
            operator: null,
            isResultDisplayed: false
        };

        function updateCalculatorDisplay() {
            calculatorDisplay.textContent = calculatorState.fullExpression || '0';
            calculatorDisplay.scrollLeft = calculatorDisplay.scrollWidth;
        }

        function inputDigit(digit) {
            if (calculatorState.isResultDisplayed) {
                calculatorState.fullExpression = digit;
                calculatorState.displayValue = digit;
                calculatorState.firstOperand = null;
                calculatorState.waitingForSecondOperand = false;
                calculatorState.operator = null;
                calculatorState.isResultDisplayed = false;
                return;
            }

            // Append to full expression, replacing single '0' unless digit is '.'
            if (calculatorState.fullExpression === '0') {
                calculatorState.fullExpression = digit;
            } else {
                calculatorState.fullExpression += digit;
            }

            const { displayValue, waitingForSecondOperand } = calculatorState;
            if (waitingForSecondOperand) {
                calculatorState.displayValue = digit;
                calculatorState.waitingForSecondOperand = false;
            } else {
                calculatorState.displayValue = displayValue === '0' ? digit : displayValue + digit;
            }
        }

        function inputDecimal(dot) {
            if (calculatorState.isResultDisplayed) {
                calculatorState.displayValue = '0.';
                calculatorState.fullExpression = '0.';
                calculatorState.firstOperand = null;
                calculatorState.waitingForSecondOperand = false;
                calculatorState.operator = null;
                calculatorState.isResultDisplayed = false;
                return;
            }

            if (calculatorState.waitingForSecondOperand) {
                calculatorState.displayValue = '0.';
                calculatorState.waitingForSecondOperand = false;
                calculatorState.fullExpression += '0.';
                return;
            }
            if (!calculatorState.displayValue.includes(dot)) {
                calculatorState.displayValue += dot;
                calculatorState.fullExpression += dot;
            }
        }
        
        const performCalculation = {
            '/': (first, second) => second === 0 ? 'Error' : first / second,
            '*': (first, second) => first * second,
            '+': (first, second) => first + second,
            '-': (first, second) => first - second,
        };

        function handleOperator(nextOperator) {
            if (calculatorState.isResultDisplayed) {
                // If starting new operation on result, keep result in display
                calculatorState.fullExpression = calculatorState.displayValue + nextOperator;
                calculatorState.isResultDisplayed = false;
            } else {
                calculatorState.fullExpression += nextOperator;
            }

            const { firstOperand, displayValue, operator } = calculatorState;
            const inputValue = parseFloat(displayValue);

            if (operator && calculatorState.waitingForSecondOperand) {
                calculatorState.operator = nextOperator;
                return;
            }

            if (firstOperand === null) {
                calculatorState.firstOperand = inputValue;
            } else if (operator) {
                const result = performCalculation[operator](firstOperand, inputValue);
                if (result === 'Error') {
                    calculatorState.displayValue = 'Error';
                    calculatorState.fullExpression = 'Error';
                } else {
                    // Truncate long decimals to avoid display issues
                    const resStr = String(parseFloat(result.toFixed(7)));
                    calculatorState.displayValue = resStr;
                }
                calculatorState.firstOperand = result === 'Error' ? null : result;
            }
            
            calculatorState.waitingForSecondOperand = true;
            calculatorState.operator = nextOperator;
        }

        function resetCalculator() {
            calculatorState.displayValue = '0';
            calculatorState.fullExpression = '';
            calculatorState.firstOperand = null;
            calculatorState.waitingForSecondOperand = false;
            calculatorState.operator = null;
            calculatorState.isResultDisplayed = false;
        }

        calculatorButtons.addEventListener('click', (event) => {
            const { target } = event;
            if (!target.matches('button')) return;

            if (calculatorState.displayValue === 'Error' && target.textContent !== 'C') return;

            if (target.classList.contains('digit')) { inputDigit(target.textContent); }
            else if (target.classList.contains('decimal')) { inputDecimal(target.textContent); }
            else if (target.classList.contains('operator')) { handleOperator(target.textContent); }
            else if (target.textContent === 'C') { resetCalculator(); }
            else if (target.classList.contains('equals')) {
                 if (calculatorState.operator && calculatorState.firstOperand !== null) {
                    const inputValue = parseFloat(calculatorState.displayValue);
                    const result = performCalculation[calculatorState.operator](calculatorState.firstOperand, inputValue);
                    
                    let resultStr = 'Error';
                    if (result !== 'Error') {
                         resultStr = String(parseFloat(result.toFixed(7)));
                    }
                    
                    calculatorState.displayValue = resultStr;
                    calculatorState.fullExpression += '=' + resultStr; // Append =Result
                    
                    calculatorState.firstOperand = null;
                    calculatorState.operator = null;
                    calculatorState.waitingForSecondOperand = false;
                    calculatorState.isResultDisplayed = true;
                }
            }
            updateCalculatorDisplay();
        });

        function handleCalculatorKeyPress(event) {
            if (calculatorModal.classList.contains('hidden')) return;

            const { key } = event;
            let buttonToAnimate;
            
            const buttons = Array.from(calculatorButtons.querySelectorAll('button'));

            if (key >= '0' && key <= '9') {
                inputDigit(key);
                buttonToAnimate = buttons.find(b => b.textContent === key && b.classList.contains('digit'));
            } else if (key === '.') {
                inputDecimal(key);
                buttonToAnimate = buttons.find(b => b.textContent === key && b.classList.contains('decimal'));
            } else if (['+', '-', '*', '/'].includes(key)) {
                handleOperator(key);
                buttonToAnimate = buttons.find(b => b.textContent === key && b.classList.contains('operator'));
            } else if (key === 'Enter' || key === '=') {
                event.preventDefault();
                if (calculatorState.operator && calculatorState.firstOperand !== null) {
                     const inputValue = parseFloat(calculatorState.displayValue);
                     const result = performCalculation[calculatorState.operator](calculatorState.firstOperand, inputValue);
                     let resultStr = 'Error';
                     if (result !== 'Error') { resultStr = String(parseFloat(result.toFixed(7))); }
                     calculatorState.displayValue = resultStr;
                     calculatorState.fullExpression += '=' + resultStr;
                     
                     calculatorState.firstOperand = null;
                     calculatorState.operator = null;
                     calculatorState.waitingForSecondOperand = false;
                     calculatorState.isResultDisplayed = true;
                }
                buttonToAnimate = buttons.find(b => b.classList.contains('equals'));
            } else if (key === 'Escape') {
                calculatorModal.classList.add('hidden');
                buttonToAnimate = calculatorCloseBtn;
            } else if (key === 'Backspace' || key.toLowerCase() === 'c') {
                resetCalculator();
                buttonToAnimate = buttons.find(b => b.textContent === 'C');
            }

            if (buttonToAnimate) {
                buttonToAnimate.classList.add('key-press-feedback');
                setTimeout(() => {
                    buttonToAnimate.classList.remove('key-press-feedback');
                }, 100);
            }
            
            if (['0','1','2','3','4','5','6','7','8','9','.','+','-','*','/','Enter','=','Backspace','c','C'].includes(key)) {
                updateCalculatorDisplay();
            }
        }
        document.addEventListener('keydown', handleCalculatorKeyPress);


        // --- SETUP SCREEN LOGIC ---
        const sectionsContainer = document.getElementById('sections-container');
        const setupErrorEl = document.getElementById('setup-error');
        
        function renderSections() {
            sectionsContainer.innerHTML = '';
            sections.forEach((section, index) => {
                const sectionEl = document.createElement('div');
                sectionEl.className = 'p-4 rounded-md flex items-center space-x-3 themed-bg-tertiary';
                const removeButtonHtml = sections.length > 1
                    ? '<button data-index="' + index + '" class="remove-section-btn themed-text-danger text-2xl">\u00d7</button>'
                    : '';
                
                sectionEl.innerHTML =
                    '<input type="text" value="' + section.name + '" data-index="' + index + '" data-field="name" class="section-input p-2 rounded w-1/4 border" placeholder="Section Name"/>' +
                    '<input type="number" value="' + section.startQuestion + '" data-index="' + index + '" data-field="startQuestion" class="section-input p-2 rounded w-1/5 border" placeholder="Start"/>' +
                    '<span class="themed-text-tertiary">to</span>' +
                    '<input type="number" value="' + section.endQuestion + '" data-index="' + index + '" data-field="endQuestion" class="section-input p-2 rounded w-1/5 border" placeholder="End"/>' +
                    '<input type="number" value="' + section.duration + '" data-index="' + index + '" data-field="duration" class="section-input p-2 rounded w-1/5 border" placeholder="Duration (min)"/>' +
                    removeButtonHtml;
                sectionsContainer.appendChild(sectionEl);
            });
        }

        document.getElementById('add-section-btn').addEventListener('click', () => {
            const lastSection = sections[sections.length - 1];
            const nextStart = lastSection.endQuestion + 1;
            if (nextStart > mcqs.length) return;
            sections.push({ name: 'Section ' + (sections.length + 1), startQuestion: nextStart, endQuestion: mcqs.length, duration: mcqs.length - nextStart + 1 });
            renderSections();
        });

        document.getElementById('auto-set-sections-btn').addEventListener('click', () => {
            if (!mcqs || mcqs.length === 0) return;
            
            sections = [];
            const chunkSize = 50;
            let currentStart = 1;
            let idx = 1;
            
            while (currentStart <= mcqs.length) {
                let currentEnd = Math.min(currentStart + chunkSize - 1, mcqs.length);
                sections.push({
                    name: 'Section ' + idx,
                    startQuestion: currentStart,
                    endQuestion: currentEnd,
                    duration: (currentEnd - currentStart + 1) // 1 minute per question
                });
                currentStart = currentEnd + 1;
                idx++;
            }
            renderSections();
            showToast("Sections auto-configured");
        });

        sectionsContainer.addEventListener('change', (e) => {
            const target = e.target;
            if (target.classList.contains('section-input')) {
                const { index, field } = target.dataset;
                const value = field === 'name' ? target.value : parseInt(target.value, 10);
                sections[index][field] = value;
            }
        });
        
        sectionsContainer.addEventListener('click', (e) => {
            const target = e.target;
            if(target.classList.contains('remove-section-btn')) {
                const { index } = target.dataset;
                sections.splice(parseInt(index, 10), 1);
                renderSections();
            }
        });

        document.getElementById('revise-btn').addEventListener('click', () => {
            setupErrorEl.textContent = '';
            subjectName = document.getElementById('subject-name').value;
            candidateName = document.getElementById('candidate-name').value;
            
            // Use full, unshuffled set for revision
            currentMcqs = [...initialMcqsState]; 
            answerStates = currentMcqs.map(mcq => ({ mcqId: mcq.id, status: QuestionStatus.NotVisited, selectedOption: undefined, timeTaken: 0 }));
            reviewQuestionIndex = 0;
            switchScreen('review');
            setupReviewScreen(true, false); // isReviseMode = true
        });

        document.getElementById('start-exam-btn').addEventListener('click', () => {
            setupErrorEl.textContent = '';
            subjectName = document.getElementById('subject-name').value;
            candidateName = document.getElementById('candidate-name').value;
            shortNote = document.getElementById('short-note').value;
            
            let questionSet = new Set();
            for(const section of sections) {
                if(section.startQuestion > section.endQuestion || section.startQuestion < 1 || section.endQuestion > mcqs.length) {
                    setupErrorEl.textContent = 'Invalid range in ' + section.name + '.'; return;
                }
                if(section.duration <= 0) {
                    setupErrorEl.textContent = 'Duration must be positive in ' + section.name + '.'; return;
                }
                for(let i = section.startQuestion; i <= section.endQuestion; i++) {
                    if(questionSet.has(i)) {
                        setupErrorEl.textContent = 'Question ' + i + ' is in multiple sections.'; return;
                    }
                    questionSet.add(i);
                }
            }
            if (questionSet.size !== mcqs.length && mcqs.length > 0) {
                 const allCoveredQuestions = Array.from(questionSet).sort((a,b) => a-b);
                 if (allCoveredQuestions.length !== mcqs.length || allCoveredQuestions[allCoveredQuestions.length - 1] !== mcqs.length) {
                    setupErrorEl.textContent = 'All questions must be covered exactly once across all sections.'; return;
                 }
            }
            
            startExam();
        });
        
        function initializeSetup() {
            sections = [{ name: 'Section 1', startQuestion: 1, endQuestion: mcqs.length, duration: mcqs.length }];
            renderSections();
            const qCountSlider = document.getElementById('practice-q-count-slider');
            const qCountLabel = document.getElementById('practice-q-count-label');
            if(qCountSlider) {
                qCountSlider.addEventListener('input', () => {
                    qCountLabel.textContent = qCountSlider.value;
                });
            }
        }

        function confirmAndProceedToNextSection() {
            const isLastSection = currentSectionIndex === sections.length - 1;
            const message = isLastSection
                ? "Are you sure you want to submit the exam? This will end the test."
                : "Are you sure you want to submit this section? You will not be able to return to it.";
            showConfirmation(message, handleNextSection);
        }


        // --- EXAM LOGIC ---
        let currentSectionMCQs = [];
        let currentMCQ;

        function startExam() {
            isShuffled = document.getElementById('shuffle-mcqs-checkbox').checked;
            let baseMcqs = JSON.parse(JSON.stringify(initialMcqsState));

            if (isShuffled) {
                // Shuffle questions *within* each section's defined range
                sections.forEach(section => {
                    const startIndex = section.startQuestion - 1;
                    const endIndex = section.endQuestion;
                    const sectionSlice = baseMcqs.slice(startIndex, endIndex);
                    shuffleArray(sectionSlice);
                    // Replace the original slice with the shuffled one
                    baseMcqs.splice(startIndex, sectionSlice.length, ...sectionSlice);
                });
            }
            
            currentMcqs.length = 0;
            Array.prototype.push.apply(currentMcqs, baseMcqs);


            answerStates = currentMcqs.map(mcq => ({ mcqId: mcq.id, status: QuestionStatus.NotVisited, selectedOption: undefined, timeTaken: 0 }));
            currentSectionIndex = 0;
            currentQuestionIndexInSection = 0;
            loadSection();
            switchScreen('exam');
        }

        function loadSection() {
            if (timerInterval) clearInterval(timerInterval);

            const section = sections[currentSectionIndex];
            document.getElementById('section-name').textContent = section.name;
            
            // Get questions for the current section from the (potentially shuffled) main list
            currentSectionMCQs = currentMcqs.slice(section.startQuestion - 1, section.endQuestion);
            
            loadQuestion();
            renderPalette();

            let timeLeft = section.duration * 60;
            const timerEl = document.getElementById('timer');
            timerEl.textContent = formatTime(timeLeft);
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = formatTime(timeLeft);
                if (timeLeft <= 0) {
                    handleNextSection();
                }
            }, 1000);
        }
        
        function loadQuestion() {
            currentMCQ = currentSectionMCQs[currentQuestionIndexInSection];
            const answerState = answerStates.find(a => a.mcqId === currentMCQ.id);

            if (answerState.status === QuestionStatus.NotVisited) {
                answerState.status = QuestionStatus.NotAnswered;
            }
            
            document.getElementById('question-counter').textContent = 'Question ' + (currentQuestionIndexInSection + 1) + ' of ' + currentSectionMCQs.length;
            document.getElementById('question-text').innerHTML = processQuestionContent(currentMCQ.question, 'question-image-container');
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            Object.keys(currentMCQ.options).forEach(key => {
                const isSelected = answerState.selectedOption === key;
                const optionEl = document.createElement('label');
                const selectedClass = isSelected ? 'selected' : '';
                optionEl.className = 'option-label flex items-center p-4 rounded-lg cursor-pointer border-2 ' + selectedClass;
                optionEl.innerHTML =
                    '<input type="radio" name="option" value="' + key + '" ' + (isSelected ? 'checked' : '') + ' class="hidden"/>' +
                    '<span class="radio-circle w-6 h-6 rounded-full border-2 themed-border-secondary mr-4 flex-shrink-0 relative"></span>' +
                    '<span class="flex-1">' + key.toUpperCase() + '. ' + currentMCQ.options[key] + '</span>';
                optionsContainer.appendChild(optionEl);
            });

            const saveNextBtn = document.getElementById('save-next-btn');
            if (currentQuestionIndexInSection === currentSectionMCQs.length - 1) {
                saveNextBtn.textContent = 'Submit Section';
            } else {
                saveNextBtn.textContent = 'Save & Next';
            }
            
            document.getElementById('prev-btn').disabled = currentQuestionIndexInSection === 0;
            updatePaletteItem(currentMCQ.id);
            updatePaletteLegendCounts();
            saveExamDraft(); // Auto-save on every question load
            questionStartTime = Date.now();
        }

        document.getElementById('options-container').addEventListener('change', e => {
            const target = e.target;
            if (target.name === 'option') {
                const answerState = answerStates.find(a => a.mcqId === currentMCQ.id);
                const newStatus = answerState.status === QuestionStatus.MarkedForReview ? QuestionStatus.MarkedForReview : QuestionStatus.Answered;
                answerState.selectedOption = target.value;
                answerState.status = newStatus;
                loadQuestion(); // Re-render to show selection and auto-save
            }
        });

        function navigateQuestion(offset) {
            recordTime(currentMCQ.id, answerStates);
            const newIndex = currentQuestionIndexInSection + offset;
            if (newIndex >= 0 && newIndex < currentSectionMCQs.length) {
                currentQuestionIndexInSection = newIndex;
                loadQuestion();
            } else if (newIndex >= currentSectionMCQs.length) {
                confirmAndProceedToNextSection();
            }
        }

        document.getElementById('save-next-btn').addEventListener('click', () => navigateQuestion(1));
        document.getElementById('prev-btn').addEventListener('click', () => navigateQuestion(-1));

        document.getElementById('mark-review-btn').addEventListener('click', () => {
            const answerState = answerStates.find(a => a.mcqId === currentMCQ.id);
            answerState.status = answerState.status === QuestionStatus.MarkedForReview 
                ? (answerState.selectedOption ? QuestionStatus.Answered : QuestionStatus.NotAnswered)
                : QuestionStatus.MarkedForReview;
            updatePaletteItem(currentMCQ.id);
            updatePaletteLegendCounts();
            navigateQuestion(1);
        });

        document.getElementById('clear-response-btn').addEventListener('click', () => {
            const answerState = answerStates.find(a => a.mcqId === currentMCQ.id);
            answerState.selectedOption = undefined;
            answerState.status = QuestionStatus.NotAnswered;
            loadQuestion();
        });

        function handleNextSection() {
            recordTime(currentMCQ.id, answerStates);
            if (currentSectionIndex < sections.length - 1) {
                currentSectionIndex++;
                currentQuestionIndexInSection = 0;
                loadSection();
            } else {
                clearInterval(timerInterval);
                showResults();
            }
        }

        // --- PALETTE LOGIC ---
        function updatePaletteLegendCounts() {
            const sectionMCQIds = new Set(currentSectionMCQs.map(mcq => mcq.id));

            const counts = {
                [QuestionStatus.Answered]: 0,
                [QuestionStatus.NotAnswered]: 0,
                [QuestionStatus.NotVisited]: 0,
                [QuestionStatus.MarkedForReview]: 0,
            };

            answerStates.forEach(state => {
                if (sectionMCQIds.has(state.mcqId)) {
                    counts[state.status]++;
                }
            });

            document.getElementById('answered-count').textContent = String(counts[QuestionStatus.Answered]);
            document.getElementById('not-answered-count').textContent = String(counts[QuestionStatus.NotAnswered]);
            document.getElementById('not-visited-count').textContent = String(counts[QuestionStatus.NotVisited]);
            document.getElementById('marked-for-review-count').textContent = String(counts[QuestionStatus.MarkedForReview]);
        }

        function renderPalette() {
            const paletteContainer = document.getElementById('palette-container');
            paletteContainer.innerHTML = '';
            currentSectionMCQs.forEach((mcq, index) => {
                const answerState = answerStates.find(a => a.mcqId === mcq.id);
                const btn = document.createElement('button');
                btn.id = 'palette-item-' + mcq.id;
                btn.dataset.index = String(index);
                btn.className = 'h-10 w-10 flex items-center justify-center rounded text-white font-bold relative ' + statusColors[answerState.status];
                btn.innerHTML = (index + 1);
                // Accessibility: Add dynamic aria-label
                btn.setAttribute('aria-label', 'Go to question ' + (index + 1));
                if (answerState.status === QuestionStatus.MarkedForReview) {
                    btn.innerHTML += '<svg xmlns="http://www.w3.org/2000/svg" class="absolute bottom-1 right-1 h-3 w-3 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z" /></svg>';
                }
                btn.addEventListener('click', () => {
                    recordTime(currentMCQ.id, answerStates);
                    currentQuestionIndexInSection = parseInt(btn.dataset.index, 10);
                    loadQuestion();
                });
                paletteContainer.appendChild(btn);
            });
        }

        function updatePaletteItem(mcqId) {
            const btn = document.getElementById('palette-item-' + mcqId);
            if (!btn) return;
            const answerState = answerStates.find(a => a.mcqId === mcqId);
            btn.className = 'h-10 w-10 flex items-center justify-center rounded text-white font-bold relative ' + statusColors[answerState.status];
            btn.innerHTML = String(parseInt(btn.dataset.index, 10) + 1);
            if (answerState.status === QuestionStatus.MarkedForReview) {
                btn.innerHTML += '<svg xmlns="http://www.w3.org/2000/svg" class="absolute bottom-1 right-1 h-3 w-3 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z" /></svg>';
            }
        }

        // --- RESULTS LOGIC ---
        function showResults() {
            clearExamDraft();
            const shortNoteHtml = shortNote ? '<p><span class="font-bold">Notes:</span> ' + shortNote + '</p>' : '';
            const detailsHtml =
                '<p><span class="font-bold">Subject:</span> ' + (subjectName || 'N/A') + '</p>' +
                '<p><span class="font-bold">Candidate:</span> ' + (candidateName || 'N/A') + '</p>' +
                shortNoteHtml;
            document.getElementById('exam-details').innerHTML = detailsHtml;

            const results = sections.map(section => {
                let correct = 0, incorrect = 0, unanswered = 0;
                // Use the section's original question indices to find the right questions in the shuffled list
                const sectionQs = currentMcqs.slice(section.startQuestion - 1, section.endQuestion);
                sectionQs.forEach(mcq => {
                    const answerState = answerStates.find(a => a.mcqId === mcq.id);
                    if(answerState) {
                        if(!answerState.selectedOption) unanswered++;
                        else if(answerState.selectedOption === mcq.correctAnswer) correct++;
                        else incorrect++;
                    }
                });

                const total = correct + incorrect + unanswered;
                return { name: section.name, correct, incorrect, unanswered, total, score: total > 0 ? (correct / total * 100) : 0 };
            });
            
            const totalCorrect = results.reduce((sum, r) => sum + r.correct, 0);
            const totalIncorrect = results.reduce((sum, r) => sum + r.incorrect, 0);
            const totalUnanswered = results.reduce((sum, r) => sum + r.unanswered, 0);
            const overallTotal = totalCorrect + totalIncorrect + totalUnanswered;
            const overallScore = overallTotal > 0 ? (totalCorrect / overallTotal * 100) : 0;
            const scoreColorClass = overallScore >= 50 ? 'themed-text-success' : 'themed-text-danger';
            
            const attemptedStates = answerStates.filter(s => s.timeTaken > 0);
            const totalTimeSpent = attemptedStates.reduce((acc, s) => acc + s.timeTaken, 0);
            const avgTime = attemptedStates.length > 0 ? totalTimeSpent / attemptedStates.length : 0;
            const avgTimeHtml = '<div class="mt-4 themed-text-secondary">Average time per question: <span class="font-semibold">' + formatTimeDetailed(avgTime) + '</span></div>';

            const performanceHtml =
                '<h2 class="text-2xl font-semibold">Overall Performance</h2>' +
                '<p class="text-5xl font-bold my-4 ' + scoreColorClass + '">' + overallScore.toFixed(2) + '%</p>' +
                '<div class="flex justify-center space-x-8 text-lg">' +
                    '<span><span class="font-bold themed-text-success">' + totalCorrect + '</span> Correct</span>' +
                    '<span><span class="font-bold themed-text-danger">' + totalIncorrect + '</span> Incorrect</span>' +
                    '<span><span class="font-bold themed-text-secondary">' + totalUnanswered + '</span> Unanswered</span>' +
                '</div>' + avgTimeHtml;
            document.getElementById('overall-performance').innerHTML = performanceHtml;
            
            const sectionAnalysisContainer = document.getElementById('section-analysis');
            sectionAnalysisContainer.innerHTML = '';
            results.forEach(r => {
                sectionAnalysisContainer.innerHTML +=
                    '<div class="p-4 rounded-lg themed-bg-primary">' +
                        '<div class="flex justify-between items-center mb-2">' +
                            '<h3 class="text-xl font-bold">' + r.name + '</h3>' +
                            '<p class="text-xl font-semibold themed-text-accent">' + r.score.toFixed(2) + '%</p>' +
                        '</div>' +
                        '<div class="flex justify-around text-sm">' +
                            '<span>Correct: <span class="font-bold themed-text-success">' + r.correct + '</span></span>' +
                            '<span>Incorrect: <span class="font-bold themed-text-danger">' + r.incorrect + '</span></span>' +
                            '<span>Unanswered: <span class="font-bold themed-text-secondary">' + r.unanswered + '</span></span>' +
                        '</div>' +
                    '</div>';
            });
            const analysisHtml = sectionAnalysisContainer.innerHTML;

            // Save result to localStorage history
            const historyJSON = localStorage.getItem(EXAM_RESULTS_HISTORY_KEY);
            let history = historyJSON ? JSON.parse(historyJSON) : [];
            const resultData = {
                timestamp: new Date().toISOString(),
                overallScore: overallScore.toFixed(2),
                detailsHtml,
                performanceHtml,
                analysisHtml,
                answerStates,
                currentMcqs,
                subjectName,
                candidateName,
                shortNote,
                isShuffled
            };
            history.unshift(resultData); // Add to the beginning
            localStorage.setItem(EXAM_RESULTS_HISTORY_KEY, JSON.stringify(history));
            
            const pastResultsContainer = document.getElementById('past-results-container');
            const pastResultsCount = document.getElementById('past-results-count');
            pastResultsContainer.classList.remove('hidden');
            pastResultsCount.textContent = history.length;


            switchScreen('results');
        }

        document.getElementById('restart-btn').addEventListener('click', () => {
            clearExamDraft();
            clearPracticeDraft();
            document.getElementById('subject-name').value = '';
            document.getElementById('candidate-name').value = '';
            document.getElementById('short-note').value = '';
            document.getElementById('shuffle-mcqs-checkbox').checked = false;
            
            currentMcqs.length = 0;
            Array.prototype.push.apply(currentMcqs, JSON.parse(JSON.stringify(initialMcqsState)));
            
            initializeSetup();
            switchScreen('setup');
        });
        
        document.getElementById('download-report-btn').addEventListener('click', () => {
            reportOptionsModal.classList.remove('hidden');
            reportOptionsModal.classList.add('flex');
        });
        
        document.getElementById('cancel-report-download-btn').addEventListener('click', () => {
            reportOptionsModal.classList.add('hidden');
            reportOptionsModal.classList.remove('flex');
        });

        document.getElementById('download-with-explanations-btn').addEventListener('click', () => {
            reportOptionsModal.classList.add('hidden');
            reportOptionsModal.classList.remove('flex');
            downloadReport(true);
        });

        document.getElementById('download-without-explanations-btn').addEventListener('click', () => {
            reportOptionsModal.classList.add('hidden');
            reportOptionsModal.classList.remove('flex');
            downloadReport(false);
        });

        function renderMarkdownToPdf(doc, markdown, options) {
            let { x, y, maxWidth, pageHeight, margin, lineHeight, bulletIndent } = options;
            if (!markdown) return y;

            const checkPageBreak = (neededHeight) => {
                if (y + neededHeight > pageHeight - margin) {
                    doc.addPage();
                    y = margin;
                }
                return y;
            };

            const renderTextBlock = (textBlock) => {
                if (!textBlock.trim()) return;
                
                const blocks = textBlock.split(/\n\s*\n/);
                blocks.forEach(block => {
                    const trimmedBlock = block.trim();
                    if (!trimmedBlock) return;
                    
                    const lines = trimmedBlock.split('\n');
                
                    let isUnordered = lines.every(l => l.trim().startsWith('- ') || l.trim().startsWith('* '));
                    let isOrdered = lines.every(l => l.trim().match(/^\d+\.\s/));
                    
                    if(isUnordered) {
                        lines.forEach(line => {
                            const itemText = line.trim().substring(2);
                            const splitText = doc.splitTextToSize(itemText, maxWidth - bulletIndent);
                            y = checkPageBreak(splitText.length * lineHeight);
                            doc.text('â€¢', x, y, { baseline: 'top' });
                            doc.text(splitText, x + bulletIndent, y, { baseline: 'top' });
                            y += splitText.length * lineHeight;
                        });
                        y += lineHeight / 2;
                    } else if (isOrdered) {
                        lines.forEach(line => {
                            const number = line.trim().match(/^\d+\./)[0];
                            const itemText = line.trim().substring(number.length).trim();
                            const splitText = doc.splitTextToSize(itemText, maxWidth - doc.getTextWidth(number) - bulletIndent);
                            y = checkPageBreak(splitText.length * lineHeight);
                            doc.text(number, x, y, { baseline: 'top' });
                            doc.text(splitText, x + doc.getTextWidth(number) + bulletIndent - 2, y, { baseline: 'top' });
                            y += splitText.length * lineHeight;
                        });
                        y += lineHeight / 2;
                    } else { // Paragraph
                        lines.forEach(line => {
                            let isBold = line.startsWith('**') && line.endsWith('**') && line.length > 4;
                            let isItalic = line.startsWith('*') && line.endsWith('*') && line.length > 2;
                            
                            let processedLine = line;
                            if (isBold) {
                                processedLine = line.substring(2, line.length - 2);
                                doc.setFont('helvetica', 'bold');
                            } else if (isItalic) {
                                processedLine = line.substring(1, line.length - 1);
                                doc.setFont('helvetica', 'italic');
                            }

                            const splitText = doc.splitTextToSize(processedLine, maxWidth);
                            y = checkPageBreak(splitText.length * lineHeight);
                            doc.text(splitText, x, y, { baseline: 'top' });
                            y += splitText.length * lineHeight;

                            doc.setFont('helvetica', 'normal'); // Reset font
                        });
                        y += lineHeight / 2;
                    }
                });
            };

            const imageRegex = /({image\s+\d+})/g;
            const parts = markdown.split(imageRegex).filter(part => part);

            parts.forEach(part => {
                if (part.match(imageRegex)) {
                    const imageIndex = parseInt(part.match(/\d+/)[0], 10) - 1;
                    if (images[imageIndex]) {
                        try {
                            const imgData = images[imageIndex];
                            const fileType = imgData.substring(imgData.indexOf('/') + 1, imgData.indexOf(';'));
                            const imgProps = doc.getImageProperties(imgData);
                            const imgWidth = Math.min(maxWidth, imgProps.width);
                            const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

                            y = checkPageBreak(imgHeight + 5); 
                            doc.addImage(imgData, fileType.toUpperCase(), x, y, imgWidth, imgHeight);
                            y += imgHeight + 5;
                        } catch (e) {
                            console.error("Error adding image to PDF:", e);
                            const errorText = '[Error loading image]';
                            y = checkPageBreak(lineHeight);
                            doc.text(errorText, x, y, { baseline: 'top' });
                            y += lineHeight;
                        }
                    }
                } else {
                    renderTextBlock(part);
                }
            });

            return y;
        }

        async function downloadReport(includeExplanations) {
            const btn = document.getElementById('download-report-btn');
            btn.disabled = true;
            btn.textContent = 'Generating...';

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const analyticsContainer = document.querySelector('#results-screen > div');

                // --- Page 1: Analytics ---
                doc.setFontSize(22);
                doc.text('Exam Report', 105, 20, { align: 'center' });
                
                doc.setFontSize(11);
                doc.text('Subject: ' + (subjectName || 'N/A'), 15, 35);
                doc.text('Candidate: ' + (candidateName || 'N/A'), 15, 42);
                if (shortNote) {
                    const noteLines = doc.splitTextToSize('Notes: ' + shortNote, 180);
                    doc.text(noteLines, 15, 49);
                }
                doc.setFontSize(9);
                doc.setTextColor(150);
                doc.text('Generated on: ' + new Date().toLocaleString(), 105, 58, { align: 'center' });

                const canvas = await window.html2canvas(analyticsContainer, { scale: 2, windowWidth: analyticsContainer.scrollWidth, windowHeight: analyticsContainer.scrollHeight });
                const imgData = canvas.toDataURL('image/png');
                const imgProps = doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                doc.addImage(imgData, 'PNG', 10, 65, pdfWidth - 20, pdfHeight);

                // --- Subsequent Pages: Detailed Review ---
                doc.addPage();
                doc.setFontSize(18);
                doc.text('Detailed Answer Review', 105, 15, { align: 'center' });

                let y = 30;
                const margin = 15;
                const pageHeight = doc.internal.pageSize.getHeight();
                const maxWidth = pdfWidth - margin * 2;

                currentMcqs.forEach((mcq, index) => {
                    const answerState = answerStates.find(a => a.mcqId === mcq.id);
                    if (y > pageHeight - 40) { 
                        doc.addPage();
                        y = 20;
                    }

                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(12);
                    
                    const questionContent = (index + 1) + '. ' + mcq.question;
                    const imageRegex = /({image\s+\d+})/g;
                    const questionParts = questionContent.split(imageRegex).filter(part => part);

                    const checkPageBreakForQuestion = (neededHeight) => {
                        if (y + neededHeight > pageHeight - margin) {
                            doc.addPage();
                            y = 20;
                        }
                    };

                    questionParts.forEach(part => {
                        if (part.match(imageRegex)) {
                            const imageIndex = parseInt(part.match(/\d+/)[0], 10) - 1;
                            if (images[imageIndex]) {
                                try {
                                    const imgData = images[imageIndex];
                                    const fileType = imgData.substring(imgData.indexOf('/') + 1, imgData.indexOf(';'));
                                    const imgProps = doc.getImageProperties(imgData);
                                    const imgWidth = Math.min(maxWidth, imgProps.width);
                                    const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

                                    checkPageBreakForQuestion(imgHeight + 5);
                                    doc.addImage(imgData, fileType.toUpperCase(), margin, y, imgWidth, imgHeight);
                                    y += imgHeight + 5;
                                } catch (e) {
                                    console.error("Error adding image to PDF:", e);
                                    const errorText = '[Error loading image]';
                                    checkPageBreakForQuestion(7);
                                    doc.text(errorText, margin, y, { baseline: 'top' });
                                    y += 7;
                                }
                            }
                        } else {
                            const questionText = doc.splitTextToSize(part, maxWidth);
                            checkPageBreakForQuestion(questionText.length * 7);
                            doc.text(questionText, margin, y, { baseline: 'top' });
                            y += questionText.length * 7;
                        }
                    });
                    y += 3;


                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    Object.keys(mcq.options).forEach(key => {
                        const isCorrect = mcq.correctAnswer === key;
                        const isSelected = answerState.selectedOption === key;

                        if (isCorrect) doc.setTextColor(34, 139, 34);
                        else if (isSelected && !isCorrect) doc.setTextColor(220, 20, 60);
                        else doc.setTextColor(0, 0, 0);
                        
                        const optionString = '(' + key.toUpperCase() + ') ' + mcq.options[key];
                        const optionText = doc.splitTextToSize(optionString, maxWidth - 5);
                        doc.text(optionText, margin + 5, y, { baseline: 'top' });
                        y += optionText.length * 5;
                    });
                    y += 3;
                    
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(9);
                    const summaryText = 'Your Answer: ' + (answerState.selectedOption ? answerState.selectedOption.toUpperCase() : 'Not Answered') + ' | Correct Answer: ' + mcq.correctAnswer.toUpperCase();
                    doc.text(summaryText, margin, y, { baseline: 'top' });
                    y += 7;

                    if (includeExplanations && mcq.explanation) {
                        doc.setTextColor(55, 65, 81);
                        doc.setFont('helvetica', 'bold');
                        doc.setFontSize(10);
                        doc.text('Explanation:', margin, y, { baseline: 'top' });
                        y += 6;

                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(9);

                        const renderOptions = { x: margin, y: y, maxWidth: maxWidth, pageHeight: pageHeight, margin: margin, lineHeight: 4.5, bulletIndent: 4 };
                        y = renderMarkdownToPdf(doc, mcq.explanation, renderOptions);
                    }
                    
                    y += 4;

                    if (index < currentMcqs.length - 1) {
                        doc.setDrawColor(200, 200, 200);
                        doc.line(margin, y, pdfWidth - margin, y);
                        y += 7;
                    }
                });

                doc.save('exam_report.pdf');
            } catch (error) {
                console.error("Failed to generate report:", error);
                alert("Sorry, there was an error generating the report.");
            } finally {
                btn.disabled = false;
                btn.textContent = 'Download Report';
            }
        }
        
        function markdownToHtml(markdown) {
            if (!markdown) return '';

            let text = markdown
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');

            const blocks = text.split(/\n\s*\n/);
            
            return blocks.map(block => {
                const trimmedBlock = block.trim();
                if (!trimmedBlock) return '';

                const lines = trimmedBlock.split('\n');

                if (lines.every(line => line.trim().startsWith('- ') || line.trim().startsWith('* '))) {
                    const listItems = lines.map(line => '<li>' + line.trim().substring(2) + '</li>').join('');
                    return '<ul>' + listItems + '</ul>';
                }

                if (lines.every(line => line.trim().match(/^\d+\.\s/))) {
                    const listItems = lines.map(line => '<li>' + line.trim().replace(/^\d+\.\s/, '') + '</li>').join('');
                    return '<ol>' + listItems + '</ol>';
                }

                return '<p>' + lines.join('<br />') + '</p>';
            }).join('');
        }
        
        // --- PRACTICE MODE LOGIC ---
        document.getElementById('start-practice-btn').addEventListener('click', () => {
            setupErrorEl.textContent = '';
            subjectName = document.getElementById('subject-name').value;
            candidateName = document.getElementById('candidate-name').value;

            const savedPracticeDraft = localStorage.getItem(PRACTICE_DRAFT_KEY);

            if (savedPracticeDraft) {
                practiceResumeModal.classList.remove('hidden');
                practiceResumeModal.classList.add('flex');
            } else {
                startPractice(false); // false means don't load from draft
            }
        });

        document.getElementById('practice-resume-btn').addEventListener('click', () => {
            practiceResumeModal.classList.add('hidden');
            practiceResumeModal.classList.remove('flex');
            startPractice(true); // true means load from draft
        });

        document.getElementById('practice-start-new-btn').addEventListener('click', () => {
            practiceResumeModal.classList.add('hidden');
            practiceResumeModal.classList.remove('flex');
            clearPracticeDraft();
            startPractice(false);
        });

        function handleQuestionTimeout() {
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
            const mcq = currentMcqs[currentPracticeIndex];
            const practiceState = practiceStates.find(p => p.mcqId === mcq.id);

            if (practiceState.attempted) return;

            practiceState.attempted = true;
            practiceState.selectedOption = null; // Timed out, considered incorrect
            practiceState.timeTaken = timePerMcq;
            
            revealPracticeAnswer(null);
            savePracticeDraft();
        }

        // Streak UI Helper
        function updateStreakUI() {
            const streakBadge = document.getElementById('streak-badge');
            const streakCountEl = document.getElementById('streak-count');
            
            if (currentStreak > 0) {
                streakBadge.classList.remove('hidden');
                streakCountEl.textContent = currentStreak;
                
                // Animate
                streakBadge.classList.remove('active');
                void streakBadge.offsetWidth; // Trigger reflow
                streakBadge.classList.add('active');
                setTimeout(() => streakBadge.classList.remove('active'), 200);
            } else {
                streakBadge.classList.add('hidden');
            }
        }

        function startPractice(loadFromDraft = false) {
            if (practiceTimerInterval) clearInterval(practiceTimerInterval);
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
            
            if (loadFromDraft) {
                try {
                    const draft = JSON.parse(localStorage.getItem(PRACTICE_DRAFT_KEY));
                    currentMcqs.length = 0;
                    Array.prototype.push.apply(currentMcqs, draft.mcqs);
                    practiceStates = draft.practiceStates;
                    currentPracticeIndex = draft.currentPracticeIndex;
                    subjectName = draft.subjectName;
                    candidateName = draft.candidateName;
                    isShuffled = draft.isShuffled;
                    timePerMcq = draft.timePerMcq || 0;
                    timeOverall = draft.timeOverall || 0;
                    currentStreak = draft.currentStreak || 0;
                    
                    document.getElementById('subject-name').value = subjectName || '';
                    document.getElementById('candidate-name').value = candidateName || '';
                    document.getElementById('shuffle-mcqs-checkbox').checked = isShuffled;

                } catch (e) {
                    console.error("Failed to load practice draft:", e);
                    alert("The saved practice draft is corrupted. Starting a new session.");
                    clearPracticeDraft();
                    loadFromDraft = false; // Fallback to new session
                }
            }
            
            if (!loadFromDraft) {
                currentStreak = 0; // Reset streak
                isShuffled = document.getElementById('shuffle-mcqs-checkbox').checked;
                let baseMcqs = [...initialMcqsState];
                if (isShuffled) {
                    shuffleArray(baseMcqs);
                }

                const qCountSlider = document.getElementById('practice-q-count-slider');
                let qCount = parseInt(qCountSlider.value, 10);
                if (isNaN(qCount) || qCount <= 0 || qCount > baseMcqs.length) {
                    qCount = baseMcqs.length;
                }
                currentMcqs = baseMcqs.slice(0, qCount);
                
                practiceStates = currentMcqs.map(mcq => ({ mcqId: mcq.id, selectedOption: null, attempted: false, timeTaken: 0 }));
                currentPracticeIndex = 0;
                timePerMcq = parseInt(document.getElementById('practice-time-per-mcq').value, 10) || 0;
                timeOverall = parseInt(document.getElementById('practice-time-overall').value, 10) || 0;
            }

            document.getElementById('practice-subject-name').textContent = subjectName || 'Practice Mode';
            updateStreakUI();
            switchScreen('practice');
            renderPracticePalette(); // Added call to render palette
            renderPracticeQuestion();
            
            const practiceTimerEl = document.getElementById('practice-timer');
            if (timeOverall > 0) {
                practiceTimerEl.classList.remove('hidden');
                let timeLeft = timeOverall * 60;
                practiceTimerEl.textContent = formatTime(timeLeft);
                practiceTimerInterval = setInterval(() => {
                    timeLeft--;
                    practiceTimerEl.textContent = formatTime(timeLeft);
                    if (timeLeft <= 0) {
                        if(practiceTimerInterval) clearInterval(practiceTimerInterval);
                        if(perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
                        alert("Practice time is up!");
                        showPracticeResults();
                    }
                }, 1000);
            } else {
                practiceTimerEl.classList.add('hidden');
            }
        }

        function renderPracticeQuestion() {
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);

            const mcq = currentMcqs[currentPracticeIndex];
            const practiceState = practiceStates.find(p => p.mcqId === mcq.id);
            
            document.getElementById('practice-question-counter').textContent = 'Question ' + (currentPracticeIndex + 1) + ' of ' + currentMcqs.length;
            document.getElementById('practice-question-text').innerHTML = (currentPracticeIndex + 1) + '. ' + processQuestionContent(mcq.question, 'practice-question-image-container');

            // Update Palette Active State
            const allPaletteBtns = document.querySelectorAll('#practice-palette-grid button');
            allPaletteBtns.forEach(btn => btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500'));
            const currentBtn = document.getElementById('practice-palette-item-' + currentPracticeIndex);
            if (currentBtn) {
                currentBtn.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
                // Ensure the active button is visible in the scrollable container
                currentBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }

            const optionsContainer = document.getElementById('practice-options-container');
            optionsContainer.innerHTML = '';
            
            Object.keys(mcq.options).forEach(key => {
                const optionEl = document.createElement('div');
                optionEl.dataset.optionKey = key;
                optionEl.className = 'flex items-center p-4 rounded-lg border-2 transition-all themed-bg-tertiary themed-border-primary';
                optionEl.innerHTML = '<span class="flex-1">' + key.toUpperCase() + '. ' + mcq.options[key] + '</span>';
                optionsContainer.appendChild(optionEl);
            });
            
            // Hide previous results elements
            document.getElementById('practice-explanation-section').classList.add('hidden');
            document.getElementById('header-feedback-badge').classList.remove('visible');
            document.getElementById('header-feedback-badge').className = 'feedback-badge'; // Reset class

            if (practiceState.attempted) {
                revealPracticeAnswer(practiceState.selectedOption);
            } else {
                optionsContainer.classList.add('cursor-pointer');
                optionsContainer.querySelectorAll('[data-option-key]').forEach(el => el.classList.add('themed-bg-accent-hover'));
            }

            // Per-question timer logic
            const timerContainer = document.getElementById('per-question-timer-container');
            const timerBar = document.getElementById('per-question-timer-bar');
            if (timePerMcq > 0 && !practiceState.attempted) {
                timerContainer.classList.remove('hidden');
                timerBar.style.width = '100%';
                timerBar.classList.remove('bg-green-500');
                timerBar.classList.add('bg-green-500');

                const timerStart = Date.now();
                perQuestionTimerInterval = setInterval(() => {
                    const elapsed = (Date.now() - timerStart) / 1000;
                    if (elapsed >= timePerMcq) {
                        handleQuestionTimeout();
                        return;
                    }
                    const remainingPercent = ((timePerMcq - elapsed) / timePerMcq) * 100;
                    timerBar.style.width = remainingPercent + '%';

                    if (remainingPercent < 40) {
                        timerBar.classList.remove('bg-green-500');
                        timerBar.classList.add('bg-red-500');
                    }
                }, 100);
            } else {
                timerContainer.classList.add('hidden');
            }

            document.getElementById('practice-prev-btn').disabled = currentPracticeIndex === 0;
            document.getElementById('practice-next-btn').disabled = currentPracticeIndex === currentMcqs.length - 1;
            
            updatePracticeSaveButtonState();
            questionStartTime = Date.now();
        }

        function revealPracticeAnswer(selectedKey) {
            const mcq = currentMcqs[currentPracticeIndex];
            const optionsContainer = document.getElementById('practice-options-container');
            optionsContainer.classList.remove('cursor-pointer');
            
            // Check correctness
            const isCorrect = mcq.correctAnswer === selectedKey;
            
            // Update Palette Button Color for the answered question
            const paletteBtn = document.getElementById('practice-palette-item-' + currentPracticeIndex);
            if (paletteBtn) {
                // If selectedKey is null (timeout), it's incorrect (red)
                const paletteIsCorrect = selectedKey && (mcq.correctAnswer === selectedKey);
                paletteBtn.className = 'w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full text-white font-bold transition-all transform hover:scale-110 focus:outline-none ' + (paletteIsCorrect ? 'bg-green-600' : 'bg-red-600');
            }

            optionsContainer.querySelectorAll('[data-option-key]').forEach(el => {
                el.classList.remove('themed-bg-accent-hover');
                const key = el.dataset.optionKey;
                const isOptionCorrect = mcq.correctAnswer === key;
                const isSelected = selectedKey === key;

                el.classList.remove('themed-bg-tertiary', 'themed-border-primary');
                
                // SVG Icons
                const checkIcon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2 text-green-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>';
                const crossIcon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2 text-red-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>';

                if (isOptionCorrect) {
                    el.style.backgroundColor = 'var(--bg-success)';
                    el.style.borderColor = 'var(--bg-success-border)';
                    if (!el.innerHTML.includes('<svg')) el.innerHTML += checkIcon;
                    
                    if (isCorrect && isSelected) {
                        triggerConfetti(el.getBoundingClientRect());
                    }
                } else if (isSelected && !isOptionCorrect) {
                    el.style.backgroundColor = 'var(--bg-danger)';
                    el.style.borderColor = 'var(--bg-danger-border)';
                     if (!el.innerHTML.includes('<svg')) el.innerHTML += crossIcon;
                } else {
                    el.classList.add('opacity-60');
                }
            });
            
            // --- HEADER FEEDBACK ---
            const badge = document.getElementById('header-feedback-badge');
            const badgeText = document.getElementById('header-feedback-text');
            
            if (isCorrect) {
                badge.className = 'feedback-badge visible correct';
                badgeText.innerHTML = 'Excellent! ðŸŽ‰';
            } else {
                badge.className = 'feedback-badge visible incorrect';
                badgeText.innerHTML = 'Incorrect âŒ';
            }

            // --- EXPLANATION SECTION ---
            const explanationSection = document.getElementById('practice-explanation-section');
            const explanationContainer = document.getElementById('practice-explanation-container');
            
            if (mcq.explanation) {
                const cleanedExplanationText = processQuestionContent(mcq.explanation, 'practice-explanation-image-container');
                explanationContainer.innerHTML = markdownToHtml(cleanedExplanationText);
            } else {
                document.getElementById('practice-explanation-image-container').innerHTML = '';
                explanationContainer.innerHTML = '<p class="themed-text-tertiary">No explanation was provided for this question.</p>';
            }
            explanationSection.classList.remove('hidden');
        }

        document.getElementById('practice-options-container').addEventListener('click', (e) => {
            const optionEl = e.target.closest('[data-option-key]');
            if (!optionEl) return;

            const mcq = currentMcqs[currentPracticeIndex];
            const practiceState = practiceStates.find(p => p.mcqId === mcq.id);
            
            if (practiceState.attempted) return;
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);

            recordTime(mcq.id, practiceStates);
            
            const selectedKey = optionEl.dataset.optionKey;
            practiceState.attempted = true;
            practiceState.selectedOption = selectedKey;

            // STREAK LOGIC UPDATE
            if (selectedKey === mcq.correctAnswer) {
                currentStreak++;
            } else {
                currentStreak = 0;
            }
            updateStreakUI();

            revealPracticeAnswer(selectedKey);
            savePracticeDraft();
        });
        
        // ADDED: Function to render the practice palette
        function renderPracticePalette() {
            const paletteGrid = document.getElementById('practice-palette-grid');
            if (!paletteGrid) return;
            paletteGrid.innerHTML = '';

            currentMcqs.forEach((mcq, index) => {
                const btn = document.createElement('button');
                btn.id = 'practice-palette-item-' + index;
                btn.dataset.index = String(index);
                
                // Determine color based on state
                const pState = practiceStates.find(p => p.mcqId === mcq.id);
                let bgClass = 'bg-gray-400'; // Default gray
                if (pState && pState.attempted) {
                     const isCorrect = pState.selectedOption === mcq.correctAnswer;
                     bgClass = isCorrect ? 'bg-green-600' : 'bg-red-600';
                }

                btn.className = 'w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full text-white font-bold transition-all transform hover:scale-110 focus:outline-none ' + bgClass; 
                btn.textContent = String(index + 1);
                btn.setAttribute('aria-label', 'Go to question ' + (index + 1));
                
                btn.addEventListener('click', () => {
                    if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
                    // Record time for current before switching if not answered
                    const currentMcq = currentMcqs[currentPracticeIndex];
                    if(currentMcq) {
                         const currentState = practiceStates.find(p => p.mcqId === currentMcq.id);
                         if (!currentState.attempted) recordTime(currentMcq.id, practiceStates);
                    }
                    
                    currentPracticeIndex = parseInt(btn.dataset.index, 10);
                    renderPracticeQuestion();
                    savePracticeDraft();
                });
                paletteGrid.appendChild(btn);
            });
        }
        
        function navigatePractice(offset) {
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
            const mcq = currentMcqs[currentPracticeIndex];
            const practiceState = practiceStates.find(p => p.mcqId === mcq.id);
            if (!practiceState.attempted) {
                recordTime(mcq.id, practiceStates); // Record time even if unanswered
            }

            const newIndex = currentPracticeIndex + offset;
            if (newIndex >= 0 && newIndex < currentMcqs.length) {
                currentPracticeIndex = newIndex;
                renderPracticeQuestion();
                savePracticeDraft();
            }
        }

        document.getElementById('practice-prev-btn').addEventListener('click', () => navigatePractice(-1));
        document.getElementById('practice-next-btn').addEventListener('click', () => navigatePractice(1));

        document.getElementById('exit-practice-btn').addEventListener('click', () => {
            if (practiceTimerInterval) clearInterval(practiceTimerInterval);
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
            recordTime(currentMcqs[currentPracticeIndex].id, practiceStates);
            showPracticeResults();
        });

        // --- REVIEW LOGIC ---
        let reviewQuestionIndex = 0;
        
        function setupReviewScreen(isReviseMode = false, isSavedMode = false) {
            const backBtn = document.getElementById('back-to-results-btn');
            const exitBtn = document.getElementById('exit-revise-btn');
            isReviewingSaved = isSavedMode;

            if (isSavedMode) {
                reviewTitleEl.textContent = 'Saved Questions';
                backBtn.style.display = 'none';
                exitBtn.style.display = 'inline-block';
                document.getElementById('review-time-taken').style.display = 'none';
            } else if (isReviseMode) {
                reviewTitleEl.textContent = 'Revise Mode';
                backBtn.style.display = 'none';
                exitBtn.style.display = 'inline-block';
                document.getElementById('review-time-taken').style.display = 'none';
            } else {
                reviewTitleEl.textContent = 'Review Answers';
                backBtn.style.display = 'inline-block';
                exitBtn.style.display = 'none';
                document.getElementById('review-time-taken').style.display = 'flex';
                if (reviewReturnScreen === 'practiceResults') {
                    backBtn.textContent = 'Back to Practice Results';
                } else {
                    backBtn.textContent = 'Back to Exam Results';
                }
            }
            renderReviewPalette();
            renderReviewQuestion();
        }
        
        document.getElementById('review-answers-btn').addEventListener('click', () => {
            reviewQuestionIndex = 0;
            reviewReturnScreen = 'results';
            switchScreen('review');
            setupReviewScreen(false, false);
        });
        
        document.getElementById('exit-revise-btn').addEventListener('click', () => {
            switchScreen('setup');
        });

        document.getElementById('review-practice-answers-btn').addEventListener('click', () => {
            answerStates = currentMcqs.map(mcq => {
                const pState = practiceStates.find(p => p.mcqId === mcq.id);
                return { mcqId: mcq.id, selectedOption: pState ? pState.selectedOption : null, timeTaken: pState ? pState.timeTaken : 0 };
            });
            reviewQuestionIndex = 0;
            reviewReturnScreen = 'practiceResults';
            switchScreen('review');
            setupReviewScreen(false, false);
        });

        document.getElementById('back-to-results-btn').addEventListener('click', () => switchScreen(reviewReturnScreen));
        
        function renderReviewPalette() {
            const paletteGrid = document.getElementById('review-palette-grid');
            if (!paletteGrid) return;
            paletteGrid.innerHTML = '';

            currentMcqs.forEach((mcq, index) => {
                const answerState = answerStates.find(a => a.mcqId === mcq.id);
                const isCorrect = answerState && answerState.selectedOption === mcq.correctAnswer;
                const hasAnswered = answerState && answerState.selectedOption !== undefined && answerState.selectedOption !== null;
                
                let bgClass = 'bg-gray-400';
                if (hasAnswered) {
                    bgClass = isCorrect ? 'bg-green-600' : 'bg-red-600';
                }

                const btn = document.createElement('button');
                btn.id = 'review-palette-item-' + index;
                btn.dataset.index = String(index);
                btn.className = 'w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full text-white font-bold transition-all transform hover:scale-110 focus:outline-none ' + bgClass;
                btn.textContent = String(index + 1);
                // Accessibility: Dynamic aria label
                btn.setAttribute('aria-label', 'Review question ' + (index + 1));
                btn.addEventListener('click', () => {
                    reviewQuestionIndex = parseInt(btn.dataset.index, 10);
                    renderReviewQuestion();
                });
                paletteGrid.appendChild(btn);
            });
        }

        function renderReviewQuestion() {
            updateSaveButtonState();
            const allPaletteBtns = document.querySelectorAll('#review-palette-grid button');
            allPaletteBtns.forEach(btn => btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500'));
            const currentBtn = document.getElementById('review-palette-item-' + reviewQuestionIndex);
            if (currentBtn) {
                currentBtn.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
                currentBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }

            const mcq = currentMcqs[reviewQuestionIndex];
            const answerState = answerStates.find(a => a.mcqId === mcq.id);
            
            document.getElementById('review-question-text').innerHTML = (reviewQuestionIndex + 1) + '. ' + processQuestionContent(mcq.question, 'review-question-image-container');
            document.getElementById('review-question-counter').textContent = 'Question ' + (reviewQuestionIndex + 1) + ' of ' + currentMcqs.length;
            
            const timeTakenEl = document.getElementById('review-time-taken');
            if (answerState && answerState.timeTaken) {
                timeTakenEl.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg> Time Taken: <span class="font-semibold ml-1">' + formatTimeDetailed(answerState.timeTaken) + '</span>';
            } else {
                timeTakenEl.innerHTML = '';
            }

            const explanationContainer = document.getElementById('explanation-container');
            if (mcq.explanation) {
                const cleanedExplanationText = processQuestionContent(mcq.explanation, 'explanation-image-container');
                explanationContainer.innerHTML = markdownToHtml(cleanedExplanationText);
            } else {
                document.getElementById('explanation-image-container').innerHTML = '';
                explanationContainer.innerHTML = '<p class="themed-text-tertiary">No explanation was provided for this question.</p>';
            }
            
            const reviewOptionsContainer = document.getElementById('review-options-container');
            reviewOptionsContainer.innerHTML = '';
            Object.keys(mcq.options).forEach(key => {
                const isSelected = answerState && answerState.selectedOption === key;
                const isCorrect = mcq.correctAnswer === key;
                let style = 'background-color: var(--bg-tertiary); border-color: transparent;';
                let indicatorText = '';

                if (isCorrect) {
                    style = 'background-color: var(--bg-success); border-color: var(--bg-success-border);';
                    indicatorText = '<span class="ml-auto text-sm font-semibold themed-text-success">Correct Answer</span>';
                }
                
                if (isSelected && !isCorrect) {
                    style = 'background-color: var(--bg-danger); border-color: var(--bg-danger-border);';
                    indicatorText = '<span class="ml-auto text-sm font-semibold themed-text-danger">Your Answer</span>';
                } else if (isSelected && isCorrect) {
                     indicatorText = '<span class="ml-auto text-sm font-semibold themed-text-success">Your Answer (Correct)</span>';
                }
                
                reviewOptionsContainer.innerHTML +=
                    '<div class="flex items-center p-4 rounded-lg border-2" style="' + style + '">' +
                        '<span class="flex-1">' + key.toUpperCase() + '. ' + mcq.options[key] + '</span>' +
                        indicatorText +
                    '</div>';
            });
            
            document.getElementById('review-prev-btn').disabled = reviewQuestionIndex === 0;
            document.getElementById('review-next-btn').disabled = reviewQuestionIndex === currentMcqs.length - 1;
        }

        document.getElementById('review-prev-btn').addEventListener('click', () => {
            if(reviewQuestionIndex > 0) {
                reviewQuestionIndex--;
                renderReviewQuestion();
            }
        });

        document.getElementById('review-next-btn').addEventListener('click', () => {
            if(reviewQuestionIndex < currentMcqs.length - 1) {
                reviewQuestionIndex++;
                renderReviewQuestion();
            }
        });
        
        // --- SWIPE NAVIGATION LOGIC ---
        function setupSwipeNavigation(container) {
            let touchStartX = 0;
            let touchStartY = 0;
            const mainContent = container.querySelector('main');
            let isAnimating = false;

            container.addEventListener('touchstart', e => {
                if (isAnimating) return;
                
                // FIX: Prevent page swipe if user is trying to scroll the palette
                if (e.target.closest('.overflow-x-auto')) return;

                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            container.addEventListener('touchend', e => {
                if (isAnimating) return;
                const touchEndX = e.changedTouches[0].screenX;
                const touchEndY = e.changedTouches[0].screenY;
                const diffX = touchEndX - touchStartX;
                const diffY = touchEndY - touchStartY;

                if (Math.abs(diffX) > 50 && Math.abs(diffX) > Math.abs(diffY)) {
                    
                    const isNext = diffX < 0; // Swipe Left
                    
                    // FIX: Re-enabled swipe backward (swipe right)
                    // The line that prevented it was removed here.

                    isAnimating = true;
                    const outClass = isNext ? 'slide-out-left' : 'slide-out-right';
                    const inClass = isNext ? 'slide-in-from-right' : 'slide-in-from-left';
                    
                    const onAnimationOutEnd = () => {
                        mainContent.removeEventListener('animationend', onAnimationOutEnd);
                        mainContent.classList.remove(outClass);

                        // Perform navigation action
                        if (container.id === 'practice-screen') {
                            if (isNext) navigatePractice(1);
                            else navigatePractice(-1);
                        } else if (container.id === 'review-screen') {
                            if (isNext) document.getElementById('review-next-btn').click();
                            else document.getElementById('review-prev-btn').click();
                        }

                        mainContent.classList.add(inClass);
                        
                        const onAnimationInEnd = () => {
                            mainContent.removeEventListener('animationend', onAnimationInEnd);
                            mainContent.classList.remove(inClass);
                            isAnimating = false;
                        };
                        mainContent.addEventListener('animationend', onAnimationInEnd);
                    };

                    mainContent.addEventListener('animationend', onAnimationOutEnd);
                    mainContent.classList.add(outClass);
                }
            }, { passive: true });
        }

        setupSwipeNavigation(screens.practice);
        setupSwipeNavigation(screens.review);

        // --- PAST RESULTS LOGIC ---
        function showPastResultsList() {
            const historyJSON = localStorage.getItem(EXAM_RESULTS_HISTORY_KEY);
            const history = historyJSON ? JSON.parse(historyJSON) : [];
            const listEl = document.getElementById('past-results-list');
            listEl.innerHTML = '';

            if (history.length === 0) {
                listEl.innerHTML = '<p class="text-center themed-text-tertiary">No past results found.</p>';
            } else {
                history.forEach((result, index) => {
                    const date = new Date(result.timestamp).toLocaleString();
                    const scoreColor = result.overallScore >= 50 ? 'themed-text-success' : 'themed-text-danger';
                    const item = document.createElement('button');
                    item.className = 'w-full text-left p-4 rounded-lg border flex justify-between items-center transition-colors themed-bg-primary themed-border-primary hover:bg-[var(--bg-tertiary)]';
                    item.dataset.resultIndex = index;
                    item.innerHTML = 
                        '<div>' +
                            '<p class="font-bold themed-text-primary">' + (result.subjectName || 'Untitled Exam') + '</p>' +
                            '<p class="text-sm themed-text-secondary">' + date + '</p>' +
                        '</div>' +
                        '<div class="text-right">' +
                            '<p class="text-xl font-bold ' + scoreColor + '">' + result.overallScore + '%</p>' +
                            '<p class="text-xs themed-text-tertiary">Click to view details</p>' +
                        '</div>';
                    listEl.appendChild(item);
                });
            }
            switchScreen('pastResults');
        }
        
        document.getElementById('past-results-list').addEventListener('click', (e) => {
            const target = e.target.closest('[data-result-index]');
            if (target) {
                const index = parseInt(target.dataset.resultIndex, 10);
                const historyJSON = localStorage.getItem(EXAM_RESULTS_HISTORY_KEY);
                const history = historyJSON ? JSON.parse(historyJSON) : [];
                const resultData = history[index];
                if (resultData) {
                    loadResultIntoView(resultData);
                }
            }
        });

        function loadResultIntoView(resultData) {
            document.getElementById('exam-details').innerHTML = resultData.detailsHtml;
            document.getElementById('overall-performance').innerHTML = resultData.performanceHtml;
            document.getElementById('section-analysis').innerHTML = resultData.analysisHtml;
            
            // Set state for the "Review Answers" button for this specific result
            answerStates = resultData.answerStates;
            currentMcqs = resultData.currentMcqs;
            subjectName = resultData.subjectName;
            candidateName = resultData.candidateName;
            shortNote = resultData.shortNote;
            isShuffled = resultData.isShuffled;
            
            switchScreen('results');
        }
        
        document.getElementById('back-to-setup-from-history-btn').addEventListener('click', () => switchScreen('setup'));

        // --- PROGRESS CHARTS RENDERING ---
        function renderProgressCharts() {
            const examHistoryJSON = localStorage.getItem(EXAM_RESULTS_HISTORY_KEY);
            const examHistory = examHistoryJSON ? JSON.parse(examHistoryJSON) : [];
            
            const practiceHistoryJSON = localStorage.getItem(PRACTICE_RESULTS_HISTORY_KEY);
            const practiceHistory = practiceHistoryJSON ? JSON.parse(practiceHistoryJSON) : [];

            // --- KPI DASHBOARD STATS ---
            // Combine scores for calculation? No, separate is better. Let's show Exam stats primarily.
            const examScores = examHistory.map(h => parseFloat(h.overallScore || 0));
            const totalExams = examHistory.length;
            const avgScore = totalExams > 0 ? (examScores.reduce((a,b)=>a+b, 0) / totalExams).toFixed(1) : '0';
            const maxScore = totalExams > 0 ? Math.max(...examScores).toFixed(1) : '0';
            
            // Total Practice Questions Solved
            const totalPracticeQs = practiceHistory.reduce((acc, curr) => acc + (curr.attempted || 0), 0);

            const kpiDashboard = document.getElementById('kpi-dashboard');
            kpiDashboard.innerHTML = ''; // Clear previous

            const kpis = [
                { label: 'Avg Exam Score', value: avgScore + '%', color: 'text-blue-500' },
                { label: 'Highest Score', value: maxScore + '%', color: 'text-green-500' },
                { label: 'Total Attempts', value: totalExams, color: 'text-purple-500' },
                { label: 'Practice Qs', value: totalPracticeQs, color: 'text-orange-500' }
            ];

            kpis.forEach(kpi => {
                const card = document.createElement('div');
                card.className = 'stat-card themed-bg-primary themed-border-primary';
                card.innerHTML = `
                    <span class="stat-value ${kpi.color}">${kpi.value}</span>
                    <span class="stat-label">${kpi.label}</span>
                `;
                kpiDashboard.appendChild(card);
            });


            // Helper to create bars
            const createBar = (score, labelText, tooltipTitle, subtitle, index, prevScore) => {
                const scoreNum = parseFloat(score);
                const isSuccess = scoreNum >= 50;
                const barClass = isSuccess ? 'bar-success' : 'bar-danger';
                
                const barContainer = document.createElement('div');
                barContainer.className = 'chart-bar-container';
                
                const bar = document.createElement('div');
                bar.className = 'chart-bar ' + barClass;
                bar.style.height = Math.max(scoreNum, 5) + '%'; 
                // Staggered Animation Delay
                bar.style.animationDelay = (index * 0.1) + 's';
                
                // Text inside bar
                const barText = document.createElement('span');
                barText.className = 'chart-bar-text';
                barText.textContent = scoreNum.toFixed(1) + '%';
                if (scoreNum < 15) barText.style.display = 'none';
                bar.appendChild(barText);
                
                const label = document.createElement('div');
                label.className = 'chart-bar-label';
                label.textContent = labelText;
                
                // Trend Indicator
                let trendHtml = '';
                if (prevScore !== null) {
                    const diff = scoreNum - prevScore;
                    if (diff > 0) trendHtml = '<span class="text-green-400 ml-2 text-xs">â–² +' + diff.toFixed(1) + '%</span>';
                    else if (diff < 0) trendHtml = '<span class="text-red-400 ml-2 text-xs">â–¼ ' + diff.toFixed(1) + '%</span>';
                    else trendHtml = '<span class="text-gray-400 ml-2 text-xs">- 0%</span>';
                }

                const tooltip = document.createElement('div');
                tooltip.className = 'chart-bar-tooltip';
                tooltip.innerHTML = '<strong>' + tooltipTitle + '</strong>' + trendHtml + '<br/>' + subtitle;
                
                barContainer.appendChild(tooltip);
                barContainer.appendChild(bar);
                barContainer.appendChild(label);
                
                return barContainer;
            };

            // 1. Render Exam Chart
            const examContainer = document.getElementById('exam-chart-container');
            const examEmpty = document.getElementById('exam-chart-empty');
            
            examContainer.innerHTML = '';
            if (examHistory.length === 0) {
                examEmpty.classList.remove('hidden');
            } else {
                examEmpty.classList.add('hidden');
                // Process in chronological order for trends, but show recent last? 
                // Actually history is stored newest first. Let's reverse to show chronological left-to-right.
                const reversedHistory = [...examHistory].reverse();
                
                reversedHistory.forEach((result, i) => {
                    let correct = 0, total = 0;
                    if (result.answerStates && result.currentMcqs) {
                        result.answerStates.forEach(state => {
                            const mcq = result.currentMcqs.find(m => m.id === state.mcqId);
                            if(mcq) {
                                total++;
                                if (state.selectedOption === mcq.correctAnswer) correct++;
                            }
                        });
                    }
                    
                    const date = new Date(result.timestamp).toLocaleDateString(undefined, {month: 'short', day: 'numeric'});
                    const subject = (result.subjectName || 'Exam').substring(0, 15);
                    
                    // Previous score for trend
                    const prevScore = i > 0 ? parseFloat(reversedHistory[i-1].overallScore) : null;

                    const bar = createBar(
                        result.overallScore, 
                        date, 
                        subject, 
                        'Score: ' + result.overallScore + '%<br>Marks: ' + correct + ' / ' + total,
                        i,
                        prevScore
                    );
                    examContainer.appendChild(bar);
                });
            }

            // 2. Render Practice Chart
            const practiceContainer = document.getElementById('practice-chart-container');
            const practiceEmpty = document.getElementById('practice-chart-empty');
            
            practiceContainer.innerHTML = '';
            if (practiceHistory.length === 0) {
                practiceEmpty.classList.remove('hidden');
            } else {
                practiceEmpty.classList.add('hidden');
                const reversedHistory = [...practiceHistory].reverse();
                
                reversedHistory.forEach((result, i) => {
                    const date = new Date(result.timestamp).toLocaleDateString(undefined, {month: 'short', day: 'numeric'});
                    const subject = (result.subjectName || 'Practice').substring(0, 15);
                    const prevScore = i > 0 ? parseFloat(reversedHistory[i-1].score) : null;

                    const bar = createBar(
                        result.score, 
                        date, 
                        subject, 
                        'Score: ' + result.score + '%<br>Marks: ' + result.correct + ' / ' + result.attempted,
                        i,
                        prevScore
                    );
                    practiceContainer.appendChild(bar);
                });
            }
        }

        document.getElementById('reset-practice-history-btn').addEventListener('click', () => {
            showConfirmation("Are you sure you want to clear all practice history? This cannot be undone.", () => {
                localStorage.removeItem(PRACTICE_RESULTS_HISTORY_KEY);
                renderProgressCharts();
            });
        });
        
        function showPracticeResults() {
            if (practiceTimerInterval) clearInterval(practiceTimerInterval);
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
            clearPracticeDraft();
            
            const detailsHtml =
                '<p><span class="font-bold">Subject:</span> ' + (subjectName || 'N/A') + '</p>' +
                '<p><span class="font-bold">Candidate:</span> ' + (candidateName || 'N/A') + '</p>';
            document.getElementById('practice-exam-details').innerHTML = detailsHtml;

            let correct = 0, incorrect = 0, attempted = 0;
            practiceStates.forEach(state => {
                if (state.attempted) {
                    attempted++;
                    const mcq = currentMcqs.find(m => m.id === state.mcqId);
                    if (mcq && state.selectedOption === mcq.correctAnswer) {
                        correct++;
                    } else {
                        incorrect++;
                    }
                }
            });
            
            const score = attempted > 0 ? (correct / attempted * 100) : 0;
            const scoreColorClass = score >= 50 ? 'themed-text-success' : 'themed-text-danger';
            
            document.getElementById('practice-score').className = 'text-5xl font-bold my-4 ' + scoreColorClass;
            document.getElementById('practice-score').textContent = score.toFixed(2) + '%';
            
            document.getElementById('practice-correct').innerHTML = '<span class="font-bold themed-text-success">' + correct + '</span> Correct';
            document.getElementById('practice-incorrect').innerHTML = '<span class="font-bold themed-text-danger">' + incorrect + '</span> Incorrect';
            document.getElementById('practice-attempted').innerHTML = '<span class="font-bold themed-text-secondary">' + attempted + '</span> Attempted';
            
            const attemptedStates = practiceStates.filter(s => s.timeTaken > 0);
            const totalTimeSpent = attemptedStates.reduce((acc, s) => acc + s.timeTaken, 0);
            const avgTime = attemptedStates.length > 0 ? totalTimeSpent / attemptedStates.length : 0;
            document.getElementById('practice-avg-time').innerHTML = 'Average time per question: <span class="font-semibold">' + formatTimeDetailed(avgTime) + '</span>';

            // SAVE PRACTICE RESULT
            const historyJSON = localStorage.getItem(PRACTICE_RESULTS_HISTORY_KEY);
            let history = historyJSON ? JSON.parse(historyJSON) : [];
            const resultData = {
                timestamp: new Date().toISOString(),
                score: score.toFixed(2),
                correct,
                incorrect,
                attempted,
                subjectName
            };
            history.unshift(resultData);
            localStorage.setItem(PRACTICE_RESULTS_HISTORY_KEY, JSON.stringify(history));

            switchScreen('practiceResults');
        }

        document.getElementById('restart-practice-btn').addEventListener('click', () => {
            clearPracticeDraft();
            startPractice(false);
        });
        
        document.getElementById('back-to-setup-btn').addEventListener('click', () => switchScreen('setup'));
        document.getElementById('back-to-setup-from-progress-btn').addEventListener('click', () => switchScreen('setup'));

        // --- INITIALIZE APP ---
        const savedExamDraft = localStorage.getItem(EXAM_DRAFT_KEY);
        if (savedExamDraft) {
            const resumeBanner = document.getElementById('resume-banner');
            resumeBanner.classList.remove('hidden');

            document.getElementById('resume-session-btn').addEventListener('click', () => {
                try {
                    const draft = JSON.parse(savedExamDraft);
                    
                    currentMcqs.length = 0;
                    Array.prototype.push.apply(currentMcqs, draft.mcqs);
                    sections = draft.sections;
                    answerStates = draft.answerStates;
                    currentSectionIndex = draft.currentSectionIndex;
                    currentQuestionIndexInSection = draft.currentQuestionIndexInSection;
                    subjectName = draft.subjectName;
                    candidateName = draft.candidateName;
                    shortNote = draft.shortNote;
                    isShuffled = draft.isShuffled;

                    document.getElementById('subject-name').value = subjectName || '';
                    document.getElementById('candidate-name').value = candidateName || '';
                    document.getElementById('short-note').value = shortNote || '';
                    document.getElementById('shuffle-mcqs-checkbox').checked = isShuffled;
                    
                    renderSections();
                    loadSection();
                    switchScreen('exam');

                } catch (e) {
                    console.error("Failed to load exam draft:", e);
                    alert("The saved exam draft appears to be corrupted and could not be loaded.");
                    clearExamDraft();
                    resumeBanner.classList.add('hidden');
                }
            });

            document.getElementById('discard-draft-btn').addEventListener('click', () => {
                clearExamDraft();
                resumeBanner.classList.add('hidden');
            });
        }
        
        const savedMcqsData = localStorage.getItem(SAVED_MCQS_KEY);
        if (savedMcqsData) {
            try {
                savedMcqIds = JSON.parse(savedMcqsData);
            } catch (e) {
                console.error("Could not parse saved MCQs", e);
                savedMcqIds = [];
            }
        }
        updateSavedQuestionsUI();
        
        const savedResultsData = localStorage.getItem(EXAM_RESULTS_HISTORY_KEY);
        if (savedResultsData) {
            const history = JSON.parse(savedResultsData);
            if(history.length > 0) {
                const pastResultsContainer = document.getElementById('past-results-container');
                const pastResultsCount = document.getElementById('past-results-count');
                pastResultsContainer.classList.remove('hidden');
                pastResultsCount.textContent = history.length;
            }
        }

        document.getElementById('view-past-results-btn').addEventListener('click', showPastResultsList);

        saveMcqBtn.addEventListener('click', toggleSaveMcq);
        saveMcqPracticeBtn.addEventListener('click', toggleSavePracticeMcq);
        
        if (toggleSparklesBtn) {
            toggleSparklesBtn.addEventListener('click', () => {
                isSparklesEnabled = !isSparklesEnabled;
                const svg = toggleSparklesBtn.querySelector('svg');
                if (isSparklesEnabled) {
                    svg.classList.remove('themed-text-secondary');
                    svg.classList.add('text-yellow-500');
                    svg.setAttribute('fill', 'currentColor');
                    showToast("Sparkles On âœ¨");
                } else {
                    svg.classList.add('themed-text-secondary');
                    svg.classList.remove('text-yellow-500');
                    svg.setAttribute('fill', 'none');
                    showToast("Sparkles Off");
                }
            });
        }

        viewSavedBtn.addEventListener('click', () => {
            if (savedMcqIds.length === 0) {
                alert("You have no saved questions.");
                return;
            }
            currentMcqs = initialMcqsState.filter(mcq => savedMcqIds.includes(mcq.id));
            answerStates = currentMcqs.map(mcq => ({
                mcqId: mcq.id,
                status: QuestionStatus.NotVisited,
                selectedOption: undefined,
                timeTaken: 0
            }));
            reviewQuestionIndex = 0;
            switchScreen('review');
            setupReviewScreen(true, true);
        });

        if (mcqs.length > 0) {
            currentMcqs = [...mcqs];
            initializeSetup();
        } else {
            switchScreen('setup');
            document.getElementById('setup-error').textContent = "No questions were loaded. Please generate a new file.";
            document.getElementById('start-exam-btn').disabled = true;
            document.getElementById('add-section-btn').disabled = true;
        }
      } catch (error) {
          console.error("Fatal error during exam initialization:", error);
          document.body.innerHTML =
              '<div style="padding: 2rem; text-align: center; font-family: sans-serif; color: #333;">' +
                  '<h1 style="color: #d9534f; font-size: 2rem;">An Unexpected Error Occurred</h1>' +
                  '<p style="margin-top: 1rem;">The exam file could not be loaded. This is likely due to an internal script error.</p>' +
                  '<p style="margin-top: 0.5rem;">Please try generating the exam file again from the main application.</p>' +
                  '<div style="margin-top: 2rem; padding: 1rem; background-color: #f7f7f7; border: 1px solid #ddd; text-align: left; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; font-size: 0.8rem; max-width: 800px; margin-left: auto; margin-right: auto;">' +
                      '<h3 style="margin-bottom: 0.5rem; font-weight: bold;">Error Details:</h3>' +
                      error.message +
                  '</div>' +
              '</div>';
      }
    });

</script>
<script>
    // --- DISABLE BROWSER BACK/FORWARD ---
    // This script prevents the user from using the browser back button or swipe gestures
    // to leave the page or navigate history, keeping them in the exam app.
    history.pushState(null, document.title, location.href);
    window.addEventListener('popstate', function (event) {
        history.pushState(null, document.title, location.href);
    });
</script>
</body>
</html>
    
