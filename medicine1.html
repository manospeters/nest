
<!DOCTYPE html>
<html lang="en">
<head>
    <script>
    // --- SECURITY CHECK ---
    // If the token is missing, they accessed this file directly (cheating)
    if (!sessionStorage.getItem('portalToken')) {
        // Replace 'index.html' with the actual name of your main login page
        window.location.href = 'index.html'; 
    }

    // Disable Right Click on Exam Page too
    document.addEventListener('contextmenu', event => event.preventDefault());
    
    // Disable Selection
    document.addEventListener('selectstart', event => event.preventDefault());
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MCQ Exam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root, [data-theme="light"] {
            --bg-primary: #f9fafb; /* gray-50 */
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6; /* gray-100 */
            --bg-accent: #e5e7eb; /* gray-200 */
            --bg-accent-hover: #d1d5db; /* gray-300 */
            --bg-info: #eff6ff; /* blue-50 */
            --bg-info-border: #bfdbfe; /* blue-200 */
            --bg-success: #f0fdf4; /* green-50 */
            --bg-success-border: #bbf7d0; /* green-200 */
            --bg-danger: #fef2f2; /* red-50 */
            --bg-danger-border: #fecaca; /* red-200 */
            --bg-warning: #fffbeb; /* yellow-50 */
            --bg-warning-border: #fde68a; /* yellow-200 */
            --bg-code: #e5e7eb;
            --text-primary: #1f2937; /* gray-800 */
            --text-secondary: #4b5563; /* gray-600 */
            --text-tertiary: #6b7280; /* gray-500 */
            --text-accent: #3b82f6; /* blue-600 */
            --text-accent-hover: #2563eb; /* blue-700 */
            --text-inverted: #ffffff;
            --text-info: #1e40af; /* blue-800 */
            --text-success: #15803d; /* green-700 */
            --text-danger: #b91c1c; /* red-700 */
            --text-warning: #92400e; /* yellow-800 */
            --border-primary: #e5e7eb; /* gray-200 */
            --border-secondary: #d1d5db; /* gray-300 */
            --border-accent: #3b82f6;
            --shadow-color: rgba(0,0,0,0.1);
            --swipe-duration: 0.3s; /* Default Smooth */
            --font-explanation: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }

        [data-theme="dark"] {
            --bg-primary: #111827; /* gray-900 */
            --bg-secondary: #1f2937; /* gray-800 */
            --bg-tertiary: #374151; /* gray-700 */
            --bg-accent: #4b5563; /* gray-600 */
            --bg-accent-hover: #525c6a;
            --bg-info: #1e293b; 
            --bg-info-border: #334155;
            --bg-success: #064e3b; /* green-900 */
            --bg-success-border: #065f46;
            --bg-danger: #7f1d1d; /* red-900 */
            --bg-danger-border: #991b1b;
            --bg-warning: #451a03;
            --bg-warning-border: #78350f;
            --bg-code: #374151;
            --text-primary: #f3f4f6; /* near-white, AAA */
            --text-secondary: #d1d5db; /* gray-300, AAA */
            --text-tertiary: #9ca3af; /* gray-400 */
            --text-accent: #60a5fa; /* blue-400 */
            --text-accent-hover: #93c5fd; /* blue-300 */
            --text-inverted: #1f2937;
            --text-info: #bfdbfe;
            --text-success: #86efac; /* green-300 */
            --text-danger: #fca5a5; /* red-300 */
            --text-warning: #fcd34d;
            --border-primary: #374151; /* gray-700 */
            --border-secondary: #4b5563; /* gray-600 */
            --border-accent: #60a5fa;
            --shadow-color: rgba(0,0,0,0.4);
            --font-explanation: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }

        [data-theme="ambient"] {
            --bg-primary: #fdf6e3; /* cream */
            --bg-secondary: #f6efd8;
            --bg-tertiary: #eee8d5;
            --bg-accent: #dcd4c1;
            --bg-accent-hover: #c9c1ae;
            --bg-info: #e0f2f1; 
            --bg-info-border: #b2dfdb;
            --bg-success: #e8f5e9;
            --bg-success-border: #c8e6c9;
            --bg-danger: #ffebee;
            --bg-danger-border: #ffcdd2;
            --bg-warning: #fff3e0;
            --bg-warning-border: #ffe0b2;
            --bg-code: #eee8d5;
            --text-primary: #433e3f; /* dark brown */
            --text-secondary: #586e75;
            --text-tertiary: #657b83;
            --text-accent: #cb4b16; /* warm orange */
            --text-accent-hover: #d35400;
            --text-inverted: #fdf6e3;
            --text-info: #00695c;
            --text-success: #2e7d32;
            --text-danger: #c62828;
            --text-warning: #e65100;
            --border-primary: #dcd4c1;
            --border-secondary: #c9c1ae;
            --border-accent: #cb4b16;
            --shadow-color: rgba(67, 62, 63, 0.1);
            --font-explanation: 'Georgia', 'Cambria', 'Times New Roman', serif;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            /* Disable Selection and Touch Callouts */
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10 and IE 11 */
            user-select: none; /* Standard syntax */
            -webkit-touch-callout: none; /* iOS Safari */
        }
        
        /* Re-enable selection for inputs */
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        /* View Transitions for Theme Switch */
        ::view-transition-old(root),
        ::view-transition-new(root) {
            animation: none;
            mix-blend-mode: normal;
        }
        ::view-transition-old(root) { z-index: 1; }
        ::view-transition-new(root) { z-index: 9999; }

        .screen { display: none; }
        .screen.active { display: flex; }
        .option-label { transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out; }
        .prose strong { font-weight: 700; color: var(--text-primary); }
        .prose em { color: var(--text-primary); font-style: italic; }
        .prose br { content: ""; display: block; margin-bottom: 0.5rem; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .prose p { margin-bottom: 1rem; }
        .calculator-btn { padding: 1rem 0; font-size: 1.25rem; border-radius: 0.5rem; transition: background-color 0.2s, transform 0.1s, filter 0.1s; text-align: center; }
        .key-press-feedback { transform: scale(0.95); filter: brightness(0.85); }
        .calculator-modal.dragging { opacity: 0.7; border: 2px dashed var(--border-accent); }
        
        /* Custom Radio Button for Exam Mode */
        .radio-circle::after {
            content: '';
            display: block;
            width: 1rem; /* 16px */
            height: 1rem; /* 16px */
            border-radius: 50%;
            background-color: var(--border-accent);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.2s ease-in-out;
        }
        .option-label.selected .radio-circle::after {
            transform: translate(-50%, -50%) scale(1);
        }
        
        /* Themed Components */
        .themed-bg-primary { background-color: var(--bg-primary); }
        .themed-bg-secondary { background-color: var(--bg-secondary); }
        .themed-bg-tertiary { background-color: var(--bg-tertiary); }
        .themed-bg-accent { background-color: var(--bg-accent); }
        .themed-bg-accent-hover:hover { background-color: var(--bg-accent-hover); }

        .themed-text-primary { color: var(--text-primary); }
        .themed-text-secondary { color: var(--text-secondary); }
        .themed-text-tertiary { color: var(--text-tertiary); }
        .themed-text-accent { color: var(--text-accent); }
        .themed-text-inverted { color: var(--text-inverted); }
        .themed-text-success { color: var(--text-success); }
        .themed-text-danger { color: var(--text-danger); }
        .themed-text-warning { color: var(--text-warning); }

        .themed-border-primary { border-color: var(--border-primary); }
        .themed-border-secondary { border-color: var(--border-secondary); }
        .themed-border-accent { border-color: var(--border-accent); }
        
        .themed-shadow { box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -2px var(--shadow-color); }
        
        /* Component specific overrides */
        #setup-screen .bg-white, #results-screen .bg-white, #review-screen .bg-white, #practice-screen .bg-white, #practice-results-screen .bg-white, #past-results-screen .bg-white, #progress-screen .bg-white, .modal-card, #calculator-modal {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        header { background-color: var(--bg-secondary); }
        main, footer { background-color: var(--bg-tertiary); }
        footer { box-shadow: 0 -2px 5px var(--shadow-color); }
        input, textarea { background-color: var(--bg-secondary); border-color: var(--border-secondary); color: var(--text-primary); }
        input:focus, textarea:focus { --tw-ring-color: var(--text-accent); border-color: var(--text-accent); }
        #timer, #practice-timer { background-color: var(--bg-accent); }
        .option-label { background-color: var(--bg-tertiary); position: relative; overflow: hidden; }
        .option-label.selected { background-color: var(--bg-info); border-color: var(--border-accent); }
        .option-label:hover { background-color: var(--bg-accent); }
        #question-palette { background-color: var(--bg-secondary); }
        #hide-palette-btn, #show-palette-btn { background-color: var(--bg-secondary); color: var(--text-secondary); border-color: var(--border-primary); }
        
        /* Improved Explanation Typography and Styles */
        .explanation-card {
            background-color: var(--bg-secondary);
            border-top: 4px solid var(--text-accent);
            border-radius: 0.75rem;
            margin-top: 2rem;
            animation: fade-in-up 0.4s ease-out;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            position: relative; /* For toolbar anchor */
        }
        .explanation-header {
            padding: 1rem 1.5rem;
            font-weight: 700;
            color: var(--text-accent);
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-primary);
            font-size: 1.1rem;
        }
        .explanation-content {
            padding: 1.5rem 2rem;
            color: var(--text-primary);
            font-size: 1.05rem;
            line-height: 1.8;
            font-family: var(--font-explanation);
            user-select: text; /* Allow selection in explanation */
        }

        /* Feedback Header Badge */
        .feedback-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 0.875rem;
            margin-left: 1rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease-out;
        }
        .feedback-badge.visible { opacity: 1; transform: translateY(0); }
        .feedback-badge.correct { background-color: var(--bg-success); color: var(--text-success); border: 1px solid var(--bg-success-border); }
        .feedback-badge.incorrect { background-color: var(--bg-danger); color: var(--text-danger); border: 1px solid var(--bg-danger-border); }

        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Streak Badge */
        .streak-badge {
            display: flex;
            align-items: center;
            background: rgba(245, 158, 11, 0.1); /* amber-500 with opacity */
            color: #d97706; /* amber-600 */
            padding: 0.25rem 0.75rem;
            border-radius: 99px;
            font-weight: 700;
            font-size: 0.85rem;
            border: 1px solid rgba(245, 158, 11, 0.3);
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .streak-badge.active {
            transform: scale(1.1);
            background: rgba(245, 158, 11, 0.25);
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.2);
        }
        
        /* Swipe Animations */
        @keyframes slide-out-left { to { transform: translateX(-100%); opacity: 0; } }
        @keyframes slide-in-from-right { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slide-out-right { to { transform: translateX(100%); opacity: 0; } }
        @keyframes slide-in-from-left { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .slide-out-left { animation: slide-out-left var(--swipe-duration) ease-out forwards; }
        .slide-in-from-right { animation: slide-in-from-right var(--swipe-duration) ease-out forwards; }
        .slide-out-right { animation: slide-out-right var(--swipe-duration) ease-out forwards; }
        .slide-in-from-left { animation: slide-in-from-left var(--swipe-duration) ease-out forwards; }
        
        /* Toast Notification */
        @keyframes fade-in-out {
            0% { transform: translateY(100%); opacity: 0; }
            10% { transform: translateY(0); opacity: 1; }
            90% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(100%); opacity: 0; }
        }
        #toast-notification {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            background-color: #333;
            color: white;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            z-index: 100;
            visibility: hidden;
            opacity: 0;
        }
        #toast-notification.show {
            visibility: visible;
            bottom: 2rem;
            animation: fade-in-out 3s ease-in-out forwards;
        }

        /* Save Button Animation */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.25); }
            100% { transform: scale(1); }
        }
        .pop-animation {
            animation: pop 0.3s ease-out;
        }
        
        /* CHART CSS */
        .chart-wrapper {
            display: flex;
            align-items: flex-end;
            justify-content: flex-start;
            gap: 16px;
            height: 300px;
            width: 100%;
            overflow-x: auto;
            padding: 20px 10px 40px 10px;
            border-bottom: 2px solid var(--border-primary);
            border-left: 2px solid var(--border-primary);
            background: linear-gradient(to bottom, var(--bg-primary), var(--bg-secondary));
            border-radius: 12px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.02);
        }
        .chart-bar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            justify-content: flex-end;
            flex-shrink: 0;
            width: 50px;
            position: relative;
            transition: transform 0.2s;
        }
        .chart-bar-container:hover {
            transform: translateY(-5px);
            z-index: 10;
        }
        
        @keyframes grow-up {
            from { height: 0; opacity: 0; }
            to { opacity: 1; }
        }
        
        .chart-bar {
            width: 100%;
            border-radius: 6px 6px 0 0;
            position: relative;
            min-height: 24px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 5px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: grow-up 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            opacity: 0; /* Start invisible for animation */
        }
        
        /* Interference/Gradient Effects */
        .bar-success {
            background: linear-gradient(180deg, #4ade80 0%, #16a34a 100%);
            border: 1px solid #15803d;
        }
        .bar-danger {
            background: linear-gradient(180deg, #f87171 0%, #dc2626 100%);
            border: 1px solid #b91c1c;
        }
        
        /* Text inside bar */
        .chart-bar-text {
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            white-space: nowrap;
            margin-bottom: 5px;
        }
        
        .chart-bar-label {
            font-size: 11px;
            margin-top: 10px;
            color: var(--text-secondary);
            transform: rotate(-45deg);
            white-space: nowrap;
            text-align: right;
            width: 100%;
            transform-origin: top center;
            text-overflow: ellipsis;
            overflow: hidden;
        }
        .chart-bar-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: rgba(17, 24, 39, 0.95);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 20;
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }
        .chart-bar-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: rgba(17, 24, 39, 0.95) transparent transparent transparent;
        }
        .chart-bar-container:hover .chart-bar-tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(-12px);
        }
        
        /* STAT CARDS */
        .stat-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-value { font-size: 1.5rem; font-weight: 800; color: var(--text-primary); }
        .stat-label { font-size: 0.75rem; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; }

        /* DYNAMIC ISLAND */
        #dynamic-island {
            position: fixed;
            z-index: 9999;
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(16px);
            border-radius: 20px;
            padding: 6px;
            gap: 8px;
            display: flex;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            transition: width 0.5s, height 0.5s, top 0.5s, left 0.5s, right 0.5s, bottom 0.5s, border-radius 0.5s, opacity 0.4s ease;
            cursor: grab;
            border: 1px solid rgba(255,255,255,0.15);
        }
        #dynamic-island:active { cursor: grabbing; }
        
        #dynamic-island.dragging { transition: none !important; }
        
        @keyframes hint-move {
            0% { transform: translateY(0); }
            25% { transform: translateY(5px); }
            50% { transform: translateY(-5px); }
            75% { transform: translateY(5px); }
            100% { transform: translateY(0); }
        }
        .hint-anim { animation: hint-move 0.6s ease-in-out; box-shadow: 0 0 25px rgba(255,255,255,0.5) !important; }
        
        #dynamic-island.idle { opacity: 0.3; }
        #dynamic-island.idle:hover { opacity: 1; }
        
        #dynamic-island.horizontal { flex-direction: row; height: auto; align-items: center; }
        #dynamic-island.vertical { flex-direction: column; width: auto; align-items: center; }

        .island-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: background 0.2s, transform 0.2s;
            cursor: pointer;
        }
        .island-btn:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
        .island-btn:active { transform: scale(0.95); }
        .island-btn svg { width: 18px; height: 18px; }
        
        .island-mini-btn {
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            padding: 0;
            padding-bottom: 2px;
        }
        .island-mini-btn:hover { background: rgba(255, 255, 255, 0.2); color: white; }

        .island-separator { background: rgba(255,255,255,0.2); border-radius: 99px; }
        #dynamic-island.horizontal .island-separator { width: 1px; height: 20px; }
        #dynamic-island.vertical .island-separator { width: 20px; height: 1px; }

        #dynamic-island.minimized {
            padding: 0;
            gap: 0;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            cursor: pointer;
            justify-content: center;
            opacity: 1 !important; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        [data-theme="light"] #dynamic-island.minimized,
        [data-theme="ambient"] #dynamic-island.minimized {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        #dynamic-island.minimized > * { display: none !important; }

        #dynamic-island.minimized.horizontal { width: 40px; height: 6px; border-radius: 10px; }
        #dynamic-island.minimized.vertical { width: 6px; height: 40px; border-radius: 10px; }

    </style>
    <script>
        // Immediately apply theme from localStorage to prevent FOUC
        (function() {
            try {
                const examId = 'exam_1765463581122_z81nzlx';
                const THEME_KEY = 'examTheme_' + examId;
                const savedTheme = localStorage.getItem(THEME_KEY);
                if (savedTheme) {
                    document.documentElement.dataset.theme = savedTheme;
                }
            } catch (e) {
                console.error('Could not apply saved theme.', e);
            }
        })();
    </script>
</head>
<body class="">
    
    <!-- DYNAMIC ISLAND: Left Side Center Default -->
    <div id="dynamic-island" class="vertical" style="top: 50%; left: 20px; transform: translateY(-50%);">
        <button id="island-minimize-btn" class="island-mini-btn" aria-label="Minimize Island" title="Minimize">&minus;</button>
        
        <div class="island-separator"></div>
        <button id="island-home-btn" class="island-btn" aria-label="Go Home">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
        </button>

        <div class="island-separator"></div>
        <button id="island-progress-btn" class="island-btn" aria-label="View Progress">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
        </button>
        <div class="island-separator"></div>
        <button id="island-theme-btn" class="island-btn" aria-label="Toggle Theme">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
            </svg>
        </button>
        <div class="island-separator"></div>
        <button id="island-settings-btn" class="island-btn" aria-label="Swipe Settings">
             <svg id="swipe-icon-smooth" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
            <svg id="swipe-icon-hard" class="hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
        </button>
    </div>

    <div id="toast-notification"></div>
    <main id="app-container" class="h-screen w-screen relative">
        <!-- SCREEN 1: SECTION SETUP -->
        <div id="setup-screen" class="screen active flex-col justify-center items-center p-4">
            <div id="resume-banner" class="hidden w-full max-w-5xl bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg shadow-lg mb-6" role="alert">
                <div class="flex">
                    <div class="py-1"><svg class="fill-current h-6 w-6 text-yellow-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-5.414V8a1 1 0 112 0v4.586a1 1 0 11-2 0zM10 6a1 1 0 100-2 1 1 0 000 2z"/></svg></div>
                    <div>
                        <p class="font-bold">Saved Exam Session Found!</p>
                        <p class="text-sm">You have a saved exam in progress. What would you like to do?</p>
                        <div class="mt-3">
                            <button id="resume-session-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded" aria-label="Resume previous session">Resume Session</button>
                            <button id="discard-draft-btn" class="ml-4 text-sm text-yellow-800 hover:underline" aria-label="Discard draft and start new">Discard and Start New</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="w-full max-w-5xl bg-white p-8 rounded-lg shadow-lg themed-bg-secondary themed-shadow">
                <p class="text-xs text-center mb-4 themed-text-tertiary">Read instructions before start</p>
                <h1 class="text-3xl font-bold mb-2 text-center themed-text-accent">Medicine</h1>
                <h2 class="text-xl font-semibold mb-6 text-center themed-text-secondary">Exam Setup</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- Left Panel: Exam Configuration -->
                    <div class="md:col-span-2 space-y-6">
                        <div>
                            <p class="mb-4 themed-text-secondary">Total Questions Found: 65. Configure your exam sections below.</p>
                            
                            <div class="space-y-4 mb-6">
                                <div>
                                    <label for="subject-name" class="block text-sm font-medium themed-text-secondary">Subject Name</label>
                                    <input type="text" id="subject-name" value="Medicine" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="candidate-name" class="block text-sm font-medium themed-text-secondary">Candidate Name</label>
                                    <input type="text" id="candidate-name" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="short-note" class="block text-sm font-medium themed-text-secondary">Short Note (Optional)</label>
                                    <textarea id="short-note" rows="2" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Any notes for this test..."></textarea>
                                </div>
                            </div>

                            <div class="flex items-center mb-6">
                                <input type="checkbox" id="shuffle-mcqs-checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="shuffle-mcqs-checkbox" class="ml-2 block text-sm font-medium themed-text-secondary">Shuffle Questions</label>
                            </div>

                            <hr class="my-6 themed-border-primary">
                            
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold themed-text-primary">Exam Sections</h2>
                                <button id="auto-set-sections-btn" class="px-3 py-1 rounded-full text-xs font-semibold border border-blue-500 text-blue-500 hover:bg-blue-50 transition-colors" title="Split into 50-question sections (1 min/q)">Auto Set</button>
                            </div>
                            <div id="sections-container" class="space-y-4 max-h-48 overflow-y-auto pr-2">
                                <!-- Sections will be injected here by JS -->
                            </div>

                            <div class="mt-4 flex justify-between items-center">
                                <button id="add-section-btn" class="py-2 px-4 rounded themed-bg-accent themed-bg-accent-hover" aria-label="Add a new section">Add Section</button>
                            </div>
                        </div>

                        <div class="mt-6 text-center">
                            <button id="start-exam-btn" class="py-3 px-8 rounded-lg font-bold text-lg w-full md:w-auto" style="background-color: var(--text-accent); color: var(--text-inverted);" aria-label="Start the exam">Start Exam</button>
                            <p id="setup-error" class="mt-4 themed-text-danger text-center h-5"></p>
                        </div>
                    </div>

                    <!-- Right Panel: Alternative Modes -->
                    <div class="md:col-span-1 p-6 rounded-lg border themed-bg-primary themed-border-primary">
                        <h2 class="text-xl font-semibold mb-6 text-center themed-text-primary">Alternative Modes</h2>
                        <div class="space-y-4">
                            <div class="p-4 rounded-lg border" style="background-color: var(--bg-warning); border-color: var(--bg-warning-border);">
                                <h3 class="font-semibold text-lg text-center mb-3 themed-text-warning">Practice Mode</h3>
                                <div class="space-y-4 text-sm">
                                     <div>
                                        <label for="practice-q-count-slider" class="block font-medium themed-text-secondary">Number of Questions: <span id="practice-q-count-label">65</span></label>
                                        <input type="range" id="practice-q-count-slider" min="1" max="65" value="65" class="mt-1 block w-full cursor-pointer">
                                    </div>
                                    <div>
                                        <label for="practice-time-overall" class="block font-medium themed-text-secondary">Overall Time Limit (minutes)</label>
                                        <input type="number" id="practice-time-overall" class="mt-1 block w-full p-2 border rounded-md shadow-sm" placeholder="Optional: e.g., 60">
                                    </div>
                                    <div>
                                        <label for="practice-time-per-mcq" class="block font-medium themed-text-secondary">Time per MCQ (seconds)</label>
                                        <input type="number" id="practice-time-per-mcq" class="mt-1 block w-full p-2 border rounded-md shadow-sm" placeholder="Optional: e.g., 30">
                                    </div>
                                </div>
                                <button id="start-practice-btn" class="mt-4 py-3 px-6 rounded-lg font-bold w-full" style="background-color: var(--text-warning); color: var(--bg-primary);" aria-label="Start Practice Mode">Start Practice</button>
                                <p class="text-xs mt-2 text-center themed-text-tertiary">Get instant feedback with streaks & gamification.</p>
                            </div>
                            <div class="text-center">
                                <button id="revise-btn" class="py-3 px-6 rounded-lg font-bold w-full" style="background-color: #8b5cf6; color: white;" aria-label="Start Revise Mode">Revise Test</button>
                                <p class="text-xs mt-2 themed-text-tertiary">Freely browse all questions, answers, and explanations.</p>
                            </div>
                             <div id="saved-questions-container" class="text-center hidden">
                                 <button id="view-saved-btn" class="py-3 px-6 rounded-lg font-bold w-full relative" style="background-color: #4f46e5; color: white;" aria-label="View Saved Questions">
                                     Saved Questions
                                     <span id="saved-questions-count" class="absolute top-0 right-0 -mt-2 -mr-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                                 </button>
                                 <p class="text-xs mt-2 themed-text-tertiary">Review questions you've bookmarked.</p>
                            </div>
                            <div id="past-results-container" class="text-center hidden">
                                <button id="view-past-results-btn" class="py-3 px-6 rounded-lg font-bold w-full relative" style="background-color: #0d9488; color: white;" aria-label="View Past Results">
                                    View Past Results
                                    <span id="past-results-count" class="absolute top-0 right-0 -mt-2 -mr-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                                 </button>
                                 <p class="text-xs mt-2 themed-text-tertiary">Review your past exam performances.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCREEN 2: EXAM -->
        <div id="exam-screen" class="screen h-full relative">
            <!-- Main Content -->
            <div class="flex-1 flex flex-col">
                <header class="p-3 shadow-md flex justify-between items-center themed-bg-secondary themed-shadow">
                    <div class="flex items-center space-x-4">
                        <div>
                            <h1 id="section-name" class="text-xl font-bold themed-text-accent"></h1>
                            <p id="question-counter" class="text-sm themed-text-tertiary"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-xs font-bold themed-text-tertiary">created by mano</span>
                        <button id="calculator-toggle-btn" class="p-2 rounded-full themed-bg-accent-hover" aria-label="Toggle Calculator">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 themed-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                           </svg>
                        </button>
                        <div id="timer" class="text-xl font-mono px-4 py-1 rounded themed-bg-accent themed-text-primary" aria-label="Timer"></div>
                    </div>
                </header>

                <main class="flex-1 p-6 overflow-y-auto themed-bg-tertiary">
                    <div class="p-6 rounded-lg themed-bg-secondary">
                        <p id="question-text" class="text-lg font-semibold mb-6 whitespace-pre-wrap"></p>
                        <div id="question-image-container" class="my-4 flex justify-center"></div>
                        <div id="options-container" class="space-y-4"></div>
                    </div>
                </main>
                
                <footer class="p-4 themed-bg-secondary" style="box-shadow: 0 -2px 5px var(--shadow-color);">
                    <div class="flex justify-between items-center">
                        <div>
                            <button id="mark-review-btn" class="py-2 px-4 rounded text-white bg-purple-600 hover:bg-purple-700" aria-label="Mark for Review and Next">Mark for Review & Next</button>
                            <button id="clear-response-btn" class="py-2 px-4 rounded ml-4 themed-bg-accent themed-bg-accent-hover" aria-label="Clear Selected Response">Clear Response</button>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button id="prev-btn" class="py-2 px-6 rounded disabled:opacity-50 themed-bg-accent themed-bg-accent-hover" aria-label="Previous Question">Previous</button>
                            <button id="save-next-btn" class="py-2 px-6 rounded font-bold" style="background-color: #16a34a; color: white;" aria-label="Save Answer and Next Question">Save & Next</button>
                        </div>
                    </div>
                </footer>
            </div>

            <!-- Side Palette -->
            <aside id="question-palette" class="w-64 flex-shrink-0 relative transition-all duration-300 ease-in-out themed-bg-secondary">
                <div id="palette-content-wrapper" class="p-4 flex flex-col h-full w-full overflow-hidden transition-opacity duration-300">
                    <h2 class="text-lg font-bold mb-4 text-center">Question Palette</h2>
                    <div id="palette-container" class="grid grid-cols-5 gap-2 flex-1 overflow-y-auto"></div>
                     <div class="mt-4 text-xs space-y-2 themed-text-secondary">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center"><div class="w-4 h-4 rounded bg-green-600 mr-2"></div> Answered</div>
                            <span id="answered-count" class="font-bold px-1.5 py-0.5 rounded-full text-[10px] themed-bg-accent themed-text-primary">0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center"><div class="w-4 h-4 rounded bg-red-600 mr-2"></div> Not Answered</div>
                            <span id="not-answered-count" class="font-bold px-1.5 py-0.5 rounded-full text-[10px] themed-bg-accent themed-text-primary">0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center"><div class="w-4 h-4 rounded bg-gray-500 mr-2"></div> Not Visited</div>
                            <span id="not-visited-count" class="font-bold px-1.5 py-0.5 rounded-full text-[10px] themed-bg-accent themed-text-primary">0</span>
                        </div>
                         <div class="flex items-center justify-between">
                            <div class="flex items-center"><div class="w-4 h-4 rounded bg-purple-600 mr-2 relative"><svg xmlns="http://www.w3.org/2000/svg" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 h-2.5 w-2.5 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z" /></svg></div> Marked for Review</div>
                            <span id="marked-for-review-count" class="font-bold px-1.5 py-0.5 rounded-full text-[10px] themed-bg-accent themed-text-primary">0</span>
                        </div>
                    </div>
                </div>
                <button id="hide-palette-btn" class="absolute top-1/2 -left-3 z-10 p-1 rounded-full shadow-md border -translate-y-1/2" aria-label="Hide Question Palette">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                </button>
            </aside>

            <!-- Show Palette Button -->
            <button id="show-palette-btn" class="hidden absolute top-1/2 right-4 z-10 p-2 rounded-full shadow-lg border -translate-y-1/2" aria-label="Show Question Palette">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
            </button>
        </div>

        <!-- SCREEN 3: RESULTS -->
        <div id="results-screen" class="screen flex-col items-center justify-center p-8">
            <div class="w-full max-w-4xl p-8 rounded-lg shadow-lg themed-bg-secondary themed-shadow">
                <h1 class="text-4xl font-bold mb-4 text-center themed-text-accent">Exam Results</h1>
                <div id="exam-details" class="text-sm themed-text-secondary mb-6 border-b pb-4 space-y-1 themed-border-primary"></div>
                <div id="overall-performance" class="p-6 rounded-lg mb-8 text-center themed-bg-primary"></div>
                <h2 class="text-2xl font-semibold mb-4 text-center">Section-wise Analysis</h2>
                <div id="section-analysis" class="space-y-4"></div>
                <div class="mt-8 flex justify-center gap-4">
                    <button id="review-answers-btn" class="py-3 px-8 text-white rounded font-bold" style="background-color: var(--text-accent);" aria-label="Review Answers">Review Answers</button>
                    <button id="download-report-btn" class="py-3 px-8 text-white rounded font-bold" style="background-color: var(--text-success); color: var(--text-inverted);" aria-label="Download Report">Download Report</button>
                    <button id="restart-btn" class="py-3 px-8 rounded font-bold themed-bg-accent themed-text-primary" aria-label="Start New Exam">New Exam</button>
                </div>
            </div>
        </div>
        
        <!-- SCREEN 4: REVIEW -->
        <div id="review-screen" class="screen h-full flex-col">
          <header class="p-3 shadow-md flex justify-between items-center w-full themed-bg-secondary">
              <h1 id="review-title" class="text-xl font-bold themed-text-accent">Review Mode</h1>
               <div class="flex items-center space-x-4">
                    <button id="save-mcq-btn" class="p-2 rounded-full themed-bg-accent-hover" aria-label="Save Question">
                        <!-- SVG will be injected here -->
                    </button>
                    <button id="exit-revise-btn" class="py-2 px-4 rounded themed-bg-accent themed-bg-accent-hover hidden" aria-label="Exit Revise Mode">Exit Revise</button>
                    <button id="back-to-results-btn" class="py-2 px-4 rounded themed-bg-accent themed-bg-accent-hover" aria-label="Back to Results">Back to Results</button>
                </div>
          </header>
          <div id="review-palette-container" class="w-full max-w-4xl mx-auto p-4 border-b overflow-x-auto themed-bg-primary themed-border-primary">
             <div id="review-palette-grid" class="flex flex-nowrap gap-3 justify-start">
                 <!-- Review palette buttons will be injected here -->
             </div>
          </div>
          <main class="flex-1 p-6 overflow-y-auto w-full max-w-4xl mx-auto">
              <div class="p-6 rounded-lg themed-bg-secondary">
                  <div class="flex justify-between items-center">
                    <p id="review-question-text" class="text-lg font-semibold mb-6 whitespace-pre-wrap flex-1"></p>
                    <div id="review-time-taken" class="text-sm flex items-center ml-4 flex-shrink-0 themed-text-secondary"></div>
                  </div>
                  <div id="review-question-image-container" class="my-4 flex justify-center"></div>
                  <div id="review-options-container" class="space-y-4"></div>
                  
                  <!-- EXPLANATION SECTION -->
                  <div class="explanation-card" id="review-explanation-card">
                       <div class="explanation-header">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Explanation
                       </div>

                      <div id="explanation-image-container" class="my-4 flex justify-center"></div>
                      <div id="explanation-container" class="explanation-content prose max-w-none">
                          <!-- Explanation text will go here -->
                      </div>
                  </div>
              </div>
          </main>
          <footer class="p-4 shadow-inner flex justify-between items-center w-full themed-bg-secondary" style="box-shadow: 0 -2px 5px var(--shadow-color);">
              <button id="review-prev-btn" class="py-2 px-6 rounded disabled:opacity-50 themed-bg-accent themed-bg-accent-hover" aria-label="Previous Question">Previous</button>
              <span id="review-question-counter" class="font-bold"></span>
              <button id="review-next-btn" class="py-2 px-6 rounded disabled:opacity-50 themed-bg-accent themed-bg-accent-hover" aria-label="Next Question">Next</button>
          </footer>
        </div>
        
        <!-- SCREEN 5: PRACTICE MODE -->
        <div id="practice-screen" class="screen h-full flex-col relative">
            <header class="p-3 shadow-md flex justify-between items-center w-full themed-bg-secondary">
                <div class="flex items-center space-x-4">
                    <div>
                        <h1 class="text-xl font-bold themed-text-warning">Practice Mode</h1>
                        <p id="practice-subject-name" class="text-sm themed-text-tertiary"></p>
                    </div>
                </div>
                
                <!-- STREAK COUNTER & FEEDBACK -->
                <div id="practice-streak-container" class="flex-1 flex justify-center items-center">
                    <div id="streak-badge" class="streak-badge hidden">
                        <span class="mr-1">ðŸ”¥</span> Streak: <span id="streak-count" class="ml-1">0</span>
                    </div>
                    <!-- Header Feedback Badge -->
                    <div id="header-feedback-badge" class="feedback-badge">
                         <span id="header-feedback-text"></span>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <button id="save-mcq-practice-btn" class="p-2 rounded-full themed-bg-accent-hover" aria-label="Save Question">
                        <!-- SVG will be injected here -->
                    </button>
                    <button id="toggle-sparkles-btn" class="p-2 rounded-full themed-bg-accent-hover" aria-label="Toggle Sparkles">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                       </svg>
                    </button>
                    <button id="practice-calculator-toggle-btn" class="p-2 rounded-full themed-bg-accent-hover" aria-label="Toggle Calculator">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 themed-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                       </svg>
                    </button>
                    <div id="practice-timer" class="text-xl font-mono px-4 py-1 rounded hidden themed-bg-accent themed-text-primary" aria-label="Practice Timer"></div>
                    <button id="exit-practice-btn" class="py-2 px-4 rounded themed-bg-accent themed-bg-accent-hover" aria-label="Exit Practice Mode">Exit Practice</button>
                </div>
            </header>
            
            <div id="practice-palette-container" class="w-full max-w-4xl mx-auto p-4 border-b overflow-x-auto themed-bg-primary themed-border-primary">
                 <div id="practice-palette-grid" class="flex flex-nowrap gap-3 justify-start">
                     <!-- Practice palette buttons injected by JS -->
                 </div>
            </div>

            <div id="per-question-timer-container" class="w-full h-2 themed-bg-accent hidden">
                <div id="per-question-timer-bar" class="h-full bg-green-500" style="transition: width 150ms linear;"></div>
            </div>
            <main class="flex-1 p-6 overflow-y-auto w-full max-w-4xl mx-auto">
                <div class="p-6 rounded-lg themed-bg-secondary">
                    <p id="practice-question-text" class="text-lg font-semibold mb-6 whitespace-pre-wrap"></p>
                    <div id="practice-question-image-container" class="my-4 flex justify-center"></div>
                    <div id="practice-options-container" class="space-y-4"></div>
                    
                    <!-- EXPLANATION SECTION -->
                    <div id="practice-explanation-section" class="hidden explanation-card">
                        <div class="explanation-header">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Explanation
                        </div>
                        
                        <div id="practice-explanation-image-container" class="my-4 flex justify-center"></div>
                        <div id="practice-explanation-container" class="explanation-content prose max-w-none">
                            <!-- Explanation text will go here -->
                        </div>
                    </div>
                </div>
            </main>
            <footer class="p-4 shadow-inner flex justify-between items-center w-full themed-bg-secondary" style="box-shadow: 0 -2px 5px var(--shadow-color);">
                <button id="practice-prev-btn" class="py-2 px-6 rounded disabled:opacity-50 themed-bg-accent themed-bg-accent-hover" aria-label="Previous Question">Previous</button>
                <span id="practice-question-counter" class="font-bold"></span>
                <button id="practice-next-btn" class="py-2 px-6 rounded disabled:opacity-50 themed-bg-accent themed-bg-accent-hover" aria-label="Next Question">Next</button>
            </footer>
        </div>

        <!-- SCREEN 6: PRACTICE RESULTS -->
        <div id="practice-results-screen" class="screen flex-col items-center justify-center p-8">
            <div class="w-full max-w-2xl p-8 rounded-lg shadow-lg text-center themed-bg-secondary themed-shadow">
                <h1 class="text-4xl font-bold mb-4 themed-text-warning">Practice Results</h1>
                <div id="practice-exam-details" class="text-sm themed-text-secondary mb-6 border-b pb-4 space-y-1 themed-border-primary"></div>
                
                <div class="p-6 rounded-lg mb-8 themed-bg-primary">
                    <h2 class="text-2xl font-semibold">Your Performance</h2>
                    <p id="practice-score" class="text-5xl font-bold my-4"></p>
                    <div class="flex justify-center space-x-8 text-lg">
                        <span id="practice-correct"></span>
                        <span id="practice-incorrect"></span>
                        <span id="practice-attempted"></span>
                    </div>
                     <div id="practice-avg-time" class="mt-4 themed-text-secondary"></div>
                </div>
                
                <div class="mt-8 flex justify-center gap-4">
                    <button id="review-practice-answers-btn" class="py-3 px-8 rounded font-bold" style="background-color: var(--text-accent); color: var(--text-inverted);" aria-label="Review Practice Answers">Review Answers</button>
                    <button id="restart-practice-btn" class="py-3 px-8 rounded font-bold" style="background-color: var(--text-warning); color: var(--bg-primary);" aria-label="Restart Practice">Restart Practice</button>
                    <button id="back-to-setup-btn" class="py-3 px-8 rounded font-bold themed-bg-accent themed-text-primary" aria-label="Back to Setup">Back to Setup</button>
                </div>
            </div>
        </div>

        <!-- SCREEN 7: PAST RESULTS HISTORY -->
        <div id="past-results-screen" class="screen flex-col items-center justify-center p-8">
            <div class="w-full max-w-3xl p-8 rounded-lg shadow-lg themed-bg-secondary themed-shadow">
                <h1 class="text-3xl font-bold mb-6 text-center themed-text-accent">Past Exam Results</h1>
                <div id="past-results-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                    <!-- Past results will be injected here -->
                </div>
                <div class="mt-8 flex justify-center">
                    <button id="back-to-setup-from-history-btn" class="py-3 px-8 rounded font-bold themed-bg-accent themed-text-primary" aria-label="Back to Setup">Back to Setup</button>
                </div>
            </div>
        </div>

        <!-- SCREEN 8: PROGRESS ANALYTICS (CHARTS) -->
        <div id="progress-screen" class="screen flex-col items-center justify-center p-8">
            <div class="w-full max-w-5xl p-8 rounded-lg shadow-lg themed-bg-secondary themed-shadow overflow-y-auto max-h-full">
                <h1 class="text-3xl font-bold mb-6 text-center themed-text-accent">Performance Analytics</h1>
                
                <!-- KPI Dashboard (Inserted) -->
                <div id="kpi-dashboard" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <!-- Cards injected by JS -->
                </div>

                <!-- Exam Progress -->
                <div class="mb-8">
                    <h2 class="text-xl font-bold mb-4 themed-text-primary flex items-center">
                        <svg class="w-5 h-5 mr-2 themed-text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        Exam History
                    </h2>
                    <div id="exam-chart-container" class="chart-wrapper">
                        <!-- Exam bars injected here -->
                    </div>
                    <p id="exam-chart-empty" class="text-sm themed-text-tertiary mt-2 text-center hidden">No exam attempts recorded yet.</p>
                </div>

                <!-- Practice Progress -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold themed-text-warning flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            Practice History
                        </h2>
                        <button id="reset-practice-history-btn" class="text-xs py-1 px-3 rounded border border-red-300 text-red-500 hover:bg-red-50">Reset Practice History</button>
                    </div>
                    <div id="practice-chart-container" class="chart-wrapper">
                        <!-- Practice bars injected here -->
                    </div>
                    <p id="practice-chart-empty" class="text-sm themed-text-tertiary mt-2 text-center hidden">No practice sessions recorded yet.</p>
                </div>

                <div class="flex justify-center">
                    <button id="back-to-setup-from-progress-btn" class="py-3 px-8 rounded font-bold themed-bg-accent themed-text-primary" aria-label="Back to Setup">Back to Setup</button>
                </div>
            </div>
        </div>


        <!-- MODAL: CONFIRMATION -->
        <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
            <div class="p-8 rounded-lg shadow-xl max-w-sm w-full text-center modal-card">
                <h2 class="text-xl font-bold mb-4">Confirm Action</h2>
                <p id="confirmation-message" class="mb-6 themed-text-secondary"></p>
                <div class="flex justify-center gap-4">
                    <button id="cancel-confirmation-btn" class="py-2 px-6 rounded font-semibold themed-bg-accent themed-bg-accent-hover" aria-label="Cancel Action">Cancel</button>
                    <button id="confirm-action-btn" class="py-2 px-6 rounded font-semibold text-white" style="background-color: var(--text-danger); color: var(--text-inverted);" aria-label="Confirm Action">Proceed</button>
                </div>
            </div>
        </div>

        <!-- MODAL: REPORT OPTIONS -->
        <div id="report-options-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
            <div class="p-8 rounded-lg shadow-xl max-w-sm w-full text-center modal-card">
                <h2 class="text-xl font-bold mb-4">Download Report</h2>
                <p class="mb-6 themed-text-secondary">Would you like to include the explanations in your PDF report?</p>
                <div class="flex flex-col gap-4">
                    <button id="download-with-explanations-btn" class="py-2 px-6 rounded font-semibold" style="background-color: var(--text-success); color: var(--text-inverted);" aria-label="Download with explanations">With Explanations</button>
                    <button id="download-without-explanations-btn" class="py-2 px-6 rounded font-semibold" style="background-color: var(--text-accent); color: var(--text-inverted);" aria-label="Download without explanations">Without Explanations</button>
                    <button id="cancel-report-download-btn" class="py-2 px-6 rounded font-semibold mt-2 themed-bg-accent themed-bg-accent-hover" aria-label="Cancel Download">Cancel</button>
                </div>
            </div>
        </div>

        <!-- MODAL: PRACTICE RESUME -->
        <div id="practice-resume-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
            <div class="p-8 rounded-lg shadow-xl max-w-sm w-full text-center modal-card">
                <h2 class="text-xl font-bold mb-4">Resume Practice</h2>
                <p class="mb-6 themed-text-secondary">You have a saved practice session. Would you like to continue where you left off?</p>
                <div class="flex justify-center gap-4">
                    <button id="practice-start-new-btn" class="py-2 px-6 rounded font-semibold themed-bg-accent themed-bg-accent-hover" aria-label="Start new practice">Start New</button>
                    <button id="practice-resume-btn" class="py-2 px-6 rounded font-semibold text-white bg-yellow-500 hover:bg-yellow-600" aria-label="Resume practice">Resume</button>
                </div>
            </div>
        </div>
        
        <!-- CALCULATOR MODAL -->
        <div id="calculator-modal" class="calculator-modal absolute w-64 rounded-lg shadow-2xl z-50 hidden">
            <div id="calculator-header" class="p-2 flex justify-between items-center rounded-t-lg cursor-move themed-bg-accent">
                <span class="font-bold themed-text-secondary">Calculator</span>
                <button id="calculator-close-btn" class="text-xl themed-text-secondary hover:themed-text-primary" aria-label="Close Calculator">&times;</button>
            </div>
            <div class="p-4">
                <div id="calculator-display" class="text-right text-3xl font-mono p-2 rounded mb-4 overflow-x-auto themed-bg-tertiary" aria-label="Calculator Display">0</div>
                <div id="calculator-buttons" class="grid grid-cols-4 gap-2">
                    <button class="calculator-btn col-span-2" style="background-color: var(--text-danger); color: var(--text-inverted);" aria-label="Clear Calculation">C</button>
                    <button class="calculator-btn operator themed-bg-accent themed-bg-accent-hover">/</button>
                    <button class="calculator-btn operator themed-bg-accent themed-bg-accent-hover">*</button>

                    <button class="calculator-btn digit themed-bg-tertiary">7</button>
                    <button class="calculator-btn digit themed-bg-tertiary">8</button>
                    <button class="calculator-btn digit themed-bg-tertiary">9</button>
                    <button class="calculator-btn operator themed-bg-accent themed-bg-accent-hover">-</button>

                    <button class="calculator-btn digit themed-bg-tertiary">4</button>
                    <button class="calculator-btn digit themed-bg-tertiary">5</button>
                    <button class="calculator-btn digit themed-bg-tertiary">6</button>
                    <button class="calculator-btn operator themed-bg-accent themed-bg-accent-hover">+</button>

                    <button class="calculator-btn digit themed-bg-tertiary">1</button>
                    <button class="calculator-btn digit themed-bg-tertiary">2</button>
                    <button class="calculator-btn digit themed-bg-tertiary">3</button>
                    <button class="calculator-btn equals row-span-2" style="background-color: var(--text-accent); color: var(--text-inverted);" aria-label="Calculate Result">=</button>
                    
                    <button class="calculator-btn col-span-2 digit themed-bg-tertiary">0</button>
                    <button class="calculator-btn decimal themed-bg-tertiary">.</button>
                </div>
            </div>
        </div>
    </main>

<script>
    // --- APP INITIALIZATION ---
    // Prevent right-click to protect content
    document.addEventListener('contextmenu', (e) => e.preventDefault());

    // Prevent inspection via keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
        if (e.key === 'F12' || 
            (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) || 
            (e.ctrlKey && e.key === 'U')) {
            e.preventDefault();
        }
    });

    window.addEventListener('DOMContentLoaded', () => {
      try {
        // --- DATA & STATE ---
        // FIX: Using renamed variable from outer scope.
        const examId = 'exam_1765463581122_z81nzlx';
        const mcqs = [{"id":1,"question":"A 27-year-old woman presents with photosensitive rash, oral ulcers, and migratory arthritis. Labs: ANA positive (1:320), anti-dsDNA positive, low C3/C4. Urinalysis: 2+ proteinuria. What is the MOST likely renal involvement?","options":{"a":"Minimal change disease","b":"Membranous nephropathy","c":"Diffuse proliferative GN","d":"Focal segmental glomerulosclerosis"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nSystemic lupus erythematosus (SLE) with photosensitive rash, oral ulcers, arthritis, positive ANA, anti-dsDNA, and low C3/C4 presenting with proteinuria indicates lupus nephritis. The most common class in active SLE is Class IV (diffuse proliferative glomerulonephritis), characterized by >50% of glomeruli involved with endocapillary or extracapillary proliferation. This class has highest risk of progression to renal failure and requires aggressive immunosuppression.\n\n**2. Rationale for Incorrect Options**\n\n- a) Minimal change disease: Rarely seen in SLE; primary cause in children; presents with nephrotic syndrome; no anti-dsDNA.\n- b) Membranous nephropathy: Can occur in SLE (Class V) but typically without RBC casts or active proliferation.\n- d) FSGS: Not typical of lupus nephritis; more common in HIV, obesity, heroin abuse.\n\n**3. Exam Essentials**\n\n- Lupus nephritis classes: I (normal), II (mesangial), III (focal proliferative), IV (diffuse), V (membranous), VI (advanced sclerosis).\n- Class IV features: Most common symptomatic; highest creatinine elevation; RBC casts; worst prognosis.\n- Treatment: High-dose corticosteroids + cyclophosphamide (NCCN) or mycophenolate mofetil.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Lupus Nephritis Severity\":\n- Class I: Normal (no LN)\n- Class II: Mesangial (mild)\n- Class III: Focal proliferative (moderate)\n- Class IV: Diffuse proliferative (severe)\n- Class V: Membranous (nephrotic)\n- Class VI: Sclerotic (ESRD)"},{"id":2,"question":"A 43-year-old woman has symmetric small-joint pain, morning stiffness >1 hour, and positive antiCCP. X-ray: periarticular osteopenia & marginal erosions. What is the BEST early treatment strategy?","options":{"a":"NSAIDs only","b":"Start Methotrexate","c":"Hydroxychloroquine monotherapy","d":"Oral steroids long-term"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn rheumatoid arthritis with symmetric small-joint pain, morning stiffness >1 hour, positive anti-CCP, periarticular osteopenia, and erosions, the best early treatment is methotrexate. Current DMARD-first strategy (tight control) uses methotrexate as anchor therapy with early introduction to prevent joint damage. NSAIDs provide symptom relief but do not prevent progression; hydroxychloroquine is too weak for DMARD monotherapy; steroids alone lead to dependence without remission.\n\n**2. Rationale for Incorrect Options**\n\n- a) NSAIDs only: Symptomatic but do not prevent joint damage or achieve remission; inadequate monotherapy.\n- c) Hydroxychloroquine monotherapy: Weak DMARD; used in combination but not sufficient as monotherapy for active RA.\n- d) Oral steroids long-term: Leads to steroid dependence; increased infection/fracture risk; not DMARDs.\n\n**3. Exam Essentials**\n\n- DMARD-first strategy: Methotrexate (anchor), biologics (TNF-i, IL-6, costimulation), targeted synthetic (JAKi).\n- Goal: Low disease activity or remission within 3-6 months; escalate if inadequate response.\n- Methotrexate: PABA antagonist; slows progression; add folic acid to reduce toxicity.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":3,"question":"A 52-year-old female presents with tightening of skin on hands/face, Raynaud phenomenon, and difficulty swallowing. Antibody: anti-centromere +. What is the most likely complication?","options":{"a":"Esophagitis","b":"Renal crisis","c":"Pulmonary arterial hypertension","d":"Myocarditis"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nLimited cutaneous systemic sclerosis (lcSSc) with anti-centromere antibodies (positivity >80% in lcSSc) has excellent prognosis regarding skin involvement but carries high risk of pulmonary arterial hypertension (PAH). PAH develops in 8-14% of lcSSc patients and is a major cause of mortality. Other features: Raynaud phenomenon, esophageal dysmotility (but renal crisis rare in lcSSc), and slower progression than diffuse disease.\n\n**2. Rationale for Incorrect Options**\n\n- a) Esophagitis: Esophageal dysmotility common in SSc causing GERD; but PAH is the dreaded complication.\n- b) Renal crisis: Occurs in diffuse cutaneous SSc (dcSSc), not lcSSc; rare in anti-centromere patients.\n- d) Myocarditis: Can occur but less common than PAH as specific complication of lcSSc.\n\n**3. Exam Essentials**\n\n- Limited vs diffuse SSc: Limited (skin distal to elbows/knees) vs diffuse (proximal involvement); anti-centromere vs anti-Scl70.\n- PAH screening: Annual echocardiography + 6-minute walk test in lcSSc; earliest sign is elevated TR velocity.\n- Treatment: Bosentan, ambrisentan, sildenafil for SSc-PAH; improve outcomes compared to untreated.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Limited SSc (CREST Syndrome)\":\n- C â€“ Calcinosis\n- R â€“ Raynaud phenomenon\n- E â€“ Esophageal dysmotility\n- S â€“ Sclerodactyly\n- T â€“ Telangiectasia\n- Plus: PAH (complication)"},{"id":4,"question":"A 26-year-old woman presents with fever, weight loss, oral ulcers, pleuritic chest pain, and hair loss. She has intermittent photosensitive rash. Labs: Hb 8.9 g/dL, platelets 85,000, WBC 2,800. Urinalysis: RBC casts, proteinuria 1.8 g/day. ANA 1:640 (homogeneous), anti-dsDNA high, C3/C4 low. ECG normal. What is the MOST likely classification of her kidney disease?","options":{"a":"Class II mesangial","b":"Class III focal","c":"Class IV diffuse","d":"Class V membranous"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nThis patient with active SLE (fever, weight loss, cytopenias, RBC casts, proteinuria, elevated transaminases) and very high ANA (1:640, homogeneous), high anti-dsDNA, very low C3/C4 has severe proliferative lupus nephritis, Class IV (diffuse proliferative GN). The RBC casts and 1.8 g/day proteinuria indicate active proliferative disease affecting >50% of glomeruli, which is Class IV, the most severe and common symptomatic class.\n\n**2. Rationale for Incorrect Options**\n\n- a) Class II mesangial: Minimal proliferation; no RBC casts; much milder.\n- b) Class III focal: \u003c50% glomeruli; milder than diffuse; less hematuria.\n- d) Class V membranous: Pure nephrotic pattern; less hematuria than this patient.\n\n**3. Exam Essentials**\n\n- Class IV features: >50% glomeruli, RBC casts, significant proteinuria, elevated creatinine, low C3/C4.\n- Poor prognostic factors: Male sex, higher creatinine, severe proliferation, crescents, C3/C4 deposition.\n- Treatment: High-dose methylprednisolone + cyclophosphamide or mycophenolate mofetil.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":5,"question":"A 58-year-old man presents with intense pain and swelling in his right ankle for 1 day. He drank alcohol heavily last night. Exam shows a warm, erythematous ankle with exquisite tenderness. Synovial fluid shows WBC 25,000/ÂµL and needle-shaped, negatively birefringent crystals. He has CKD stage 4 (eGFR 22). What is the best treatment for this acute attack?","options":{"a":"NSAIDs","b":"Colchicine","c":"Allopurinol","d":"Probenecid"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn acute gout with CKD stage 4 (eGFR 22), colchicine is the best treatment for acute attack in renal impairment. NSAIDs are relatively contraindicated in advanced CKD due to further renal injury and electrolyte abnormalities. Colchicine (low-dose 0.5 mg q6h) is safe and effective; allopurinol should NOT be started during acute attack (worsens inflammation); probenecid is ineffective in CKD due to impaired urinary excretion.\n\n**2. Rationale for Incorrect Options**\n\n- a) NSAIDs: Contraindicated in CKD; worsen renal function, fluid retention, hyperkalemia.\n- c) Allopurinol: Never start during acute attack; must wait 2 weeks post-attack resolution.\n- d) Probenecid: Uricosuric agent; ineffective in CKD due to impaired glomerular filtration.\n\n**3. Exam Essentials**\n\n- Gout management: Acute (colchicine, NSAIDs, corticosteroids); maintenance (allopurinol, febuxostat, uricase).\n- CKD special considerations: Avoid NSAIDs; colchicine dose reduction if GFR \u003c30; close monitoring.\n- Prophylaxis: Allopurinol 50-100 mg qd in CKD (lower doses); titrate slowly.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":6,"question":"A 45-year-old obese male with metabolic syndrome presents with recurrent attacks of severe pain in the great toe. He has had three episodes in the last year. Uric acid is 9.2 mg/dL. He takes thiazide diuretics for his hypertension. What is the best long-term management?","options":{"a":"Stop thiazide and start losartan","b":"Start NSAIDs for prophylaxis","c":"Start allopurinol now","d":"Give intra-articular steroids"},"correctAnswer":"a","explanation":"**1. High-Yield Topic Explanation**\n\nIn recurrent gout (3 episodes/year) with hyperuricemia (9.2 mg/dL) on thiazide diuretics, the best long-term strategy is stopping thiazide and starting losartan. Thiazides increase serum uric acid by decreasing urinary excretion (contraindicated in gout); losartan (ARB) is neutral/slightly uricosuric and maintains hypertension control. This addresses the gout trigger while maintaining BP managementâ€”a definitive solution better than NSAIDs prophylaxis or allopurinol alone without changing diuretic.\n\n**2. Rationale for Incorrect Options**\n\n- b) NSAIDs for prophylaxis: Can reduce attack frequency but does not address hyperuricemia; long-term NSAID use has GI/renal risks.\n- c) Allopurinol now: Yes, but should still change thiazide to losartan; incomplete management.\n- d) Intra-articular steroids: Temporary relief only; does not address recurrent attacks or uric acid elevation.\n\n**3. Exam Essentials**\n\n- Gout triggers: Thiazides, loop diuretics (â†‘ UA), alcohol, purine-rich diet, dehydration, ASA.\n- Uric acid-neutral/lowering agents: Losartan, ACE-I, calcium channel blockers.\n- Allopurinol indication: SUA >9 mg/dL or â‰¥2 attacks/year; target SUA \u003c6 mg/dL.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":7,"question":"A 67-year-old man presents with chronic joint pain in the midfoot and knee. Exam shows bony irregularities and decreased range of motion. X-ray shows â€œpunched-outâ€ erosions with overhanging edges. He has firm, yellowish nodules over his elbows. What is the diagnosis?","options":{"a":"Pseudogout","b":"Chronic tophaceous gout","c":"Rheumatoid arthritis","d":"Septic arthritis"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nChronic tophaceous gout presents with chronic joint pain, bony irregularities, \"punched-out\" erosions with overhanging edges (pathognomonic), and firm, yellowish nodules (tophi) over joints/earlobes. Tophi are deposits of monosodium urate crystals with surrounding inflammatory infiltrate, indicating chronic, poorly controlled gout. The \"rat-bite\" erosion appearance (overhanging cortex) is classic for gout, distinguishing it from RA where erosions lack overhanging edges.\n\n**2. Rationale for Incorrect Options**\n\n- a) Pseudogout: Calcium pyrophosphate deposition; acute attacks but no tophi; erosions less characteristic.\n- c) RA: Symmetrical joint involvement; erosions lack overhanging edges; no tophi; positive RF/anti-CCP.\n- d) Septic arthritis: Acute presentation with fever; not chronic with bony deformity and tophi.\n\n**3. Exam Essentials**\n\n- Tophus composition: Monosodium urate crystals + fibrin + inflammatory cells; needle-shaped negatively birefringent crystals on synovial fluid.\n- Complications: Joint destruction, chronic kidney disease (urate nephropathy), hearing loss (rare).\n- Treatment: Allopurinol + NSAIDs; tophi may partially resolve with aggressive uric acid lowering.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":8,"question":"A 38-year-old woman presents with 3 months of swelling in the wrists, MCP, and PIP joints. She reports morning stiffness lasting 2 hours. Exam shows symmetrical tenderness and synovitis. Labs: ESR 65 mm/hr, CRP elevated, RF positive, anti-CCP strongly positive. X-ray shows periarticular osteopenia. What is the most appropriate initial therapy?","options":{"a":"Prednisolone for 6 months","b":"Methotrexate","c":"Hydroxychloroquine monotherapy","d":"Etanercept"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn newly diagnosed, active RA (symmetrical polyarticular inflammation, 2+ hours morning stiffness, elevated inflammatory markers, RF+, anti-CCP+, radiographic damage), methotrexate is the most appropriate initial therapy as the anchor DMARD in current treat-to-target strategies. Methotrexate provides rapid onset of action (8-12 weeks), good efficacy, and cost-effectiveness. Early DMARD initiation within 3 months of disease onset improves long-term outcomes and prevents irreversible joint damage.\n\n**2. Rationale for Incorrect Options**\n\n- a) Prednisolone 6 months: Bridges inflammation but does not provide DMARD effect; dose escalation and dependence risk.\n- c) Hydroxychloroquine monotherapy: Weak DMARD; inadequate as sole agent in active RA with radiographic erosions.\n- d) Etanercept (TNF-i): Excellent but typically added to methotrexate, not as initial monotherapy (increased infection risk, cost).\n\n**3. Exam Essentials**\n\n- Treat-to-target approach: Tight control with DMARDs; target remission/low disease activity within 3-6 months; escalate if inadequate.\n- DMARD hierarchy: Methotrexate (first-line) â†’ add biologics (TNF-i, IL-6) or synthetic DMARDs if inadequate.\n- Monitoring: CBC, LFTs monthly initially (methotrexate toxicity); DAS28 or CDAI for disease activity.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":9,"question":"A 42-year-old woman with pruritus, jaundice and fatigue has elevated ALP, GGT, and positive AMA antibody. Liver biopsy shows destruction of intrahepatic bile ducts. Diagnosis?","options":{"a":"Primary sclerosing cholangitis","b":"Primary biliary cholangitis","c":"Autoimmune hepatitis","d":"Drug-induced cholestasis"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nPrimary biliary cholangitis (PBC) presents with pruritus, jaundice, elevated ALP/GGT (alkaline phosphatase >AST/ALT), positive anti-mitochondrial (AMA) antibodies, and liver biopsy showing bile duct destruction. PBC is an autoimmune cholestatic disease affecting intrahepatic bile ducts (intra rather than extrahepatic), causing progressive cirrhosis. More common in middle-aged women; AMA+ in ~95% of PBC patients.\n\n**2. Rationale for Incorrect Options**\n\n- a) PSC: Large/extra-hepatic bile duct inflammation; usually in males with IBD; different serology (p-ANCA); strictures on MRCP.\n- c) Autoimmune hepatitis: Elevated ALT/AST > ALP; different serology (ANA, anti-smooth muscle).\n- d) Drug-induced: Temporal relationship to medication; reverses with drug discontinuation.\n\n**3. Exam Essentials**\n\n- PBC serology: AMA+ (anti-M2 specific); anti-mitochondrial M2 is most specific antibody.\n- Bile acid sequestrants + UDCA: First-line; reduce pruritus and cholestasis; slow fibrosis progression.\n- Complications: Portal hypertension, esophageal varices, osteoporosis, hepatocellular carcinoma (in cirrhotic stage).\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":10,"question":"A 60-year-old diabetic male presents with weight loss, jaundice, pruritus. LFTs show ALP >> AST/ALT. Ultrasound: dilated bile ducts. Best next test?","options":{"a":"Anti-smooth muscle antibody","b":"MRCP","c":"Bone scan","d":"HIDA scan"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn obstructive jaundice (ALP >> ALT/AST, dilated bile ducts on ultrasound) without defined obstruction, MRCP (magnetic resonance cholangiopancreatography) is the best next investigation to visualize intra- and extrahepatic bile ducts non-invasively. MRCP has excellent sensitivity and specificity for choledocholithiasis, bile duct strictures, and masses, guiding further management (ERCP if intervention needed).\n\n**2. Rationale for Incorrect Options**\n\n- a) Anti-smooth muscle antibody: For autoimmune hepatitis; not relevant to obstructive pattern.\n- c) Bone scan: For bone metastases; irrelevant to bile duct obstruction assessment.\n- d) HIDA scan: Functional bile flow imaging; less specific for anatomic obstruction than MRCP.\n\n**3. Exam Essentials**\n\n- Obstructive vs cholestatic: Both show elevated ALP; obstruction has dilated ducts on imaging (US, CT, MRCP).\n- MRCP advantages: Non-invasive, no radiation exposure (vs ERCP which is therapeutic), excellent ductal visualization.\n- Subsequent management: ERCP if therapeutic intervention needed (sphincterotomy, stent placement).\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":11,"question":"A 45-year-old man has jaundice, Coombs-negative hemolytic anemia, Kayser-Fleischer rings, low ceruloplasmin. Diagnosis?","options":{"a":"Hemochromatosis","b":"Wilson disease","c":"Autoimmune hepatitis","d":"Alcoholic hepatitis"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nWilson disease (copper metabolism disorder) presents with jaundice, Coombs-negative hemolytic anemia (copper-induced hemolysis), Kayser-Fleischer rings (golden-brown corneal deposits from copper), and low ceruloplasmin (copper transport protein). This tetrad is pathognomonic for Wilson disease, an autosomal recessive ATP7B gene mutation causing toxic copper accumulation in liver, brain, and cornea.\n\n**2. Rationale for Incorrect Options**\n\n- a) Hemochromatosis: Iron metabolism disorder; presents with bronze skin, arthropathy, DM; no Kayser-Fleischer rings.\n- c) Autoimmune hepatitis: No hemolysis, Kayser-Fleischer rings, or low ceruloplasmin.\n- d) Alcoholic hepatitis: History of heavy alcohol use; no Kayser-Fleischer rings or ceruloplasmin changes.\n\n**3. Exam Essentials**\n\n- Wilson diagnosis: Low ceruloplasmin + high 24-hour urine copper + Kayser-Fleischer rings + elevated serum copper.\n- Treatment: Penicillamine (copper chelator) or trientine; zinc supplementation; copper-restricted diet.\n- Complications: Hepatic encephalopathy, neurological disease (parkinsonism, ataxia), Coombs-negative hemolytic anemia.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Wilson Disease Features\":\n- W â€“ Wilson disease (copper disorder)\n- I â€“ Iron-normal (unlike hemochromatosis)\n- L â€“ Low ceruloplasmin, Liver cirrhosis\n- S â€“ Slit-lamp (Kayser-Fleischer rings)\n- O â€“ Orally absorbed (copper from food)\n- N â€“ Neurological symptoms, Neuritic Wilson disease"},{"id":12,"question":"A 50-year-old has diabetes, skin hyperpigmentation, arthropathy, high ferritin, TSAT 75%. Which finding is most characteristic?","options":{"a":"Low TIBC","b":"Elevated transferrin","c":"High urine copper","d":"Anti-mitochondrial antibodies"},"correctAnswer":"a","explanation":"**1. High-Yield Topic Explanation**\n\nHereditary hemochromatosis (HFE-related) with diabetes, hyperpigmentation, arthropathy, elevated ferritin, and TSAT 75% has low TIBC (total iron-binding capacity) as the characteristic finding. In iron overload, transferrin saturation increases while total iron-binding capacity decreases because transferrin is already saturated with iron and cannot bind additional iron. Low TIBC (normal 250-400 Âµg/dL) with high TSAT (normal \u003c45%) is diagnostic.\n\n**2. Rationale for Incorrect Options**\n\n- b) Elevated transferrin: False; transferrin is utilized (low TIBC); elevation occurs in iron deficiency.\n- c) High urine copper: Characteristic of Wilson disease (copper metabolism), not iron overload.\n- d) Anti-mitochondrial antibodies: Seen in primary biliary cholangitis; not hemochromatosis.\n\n**3. Exam Essentials**\n\n- Hemochromatosis markers: High ferritin + high TSAT (>45%) + low TIBC; confirms iron overload.\n- HFE mutations: C282Y homozygous most common (>85% of patients); H63D compound heterozygotes rarer.\n- Complications: Cirrhosis, HCC, cardiac arrhythmias, hypogonadism, arthropathy (2nd/3rd MCP joints).\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Iron Overload Parameters\":\n- Ferritin: â†‘ (iron storage)\n- TSAT: â†‘ (transferrin saturated)\n- TIBC: â†“ (cannot bind more iron)\n- Serum iron: â†‘"},{"id":13,"question":"A 27-year-old man presents with fatigue, nausea, right upper quadrant discomfort, and dark urine for 5 days. He recently had unprotected sexual contact. Labs show: ALT 950 U/L, AST 720 U/L, total bilirubin 3.1 mg/dL. Hepatitis B serology: HBsAg: Positive; Anti-HBc IgM: Positive; HBeAg: Positive; Anti-HBs: Negative. What is the most likely diagnosis?","options":{"a":"Acute Hepatitis B infection","b":"Chronic active Hepatitis B","c":"Window period of Hepatitis B","d":"Immunity due to vaccination"},"correctAnswer":"a","explanation":"**1. High-Yield Topic Explanation**\n\nAcute Hepatitis B infection presents with HBsAg+, Anti-HBc IgM+, HBeAg+, Anti-HBsâˆ’, elevated ALT/AST, and bilirubin. The Anti-HBc IgM is pathognomonic for acute HBV; combined with HBsAg+ and negative Anti-HBs, this confirms acute infection in window period or early acute phase. High transaminases (ALT/AST >1000) are typical of acute HBV.\n\n**2. Rationale for Incorrect Options**\n\n- b) Chronic HBV: HBsAg+ for >6 months; Anti-HBc IgG+ (not IgM); different natural history.\n- c) Window period: Anti-HBc IgM+ with HBsAgâˆ’ and Anti-HBsâˆ’; HBsAg is positive here.\n- d) Vaccination immunity: Only Anti-HBs+; HBsAg and Anti-HBc always negative.\n\n**3. Exam Essentials**\n\n- Acute HBV phases: Incubation (no symptoms, HBsAgâˆ’) â†’ prodrome (HBsAg+, Anti-HBc IgM+) â†’ icterus (peak ALT, jaundice) â†’ recovery (Anti-HBs+).\n- Anti-HBc IgM timeline: Appears with HBsAg, peaks early, disappears within 6 months.\n- Prognosis: 90-95% of adults recover; \u003c5% progress to chronic; fulminant hepatitis rare (\u003c1%).\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Acute HBV Serology Pattern\":\n- HBsAg: âœ“ (surface antigen present)\n- Anti-HBc IgM: âœ“ (acute infection marker)\n- HBeAg: âœ“ (high replication)\n- Anti-HBs: âœ— (recovery marker; develops later)"},{"id":14,"question":"A 45-year-old man with no symptoms undergoes a routine medical check. He is a migrant worker from an HBV-endemic region. Serology: HBsAg: Positive for >6 months; Anti-HBc IgG: Positive; HBeAg: Positive; HBV DNA: High; Anti-HBs: Negative; LFTs: ALT mildly elevated. What is the correct interpretation?","options":{"a":"Past infection with immunity","b":"Vaccination-induced immunity","c":"Chronic Hepatitis B with high viral replication","d":"Acute resolving Hepatitis B"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nHBsAg+ for >6 months (chronic), Anti-HBc IgG+ (past/ongoing), HBeAg+ (replication), HBV DNA high, ALT mildly elevated is the definition of chronic Hepatitis B with high viral replication. Chronic HBV is defined by persistence of HBsAg â‰¥6 months. High replication (HBeAg+, HBV DNA high) with elevated ALT indicates active liver disease requiring monitoring and consideration of treatment (NRTi, TDF, etc.).\n\n**2. Rationale for Incorrect Options**\n\n- a) Past infection with immunity: Would have Anti-HBs+ (antibody), HBsAgâˆ’; this patient HBsAg+.\n- b) Vaccination immunity: Only Anti-HBs+; HBsAg/Anti-HBc always negative.\n- d) Acute resolving: Acute HBV; HBsAg resolves within 6 months in most; this is >6 months.\n\n**3. Exam Essentials**\n\n- Chronic HBV phases: Immune tolerant (high HBV DNA, normal ALT), active (HBV DNA high, ALT elevated), inactive carrier.\n- Treatment indication: HBeAg+ with ALT >2Ã— ULN + HBV DNA >10âµ copies/mL; or HBeAgâˆ’ with ALT elevated + HBV DNA >10â´.\n- Monitoring: Annual HBsAg/HBV DNA, ultrasound for HCC surveillance if cirrhosis.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":15,"question":"A 33-year-old woman presents with malaise and mild jaundice. She reports flu-like symptoms 3 weeks earlier. Hepatitis B serology: HBsAg: Negative; Anti-HBs: Negative; Anti-HBc IgM: Positive; HBeAg: Negative. What is the most likely explanation for this pattern?","options":{"a":"Past resolved infection","b":"Vaccinated, no infection","c":"Window period of acute HBV","d":"Chronic inactive carrier state"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nThe window period in Hepatitis B occurs after HBsAg disappears but before Anti-HBs develops, presenting with HBsAgâˆ’, Anti-HBc IgM+, Anti-HBsâˆ’. This transient period lasts days to weeks in recovering acute HBV patients. The Anti-HBc IgM positivity indicates recent acute infection despite negative HBsAg, and the absence of Anti-HBs confirms immunity not yet developed.\n\n**2. Rationale for Incorrect Options**\n\n- a) Past resolved infection: Anti-HBs+ and HBsAgâˆ’; Anti-HBc IgMâˆ’ (chronic anti-HBc IgG instead).\n- b) Vaccinated, no infection: Anti-HBs+ only; Anti-HBc always negative (no prior infection).\n- d) Chronic inactive: HBsAg+ for >6 months; Anti-HBc IgM not present (becomes IgG chronically).\n\n**3. Exam Essentials**\n\n- Window period timeline: Short-lived (usually \u003c30 days) in acute HBV; HBsAg disappears, Anti-HBs delayed.\n- Anti-HBc IgM significance: Markers recent acute infection; present in window period distinguishing from chronic disease.\n- Clinical relevance: Important for blood banking/donation screening; can transmit virus despite negative HBsAg.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Hepatitis B Serological Patterns\":\n- Acute: HBsAg+, Anti-HBc IgM+, Anti-HBsâˆ’\n- Window: HBsAgâˆ’, Anti-HBc IgM+, Anti-HBsâˆ’\n- Recovered: HBsAgâˆ’, Anti-HBc IgG+, Anti-HBs+\n- Chronic: HBsAg+, Anti-HBc IgG+, Anti-HBsâˆ’\n- Vaccinated: Anti-HBs+ only"},{"id":16,"question":"All are true about Hepatitis C infection EXCEPT:","options":{"a":"Most patients remain asymptomatic in the acute phase","b":"Chronic infection is more common than in Hepatitis B","c":"HCV RNA is the earliest detectable marker of infection","d":"Presence of anti-HCV antibodies confirms active infection"},"correctAnswer":"d","explanation":"**1. High-Yield Topic Explanation**\n\n\"Presence of anti-HCV antibodies confirms active infection\" is FALSE. Anti-HCV antibodies can persist even after viral clearance (post-treatment or spontaneous clearance). Only HCV RNA positivity (by RT-PCR) confirms active, replicating infection. This distinction is critical because many patients with anti-HCV antibodies have cleared the virus or are cured post-treatment.\n\n**2. Rationale for Incorrect Options**\n\n- a) Asymptomatic acute phase: True; most patients (~75%) have no symptoms; alanine aminotransferase mildly elevated.\n- b) Chronic >acute: True; 15-25% spontaneous clearance; 75-85% develop chronic infection.\n- c) HCV RNA earliest marker: True; appears within 1-2 weeks; before antibodies (4-10 weeks); most specific for active disease.\n\n**3. Exam Essentials**\n\n- HCV diagnosis: HCV RNA (RT-PCR) gold-standard for active infection; anti-HCV less specific (can be false +/past cleared).\n- Chronic HCV: 80% risk cirrhosis over 20 years; HCC risk in cirrhotic patients.\n- Treatment: Direct-acting antivirals (DAAs) cure >95% of HCV; IFN/ribavirin era ended.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":17,"question":"All are true about chronic Hepatitis C EXCEPT:","options":{"a":"It increases the risk of hepatocellular carcinoma","b":"It may present with extrahepatic manifestations like cryoglobulinemia","c":"Direct-acting antivirals cure >90% of cases","d":"Liver biopsy is mandatory for diagnosis"},"correctAnswer":"d","explanation":"**1. High-Yield Topic Explanation**\n\n\"Liver biopsy is mandatory for diagnosis\" is FALSE in modern HCV management. Liver biopsy is NO LONGER required for HCV diagnosis or to initiate treatment. HCV RNA positivity confirms active infection; transient elastography (FibroScan) or biomarkers assess fibrosis without invasive biopsy. This change reflects evidence that all patients with HCV should be treated regardless of fibrosis stage.\n\n**2. Rationale for Incorrect Options**\n\n- a) HCC risk increased: True; cirrhotic patients 1-5% annual HCC risk; even non-cirrhotic can develop HCC.\n- b) Extrahepatic manifestations: True; cryoglobulinemia (vasculitis, neuropathy), lymphoma, glomerulonephritis possible.\n- c) DAA cure >90%: True; cure rates 95-99% with modern DAAs; sustained virologic response (SVR).\n\n**3. Exam Essentials**\n\n- HCV diagnosis: Anti-HCV + HCV RNA by RT-PCR; no biopsy needed currently.\n- Fibrosis assessment: FibroScan (elastography), AST/ALT ratio, platelet count; biopsy if diagnosis uncertain.\n- Treatment: All patients with HCV should be treated; DAA duration 8-12 weeks; side effects minimal vs IFN era.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":18,"question":"All are true regarding Hepatitis C transmission EXCEPT:","options":{"a":"IV drug use is the most common route","b":"Sexual transmission is highly efficient and common","c":"Vertical transmission risk increases with high maternal viral load","d":"Needle-stick injury can transmit the virus"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\n\"Sexual transmission is highly efficient and common\" is FALSE for Hepatitis C. HCV transmission routes are blood-borne primarily (IV drug use, transfusion, needle-stick); sexual transmission is NOT highly efficient (unlike HBV). Vertical transmission from mother to child is possible but risk increases with high maternal viral load and is variable. Sexual transmission remains rare even with high viral loads.\n\n**2. Rationale for Incorrect Options**\n\n- a) IV drug use most common: True; needle/syringe sharing is #1 transmission route currently.\n- c) Vertical transmission with high viral load: True; risk increases with maternal HCV RNA levels.\n- d) Needle-stick transmission: True; occupational exposure risk ~3%.\n\n**3. Exam Essentials**\n\n- HCV transmission: Parenteral (IVDU, blood products, needle-stick), perinatal (maternal-fetal); NOT sexual (rare).\n- HBV vs HCV: HBV highly transmissible sexually; HCV rarely; explains different sexual transmission patterns.\n- Prevention: Harm reduction programs (needle exchange), universal precautions, no HCV vaccine.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"HCV vs HBV Transmission\":\n- HCV: Blood-borne primarily (IVDU, transfusion); minimal sexual\n- HBV: Blood, sexual, perinatal; highly transmissible sexually"},{"id":19,"question":"Complications of Fulminant Hepatitis: All are true EXCEPT","options":{"a":"Hepatic encephalopathy occurs due to accumulation of ammonia and neurotoxins","b":"Cerebral edema is a major cause of death in fulminant hepatitis","c":"Hypoglycemia occurs because of impaired gluconeogenesis","d":"Portal hypertension and esophageal varices typically develop early in the disease"},"correctAnswer":"d","explanation":"**1. High-Yield Topic Explanation**\n\n\"Portal hypertension and esophageal varices typically develop EARLY in fulminant hepatitis\" is FALSE. In fulminant hepatic failure, varices are a late manifestation if they develop at all; the disease progresses rapidly to death or recovery within days to weeks, before chronic portal hypertension develops. The primary killers are cerebral edema and hepatic encephalopathy, not variceal bleeding.\n\n**2. Rationale for Incorrect Options**\n\n- a) Hepatic encephalopathy from ammonia: True; ammonia accumulation from impaired ureagenesis; hyperammonemia causes encephalopathy.\n- b) Cerebral edema: True; major cause of death in fulminant hepatitis; raised ICP â†’ herniation.\n- c) Hypoglycemia from impaired gluconeogenesis: True; massive hepatocyte necrosis â†’ severe hypoglycemia; life-threatening.\n\n**3. Exam Essentials**\n\n- Fulminant hepatic failure: Encephalopathy \u003c2 weeks of jaundice (hyperacute \u003c7 days); mortality 50-85% without transplant.\n- Management: Supportive care, consider transplant evaluation early; lactulose + rifaxomicin for encephalopathy.\n- Cause: Viral (HBV, HAV, HEV), drug-induced (acetaminophen), autoimmune, pregnancy-related.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":20,"question":"A 17-year-old boy is brought by his parents due to progressive mood changes, irritability, and declining academic performance over the past year. His teachers report new-onset difficulty with concentration and episodes of inappropriate laughter. Over the past 3 months, he has also developed slurred speech, difficulty writing, and occasional tremors in both hands, especially when reaching for objects. He denies alcohol or drug use. There is no family history of neurologic disorders. On physical examination, he appears mildly jaundiced. His abdomen is soft but shows palpable hepatomegaly. Neurologic examination reveals dysarthria, a wing-beating tremor, and mild rigidity of the upper limbs. Routine labs show: AST: 118 U/L, ALT: 102 U/L, Bilirubin mildly elevated, INR slightly prolonged. Further testing reveals: Serum ceruloplasmin: significantly low; 24-hour urinary copper: markedly elevated. A slit-lamp eye examination demonstrates golden-brown rings encircling the cornea. Which diagnosis best explains this patientâ€™s presentation?","options":{"a":"Early-onset Huntington disease","b":"Wilson disease","c":"Autoimmune hepatitis","d":"Hereditary hemochromatosis"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nWilson disease in a 17-year-old with neuropsychiatric symptoms, wing-beating tremor (asterixis), dysarthria, jaundice, hepatomegaly, low ceruloplasmin, elevated urinary copper, and Kayser-Fleischer rings on slit lamp is diagnostic. This neuropsychiatric presentation (Wilsonian dementia) is the initial manifestation in ~50% of patients with Wilson disease. Copper deposition in brain (putamen, globus pallidus, thalamus) causes the characteristic movement disorder.\n\n**2. Rationale for Incorrect Options**\n\n- a) Huntington disease: Genetic CAG repeat; family history usual; no Kayser-Fleischer rings, low ceruloplasmin, or elevated copper.\n- c) Autoimmune hepatitis: Causes hepatitis but no movement disorder, Kayser-Fleischer rings, or ceruloplasmin changes.\n- d) Hemochromatosis: Iron metabolism; bronze skin, arthropathy, DM; no neurologic disease or Kayser-Fleischer rings.\n\n**3. Exam Essentials**\n\n- Wilson neurologic presentation: Tremor (wing-beating, dystonic), rigidity (parkinsonism), ataxia, dysarthria, personality change.\n- Psychiatric manifestations: Schizophrenia-like, depression, behavioral disturbance can precede motor signs.\n- Diagnosis: Low ceruloplasmin + high urinary copper (>100 Âµg/24hr) + Kayser-Fleischer rings; genetic testing (ATP7B) confirmatory.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Wilson Disease Presentation\":\n- Psychiatric/neurologic (younger, \u003c30 years): tremor, personality change, psychosis\n- Hepatic (older, >40 years): cirrhosis, hepatitis\n- Kayser-Fleischer rings: Always check slit lamp in neuropsych patients \u003c30 years"},{"id":21,"question":"A 52-year-old man presents with progressive fatigue, decreased libido, and intermittent pain in the second and third MCP joints of both hands. He reports that his â€œskin seems to be getting darker,â€ even though he has not been spending much time in the sun. Over the last year, he also developed poor glycemic control, requiring escalation of diabetes medications. He denies alcohol use and has no history of blood transfusions. On examination, his skin appears bronze-colored, and he has hepatomegaly without tenderness. Testicular size is slightly reduced. Laboratory results show: AST: 92 U/L, ALT: 88 U/L, Fasting glucose: elevated, Serum ferritin: markedly elevated, Transferrin saturation: very high (â‰ˆ 70%), HbA1c: elevated. Genetic testing reveals C282Y homozygosity in the HFE gene. Which diagnosis best fits this presentation?","options":{"a":"Wilson disease","b":"Alcoholic liver disease","c":"Hereditary hemochromatosis","d":"Primary biliary cholangitis"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nHereditary hemochromatosis with bronze-colored skin, arthropathy, gonadal dysfunction (reduced testicular size), poor glycemic control (secondary DM), markedly elevated ferritin, high TSAT, and C282Y homozygosity confirms genetic iron overload disorder. The C282Y mutation (most common, >85% HFE hemochromatosis) leads to iron absorption increase and recycling, causing multi-organ iron deposition.\n\n**2. Rationale for Incorrect Options**\n\n- a) Wilson disease: Copper disorder; no bronze skin, arthropathy pattern, or hyperferritinemia.\n- b) Alcoholic liver disease: Alcohol consumption required; no genetic mutation; no secondary DM or arthropathy pattern.\n- d) Primary biliary cholangitis: Cholestatic; female predominance; no iron overload markers; anti-mitochondrial antibodies.\n\n**3. Exam Essentials**\n\n- HFE hemochromatosis: C282Y homozygous (classic); H63D compound heterozygote (milder); autosomal recessive.\n- Screening: Ferritin + TSAT in males; TSAT more specific; iron saturation >45% abnormal.\n- Complications: Cirrhosis (30%), HCC (5-10% if cirrhotic), cardiomyopathy, arthropathy (2nd/3rd MCP), hypogonadism.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Hemochromatosis Features (HARMED)\":\n- H â€“ Heart (cardiomyopathy)\n- A â€“ Arthropathy (2nd/3rd MCP)\n- R â€“ Reproductive (hypogonadism, impotence)\n- M â€“ Melanin (bronze/gray skin)\n- E â€“ Endocrine (DM - secondary)\n- D â€“ Liver (Diabetes, Cirrhosis, Hepatoma)"},{"id":22,"question":"A 32-year-old woman presents with 3 months of fatigue, anorexia, and intermittent right upper quadrant discomfort. She reports joint pains and had an episode of jaundice last month. She has no history of alcohol use or medication toxicity. She has a past history of Hashimoto thyroiditis. Physical exam shows mild hepatomegaly. Labs: AST: 620 U/L, ALT: 710 U/L, Total bilirubin: 3.0 mg/dL, IgG levels: markedly elevated, Viral hepatitis panel: negative, ANA: positive, Antiâ€“smooth muscle antibody (SMA): strongly positive. Liver biopsy shows interface hepatitis with a plasma cell infiltrate. What is the most likely diagnosis?","options":{"a":"Alcoholic hepatitis","b":"Autoimmune hepatitis","c":"Wilson disease","d":"Drug-induced liver injury"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nAutoimmune hepatitis presents with markedly elevated transaminases (ALT >AST, both >600), hyperbilirubinemia, markedly elevated IgG, positive ANA and especially anti-smooth muscle (SMA) antibodies, negative viral markers, and liver biopsy showing interface hepatitis with plasma cell infiltration. This is autoimmune liver inflammation requiring immunosuppression (corticosteroids + azathioprine/mycophenolate).\n\n**2. Rationale for Incorrect Options**\n\n- a) Alcoholic hepatitis: Alcohol history required; AST > ALT pattern; normal/low immunoglobulins.\n- c) Wilson disease: Copper metabolism; low ceruloplasmin, elevated urinary copper; ANA/SMA negative.\n- d) Drug-induced: Temporal relationship to drug; pattern depends on drug; immunoglobulin pattern different.\n\n**3. Exam Essentials**\n\n- Autoimmune hepatitis types: Type I (ANA+/SMA+), Type II (anti-LKM+), Type III (anti-SLA+ rare).\n- Diagnostic criteria: Elevated transaminases (>5Ã— ULN), elevated immunoglobulins (>1.5Ã— ULN), autoantibodies, interface hepatitis on biopsy.\n- Treatment: Prednisolone + azathioprine; induces remission in 90%; goal: aminotransferases \u003cnormal.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":23,"question":"A 24-year-old man is evaluated for lifelong mild jaundice that worsens during fasting or illness. He has no abdominal pain, pruritus, or weight loss. Physical examination is unremarkable other than scleral icterus. Liver is smooth and normal in color Laboratory results: Total bilirubin: 3.8 mg/dL, Direct (conjugated) bilirubin: elevated, AST/ALT: normal, ALP: normal. Urine coproporphyrin analysis shows increased type I coproporphyrin. Ultrasound of the liver is normal. Which diagnosis best explains his presentation?","options":{"a":"Rotor syndrome","b":"Dubinâ€“Johnson syndrome","c":"Gilbert syndrome","d":"Autoimmune hepatitis"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nDubin-Johnson syndrome presents with lifelong mild jaundice (predominantly conjugated hyperbilirubinemia), elevated direct bilirubin despite normal ALT/AST/ALP, worsening with illness/fasting, and increased type I coproporphyrin in urine. It's an autosomal recessive defect in hepatic organic anion transporter (MRP2), causing impaired biliary excretion of conjugated bilirubin. Liver biopsy shows characteristic dark brown pigment (lipofuscin-like).\n\n**2. Rationale for Incorrect Options**\n\n- a) Rotor syndrome: Similar presentation but lacks dark liver pigment and has different coproporphyrin pattern (>80% type III).\n- c) Gilbert syndrome: Unconjugated hyperbilirubinemia (indirect); normal direct bilirubin.\n- d) Autoimmune hepatitis: Markedly elevated transaminases; not mild asymptomatic.\n\n**3. Exam Essentials**\n\n- Dubin-Johnson: Conjugated hyperbilirubinemia, dark liver on biopsy (lipofuscin), type I coproporphyrin elevated, benign prognosis.\n- Rotor: Similar but type III coproporphyrin elevated; no dark liver pigment; slightly higher bilirubin.\n- Prognosis: Benign; no treatment needed; reassurance primary management.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Dubin-Johnson Syndrome\":\n- D â€“ Direct (conjugated) hyperbilirubinemia\n- U â€“ Unconjugated normal (unlike Gilbert)\n- B â€“ Brown/dark liver (lipofuscin pigment)\n- I â€“ Impaired MRP2 transporter\n- N â€“ No hepatocellular damage"},{"id":24,"question":"A 63-year-old man with a 20-year history of chronic hepatitis B presents with unintentional weight loss, abdominal discomfort, and new onset abdominal swelling. Exam reveals shifting dullness and mild jaundice. Laboratory results: AST: 145 U/L, ALT: 110 U/L, ALP: mildly elevated, AFP (alpha-fetoprotein): markedly elevated. Abdominal ultrasound shows a heterogeneous mass in the right lobe of the liver with arterial enhancement and rapid venous washout on CT. What is the most likely diagnosis?","options":{"a":"Cholangiocarcinoma","b":"Hepatocellular carcinoma","c":"Liver metastasis","d":"Focal nodular hyperplasia"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nHepatocellular carcinoma (HCC) in a chronic HBV patient with weight loss, ascites, markedly elevated AFP, and heterogeneous mass with arterial enhancement and rapid washout on contrast CT is diagnostic. The \"hallmark\" radiological finding is arterial phase enhancement + washout on portal venous/delayed phase, which is diagnostic for HCC in cirrhotic livers without need for biopsy. AFP >200 ng/mL is highly specific for HCC.\n\n**2. Rationale for Incorrect Options**\n\n- a) Cholangiocarcinoma: Bile duct cancer; different imaging (peripheral location); elevated CA 19-9.\n- c) Liver metastasis: Different primary; no chronic hepatitis history; imaging less characteristic.\n- d) Focal nodular hyperplasia: Benign; no malignancy features; normal AFP; rare in cirrhosis.\n\n**3. Exam Essentials**\n\n- HCC diagnosis: Nodule >1 cm on CT/MRI with arterial enhancement + washout (no biopsy needed); or biopsy if uncertain.\n- Risk factors: Cirrhosis (HBV, HCV, alcohol), NAFLD, hemochromatosis, alpha-1 antitrypsin deficiency.\n- Surveillance: Ultrasound + AFP every 6 months in cirrhotic patients; earlier HCC detection improves prognosis.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":25,"question":"A 65-year-old diabetic patient presents with oliguria, hypotension, and elevated creatinine from 1.1 â†’ 3.2 mg/dL after severe dehydration. Urine sodium is 10 mEq/L, FeNa = 0.7%, urine osmolality = 650 mOsm/kg. What is the most likely diagnosis?","options":{"a":"Acute tubular necrosis","b":"Prerenal acute kidney injury","c":"Acute interstitial nephritis","d":"Postrenal obstruction"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn acute kidney injury after dehydration with oliguria, elevated creatinine (1.1â†’3.2), low urine sodium (10 mEq/L), low FeNa (0.7%), and high urine osmolality (650), this indicates prerenal AKI. The kidneys are appropriately reabsorbing sodium and concentrating urine, demonstrating preserved renal functionâ€”volume depletion triggers appropriate renal responses. FeNa \u003c1% is classic for prerenal AKI; contrast with ATN (FeNa >2%).\n\n**2. Rationale for Incorrect Options**\n\n- a) ATN: FeNa >2%; high urine sodium; dilute urine; tubular damage from ischemia/toxins.\n- c) AIN: Fever, rash, eosinophiluria; drug history typical; different clinical context.\n- d) Postrenal: Obstruction; flank pain common; catheterization/imaging reveals obstruction.\n\n**3. Exam Essentials**\n\n- FeNa calculation: (Urine Na Ã— Serum Cr)/(Serum Na Ã— Urine Cr) Ã— 100; \u003c1% = prerenal, >2% = ATN.\n- Prerenal response: Oliguria, concentrated urine (osmol >500), low urine Na, low FeNa.\n- Treatment: IV fluid resuscitation; addresses underlying hypovolemia; creatinine normalizes with rehydration.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"AKI FeNa Cut-offs\":\n- FeNa \u003c1%: Prerenal (kidney preserving Na, concentrating urine)\n- FeNa 1-2%: Borderline (prerenal vs intrinsic)\n- FeNa >2%: Intrinsic (ATN most common; tubular damage)"},{"id":26,"question":"A 58-year-old woman presents with frothy urine, edema, and serum albumin 2.2 g/dL. Urine protein is 4.5 g/day. Which condition is MOST strongly associated with hypercoagulability?","options":{"a":"Minimal change disease","b":"FSGS","c":"Membranous nephropathy","d":"IgA nephropathy"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nMembranous nephropathy (MN) is the most hypercoagulable nephrotic syndrome due to loss of anticoagulant proteins (protein S, antithrombin III) in proteinuria and thrombophilic effects of proteinuria (activated coagulation cascade from proteinemia, hemoconcentration). Membranous disease carries highest VTE risk (renal vein thrombosis, DVT, PE) among glomerular diseases; thrombosis can be initial presentation of MN.\n\n**2. Rationale for Incorrect Options**\n\n- a) MCD: Responds to steroids; nephrotic but lower VTE risk than MN.\n- b) FSGS: Progressive; proteinuric but less hypercoagulable than MN.\n- d) IgAN: Hematuria-predominant; lower nephrotic syndrome prevalence; less hypercoagulability.\n\n**3. Exam Essentials**\n\n- Nephrotic hypercoagulability mechanism: Urinary loss of anticoagulants (protein S, antithrombin), proteinuria-induced coagulation activation.\n- MN VTE risk: Up to 40% develop thrombosis if untreated; renal vein thrombosis classic.\n- Anticoagulation: Consider prophylactic anticoagulation in MN with nephrotic syndrome; individualized decision.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":27,"question":"A hypertensive patient with a renal bruit shows sudden worsening of BP. Labs: Creatinine increases after starting ACE inhibitor. What is the most likely cause?","options":{"a":"Unilateral renal artery stenosis","b":"Bilateral renal artery stenosis","c":"Renal vein thrombosis","d":"Fibromuscular dysplasia"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nBilateral renal artery stenosis (RAS) presents with renal bruit + worsening hypertension + creatinine increase AFTER starting ACE inhibitor. ACE inhibitors work by reducing efferent arteriolar vasoconstriction; in bilateral RAS, they eliminate this compensation mechanism for reduced glomerular filtration pressure, precipitating acute creatinine rise. This is the classic presentation distinguishing bilateral from unilateral RAS.\n\n**2. Rationale for Incorrect Options**\n\n- a) Unilateral RAS: HTN present but creatinine unchanged with ACE-I; affected kidney perfused, contralateral compensates.\n- c) RVT: Thrombosis; acute flank pain, hematuria; different presentation.\n- d) FMD: Fibromuscular dysplasia; can cause RAS but typically unilateral; doesn't explain ACE-I creatinine worsening.\n\n**3. Exam Essentials**\n\n- Bilateral RAS: ACE-I contraindicated; causes catastrophic renal failure; use calcium channel blockers or ARBs with caution.\n- Unilateral RAS: ACE-I safe; improves renal perfusion pressure; may improve proteinuria.\n- Screening: Doppler ultrasound (operator-dependent), CT/MR angiography, or captopril renography.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":28,"question":"A 50-year-old patient with long-standing CKD presents with bone pain, PTH 700 pg/mL, phosphate 6.8 mg/dL, calcium 7.9 mg/dL. Diagnosis?","options":{"a":"Adynamic bone disease","b":"Osteomalacia","c":"Secondary hyperparathyroidism","d":"Tertiary hyperparathyroidism"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nIn CKD with elevated PTH (700 pg/mL), hyperphosphatemia (6.8), and hypocalcemia (7.9), this is secondary hyperparathyroidismâ€”appropriate parathyroid response to phosphate retention and calcium depletion from declining renal function. PTH appropriately elevated as compensatory mechanism. Later stages show tertiary hyperparathyroidism if parathyroids become autonomous (PTH high despite calcium normalization).\n\n**2. Rationale for Incorrect Options**\n\n- a) Adynamic bone disease: PTH inappropriately low; over-suppression (excessive PTH-lowering); different metabolic state.\n- b) Osteomalacia: Vitamin D deficiency; low PTH expected; different metabolic pattern.\n- d) Tertiary hyperparathyroidism: Autonomous hyperparathyroidism after prolonged secondary phase; calcium elevated despite high PTH.\n\n**3. Exam Essentials**\n\n- CKD-MBD progression: Secondary HPT â†’ if untreated/prolonged â†’ tertiary HPT (autonomous).\n- Management: Phosphate binders, vitamin D supplementation, calcium monitoring; PTH goal varies by CKD stage.\n- Tertiary HPT: Requires parathyroidectomy if severe; develops after years of secondary HPT.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"CKD Mineral Metabolism\":\n- Secondary HPT: PTH high (appropriate response), PO4 high, Ca low, VitD low\n- Tertiary HPT: PTH very high (autonomous), Ca normalized/high, PO4 normalized, PTX may be needed"},{"id":29,"question":"A patient presents with cola-colored urine following a sore throat 2 weeks ago. BP is high, C3 is low, ASO titers are high. What is the most likely diagnosis?","options":{"a":"IgA nephropathy","b":"PSGN","c":"RPGN","d":"Membranoproliferative GN"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nPost-streptococcal glomerulonephritis (PSGN) presents with cola-colored hematuria 2 weeks after sore throat, hypertension, low C3 (complement activation), and high ASO titers confirming streptococcal infection. PSGN is immune complex-mediated glomerulonephritis from streptococcal antigen-antibody complex deposition. Children recover completely; adults have variable outcomes.\n\n**2. Rationale for Incorrect Options**\n\n- a) IgA nephropathy: IgA deposition; can follow URI but different timing/C3 pattern.\n- c) RPGN: Rapidly progressive; crescent formation; more aggressive; different serologies.\n- d) MPGN: Different antigen-antibody patterns; C3 may be low but different clinical presentation.\n\n**3. Exam Essentials**\n\n- PSGN classic: Hematuria + hypertension + edema post-strep pharyngitis; occurs 1-2 weeks post-infection.\n- Diagnosis: Elevated ASO titer, low C3, hematuria, RBC casts; kidney biopsy rarely needed.\n- Prognosis: Children 90% recover completely; adults 50% have residual disease; treatment supportive (BP control, ACE-I).\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"PSGN Features\":\n- P â€“ Post-streptococcal\n- S â€“ Streptococcus pyogenes\n- G â€“ Glomerulonephritis (hematuria, casts)\n- N â€“ Note: C3 low, ASO high, good prognosis in kids"},{"id":30,"question":"A 22-year-old male has recurrent renal stones, nephrocalcinosis, serum HCOâ‚ƒâ» 17 mEq/L, hypokalemia, urine pH 6.5. Diagnosis?","options":{"a":"Type I RTA","b":"Type II RTA","c":"Type IV RTA","d":"Gitelman syndrome"},"correctAnswer":"a","explanation":"**1. High-Yield Topic Explanation**\n\nType I RTA (Distal RTA) presents with recurrent renal stones, nephrocalcinosis (calcium phosphate precipitation), metabolic acidosis with hypokalemia (HCO3 17), and alkaline urine pH 6.5. Inability to acidify urine (pH always >5.5) despite systemic acidosis distinguishes Type I RTA. Positive urine anion gap confirms distal H+ secretion defect. Calcium phosphate stones result from alkaline urine favoring supersaturation.\n\n**2. Rationale for Incorrect Options**\n\n- b) Type II RTA: Proximal; low serum HCO3 only; urine can acidify if systemic pH very low; different.\n- c) Type IV RTA: High potassium (hypokalemia rules out); aldosterone deficiency/resistance.\n- d) Gitelman syndrome: Hypokalemia + hypomagnesemia but different mechanism (thiazide-like); normal acid-base.\n\n**3. Exam Essentials**\n\n- Type I RTA: Cannot acidify urine; alkaline urine pH despite acidemia; urine AG positive.\n- Complications: Nephrolithiasis (calcium phosphate), nephrocalcinosis, bone disease (chronic acidosis).\n- Causes: Autoimmune (SLE), sarcoidosis, amphotericin B, methicillin, pyelonephritis.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"RTA Types Summary\":\n- Type I: Distal RTA (cannot acidify urine); alkaline urine with acidemia\n- Type II: Proximal RTA (normal distal, proximal reabsorption impaired)\n- Type III: Rare; combination I + II\n- Type IV: Hyperkalemic RTA (aldosterone deficiency/resistance)"},{"id":31,"question":"A 55-year-old CKD patient presents with hyperkalemia (Kâº 6.2). ECG: peaked T waves. What is the FIRST step in management?","options":{"a":"IV insulin + glucose","b":"IV calcium gluconate","c":"Furosemide","d":"Sodium bicarbonate"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn acute hyperkalemia with ECG changes (peaked T waves), the FIRST step is IV calcium gluconate to stabilize cardiac membrane and prevent ventricular arrhythmias. Calcium is the only cardioprotective agent and works within minutes. While other agents (insulin-glucose, diuretics, sodium bicarbonate) shift potassium intracellularly and eliminate from body, they take longer to work and do not protect the heart acutely. Calcium is the emergency intervention.\n\n**2. Rationale for Incorrect Options**\n\n- a) Insulin + glucose: Shifts K+ into cells; takes 10-30 minutes; not first for cardiac protection.\n- c) Furosemide: Promotes urinary K+ excretion; slow; requires adequate renal function.\n- d) Sodium bicarbonate: Shifts K+ intracellularly; slower than insulin; minimal benefit if already acidotic.\n\n**3. Exam Essentials**\n\n- Hyperkalemia emergency: ECG changes (peaked T, widened QRS, loss of P) â†’ immediate calcium gluconate.\n- Subsequent management: Insulin-glucose, diuretics, sodium bicarbonate to shift K+; dialysis if renal failure.\n- Monitoring: Serial ECG, frequent K+ levels; address underlying cause (medication, renal failure, acidosis).\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Hyperkalemia Management Priority\":\n- 1st (Cardiac stabilization): Calcium gluconate (minutes)\n- 2nd (Shift K+ in): Insulin-glucose (10-30 min)\n- 3rd (Eliminate K+): Diuretics, sodium bicarbonate, dialysis (hours)"},{"id":32,"question":"A 21-year-old man presents with persistent hypokalemia, metabolic alkalosis, hypertension, and low renin/low aldosterone. Diagnosis?","options":{"a":"Bartter syndrome","b":"Gitelman syndrome","c":"Liddle syndrome","d":"Conn syndrome"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nLiddle syndrome presents with hypokalemia, metabolic alkalosis, hypertension, and LOW renin/LOW aldosterone. This rare genetic channelopathy (epithelial sodium channel [ENaC] gain-of-function) causes excessive distal sodium reabsorption with secondary potassium wasting and hydrogen ion loss (alkalosis). The low renin-aldosterone axis distinguishes it from Bartter/Gitelman (high renin, high aldosterone).\n\n**2. Rationale for Incorrect Options**\n\n- a) Bartter syndrome: High renin, high aldosterone (opposite here); normal BP or hypotension.\n- b) Gitelman syndrome: Similar to Bartter but with hypomagnesemia; high renin/aldosterone.\n- d) Conn syndrome: Primary hyperaldosteronism; high aldosterone (here it's low); APAdenoma/bilateral hyperplasia.\n\n**3. Exam Essentials**\n\n- Liddle pathophysiology: ENaC hyperactivity â†’ â†‘ Na reabsorption â†’ â†“ K/H excretion â†’ hypokalemia + alkalosis.\n- Diagnosis: Low renin, low aldosterone with hypertension + hypokalemia (opposite of hyperaldosteronism).\n- Treatment: ENaC blockers (amiloride, triamterene); avoid loop/thiazide diuretics.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":33,"question":"A patient has severe metabolic acidosis: pH 7.10, HCOâ‚ƒâ» 6. Kussmaul breathing. Osmolar gap normal. Anion gap = 28. Which is the MOST likely cause?","options":{"a":"Methanol poisoning","b":"DKA","c":"Ethylene glycol poisoning","d":"Chronic diarrhea"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nSevere metabolic acidosis (pH 7.10, HCO3 6) with high anion gap (28), Kussmaul breathing, and normal osmolar gap indicates DKA (diabetic ketoacidosis). The high anion gap metabolic acidosis results from ketone body accumulation (beta-hydroxybutyrate, acetoacetate). Normal osmolar gap rules out methanol/ethylene glycol poisoning (which cause increased osmolar gap). Kussmaul breathing (deep, rapid) is compensatory hyperventilation.\n\n**2. Rationale for Incorrect Options**\n\n- a) Methanol poisoning: Would show increased osmolar gap (normal ~10-15); AG metabolic acidosis present.\n- c) Ethylene glycol: Similar to methanol; increased osmolar gap differentiating feature.\n- d) Chronic diarrhea: Causes normal anion gap metabolic acidosis (hyperchloremic); AG here is 28 (high).\n\n**3. Exam Essentials**\n\n- DKA: Hyperglycemia, ketonemia/ketonuria, metabolic acidosis, Kussmaul breathing; treat with insulin + fluids + electrolytes.\n- Osmolar gap: Calculated osmolarity âˆ’ measured osmolarity; >10-15 suggests methanol/ethylene glycol.\n- Anion gap: Na âˆ’ (Cl + HCO3); >12 indicates high AG acidosis (ketoacidosis, lactic acidosis, methanol, ethylene glycol, ASA).\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Anion Gap Metabolic Acidosis Causes (MUDPILES)\":\n- M â€“ Methanol\n- U â€“ Uremia\n- D â€“ DKA\n- P â€“ Propylene glycol\n- I â€“ Isoniazid\n- L â€“ Lactic acidosis\n- E â€“ Ethylene glycol\n- S â€“ Salicylates (ASA)"},{"id":34,"question":"After kidney transplant, a patient develops graft dysfunction 5 days later. Biopsy shows neutrophilic infiltration and fibrinoid necrosis of vessels. Diagnosis?","options":{"a":"Hyperacute rejection","b":"Acute antibody-mediated rejection","c":"Acute T-cellâ€“mediated rejection","d":"Chronic rejection"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nAcute antibody-mediated (humoral) rejection presents 5 days post-transplant with neutrophilic infiltration and fibrinoid necrosis of vessels on biopsy. This represents early acute antibody response to donor HLA antigens, causing vasculitis and vessel damage. Earlier than cellular rejection (usually >7 days); requires immediate aggressive immunosuppression (plasmapheresis, IVIG, rituximab).\n\n**2. Rationale for Incorrect Options**\n\n- a) Hyperacute rejection: Minutes to hours; immediate graft loss; prevented by ABO typing/HLA crossmatch.\n- c) Acute T-cell-mediated: 7+ days; inflammatory cells in tubules/interstitium; different histology.\n- d) Chronic rejection: Months to years; progressive fibrosis; different pathology.\n\n**3. Exam Essentials**\n\n- Acute AMR features: Neutrophilic infiltration, fibrinoid necrosis, C4d deposition on peritubular capillaries.\n- Risk factors: HLA sensitization, positive crossmatch (should prevent transplant), repeat transplant.\n- Treatment: Aggressive immunosuppression; plasmapheresis removes circulating antibodies; rituximab for B cell depletion.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":35,"question":"A 42-year-old man presents with progressive swelling of his legs for 3 months. He has no history of diabetes or hypertension. Urinalysis reveals 4+ proteinuria with oval fat bodies. Serum albumin is low. Creatinine is normal. Renal biopsy shows thickened capillary basement membranes with subepithelial immune complex deposits on electron microscopy. Antiâ€“PLA2R antibodies are positive. What is the most likely diagnosis?","options":{"a":"Minimal change disease","b":"Membranous glomerulonephritis","c":"IgA nephropathy","d":"Post-streptococcal GN"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nMembranous glomerulonephritis (MGN) presents with progressive leg edema, nephrotic syndrome (heavy proteinuria 4+ with oval fat bodies, hypoalbuminemia), normal creatinine, thickened capillary basement membranes, subepithelial immune deposits on EM, and positive anti-PLA2R antibodies. Anti-PLA2R+ in ~70% of primary MGN; identifies autoimmune etiology and predicts worse prognosis.\n\n**2. Rationale for Incorrect Options**\n\n- a) MCD: Podocyte foot process effacement (different mechanism); responds to steroids; no complement/immune deposits.\n- c) IgAN: IgA deposition; hematuria-predominant; not typically subepithelial deposits.\n- d) PSGN: Post-infectious; C3 deposits; usually self-limited.\n\n**3. Exam Essentials**\n\n- MGN pathology: Spikes and domes on EM (subepithelial deposits); \"basement membrane remodeling.\"\n- Primary MGN: Idiopathic; anti-PLA2R antibodies; 30% spontaneous remission, 40% progressive.\n- Secondary MGN: SLE, infection (syphilis, malaria), drugs (gold, mercury), malignancy.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"MGN Features\":\n- M â€“ Membranous (thickened BM)\n- G â€“ Glomerulonephritis\n- N â€“ Nephrotic (proteinuria, hypoalbuminemia)\n- Plus: Subepithelial IgG deposits, anti-PLA2R+ in primary"},{"id":36,"question":"A 29-year-old African-American man presents with new-onset leg edema. He has a history of IV drug use and poorly controlled HIV. Urinalysis shows heavy proteinuria, and his serum creatinine is elevated. Renal biopsy shows segmental sclerosis of some glomeruli with collapsing lesions. Which condition is most strongly associated with this patientâ€™s kidney disease?","options":{"a":"Hepatitis C","b":"HIV infection","c":"Systemic lupus erythematosus","d":"Streptococcal pharyngitis"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nA young African-American with IV drug use and poorly controlled HIV presenting with heavy proteinuria and collapsing FSGS on biopsy has HIV-associated nephropathy (HIVAN). This is a unique collapsing variant of FSGS seen almost exclusively in HIV patients (especially Black patients) with CD4 counts \u003c200 and high viral loads. Direct HIV infection of podocytes causes segmental sclerosis with glomerular collapse.\n\n**2. Rationale for Incorrect Options**\n\n- a) Hepatitis C: Can cause membranoproliferative GN; not collapsing FSGS typically.\n- c) SLE: Lupus nephritis with different serologies (ANA, anti-dsDNA); different demographics.\n- d) Streptococcal: PSGN; acute GN, not collapsing FSGS.\n\n**3. Exam Essentials**\n\n- HIVAN features: Collapsing FSGS, heavy proteinuria, rapid renal failure, CD4 \u003c200 typically.\n- Mechanism: Direct HIV infection of podocytes; HIV in urine; responds to ART.\n- Management: Immediate ART initiation (highest priority); ACE-I/ARB for proteinuria reduction.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":37,"question":"A 58-year-old woman with a 15-year history of type 2 diabetes presents with worsening leg swelling. BP is 160/95 mmHg. Urinalysis shows proteinuria and no hematuria. Her albumin-to-creatinine ratio is significantly elevated. Kidney biopsy reveals nodular mesangial expansion (Kimmelstielâ€“Wilson nodules), GBM thickening, and hyaline arteriolosclerosis. What is the most important early mechanism in the development of her kidney disease?","options":{"a":"Immune complex deposition","b":"Podocyte foot process effacement","c":"Glomerular hyperfiltration due to hyperglycemia","d":"Complement activation"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nThe earliest pathological change in diabetic nephropathy is glomerular hyperfiltration and thickened basement membrane from hyperglycemia-induced effects. Increased GFR and intraglomerular pressure from afferent arteriolar vasodilation precedes proteinuria and nodular sclerosis (Kimmelstiel-Wilson nodules). This hyperfiltration phase is potentially reversible with tight glycemic control; once nodular changes appear, damage is more advanced.\n\n**2. Rationale for Incorrect Options**\n\n- a) Immune complex deposition: Occurs in lupus nephritis, not typical diabetic disease.\n- b) Podocyte foot process effacement: Seen in minimal change disease; not primary in DM.\n- d) Complement activation: Not the initiating mechanism in diabetic disease.\n\n**3. Exam Essentials**\n\n- DN progression: Stage 1 (hyperfiltration, thick BM) â†’ Stage 2 (silent) â†’ Stage 3 (overt proteinuria) â†’ Stage 4 (declining GFR).\n- Kimmelstiel-Wilson nodules: Nodular mesangial expansion; late finding; indicates advanced DN.\n- Prevention: Tight glucose/BP control (ACE-I/ARB essential) in early stages; delays progression significantly.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Diabetic Nephropathy Stages\":\n- Stage 1: Hyperfiltration (high GFR, thick BM, hypertrophy)\n- Stage 2: Silent (structural changes, normal albumin)\n- Stage 3: Overt (proteinuria \u003c3.5 g/day, declining GFR)\n- Stage 4: Advanced (proteinuria, GFR \u003c50, hypertension)\n- Stage 5: ESRD (GFR \u003c15)"},{"id":38,"question":"A 46-year-old woman presents with recurrent episodes of flank pain, fever, and foul-smelling urine. She has had multiple UTIs over the past year. On exam, she is febrile and has right costovertebral angle tenderness. Urinalysis reveals: pH: 8.5; Numerous coffin-lidâ€“shaped crystals; Positive leukocyte esterase and nitrites. A renal ultrasound shows a large, irregular renal pelvic stone occupying most of the collecting system. What is the most likely composition of this stone?","options":{"a":"Calcium oxalate","b":"Uric acid","c":"Struvite (magnesium ammonium phosphate)","d":"Cystine"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nStruvite stones (magnesium ammonium phosphate) form in alkaline urine (pH 8.5) from recurrent UTIs with urease-producing bacteria (Proteus, Klebsiella). The alkaline pH favors struvite precipitation; coffin-lid crystals are pathognomonic. These stones form in infected urine and are more common in women with recurrent infections. Large staghorn calculi can develop, requiring surgical intervention.\n\n**2. Rationale for Incorrect Options**\n\n- a) Calcium oxalate: Acidic urine; most common stone type; different crystal morphology.\n- b) Uric acid: Acidic urine (\u003c5.5); radiolucent; associated with gout.\n- d) Cystine: Genetic; cystinuria; rare; acidic urine; sulfur-containing.\n\n**3. Exam Essentials**\n\n- Struvite stone features: Alkaline urine, recurrent UTI, large stones, coffin-lid crystals, positive nitrites/leukocyte esterase.\n- Management: Antibiotics for infection, acidification of urine (methionine), stone removal (PCNL if large).\n- Prevention: Aggressive UTI treatment, urinary acidification, low dietary phosphate.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Renal Stone Associations\":\n- Calcium oxalate: Hyperuricemia, hypercalcemia, hypocitraturia, dehydration\n- Uric acid: Gout, high urine uric acid, acidic urine\n- Struvite: Recurrent UTI, alkaline urine, urease-producing bacteria\n- Cystine: Cystinuria (genetic), rare, early onset"},{"id":39,"question":"A 62-year-old man with long-standing hypertension and type 2 diabetes presents with fatigue and decreased appetite. His BP is 158/92 mmHg. Lab results show: eGFR: 26 mL/min/1.73 mÂ²; Serum creatinine: 2.0 mg/dL; Hemoglobin: 9.8 g/dL; Potassium: 4.8 mEq/L; Urinalysis: albuminuria (++). Which additional abnormality is most likely at this stage of CKD?","options":{"a":"Increased erythropoietin levels","b":"Hypophosphatemia","c":"Metabolic acidosis due to reduced acid excretion","d":"Hypercalcemia"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nAt CKD stage 3b (eGFR 26), the most likely additional abnormality is metabolic acidosis from reduced renal acid excretion. As GFR declines, kidneys lose ability to excrete protons and titratable acid; anion gap remains normal (\"hyperchloremic acidosis\"). Hemoglobin slightly low (anemia from erythropoietin deficiency), potassium normal (not yet elevated), phosphate rises later (stage 4-5).\n\n**2. Rationale for Incorrect Options**\n\n- a) Increased EPO: Paradoxical; EPO decreases in CKD; anemia develops from reduced EPO production.\n- b) Hypophosphatemia: Occurs in early stages with parathyroid activation; hyperphosphatemia develops later.\n- d) Hypercalcemia: Uncommon; hypocalcemia more typical from phosphate retention and vitamin D reduction.\n\n**3. Exam Essentials**\n\n- CKD metabolic consequences: Hyperkalemia (K \u003c60), hyperphosphatemia (PO4 >600), hypocalcemia, metabolic acidosis.\n- Anemia: From EPO deficiency; mild at stage 3b; worsens with declining GFR.\n- Mineral metabolism: Tertiary hyperparathyroidism develops; PTH elevation compensates for calcium/phosphate imbalance.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"CKD Complications by Stage\":\n- Stage 1-2: Hypertension, proteinuria\n- Stage 3a: Anemia begins, metabolic acidosis\n- Stage 3b: Anemia worsens, acidosis, mineral imbalance begins\n- Stage 4: Hyperkalemia, hyperphosphatemia, hypocalcemia, secondary HPT\n- Stage 5: Severe: ESRD needing dialysis/transplant"},{"id":40,"question":"A 58-year-old diabetic man on lisinopril presents with muscle weakness and palpitations. Labs show: Potassium: 6.1 mEq/L; Bicarbonate: 17 mEq/L; pH: 7.31; Sodium: 137 mEq/L; Urine sodium: normal. Aldosterone level is low. Which feature is most characteristic of his condition?","options":{"a":"Hypokalemia due to increased distal sodium delivery","b":"Hyperkalemia from decreased aldosterone activity","c":"Very alkaline urine pH (>6.5)","d":"High anion gap metabolic acidosis"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nType IV RTA (hyperkalemic RTA) presents with hyperkalemia (6.1), metabolic acidosis (HCO3 17, pH 7.31), and low aldosterone. This results from aldosterone deficiency/resistance, causing impaired distal potassium secretion and hydrogen ion excretion. Common in diabetics on ACE-I/ARB, renal disease, medications (NSAIDs, potassium-sparing diuretics).\n\n**2. Rationale for Incorrect Options**\n\n- a) Hypokalemia: Type I and II RTA present with hypokalemia; Type IV has hyperkalemia.\n- c) Alkaline urine: Seen in Type I RTA; Type IV urine can acidify (not the primary defect).\n- d) High anion gap: Type IV has normal anion gap (hyperchloremic); Type I-II also normal AG.\n\n**3. Exam Essentials**\n\n- Type IV RTA mechanism: Aldosterone deficiency (Addison, heparin use) or resistance (ACE-I, NSAIDs, K-sparing diuretics).\n- Diagnosis: Hyperkalemia with metabolic acidosis + low aldosterone (inappropriately low).\n- Management: Diuretics (fludrocortisone if aldosterone-deficient), dietary K+ restriction, avoid ACE-I/NSAIDs.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Type IV RTA (Hyperkalemic)\":\n- Low aldosterone â†’ poor K+ secretion\n- Impaired H+ secretion â†’ metabolic acidosis\n- Associated with: ACE-I, NSAIDs, K-sparing diuretics, diabetes, renal disease"},{"id":41,"question":"A 2-month-old infant is brought due to generalized swelling and poor feeding. The mother reports the baby has had puffy eyes since birth, and the swelling has progressively increased. On exam, there is marked ascites and periorbital edema. Labs show: Serum albumin: very low; Massive proteinuria; Normal complement levels (C3/C4). No hematuria. Ultrasound shows enlarged echogenic kidneys. Genetic testing reveals a mutation in the NPHS1 gene. What is the most likely diagnosis?","options":{"a":"Minimal change disease","b":"Congenital nephrotic syndrome","c":"PSGN","d":"IgA nephropathy"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nCongenital nephrotic syndrome (CNS) presents in a 2-month-old with puffy eyes since birth, generalized edema, ascites, massive proteinuria, hypoalbuminemia, normal complement (unlike PSGN), and NPHS1 mutation. This is autosomal recessive podocin deficiency; most common form of CNS in Finland, less common elsewhere. Massive proteinuria from birth causes severe hypoalbuminemia and edema requiring aggressive management.\n\n**2. Rationale for Incorrect Options**\n\n- a) MCD: Older children; normal complement; responds to steroids; rare in infants.\n- c) PSGN: Post-infectious; low complement; older children typically.\n- d) IgAN: Hematuria-predominant; older children; different genetics.\n\n**3. Exam Essentials**\n\n- CNS features: Puffy eyes from birth, massive proteinuria (may exceed 10 g/day), severe hypoalbuminemia, edema/ascites.\n- NPHS1 gene: Encodes podocin (podocyte protein); mutations cause congenital nephrotic syndrome.\n- Prognosis: Progressive renal failure; dialysis/transplant needed by school age; mortality \u003c5% with modern management.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":42,"question":"A 5-year-old boy presents with sudden onset facial puffiness and leg swelling after a recent viral illness. He has no hematuria. BP is normal. Labs show: Urinalysis: 4+ protein, no RBCs; Albumin: low; Cholesterol: elevated; Complement levels: normal. Renal biopsy is performed only because the child is steroid-resistant. Electron microscopy shows diffuse effacement of podocyte foot processes. What is the most likely diagnosis?","options":{"a":"Membranous nephropathy","b":"Minimal change disease","c":"Post-streptococcal GN","d":"IgA nephropathy"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn a 5-year-old with sudden nephrotic syndrome (4+ proteinuria, hypoalbuminemia, normal complement, normal hematuria), normal BP, and podocyte foot process effacement on biopsy, the diagnosis is minimal change disease (MCD), the most common nephrotic syndrome in children. The diffuse foot process effacement on electron microscopy is pathognomonic for MCD. This child is steroid-resistant, requiring additional therapy (cyclophosphamide, MMF, tacrolimus).\n\n**2. Rationale for Incorrect Options**\n\n- a) Membranous: Rare in children; different EM findings (subepithelial deposits); older age group.\n- c) PSGN: Post-infectious; hematuria prominent; normal glomeruli on EM; different pathology.\n- d) IgAN: Hematuria predominant; IgA deposition on immunofluorescence; different.\n\n**3. Exam Essentials**\n\n- MCD features: Sudden nephrotic syndrome, normal creatinine/complement, negative serology, foot process effacement.\n- Steroid-responsive (90%): Responds to prednisolone within 4 weeks; relapses common.\n- Steroid-resistant: Cyclophosphamide, MMF, tacrolimus; higher progression risk.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":43,"question":"A 12-year-old boy presents with cola-colored urine. His mother reports he had a sore throat 2 days ago. Vital signs: mild hypertension. Labs: Urinalysis: red blood cell casts; Complement C3: normal; Serum creatinine: mild elevation. Renal biopsy shows mesangial proliferation What is the most likely diagnosis?","options":{"a":"Post-streptococcal glomerulonephritis (PSGN)","b":"IgA nephropathy","c":"Membranoproliferative GN","d":"Henochâ€“SchÃ¶nlein purpura"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nA 12-year-old with cola-colored urine 2 days after sore throat, mild hypertension, RBC casts, and mesangial proliferation on biopsy has post-streptococcal glomerulonephritis (PSGN). Note: C3 normal (not low) is classic for PSGN (unlike older classification), distinguishing it from other proliferative diseases. The mesangial proliferation is the hallmark histology; occurs typically 1-2 weeks post-streptococcal infection.\n\n**2. Rationale for Incorrect Options**\n\n- a) IgAN: IgA deposition; similar presentation but different mechanism; can follow URI.\n- c) MPGN: Membranoproliferative; different histology (membranous plus proliferative); may have low C3.\n- d) HSP: Henoch-SchÃ¶nlein purpura; palpable purpura, abdominal pain typical; IgA deposition.\n\n**3. Exam Essentials**\n\n- PSGN pathology: Mesangial proliferation (most common), endocapillary proliferation, deposits on EM.\n- \"Humped bumps\" on EM: Subepithelial deposits characteristic of PSGN.\n- C3 pattern: Now understood as complement-mediated; C3 may be normal (post-infectious GN not low-complement).\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":44,"question":"A 45-year-old woman presents with fatigue, weight gain, and cold intolerance. TSH is elevated with low T3/T4. Which hormone is primarily decreased due to the affected gland?","options":{"a":"Cortisol","b":"Tri-iodothyronine","c":"Aldosterone","d":"Growth hormone"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn primary hypothyroidism with fatigue, weight gain, cold intolerance, elevated TSH, and LOW T3/T4, the hormone primarily decreased is tri-iodothyronine (T3) and thyroxine (T4). The thyroxine (T4) is the major secreted product of thyroid, accounting for ~80% of thyroid output; T3 is produced peripherally from T4 conversion. Both are decreased in primary hypothyroidism.\n\n**2. Rationale for Incorrect Options**\n\n- a) Cortisol: Adrenal hormone; not primary in thyroid disease (secondary hypothyroidism could affect ACTH/cortisol).\n- c) Aldosterone: Kidney/adrenal; unaffected in primary thyroid disease.\n- d) GH: Pituitary hormone; may be affected in secondary hypothyroidism but not primary thyroid.\n\n**3. Exam Essentials**\n\n- Primary hypothyroidism: High TSH (compensatory), low free T4 (primary defect), low/normal free T3.\n- Treatment: Levothyroxine (T4 replacement); peripheral conversion to T3 adequate in most.\n- Monitoring: TSH goal 0.5-2.5 mIU/L on replacement; periodic TSH checks for dose adjustment.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":45,"question":"A 23-year-old woman complains of amenorrhea and galactorrhea. Prolactin levels are high. Which hypothalamic hormone is likely decreased?","options":{"a":"Somatostatin","b":"GnRH","c":"Dopamine","d":"CRH"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nIn hyperprolactinemia (amenorrhea, galactorrhea, elevated prolactin), the hypothalamic hormone likely decreased is dopamine. Dopamine is the prolactin-inhibiting factor (PIF); dopamine antagonism increases prolactin; dopamine deficiency or stalk compression removes dopamine's inhibitory effect, allowing prolactin elevation. The hypothalamic-pituitary axis is uniqueâ€”dopamine tonically suppresses prolactin.\n\n**2. Rationale for Incorrect Options**\n\n- a) Somatostatin: Inhibits growth hormone and somatotroph function; not directly prolactin regulation.\n- b) GnRH: Controls FSH/LH; amenorrhea results from high prolactin (which inhibits GnRH indirectly).\n- d) CRH: Controls ACTH; not involved in prolactin regulation.\n\n**3. Exam Essentials**\n\n- Dopamine role: Tonic inhibition of prolactin; dopamine agonists (bromocriptine, cabergoline) lower prolactin.\n- Causes of hyperprolactinemia: Prolactinoma (most common), stalk compression, medications (antipsychotics, metoclopramide), hypothyroidism.\n- Symptoms: Amenorrhea, galactorrhea, erectile dysfunction, decreased libido, headaches (if pituitary adenoma).\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":46,"question":"A 60-year-old man presents with episodic headache, palpitations & diaphoresis. Plasma metanephrines are high. Which hormone is over-secreted?","options":{"a":"Dopamine","b":"Aldosterone","c":"Catecholamines","d":"ACTH"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nIn pheochromocytoma (episodic headache, palpitations, diaphoresis, elevated plasma metanephrines), the hormone over-secreted is catecholamines (epinephrine and norepinephrine). The elevated metanephrines (metabolites of catecholamines) confirm catecholamine excess. Pheochromocytomas are neuroendocrine tumors of adrenal medulla secreting catecholamines paroxysm, causing hypertension and classic triad.\n\n**2. Rationale for Incorrect Options**\n\n- a) Dopamine: Pheochromocytomas can secrete dopamine but it's less common/clinically significant than catecholamines.\n- b) Aldosterone: Primary aldosteronism (separate entity); not pheochromocytoma.\n- d) ACTH: Pheochromocytomas rarely secrete ACTH; would cause Cushing syndrome (separate syndrome).\n\n**3. Exam Essentials**\n\n- Pheochromocytoma diagnosis: Elevated plasma free metanephriles or 24-hour urine metanephrines; >400 pg/mL highly specific.\n- Classic triad: Severe headache, profuse sweating, palpitations (with hypertension).\n- Treatment: Alpha-blockade (phenoxybenzamine) first, then beta-blockade (propranolol), then surgical removal.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Pheochromocytoma Presentation (5 P's)\":\n- Paroxysmal (episodic symptoms)\n- Perspiration (profuse sweating)\n- Palpitations\n- Postural hypertension (initially; then sustained)\n- Pressure (severe headache)"},{"id":47,"question":"A 48-year-old man presents with recurrent kidney stones. Labs show â†‘ Ca, â†“ phosphate, â†‘ PTH. Which hormone effect explains hypercalcemia?","options":{"a":"Increased calcium absorption in intestine","b":"Increased bone resorption","c":"Decreased vitamin D activation","d":"Decreased renal calcium reabsorption"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn hyperparathyroidism with elevated serum calcium, low phosphate, and elevated PTH, the mechanism causing hypercalcemia is increased bone resorption. PTH stimulates osteoclast activity via RANKL on osteoblasts, increasing bone resorption and releasing calcium from bone into serum. Additionally, PTH increases renal calcium reabsorption and 1,25-vitamin D production (increases intestinal absorption), but bone resorption is the dominant mechanism for hypercalcemia.\n\n**2. Rationale for Incorrect Options**\n\n- a) Increased intestinal absorption: Secondary mechanism; vitamin D-dependent; less important than bone resorption.\n- c) Decreased vitamin D activation: Opposite; PTH activates 1-alpha-hydroxylase â†’ increased 1,25-vitamin D.\n- d) Decreased renal reabsorption: Opposite; PTH increases renal calcium reabsorption in collecting duct.\n\n**3. Exam Essentials**\n\n- Primary hyperparathyroidism: Elevated PTH + elevated calcium + low-normal phosphate; usually asymptomatic.\n- Symptoms: Nephrolithiasis, osteoporosis, hypercalcemic crisis (severe: confusion, cardiac arrhythmias).\n- Treatment: PTH-lowering agents (vitamin D, cinacalcet), surgical parathyroidectomy if symptomatic.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"PTH Effects\":\n- Bone: Increased resorption (â†‘ Ca, â†“ PO4)\n- Kidney: Increased Ca reabsorption, decreased PO4 reabsorption, increased 1,25-vitamin D\n- Result: â†‘ Serum calcium, â†“ Phosphate"},{"id":48,"question":"A patient with chronic renal failure develops hypocalcemia despite normal PTH levels. The reason is decreased secretion of which hormone?","options":{"a":"Calcitonin","b":"Vitamin D (1,25-OHâ‚‚Dâ‚ƒ)","c":"PTH-related peptide","d":"Aldosterone"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn chronic renal failure with hypocalcemia despite normal PTH levels, the hormone deficiency is vitamin D (1,25-OHâ‚‚Dâ‚ƒ/calcitriol). The kidneys activate 25-hydroxyvitamin D to 1,25-dihydroxyvitamin D (active form) via 1-alpha-hydroxylase; declining renal function impairs this activation. Low calcitriol causes hypocalcemia and secondary hyperparathyroidism compensation. Chronic kidney disease mineral and bone disorder (CKD-MBD) results.\n\n**2. Rationale for Incorrect Options**\n\n- a) Calcitonin: Thyroid hormone; decreases serum calcium; not the primary deficiency in CKD.\n- c) PTH-related peptide: Malignancy-related; not relevant to CKD.\n- d) Aldosterone: Mineralocorticoid; doesn't directly regulate serum calcium.\n\n**3. Exam Essentials**\n\n- Vitamin D metabolism: 25-OH-vitamin D (storage form, measured for deficiency) â†’ 1,25-OHâ‚‚Dâ‚ƒ (active form, kidneys).\n- CKD management: Vitamin D supplementation (cholecalciferol, calcitriol); phosphate binders; secondary HPT treatment.\n- Monitoring: Serum calcium, phosphate, PTH, vitamin D levels; skeletal density assessment.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":49,"question":"A 32-year-old woman presents with weight loss, palpitations, heat intolerance, and a diffusely enlarged thyroid gland. TSH is suppressed. Which hormone is MOST responsible for her symptoms?","options":{"a":"Calcitonin","b":"Thyroxine (T4)","c":"Parathyroid hormone","d":"Aldosterone"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn hyperthyroidism (weight loss, palpitations, heat intolerance, goiter, suppressed TSH), the hormone MOST responsible for the symptoms is thyroxine (T4). T4 is the major secreted thyroid hormone (~80% of thyroid output); T3 is more biologically potent but accounts for ~20% of thyroid output. Elevated T4 and T3 increase metabolism, sympathetic activity, and heat production, explaining the clinical symptoms.\n\n**2. Rationale for Incorrect Options**\n\n- a) Calcitonin: Thyroid C-cell hormone; regulates calcium; not responsible for hyperthyroid symptoms.\n- c) PTH: Parathyroid hormone; calcium regulation; unrelated to thyroid disease.\n- d) Aldosterone: Adrenal hormone; not involved in thyroid disease pathophysiology.\n\n**3. Exam Essentials**\n\n- Hyperthyroidism causes: Graves disease (autoimmune, most common), thyroiditis, toxic nodule, TSH-secreting pituitary.\n- Diagnosis: Low TSH, elevated free T4/T3; TSH receptor antibodies in Graves.\n- Treatment: Antithyroid drugs (PTU, methimazole), beta-blockers (symptom relief), radioiodine, or surgery.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Hyperthyroidism Symptoms\":\n- Metabolic: Weight loss, heat intolerance, â†‘ appetite\n- Cardiovascular: Tachycardia, palpitations, AFib risk\n- Neuropsychiatric: Anxiety, tremor, insomnia, irritability\n- Physical: Goiter, eye signs (Graves), proximal weakness"},{"id":50,"question":"A 45-year-old man with central obesity, moon face, and proximal muscle weakness has high serum cortisol not suppressed by low-dose dexamethasone. ACTH is high. Which hormone overproduction is most likely?","options":{"a":"Cortisol from adrenal medulla","b":"ACTH from the pituitary","c":"Renin from kidneys","d":"CRH from hypothalamus"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn Cushing syndrome with central obesity, moon facies, proximal muscle weakness, high cortisol NOT suppressed by low-dose dexamethasone, and HIGH ACTH, the hormone overproduction source is ACTH from the pituitary (Cushing disease). The high ACTH-driven cortisol excess that fails to suppress with low-dose dex but partially suppresses with high-dose dex (indicating pituitary source responding to higher suppression) confirms pituitary corticotroph adenoma.\n\n**2. Rationale for Incorrect Options**\n\n- a) Cortisol from adrenal medulla: Adrenal medulla produces catecholamines, not cortisol (adrenal cortex zone fasciculata).\n- c) Renin from kidneys: Hypertension-related; not Cushing syndrome.\n- d) CRH from hypothalamus: If elevated, would cause secondary pituitary ACTH; less common than primary pituitary adenoma.\n\n**3. Exam Essentials**\n\n- Cushing disease: Pituitary ACTH-secreting adenoma; most common Cushing syndrome (~70%).\n- Dexamethasone suppression test: Low-dose (no suppression if pituitary) vs high-dose (suppression if pituitary, not ectopic).\n- Treatment: Transsphenoidal pituitary surgery; radiation if incomplete; medical therapy (mitotane, metyrapone) if surgery fails.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Cushing Syndrome Differential\":\n- Cushing disease (pituitary ACTH): â†‘ ACTH, suppressed by high-dose dex\n- Ectopic ACTH: â†‘ ACTH, NOT suppressed by high-dose dex\n- Primary adrenal: â†“ ACTH, high cortisol"},{"id":51,"question":"A 50-year-old man experiences severe hypotension, hyperpigmentation, hyponatremia, and hyperkalemia. Which hormone deficiency explains these findings?","options":{"a":"Aldosterone","b":"Cortisol only","c":"Epinephrine","d":"Thyroxine"},"correctAnswer":"a","explanation":""},{"id":52,"question":"A 29-year-old woman presents with amenorrhea, galactorrhea, low estradiol, and headaches. Prolactin level is high. What hormone is MOST likely suppressed?","options":{"a":"FSH","b":"ACTH","c":"TSH","d":"GH"},"correctAnswer":"a","explanation":"**1. High-Yield Topic Explanation**\n\nIn hyperprolactinemia (high prolactin level) with amenorrhea, galactorrhea, low estradiol, and headaches, the hormone MOST likely suppressed is FSH (follicle-stimulating hormone). Prolactin inhibits GnRH secretion (indirectly reducing FSH and LH), resulting in hypogonadism, anovulation, and amenorrhea. Additionally, prolactin directly inhibits follicular estradiol production, causing low estrogen.\n\n**2. Rationale for Incorrect Options**\n\n- b) ACTH: Controls cortisol; unrelated to amenorrhea from prolactin.\n- c) TSH: Thyroid-stimulating; may be affected in pituitary disease but not primary in prolactinoma.\n- d) GH: Growth hormone; may be suppressed by pituitary adenoma mass effect but less directly related to amenorrhea.\n\n**3. Exam Essentials**\n\n- Hyperprolactinemia-induced amenorrhea: Prolactin >200 mIU/L usually amenorrheic; levels >10 times normal diagnostic.\n- FSH/LH suppression: Results in anovulation and hypogonadism; estradiol low.\n- Treatment: Dopamine agonists (bromocriptine, cabergoline) restore FSH/LH and fertility in most.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":53,"question":"A 22-year-old man presents with polyuria, polydipsia, weight loss, and fasting glucose 290 mg/dL. Autoantibodies are positive. Which hormone is deficient?","options":{"a":"Glucagon","b":"Cortisol","c":"Insulin","d":"Growth hormone"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nIn type 1 diabetes with polyuria, polydipsia, weight loss, fasting glucose 290 mg/dL, and positive autoantibodies, the hormone deficient is insulin. Autoimmune destruction of pancreatic beta cells leads to absolute insulin deficiency. Autoantibodies (GAD, IA-2, ZnT8) confirm autoimmune etiology distinguishing type 1 from type 2 diabetes.\n\n**2. Rationale for Incorrect Options**\n\n- a) Glucagon: Elevated in type 1 DM; not deficient (contributes to hyperglycemia).\n- b) Cortisol: Adrenal hormone; not primary deficiency in type 1 diabetes.\n- d) GH: Pituitary hormone; not deficient in type 1 diabetes.\n\n**3. Exam Essentials**\n\n- Type 1 DM diagnosis: Elevated glucose + positive autoantibodies + low C-peptide (beta cell failure).\n- Autoantibodies: GAD-65, IA-2, ZnT8 (>1 positive in new-onset T1DM).\n- Treatment: Insulin replacement (subcutaneous injection or pump); carbohydrate counting; intensive glucose monitoring.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Type 1 DM Features\":\n- Autoimmune etiology\n- Absolute insulin deficiency\n- Autoantibodies (GAD, IA-2, ZnT8)\n- Acute presentation (polyuria, polydipsia, weight loss)\n- Young patients (typically \u003c30 years)"},{"id":54,"question":"A 33-year-old woman presents with weight gain, easy bruising, purple striae, and uncontrolled diabetes. Low-dose dex suppression test: NO suppression. High-dose dex test: cortisol partially suppressed; ACTH decreased. Which is the MOST likely source?","options":{"a":"Adrenal adenoma","b":"Pituitary corticotroph adenoma","c":"Ectopic ACTH-producing tumor","d":"Adrenal carcinoma"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn Cushing syndrome with weight gain, easy bruising, purple striae, uncontrolled diabetes, and HIGH cortisol NOT suppressed by low-dose dex but PARTIALLY suppressed by high-dose dex with ACTH decreased, the most likely source is pituitary corticotroph adenoma (Cushing disease). The high-dose dexamethasone suppression (cortisol partially suppressed, ACTH decreased) indicates pituitary ACTH-secreting adenoma; ectopic ACTH would NOT suppress with high-dose dex.\n\n**2. Rationale for Incorrect Options**\n\n- a) Adrenal adenoma: Low ACTH (suppressed by feedback); this patient has high ACTH.\n- c) Ectopic ACTH: Would NOT suppress with high-dose dex (resistant to suppression).\n- d) Adrenal carcinoma: Rapid progression; more severe; different presentation.\n\n**3. Exam Essentials**\n\n- Cushing disease: Pituitary adenoma; most common cause (~70% of Cushing syndrome).\n- Dex suppression test: Low-dose (none/minimal suppression) â†’ high-dose (suppression indicates pituitary source).\n- ACTH levels: Elevated but moderate (10-100 pg/mL); ectopic ACTH usually much higher (>200).\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Dexamethasone Suppression Interpretation\":\n- No suppression at either dose: Ectopic ACTH or adrenal tumor\n- Suppression at high-dose only: Pituitary adenoma (Cushing disease)\n- Suppression at both doses: Normal axis (but must exclude factitious Cushing)"},{"id":55,"question":"A diabetic patient presents with sweating, tremors, confusion. Glucose = 38 mg/dL. C-peptide is suppressed, insulin is high, sulfonylurea screen is negative. What is the cause?","options":{"a":"Exogenous insulin administration","b":"Insulinoma","c":"Factitious hypoglycemia with sulfonylurea","d":"Reactive hypoglycemia"},"correctAnswer":"a","explanation":"**1. High-Yield Topic Explanation**\n\nIn hypoglycemia (glucose 38) with high insulin but suppressed C-peptide, negative sulfonylurea screen, this indicates exogenous insulin administration (factitious hypoglycemia). The high insulin with suppressed C-peptide (endogenous insulin production) is pathognomonic; in contrast, insulinoma would show high insulin AND high C-peptide. This presentation confirms surreptitious insulin injection.\n\n**2. Rationale for Incorrect Options**\n\n- b) Insulinoma: Would show high insulin AND high C-peptide (both from tumor); this patient C-peptide suppressed.\n- c) Factitious with sulfonylurea: Sulfonylurea screen negative; rules out this.\n- d) Reactive hypoglycemia: Postprandial; not severe (glucose >50); different context.\n\n**3. Exam Essentials**\n\n- Insulin hypoglycemia differential: Insulin high + C-peptide high = insulinoma; high insulin + C-peptide low = exogenous insulin.\n- Exogenous sources: Self-injected (Munchausen), intentional (suicide attempt), accidental overdose.\n- Management: Identification of source; psychiatric evaluation if factitious; glucose replacement.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Hypoglycemia Insulin/C-Peptide Pattern\":\n- High insulin + High C-peptide: Insulinoma\n- High insulin + Low C-peptide: Exogenous insulin\n- Low insulin + Low C-peptide: Depleted glycogen, critical illness"},{"id":56,"question":"A 24-year-old male presents with recurrent kidney stones, jaw pain, and osteoporosis. Calcium is high, PTH is high, phosphorus is low. Genetic testing reveals MEN-1 mutation. Which hormone combination is most elevated?","options":{"a":"PTH + Gastrin + Prolactin","b":"Calcitonin + ACTH + GH","c":"Aldosterone + Cortisol + ADH","d":"Insulin + Glucagon + Somatostatin"},"correctAnswer":"a","explanation":"**1. High-Yield Topic Explanation**\n\nMEN-1 syndrome (multiple endocrine neoplasia-1) with recurrent kidney stones (PTH-induced hypercalcemia), jaw pain (parathyroid adenoma), osteoporosis, and C282Y homozygous mutation shows \"3 P's\": Parathyroid (adenoma, hyperparathyroidism), Pancreatic (gastrinoma), Pituitary (prolactinoma). The hormone combination most elevated is PTH + Gastrin + Prolactin, reflecting tumors in these three glands.\n\n**2. Rationale for Incorrect Options**\n\n- b) Calcitonin + ACTH + GH: Not the classic MEN-1 triad.\n- c) Aldosterone + Cortisol + ADH: Not MEN-1 associated.\n- d) Insulin + Glucagon + Somatostatin: Pancreatic but gastrin more characteristic of MEN-1.\n\n**3. Exam Essentials**\n\n- MEN-1 features: Parathyroid hyperplasia (90%), pancreatic tumors (60%, gastrinoma most common), pituitary adenoma (40%, prolactinoma).\n- Other tumors: Adrenocortical, carcinoid (thymic/bronchial/gastric), cutaneous manifestations.\n- Gene: MEN1 (chromosome 12); autosomal dominant inheritance.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"MEN-1 (The 3 P's)\":\n- Parathyroid (hyperplasia/adenoma)\n- Pancreas (gastrinoma > insulinoma > VIPoma)\n- Pituitary (prolactinoma > GH-secreting > ACTH-secreting)"},{"id":57,"question":"A 14-year-old girl presents with polyuria, weight loss, and abdominal pain. She has a history of autoimmune thyroiditis. Labs show: glucose 410 mg/dL, ketones positive. Her C-peptide level is very low. Which mechanism best explains her condition?","options":{"a":"Peripheral insulin resistance due to obesity","b":"Autoimmune destruction of Î²-cells mediated by T lymphocytes","c":"Genetic defect in insulin receptor kinase","d":"Increased hepatic gluconeogenesis due to glucagon excess alone"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn type 1 diabetes with polyuria, weight loss, ketosis, elevated glucose, and low C-peptide, plus history of autoimmune thyroiditis, the mechanism is autoimmune destruction of beta-cells mediated by T lymphocytes (CD8+ T cells). Autoimmune destruction is selective for insulin-producing beta-cells; environmental trigger (viral infection) likely precipitates disease in genetically predisposed individuals (HLA-linked).\n\n**2. Rationale for Incorrect Options**\n\n- a) Insulin resistance: Type 2 DM mechanism; type 1 has absolute insulin deficiency, not resistance.\n- c) Genetic defect in insulin receptor: Would present differently; rare monogenic form.\n- d) Glucagon excess: Secondary to insulin deficiency; not primary mechanism.\n\n**3. Exam Essentials**\n\n- Type 1 DM pathophysiology: T-cell mediated autoimmune destruction of beta cells; HLA-linked.\n- Autoantibodies: GAD-65, IA-2, ZnT8; multiple antibodies predict earlier disease progression.\n- Stages: Stage 1 (autoimmunity without hyperglycemia), Stage 2 (dysglycemia), Stage 3 (overt DM).\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":58,"question":"A 52-year-old overweight man presents with fasting glucose of 168 mg/dL. C-peptide is elevated. He has acanthosis nigricans. Which mechanism is central to the development of his disease?","options":{"a":"GLUT-4 transporter deficiency","b":"Autoantibodies against insulin","c":"Insulin resistance leading to Î²-cell exhaustion","d":"Pancreatic amyloid destruction of Î±-cells"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nIn type 2 diabetes with elevated fasting glucose (168), elevated C-peptide (preserved beta-cell function), and acanthosis nigricans (insulin resistance marker), the central mechanism is insulin resistance leading to beta-cell exhaustion. Insulin resistance (poor cellular glucose uptake despite high insulin levels) forces pancreas to hypersecrete insulin, eventually causing beta-cell burnout and glucose intolerance despite initially high insulin levels.\n\n**2. Rationale for Incorrect Options**\n\n- a) GLUT-4 transporter deficiency: Would cause severe insulin-resistant diabetes; rare genetic form.\n- b) Autoantibodies against insulin: Type 1 DM feature; type 2 is not autoimmune.\n- d) Pancreatic amyloid destruction: Rare; neuropathology not pathophysiology of common type 2.\n\n**3. Exam Essentials**\n\n- Type 2 DM pathophysiology: Insulin resistance (peripheral + hepatic) + beta-cell dysfunction (declining insulin secretion over time).\n- Acanthosis nigricans: Marker of severe insulin resistance; associated with PCOS, obesity, metabolic syndrome.\n- C-peptide: Elevated initially in type 2; declines with progression and beta-cell failure.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Type 2 DM Pathophysiology\":\n- Insulin resistance (muscle, liver, adipose tissue)\n- â†‘ Hepatic glucose output (impaired insulin suppression)\n- Beta-cell compensation (high C-peptide initially)\n- Progressive beta-cell failure (exhaustion from chronic demand)\n- Hyperglycemia results"},{"id":59,"question":"A 23-year-old woman with known type 1 DM presents with vomiting, abdominal pain, and deep rapid breathing. Labs: Glucose: 580 mg/dL; pH: 7.12; Bicarbonate: 9 mEq/L; Positive ketones. Which is the most appropriate initial management?","options":{"a":"Start subcutaneous long-acting insulin","b":"Begin IV fluids followed by IV insulin","c":"Give oral bicarbonate","d":"Give glucagon injection"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn type 1 diabetic with DKA (vomiting, abdominal pain, deep rapid breathing, glucose 580, pH 7.12, HCO3 9, positive ketones), the most appropriate initial management is IV fluids FOLLOWED BY IV insulin. Fluid resuscitation addresses dehydration and hyperosmolarity first; insulin stops ketone production and hyperglycemia. Order matters: fluids first to restore perfusion, then insulin with close monitoring of potassium (critical electrolyte in DKA).\n\n**2. Rationale for Incorrect Options**\n\n- a) Subcutaneous long-acting insulin: Inappropriate in acute DKA; IV insulin needed.\n- c) Oral bicarbonate: Not standard unless severe acidosis; bicarbonate controversial; fluids preferred.\n- d) Glucagon: Contraindicated in DKA (raises glucose further); insulin needed.\n\n**3. Exam Essentials**\n\n- DKA management: IV fluids (0.9% NS, rate based on deficit), IV insulin (0.1 unit/kg bolus, then infusion), potassium monitoring.\n- Glucose targets: 250-300 mg/dL acceptable; below this add dextrose to IV; prevent hypoglycemia.\n- Monitoring: Glucose, pH, HCO3, potassium, osmolality hourly initially; ICU care often needed.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"DKA Management Sequence (FLUID)\":\n- Fluids (isotonic saline IV)\n- Lytes (K+, replace carefully)\n- Urinary ketones (monitor clearance)\n- Insulin (IV infusion)\n- Dextrose (add when glucose \u003c250)"},{"id":60,"question":"A 70-year-old man with poorly controlled type 2 diabetes presents with confusion and dehydration. Labs: Glucose: 920 mg/dL; pH: 7.36; Serum osmolality: very high; No ketones. What is the most appropriate explanation for absence of ketoacidosis?","options":{"a":"Increased fatty acid oxidation","b":"Partial insulin activity suppressing lipolysis","c":"Elevated glucagon suppresses ketone formation","d":"Excess cortisol inhibits ketone production"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn hyperglycemic hyperosmolar nonketotic syndrome (HHNS) (glucose 920, high osmolality, pH normal, no ketones, confusion/dehydration), partial insulin activity suppresses lipolysis (preventing ketone production) while failing to suppress glucose production (hyperglycemia persists). Unlike DKA where absolute insulin deficiency allows maximal lipolysis and ketone production, HHNS has sufficient insulin to inhibit ketone formation but insufficient glucose control.\n\n**2. Rationale for Incorrect Options**\n\n- a) Increased fatty acid oxidation: Would increase ketones (opposite of what's seen).\n- c) Elevated glucagon suppresses ketones: Glucagon promotes ketosis (opposite mechanism).\n- d) Excess cortisol: Stress hormone; would promote ketosis, not suppress it.\n\n**3. Exam Essentials**\n\n- HHNS vs DKA: HHNS has no/minimal ketones (partial insulin), very high glucose, extreme hypertonicity; DKA has significant ketones, moderate glucose.\n- Mortality: HHNS higher (10-15%) than DKA; elderly, comorbidities more common.\n- Management: Aggressive fluid resuscitation (higher deficit than DKA), insulin slower than DKA, careful electrolyte correction.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"HHNS vs DKA\":\n- HHNS: Extreme hyperglycemia, NO ketones, extremely hyperosmolar, elderly, sepsis trigger\n- DKA: Moderate glucose elevation, significant ketones, moderate osmolality, younger, primary insulin lack"},{"id":61,"question":"A 58-year-old woman with 15 years of diabetes presents with albuminuria, rising creatinine, and hypertension. Which early pathological change best characterizes her kidney disease?","options":{"a":"Immune complex deposition","b":"Glomerular hyperfiltration and basement membrane thickening","c":"Crescent formation","d":"Mesangial IgA deposition"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nThe earliest pathological change in diabetic nephropathy is glomerular hyperfiltration and basement membrane thickening from hyperglycemia-induced hemodynamic and structural changes. Increased intraglomerular pressure (afferent vasodilation > efferent vasodilation) and GBM thickening occur before proteinuria develops and are potentially reversible with tight glycemic control if addressed early in disease course.\n\n**2. Rationale for Incorrect Options**\n\n- a) Immune complex deposition: Lupus nephritis mechanism; not primary in diabetic disease.\n- c) Crescent formation: Rapidly progressive GN; not typical diabetic nephropathy.\n- d) IgA deposition: IgA nephropathy; unrelated to diabetes directly.\n\n**3. Exam Essentials**\n\n- Diabetic nephropathy stages: Stage 1 (hyperfiltration, GBM thickening) â†’ Stage 2 (silent) â†’ Stage 3 (proteinuria) â†’ Stage 4 (declining GFR).\n- Prevention: Tight glucose control (HbA1c \u003c7%), tight BP control (\u003c130/80), ACE-I/ARB use.\n- Kimmelstiel-Wilson nodules: Nodular mesangial sclerosis; late stage; indicates advanced irreversible disease.\n\n**4. Logical Learning Aid**\n\nNo well-established, logical learning aid (mnemonic/trick) is required or available for this concept."},{"id":62,"question":"A 48-year-old man with newly diagnosed type 2 diabetes (HbA1c 8.2%) is overweight with normal kidney and liver function. He has no cardiovascular disease. What is the best initial medication?","options":{"a":"Basal insulin","b":"Metformin","c":"Sulfonylurea","d":"Pioglitazone"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn newly diagnosed type 2 diabetes (HbA1c 8.2%, overweight, normal renal/hepatic function, no cardiovascular disease), metformin is the best initial medication. Metformin reduces hepatic glucose output, improves insulin sensitivity, is weight-neutral, has cardiovascular benefits, and is inexpensive. First-line in type 2 DM guidelines (ADA, EASD) unless contraindicated (eGFR \u003c30, hepatic disease, alcoholism).\n\n**2. Rationale for Incorrect Options**\n\n- a) Basal insulin: Reserved for more advanced disease or failure of other agents.\n- c) Sulfonylurea: Older agent; risk of hypoglycemia, weight gain; second-line now.\n- d) Pioglitazone: TZD; third-line; weight gain, fluid retention, bladder cancer risk.\n\n**3. Exam Essentials**\n\n- Metformin mechanism: AMPK activation â†’ reduced hepatic gluconeogenesis, improved insulin sensitivity.\n- Current approach: Metformin + second agent (GLP-1 agonist if CV disease, SGLT2i if HF, others as needed).\n- Monitoring: HbA1c goal \u003c7% (individualized); renal function (metformin contraindicated if eGFR \u003c30).\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Type 2 DM Medication Approach\":\n- Metformin (first-line, standard)\n- Add GLP-1 agonist (if CV disease)\n- Add SGLT2i (if heart failure or CKD)\n- Add DPP-4i or TZD (alternative options)\n- Add sulfonylurea (if above failed; hypoglycemia risk)\n- Add insulin (if above failed; progressive disease)"},{"id":63,"question":"A 52-year-old man who immigrated from an HBV-endemic country is evaluated for mildly abnormal liver enzymes. He denies ever being diagnosed with hepatitis. His detailed serology panel shows: HBsAg: Negative; Anti-HBc IgG: Positive; Anti-HBc IgM: Negative; Anti-HBs: Positive; HBeAg: Negative; Anti-HBe: Positive; HBV DNA: Undetectable. Liver ultrasound shows no fibrosis. Which explanation BEST fits this profile?","options":{"a":"Vaccination immunity","b":"Occult HBV infection with undetectable HBV DNA","c":"Past natural infection with complete recovery and resolved viremia","d":"False-positive anti-HBc due to cross-reactive antibody"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nPast resolved HBV infection with complete recovery shows HBsAgâˆ’, Anti-HBc IgG+, Anti-HBc IgMâˆ’, Anti-HBs+, HBeAgâˆ’, Anti-HBe+, HBV DNA undetectable, normal liver ultrasound. This confirms successful clearance of virus and development of immunity (Anti-HBs presence). This pattern indicates the patient is immune and cannot be reinfected.\n\n**2. Rationale for Incorrect Options**\n\n- a) Vaccination immunity: Anti-HBs+ only; Anti-HBc always negative (no prior infection exposure).\n- b) Occult HBV: HBsAgâˆ’ but HBV DNA detectable in serum/liver; DNA here undetectable.\n- d) False-positive anti-HBc: Possible but anti-HBs presence indicates true past infection with recovery.\n\n**3. Exam Essentials**\n\n- Past resolved HBV: Complete immune response; Anti-HBc and Anti-HBs both positive; HBsAg negative.\n- Immunity confirmation: Anti-HBs >10 mIU/mL indicates protective immunity.\n- Clinical significance: Patient safe; cannot transmit virus; immune to reinfection.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"HBV Serology Interpretation\":\n- HBsAg+: Current infection (acute or chronic)\n- Anti-HBc IgM+: Acute infection (early marker)\n- Anti-HBc IgG+: Past exposure (acute resolved or chronic)\n- Anti-HBs+: Immunity (vaccination or past infection recovery)"},{"id":64,"question":"A researcher is studying viral antigen distribution in patients with acute HBV infection. In one patient, serum testing reveals: HBsAg: Strongly positive; HBeAg: Positive; HBV DNA: High; Anti-HBc IgM: Positive; Anti-HBc IgG: Negative. Despite extensive testing using highly sensitive assays, one HBV antigen remains completely undetectable in serum. Which antigen is it?","options":{"a":"HBeAg","b":"HBcAg","c":"HBsAg","d":"Pre-core mutant HBeAg"},"correctAnswer":"b","explanation":"**1. High-Yield Topic Explanation**\n\nIn acute HBV infection, despite high HBsAg, HBeAg, HBV DNA, and Anti-HBc IgM positivity, HBcAg (hepatitis B core antigen) remains undetectable in serum. This is because HBcAg is located inside the virion (core) and does not circulate as free antigen; only HBeAg (e antigen, derived from core) appears in serum as marker of active replication. HBcAg can be detected in liver biopsy but not serum.\n\n**2. Rationale for Incorrect Options**\n\n- a) HBeAg: Detectable; marker of active replication.\n- c) HBsAg: Detectable; surface antigen present in acute infection.\n- d) Pre-core mutant HBeAg: Rare variant; not undetectable in typical acute HBV.\n\n**3. Exam Essentials**\n\n- HBcAg location: Core protein; intracellular/intraviral; not released as free serum antigen.\n- HBeAg vs HBcAg: HBeAg is e antigen (cleaved from core, soluble); appears in serum as marker of replication.\n- Clinical relevance: HBcAg only relevant on liver histology; serum testing focuses on HBsAg, HBeAg, Anti-HBc.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"HBV Antigen Detection\":\n- HBsAg: âœ“ Serum (surface antigen)\n- HBeAg: âœ“ Serum (e antigen, active replication marker)\n- HBcAg: âœ— NOT in serum (core antigen, intraviral only)\n- Anti-HBc: âœ“ Serum (antibody to core)"},{"id":65,"question":"A 25-year-old healthcare worker undergoes routine screening before hospital employment. She has never had hepatitis B infection. Her serology results are: HBsAg: Negative; Anti-HBc (total): Negative Anti-HBs: Positive (high titer). Which interpretation is correct?","options":{"a":"Acute resolving hepatitis B","b":"Chronic hepatitis B","c":"Immunity due to vaccination","d":"Immunity due to past infection"},"correctAnswer":"c","explanation":"**1. High-Yield Topic Explanation**\n\nHBV vaccination immunity produces Anti-HBs+ (antibody to surface antigen) ONLY; HBsAg and Anti-HBc are always negative because vaccination uses surface antigen without core antigen exposure. This serological pattern (Anti-HBs+ with HBsAgâˆ’ and Anti-HBcâˆ’) is pathognomonic for vaccination-induced immunity and distinguishes it from past natural infection (which would have Anti-HBc+).\n\n**2. Rationale for Incorrect Options**\n\n- a) Acute resolving: Would have HBsAg+ and Anti-HBc IgM+ in acute phase; different pattern.\n- b) Chronic HBV: HBsAg+ (persistent); Anti-HBc IgG+ (chronic phase).\n- d) Immunity from past infection: Would have Anti-HBc+ (infection exposure); vaccination has Anti-HBcâˆ’.\n\n**3. Exam Essentials**\n\n- Vaccination response: Anti-HBs develops; titer typically >100 mIU/mL protective.\n- Anti-HBc absence: Key distinguishing factor; vaccination alone does NOT produce Anti-HBc.\n- Immunity assessment: Anti-HBs >10 mIU/mL indicates immunity; >100 is robust protection.\n\n**4. Logical Learning Aid**\n\nMnemonic â€“ \"Vaccinated vs Past Infection Serology\":\n- Vaccinated: Anti-HBs+ ONLY (HBsAgâˆ’, Anti-HBcâˆ’)\n- Past infection recovered: Anti-HBs+ AND Anti-HBc+ (HBsAgâˆ’)\n- Chronic HBV: HBsAg+ (persistent), Anti-HBc IgG+\n- Acute HBV: HBsAg+, Anti-HBc IgM+"}];
        const images = [];
        const initialMcqsState = JSON.parse(JSON.stringify(mcqs)); // For exam reset
        let currentMcqs = []; // Can be a subset for practice mode
        let sections = [];
        let answerStates = [];
        let practiceStates = [];
        let currentSectionIndex = 0;
        let currentQuestionIndexInSection = 0;
        let currentPracticeIndex = 0;
        let timerInterval;
        let practiceTimerInterval;
        let perQuestionTimerInterval;
        let timePerMcq = 0;
        let timeOverall = 0;
        let questionStartTime = 0;
        let subjectName, candidateName, shortNote;
        let onConfirmCallback = null;
        let reviewReturnScreen = 'results'; // 'results' or 'practiceResults'
        let isShuffled = false;
        let isReviewingSaved = false;
        // FIX: Changed to string concatenation to avoid nested template literal parsing issues.
        const EXAM_DRAFT_KEY = 'examDraft_' + examId;
        const PRACTICE_DRAFT_KEY = 'practiceDraft_' + examId;
        const SAVED_MCQS_KEY = 'savedMcqs_' + examId;
        const EXAM_RESULTS_HISTORY_KEY = 'examResultsHistory_' + examId;
        const PRACTICE_RESULTS_HISTORY_KEY = 'practiceResultsHistory_' + examId;
        const THEME_KEY = 'examTheme_' + examId;
        let savedMcqIds = [];
        let isSmoothSwipe = true;
        let isSparklesEnabled = true;
        
        // --- GAMIFICATION STATE ---
        let currentStreak = 0;

        const QuestionStatus = {
            NotVisited: 'NOT_VISITED',
            NotAnswered: 'NOT_ANSWERED',
            Answered: 'ANSWERED',
            MarkedForReview: 'MARKED_FOR_REVIEW',
        };
        
        const statusColors = {
            [QuestionStatus.Answered]: 'bg-green-600 hover:bg-green-500',
            [QuestionStatus.NotAnswered]: 'bg-red-600 hover:bg-red-500',
            [QuestionStatus.NotVisited]: 'bg-gray-500 hover:bg-gray-600',
            [QuestionStatus.MarkedForReview]: 'bg-purple-600 hover:bg-purple-500',
        };

        const svgBookmarkOutline = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" style="color: var(--text-secondary);" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>';
        const svgBookmarkSolid = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" style="color: var(--text-accent);" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path></svg>';

        // --- DOM ELEMENTS ---
        const screens = {
            setup: document.getElementById('setup-screen'),
            exam: document.getElementById('exam-screen'),
            results: document.getElementById('results-screen'),
            review: document.getElementById('review-screen'),
            practice: document.getElementById('practice-screen'),
            practiceResults: document.getElementById('practice-results-screen'),
            pastResults: document.getElementById('past-results-screen'),
            progress: document.getElementById('progress-screen'),
        };
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessageEl = document.getElementById('confirmation-message');
        const confirmActionBtn = document.getElementById('confirm-action-btn');
        const cancelConfirmationBtn = document.getElementById('cancel-confirmation-btn');
        const reportOptionsModal = document.getElementById('report-options-modal');
        const calculatorModal = document.getElementById('calculator-modal');
        const questionPalette = document.getElementById('question-palette');
        const paletteContentWrapper = document.getElementById('palette-content-wrapper');
        const hidePaletteBtn = document.getElementById('hide-palette-btn');
        const showPaletteBtn = document.getElementById('show-palette-btn');
        const practiceResumeModal = document.getElementById('practice-resume-modal');
        const savedQuestionsContainer = document.getElementById('saved-questions-container');
        const viewSavedBtn = document.getElementById('view-saved-btn');
        const savedQuestionsCountEl = document.getElementById('saved-questions-count');
        const saveMcqBtn = document.getElementById('save-mcq-btn');
        const saveMcqPracticeBtn = document.getElementById('save-mcq-practice-btn');
        const toggleSparklesBtn = document.getElementById('toggle-sparkles-btn');
        const reviewTitleEl = document.getElementById('review-title');
        const toastEl = document.getElementById('toast-notification');
        
        // --- CONFETTI LOGIC (Gravity Burst) ---
        function triggerConfetti(rect) {
            if (!isSparklesEnabled) return;
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const colors = ['#EF476F', '#FFD166', '#06D6A0', '#118AB2', '#073B4C', '#9D4EDD'];
            
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.style.position = 'fixed';
                particle.style.left = centerX + 'px';
                particle.style.top = centerY + 'px';
                particle.style.width = (Math.random() * 10 + 5) + 'px';
                particle.style.height = particle.style.width;
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                particle.style.zIndex = '9999';
                particle.style.pointerEvents = 'none';
                
                // Random Shapes: Square, Circle, Triangle, Star
                const shapeType = Math.floor(Math.random() * 4);
                if (shapeType === 1) { // Circle
                    particle.style.borderRadius = '50%';
                } else if (shapeType === 2) { // Triangle
                     particle.style.width = '0'; 
                     particle.style.height = '0'; 
                     particle.style.backgroundColor = 'transparent';
                     particle.style.borderLeft = '6px solid transparent';
                     particle.style.borderRight = '6px solid transparent';
                     particle.style.borderBottom = '12px solid ' + colors[Math.floor(Math.random() * colors.length)];
                } else if (shapeType === 3) { // Star (using clip-path)
                     particle.style.clipPath = 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)';
                }
                // shapeType 0 is Square (default)

                document.body.appendChild(particle);

                // Physics variables
                // Burst effect: high velocity, random angle
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 15 + 5; 
                let vx = Math.cos(angle) * velocity;
                let vy = Math.sin(angle) * velocity;
                const gravity = 0.8;
                const drag = 0.96;
                let posX = centerX;
                let posY = centerY;
                let rotation = Math.random() * 360;
                let rotationSpeed = (Math.random() - 0.5) * 20;
                let opacity = 1;

                function animate() {
                    posX += vx;
                    posY += vy;
                    vy += gravity; // Apply gravity
                    vx *= drag;    // Air resistance
                    vy *= drag;
                    rotation += rotationSpeed;
                    opacity -= 0.01;

                    particle.style.left = posX + 'px';
                    particle.style.top = posY + 'px';
                    if (shapeType !== 2) { 
                        particle.style.transform = 'rotate(' + rotation + 'deg)';
                    } else {
                        particle.style.transform = 'rotate(' + rotation + 'deg)';
                    }
                    particle.style.opacity = opacity;

                    if (opacity > 0 && posY < window.innerHeight) {
                        requestAnimationFrame(animate);
                    } else {
                        particle.remove();
                    }
                }
                
                requestAnimationFrame(animate);
            }
        }

        // --- DYNAMIC ISLAND LOGIC ---
        const island = document.getElementById('dynamic-island');
        const islandMinimizeBtn = document.getElementById('island-minimize-btn');
        const islandThemeBtn = document.getElementById('island-theme-btn');
        const islandSettingsBtn = document.getElementById('island-settings-btn');
        const islandProgressBtn = document.getElementById('island-progress-btn');
        const islandHomeBtn = document.getElementById('island-home-btn');
        const swipeIconSmooth = document.getElementById('swipe-icon-smooth');
        const swipeIconHard = document.getElementById('swipe-icon-hard');
        
        let islandIdleTimeout;
        let isMinimized = false;
        
        function resetIslandIdle() {
            if (isMinimized) return; // Don't fade out if minimized (handled by style)
            island.classList.remove('idle');
            if (islandIdleTimeout) clearTimeout(islandIdleTimeout);
            islandIdleTimeout = setTimeout(() => {
                island.classList.add('idle');
            }, 3000);
        }

        // Initialize drag for Dynamic Island
        function initDynamicIsland() {
            // Trigger startup vibration
            island.classList.add('hint-anim');
            setTimeout(() => { island.classList.remove('hint-anim'); }, 1000);

            let isDragging = false;
            let dragOffsetX, dragOffsetY;
            const threshold = 5; // Movement threshold

            const onStart = (clientX, clientY) => {
                if (isMinimized) return;
                
                // Calculate offset from the top-left of the island to the cursor
                const rect = island.getBoundingClientRect();
                dragOffsetX = clientX - rect.left;
                dragOffsetY = clientY - rect.top;
                
                isDragging = false;
                resetIslandIdle();
                
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchmove', onTouchMove, { passive: false });
                document.addEventListener('touchend', onEnd);
            };
            
            const onMove = (e) => handleMove(e.clientX, e.clientY);
            const onTouchMove = (e) => {
                if (isMinimized) return;
                e.preventDefault();
                handleMove(e.touches[0].clientX, e.touches[0].clientY);
            };

            const handleMove = (clientX, clientY) => {
                if (!isDragging) {
                    // Check if moved enough to count as drag
                    isDragging = true;
                    island.classList.add('dragging'); // Disables transition for 1:1 tracking
                    
                    // Clear transform logic used for centering, switch to absolute pos
                    island.style.transform = 'none';
                    island.style.right = 'auto'; 
                    island.style.bottom = 'auto';
                }

                // Move exactly with cursor
                island.style.left = (clientX - dragOffsetX) + 'px';
                island.style.top = (clientY - dragOffsetY) + 'px';
                resetIslandIdle();
            };

            const onEnd = () => {
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchmove', onTouchMove);
                document.removeEventListener('touchend', onEnd);
                
                if (isDragging) {
                    island.classList.remove('dragging'); // Re-enable transition for snap
                    snapIsland();
                }
            };
            
            island.addEventListener('mousedown', (e) => {
                if (isMinimized) return;
                if (e.target.closest('button')) return;
                onStart(e.clientX, e.clientY);
            });
            
            island.addEventListener('touchstart', (e) => {
                if (isMinimized) return;
                if (e.target.closest('button')) return;
                onStart(e.touches[0].clientX, e.touches[0].clientY);
            }, { passive: false });
            
            island.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', resetIslandIdle);
            });
            
            island.addEventListener('click', (e) => {
                if (isMinimized && !e.target.closest('button')) {
                    toggleMinimize();
                }
            });
            
            resetIslandIdle();
        }
        
        function snapIsland() {
            const rect = island.getBoundingClientRect();
            const winW = window.innerWidth;
            const winH = window.innerHeight;
            
            const distTop = rect.top;
            const distBottom = winH - rect.bottom;
            const distLeft = rect.left;
            const distRight = winW - rect.right;
            
            const minDist = Math.min(distTop, distBottom, distLeft, distRight);
            const padding = 20;

            island.classList.remove('horizontal', 'vertical');

            // Snap logic
            if (minDist === distTop) {
                island.style.top = padding + 'px';
                island.style.bottom = 'auto';
                island.classList.add('horizontal');
            } else if (minDist === distBottom) {
                island.style.top = 'auto';
                island.style.bottom = padding + 'px';
                island.classList.add('horizontal');
            } else if (minDist === distLeft) {
                island.style.left = padding + 'px';
                island.style.right = 'auto';
                island.classList.add('vertical');
            } else { // Right
                island.style.left = 'auto';
                island.style.right = padding + 'px';
                island.classList.add('vertical');
            }
            
            // Constrain within window
            const newRect = island.getBoundingClientRect();
            if (island.classList.contains('horizontal')) {
               if(newRect.left < 0) island.style.left = padding + 'px';
               if(newRect.right > winW) island.style.left = (winW - newRect.width - padding) + 'px';
            } else {
               if(newRect.top < 0) island.style.top = padding + 'px';
               if(newRect.bottom > winH) island.style.top = (winH - newRect.height - padding) + 'px';
            }
        }
        
        function toggleMinimize() {
            isMinimized = !isMinimized;
            
            if (isMinimized) {
                island.classList.add('minimized');
                // Force snap to closest wall with 0 padding for the "dash" look
                const rect = island.getBoundingClientRect();
                const winW = window.innerWidth;
                const winH = window.innerHeight;
                
                // Determine orientation based on current class
                if (island.classList.contains('horizontal')) {
                    if (rect.top < winH / 2) { // Top wall
                        island.style.top = '0px';
                        island.style.bottom = 'auto';
                    } else { // Bottom wall
                        island.style.top = 'auto';
                        island.style.bottom = '0px';
                    }
                } else { // Vertical
                     if (rect.left < winW / 2) { // Left wall
                        island.style.left = '0px';
                        island.style.right = 'auto';
                    } else { // Right wall
                        island.style.left = 'auto';
                        island.style.right = '0px';
                    }
                }
            } else {
                island.classList.remove('minimized');
                snapIsland(); // Restore to padded position
                resetIslandIdle();
            }
        }
        
        initDynamicIsland();

        islandMinimizeBtn.addEventListener('click', toggleMinimize);
        
        const themes = ['light', 'dark', 'ambient'];
        islandThemeBtn.addEventListener('click', (e) => {
            const currentTheme = document.documentElement.dataset.theme || 'light';
            const currentIndex = themes.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % themes.length;
            const newTheme = themes[nextIndex];
            
            // Fix: Ensure coordinates are valid for touch/click
            const x = (e.clientX !== undefined && e.clientX !== 0) ? e.clientX : window.innerWidth / 2;
            const y = (e.clientY !== undefined && e.clientY !== 0) ? e.clientY : window.innerHeight / 2;
            
            const endRadius = Math.hypot(
                Math.max(x, innerWidth - x),
                Math.max(y, innerHeight - y)
            );

            // View Transition API for "Sunrise" effect
            if (document.startViewTransition) {
                 const transition = document.startViewTransition(() => {
                    applyTheme(newTheme);
                });

                transition.ready.then(() => {
                    // Animate the clip-path of the new view
                    document.documentElement.animate(
                        {
                            clipPath: [
                                `circle(0px at ${x}px ${y}px)`,
                                `circle(${endRadius}px at ${x}px ${y}px)`
                            ],
                        },
                        {
                            duration: 500,
                            easing: 'ease-in',
                            pseudoElement: '::view-transition-new(root)',
                        }
                    );
                });
            } else {
                // Fallback Animation for devices without View Transition API
                 const themeColors = {
                    'light': '#f3f4f6',
                    'dark': '#374151',
                    'ambient': '#eee8d5'
                };
                
                const overlay = document.createElement('div');
                overlay.style.position = 'fixed';
                overlay.style.top = y + 'px';
                overlay.style.left = x + 'px';
                overlay.style.width = '0px';
                overlay.style.height = '0px';
                overlay.style.borderRadius = '50%';
                overlay.style.backgroundColor = themeColors[newTheme];
                overlay.style.zIndex = '10000';
                overlay.style.transform = 'translate(-50%, -50%)';
                overlay.style.pointerEvents = 'none';
                document.body.appendChild(overlay);
                
                const anim = overlay.animate(
                    [{ width: '0px', height: '0px' }, { width: (endRadius * 2) + 'px', height: (endRadius * 2) + 'px' }],
                    { duration: 500, easing: 'ease-in', fill: 'forwards' }
                );
                
                anim.onfinish = () => {
                    applyTheme(newTheme);
                    overlay.remove();
                };
            }
        });
        
        islandSettingsBtn.addEventListener('click', () => {
            isSmoothSwipe = !isSmoothSwipe;
            if (isSmoothSwipe) {
                document.documentElement.style.setProperty('--swipe-duration', '0.3s');
                swipeIconSmooth.classList.remove('hidden');
                swipeIconHard.classList.add('hidden');
                showToast("Swipe Animation: Smooth");
            } else {
                document.documentElement.style.setProperty('--swipe-duration', '0s');
                swipeIconSmooth.classList.add('hidden');
                swipeIconHard.classList.remove('hidden');
                showToast("Swipe Animation: Instant");
            }
        });
        
        islandProgressBtn.addEventListener('click', () => {
            switchScreen('progress');
            renderProgressCharts();
        });

        islandHomeBtn.addEventListener('click', () => {
            const currentScreenId = document.querySelector('.screen.active')?.id;
            const goHome = () => {
                 if (document.startViewTransition) {
                     document.startViewTransition(() => switchScreen('setup'));
                 } else {
                     switchScreen('setup');
                 }
            };
            
            if (currentScreenId === 'exam-screen') {
                showConfirmation("Exit exam and go home? Progress is saved locally.", () => {
                    saveExamDraft();
                    goHome();
                });
            } else if (currentScreenId === 'practice-screen') {
                 showConfirmation("Exit practice session?", () => {
                    savePracticeDraft();
                    goHome();
                 });
            } else {
                goHome();
            }
        });

        // --- THEME LOGIC ---
        function applyTheme(theme) {
            document.documentElement.dataset.theme = theme;
            try {
                localStorage.setItem(THEME_KEY, theme);
            } catch (e) { console.error('Failed to save theme'); }
        }

        // --- UTILS ---
        let toastTimeout;
        function showToast(message) {
            if (toastTimeout) clearTimeout(toastTimeout);
            toastEl.textContent = message;
            toastEl.classList.add('show');
            toastTimeout = setTimeout(() => {
                toastEl.classList.remove('show');
            }, 3000);
        }
        
        function animateButton(buttonEl) {
            buttonEl.classList.remove('pop-animation');
            // This is a trick to restart the animation
            void buttonEl.offsetWidth; 
            buttonEl.classList.add('pop-animation');
        }

        function showConfirmation(message, onConfirm) {
            onConfirmCallback = onConfirm;
            confirmationMessageEl.textContent = message;
            confirmationModal.classList.remove('hidden');
            confirmationModal.classList.add('flex');
        }

        function hideConfirmation() {
            onConfirmCallback = null;
            confirmationModal.classList.add('hidden');
            confirmationModal.classList.remove('flex');
        }

        confirmActionBtn.addEventListener('click', () => {
            if (onConfirmCallback) {
                onConfirmCallback();
            }
            hideConfirmation();
        });

        cancelConfirmationBtn.addEventListener('click', hideConfirmation);

        // --- HISTORY API INTEGRATION ---
        
        // Initialize history state on load
        window.history.replaceState({ screen: 'setup' }, '', '#setup');

        function switchScreen(screenName, pushToHistory = true) {
            Object.values(screens).forEach(screen => {
                if(screen) screen.classList.remove('active');
            });
            if(screens[screenName]) {
                screens[screenName].classList.add('active');
                if (pushToHistory) {
                    window.history.pushState({ screen: screenName }, '', '#' + screenName);
                }
            }
        }

        window.addEventListener('popstate', (event) => {
            const activeScreen = document.querySelector('.screen.active');
            const activeId = activeScreen ? activeScreen.id : 'setup-screen';

            // GUARD: Prevent exiting Exam Mode accidentally
            if (activeId === 'exam-screen') {
                // Push state back immediately to maintain URL/State stability while showing modal
                window.history.pushState({ screen: 'exam' }, '', '#exam');
                showConfirmation("Are you sure you want to exit the exam? Your progress will be saved.", () => {
                    // If confirmed, proceed to finish exam (which goes to results)
                    handleNextSection(); 
                });
                return;
            }

            // GUARD: Prevent exiting Practice Mode accidentally
            if (activeId === 'practice-screen') {
                 window.history.pushState({ screen: 'practice' }, '', '#practice');
                 showConfirmation("Are you sure you want to exit practice mode?", () => {
                    if (practiceTimerInterval) clearInterval(practiceTimerInterval);
                    if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
                    recordTime(currentMcqs[currentPracticeIndex].id, practiceStates);
                    showPracticeResults();
                 });
                 return;
            }

            // Normal Navigation handling
            if (event.state && event.state.screen) {
                switchScreen(event.state.screen, false); // false = don't push again
            } else {
                switchScreen('setup', false);
            }
        });

        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function formatTime(seconds) {
            const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
            const secs = String(seconds % 60).padStart(2, '0');
            return mins + ':' + secs;
        }
        
        function formatTimeDetailed(seconds) {
            if (seconds < 60) return Math.round(seconds) + 's';
            const mins = Math.floor(seconds / 60);
            const secs = Math.round(seconds % 60);
            return mins + 'm ' + secs + 's';
        }

        function processQuestionContent(text, imageContainerId) {
            const imageContainer = document.getElementById(imageContainerId);
            imageContainer.innerHTML = ''; // Clear previous image

            const imageRegex = /{image\s+(\d+)}/g;
            let processedText = text;
            
            let match;
            const displayedImageIndices = new Set();
            while ((match = imageRegex.exec(text)) !== null) {
                const imageIndex = parseInt(match[1], 10) - 1;
                if (images[imageIndex] && !displayedImageIndices.has(imageIndex)) {
                    const img = document.createElement('img');
                    img.src = images[imageIndex];
                    img.alt = 'Illustration for question';
                    img.className = 'max-w-full max-h-96 object-contain rounded-md shadow-sm border mx-auto themed-border-primary';
                    imageContainer.appendChild(img);
                    displayedImageIndices.add(imageIndex);
                }
                processedText = processedText.replace(match[0], '');
            }
            
            return processedText.trim();
        }

        // --- TIME TRACKING LOGIC ---
        function recordTime(mcqId, stateCollection) {
            if (!mcqId || !questionStartTime) return;
            const state = stateCollection.find(s => s.mcqId === mcqId);
            if (state) {
                const elapsed = (Date.now() - questionStartTime) / 1000; // in seconds
                state.timeTaken = (state.timeTaken || 0) + elapsed;
            }
        }

        // --- DRAFT LOGIC ---
        function saveExamDraft() {
            try {
                recordTime(currentMCQ.id, answerStates);
                const draft = {
                    mcqs: currentMcqs, // Save potentially shuffled list
                    sections,
                    answerStates,
                    currentSectionIndex,
                    currentQuestionIndexInSection,
                    subjectName,
                    candidateName,
                    shortNote,
                    isShuffled,
                };
                localStorage.setItem(EXAM_DRAFT_KEY, JSON.stringify(draft));
                questionStartTime = Date.now(); // Reset timer after saving
            } catch (e) {
                console.error("Failed to save exam draft:", e);
            }
        }
        
        function savePracticeDraft() {
            try {
                recordTime(currentMcqs[currentPracticeIndex].id, practiceStates);
                const draft = {
                    mcqs: currentMcqs, // Save the subset of MCQs
                    practiceStates,
                    currentPracticeIndex,
                    subjectName,
                    candidateName,
                    isShuffled,
                    timePerMcq,
                    timeOverall,
                    currentStreak, // Save streak
                };
                localStorage.setItem(PRACTICE_DRAFT_KEY, JSON.stringify(draft));
                questionStartTime = Date.now(); // Reset timer after saving
            } catch (e) {
                console.error("Failed to save practice draft:", e);
            }
        }

        function clearExamDraft() { localStorage.removeItem(EXAM_DRAFT_KEY); }
        function clearPracticeDraft() { localStorage.removeItem(PRACTICE_DRAFT_KEY); }
        
        // --- SAVED QUESTIONS LOGIC ---
        function updateSavedQuestionsUI() {
            if (savedMcqIds.length > 0) {
                savedQuestionsCountEl.textContent = savedMcqIds.length;
                savedQuestionsContainer.classList.remove('hidden');
            } else {
                savedQuestionsContainer.classList.add('hidden');
            }
        }

        function toggleSaveMcq() {
            const mcq = currentMcqs[reviewQuestionIndex];
            if (!mcq) return;

            const mcqId = mcq.id;
            const index = savedMcqIds.indexOf(mcqId);
            let message = '';

            if (index > -1) {
                savedMcqIds.splice(index, 1);
                message = 'Question Unsaved!';
            } else {
                savedMcqIds.push(mcqId);
                message = 'Question Saved!';
                animateButton(saveMcqBtn);
            }

            showToast(message);
            localStorage.setItem(SAVED_MCQS_KEY, JSON.stringify(savedMcqIds));
            updateSaveButtonState();
            updateSavedQuestionsUI();

            if (isReviewingSaved && savedMcqIds.length === 0) {
                alert("You have no saved questions.");
                switchScreen('setup');
            } else if (isReviewingSaved) {
                // Refresh the view if an item is removed
                currentMcqs = initialMcqsState.filter(mcq => savedMcqIds.includes(mcq.id));
                if (reviewQuestionIndex >= currentMcqs.length) {
                    reviewQuestionIndex = Math.max(0, currentMcqs.length - 1);
                }
                renderReviewPalette();
                renderReviewQuestion();
            }
        }
        
        function toggleSavePracticeMcq() {
            const mcq = currentMcqs[currentPracticeIndex];
            if (!mcq) return;

            const mcqId = mcq.id;
            const index = savedMcqIds.indexOf(mcqId);
            let message = '';

            if (index > -1) {
                savedMcqIds.splice(index, 1);
                message = 'Question Unsaved!';
            } else {
                savedMcqIds.push(mcqId);
                message = 'Question Saved!';
                animateButton(saveMcqPracticeBtn);
            }
            
            showToast(message);
            localStorage.setItem(SAVED_MCQS_KEY, JSON.stringify(savedMcqIds));
            updatePracticeSaveButtonState();
            updateSavedQuestionsUI();
        }

        function updateSaveButtonState() {
            const mcq = currentMcqs[reviewQuestionIndex];
            if (!mcq) return;

            if (savedMcqIds.includes(mcq.id)) {
                saveMcqBtn.innerHTML = svgBookmarkSolid;
                saveMcqBtn.setAttribute('aria-label', 'Unsave Question');
            } else {
                saveMcqBtn.innerHTML = svgBookmarkOutline;
                saveMcqBtn.setAttribute('aria-label', 'Save Question');
            }
        }
        
        function updatePracticeSaveButtonState() {
            const mcq = currentMcqs[currentPracticeIndex];
            if (!mcq) return;

            if (savedMcqIds.includes(mcq.id)) {
                saveMcqPracticeBtn.innerHTML = svgBookmarkSolid;
                saveMcqPracticeBtn.setAttribute('aria-label', 'Unsave Question');
            } else {
                saveMcqPracticeBtn.innerHTML = svgBookmarkOutline;
                saveMcqPracticeBtn.setAttribute('aria-label', 'Save Question');
            }
        }

        // --- PALETTE VISIBILITY LOGIC ---
        if(hidePaletteBtn && showPaletteBtn && questionPalette && paletteContentWrapper) {
            hidePaletteBtn.addEventListener('click', () => {
                questionPalette.classList.remove('w-64');
                questionPalette.classList.add('w-0');
                paletteContentWrapper.classList.add('opacity-0');
                hidePaletteBtn.classList.add('hidden');
                showPaletteBtn.classList.remove('hidden');
            });

            showPaletteBtn.addEventListener('click', () => {
                questionPalette.classList.remove('w-0');
                questionPalette.classList.add('w-64');
                paletteContentWrapper.classList.remove('opacity-0');
                showPaletteBtn.classList.add('hidden');
                hidePaletteBtn.classList.remove('hidden');
            });
        }

        // --- CALCULATOR LOGIC ---
        const calculatorHeader = document.getElementById('calculator-header');
        const calculatorCloseBtn = document.getElementById('calculator-close-btn');
        const calculatorDisplay = document.getElementById('calculator-display');
        const calculatorButtons = document.getElementById('calculator-buttons');
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };

        function toggleCalculator(buttonEl) {
            const wasHidden = calculatorModal.classList.contains('hidden');
            
            if (wasHidden) {
                const rect = buttonEl.getBoundingClientRect();
                const calculatorWidth = 256; // Corresponds to Tailwind's w-64 class
                
                // Position it below the button, accounting for page scroll
                calculatorModal.style.top = (rect.bottom + window.scrollY + 10) + 'px';
                
                // Center it horizontally under the button
                let leftPos = rect.left + window.scrollX + (rect.width / 2) - (calculatorWidth / 2);
                
                // Constrain to viewport horizontal edges
                const minLeft = window.scrollX + 8;
                const maxLeft = window.scrollX + window.innerWidth - calculatorWidth - 8;
                leftPos = Math.max(minLeft, Math.min(leftPos, maxLeft));

                calculatorModal.style.left = leftPos + 'px';
            }
             
            calculatorModal.classList.toggle('hidden');
        }
        document.getElementById('calculator-toggle-btn').addEventListener('click', (e) => toggleCalculator(e.currentTarget));
        document.getElementById('practice-calculator-toggle-btn').addEventListener('click', (e) => toggleCalculator(e.currentTarget));
        
        calculatorCloseBtn.addEventListener('click', () => {
            calculatorModal.classList.add('hidden');
        });

        function dragStart(clientX, clientY) {
            isDragging = true;
            dragOffset.x = clientX - calculatorModal.offsetLeft;
            dragOffset.y = clientY - calculatorModal.offsetTop;
            calculatorModal.classList.add('dragging');
            document.body.style.userSelect = 'none'; // Prevent text selection
        }

        function dragMove(clientX, clientY) {
            if (!isDragging) return;
            const newX = clientX - dragOffset.x;
            const newY = clientY - dragOffset.y;
            const maxX = window.innerWidth - calculatorModal.offsetWidth;
            const maxY = window.innerHeight - calculatorModal.offsetHeight;
            calculatorModal.style.left = Math.max(0, Math.min(newX, maxX)) + 'px';
            calculatorModal.style.top = Math.max(0, Math.min(newY, maxY)) + 'px';
        }

        function dragEnd() {
            if (!isDragging) return;
            isDragging = false;
            calculatorModal.classList.remove('dragging');
            document.body.style.userSelect = '';
        }

        // Mouse Events
        calculatorHeader.addEventListener('mousedown', (e) => {
            e.preventDefault();
            dragStart(e.clientX, e.clientY);
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                dragMove(e.clientX, e.clientY);
            }
        });
        
        document.addEventListener('mouseup', dragEnd);

        // Touch Events
        calculatorHeader.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                dragStart(e.touches[0].clientX, e.touches[0].clientY);
            }
        }, { passive: true });

        document.addEventListener('touchmove', (e) => {
            if (isDragging && e.touches.length === 1) {
                e.preventDefault(); // Prevent scrolling while dragging
                dragMove(e.touches[0].clientX, e.touches[0].clientY);
            }
        }, { passive: false });

        document.addEventListener('touchend', dragEnd);
        document.addEventListener('touchcancel', dragEnd);


        const calculatorState = {
            displayValue: '0',
            fullExpression: '', // Holds the full visual string e.g. "6+5"
            firstOperand: null,
            waitingForSecondOperand: false,
            operator: null,
            isResultDisplayed: false
        };

        function updateCalculatorDisplay() {
            calculatorDisplay.textContent = calculatorState.fullExpression || '0';
            calculatorDisplay.scrollLeft = calculatorDisplay.scrollWidth;
        }

        function inputDigit(digit) {
            if (calculatorState.isResultDisplayed) {
                calculatorState.fullExpression = digit;
                calculatorState.displayValue = digit;
                calculatorState.firstOperand = null;
                calculatorState.waitingForSecondOperand = false;
                calculatorState.operator = null;
                calculatorState.isResultDisplayed = false;
                return;
            }

            // Append to full expression, replacing single '0' unless digit is '.'
            if (calculatorState.fullExpression === '0') {
                calculatorState.fullExpression = digit;
            } else {
                calculatorState.fullExpression += digit;
            }

            const { displayValue, waitingForSecondOperand } = calculatorState;
            if (waitingForSecondOperand) {
                calculatorState.displayValue = digit;
                calculatorState.waitingForSecondOperand = false;
            } else {
                calculatorState.displayValue = displayValue === '0' ? digit : displayValue + digit;
            }
        }

        function inputDecimal(dot) {
            if (calculatorState.isResultDisplayed) {
                calculatorState.displayValue = '0.';
                calculatorState.fullExpression = '0.';
                calculatorState.firstOperand = null;
                calculatorState.waitingForSecondOperand = false;
                calculatorState.operator = null;
                calculatorState.isResultDisplayed = false;
                return;
            }

            if (calculatorState.waitingForSecondOperand) {
                calculatorState.displayValue = '0.';
                calculatorState.waitingForSecondOperand = false;
                calculatorState.fullExpression += '0.';
                return;
            }
            if (!calculatorState.displayValue.includes(dot)) {
                calculatorState.displayValue += dot;
                calculatorState.fullExpression += dot;
            }
        }
        
        const performCalculation = {
            '/': (first, second) => second === 0 ? 'Error' : first / second,
            '*': (first, second) => first * second,
            '+': (first, second) => first + second,
            '-': (first, second) => first - second,
        };

        function handleOperator(nextOperator) {
            if (calculatorState.isResultDisplayed) {
                // If starting new operation on result, keep result in display
                calculatorState.fullExpression = calculatorState.displayValue + nextOperator;
                calculatorState.isResultDisplayed = false;
            } else {
                calculatorState.fullExpression += nextOperator;
            }

            const { firstOperand, displayValue, operator } = calculatorState;
            const inputValue = parseFloat(displayValue);

            if (operator && calculatorState.waitingForSecondOperand) {
                calculatorState.operator = nextOperator;
                return;
            }

            if (firstOperand === null) {
                calculatorState.firstOperand = inputValue;
            } else if (operator) {
                const result = performCalculation[operator](firstOperand, inputValue);
                if (result === 'Error') {
                    calculatorState.displayValue = 'Error';
                    calculatorState.fullExpression = 'Error';
                } else {
                    // Truncate long decimals to avoid display issues
                    const resStr = String(parseFloat(result.toFixed(7)));
                    calculatorState.displayValue = resStr;
                }
                calculatorState.firstOperand = result === 'Error' ? null : result;
            }
            
            calculatorState.waitingForSecondOperand = true;
            calculatorState.operator = nextOperator;
        }

        function resetCalculator() {
            calculatorState.displayValue = '0';
            calculatorState.fullExpression = '';
            calculatorState.firstOperand = null;
            calculatorState.waitingForSecondOperand = false;
            calculatorState.operator = null;
            calculatorState.isResultDisplayed = false;
        }

        calculatorButtons.addEventListener('click', (event) => {
            const { target } = event;
            if (!target.matches('button')) return;

            if (calculatorState.displayValue === 'Error' && target.textContent !== 'C') return;

            if (target.classList.contains('digit')) { inputDigit(target.textContent); }
            else if (target.classList.contains('decimal')) { inputDecimal(target.textContent); }
            else if (target.classList.contains('operator')) { handleOperator(target.textContent); }
            else if (target.textContent === 'C') { resetCalculator(); }
            else if (target.classList.contains('equals')) {
                 if (calculatorState.operator && calculatorState.firstOperand !== null) {
                    const inputValue = parseFloat(calculatorState.displayValue);
                    const result = performCalculation[calculatorState.operator](calculatorState.firstOperand, inputValue);
                    
                    let resultStr = 'Error';
                    if (result !== 'Error') {
                         resultStr = String(parseFloat(result.toFixed(7)));
                    }
                    
                    calculatorState.displayValue = resultStr;
                    calculatorState.fullExpression += '=' + resultStr; // Append =Result
                    
                    calculatorState.firstOperand = null;
                    calculatorState.operator = null;
                    calculatorState.waitingForSecondOperand = false;
                    calculatorState.isResultDisplayed = true;
                }
            }
            updateCalculatorDisplay();
        });

        function handleCalculatorKeyPress(event) {
            if (calculatorModal.classList.contains('hidden')) return;

            const { key } = event;
            let buttonToAnimate;
            
            const buttons = Array.from(calculatorButtons.querySelectorAll('button'));

            if (key >= '0' && key <= '9') {
                inputDigit(key);
                buttonToAnimate = buttons.find(b => b.textContent === key && b.classList.contains('digit'));
            } else if (key === '.') {
                inputDecimal(key);
                buttonToAnimate = buttons.find(b => b.textContent === key && b.classList.contains('decimal'));
            } else if (['+', '-', '*', '/'].includes(key)) {
                handleOperator(key);
                buttonToAnimate = buttons.find(b => b.textContent === key && b.classList.contains('operator'));
            } else if (key === 'Enter' || key === '=') {
                event.preventDefault();
                if (calculatorState.operator && calculatorState.firstOperand !== null) {
                     const inputValue = parseFloat(calculatorState.displayValue);
                     const result = performCalculation[calculatorState.operator](calculatorState.firstOperand, inputValue);
                     let resultStr = 'Error';
                     if (result !== 'Error') { resultStr = String(parseFloat(result.toFixed(7))); }
                     calculatorState.displayValue = resultStr;
                     calculatorState.fullExpression += '=' + resultStr;
                     
                     calculatorState.firstOperand = null;
                     calculatorState.operator = null;
                     calculatorState.waitingForSecondOperand = false;
                     calculatorState.isResultDisplayed = true;
                }
                buttonToAnimate = buttons.find(b => b.classList.contains('equals'));
            } else if (key === 'Escape') {
                calculatorModal.classList.add('hidden');
                buttonToAnimate = calculatorCloseBtn;
            } else if (key === 'Backspace' || key.toLowerCase() === 'c') {
                resetCalculator();
                buttonToAnimate = buttons.find(b => b.textContent === 'C');
            }

            if (buttonToAnimate) {
                buttonToAnimate.classList.add('key-press-feedback');
                setTimeout(() => {
                    buttonToAnimate.classList.remove('key-press-feedback');
                }, 100);
            }
            
            if (['0','1','2','3','4','5','6','7','8','9','.','+','-','*','/','Enter','=','Backspace','c','C'].includes(key)) {
                updateCalculatorDisplay();
            }
        }
        document.addEventListener('keydown', handleCalculatorKeyPress);


        // --- SETUP SCREEN LOGIC ---
        const sectionsContainer = document.getElementById('sections-container');
        const setupErrorEl = document.getElementById('setup-error');
        
        function renderSections() {
            sectionsContainer.innerHTML = '';
            sections.forEach((section, index) => {
                const sectionEl = document.createElement('div');
                sectionEl.className = 'p-4 rounded-md flex items-center space-x-3 themed-bg-tertiary';
                const removeButtonHtml = sections.length > 1
                    ? '<button data-index="' + index + '" class="remove-section-btn themed-text-danger text-2xl">\u00d7</button>'
                    : '';
                
                sectionEl.innerHTML =
                    '<input type="text" value="' + section.name + '" data-index="' + index + '" data-field="name" class="section-input p-2 rounded w-1/4 border" placeholder="Section Name"/>' +
                    '<input type="number" value="' + section.startQuestion + '" data-index="' + index + '" data-field="startQuestion" class="section-input p-2 rounded w-1/5 border" placeholder="Start"/>' +
                    '<span class="themed-text-tertiary">to</span>' +
                    '<input type="number" value="' + section.endQuestion + '" data-index="' + index + '" data-field="endQuestion" class="section-input p-2 rounded w-1/5 border" placeholder="End"/>' +
                    '<input type="number" value="' + section.duration + '" data-index="' + index + '" data-field="duration" class="section-input p-2 rounded w-1/5 border" placeholder="Duration (min)"/>' +
                    removeButtonHtml;
                sectionsContainer.appendChild(sectionEl);
            });
        }

        document.getElementById('add-section-btn').addEventListener('click', () => {
            const lastSection = sections[sections.length - 1];
            const nextStart = lastSection.endQuestion + 1;
            if (nextStart > mcqs.length) return;
            sections.push({ name: 'Section ' + (sections.length + 1), startQuestion: nextStart, endQuestion: mcqs.length, duration: mcqs.length - nextStart + 1 });
            renderSections();
        });

        document.getElementById('auto-set-sections-btn').addEventListener('click', () => {
            if (!mcqs || mcqs.length === 0) return;
            
            sections = [];
            const chunkSize = 50;
            let currentStart = 1;
            let idx = 1;
            
            while (currentStart <= mcqs.length) {
                let currentEnd = Math.min(currentStart + chunkSize - 1, mcqs.length);
                sections.push({
                    name: 'Section ' + idx,
                    startQuestion: currentStart,
                    endQuestion: currentEnd,
                    duration: (currentEnd - currentStart + 1) // 1 minute per question
                });
                currentStart = currentEnd + 1;
                idx++;
            }
            renderSections();
            showToast("Sections auto-configured");
        });

        sectionsContainer.addEventListener('change', (e) => {
            const target = e.target;
            if (target.classList.contains('section-input')) {
                const { index, field } = target.dataset;
                const value = field === 'name' ? target.value : parseInt(target.value, 10);
                sections[index][field] = value;
            }
        });
        
        sectionsContainer.addEventListener('click', (e) => {
            const target = e.target;
            if(target.classList.contains('remove-section-btn')) {
                const { index } = target.dataset;
                sections.splice(parseInt(index, 10), 1);
                renderSections();
            }
        });

        document.getElementById('revise-btn').addEventListener('click', () => {
            setupErrorEl.textContent = '';
            subjectName = document.getElementById('subject-name').value;
            candidateName = document.getElementById('candidate-name').value;
            
            // Use full, unshuffled set for revision
            currentMcqs = [...initialMcqsState]; 
            answerStates = currentMcqs.map(mcq => ({ mcqId: mcq.id, status: QuestionStatus.NotVisited, selectedOption: undefined, timeTaken: 0 }));
            reviewQuestionIndex = 0;
            switchScreen('review');
            setupReviewScreen(true, false); // isReviseMode = true
        });

        document.getElementById('start-exam-btn').addEventListener('click', () => {
            setupErrorEl.textContent = '';
            subjectName = document.getElementById('subject-name').value;
            candidateName = document.getElementById('candidate-name').value;
            shortNote = document.getElementById('short-note').value;
            
            let questionSet = new Set();
            for(const section of sections) {
                if(section.startQuestion > section.endQuestion || section.startQuestion < 1 || section.endQuestion > mcqs.length) {
                    setupErrorEl.textContent = 'Invalid range in ' + section.name + '.'; return;
                }
                if(section.duration <= 0) {
                    setupErrorEl.textContent = 'Duration must be positive in ' + section.name + '.'; return;
                }
                for(let i = section.startQuestion; i <= section.endQuestion; i++) {
                    if(questionSet.has(i)) {
                        setupErrorEl.textContent = 'Question ' + i + ' is in multiple sections.'; return;
                    }
                    questionSet.add(i);
                }
            }
            if (questionSet.size !== mcqs.length && mcqs.length > 0) {
                 const allCoveredQuestions = Array.from(questionSet).sort((a,b) => a-b);
                 if (allCoveredQuestions.length !== mcqs.length || allCoveredQuestions[allCoveredQuestions.length - 1] !== mcqs.length) {
                    setupErrorEl.textContent = 'All questions must be covered exactly once across all sections.'; return;
                 }
            }
            
            startExam();
        });
        
        function initializeSetup() {
            sections = [{ name: 'Section 1', startQuestion: 1, endQuestion: mcqs.length, duration: mcqs.length }];
            renderSections();
            const qCountSlider = document.getElementById('practice-q-count-slider');
            const qCountLabel = document.getElementById('practice-q-count-label');
            if(qCountSlider) {
                qCountSlider.addEventListener('input', () => {
                    qCountLabel.textContent = qCountSlider.value;
                });
            }
        }

        function confirmAndProceedToNextSection() {
            const isLastSection = currentSectionIndex === sections.length - 1;
            const message = isLastSection
                ? "Are you sure you want to submit the exam? This will end the test."
                : "Are you sure you want to submit this section? You will not be able to return to it.";
            showConfirmation(message, handleNextSection);
        }


        // --- EXAM LOGIC ---
        let currentSectionMCQs = [];
        let currentMCQ;

        function startExam() {
            isShuffled = document.getElementById('shuffle-mcqs-checkbox').checked;
            let baseMcqs = JSON.parse(JSON.stringify(initialMcqsState));

            if (isShuffled) {
                // Shuffle questions *within* each section's defined range
                sections.forEach(section => {
                    const startIndex = section.startQuestion - 1;
                    const endIndex = section.endQuestion;
                    const sectionSlice = baseMcqs.slice(startIndex, endIndex);
                    shuffleArray(sectionSlice);
                    // Replace the original slice with the shuffled one
                    baseMcqs.splice(startIndex, sectionSlice.length, ...sectionSlice);
                });
            }
            
            currentMcqs.length = 0;
            Array.prototype.push.apply(currentMcqs, baseMcqs);


            answerStates = currentMcqs.map(mcq => ({ mcqId: mcq.id, status: QuestionStatus.NotVisited, selectedOption: undefined, timeTaken: 0 }));
            currentSectionIndex = 0;
            currentQuestionIndexInSection = 0;
            loadSection();
            switchScreen('exam');
        }

        function loadSection() {
            if (timerInterval) clearInterval(timerInterval);

            const section = sections[currentSectionIndex];
            document.getElementById('section-name').textContent = section.name;
            
            // Get questions for the current section from the (potentially shuffled) main list
            currentSectionMCQs = currentMcqs.slice(section.startQuestion - 1, section.endQuestion);
            
            loadQuestion();
            renderPalette();

            let timeLeft = section.duration * 60;
            const timerEl = document.getElementById('timer');
            timerEl.textContent = formatTime(timeLeft);
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = formatTime(timeLeft);
                if (timeLeft <= 0) {
                    handleNextSection();
                }
            }, 1000);
        }
        
        function loadQuestion() {
            currentMCQ = currentSectionMCQs[currentQuestionIndexInSection];
            const answerState = answerStates.find(a => a.mcqId === currentMCQ.id);

            if (answerState.status === QuestionStatus.NotVisited) {
                answerState.status = QuestionStatus.NotAnswered;
            }
            
            document.getElementById('question-counter').textContent = 'Question ' + (currentQuestionIndexInSection + 1) + ' of ' + currentSectionMCQs.length;
            document.getElementById('question-text').innerHTML = processQuestionContent(currentMCQ.question, 'question-image-container');
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            Object.keys(currentMCQ.options).forEach(key => {
                const isSelected = answerState.selectedOption === key;
                const optionEl = document.createElement('label');
                const selectedClass = isSelected ? 'selected' : '';
                optionEl.className = 'option-label flex items-center p-4 rounded-lg cursor-pointer border-2 ' + selectedClass;
                optionEl.innerHTML =
                    '<input type="radio" name="option" value="' + key + '" ' + (isSelected ? 'checked' : '') + ' class="hidden"/>' +
                    '<span class="radio-circle w-6 h-6 rounded-full border-2 themed-border-secondary mr-4 flex-shrink-0 relative"></span>' +
                    '<span class="flex-1">' + key.toUpperCase() + '. ' + currentMCQ.options[key] + '</span>';
                optionsContainer.appendChild(optionEl);
            });

            const saveNextBtn = document.getElementById('save-next-btn');
            if (currentQuestionIndexInSection === currentSectionMCQs.length - 1) {
                saveNextBtn.textContent = 'Submit Section';
            } else {
                saveNextBtn.textContent = 'Save & Next';
            }
            
            document.getElementById('prev-btn').disabled = currentQuestionIndexInSection === 0;
            updatePaletteItem(currentMCQ.id);
            updatePaletteLegendCounts();
            saveExamDraft(); // Auto-save on every question load
            questionStartTime = Date.now();
        }

        document.getElementById('options-container').addEventListener('change', e => {
            const target = e.target;
            if (target.name === 'option') {
                const answerState = answerStates.find(a => a.mcqId === currentMCQ.id);
                const newStatus = answerState.status === QuestionStatus.MarkedForReview ? QuestionStatus.MarkedForReview : QuestionStatus.Answered;
                answerState.selectedOption = target.value;
                answerState.status = newStatus;
                loadQuestion(); // Re-render to show selection and auto-save
            }
        });

        function navigateQuestion(offset) {
            recordTime(currentMCQ.id, answerStates);
            const newIndex = currentQuestionIndexInSection + offset;
            if (newIndex >= 0 && newIndex < currentSectionMCQs.length) {
                currentQuestionIndexInSection = newIndex;
                loadQuestion();
            } else if (newIndex >= currentSectionMCQs.length) {
                confirmAndProceedToNextSection();
            }
        }

        document.getElementById('save-next-btn').addEventListener('click', () => navigateQuestion(1));
        document.getElementById('prev-btn').addEventListener('click', () => navigateQuestion(-1));

        document.getElementById('mark-review-btn').addEventListener('click', () => {
            const answerState = answerStates.find(a => a.mcqId === currentMCQ.id);
            answerState.status = answerState.status === QuestionStatus.MarkedForReview 
                ? (answerState.selectedOption ? QuestionStatus.Answered : QuestionStatus.NotAnswered)
                : QuestionStatus.MarkedForReview;
            updatePaletteItem(currentMCQ.id);
            updatePaletteLegendCounts();
            navigateQuestion(1);
        });

        document.getElementById('clear-response-btn').addEventListener('click', () => {
            const answerState = answerStates.find(a => a.mcqId === currentMCQ.id);
            answerState.selectedOption = undefined;
            answerState.status = QuestionStatus.NotAnswered;
            loadQuestion();
        });

        function handleNextSection() {
            recordTime(currentMCQ.id, answerStates);
            if (currentSectionIndex < sections.length - 1) {
                currentSectionIndex++;
                currentQuestionIndexInSection = 0;
                loadSection();
            } else {
                clearInterval(timerInterval);
                showResults();
            }
        }

        // --- PALETTE LOGIC ---
        function updatePaletteLegendCounts() {
            const sectionMCQIds = new Set(currentSectionMCQs.map(mcq => mcq.id));

            const counts = {
                [QuestionStatus.Answered]: 0,
                [QuestionStatus.NotAnswered]: 0,
                [QuestionStatus.NotVisited]: 0,
                [QuestionStatus.MarkedForReview]: 0,
            };

            answerStates.forEach(state => {
                if (sectionMCQIds.has(state.mcqId)) {
                    counts[state.status]++;
                }
            });

            document.getElementById('answered-count').textContent = String(counts[QuestionStatus.Answered]);
            document.getElementById('not-answered-count').textContent = String(counts[QuestionStatus.NotAnswered]);
            document.getElementById('not-visited-count').textContent = String(counts[QuestionStatus.NotVisited]);
            document.getElementById('marked-for-review-count').textContent = String(counts[QuestionStatus.MarkedForReview]);
        }

        function renderPalette() {
            const paletteContainer = document.getElementById('palette-container');
            paletteContainer.innerHTML = '';
            currentSectionMCQs.forEach((mcq, index) => {
                const answerState = answerStates.find(a => a.mcqId === mcq.id);
                const btn = document.createElement('button');
                btn.id = 'palette-item-' + mcq.id;
                btn.dataset.index = String(index);
                btn.className = 'h-10 w-10 flex items-center justify-center rounded text-white font-bold relative ' + statusColors[answerState.status];
                btn.innerHTML = (index + 1);
                // Accessibility: Add dynamic aria-label
                btn.setAttribute('aria-label', 'Go to question ' + (index + 1));
                if (answerState.status === QuestionStatus.MarkedForReview) {
                    btn.innerHTML += '<svg xmlns="http://www.w3.org/2000/svg" class="absolute bottom-1 right-1 h-3 w-3 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z" /></svg>';
                }
                btn.addEventListener('click', () => {
                    recordTime(currentMCQ.id, answerStates);
                    currentQuestionIndexInSection = parseInt(btn.dataset.index, 10);
                    loadQuestion();
                });
                paletteContainer.appendChild(btn);
            });
        }

        function updatePaletteItem(mcqId) {
            const btn = document.getElementById('palette-item-' + mcqId);
            if (!btn) return;
            const answerState = answerStates.find(a => a.mcqId === mcqId);
            btn.className = 'h-10 w-10 flex items-center justify-center rounded text-white font-bold relative ' + statusColors[answerState.status];
            btn.innerHTML = String(parseInt(btn.dataset.index, 10) + 1);
            if (answerState.status === QuestionStatus.MarkedForReview) {
                btn.innerHTML += '<svg xmlns="http://www.w3.org/2000/svg" class="absolute bottom-1 right-1 h-3 w-3 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z" /></svg>';
            }
        }

        // --- RESULTS LOGIC ---
        function showResults() {
            clearExamDraft();
            const shortNoteHtml = shortNote ? '<p><span class="font-bold">Notes:</span> ' + shortNote + '</p>' : '';
            const detailsHtml =
                '<p><span class="font-bold">Subject:</span> ' + (subjectName || 'N/A') + '</p>' +
                '<p><span class="font-bold">Candidate:</span> ' + (candidateName || 'N/A') + '</p>' +
                shortNoteHtml;
            document.getElementById('exam-details').innerHTML = detailsHtml;

            const results = sections.map(section => {
                let correct = 0, incorrect = 0, unanswered = 0;
                // Use the section's original question indices to find the right questions in the shuffled list
                const sectionQs = currentMcqs.slice(section.startQuestion - 1, section.endQuestion);
                sectionQs.forEach(mcq => {
                    const answerState = answerStates.find(a => a.mcqId === mcq.id);
                    if(answerState) {
                        if(!answerState.selectedOption) unanswered++;
                        else if(answerState.selectedOption === mcq.correctAnswer) correct++;
                        else incorrect++;
                    }
                });

                const total = correct + incorrect + unanswered;
                return { name: section.name, correct, incorrect, unanswered, total, score: total > 0 ? (correct / total * 100) : 0 };
            });
            
            const totalCorrect = results.reduce((sum, r) => sum + r.correct, 0);
            const totalIncorrect = results.reduce((sum, r) => sum + r.incorrect, 0);
            const totalUnanswered = results.reduce((sum, r) => sum + r.unanswered, 0);
            const overallTotal = totalCorrect + totalIncorrect + totalUnanswered;
            const overallScore = overallTotal > 0 ? (totalCorrect / overallTotal * 100) : 0;
            const scoreColorClass = overallScore >= 50 ? 'themed-text-success' : 'themed-text-danger';
            
            const attemptedStates = answerStates.filter(s => s.timeTaken > 0);
            const totalTimeSpent = attemptedStates.reduce((acc, s) => acc + s.timeTaken, 0);
            const avgTime = attemptedStates.length > 0 ? totalTimeSpent / attemptedStates.length : 0;
            const avgTimeHtml = '<div class="mt-4 themed-text-secondary">Average time per question: <span class="font-semibold">' + formatTimeDetailed(avgTime) + '</span></div>';

            const performanceHtml =
                '<h2 class="text-2xl font-semibold">Overall Performance</h2>' +
                '<p class="text-5xl font-bold my-4 ' + scoreColorClass + '">' + overallScore.toFixed(2) + '%</p>' +
                '<div class="flex justify-center space-x-8 text-lg">' +
                    '<span><span class="font-bold themed-text-success">' + totalCorrect + '</span> Correct</span>' +
                    '<span><span class="font-bold themed-text-danger">' + totalIncorrect + '</span> Incorrect</span>' +
                    '<span><span class="font-bold themed-text-secondary">' + totalUnanswered + '</span> Unanswered</span>' +
                '</div>' + avgTimeHtml;
            document.getElementById('overall-performance').innerHTML = performanceHtml;
            
            const sectionAnalysisContainer = document.getElementById('section-analysis');
            sectionAnalysisContainer.innerHTML = '';
            results.forEach(r => {
                sectionAnalysisContainer.innerHTML +=
                    '<div class="p-4 rounded-lg themed-bg-primary">' +
                        '<div class="flex justify-between items-center mb-2">' +
                            '<h3 class="text-xl font-bold">' + r.name + '</h3>' +
                            '<p class="text-xl font-semibold themed-text-accent">' + r.score.toFixed(2) + '%</p>' +
                        '</div>' +
                        '<div class="flex justify-around text-sm">' +
                            '<span>Correct: <span class="font-bold themed-text-success">' + r.correct + '</span></span>' +
                            '<span>Incorrect: <span class="font-bold themed-text-danger">' + r.incorrect + '</span></span>' +
                            '<span>Unanswered: <span class="font-bold themed-text-secondary">' + r.unanswered + '</span></span>' +
                        '</div>' +
                    '</div>';
            });
            const analysisHtml = sectionAnalysisContainer.innerHTML;

            // Save result to localStorage history
            const historyJSON = localStorage.getItem(EXAM_RESULTS_HISTORY_KEY);
            let history = historyJSON ? JSON.parse(historyJSON) : [];
            const resultData = {
                timestamp: new Date().toISOString(),
                overallScore: overallScore.toFixed(2),
                detailsHtml,
                performanceHtml,
                analysisHtml,
                answerStates,
                currentMcqs,
                subjectName,
                candidateName,
                shortNote,
                isShuffled
            };
            history.unshift(resultData); // Add to the beginning
            localStorage.setItem(EXAM_RESULTS_HISTORY_KEY, JSON.stringify(history));
            
            const pastResultsContainer = document.getElementById('past-results-container');
            const pastResultsCount = document.getElementById('past-results-count');
            pastResultsContainer.classList.remove('hidden');
            pastResultsCount.textContent = history.length;


            switchScreen('results');
        }

        document.getElementById('restart-btn').addEventListener('click', () => {
            clearExamDraft();
            clearPracticeDraft();
            document.getElementById('subject-name').value = '';
            document.getElementById('candidate-name').value = '';
            document.getElementById('short-note').value = '';
            document.getElementById('shuffle-mcqs-checkbox').checked = false;
            
            currentMcqs.length = 0;
            Array.prototype.push.apply(currentMcqs, JSON.parse(JSON.stringify(initialMcqsState)));
            
            initializeSetup();
            switchScreen('setup');
        });
        
        document.getElementById('download-report-btn').addEventListener('click', () => {
            reportOptionsModal.classList.remove('hidden');
            reportOptionsModal.classList.add('flex');
        });
        
        document.getElementById('cancel-report-download-btn').addEventListener('click', () => {
            reportOptionsModal.classList.add('hidden');
            reportOptionsModal.classList.remove('flex');
        });

        document.getElementById('download-with-explanations-btn').addEventListener('click', () => {
            reportOptionsModal.classList.add('hidden');
            reportOptionsModal.classList.remove('flex');
            downloadReport(true);
        });

        document.getElementById('download-without-explanations-btn').addEventListener('click', () => {
            reportOptionsModal.classList.add('hidden');
            reportOptionsModal.classList.remove('flex');
            downloadReport(false);
        });

        function renderMarkdownToPdf(doc, markdown, options) {
            let { x, y, maxWidth, pageHeight, margin, lineHeight, bulletIndent } = options;
            if (!markdown) return y;

            const checkPageBreak = (neededHeight) => {
                if (y + neededHeight > pageHeight - margin) {
                    doc.addPage();
                    y = margin;
                }
                return y;
            };

            const renderTextBlock = (textBlock) => {
                if (!textBlock.trim()) return;
                
                const blocks = textBlock.split(/\n\s*\n/);
                blocks.forEach(block => {
                    const trimmedBlock = block.trim();
                    if (!trimmedBlock) return;
                    
                    const lines = trimmedBlock.split('\n');
                
                    let isUnordered = lines.every(l => l.trim().startsWith('- ') || l.trim().startsWith('* '));
                    let isOrdered = lines.every(l => l.trim().match(/^\d+\.\s/));
                    
                    if(isUnordered) {
                        lines.forEach(line => {
                            const itemText = line.trim().substring(2);
                            const splitText = doc.splitTextToSize(itemText, maxWidth - bulletIndent);
                            y = checkPageBreak(splitText.length * lineHeight);
                            doc.text('â€¢', x, y, { baseline: 'top' });
                            doc.text(splitText, x + bulletIndent, y, { baseline: 'top' });
                            y += splitText.length * lineHeight;
                        });
                        y += lineHeight / 2;
                    } else if (isOrdered) {
                        lines.forEach(line => {
                            const number = line.trim().match(/^\d+\./)[0];
                            const itemText = line.trim().substring(number.length).trim();
                            const splitText = doc.splitTextToSize(itemText, maxWidth - doc.getTextWidth(number) - bulletIndent);
                            y = checkPageBreak(splitText.length * lineHeight);
                            doc.text(number, x, y, { baseline: 'top' });
                            doc.text(splitText, x + doc.getTextWidth(number) + bulletIndent - 2, y, { baseline: 'top' });
                            y += splitText.length * lineHeight;
                        });
                        y += lineHeight / 2;
                    } else { // Paragraph
                        lines.forEach(line => {
                            let isBold = line.startsWith('**') && line.endsWith('**') && line.length > 4;
                            let isItalic = line.startsWith('*') && line.endsWith('*') && line.length > 2;
                            
                            let processedLine = line;
                            if (isBold) {
                                processedLine = line.substring(2, line.length - 2);
                                doc.setFont('helvetica', 'bold');
                            } else if (isItalic) {
                                processedLine = line.substring(1, line.length - 1);
                                doc.setFont('helvetica', 'italic');
                            }

                            const splitText = doc.splitTextToSize(processedLine, maxWidth);
                            y = checkPageBreak(splitText.length * lineHeight);
                            doc.text(splitText, x, y, { baseline: 'top' });
                            y += splitText.length * lineHeight;

                            doc.setFont('helvetica', 'normal'); // Reset font
                        });
                        y += lineHeight / 2;
                    }
                });
            };

            const imageRegex = /({image\s+\d+})/g;
            const parts = markdown.split(imageRegex).filter(part => part);

            parts.forEach(part => {
                if (part.match(imageRegex)) {
                    const imageIndex = parseInt(part.match(/\d+/)[0], 10) - 1;
                    if (images[imageIndex]) {
                        try {
                            const imgData = images[imageIndex];
                            const fileType = imgData.substring(imgData.indexOf('/') + 1, imgData.indexOf(';'));
                            const imgProps = doc.getImageProperties(imgData);
                            const imgWidth = Math.min(maxWidth, imgProps.width);
                            const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

                            y = checkPageBreak(imgHeight + 5); 
                            doc.addImage(imgData, fileType.toUpperCase(), x, y, imgWidth, imgHeight);
                            y += imgHeight + 5;
                        } catch (e) {
                            console.error("Error adding image to PDF:", e);
                            const errorText = '[Error loading image]';
                            y = checkPageBreak(lineHeight);
                            doc.text(errorText, x, y, { baseline: 'top' });
                            y += lineHeight;
                        }
                    }
                } else {
                    renderTextBlock(part);
                }
            });

            return y;
        }

        async function downloadReport(includeExplanations) {
            const btn = document.getElementById('download-report-btn');
            btn.disabled = true;
            btn.textContent = 'Generating...';

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const analyticsContainer = document.querySelector('#results-screen > div');

                // --- Page 1: Analytics ---
                doc.setFontSize(22);
                doc.text('Exam Report', 105, 20, { align: 'center' });
                
                doc.setFontSize(11);
                doc.text('Subject: ' + (subjectName || 'N/A'), 15, 35);
                doc.text('Candidate: ' + (candidateName || 'N/A'), 15, 42);
                if (shortNote) {
                    const noteLines = doc.splitTextToSize('Notes: ' + shortNote, 180);
                    doc.text(noteLines, 15, 49);
                }
                doc.setFontSize(9);
                doc.setTextColor(150);
                doc.text('Generated on: ' + new Date().toLocaleString(), 105, 58, { align: 'center' });

                const canvas = await window.html2canvas(analyticsContainer, { scale: 2, windowWidth: analyticsContainer.scrollWidth, windowHeight: analyticsContainer.scrollHeight });
                const imgData = canvas.toDataURL('image/png');
                const imgProps = doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                doc.addImage(imgData, 'PNG', 10, 65, pdfWidth - 20, pdfHeight);

                // --- Subsequent Pages: Detailed Review ---
                doc.addPage();
                doc.setFontSize(18);
                doc.text('Detailed Answer Review', 105, 15, { align: 'center' });

                let y = 30;
                const margin = 15;
                const pageHeight = doc.internal.pageSize.getHeight();
                const maxWidth = pdfWidth - margin * 2;

                currentMcqs.forEach((mcq, index) => {
                    const answerState = answerStates.find(a => a.mcqId === mcq.id);
                    if (y > pageHeight - 40) { 
                        doc.addPage();
                        y = 20;
                    }

                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(12);
                    
                    const questionContent = (index + 1) + '. ' + mcq.question;
                    const imageRegex = /({image\s+\d+})/g;
                    const questionParts = questionContent.split(imageRegex).filter(part => part);

                    const checkPageBreakForQuestion = (neededHeight) => {
                        if (y + neededHeight > pageHeight - margin) {
                            doc.addPage();
                            y = 20;
                        }
                    };

                    questionParts.forEach(part => {
                        if (part.match(imageRegex)) {
                            const imageIndex = parseInt(part.match(/\d+/)[0], 10) - 1;
                            if (images[imageIndex]) {
                                try {
                                    const imgData = images[imageIndex];
                                    const fileType = imgData.substring(imgData.indexOf('/') + 1, imgData.indexOf(';'));
                                    const imgProps = doc.getImageProperties(imgData);
                                    const imgWidth = Math.min(maxWidth, imgProps.width);
                                    const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

                                    checkPageBreakForQuestion(imgHeight + 5);
                                    doc.addImage(imgData, fileType.toUpperCase(), margin, y, imgWidth, imgHeight);
                                    y += imgHeight + 5;
                                } catch (e) {
                                    console.error("Error adding image to PDF:", e);
                                    const errorText = '[Error loading image]';
                                    checkPageBreakForQuestion(7);
                                    doc.text(errorText, margin, y, { baseline: 'top' });
                                    y += 7;
                                }
                            }
                        } else {
                            const questionText = doc.splitTextToSize(part, maxWidth);
                            checkPageBreakForQuestion(questionText.length * 7);
                            doc.text(questionText, margin, y, { baseline: 'top' });
                            y += questionText.length * 7;
                        }
                    });
                    y += 3;


                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    Object.keys(mcq.options).forEach(key => {
                        const isCorrect = mcq.correctAnswer === key;
                        const isSelected = answerState.selectedOption === key;

                        if (isCorrect) doc.setTextColor(34, 139, 34);
                        else if (isSelected && !isCorrect) doc.setTextColor(220, 20, 60);
                        else doc.setTextColor(0, 0, 0);
                        
                        const optionString = '(' + key.toUpperCase() + ') ' + mcq.options[key];
                        const optionText = doc.splitTextToSize(optionString, maxWidth - 5);
                        doc.text(optionText, margin + 5, y, { baseline: 'top' });
                        y += optionText.length * 5;
                    });
                    y += 3;
                    
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(9);
                    const summaryText = 'Your Answer: ' + (answerState.selectedOption ? answerState.selectedOption.toUpperCase() : 'Not Answered') + ' | Correct Answer: ' + mcq.correctAnswer.toUpperCase();
                    doc.text(summaryText, margin, y, { baseline: 'top' });
                    y += 7;

                    if (includeExplanations && mcq.explanation) {
                        doc.setTextColor(55, 65, 81);
                        doc.setFont('helvetica', 'bold');
                        doc.setFontSize(10);
                        doc.text('Explanation:', margin, y, { baseline: 'top' });
                        y += 6;

                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(9);

                        const renderOptions = { x: margin, y: y, maxWidth: maxWidth, pageHeight: pageHeight, margin: margin, lineHeight: 4.5, bulletIndent: 4 };
                        y = renderMarkdownToPdf(doc, mcq.explanation, renderOptions);
                    }
                    
                    y += 4;

                    if (index < currentMcqs.length - 1) {
                        doc.setDrawColor(200, 200, 200);
                        doc.line(margin, y, pdfWidth - margin, y);
                        y += 7;
                    }
                });

                doc.save('exam_report.pdf');
            } catch (error) {
                console.error("Failed to generate report:", error);
                alert("Sorry, there was an error generating the report.");
            } finally {
                btn.disabled = false;
                btn.textContent = 'Download Report';
            }
        }
        
        function markdownToHtml(markdown) {
            if (!markdown) return '';

            let text = markdown
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');

            const blocks = text.split(/\n\s*\n/);
            
            return blocks.map(block => {
                const trimmedBlock = block.trim();
                if (!trimmedBlock) return '';

                const lines = trimmedBlock.split('\n');

                if (lines.every(line => line.trim().startsWith('- ') || line.trim().startsWith('* '))) {
                    const listItems = lines.map(line => '<li>' + line.trim().substring(2) + '</li>').join('');
                    return '<ul>' + listItems + '</ul>';
                }

                if (lines.every(line => line.trim().match(/^\d+\.\s/))) {
                    const listItems = lines.map(line => '<li>' + line.trim().replace(/^\d+\.\s/, '') + '</li>').join('');
                    return '<ol>' + listItems + '</ol>';
                }

                return '<p>' + lines.join('<br />') + '</p>';
            }).join('');
        }
        
        // --- PRACTICE MODE LOGIC ---
        document.getElementById('start-practice-btn').addEventListener('click', () => {
            setupErrorEl.textContent = '';
            subjectName = document.getElementById('subject-name').value;
            candidateName = document.getElementById('candidate-name').value;

            const savedPracticeDraft = localStorage.getItem(PRACTICE_DRAFT_KEY);

            if (savedPracticeDraft) {
                practiceResumeModal.classList.remove('hidden');
                practiceResumeModal.classList.add('flex');
            } else {
                startPractice(false); // false means don't load from draft
            }
        });

        document.getElementById('practice-resume-btn').addEventListener('click', () => {
            practiceResumeModal.classList.add('hidden');
            practiceResumeModal.classList.remove('flex');
            startPractice(true); // true means load from draft
        });

        document.getElementById('practice-start-new-btn').addEventListener('click', () => {
            practiceResumeModal.classList.add('hidden');
            practiceResumeModal.classList.remove('flex');
            clearPracticeDraft();
            startPractice(false);
        });

        function handleQuestionTimeout() {
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
            const mcq = currentMcqs[currentPracticeIndex];
            const practiceState = practiceStates.find(p => p.mcqId === mcq.id);

            if (practiceState.attempted) return;

            practiceState.attempted = true;
            practiceState.selectedOption = null; // Timed out, considered incorrect
            practiceState.timeTaken = timePerMcq;
            
            revealPracticeAnswer(null);
            savePracticeDraft();
        }

        // Streak UI Helper
        function updateStreakUI() {
            const streakBadge = document.getElementById('streak-badge');
            const streakCountEl = document.getElementById('streak-count');
            
            if (currentStreak > 0) {
                streakBadge.classList.remove('hidden');
                streakCountEl.textContent = currentStreak;
                
                // Animate
                streakBadge.classList.remove('active');
                void streakBadge.offsetWidth; // Trigger reflow
                streakBadge.classList.add('active');
                setTimeout(() => streakBadge.classList.remove('active'), 200);
            } else {
                streakBadge.classList.add('hidden');
            }
        }

        function startPractice(loadFromDraft = false) {
            if (practiceTimerInterval) clearInterval(practiceTimerInterval);
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
            
            if (loadFromDraft) {
                try {
                    const draft = JSON.parse(localStorage.getItem(PRACTICE_DRAFT_KEY));
                    currentMcqs.length = 0;
                    Array.prototype.push.apply(currentMcqs, draft.mcqs);
                    practiceStates = draft.practiceStates;
                    currentPracticeIndex = draft.currentPracticeIndex;
                    subjectName = draft.subjectName;
                    candidateName = draft.candidateName;
                    isShuffled = draft.isShuffled;
                    timePerMcq = draft.timePerMcq || 0;
                    timeOverall = draft.timeOverall || 0;
                    currentStreak = draft.currentStreak || 0;
                    
                    document.getElementById('subject-name').value = subjectName || '';
                    document.getElementById('candidate-name').value = candidateName || '';
                    document.getElementById('shuffle-mcqs-checkbox').checked = isShuffled;

                } catch (e) {
                    console.error("Failed to load practice draft:", e);
                    alert("The saved practice draft is corrupted. Starting a new session.");
                    clearPracticeDraft();
                    loadFromDraft = false; // Fallback to new session
                }
            }
            
            if (!loadFromDraft) {
                currentStreak = 0; // Reset streak
                isShuffled = document.getElementById('shuffle-mcqs-checkbox').checked;
                let baseMcqs = [...initialMcqsState];
                if (isShuffled) {
                    shuffleArray(baseMcqs);
                }

                const qCountSlider = document.getElementById('practice-q-count-slider');
                let qCount = parseInt(qCountSlider.value, 10);
                if (isNaN(qCount) || qCount <= 0 || qCount > baseMcqs.length) {
                    qCount = baseMcqs.length;
                }
                currentMcqs = baseMcqs.slice(0, qCount);
                
                practiceStates = currentMcqs.map(mcq => ({ mcqId: mcq.id, selectedOption: null, attempted: false, timeTaken: 0 }));
                currentPracticeIndex = 0;
                timePerMcq = parseInt(document.getElementById('practice-time-per-mcq').value, 10) || 0;
                timeOverall = parseInt(document.getElementById('practice-time-overall').value, 10) || 0;
            }

            document.getElementById('practice-subject-name').textContent = subjectName || 'Practice Mode';
            updateStreakUI();
            switchScreen('practice');
            renderPracticePalette(); // Added call to render palette
            renderPracticeQuestion();
            
            const practiceTimerEl = document.getElementById('practice-timer');
            if (timeOverall > 0) {
                practiceTimerEl.classList.remove('hidden');
                let timeLeft = timeOverall * 60;
                practiceTimerEl.textContent = formatTime(timeLeft);
                practiceTimerInterval = setInterval(() => {
                    timeLeft--;
                    practiceTimerEl.textContent = formatTime(timeLeft);
                    if (timeLeft <= 0) {
                        if(practiceTimerInterval) clearInterval(practiceTimerInterval);
                        if(perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
                        alert("Practice time is up!");
                        showPracticeResults();
                    }
                }, 1000);
            } else {
                practiceTimerEl.classList.add('hidden');
            }
        }

        function renderPracticeQuestion() {
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);

            const mcq = currentMcqs[currentPracticeIndex];
            const practiceState = practiceStates.find(p => p.mcqId === mcq.id);
            
            document.getElementById('practice-question-counter').textContent = 'Question ' + (currentPracticeIndex + 1) + ' of ' + currentMcqs.length;
            document.getElementById('practice-question-text').innerHTML = (currentPracticeIndex + 1) + '. ' + processQuestionContent(mcq.question, 'practice-question-image-container');

            // Update Palette Active State
            const allPaletteBtns = document.querySelectorAll('#practice-palette-grid button');
            allPaletteBtns.forEach(btn => btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500'));
            const currentBtn = document.getElementById('practice-palette-item-' + currentPracticeIndex);
            if (currentBtn) {
                currentBtn.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
                // Ensure the active button is visible in the scrollable container
                currentBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }

            const optionsContainer = document.getElementById('practice-options-container');
            optionsContainer.innerHTML = '';
            
            Object.keys(mcq.options).forEach(key => {
                const optionEl = document.createElement('div');
                optionEl.dataset.optionKey = key;
                optionEl.className = 'flex items-center p-4 rounded-lg border-2 transition-all themed-bg-tertiary themed-border-primary';
                optionEl.innerHTML = '<span class="flex-1">' + key.toUpperCase() + '. ' + mcq.options[key] + '</span>';
                optionsContainer.appendChild(optionEl);
            });
            
            // Hide previous results elements
            document.getElementById('practice-explanation-section').classList.add('hidden');
            document.getElementById('header-feedback-badge').classList.remove('visible');
            document.getElementById('header-feedback-badge').className = 'feedback-badge'; // Reset class

            if (practiceState.attempted) {
                revealPracticeAnswer(practiceState.selectedOption);
            } else {
                optionsContainer.classList.add('cursor-pointer');
                optionsContainer.querySelectorAll('[data-option-key]').forEach(el => el.classList.add('themed-bg-accent-hover'));
            }

            // Per-question timer logic
            const timerContainer = document.getElementById('per-question-timer-container');
            const timerBar = document.getElementById('per-question-timer-bar');
            if (timePerMcq > 0 && !practiceState.attempted) {
                timerContainer.classList.remove('hidden');
                timerBar.style.width = '100%';
                timerBar.classList.remove('bg-green-500');
                timerBar.classList.add('bg-green-500');

                const timerStart = Date.now();
                perQuestionTimerInterval = setInterval(() => {
                    const elapsed = (Date.now() - timerStart) / 1000;
                    if (elapsed >= timePerMcq) {
                        handleQuestionTimeout();
                        return;
                    }
                    const remainingPercent = ((timePerMcq - elapsed) / timePerMcq) * 100;
                    timerBar.style.width = remainingPercent + '%';

                    if (remainingPercent < 40) {
                        timerBar.classList.remove('bg-green-500');
                        timerBar.classList.add('bg-red-500');
                    }
                }, 100);
            } else {
                timerContainer.classList.add('hidden');
            }

            document.getElementById('practice-prev-btn').disabled = currentPracticeIndex === 0;
            document.getElementById('practice-next-btn').disabled = currentPracticeIndex === currentMcqs.length - 1;
            
            updatePracticeSaveButtonState();
            questionStartTime = Date.now();
        }

        function revealPracticeAnswer(selectedKey) {
            const mcq = currentMcqs[currentPracticeIndex];
            const optionsContainer = document.getElementById('practice-options-container');
            optionsContainer.classList.remove('cursor-pointer');
            
            // Check correctness
            const isCorrect = mcq.correctAnswer === selectedKey;
            
            // Update Palette Button Color for the answered question
            const paletteBtn = document.getElementById('practice-palette-item-' + currentPracticeIndex);
            if (paletteBtn) {
                // If selectedKey is null (timeout), it's incorrect (red)
                const paletteIsCorrect = selectedKey && (mcq.correctAnswer === selectedKey);
                paletteBtn.className = 'w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full text-white font-bold transition-all transform hover:scale-110 focus:outline-none ' + (paletteIsCorrect ? 'bg-green-600' : 'bg-red-600');
            }

            optionsContainer.querySelectorAll('[data-option-key]').forEach(el => {
                el.classList.remove('themed-bg-accent-hover');
                const key = el.dataset.optionKey;
                const isOptionCorrect = mcq.correctAnswer === key;
                const isSelected = selectedKey === key;

                el.classList.remove('themed-bg-tertiary', 'themed-border-primary');
                
                // SVG Icons
                const checkIcon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2 text-green-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>';
                const crossIcon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2 text-red-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>';

                if (isOptionCorrect) {
                    el.style.backgroundColor = 'var(--bg-success)';
                    el.style.borderColor = 'var(--bg-success-border)';
                    if (!el.innerHTML.includes('<svg')) el.innerHTML += checkIcon;
                    
                    if (isCorrect && isSelected) {
                        triggerConfetti(el.getBoundingClientRect());
                    }
                } else if (isSelected && !isOptionCorrect) {
                    el.style.backgroundColor = 'var(--bg-danger)';
                    el.style.borderColor = 'var(--bg-danger-border)';
                     if (!el.innerHTML.includes('<svg')) el.innerHTML += crossIcon;
                } else {
                    el.classList.add('opacity-60');
                }
            });
            
            // --- HEADER FEEDBACK ---
            const badge = document.getElementById('header-feedback-badge');
            const badgeText = document.getElementById('header-feedback-text');
            
            if (isCorrect) {
                badge.className = 'feedback-badge visible correct';
                badgeText.innerHTML = 'Excellent! ðŸŽ‰';
            } else {
                badge.className = 'feedback-badge visible incorrect';
                badgeText.innerHTML = 'Incorrect âŒ';
            }

            // --- EXPLANATION SECTION ---
            const explanationSection = document.getElementById('practice-explanation-section');
            const explanationContainer = document.getElementById('practice-explanation-container');
            
            if (mcq.explanation) {
                const cleanedExplanationText = processQuestionContent(mcq.explanation, 'practice-explanation-image-container');
                explanationContainer.innerHTML = markdownToHtml(cleanedExplanationText);
            } else {
                document.getElementById('practice-explanation-image-container').innerHTML = '';
                explanationContainer.innerHTML = '<p class="themed-text-tertiary">No explanation was provided for this question.</p>';
            }
            explanationSection.classList.remove('hidden');
        }

        document.getElementById('practice-options-container').addEventListener('click', (e) => {
            const optionEl = e.target.closest('[data-option-key]');
            if (!optionEl) return;

            const mcq = currentMcqs[currentPracticeIndex];
            const practiceState = practiceStates.find(p => p.mcqId === mcq.id);
            
            if (practiceState.attempted) return;
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);

            recordTime(mcq.id, practiceStates);
            
            const selectedKey = optionEl.dataset.optionKey;
            practiceState.attempted = true;
            practiceState.selectedOption = selectedKey;

            // STREAK LOGIC UPDATE
            if (selectedKey === mcq.correctAnswer) {
                currentStreak++;
            } else {
                currentStreak = 0;
            }
            updateStreakUI();

            revealPracticeAnswer(selectedKey);
            savePracticeDraft();
        });
        
        // ADDED: Function to render the practice palette
        function renderPracticePalette() {
            const paletteGrid = document.getElementById('practice-palette-grid');
            if (!paletteGrid) return;
            paletteGrid.innerHTML = '';

            currentMcqs.forEach((mcq, index) => {
                const btn = document.createElement('button');
                btn.id = 'practice-palette-item-' + index;
                btn.dataset.index = String(index);
                
                // Determine color based on state
                const pState = practiceStates.find(p => p.mcqId === mcq.id);
                let bgClass = 'bg-gray-400'; // Default gray
                if (pState && pState.attempted) {
                     const isCorrect = pState.selectedOption === mcq.correctAnswer;
                     bgClass = isCorrect ? 'bg-green-600' : 'bg-red-600';
                }

                btn.className = 'w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full text-white font-bold transition-all transform hover:scale-110 focus:outline-none ' + bgClass; 
                btn.textContent = String(index + 1);
                btn.setAttribute('aria-label', 'Go to question ' + (index + 1));
                
                btn.addEventListener('click', () => {
                    if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
                    // Record time for current before switching if not answered
                    const currentMcq = currentMcqs[currentPracticeIndex];
                    if(currentMcq) {
                         const currentState = practiceStates.find(p => p.mcqId === currentMcq.id);
                         if (!currentState.attempted) recordTime(currentMcq.id, practiceStates);
                    }
                    
                    currentPracticeIndex = parseInt(btn.dataset.index, 10);
                    renderPracticeQuestion();
                    savePracticeDraft();
                });
                paletteGrid.appendChild(btn);
            });
        }
        
        function navigatePractice(offset) {
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
            const mcq = currentMcqs[currentPracticeIndex];
            const practiceState = practiceStates.find(p => p.mcqId === mcq.id);
            if (!practiceState.attempted) {
                recordTime(mcq.id, practiceStates); // Record time even if unanswered
            }

            const newIndex = currentPracticeIndex + offset;
            if (newIndex >= 0 && newIndex < currentMcqs.length) {
                currentPracticeIndex = newIndex;
                renderPracticeQuestion();
                savePracticeDraft();
            }
        }

        document.getElementById('practice-prev-btn').addEventListener('click', () => navigatePractice(-1));
        document.getElementById('practice-next-btn').addEventListener('click', () => navigatePractice(1));

        document.getElementById('exit-practice-btn').addEventListener('click', () => {
            if (practiceTimerInterval) clearInterval(practiceTimerInterval);
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
            recordTime(currentMcqs[currentPracticeIndex].id, practiceStates);
            showPracticeResults();
        });

        // --- REVIEW LOGIC ---
        let reviewQuestionIndex = 0;
        
        function setupReviewScreen(isReviseMode = false, isSavedMode = false) {
            const backBtn = document.getElementById('back-to-results-btn');
            const exitBtn = document.getElementById('exit-revise-btn');
            isReviewingSaved = isSavedMode;

            if (isSavedMode) {
                reviewTitleEl.textContent = 'Saved Questions';
                backBtn.style.display = 'none';
                exitBtn.style.display = 'inline-block';
                document.getElementById('review-time-taken').style.display = 'none';
            } else if (isReviseMode) {
                reviewTitleEl.textContent = 'Revise Mode';
                backBtn.style.display = 'none';
                exitBtn.style.display = 'inline-block';
                document.getElementById('review-time-taken').style.display = 'none';
            } else {
                reviewTitleEl.textContent = 'Review Answers';
                backBtn.style.display = 'inline-block';
                exitBtn.style.display = 'none';
                document.getElementById('review-time-taken').style.display = 'flex';
                if (reviewReturnScreen === 'practiceResults') {
                    backBtn.textContent = 'Back to Practice Results';
                } else {
                    backBtn.textContent = 'Back to Exam Results';
                }
            }
            renderReviewPalette();
            renderReviewQuestion();
        }
        
        document.getElementById('review-answers-btn').addEventListener('click', () => {
            reviewQuestionIndex = 0;
            reviewReturnScreen = 'results';
            switchScreen('review');
            setupReviewScreen(false, false);
        });
        
        document.getElementById('exit-revise-btn').addEventListener('click', () => {
            switchScreen('setup');
        });

        document.getElementById('review-practice-answers-btn').addEventListener('click', () => {
            answerStates = currentMcqs.map(mcq => {
                const pState = practiceStates.find(p => p.mcqId === mcq.id);
                return { mcqId: mcq.id, selectedOption: pState ? pState.selectedOption : null, timeTaken: pState ? pState.timeTaken : 0 };
            });
            reviewQuestionIndex = 0;
            reviewReturnScreen = 'practiceResults';
            switchScreen('review');
            setupReviewScreen(false, false);
        });

        document.getElementById('back-to-results-btn').addEventListener('click', () => switchScreen(reviewReturnScreen));
        
        function renderReviewPalette() {
            const paletteGrid = document.getElementById('review-palette-grid');
            if (!paletteGrid) return;
            paletteGrid.innerHTML = '';

            currentMcqs.forEach((mcq, index) => {
                const answerState = answerStates.find(a => a.mcqId === mcq.id);
                const isCorrect = answerState && answerState.selectedOption === mcq.correctAnswer;
                const hasAnswered = answerState && answerState.selectedOption !== undefined && answerState.selectedOption !== null;
                
                let bgClass = 'bg-gray-400';
                if (hasAnswered) {
                    bgClass = isCorrect ? 'bg-green-600' : 'bg-red-600';
                }

                const btn = document.createElement('button');
                btn.id = 'review-palette-item-' + index;
                btn.dataset.index = String(index);
                btn.className = 'w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full text-white font-bold transition-all transform hover:scale-110 focus:outline-none ' + bgClass;
                btn.textContent = String(index + 1);
                // Accessibility: Dynamic aria label
                btn.setAttribute('aria-label', 'Review question ' + (index + 1));
                btn.addEventListener('click', () => {
                    reviewQuestionIndex = parseInt(btn.dataset.index, 10);
                    renderReviewQuestion();
                });
                paletteGrid.appendChild(btn);
            });
        }

        function renderReviewQuestion() {
            updateSaveButtonState();
            const allPaletteBtns = document.querySelectorAll('#review-palette-grid button');
            allPaletteBtns.forEach(btn => btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500'));
            const currentBtn = document.getElementById('review-palette-item-' + reviewQuestionIndex);
            if (currentBtn) {
                currentBtn.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
                currentBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }

            const mcq = currentMcqs[reviewQuestionIndex];
            const answerState = answerStates.find(a => a.mcqId === mcq.id);
            
            document.getElementById('review-question-text').innerHTML = (reviewQuestionIndex + 1) + '. ' + processQuestionContent(mcq.question, 'review-question-image-container');
            document.getElementById('review-question-counter').textContent = 'Question ' + (reviewQuestionIndex + 1) + ' of ' + currentMcqs.length;
            
            const timeTakenEl = document.getElementById('review-time-taken');
            if (answerState && answerState.timeTaken) {
                timeTakenEl.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg> Time Taken: <span class="font-semibold ml-1">' + formatTimeDetailed(answerState.timeTaken) + '</span>';
            } else {
                timeTakenEl.innerHTML = '';
            }

            const explanationContainer = document.getElementById('explanation-container');
            if (mcq.explanation) {
                const cleanedExplanationText = processQuestionContent(mcq.explanation, 'explanation-image-container');
                explanationContainer.innerHTML = markdownToHtml(cleanedExplanationText);
            } else {
                document.getElementById('explanation-image-container').innerHTML = '';
                explanationContainer.innerHTML = '<p class="themed-text-tertiary">No explanation was provided for this question.</p>';
            }
            
            const reviewOptionsContainer = document.getElementById('review-options-container');
            reviewOptionsContainer.innerHTML = '';
            Object.keys(mcq.options).forEach(key => {
                const isSelected = answerState && answerState.selectedOption === key;
                const isCorrect = mcq.correctAnswer === key;
                let style = 'background-color: var(--bg-tertiary); border-color: transparent;';
                let indicatorText = '';

                if (isCorrect) {
                    style = 'background-color: var(--bg-success); border-color: var(--bg-success-border);';
                    indicatorText = '<span class="ml-auto text-sm font-semibold themed-text-success">Correct Answer</span>';
                }
                
                if (isSelected && !isCorrect) {
                    style = 'background-color: var(--bg-danger); border-color: var(--bg-danger-border);';
                    indicatorText = '<span class="ml-auto text-sm font-semibold themed-text-danger">Your Answer</span>';
                } else if (isSelected && isCorrect) {
                     indicatorText = '<span class="ml-auto text-sm font-semibold themed-text-success">Your Answer (Correct)</span>';
                }
                
                reviewOptionsContainer.innerHTML +=
                    '<div class="flex items-center p-4 rounded-lg border-2" style="' + style + '">' +
                        '<span class="flex-1">' + key.toUpperCase() + '. ' + mcq.options[key] + '</span>' +
                        indicatorText +
                    '</div>';
            });
            
            document.getElementById('review-prev-btn').disabled = reviewQuestionIndex === 0;
            document.getElementById('review-next-btn').disabled = reviewQuestionIndex === currentMcqs.length - 1;
        }

        document.getElementById('review-prev-btn').addEventListener('click', () => {
            if(reviewQuestionIndex > 0) {
                reviewQuestionIndex--;
                renderReviewQuestion();
            }
        });

        document.getElementById('review-next-btn').addEventListener('click', () => {
            if(reviewQuestionIndex < currentMcqs.length - 1) {
                reviewQuestionIndex++;
                renderReviewQuestion();
            }
        });
        
        // --- SWIPE NAVIGATION LOGIC ---
        function setupSwipeNavigation(container) {
            let touchStartX = 0;
            let touchStartY = 0;
            const mainContent = container.querySelector('main');
            let isAnimating = false;

            container.addEventListener('touchstart', e => {
                if (isAnimating) return;
                
                // FIX: Prevent page swipe if user is trying to scroll the palette
                if (e.target.closest('.overflow-x-auto')) return;

                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            container.addEventListener('touchend', e => {
                if (isAnimating) return;
                const touchEndX = e.changedTouches[0].screenX;
                const touchEndY = e.changedTouches[0].screenY;
                const diffX = touchEndX - touchStartX;
                const diffY = touchEndY - touchStartY;

                if (Math.abs(diffX) > 50 && Math.abs(diffX) > Math.abs(diffY)) {
                    
                    const isNext = diffX < 0; // Swipe Left
                    
                    // FIX: Re-enabled swipe backward (swipe right)
                    // The line that prevented it was removed here.

                    isAnimating = true;
                    const outClass = isNext ? 'slide-out-left' : 'slide-out-right';
                    const inClass = isNext ? 'slide-in-from-right' : 'slide-in-from-left';
                    
                    const onAnimationOutEnd = () => {
                        mainContent.removeEventListener('animationend', onAnimationOutEnd);
                        mainContent.classList.remove(outClass);

                        // Perform navigation action
                        if (container.id === 'practice-screen') {
                            if (isNext) navigatePractice(1);
                            else navigatePractice(-1);
                        } else if (container.id === 'review-screen') {
                            if (isNext) document.getElementById('review-next-btn').click();
                            else document.getElementById('review-prev-btn').click();
                        }

                        mainContent.classList.add(inClass);
                        
                        const onAnimationInEnd = () => {
                            mainContent.removeEventListener('animationend', onAnimationInEnd);
                            mainContent.classList.remove(inClass);
                            isAnimating = false;
                        };
                        mainContent.addEventListener('animationend', onAnimationInEnd);
                    };

                    mainContent.addEventListener('animationend', onAnimationOutEnd);
                    mainContent.classList.add(outClass);
                }
            }, { passive: true });
        }

        setupSwipeNavigation(screens.practice);
        setupSwipeNavigation(screens.review);

        // --- PAST RESULTS LOGIC ---
        function showPastResultsList() {
            const historyJSON = localStorage.getItem(EXAM_RESULTS_HISTORY_KEY);
            const history = historyJSON ? JSON.parse(historyJSON) : [];
            const listEl = document.getElementById('past-results-list');
            listEl.innerHTML = '';

            if (history.length === 0) {
                listEl.innerHTML = '<p class="text-center themed-text-tertiary">No past results found.</p>';
            } else {
                history.forEach((result, index) => {
                    const date = new Date(result.timestamp).toLocaleString();
                    const scoreColor = result.overallScore >= 50 ? 'themed-text-success' : 'themed-text-danger';
                    const item = document.createElement('button');
                    item.className = 'w-full text-left p-4 rounded-lg border flex justify-between items-center transition-colors themed-bg-primary themed-border-primary hover:bg-[var(--bg-tertiary)]';
                    item.dataset.resultIndex = index;
                    item.innerHTML = 
                        '<div>' +
                            '<p class="font-bold themed-text-primary">' + (result.subjectName || 'Untitled Exam') + '</p>' +
                            '<p class="text-sm themed-text-secondary">' + date + '</p>' +
                        '</div>' +
                        '<div class="text-right">' +
                            '<p class="text-xl font-bold ' + scoreColor + '">' + result.overallScore + '%</p>' +
                            '<p class="text-xs themed-text-tertiary">Click to view details</p>' +
                        '</div>';
                    listEl.appendChild(item);
                });
            }
            switchScreen('pastResults');
        }
        
        document.getElementById('past-results-list').addEventListener('click', (e) => {
            const target = e.target.closest('[data-result-index]');
            if (target) {
                const index = parseInt(target.dataset.resultIndex, 10);
                const historyJSON = localStorage.getItem(EXAM_RESULTS_HISTORY_KEY);
                const history = historyJSON ? JSON.parse(historyJSON) : [];
                const resultData = history[index];
                if (resultData) {
                    loadResultIntoView(resultData);
                }
            }
        });

        function loadResultIntoView(resultData) {
            document.getElementById('exam-details').innerHTML = resultData.detailsHtml;
            document.getElementById('overall-performance').innerHTML = resultData.performanceHtml;
            document.getElementById('section-analysis').innerHTML = resultData.analysisHtml;
            
            // Set state for the "Review Answers" button for this specific result
            answerStates = resultData.answerStates;
            currentMcqs = resultData.currentMcqs;
            subjectName = resultData.subjectName;
            candidateName = resultData.candidateName;
            shortNote = resultData.shortNote;
            isShuffled = resultData.isShuffled;
            
            switchScreen('results');
        }
        
        document.getElementById('back-to-setup-from-history-btn').addEventListener('click', () => switchScreen('setup'));

        // --- PROGRESS CHARTS RENDERING ---
        function renderProgressCharts() {
            const examHistoryJSON = localStorage.getItem(EXAM_RESULTS_HISTORY_KEY);
            const examHistory = examHistoryJSON ? JSON.parse(examHistoryJSON) : [];
            
            const practiceHistoryJSON = localStorage.getItem(PRACTICE_RESULTS_HISTORY_KEY);
            const practiceHistory = practiceHistoryJSON ? JSON.parse(practiceHistoryJSON) : [];

            // --- KPI DASHBOARD STATS ---
            // Combine scores for calculation? No, separate is better. Let's show Exam stats primarily.
            const examScores = examHistory.map(h => parseFloat(h.overallScore || 0));
            const totalExams = examHistory.length;
            const avgScore = totalExams > 0 ? (examScores.reduce((a,b)=>a+b, 0) / totalExams).toFixed(1) : '0';
            const maxScore = totalExams > 0 ? Math.max(...examScores).toFixed(1) : '0';
            
            // Total Practice Questions Solved
            const totalPracticeQs = practiceHistory.reduce((acc, curr) => acc + (curr.attempted || 0), 0);

            const kpiDashboard = document.getElementById('kpi-dashboard');
            kpiDashboard.innerHTML = ''; // Clear previous

            const kpis = [
                { label: 'Avg Exam Score', value: avgScore + '%', color: 'text-blue-500' },
                { label: 'Highest Score', value: maxScore + '%', color: 'text-green-500' },
                { label: 'Total Attempts', value: totalExams, color: 'text-purple-500' },
                { label: 'Practice Qs', value: totalPracticeQs, color: 'text-orange-500' }
            ];

            kpis.forEach(kpi => {
                const card = document.createElement('div');
                card.className = 'stat-card themed-bg-primary themed-border-primary';
                card.innerHTML = `
                    <span class="stat-value ${kpi.color}">${kpi.value}</span>
                    <span class="stat-label">${kpi.label}</span>
                `;
                kpiDashboard.appendChild(card);
            });


            // Helper to create bars
            const createBar = (score, labelText, tooltipTitle, subtitle, index, prevScore) => {
                const scoreNum = parseFloat(score);
                const isSuccess = scoreNum >= 50;
                const barClass = isSuccess ? 'bar-success' : 'bar-danger';
                
                const barContainer = document.createElement('div');
                barContainer.className = 'chart-bar-container';
                
                const bar = document.createElement('div');
                bar.className = 'chart-bar ' + barClass;
                bar.style.height = Math.max(scoreNum, 5) + '%'; 
                // Staggered Animation Delay
                bar.style.animationDelay = (index * 0.1) + 's';
                
                // Text inside bar
                const barText = document.createElement('span');
                barText.className = 'chart-bar-text';
                barText.textContent = scoreNum.toFixed(1) + '%';
                if (scoreNum < 15) barText.style.display = 'none';
                bar.appendChild(barText);
                
                const label = document.createElement('div');
                label.className = 'chart-bar-label';
                label.textContent = labelText;
                
                // Trend Indicator
                let trendHtml = '';
                if (prevScore !== null) {
                    const diff = scoreNum - prevScore;
                    if (diff > 0) trendHtml = '<span class="text-green-400 ml-2 text-xs">â–² +' + diff.toFixed(1) + '%</span>';
                    else if (diff < 0) trendHtml = '<span class="text-red-400 ml-2 text-xs">â–¼ ' + diff.toFixed(1) + '%</span>';
                    else trendHtml = '<span class="text-gray-400 ml-2 text-xs">- 0%</span>';
                }

                const tooltip = document.createElement('div');
                tooltip.className = 'chart-bar-tooltip';
                tooltip.innerHTML = '<strong>' + tooltipTitle + '</strong>' + trendHtml + '<br/>' + subtitle;
                
                barContainer.appendChild(tooltip);
                barContainer.appendChild(bar);
                barContainer.appendChild(label);
                
                return barContainer;
            };

            // 1. Render Exam Chart
            const examContainer = document.getElementById('exam-chart-container');
            const examEmpty = document.getElementById('exam-chart-empty');
            
            examContainer.innerHTML = '';
            if (examHistory.length === 0) {
                examEmpty.classList.remove('hidden');
            } else {
                examEmpty.classList.add('hidden');
                // Process in chronological order for trends, but show recent last? 
                // Actually history is stored newest first. Let's reverse to show chronological left-to-right.
                const reversedHistory = [...examHistory].reverse();
                
                reversedHistory.forEach((result, i) => {
                    let correct = 0, total = 0;
                    if (result.answerStates && result.currentMcqs) {
                        result.answerStates.forEach(state => {
                            const mcq = result.currentMcqs.find(m => m.id === state.mcqId);
                            if(mcq) {
                                total++;
                                if (state.selectedOption === mcq.correctAnswer) correct++;
                            }
                        });
                    }
                    
                    const date = new Date(result.timestamp).toLocaleDateString(undefined, {month: 'short', day: 'numeric'});
                    const subject = (result.subjectName || 'Exam').substring(0, 15);
                    
                    // Previous score for trend
                    const prevScore = i > 0 ? parseFloat(reversedHistory[i-1].overallScore) : null;

                    const bar = createBar(
                        result.overallScore, 
                        date, 
                        subject, 
                        'Score: ' + result.overallScore + '%<br>Marks: ' + correct + ' / ' + total,
                        i,
                        prevScore
                    );
                    examContainer.appendChild(bar);
                });
            }

            // 2. Render Practice Chart
            const practiceContainer = document.getElementById('practice-chart-container');
            const practiceEmpty = document.getElementById('practice-chart-empty');
            
            practiceContainer.innerHTML = '';
            if (practiceHistory.length === 0) {
                practiceEmpty.classList.remove('hidden');
            } else {
                practiceEmpty.classList.add('hidden');
                const reversedHistory = [...practiceHistory].reverse();
                
                reversedHistory.forEach((result, i) => {
                    const date = new Date(result.timestamp).toLocaleDateString(undefined, {month: 'short', day: 'numeric'});
                    const subject = (result.subjectName || 'Practice').substring(0, 15);
                    const prevScore = i > 0 ? parseFloat(reversedHistory[i-1].score) : null;

                    const bar = createBar(
                        result.score, 
                        date, 
                        subject, 
                        'Score: ' + result.score + '%<br>Marks: ' + result.correct + ' / ' + result.attempted,
                        i,
                        prevScore
                    );
                    practiceContainer.appendChild(bar);
                });
            }
        }

        document.getElementById('reset-practice-history-btn').addEventListener('click', () => {
            showConfirmation("Are you sure you want to clear all practice history? This cannot be undone.", () => {
                localStorage.removeItem(PRACTICE_RESULTS_HISTORY_KEY);
                renderProgressCharts();
            });
        });
        
        function showPracticeResults() {
            if (practiceTimerInterval) clearInterval(practiceTimerInterval);
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
            clearPracticeDraft();
            
            const detailsHtml =
                '<p><span class="font-bold">Subject:</span> ' + (subjectName || 'N/A') + '</p>' +
                '<p><span class="font-bold">Candidate:</span> ' + (candidateName || 'N/A') + '</p>';
            document.getElementById('practice-exam-details').innerHTML = detailsHtml;

            let correct = 0, incorrect = 0, attempted = 0;
            practiceStates.forEach(state => {
                if (state.attempted) {
                    attempted++;
                    const mcq = currentMcqs.find(m => m.id === state.mcqId);
                    if (mcq && state.selectedOption === mcq.correctAnswer) {
                        correct++;
                    } else {
                        incorrect++;
                    }
                }
            });
            
            const score = attempted > 0 ? (correct / attempted * 100) : 0;
            const scoreColorClass = score >= 50 ? 'themed-text-success' : 'themed-text-danger';
            
            document.getElementById('practice-score').className = 'text-5xl font-bold my-4 ' + scoreColorClass;
            document.getElementById('practice-score').textContent = score.toFixed(2) + '%';
            
            document.getElementById('practice-correct').innerHTML = '<span class="font-bold themed-text-success">' + correct + '</span> Correct';
            document.getElementById('practice-incorrect').innerHTML = '<span class="font-bold themed-text-danger">' + incorrect + '</span> Incorrect';
            document.getElementById('practice-attempted').innerHTML = '<span class="font-bold themed-text-secondary">' + attempted + '</span> Attempted';
            
            const attemptedStates = practiceStates.filter(s => s.timeTaken > 0);
            const totalTimeSpent = attemptedStates.reduce((acc, s) => acc + s.timeTaken, 0);
            const avgTime = attemptedStates.length > 0 ? totalTimeSpent / attemptedStates.length : 0;
            document.getElementById('practice-avg-time').innerHTML = 'Average time per question: <span class="font-semibold">' + formatTimeDetailed(avgTime) + '</span>';

            // SAVE PRACTICE RESULT
            const historyJSON = localStorage.getItem(PRACTICE_RESULTS_HISTORY_KEY);
            let history = historyJSON ? JSON.parse(historyJSON) : [];
            const resultData = {
                timestamp: new Date().toISOString(),
                score: score.toFixed(2),
                correct,
                incorrect,
                attempted,
                subjectName
            };
            history.unshift(resultData);
            localStorage.setItem(PRACTICE_RESULTS_HISTORY_KEY, JSON.stringify(history));

            switchScreen('practiceResults');
        }

        document.getElementById('restart-practice-btn').addEventListener('click', () => {
            clearPracticeDraft();
            startPractice(false);
        });
        
        document.getElementById('back-to-setup-btn').addEventListener('click', () => switchScreen('setup'));
        document.getElementById('back-to-setup-from-progress-btn').addEventListener('click', () => switchScreen('setup'));

        // --- INITIALIZE APP ---
        const savedExamDraft = localStorage.getItem(EXAM_DRAFT_KEY);
        if (savedExamDraft) {
            const resumeBanner = document.getElementById('resume-banner');
            resumeBanner.classList.remove('hidden');

            document.getElementById('resume-session-btn').addEventListener('click', () => {
                try {
                    const draft = JSON.parse(savedExamDraft);
                    
                    currentMcqs.length = 0;
                    Array.prototype.push.apply(currentMcqs, draft.mcqs);
                    sections = draft.sections;
                    answerStates = draft.answerStates;
                    currentSectionIndex = draft.currentSectionIndex;
                    currentQuestionIndexInSection = draft.currentQuestionIndexInSection;
                    subjectName = draft.subjectName;
                    candidateName = draft.candidateName;
                    shortNote = draft.shortNote;
                    isShuffled = draft.isShuffled;

                    document.getElementById('subject-name').value = subjectName || '';
                    document.getElementById('candidate-name').value = candidateName || '';
                    document.getElementById('short-note').value = shortNote || '';
                    document.getElementById('shuffle-mcqs-checkbox').checked = isShuffled;
                    
                    renderSections();
                    loadSection();
                    switchScreen('exam');

                } catch (e) {
                    console.error("Failed to load exam draft:", e);
                    alert("The saved exam draft appears to be corrupted and could not be loaded.");
                    clearExamDraft();
                    resumeBanner.classList.add('hidden');
                }
            });

            document.getElementById('discard-draft-btn').addEventListener('click', () => {
                clearExamDraft();
                resumeBanner.classList.add('hidden');
            });
        }
        
        const savedMcqsData = localStorage.getItem(SAVED_MCQS_KEY);
        if (savedMcqsData) {
            try {
                savedMcqIds = JSON.parse(savedMcqsData);
            } catch (e) {
                console.error("Could not parse saved MCQs", e);
                savedMcqIds = [];
            }
        }
        updateSavedQuestionsUI();
        
        const savedResultsData = localStorage.getItem(EXAM_RESULTS_HISTORY_KEY);
        if (savedResultsData) {
            const history = JSON.parse(savedResultsData);
            if(history.length > 0) {
                const pastResultsContainer = document.getElementById('past-results-container');
                const pastResultsCount = document.getElementById('past-results-count');
                pastResultsContainer.classList.remove('hidden');
                pastResultsCount.textContent = history.length;
            }
        }

        document.getElementById('view-past-results-btn').addEventListener('click', showPastResultsList);

        saveMcqBtn.addEventListener('click', toggleSaveMcq);
        saveMcqPracticeBtn.addEventListener('click', toggleSavePracticeMcq);
        
        if (toggleSparklesBtn) {
            toggleSparklesBtn.addEventListener('click', () => {
                isSparklesEnabled = !isSparklesEnabled;
                const svg = toggleSparklesBtn.querySelector('svg');
                if (isSparklesEnabled) {
                    svg.classList.remove('themed-text-secondary');
                    svg.classList.add('text-yellow-500');
                    svg.setAttribute('fill', 'currentColor');
                    showToast("Sparkles On âœ¨");
                } else {
                    svg.classList.add('themed-text-secondary');
                    svg.classList.remove('text-yellow-500');
                    svg.setAttribute('fill', 'none');
                    showToast("Sparkles Off");
                }
            });
        }

        viewSavedBtn.addEventListener('click', () => {
            if (savedMcqIds.length === 0) {
                alert("You have no saved questions.");
                return;
            }
            currentMcqs = initialMcqsState.filter(mcq => savedMcqIds.includes(mcq.id));
            answerStates = currentMcqs.map(mcq => ({
                mcqId: mcq.id,
                status: QuestionStatus.NotVisited,
                selectedOption: undefined,
                timeTaken: 0
            }));
            reviewQuestionIndex = 0;
            switchScreen('review');
            setupReviewScreen(true, true);
        });

        if (mcqs.length > 0) {
            currentMcqs = [...mcqs];
            initializeSetup();
        } else {
            switchScreen('setup');
            document.getElementById('setup-error').textContent = "No questions were loaded. Please generate a new file.";
            document.getElementById('start-exam-btn').disabled = true;
            document.getElementById('add-section-btn').disabled = true;
        }
      } catch (error) {
          console.error("Fatal error during exam initialization:", error);
          document.body.innerHTML =
              '<div style="padding: 2rem; text-align: center; font-family: sans-serif; color: #333;">' +
                  '<h1 style="color: #d9534f; font-size: 2rem;">An Unexpected Error Occurred</h1>' +
                  '<p style="margin-top: 1rem;">The exam file could not be loaded. This is likely due to an internal script error.</p>' +
                  '<p style="margin-top: 0.5rem;">Please try generating the exam file again from the main application.</p>' +
                  '<div style="margin-top: 2rem; padding: 1rem; background-color: #f7f7f7; border: 1px solid #ddd; text-align: left; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; font-size: 0.8rem; max-width: 800px; margin-left: auto; margin-right: auto;">' +
                      '<h3 style="margin-bottom: 0.5rem; font-weight: bold;">Error Details:</h3>' +
                      error.message +
                  '</div>' +
              '</div>';
      }
    });

</script>
<script>
    // --- DISABLE BROWSER BACK/FORWARD ---
    // This script prevents the user from using the browser back button or swipe gestures
    // to leave the page or navigate history, keeping them in the exam app.
    history.pushState(null, document.title, location.href);
    window.addEventListener('popstate', function (event) {
        history.pushState(null, document.title, location.href);
    });
</script>
</body>
</html>
    
